---
phase: 31-quote-pdf-templates
plan: 03
type: execute
wave: 3
depends_on: ["31-02"]
files_modified:
  - globcrm-web/src/app/features/quote-templates/quote-template.models.ts
  - globcrm-web/src/app/features/quote-templates/quote-template.service.ts
  - globcrm-web/src/app/features/quote-templates/quote-template.store.ts
  - globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts
  - globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.html
  - globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.scss
autonomous: true
requirements:
  - QTPL-01
  - QTPL-02
  - QTPL-09

must_haves:
  truths:
    - "User can open the template editor with Unlayer in web displayMode (full-page layout)"
    - "User can insert CRM merge fields from categorized dropdown (Quote, Company, Contact, Deal, Organization, Line Items)"
    - "User can configure page size (A4/Letter) and orientation (portrait/landscape) per template"
    - "User can save a template (design JSON + compiled HTML sent to API)"
  artifacts:
    - path: "globcrm-web/src/app/features/quote-templates/quote-template.models.ts"
      provides: "TypeScript interfaces for QuoteTemplate, QuoteTemplateListItem, requests"
      contains: "interface QuoteTemplate"
    - path: "globcrm-web/src/app/features/quote-templates/quote-template.service.ts"
      provides: "API service for all quote template endpoints"
      contains: "class QuoteTemplateService"
    - path: "globcrm-web/src/app/features/quote-templates/quote-template.store.ts"
      provides: "Signal Store for template state management"
      contains: "QuoteTemplateStore"
    - path: "globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts"
      provides: "Full-page Unlayer editor with web displayMode and merge tags"
      contains: "QuoteTemplateEditorComponent"
  key_links:
    - from: "globcrm-web/src/app/features/quote-templates/quote-template.service.ts"
      to: "/api/quote-templates"
      via: "ApiService HTTP calls"
      pattern: "api/quote-templates"
    - from: "globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts"
      to: "angular-email-editor"
      via: "EmailEditorModule import with web displayMode"
      pattern: "displayMode.*web"
    - from: "globcrm-web/src/app/features/quote-templates/quote-template.store.ts"
      to: "QuoteTemplateService"
      via: "Injected service for API calls"
      pattern: "QuoteTemplateService"
---

<objective>
Create the frontend foundation (models, service, store) and the Unlayer-based template editor component with web displayMode, merge tag configuration, page settings, and save flow.

Purpose: The editor is the core UX of this feature. Users design templates by dragging blocks, inserting merge fields, and configuring page layout. This plan focuses on the editor experience; the template list/management is in Plan 04.

Output: Frontend models, API service, signal store, full-page Unlayer template editor component
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-quote-pdf-templates/31-CONTEXT.md
@.planning/phases/31-quote-pdf-templates/31-RESEARCH.md
@.planning/phases/31-quote-pdf-templates/31-02-SUMMARY.md

# Existing patterns to mirror
@globcrm-web/src/app/features/email-templates/email-template.models.ts
@globcrm-web/src/app/features/email-templates/email-template.service.ts
@globcrm-web/src/app/features/email-templates/email-template.store.ts
@globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
@globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.html
@globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frontend models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/quote-templates/quote-template.models.ts
    globcrm-web/src/app/features/quote-templates/quote-template.service.ts
    globcrm-web/src/app/features/quote-templates/quote-template.store.ts
  </files>
  <action>
1. Create `quote-template.models.ts`:
   - `QuoteTemplate` interface: id (string), name (string), designJson (string), htmlBody (string), isDefault (boolean), pageSize (string), pageOrientation (string), pageMarginTop (string), pageMarginRight (string), pageMarginBottom (string), pageMarginLeft (string), thumbnailUrl (string | null), ownerId (string | null), createdAt (string), updatedAt (string)
   - `QuoteTemplateListItem` interface: id, name, isDefault, pageSize, pageOrientation, thumbnailUrl (string | null), createdAt, updatedAt
   - `CreateQuoteTemplateRequest` interface: name, designJson, htmlBody, pageSize, pageOrientation, pageMarginTop, pageMarginRight, pageMarginBottom, pageMarginLeft, isDefault
   - `UpdateQuoteTemplateRequest` interface: same fields as Create
   - `MergeTagGroup` interface: name (string), mergeTags (Record<string, { name: string; value: string; sample?: string }>), rules?: { repeat?: { name: string; before: string; after: string } }

2. Create `quote-template.service.ts`:
   - Injectable service using ApiService (not raw HttpClient)
   - `getAll()`: GET /api/quote-templates -> Observable<QuoteTemplateListItem[]>
   - `getById(id: string)`: GET /api/quote-templates/{id} -> Observable<QuoteTemplate>
   - `create(request: CreateQuoteTemplateRequest)`: POST /api/quote-templates -> Observable<QuoteTemplate>
   - `update(id: string, request: UpdateQuoteTemplateRequest)`: PUT /api/quote-templates/{id} -> Observable<QuoteTemplate>
   - `delete(id: string)`: DELETE /api/quote-templates/{id} -> Observable<void>
   - `clone(id: string)`: POST /api/quote-templates/{id}/clone -> Observable<QuoteTemplate>
   - `setDefault(id: string)`: PUT /api/quote-templates/{id}/set-default -> Observable<void>
   - `getMergeFields()`: GET /api/quote-templates/merge-fields -> Observable<Record<string, MergeTagGroup>>
   - `getPreviewHtml(templateId: string, quoteId: string)`: GET /api/quote-templates/{templateId}/preview?quoteId={quoteId} -> Observable<string> (response as text, not JSON)
   - `generatePdf(quoteId: string, templateId?: string)`: GET /api/quotes/{quoteId}/pdf?templateId={templateId} -> Observable<Blob> (responseType: 'blob')
   - Follow EmailTemplateService pattern with ApiService

3. Create `quote-template.store.ts`:
   - Use @ngrx/signals signalStore pattern matching EmailTemplateStore
   - State: templates (QuoteTemplateListItem[]), selectedTemplate (QuoteTemplate | null), mergeFields (Record<string, MergeTagGroup>), loading (boolean), error (string | null)
   - Methods (using patchState):
     * loadTemplates(): call service.getAll(), set templates
     * loadTemplate(id: string): call service.getById(), set selectedTemplate
     * loadMergeFields(): call service.getMergeFields(), set mergeFields
     * createTemplate(request, onSuccess callback): call service.create(), invoke callback
     * updateTemplate(id, request, onSuccess callback): call service.update(), invoke callback
     * deleteTemplate(id, onSuccess callback): call service.delete(), invoke callback, remove from templates list
     * cloneTemplate(id, onSuccess callback): call service.clone(), invoke callback, prepend to templates list
     * setDefault(id, onSuccess callback): call service.setDefault(), update local state (clear old default, set new)
   - providedIn: 'root' is NOT used -- provide at route level (per BoardStore pattern from Phase 30)
   - Follow callback pattern for async result handling (consistent with WebhookStore, IntegrationStore)
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` -- may have import errors since editor component doesn't exist yet, but models/service/store files should have no syntax errors. Alternatively verify with `npx tsc --noEmit --project tsconfig.json 2>&1 | grep quote-template` to check for type errors.
  </verify>
  <done>
    Models, service, and store files exist with proper TypeScript types. Service maps to all API endpoints. Store manages template state with callback-based async methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create full-page Unlayer template editor component</name>
  <files>
    globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts
    globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.html
    globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.scss
  </files>
  <action>
Create the quote template editor component mirroring EmailTemplateEditorComponent but with these key differences:

**Component (.ts):**
- Standalone component with ChangeDetectionStrategy.OnPush
- Imports: EmailEditorModule, FormsModule, Material modules (Button, Icon, FormField, Input, Select, SlideToggle, ProgressSpinner, SnackBar, Dialog, Tooltip), TranslocoPipe
- `@ViewChild('emailEditor') emailEditor!: EmailEditorComponent`
- Route param input: `id = input<string | undefined>(undefined)`
- Inject: QuoteTemplateStore, Router, MatSnackBar, MatDialog, TranslocoService
- Signals for form state: templateName (string), pageSize ('A4' | 'Letter', default 'A4'), pageOrientation ('portrait' | 'landscape', default 'portrait'), marginTop (string, '20mm'), marginRight ('15mm'), marginBottom ('20mm'), marginLeft ('15mm'), isDefault (boolean), saving (boolean), editorReady (boolean)
- Computed: isEditMode from id(), pageTitle

**Unlayer editor options (CRITICAL -- must use displayMode: 'web'):**
```typescript
readonly editorOptions = computed(() => ({
  displayMode: 'web' as const,  // NOT 'email' -- full-page document layout
  features: {
    textEditor: { spellChecker: true },
  },
  appearance: {
    theme: 'light' as const,
  },
  mergeTags: this.buildQuoteMergeTags(),
}));
```

**buildQuoteMergeTags():** Build merge tags using the EXACT structure from 31-RESEARCH.md:
- `quote` group: number, title, description, status, issue_date, expiry_date, subtotal, discount_total, tax_total, grand_total, notes, version (each with name, value as `{{quote.field_name}}`, sample)
- `line_items` group: WITH rules.repeat (before: `{% for item in line_items %}`, after: `{% endfor %}`), mergeTags: description, quantity, unit_price, discount_percent, tax_percent, line_total, net_total (values as `{{item.field_name}}`)
- `contact` group: first_name, last_name, email, phone, job_title
- `company` group: name, industry, website, phone, address
- `deal` group: title, value, stage, close_date
- `organization` group: name, logo_url, address, phone, email, website

Entity colors for visual merge tag chips:
- quote: '#EA580C' (orange -- matches design system accent)
- line_items: '#FB923C' (orange-400)
- contact: '#60A5FA' (info blue)
- company: '#34D399' (positive green)
- deal: '#FBBF24' (caution yellow)
- organization: '#A78BFA' (purple)

**ngOnInit:** Load merge fields from store, load template if edit mode (id exists)

**onEditorReady():** Set editorReady, load design JSON if template loaded, update merge tags dynamically via `emailEditor.editor.setMergeTags(tags)`

**save():** Validate templateName not empty. Call `emailEditor.exportHtml((data) => ...)`, build CreateQuoteTemplateRequest/UpdateQuoteTemplateRequest from form signals + data.design + data.html, call store.createTemplate or store.updateTemplate based on isEditMode. On success: show snackbar, navigate to /quote-templates for create, stay on page for update.

**goBack():** Navigate to /quote-templates

**Template (.html):**
Full-page layout design tool feel (per CONTEXT.md decision):
- Top toolbar bar with: back button, template name input, page size select (A4/Letter), orientation select (portrait/landscape), isDefault toggle, save button, preview button (if edit mode)
- Below toolbar: Full-height Unlayer editor taking remaining viewport
- Use `<email-editor #emailEditor [options]="editorOptions()" (loaded)="onEditorLoaded()" (ready)="onEditorReady()" minHeight="calc(100vh - 64px)"></email-editor>`
- The editor should NOT show Angular Material sidenav with merge field panel (unlike email templates). Quote template merge tags are accessed via Unlayer's built-in merge tag dropdown in the text toolbar (per CONTEXT.md decision).

**Styles (.scss):**
- `:host { display: block; height: 100vh; overflow: hidden; }` -- full viewport
- `.editor-toolbar` -- top bar with flex layout, 56-64px height, background var(--bg-card), border-bottom var(--border-subtle), padding 0 16px, gap 12px, align-items center
- Template name input: 300px width, mat-form-field
- Page settings selects: compact mat-select, 120px width each
- Unlayer editor container: flex: 1, overflow hidden
- Design system colors: use CSS custom properties from tokens.css
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -15` -- component should compile. If there are unrelated errors from other modified files in git status, focus on quote-template-specific errors only.
  </verify>
  <done>
    QuoteTemplateEditorComponent exists as a full-page editor using Unlayer in web displayMode. Merge tags configured with all categories including line items repeat rules. Save exports design JSON + HTML to API. Page settings (size, orientation) configurable from toolbar. Editor feels like a dedicated design tool.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` compiles
2. Models, service, and store files exist with proper types
3. Editor component uses `displayMode: 'web'` (not 'email')
4. Merge tags include all categories: quote, line_items (with repeat rules), contact, company, deal, organization
5. Editor has full-page layout with toolbar containing name, page size, orientation, save
6. Save flow exports HTML + design JSON via Unlayer API
</verification>

<success_criteria>
- Frontend builds successfully
- Editor opens with Unlayer in document mode (full width, not email-constrained)
- All merge field categories visible in Unlayer merge tag dropdown
- Line items merge tags include repeat rules for Fluid {% for %} loop
- Page settings (A4/Letter, portrait/landscape) visible in toolbar
- Save sends designJson + htmlBody to API
</success_criteria>

<output>
After completion, create `.planning/phases/31-quote-pdf-templates/31-03-SUMMARY.md`
</output>
