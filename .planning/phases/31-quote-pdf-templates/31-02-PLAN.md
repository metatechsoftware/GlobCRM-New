---
phase: 31-quote-pdf-templates
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs
  - src/GlobCRM.Api/Controllers/QuotesController.cs
  - src/GlobCRM.Infrastructure/EmailTemplates/MergeFieldService.cs
autonomous: true
requirements:
  - QTPL-02
  - QTPL-03
  - QTPL-05
  - QTPL-06
  - QTPL-07
  - QTPL-08
  - QTPL-10
  - QTPL-11

must_haves:
  truths:
    - "API supports full CRUD for quote templates (create, read, update, delete, clone, set-default)"
    - "PDF generation endpoint accepts optional templateId to use custom template or QuestPDF fallback"
    - "Merge data builder resolves quote, line items, contact, company, deal, and organization branding"
    - "Thumbnail is generated on template save and stored via file storage"
    - "Clone creates a copy with '[Original] (Copy)' name"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs"
      provides: "Full CRUD + clone + set-default + thumbnail serving endpoints"
      contains: "class QuoteTemplatesController"
    - path: "src/GlobCRM.Api/Controllers/QuotesController.cs"
      provides: "Updated GeneratePdf with optional templateId parameter"
      contains: "GeneratePdf"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs"
      to: "IQuoteTemplateRepository"
      via: "Constructor injection"
      pattern: "IQuoteTemplateRepository"
    - from: "src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs"
      to: "PlaywrightPdfService"
      via: "Constructor injection for thumbnail generation"
      pattern: "PlaywrightPdfService"
    - from: "src/GlobCRM.Api/Controllers/QuotesController.cs"
      to: "TemplateRenderService"
      via: "Fluid rendering of custom template HTML with merge data"
      pattern: "RenderAsync"
---

<objective>
Create the QuoteTemplatesController with full CRUD, clone, set-default, and thumbnail endpoints. Update the existing QuotesController.GeneratePdf to support custom templates via Playwright while preserving the QuestPDF fallback. Build the quote-specific merge data resolver for Fluid template rendering.

Purpose: This plan provides the complete API surface that the frontend will consume. The controller handles template management, the updated PDF endpoint enables template-based PDF generation, and the merge data builder populates all template placeholders with real quote data.

Output: QuoteTemplatesController, updated QuotesController, merge data resolution for quotes
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-quote-pdf-templates/31-CONTEXT.md
@.planning/phases/31-quote-pdf-templates/31-RESEARCH.md
@.planning/phases/31-quote-pdf-templates/31-01-SUMMARY.md

# Existing patterns
@src/GlobCRM.Api/Controllers/QuotesController.cs
@src/GlobCRM.Api/Controllers/EmailTemplatesController.cs
@src/GlobCRM.Infrastructure/EmailTemplates/TemplateRenderService.cs
@src/GlobCRM.Infrastructure/EmailTemplates/MergeFieldService.cs
@src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs
@src/GlobCRM.Infrastructure/Pdf/QuotePdfDocument.cs
@src/GlobCRM.Domain/Entities/QuoteTemplate.cs
@src/GlobCRM.Domain/Entities/Quote.cs
@src/GlobCRM.Domain/Entities/QuoteLineItem.cs
@src/GlobCRM.Domain/Entities/Organization.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuoteTemplatesController with CRUD, clone, set-default, and thumbnail endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs
  </files>
  <action>
Create `src/GlobCRM.Api/Controllers/QuoteTemplatesController.cs` following the EmailTemplatesController pattern. Co-locate DTOs, request records, and validators in the same file (per project convention).

**DTOs (static FromEntity factory methods per convention):**
- QuoteTemplateListDto: Id, Name, IsDefault, PageSize, PageOrientation, ThumbnailUrl (string?, constructed from ThumbnailPath), CreatedAt, UpdatedAt
- QuoteTemplateDto: All ListDto fields plus DesignJson, HtmlBody, PageMarginTop, PageMarginRight, PageMarginBottom, PageMarginLeft, OwnerId

**Request records:**
- CreateQuoteTemplateRequest: Name (required), DesignJson (required), HtmlBody (required), PageSize (default "A4"), PageOrientation (default "portrait"), PageMarginTop/Right/Bottom/Left (defaults "20mm"/"15mm"/"20mm"/"15mm"), IsDefault (bool)
- UpdateQuoteTemplateRequest: Same fields as Create

**FluentValidation validators:**
- CreateQuoteTemplateValidator: Name NotEmpty, MaxLength(200); DesignJson NotEmpty; HtmlBody NotEmpty; PageSize must be "A4" or "Letter"; PageOrientation must be "portrait" or "landscape"
- UpdateQuoteTemplateValidator: Same rules

**Controller: [Route("api/quote-templates")]**
Constructor injects: IQuoteTemplateRepository, PlaywrightPdfService, TemplateRenderService, IFileStorageService, ITenantProvider, ILogger

**Endpoints:**
1. `GET /api/quote-templates` — List all templates for tenant. Returns QuoteTemplateListDto[]. Construct ThumbnailUrl from ThumbnailPath using a helper (e.g., `/api/quote-templates/{id}/thumbnail` endpoint or file storage URL).

2. `GET /api/quote-templates/{id}` — Get single template by ID. Returns QuoteTemplateDto.

3. `POST /api/quote-templates` — Create new template. Validates request. If IsDefault=true, call ClearDefaultAsync first. Save entity. Fire-and-forget thumbnail generation: render HtmlBody with sample merge data via TemplateRenderService, call PlaywrightPdfService.GenerateThumbnailAsync, save PNG via IFileStorageService under path `{tenantId}/quote-templates/{templateId}.png`, update ThumbnailPath. Wrap thumbnail in try/catch (non-blocking, log warning on failure). Return 201 with QuoteTemplateDto.

4. `PUT /api/quote-templates/{id}` — Update existing template. Same validation. If IsDefault changed to true, ClearDefaultAsync. Save. Re-generate thumbnail (fire-and-forget). Return QuoteTemplateDto.

5. `DELETE /api/quote-templates/{id}` — Delete template. If it had a thumbnail, delete the file too. Return 204.

6. `POST /api/quote-templates/{id}/clone` — Clone a template. Create new QuoteTemplate with Name = "[OriginalName] (Copy)", copy DesignJson, HtmlBody, page settings. IsDefault = false. Generate thumbnail for clone. Return 201 with QuoteTemplateDto.

7. `PUT /api/quote-templates/{id}/set-default` — Set template as default. ClearDefaultAsync first, then set this one to IsDefault=true. Return 200.

8. `GET /api/quote-templates/{id}/thumbnail` — Serve thumbnail PNG. Read ThumbnailPath, load bytes from IFileStorageService, return File with content-type image/png. Return 404 if no thumbnail.

9. `GET /api/quote-templates/merge-fields` — Return available merge field definitions for the template editor. Build static categories: Quote (number, title, description, status, issue_date, expiry_date, subtotal, discount_total, tax_total, grand_total, notes, version), Line Items (with repeat rules -- description, quantity, unit_price, discount_percent, tax_percent, line_total, net_total), Contact (first_name, last_name, email, phone, job_title), Company (name, industry, website, phone, address), Deal (title, value, stage, close_date), Organization (name, logo_url, address, phone, email, website). Return as structured JSON matching Unlayer merge tag format.

**Authorization:** Use [Authorize(Policy = "Permission:Quote:Edit")] for mutating endpoints, [Authorize(Policy = "Permission:Quote:View")] for read endpoints.

**Sample merge data helper method** for thumbnail generation:
Create a private method `GetSampleMergeData()` returning Dictionary with placeholder values (e.g., quote.number = "Q-0042", quote.grand_total = "11,210.00", contact.first_name = "John", company.name = "Acme Corp", line_items = 2 sample items, organization.name from current tenant).
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles with 0 errors. Check that QuoteTemplatesController.cs exists and contains all 9 endpoint methods.
  </verify>
  <done>
    QuoteTemplatesController exists with GET list, GET single, POST create, PUT update, DELETE, POST clone, PUT set-default, GET thumbnail, and GET merge-fields endpoints. All DTOs and validators co-located. Thumbnail generation is fire-and-forget on save/update/clone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update QuotesController.GeneratePdf for custom templates and extend MergeFieldService</name>
  <files>
    src/GlobCRM.Api/Controllers/QuotesController.cs
    src/GlobCRM.Infrastructure/EmailTemplates/MergeFieldService.cs
  </files>
  <action>
1. **Update QuotesController.GeneratePdf** (existing endpoint at `GET /api/quotes/{id}/pdf`):
   - Add optional query parameter: `[FromQuery] Guid? templateId`
   - Add constructor dependencies: IQuoteTemplateRepository, TemplateRenderService, PlaywrightPdfService, ITenantProvider (some may already be injected)
   - Logic flow:
     a. Load quote with line items (existing code)
     b. Permission check (existing code)
     c. If templateId is null OR template not found: use existing QuestPDF fallback (preserve current code exactly as-is for QTPL-11 backward compat)
     d. If templateId provided and template found:
        - Build merge data dictionary using a new private method `BuildQuoteMergeDataAsync(quote)`:
          * `quote` key: number, title, description, status (ToString()), issue_date (IssueDate.ToString("MMM dd, yyyy")), expiry_date, version, subtotal (.ToString("N2")), discount_total, tax_total, grand_total, notes
          * `line_items` key: array of dicts from quote.LineItems ordered by SortOrder, each with: description, quantity (.ToString("G")), unit_price (.ToString("N2")), discount_percent (.ToString("G")), tax_percent (.ToString("G")), line_total (.ToString("N2")), discount_amount (.ToString("N2")), tax_amount (.ToString("N2")), net_total (.ToString("N2"))
          * `contact` key: if quote.Contact != null, include first_name, last_name, email, phone, job_title
          * `company` key: if quote.Company != null, include name, industry, website, phone, address
          * `deal` key: if quote.Deal != null, include title, value, stage, close_date, description
          * `organization` key: from ITenantProvider.GetCurrentOrganizationAsync() -- name, logo_url, address, phone, email, website
        - Render HTML: `var renderedHtml = await _renderService.RenderAsync(template.HtmlBody, mergeData)`
        - Generate PDF: call PlaywrightPdfService.GeneratePdfAsync with rendered HTML and PdfGenerationOptions built from template's PageSize, PageOrientation, margins
        - Return File(pdfBytes, "application/pdf", filename)

2. **Add preview endpoint** to QuotesController or QuoteTemplatesController:
   - `GET /api/quote-templates/{templateId}/preview?quoteId={quoteId}` — Returns rendered HTML (not PDF) for preview display in the frontend modal
   - Load template, load quote with line items (including Contact, Company, Deal includes), build merge data, render via Fluid, return Content(renderedHtml, "text/html")
   - This supports QTPL-04 (preview with real quote data)

3. **Extend MergeFieldService** to include quote-specific fields:
   - Add a `quote` group to GetAvailableFieldsAsync with fields: quote.number, quote.title, quote.description, quote.status, quote.issue_date, quote.expiry_date, quote.subtotal, quote.discount_total, quote.tax_total, quote.grand_total, quote.notes, quote.version
   - Add an `organization` group with: organization.name, organization.logo_url, organization.address, organization.phone, organization.email, organization.website
   - Keep existing contact, company, deal, lead groups (they're reused by both email templates and quote templates)
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles with 0 errors. Verify GeneratePdf method signature now has `Guid? templateId` parameter. Verify MergeFieldService has "quote" and "organization" groups.
  </verify>
  <done>
    QuotesController.GeneratePdf accepts optional templateId -- uses Playwright+Fluid for custom templates, QuestPDF for fallback. Preview endpoint returns rendered HTML with real quote data. MergeFieldService extended with quote and organization merge field groups.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` compiles with 0 errors
2. QuoteTemplatesController has 9 endpoints (list, get, create, update, delete, clone, set-default, thumbnail, merge-fields)
3. QuotesController.GeneratePdf accepts optional templateId query parameter
4. Without templateId, existing QuestPDF path is preserved (backward compat)
5. With templateId, Fluid renders template HTML with quote merge data, Playwright generates PDF
6. Preview endpoint returns rendered HTML for frontend modal display
7. MergeFieldService has quote and organization field groups
</verification>

<success_criteria>
- dotnet build succeeds
- Complete CRUD API for quote templates with clone and set-default
- PDF generation supports both custom templates (Playwright) and built-in default (QuestPDF)
- Preview endpoint exists for template rendering with real quote data
- All merge field categories available (quote, line items, contact, company, deal, organization)
</success_criteria>

<output>
After completion, create `.planning/phases/31-quote-pdf-templates/31-02-SUMMARY.md`
</output>
