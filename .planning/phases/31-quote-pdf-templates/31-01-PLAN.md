---
phase: 31-quote-pdf-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/QuoteTemplate.cs
  - src/GlobCRM.Domain/Entities/Organization.cs
  - src/GlobCRM.Domain/Interfaces/IQuoteTemplateRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteTemplateConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteTemplateRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs
  - src/GlobCRM.Infrastructure/Pdf/PdfServiceExtensions.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
  - scripts/rls-setup.sql
autonomous: true
requirements:
  - QTPL-01
  - QTPL-09
  - QTPL-11

must_haves:
  truths:
    - "QuoteTemplate entity exists with DesignJson, HtmlBody, page config, and thumbnail support"
    - "PlaywrightPdfService can generate PDF bytes from HTML and PNG thumbnail screenshots"
    - "Organization entity has branding fields (LogoUrl, Address, Phone, Email, Website)"
    - "EF migration creates quote_templates table with proper indexes and RLS"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/QuoteTemplate.cs"
      provides: "QuoteTemplate entity with all properties"
      contains: "class QuoteTemplate"
    - path: "src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs"
      provides: "Singleton Playwright browser with PDF and thumbnail generation"
      contains: "class PlaywrightPdfService"
    - path: "src/GlobCRM.Domain/Interfaces/IQuoteTemplateRepository.cs"
      provides: "Repository interface for QuoteTemplate CRUD"
      contains: "interface IQuoteTemplateRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteTemplateRepository.cs"
      provides: "EF Core repository implementation"
      contains: "class QuoteTemplateRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteTemplateConfiguration.cs"
      provides: "EF Core entity configuration with snake_case and indexes"
      contains: "class QuoteTemplateConfiguration"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs"
      to: "Microsoft.Playwright"
      via: "NuGet package reference"
      pattern: "Playwright\\.CreateAsync"
    - from: "src/GlobCRM.Infrastructure/DependencyInjection.cs"
      to: "PlaywrightPdfService"
      via: "Singleton DI registration"
      pattern: "AddSingleton.*PlaywrightPdfService"
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "QuoteTemplate"
      via: "DbSet and global query filter"
      pattern: "DbSet.*QuoteTemplate"
---

<objective>
Create the backend foundation for quote PDF templates: QuoteTemplate domain entity with page configuration and thumbnail support, PlaywrightPdfService singleton for HTML-to-PDF and PNG thumbnail generation, QuoteTemplateRepository, EF Core migration, RLS policy, and Organization branding fields.

Purpose: All frontend and API work depends on the entity model and PDF generation service existing first. The PlaywrightPdfService is the core infrastructure that enables custom template PDF output (replacing QuestPDF for custom templates while keeping QuestPDF for the built-in default).

Output: QuoteTemplate entity, migration, repository, PlaywrightPdfService, Organization branding fields
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-quote-pdf-templates/31-CONTEXT.md
@.planning/phases/31-quote-pdf-templates/31-RESEARCH.md

# Existing patterns to follow
@src/GlobCRM.Domain/Entities/Quote.cs
@src/GlobCRM.Domain/Entities/Organization.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/IntegrationConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/IntegrationRepository.cs
@src/GlobCRM.Infrastructure/EmailTemplates/TemplateRenderService.cs
@src/GlobCRM.Infrastructure/Pdf/PdfServiceExtensions.cs
@src/GlobCRM.Infrastructure/Pdf/QuotePdfDocument.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuoteTemplate entity, Organization branding fields, and repository interface</name>
  <files>
    src/GlobCRM.Domain/Entities/QuoteTemplate.cs
    src/GlobCRM.Domain/Entities/Organization.cs
    src/GlobCRM.Domain/Interfaces/IQuoteTemplateRepository.cs
  </files>
  <action>
1. Create `src/GlobCRM.Domain/Entities/QuoteTemplate.cs` following the Quote entity pattern:
   - Properties: Id (Guid), TenantId (Guid), Name (string, required), DesignJson (string, JSONB -- Unlayer design state for re-editing), HtmlBody (string, text -- compiled HTML from Unlayer exportHtml), IsDefault (bool, default false -- one default per tenant), PageSize (string, default "A4" -- supports "A4" or "Letter"), PageOrientation (string, default "portrait" -- supports "portrait" or "landscape"), PageMarginTop (string, default "20mm"), PageMarginRight (string, default "15mm"), PageMarginBottom (string, default "20mm"), PageMarginLeft (string, default "15mm"), ThumbnailPath (string?, nullable -- file storage path to PNG thumbnail), OwnerId (Guid?, nullable FK to ApplicationUser), IsSeedData (bool, default false), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
   - Navigation: Owner (ApplicationUser?)
   - Follow same namespace pattern: `GlobCRM.Domain.Entities`
   - Add XML doc comments consistent with other entities

2. Add branding fields to `src/GlobCRM.Domain/Entities/Organization.cs`:
   - Add: LogoUrl (string?, nullable), Address (string?, nullable), Phone (string?, nullable), Email (string?, nullable), Website (string?, nullable)
   - Place after existing properties (before CreatedAt), with XML doc comments
   - These are needed for org merge fields in quote templates (QTPL-10)

3. Create `src/GlobCRM.Domain/Interfaces/IQuoteTemplateRepository.cs`:
   - Methods: GetAllAsync(CancellationToken), GetByIdAsync(Guid id, CancellationToken), GetDefaultAsync(CancellationToken), AddAsync(QuoteTemplate, CancellationToken), UpdateAsync(QuoteTemplate, CancellationToken), DeleteAsync(Guid id, CancellationToken), ClearDefaultAsync(CancellationToken) -- clears IsDefault on all templates for the tenant before setting a new default
   - Follow IIntegrationRepository pattern
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build --no-restore 2>&1 | tail -5` -- should compile (build may warn about unused but should not error since these are just domain entities)
  </verify>
  <done>
    QuoteTemplate entity file exists with all properties including page config and thumbnail. Organization has branding fields. IQuoteTemplateRepository interface defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configuration, repository, PlaywrightPdfService, migration, RLS, and DI registration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteTemplateConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteTemplateRepository.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs
    src/GlobCRM.Infrastructure/Pdf/PdfServiceExtensions.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
    scripts/rls-setup.sql
  </files>
  <action>
1. Install Microsoft.Playwright NuGet package:
   `cd src/GlobCRM.Infrastructure && dotnet add package Microsoft.Playwright`

2. Create `src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteTemplateConfiguration.cs`:
   - Table name: "quote_templates" (snake_case per convention)
   - Map all properties to snake_case columns: name, design_json, html_body, is_default, page_size, page_orientation, page_margin_top, page_margin_right, page_margin_bottom, page_margin_left, thumbnail_path, owner_id, is_seed_data, tenant_id, created_at, updated_at
   - DesignJson: column type "jsonb"
   - HtmlBody: column type "text"
   - Name: MaxLength(200), IsRequired
   - PageSize: MaxLength(20), default "A4"
   - PageOrientation: MaxLength(20), default "portrait"
   - Each margin: MaxLength(20)
   - OwnerId FK to ApplicationUser with SetNull delete
   - Index on tenant_id for query performance
   - Composite index on (tenant_id, is_default) WHERE is_default = true (partial unique -- only one default per tenant); use HasFilter("is_default = true") with IsUnique
   - Follow QuoteConfiguration/IntegrationConfiguration pattern exactly

3. Create `src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteTemplateRepository.cs`:
   - Implement IQuoteTemplateRepository
   - Constructor injects ApplicationDbContext
   - GetAllAsync: return all templates ordered by CreatedAt desc
   - GetByIdAsync: find by id
   - GetDefaultAsync: FirstOrDefaultAsync where IsDefault == true
   - AddAsync: Add + SaveChangesAsync
   - UpdateAsync: Update + SaveChangesAsync
   - DeleteAsync: find by id, remove, SaveChangesAsync
   - ClearDefaultAsync: execute update to set IsDefault=false on all templates for this tenant
   - Follow IntegrationRepository pattern

4. Update `src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs`:
   - Add `DbSet<QuoteTemplate> QuoteTemplates { get; set; }`
   - Add global query filter: `modelBuilder.Entity<QuoteTemplate>().HasQueryFilter(e => e.TenantId == _tenantId)`
   - Apply QuoteTemplateConfiguration in OnModelCreating

5. Create `src/GlobCRM.Infrastructure/Services/PlaywrightPdfService.cs`:
   - Singleton service implementing IAsyncDisposable
   - Private fields: IPlaywright? _playwright, IBrowser? _browser, SemaphoreSlim _initLock = new(1, 1)
   - `GetBrowserAsync()`: Lazy-initialize Playwright + Chromium browser with double-check locking via SemaphoreSlim
   - `GeneratePdfAsync(string html, PdfGenerationOptions options)`: Creates new browser context + page, SetContentAsync with WaitUntil.NetworkIdle, PdfAsync with PagePdfOptions (Format from options.PageSize mapping "A4"->null with Width/Height or use string directly, Landscape from options, PrintBackground=true, Margin from options), disposes context in finally block, returns byte[]
   - `GenerateThumbnailAsync(string html, int width = 400, int height = 566)`: Creates new browser context with ViewportSize, SetContentAsync, ScreenshotAsync (PNG, FullPage=false for first page only), disposes context in finally, returns byte[]
   - `DisposeAsync()`: Close browser, dispose playwright
   - PdfGenerationOptions record: PageSize (string), Landscape (bool), MarginTop (string), MarginRight (string), MarginBottom (string), MarginLeft (string)
   - Important: Use try/finally to always close browser context even on error. Log warnings but don't throw from DisposeAsync.

6. Update `src/GlobCRM.Infrastructure/Pdf/PdfServiceExtensions.cs`:
   - Add `services.AddSingleton<PlaywrightPdfService>()` to the AddPdfServices method
   - Keep existing QuestPDF license configuration (backward compat, QTPL-11)

7. Register repository in `src/GlobCRM.Infrastructure/DependencyInjection.cs`:
   - Add `services.AddScoped<IQuoteTemplateRepository, QuoteTemplateRepository>()`
   - Place near other repository registrations

8. Generate EF Core migration:
   `cd src/GlobCRM.Api && dotnet ef migrations add AddQuoteTemplates --context ApplicationDbContext --output-dir ../GlobCRM.Infrastructure/Persistence/Migrations/App --project ../GlobCRM.Infrastructure`

9. Add RLS policy to `scripts/rls-setup.sql`:
   ```sql
   -- Quote Templates
   ALTER TABLE quote_templates ENABLE ROW LEVEL SECURITY;
   DROP POLICY IF EXISTS quote_templates_tenant_isolation ON quote_templates;
   CREATE POLICY quote_templates_tenant_isolation ON quote_templates
     USING (tenant_id = current_setting('app.current_tenant')::uuid);
   ```

10. Install Playwright Chromium browsers (development setup):
    `pwsh src/GlobCRM.Api/bin/Debug/net10.0/playwright.ps1 install chromium`
    Note: If playwright.ps1 doesn't exist yet (needs a build first), run `cd src/GlobCRM.Api && dotnet build` first, then retry. If this fails in CI, it's expected -- document as a user_setup concern but don't block the plan.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` should compile successfully with 0 errors. Migration file should exist in Persistence/Migrations/App/ directory.
  </verify>
  <done>
    QuoteTemplate has EF Core config with snake_case columns, JSONB design_json, proper indexes. QuoteTemplateRepository implements all CRUD. PlaywrightPdfService is registered as singleton with PDF and thumbnail generation. Migration file created. RLS policy added. dotnet build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` compiles with 0 errors
2. QuoteTemplate entity has all required properties (DesignJson, HtmlBody, PageSize, PageOrientation, margins, ThumbnailPath, IsDefault)
3. Organization entity has LogoUrl, Address, Phone, Email, Website fields
4. PlaywrightPdfService exists as singleton with GeneratePdfAsync and GenerateThumbnailAsync methods
5. Migration file exists for AddQuoteTemplates
6. RLS policy exists in rls-setup.sql for quote_templates table
7. DI registrations: PlaywrightPdfService (singleton), QuoteTemplateRepository (scoped)
</verification>

<success_criteria>
- dotnet build succeeds with 0 errors
- QuoteTemplate entity, configuration, repository, and migration all exist
- PlaywrightPdfService compiles and is registered in DI
- Organization has branding fields for template merge data
</success_criteria>

<output>
After completion, create `.planning/phases/31-quote-pdf-templates/31-01-SUMMARY.md`
</output>
