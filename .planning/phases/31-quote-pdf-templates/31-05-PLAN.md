---
phase: 31-quote-pdf-templates
plan: 05
type: execute
wave: 4
depends_on: ["31-03", "31-04"]
files_modified:
  - globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.ts
  - globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.html
  - globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.scss
  - src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
  - globcrm-web/src/assets/i18n/quoteTemplates/en.json
  - globcrm-web/src/assets/i18n/quoteTemplates/tr.json
  - globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts
  - globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.html
  - globcrm-web/src/app/features/quote-templates/quote-template-list/quote-template-list.component.ts
  - globcrm-web/src/app/features/quote-templates/quote-template-list/quote-template-list.component.html
  - globcrm-web/src/app/features/quote-templates/quote-templates.routes.ts
autonomous: false
requirements:
  - QTPL-04
  - QTPL-05

must_haves:
  truths:
    - "User can preview a template rendered with real quote data in a modal dialog"
    - "User can select a quote for preview from a searchable dropdown"
    - "User can download a PDF from a quote using a selected template"
    - "All template UI strings are translated (EN + TR)"
    - "Starter seed templates are created for new tenants"
  artifacts:
    - path: "globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.ts"
      provides: "Preview dialog rendering template with real quote data"
      contains: "QuoteTemplatePreviewComponent"
    - path: "globcrm-web/src/assets/i18n/quoteTemplates/en.json"
      provides: "English translations for quote templates feature"
      min_lines: 30
    - path: "globcrm-web/src/assets/i18n/quoteTemplates/tr.json"
      provides: "Turkish translations for quote templates feature"
      min_lines: 30
  key_links:
    - from: "globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.ts"
      to: "QuoteTemplateService.getPreviewHtml"
      via: "API call for rendered HTML"
      pattern: "getPreviewHtml"
    - from: "globcrm-web/src/app/features/quote-templates/quote-templates.routes.ts"
      to: "provideTranslocoScope"
      via: "Route-level transloco scope provider"
      pattern: "provideTranslocoScope.*quoteTemplates"
---

<objective>
Complete the quote PDF templates feature with preview dialog, PDF download integration, starter seed templates, and full i18n (EN + TR). Includes a final verification checkpoint.

Purpose: This plan delivers the end-to-end workflow: design a template (Plan 03), manage templates (Plan 04), preview with real data, and generate/download PDFs. Starter templates provide immediate value for new tenants. i18n ensures the feature matches the localization standards of the rest of the application.

Output: Preview dialog, PDF download, seed templates, EN/TR translations, verified feature
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-quote-pdf-templates/31-CONTEXT.md
@.planning/phases/31-quote-pdf-templates/31-RESEARCH.md
@.planning/phases/31-quote-pdf-templates/31-03-SUMMARY.md
@.planning/phases/31-quote-pdf-templates/31-04-SUMMARY.md

# Patterns for i18n and seed data
@globcrm-web/src/assets/i18n/emailTemplates/en.json
@globcrm-web/src/assets/i18n/emailTemplates/tr.json
@globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts
@src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview dialog, starter templates seeder, and i18n translations</name>
  <files>
    globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.ts
    globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.html
    globcrm-web/src/app/features/quote-templates/quote-template-preview/quote-template-preview.component.scss
    src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
    globcrm-web/src/assets/i18n/quoteTemplates/en.json
    globcrm-web/src/assets/i18n/quoteTemplates/tr.json
    globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.ts
    globcrm-web/src/app/features/quote-templates/quote-template-editor/quote-template-editor.component.html
    globcrm-web/src/app/features/quote-templates/quote-template-list/quote-template-list.component.ts
    globcrm-web/src/app/features/quote-templates/quote-template-list/quote-template-list.component.html
    globcrm-web/src/app/features/quote-templates/quote-templates.routes.ts
  </files>
  <action>
**1. Create Preview Dialog Component:**

Per CONTEXT.md decision: "Preview renders in a large modal overlay over the editor -- shows rendered PDF with real quote data, dismiss to return to editing."

QuoteTemplatePreviewComponent as a MatDialog component:
- Injected data: { templateId: string } via MAT_DIALOG_DATA
- Inject: QuoteTemplateService, MatDialogRef, ApiService (for fetching quotes list)
- State signals: quotes (list of {id, title, quoteNumber} for selector), selectedQuoteId (string | null), previewHtml (string | null -- SafeHtml via DomSanitizer), loading (boolean), error (string | null)
- On init: Fetch recent quotes for the tenant (GET /api/quotes with page=1, pageSize=20 or similar) to populate the quote selector dropdown
- When user selects a quote: call `service.getPreviewHtml(templateId, selectedQuoteId)`, set previewHtml. Use DomSanitizer.bypassSecurityTrustHtml() to render the HTML in an iframe or div.
- Template layout:
  * Dialog title: "Template Preview" with close button
  * Quote selector: mat-select with quote list (show QuoteNumber + Title)
  * Preview area: Large iframe (width: 100%, height ~70vh) showing rendered HTML. Use `srcdoc` attribute with sanitized HTML for iframe rendering. This gives proper CSS isolation.
  * Action buttons: "Download PDF" button (calls service.generatePdf and triggers browser download), "Close" button
- Dialog config (opened from editor): width '90vw', maxWidth '900px', height '85vh'
- Download PDF: call `service.generatePdf(selectedQuoteId, templateId)` which returns Blob, then create object URL, create hidden <a> element, trigger click for download, revoke URL

**2. Wire preview button in editor:**
Update quote-template-editor.component.ts to add openPreview() method:
- If template is not yet saved (create mode, no id): show snackbar "Save template before previewing"
- If edit mode: save current state first (exportHtml + updateTemplate), then open preview dialog with templateId
- Follow same pattern as EmailTemplateEditorComponent.openPreview()

**3. Add starter seed templates to TenantSeeder:**
Read existing TenantSeeder.cs to understand the seeding pattern.
Add a method `SeedQuoteTemplatesAsync()` called from the main seed method:
- Check if any QuoteTemplate with IsSeedData=true exists for this tenant; skip if so
- Create 2 starter templates (per CONTEXT.md: "Offer 2-3 pre-built starter templates"):

Template 1: "Standard Quote"
- Clean layout with org header, quote details section, line items table, totals, notes
- DesignJson: Unlayer JSON representing a simple document layout (text blocks + table structure)
- HtmlBody: Well-structured HTML with Liquid merge tags
- IsDefault: true, PageSize: "A4", PageOrientation: "portrait"

Template 2: "Detailed Proposal"
- Extended layout with description block, full-column line items table, terms section
- DesignJson: Unlayer JSON for a more detailed layout
- HtmlBody: HTML with all merge field categories
- IsDefault: false, PageSize: "A4", PageOrientation: "portrait"

For the HTML templates, create clean, professional HTML with:
- CSS embedded in style tags (Playwright renders inline styles)
- Use Liquid merge tags: {{quote.number}}, {{company.name}}, etc.
- Line items: {% for item in line_items %} ... {% endfor %} loop
- Organization branding: {{organization.name}}, {{organization.logo_url}}, etc.
- Totals section: subtotal, discount, tax, grand total
- Professional styling: clean fonts (system font stack), table borders, proper spacing

The DesignJson for these templates should be valid Unlayer design JSON. Since creating real Unlayer design JSON programmatically is complex, use a minimal valid structure -- the HTML body is what matters for PDF generation. Users can edit the design in Unlayer later. Use this minimal structure:
```json
{"body":{"rows":[],"values":{"backgroundColor":"#ffffff"}},"counters":{"u_row":0,"u_column":0,"u_content_text":0}}
```

**4. Create Transloco scope and translation files:**

Update quote-templates.routes.ts to add Transloco scope provider:
```typescript
import { provideTranslocoScope } from '@jsverse/transloco';
// In the parent route's providers array:
providers: [QuoteTemplateStore, provideTranslocoScope('quoteTemplates')]
```

Create `globcrm-web/src/assets/i18n/quoteTemplates/en.json`:
```json
{
  "quoteTemplates": {
    "title": "Quote Templates",
    "list": {
      "title": "Quote Templates",
      "create": "Create Template",
      "empty": {
        "title": "No templates yet",
        "description": "Create your first quote template to generate professionally branded PDFs.",
        "action": "Create Template"
      },
      "card": {
        "default": "DEFAULT",
        "lastModified": "Last modified",
        "noThumbnail": "No preview available"
      },
      "actions": {
        "edit": "Edit",
        "clone": "Clone",
        "setDefault": "Set as Default",
        "delete": "Delete"
      },
      "messages": {
        "cloned": "Template cloned successfully",
        "deleted": "Template deleted",
        "defaultSet": "Default template updated"
      }
    },
    "editor": {
      "newTitle": "New Template",
      "editTitle": "Edit Template",
      "name": "Template Name",
      "namePlaceholder": "Enter template name",
      "pageSize": "Page Size",
      "orientation": "Orientation",
      "portrait": "Portrait",
      "landscape": "Landscape",
      "default": "Default Template",
      "save": "Save",
      "saving": "Saving...",
      "preview": "Preview",
      "back": "Back to Templates",
      "messages": {
        "nameRequired": "Template name is required",
        "saved": "Template saved successfully",
        "created": "Template created successfully",
        "saveBeforePreview": "Save the template before previewing"
      },
      "margins": {
        "top": "Top",
        "right": "Right",
        "bottom": "Bottom",
        "left": "Left"
      }
    },
    "preview": {
      "title": "Template Preview",
      "selectQuote": "Select a quote to preview",
      "noQuotes": "No quotes available",
      "loading": "Loading preview...",
      "downloadPdf": "Download PDF",
      "close": "Close",
      "error": "Failed to load preview"
    },
    "deleteDialog": {
      "title": "Delete Template",
      "message": "Are you sure you want to delete this template? This action cannot be undone.",
      "cancel": "Cancel",
      "confirm": "Delete"
    }
  }
}
```

Create `globcrm-web/src/assets/i18n/quoteTemplates/tr.json` with Turkish translations:
- "Quote Templates" -> "Teklif Sablonlari" (with proper Turkish characters)
- Translate all keys to Turkish following the established patterns from other scope files
- Use proper Turkish characters (dotless i: i vs I, etc.)

**5. Wire TranslocoPipe in all components:**
Update both quote-template-list and quote-template-editor components:
- Add TranslocoPipe to imports array
- Replace all hardcoded strings in templates with transloco pipe: `{{ 'quoteTemplates.list.title' | transloco }}`
- Use TranslocoService.translate() for programmatic strings (snackbar messages)
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -15` -- should compile. `cd src/GlobCRM.Api && dotnet build` for seeder changes. Verify translation files exist with matching key structures.
  </verify>
  <done>
    Preview dialog shows rendered template with real quote data in iframe. PDF download works from preview. Two starter seed templates created. EN and TR translation files cover all UI strings. All components use TranslocoPipe.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete quote PDF template flow</name>
  <what-built>
    Complete quote PDF template system: visual editor (Unlayer web mode), merge fields, template management (CRUD, clone, default), preview with real data, PDF generation with Playwright, QuestPDF fallback, starter templates, and i18n (EN + TR).
  </what-built>
  <how-to-verify>
    1. Start backend: `cd src/GlobCRM.Api && dotnet run`
    2. Start frontend: `cd globcrm-web && npm start`
    3. Navigate to http://localhost:4200

    **Template Management (QTPL-06, QTPL-07, QTPL-08, QTPL-12):**
    4. Go to Settings > look for "Quote Templates" card, click it
    5. Verify card grid shows starter templates (if seeded) with thumbnails
    6. Verify "Default" badge on the default template

    **Template Editor (QTPL-01, QTPL-02, QTPL-09):**
    7. Click "Create Template" or edit an existing template
    8. Verify full-page editor with Unlayer in document mode (full width, not email-narrow)
    9. Click merge tag dropdown in text editor toolbar -- verify categories: Quote, Line Items, Contact, Company, Deal, Organization
    10. Insert some merge tags, verify they appear as colored chips
    11. Verify page size (A4/Letter) and orientation (portrait/landscape) selectors in toolbar
    12. Save template, verify success snackbar

    **Clone (QTPL-07):**
    13. Return to template list, click three-dot menu on a template, click Clone
    14. Verify new template appears with "[Name] (Copy)" suffix

    **Preview (QTPL-04):**
    15. Edit a template, click Preview button
    16. Select a quote from dropdown
    17. Verify preview shows rendered HTML with actual quote data (numbers, names, line items)

    **PDF Generation (QTPL-05, QTPL-11):**
    18. From preview, click "Download PDF" -- verify PDF downloads
    19. Open the PDF -- verify it matches the template design with real data
    20. Navigate to a quote detail page -- verify template selector and "Manage Templates" link
    21. Generate PDF using default template -- verify QuestPDF fallback works (without custom template)

    **i18n:**
    22. Switch language to Turkish -- verify all template UI strings translate

    **Expected results:** All steps complete without errors. PDFs render with correct data, merge fields resolve, page settings apply, thumbnails display.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Both `dotnet build` and `ng build` compile without errors
2. Preview dialog renders template HTML with real quote data
3. PDF download produces a valid PDF file
4. Starter seed templates created on tenant seeding
5. EN and TR translation files have matching key sets
6. All components use TranslocoPipe for UI strings
7. End-to-end flow works: create template -> add merge fields -> preview with quote -> download PDF
</verification>

<success_criteria>
- Complete end-to-end workflow functional: design, manage, preview, generate PDF
- Preview shows real quote data (not placeholders)
- PDF output matches template design with resolved merge fields
- Starter templates available for new tenants
- All UI strings translated (EN + TR)
- QuestPDF fallback preserves backward compatibility for quotes without custom templates
</success_criteria>

<output>
After completion, create `.planning/phases/31-quote-pdf-templates/31-05-SUMMARY.md`
</output>
