---
phase: 03-core-crm-entities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Company.cs
  - src/GlobCRM.Domain/Entities/Contact.cs
  - src/GlobCRM.Domain/Entities/Product.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ProductConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Company, Contact, Product tables exist in database with correct columns and JSONB custom_fields"
    - "All three entities are tenant-isolated via triple-layer defense (query filter + RLS + TenantId)"
    - "Contact has nullable FK to Company (many-to-one relationship)"
    - "Product has UnitPrice decimal, SKU, Category, and IsActive fields for quote line item use"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Company.cs"
      provides: "Company domain entity with TenantId, core fields, OwnerId, CustomFields JSONB, IsSeedData"
      contains: "public class Company"
    - path: "src/GlobCRM.Domain/Entities/Contact.cs"
      provides: "Contact domain entity with CompanyId nullable FK, FullName computed property"
      contains: "public class Contact"
    - path: "src/GlobCRM.Domain/Entities/Product.cs"
      provides: "Product domain entity with UnitPrice, SKU, Category, IsActive"
      contains: "public class Product"
    - path: "src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs"
      provides: "EF Core config with snake_case columns, JSONB mapping, indexes"
      contains: "class CompanyConfiguration"
    - path: "src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs"
      provides: "EF Core config with CompanyId FK, owner FK"
      contains: "class ContactConfiguration"
    - path: "src/GlobCRM.Infrastructure/Persistence/Configurations/ProductConfiguration.cs"
      provides: "EF Core config with decimal precision, SKU unique per tenant"
      contains: "class ProductConfiguration"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and global query filters for all 3 entities"
      contains: "DbSet<Company> Companies"
    - path: "scripts/rls-setup.sql"
      provides: "RLS policies for companies, contacts, products tables"
      contains: "tenant_isolation_companies"
  key_links:
    - from: "ApplicationDbContext"
      to: "Company/Contact/Product entities"
      via: "DbSet declarations and HasQueryFilter"
      pattern: "HasQueryFilter.*TenantId"
    - from: "Contact"
      to: "Company"
      via: "nullable FK CompanyId"
      pattern: "CompanyId.*Company"
---

<objective>
Create the Company, Contact, and Product domain entities with EF Core configurations, database migration, global query filters, and RLS policies -- establishing the data foundation for all Phase 3 CRUD operations.

Purpose: Every subsequent plan in Phase 3 depends on these entities existing in the domain layer with proper tenant isolation, JSONB custom fields support, and relational navigation (Contact -> Company).

Output: 3 domain entities, 3 EF Core configurations, 1 migration, updated ApplicationDbContext with DbSets + query filters, updated RLS script.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@src/GlobCRM.Domain/Entities/Role.cs
@src/GlobCRM.Domain/Entities/Invitation.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/RoleConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Company, Contact, Product domain entities</name>
  <files>
    src/GlobCRM.Domain/Entities/Company.cs
    src/GlobCRM.Domain/Entities/Contact.cs
    src/GlobCRM.Domain/Entities/Product.cs
  </files>
  <action>
Create three domain entities following the exact patterns from the research (03-RESEARCH.md Code Examples section):

**Company.cs:**
- Properties: Id (Guid, NewGuid default), TenantId (Guid), Name (string, required), Industry, Website, Phone, Email, Address, City, State, Country, PostalCode, Size, Description (all nullable strings)
- OwnerId (Guid? nullable) + Owner navigation to ApplicationUser
- CustomFields (Dictionary of string,object? -- JSONB)
- IsSeedData (bool, default false)
- CreatedAt, UpdatedAt (DateTimeOffset, UTC default)
- Contacts navigation collection (ICollection of Contact)
- Do NOT add Organization navigation property (per Pitfall 2 in research -- TenantId is raw Guid with query filter only)

**Contact.cs:**
- Properties: Id, TenantId, FirstName (string, required), LastName (string, required), Email, Phone, MobilePhone, JobTitle, Department, Address, City, State, Country, PostalCode, Description (nullable strings)
- CompanyId (Guid? nullable) + Company navigation (per CONT-03 and Pitfall 5: simple nullable FK, NOT a join table)
- OwnerId (Guid? nullable) + Owner navigation to ApplicationUser
- CustomFields, IsSeedData, CreatedAt, UpdatedAt (same pattern as Company)
- Computed property: FullName => $"{FirstName} {LastName}".Trim()

**Product.cs:**
- Properties: Id, TenantId, Name (string, required), Description (nullable string), UnitPrice (decimal), SKU (nullable string), Category (nullable string)
- IsActive (bool, default true) -- for hiding without deleting, per Pitfall 6 in research
- CustomFields, IsSeedData, CreatedAt, UpdatedAt (same pattern)
- No OwnerId on Product (products are shared resources, not owned)
- No timeline or relational navigation on Product

Use the exact property structures from the research Code Examples section. Namespace: GlobCRM.Domain.Entities.
  </action>
  <verify>All three entity files exist and compile: `dotnet build src/GlobCRM.Domain/`</verify>
  <done>Company.cs, Contact.cs, Product.cs exist in Domain/Entities with all properties matching the research specification</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update ApplicationDbContext, update RLS, create migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ProductConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
**CompanyConfiguration.cs:**
Follow the exact pattern from research (EF Core Configuration Pattern section):
- Table name: "companies" (snake_case)
- All column names in snake_case (id, tenant_id, name, industry, website, phone, email, address, city, state, country, postal_code, size, description, owner_id, custom_fields, is_seed_data, created_at, updated_at)
- Name: HasMaxLength(200), IsRequired
- CustomFields: HasColumnType("jsonb"), HasDefaultValueSql("'{}'::jsonb")
- OwnerId FK to ApplicationUser with OnDelete(SetNull)
- Contacts collection: HasMany with FK(CompanyId), OnDelete(SetNull)
- Indexes: idx_companies_tenant (TenantId), idx_companies_tenant_name (TenantId+Name), idx_companies_custom_fields_gin (GIN on CustomFields), idx_companies_owner (OwnerId)
- For the GIN index, use: builder.HasIndex(c => c.CustomFields).HasMethod("gin").HasDatabaseName("idx_companies_custom_fields_gin")

**ContactConfiguration.cs:**
- Table name: "contacts"
- All snake_case columns (first_name, last_name, email, phone, mobile_phone, job_title, department, etc.)
- FirstName, LastName: HasMaxLength(100), IsRequired
- CompanyId FK to Company with OnDelete(SetNull) -- nullable
- OwnerId FK to ApplicationUser with OnDelete(SetNull)
- CustomFields as JSONB with same pattern
- Indexes: idx_contacts_tenant, idx_contacts_tenant_name (TenantId+LastName+FirstName), idx_contacts_company (CompanyId), idx_contacts_owner (OwnerId), idx_contacts_custom_fields_gin (GIN)
- Ignore the computed FullName property: builder.Ignore(c => c.FullName)

**ProductConfiguration.cs:**
- Table name: "products"
- All snake_case columns (name, description, unit_price, sku, category, is_active)
- UnitPrice: HasPrecision(18, 4) for currency precision
- SKU: HasMaxLength(50) -- unique per tenant constraint via index with filter
- Unique index on (TenantId, SKU) where SKU is not null: HasFilter("sku IS NOT NULL")
- IsActive: HasDefaultValue(true)
- CustomFields as JSONB with same pattern
- Indexes: idx_products_tenant, idx_products_tenant_sku (unique filtered), idx_products_custom_fields_gin (GIN)

**ApplicationDbContext.cs updates:**
- Add DbSets: Companies, Contacts, Products
- Apply configurations: CompanyConfiguration, ContactConfiguration, ProductConfiguration
- Add global query filters for all 3 entities using the established pattern:
  `e => _tenantProvider == null || _tenantProvider.GetTenantId() == null || e.TenantId == _tenantProvider.GetTenantId()`

**scripts/rls-setup.sql updates:**
Append RLS policies for companies, contacts, products tables following the exact pattern from the research (RLS Policy section):
- ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;
- ALTER TABLE {table} FORCE ROW LEVEL SECURITY;
- CREATE POLICY tenant_isolation_{table} ON {table} USING (tenant_id = current_setting('app.current_tenant', true)::uuid) WITH CHECK (...);
- Add COMMENT ON POLICY for each

**Migration:**
Run `dotnet ef migrations add AddCrmEntities --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --output-dir Persistence/Migrations/App` to generate the migration.
  </action>
  <verify>`dotnet build` passes with 0 errors. Migration file exists in Persistence/Migrations/App/. Verify migration contains CreateTable for companies, contacts, products with correct columns and JSONB defaults.</verify>
  <done>3 EF configs with snake_case + JSONB + indexes, ApplicationDbContext has 3 new DbSets + 3 query filters, RLS script has 3 new policies, migration generated successfully</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- Migration file contains CreateTable for companies, contacts, products
- companies table has custom_fields column with jsonb type
- contacts table has company_id FK
- products table has unit_price with decimal precision
- ApplicationDbContext has Companies, Contacts, Products DbSets
- rls-setup.sql has policies for all 3 new tables
</verification>

<success_criteria>
- All 3 entity files compile cleanly
- EF Core migration generates without errors
- Triple-layer tenant isolation configured: query filters + RLS policies + TenantId on all entities
- Contact-Company relationship is nullable FK (not join table)
- Product has UnitPrice, SKU, Category, IsActive fields ready for Phase 6 quotes
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-01-SUMMARY.md`
</output>
