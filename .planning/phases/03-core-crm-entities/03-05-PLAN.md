---
phase: 03-core-crm-entities
plan: 05
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - src/GlobCRM.Api/Controllers/CompaniesController.cs
  - src/GlobCRM.Api/Controllers/ContactsController.cs
  - src/GlobCRM.Api/Controllers/ProductsController.cs
autonomous: true

must_haves:
  truths:
    - "User can CRUD companies via REST API with permission enforcement"
    - "User can CRUD contacts via REST API with company linking"
    - "User can CRUD products via REST API with all required fields"
    - "Custom field values are validated on create and update"
    - "Ownership scope is checked on both list and detail endpoints"
    - "Timeline endpoint returns chronological events for companies and contacts"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/CompaniesController.cs"
      provides: "CRUD endpoints + timeline for companies with permission policies"
      exports: ["GetList", "GetById", "Create", "Update", "Delete", "GetTimeline"]
      contains: "class CompaniesController"
    - path: "src/GlobCRM.Api/Controllers/ContactsController.cs"
      provides: "CRUD endpoints + timeline for contacts with company link management"
      exports: ["GetList", "GetById", "Create", "Update", "Delete", "GetTimeline"]
      contains: "class ContactsController"
    - path: "src/GlobCRM.Api/Controllers/ProductsController.cs"
      provides: "CRUD endpoints for products"
      exports: ["GetList", "GetById", "Create", "Update", "Delete"]
      contains: "class ProductsController"
  key_links:
    - from: "CompaniesController"
      to: "ICompanyRepository"
      via: "Constructor injection"
      pattern: "ICompanyRepository"
    - from: "CompaniesController"
      to: "IPermissionService"
      via: "Ownership scope resolution for list and detail"
      pattern: "GetEffectivePermissionAsync"
    - from: "CompaniesController"
      to: "CustomFieldValidator"
      via: "Validates custom field values on create/update"
      pattern: "CustomFieldValidator"
---

<objective>
Create REST API controllers for Companies, Contacts, and Products with full CRUD operations, permission enforcement via [Authorize(Policy = "Permission:Entity:Op")], custom field validation, ownership scope checking, and timeline endpoints for companies and contacts.

Purpose: These controllers are the backend API that the Angular frontend consumes. Every entity operation flows through these endpoints with proper authorization and validation.

Output: 3 API controllers with ~6 endpoints each, DTOs for request/response, and timeline data generation.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-01-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-04-SUMMARY.md
@src/GlobCRM.Api/Controllers/CustomFieldsController.cs
@src/GlobCRM.Api/Controllers/RolesController.cs
@src/GlobCRM.Infrastructure/Authorization/PermissionService.cs
@src/GlobCRM.Infrastructure/CustomFields/CustomFieldValidator.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompaniesController and ContactsController</name>
  <files>
    src/GlobCRM.Api/Controllers/CompaniesController.cs
    src/GlobCRM.Api/Controllers/ContactsController.cs
  </files>
  <action>
**CompaniesController.cs:**
Follow the exact pattern from research (Controller Pattern with Permission Enforcement section):

```csharp
[ApiController]
[Route("api/companies")]
[Authorize]
public class CompaniesController : ControllerBase
```

Constructor dependencies: ICompanyRepository, IPermissionService, ICustomFieldRepository, CustomFieldValidator, ITenantProvider. Also inject IContactRepository for timeline contact links.

**Helper methods:**
- `GetCurrentUserId()`: Extract Guid from User.FindFirst(ClaimTypes.NameIdentifier)
- `IsWithinScope(Guid? ownerId, PermissionScope scope, Guid userId, List<Guid>? teamMemberIds)`: Check if entity is within user's scope. Return true for All scope; for Team scope check if ownerId matches userId or is in teamMemberIds; for Own scope check ownerId == userId; for None return false. Null ownerId should be accessible to All and Team scopes.
- `GetTeamMemberIds(Guid userId)`: Use IPermissionService or query TeamMembers to get IDs of users in the same team(s). Cache this alongside permission checks if possible. If IPermissionService doesn't expose this, query ApplicationDbContext.TeamMembers directly.

**DTOs** (define as records inside the controller file, following established pattern from CustomFieldsController):
- CompanyListDto: Id, Name, Industry, Website, Phone, Email, City, State, Country, OwnerName (string?), CreatedAt, UpdatedAt
- CompanyDetailDto: All CompanyListDto fields + Address, PostalCode, Size, Description, OwnerId, CustomFields (Dictionary<string,object?>), ContactCount (int)
- CreateCompanyRequest: Name (required), Industry, Website, Phone, Email, Address, City, State, Country, PostalCode, Size, Description, CustomFields
- UpdateCompanyRequest: Same fields as Create
- TimelineEntryDto: Id, Type, Title, Description, Timestamp, UserId, UserName

**Endpoints:**

1. `GET /api/companies` [Authorize(Policy = "Permission:Company:View")]
   - Accept [FromQuery] EntityQueryParams
   - Resolve user's View scope via _permissionService.GetEffectivePermissionAsync(userId, "Company", "View")
   - Get team member IDs for Team scope
   - Call _repository.GetPagedAsync(queryParams, scope, userId, teamMemberIds)
   - Map entities to CompanyListDto (include Owner?.FirstName + " " + Owner?.LastName as OwnerName)
   - Return Ok(pagedResult mapped to DTOs)

2. `GET /api/companies/{id:guid}` [Authorize(Policy = "Permission:Company:View")]
   - Get company by ID
   - If null return NotFound
   - Verify ownership scope (Pitfall 3) -- resolve scope, call IsWithinScope, return Forbid if out of scope
   - Map to CompanyDetailDto including ContactCount from company.Contacts.Count (or a separate count query)
   - Return Ok(dto)

3. `POST /api/companies` [Authorize(Policy = "Permission:Company:Create")]
   - Accept [FromBody] CreateCompanyRequest
   - Validate custom fields: if request.CustomFields has entries, call _customFieldValidator.ValidateAsync("Company", request.CustomFields). Return BadRequest if errors.
   - Create Company entity with TenantId from _tenantProvider, OwnerId = current user, map all fields
   - Return CreatedAtAction(nameof(GetById), new { id }, CompanyListDto)

4. `PUT /api/companies/{id:guid}` [Authorize(Policy = "Permission:Company:Edit")]
   - Get existing company, verify not null, verify scope
   - Validate custom fields if provided
   - Update fields, set UpdatedAt = UtcNow
   - Return NoContent

5. `DELETE /api/companies/{id:guid}` [Authorize(Policy = "Permission:Company:Delete")]
   - Get company, verify not null, verify scope
   - Delete via repository
   - Return NoContent

6. `GET /api/companies/{id:guid}/timeline` [Authorize(Policy = "Permission:Company:View")]
   - Verify scope access
   - Build timeline entries from:
     a. Entity creation: { type: "created", title: "Company created", timestamp: company.CreatedAt }
     b. Entity update (if UpdatedAt != CreatedAt): { type: "updated", title: "Company updated", timestamp: company.UpdatedAt }
     c. Linked contacts: for each contact linked to this company, { type: "contact_linked", title: "Contact {FullName} linked", timestamp: contact.CreatedAt }
   - Sort by timestamp descending
   - Return Ok(entries)

**ContactsController.cs:**
Same pattern as CompaniesController but with Contact-specific fields:

DTOs:
- ContactListDto: Id, FirstName, LastName, FullName, Email, Phone, JobTitle, CompanyId, CompanyName (string?), OwnerName, CreatedAt, UpdatedAt
- ContactDetailDto: All list fields + MobilePhone, Department, Address, City, State, Country, PostalCode, Description, OwnerId, CustomFields
- CreateContactRequest: FirstName (required), LastName (required), Email, Phone, MobilePhone, JobTitle, Department, Address, City, State, Country, PostalCode, Description, CompanyId (Guid?), CustomFields
- UpdateContactRequest: Same as Create

Endpoints follow same pattern (Permission:Contact:View/Create/Edit/Delete). Key differences:
- Create: sets CompanyId from request (nullable)
- Detail: include CompanyName from Company navigation
- Timeline: includes creation, update, and company link event

Additional endpoint:
7. `GET /api/companies/{id:guid}/contacts` [Authorize(Policy = "Permission:Contact:View")]
   - Returns contacts linked to a specific company (for the Company detail Contacts tab)
   - Simple list (not paginated for now) of ContactListDto
  </action>
  <verify>`dotnet build` passes with 0 errors. Both controller files exist with correct [Authorize(Policy)] attributes.</verify>
  <done>CompaniesController has 6 endpoints (CRUD + timeline + contacts). ContactsController has 6 endpoints (CRUD + timeline). Both enforce ownership scope on list and detail. Custom fields validated on create/update.</done>
</task>

<task type="auto">
  <name>Task 2: Create ProductsController</name>
  <files>
    src/GlobCRM.Api/Controllers/ProductsController.cs
  </files>
  <action>
**ProductsController.cs:**
Simpler than Company/Contact -- products are shared resources (no ownership scope).

```csharp
[ApiController]
[Route("api/products")]
[Authorize]
public class ProductsController : ControllerBase
```

Dependencies: IProductRepository, ICustomFieldRepository, CustomFieldValidator, ITenantProvider.

**DTOs:**
- ProductListDto: Id, Name, Description, UnitPrice, SKU, Category, IsActive, CreatedAt, UpdatedAt
- ProductDetailDto: All list fields + CustomFields (Dictionary<string, object?>)
- CreateProductRequest: Name (required), Description, UnitPrice (required, > 0), SKU, Category, CustomFields
- UpdateProductRequest: Same as Create + IsActive (bool)

**Endpoints:**

1. `GET /api/products` [Authorize(Policy = "Permission:Product:View")]
   - Accept [FromQuery] EntityQueryParams
   - No ownership scope needed (products are shared)
   - Default filter: only active products (IsActive == true) unless explicitly filtering by isActive
   - Call _repository.GetPagedAsync(queryParams)
   - Return Ok(pagedResult mapped to DTOs)

2. `GET /api/products/{id:guid}` [Authorize(Policy = "Permission:Product:View")]
   - Get by ID, map to detail DTO, return Ok
   - No ownership scope check needed

3. `POST /api/products` [Authorize(Policy = "Permission:Product:Create")]
   - Validate: Name required, UnitPrice >= 0
   - Validate custom fields
   - Create entity with TenantId
   - Return CreatedAtAction

4. `PUT /api/products/{id:guid}` [Authorize(Policy = "Permission:Product:Edit")]
   - Get existing, validate, update fields including IsActive
   - Validate custom fields if provided
   - Return NoContent

5. `DELETE /api/products/{id:guid}` [Authorize(Policy = "Permission:Product:Delete")]
   - Hard delete (or consider soft-delete via IsActive = false)
   - For now, hard delete -- products can be deactivated separately
   - Return NoContent

No timeline endpoint for products (products don't have entity timelines).

**Validation:**
Use inline FluentValidation (following established pattern from CustomFieldsController) for CreateProductRequest -- validate Name not empty, UnitPrice >= 0.
  </action>
  <verify>`dotnet build` passes with 0 errors. ProductsController exists with 5 endpoints and correct permission policies.</verify>
  <done>ProductsController has 5 endpoints (CRUD without timeline) with permission enforcement, custom field validation, and active product filtering</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- CompaniesController: GET (list), GET/{id}, POST, PUT/{id}, DELETE/{id}, GET/{id}/timeline, GET/{id}/contacts -- 7 endpoints
- ContactsController: GET (list), GET/{id}, POST, PUT/{id}, DELETE/{id}, GET/{id}/timeline -- 6 endpoints
- ProductsController: GET (list), GET/{id}, POST, PUT/{id}, DELETE/{id} -- 5 endpoints
- All CRUD endpoints have [Authorize(Policy = "Permission:Entity:Op")] attributes
- Company/Contact detail endpoints check ownership scope (return 403 if out of scope)
- Custom field validation runs on create and update
- Timeline endpoints return chronological events
</verification>

<success_criteria>
- 18 total REST endpoints across 3 controllers
- Permission enforcement via policy attributes matches EntityType enum names
- Ownership scope verified on list AND detail endpoints for Company and Contact
- Custom field validation errors return 400 with error details
- Timeline returns creation, update, and contact-link events sorted by timestamp
- Products default to showing only active items
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-05-SUMMARY.md`
</output>
