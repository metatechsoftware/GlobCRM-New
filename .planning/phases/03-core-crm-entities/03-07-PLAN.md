---
phase: 03-core-crm-entities
plan: 07
type: execute
wave: 4
depends_on: ["03-02", "03-03", "03-05"]
files_modified:
  - globcrm-web/src/app/features/contacts/contacts.routes.ts
  - globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts
  - globcrm-web/src/app/features/contacts/contact-list/contact-list.component.html
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
  - globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
autonomous: true

must_haves:
  truths:
    - "User can see a list of contacts in a dynamic table with company name column"
    - "User can create a contact with an optional company link"
    - "User can view contact details with Company tab showing linked company info"
    - "Contact detail shows entity timeline sidebar"
    - "User can edit contact's company link"
  artifacts:
    - path: "globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts"
      provides: "Contact list page with DynamicTableComponent and company name column"
      contains: "ContactListComponent"
    - path: "globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts"
      provides: "Contact detail page with Company tab and timeline"
      contains: "ContactDetailComponent"
    - path: "globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts"
      provides: "Contact create/edit form with company selector"
      contains: "ContactFormComponent"
    - path: "globcrm-web/src/app/features/contacts/contacts.routes.ts"
      provides: "Lazy-loaded routes: list, new, :id, :id/edit"
      contains: "CONTACT_ROUTES"
  key_links:
    - from: "contact-list.component.ts"
      to: "ContactStore"
      via: "Component-provided signal store"
      pattern: "inject.*ContactStore"
    - from: "contact-form.component.ts"
      to: "CompanyService"
      via: "Company search/select for linking"
      pattern: "CompanyService"
    - from: "contact-detail.component.ts"
      to: "EntityTimelineComponent"
      via: "Timeline sidebar"
      pattern: "app-entity-timeline"
---

<objective>
Build the complete Contact feature UI: list page with dynamic table (including company name column), detail page with Company tab and timeline, and create/edit form with company linking.

Purpose: Implements CONT-01 through CONT-06. Contacts are tightly related to companies -- the company link is the first real relational feature in GlobCRM.

Output: Contact list page, detail page, form component, and feature routes.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-02-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-03-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-05-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContactListComponent with dynamic table integration</name>
  <files>
    globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts
    globcrm-web/src/app/features/contacts/contact-list/contact-list.component.html
    globcrm-web/src/app/features/contacts/contacts.routes.ts
  </files>
  <action>
**ContactListComponent** -- follows the same pattern as CompanyListComponent (from Plan 06):

Standalone component with providers: [ViewStore, ContactStore].

**Key differences from Company list:**
1. Core columns include: firstName, lastName (or fullName), email, phone, jobTitle, companyName, ownerName, createdAt
2. The companyName column comes from the API DTO (server-side join), not a client-side lookup
3. Column definitions merge core contact fields + custom fields from CustomFieldService.getFieldsByEntityType('Contact')
4. Default visible columns: fullName (or firstName + lastName), email, phone, jobTitle, companyName, createdAt

Event handlers follow the same pattern: sort, page, filter, search, row click -> navigate to /contacts/:id.

**Template follows same layout as company-list:**
- View sidebar for 'Contact' entity type
- List header with "Contacts" title and "New Contact" button (*appHasPermission="'Contact:Create'")
- Filter chips + filter panel
- Dynamic table with contact data

**contacts.routes.ts:**
```typescript
export const CONTACT_ROUTES: Routes = [
  { path: '', component: ContactListComponent },
  { path: 'new', loadComponent: () => import('./contact-form/contact-form.component').then(m => m.ContactFormComponent) },
  { path: ':id', loadComponent: () => import('./contact-detail/contact-detail.component').then(m => m.ContactDetailComponent) },
  { path: ':id/edit', loadComponent: () => import('./contact-form/contact-form.component').then(m => m.ContactFormComponent) },
];
```
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` compiles</verify>
  <done>ContactListComponent renders dynamic table with company name column, saved views, filter panel, and permission-guarded New Contact button</done>
</task>

<task type="auto">
  <name>Task 2: Create ContactDetailComponent and ContactFormComponent</name>
  <files>
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
    globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
  </files>
  <action>
**ContactDetailComponent:**
Same layout pattern as CompanyDetailComponent but with contact-specific tabs.

**Header:** Back to Contacts + Contact full name + Edit/Delete buttons (permission-guarded)
**Subheader:** Email, Phone, Job Title, Company Name (clickable link to /companies/{companyId})

**Tab group:**
- Details tab: Core fields display + CustomFieldFormComponent in readonly mode for 'Contact' entity type
- Company tab (ACTIVE): Shows linked company info if contact has a companyId:
  - Company name (link to /companies/{companyId}), industry, phone, website
  - If no company linked: "No company linked" message with "Link Company" button (navigates to edit)
- Deals tab: disabled, label="Deals (Phase 4)"
- Quotes tab: disabled, label="Quotes (Phase 6)"
- Activities tab: disabled, label="Activities (Phase 5)"
- Emails tab: disabled, label="Emails (Phase 7)"
- Notes tab: disabled, label="Notes (Phase 11)"

**Timeline sidebar:** app-entity-timeline with entries from contactService.getTimeline(id)

**Delete handling:** Same confirmation dialog pattern as Company.

**ContactFormComponent:**
Similar to CompanyFormComponent but with contact-specific fields and company linking.

**Form fields:**
- firstName: ['', [Validators.required, Validators.maxLength(100)]]
- lastName: ['', [Validators.required, Validators.maxLength(100)]]
- email, phone, mobilePhone, jobTitle, department: ['']
- address, city, state, country, postalCode, description: ['']
- companyId: [null] -- nullable Guid for company link

**Company selector (CONT-03):**
Add a mat-form-field with mat-autocomplete for company selection:
1. Input field labeled "Company" with typeahead
2. On input change (debounced 300ms), call companyService.getList({ search: inputValue, pageSize: 10 }) to search companies
3. Display matching companies in mat-autocomplete dropdown showing company name + industry
4. On selection, set form's companyId to selected company's ID
5. Show currently linked company name in the input when editing
6. Allow clearing the company link (set companyId to null)

This is the key differentiator from the Company form -- the company autocomplete selector implements CONT-03 "link contacts to companies."

**Custom fields:** Include CustomFieldFormComponent with entityType='Contact'.

**Submit:** Same pattern -- create or update via contactService, navigate on success.

Import CompanyService for the company autocomplete. Use MatAutocompleteModule.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` compiles</verify>
  <done>ContactDetailComponent shows contact details with Company tab (linked company info), timeline sidebar, and edit/delete actions. ContactFormComponent has company autocomplete selector for CONT-03 linking.</done>
</task>

</tasks>

<verification>
- All contact feature files exist in features/contacts/
- Contact list includes companyName column from API
- Contact detail has Company tab showing linked company info with navigation link
- Contact form has company autocomplete for linking contacts to companies
- Routes: /contacts (list), /contacts/new, /contacts/:id, /contacts/:id/edit
- Permission directives guard New, Edit, Delete
- ng build compiles
</verification>

<success_criteria>
- CONT-01: CRUD via form and list
- CONT-02: List page uses DynamicTableComponent with adjustable columns
- CONT-03: Form has company autocomplete selector for linking/unlinking
- CONT-04: Detail page has Company tab (active) + Deals/Activities/Emails/Quotes/Notes tabs (disabled)
- CONT-05: Detail page shows entity timeline sidebar
- CONT-06: Custom fields render in both form and detail via CustomFieldFormComponent
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-07-SUMMARY.md`
</output>
