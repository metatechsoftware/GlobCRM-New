---
phase: 03-core-crm-entities
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts
  - globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
autonomous: true

must_haves:
  truths:
    - "Custom field form renders inputs for all 9 field types based on field definitions"
    - "Entity timeline displays chronological events in a vertical list"
    - "Related entity tabs show tabbed navigation with active and disabled (coming soon) tabs"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts"
      provides: "Reusable custom field form that renders dynamic inputs per field definitions"
      contains: "CustomFieldFormComponent"
    - path: "globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts"
      provides: "Vertical timeline component accepting TimelineEntry array"
      contains: "EntityTimelineComponent"
    - path: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      provides: "Tab configuration component with active/disabled tabs and content projection"
      contains: "RelatedEntityTabsComponent"
  key_links:
    - from: "custom-field-form.component.ts"
      to: "custom-field.service.ts"
      via: "Loads field definitions by entityType"
      pattern: "CustomFieldService"
    - from: "entity-timeline.component.ts"
      to: "TimelineEntry"
      via: "Input property accepting timeline data"
      pattern: "TimelineEntry"
---

<objective>
Build three reusable shared components that will be consumed by all entity detail pages and forms: a custom field form renderer, an entity timeline, and a related entity tabs shell.

Purpose: These components are shared across Company, Contact, and (partially) Product detail pages. Building them as shared components prevents duplication and ensures consistency.

Output: 3 standalone Angular components in shared/components/.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@globcrm-web/src/app/core/custom-fields/custom-field.service.ts
@globcrm-web/src/app/core/custom-fields/custom-field.models.ts
@globcrm-web/src/app/core/permissions/permission.store.ts
@globcrm-web/src/app/shared/directives/field-access.directive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomFieldFormComponent for dynamic field rendering</name>
  <files>
    globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts
  </files>
  <action>
Create a standalone Angular component that dynamically renders form inputs for custom fields based on their field definitions. Follow the pattern from research (Pattern 5).

**Component design:**
- Selector: 'app-custom-field-form'
- Standalone: true
- Inputs:
  - entityType: required string input ('Company', 'Contact', 'Product')
  - customFieldValues: optional Record<string, any> input (current values for edit mode)
  - readonly: boolean input (default false) -- for detail page view mode
- Outputs:
  - valuesChanged: EventEmitter<Record<string, any>> -- emits whenever a field value changes

**Behavior:**
1. On init (or when entityType changes), call CustomFieldService.getFieldsByEntityType(entityType) to load field definitions
2. Group fields by section (use CustomFieldService.getSections() or group by sectionId). Fields without a section go in a "General" group.
3. For each field definition, render the appropriate Material input based on fieldType:
   - Text: mat-form-field with matInput (text)
   - Number: mat-form-field with matInput (number)
   - Date: mat-form-field with mat-datepicker
   - Dropdown: mat-form-field with mat-select, options from field.options
   - Checkbox: mat-checkbox
   - MultiSelect: mat-form-field with mat-select[multiple], options from field.options
   - Currency: mat-form-field with matInput (number) and currency prefix from field.validation.currencyCode or '$'
   - File: simple file input (placeholder for now -- file upload deferred to Phase 11)
   - Relation: mat-form-field with matInput (text) as placeholder (relation autocomplete deferred to when related entities exist)
4. Apply field-level access control: check PermissionStore for field access level (hidden/readonly/editable). Use the existing FieldAccessDirective or manually check PermissionStore.getFieldAccess(entityType, fieldId). If hidden, don't render. If readonly, set input to readonly.
5. For required fields (field.validation?.required === true), add required attribute and show mat-error.
6. When any field value changes, collect all current values and emit via valuesChanged output.

**Template approach:**
Use @switch on field.fieldType for each field type. Wrap sections in mat-expansion-panel or simple div with h3 header. Use Angular Material form fields throughout.

**Form control management:**
Create a FormGroup dynamically with FormControl per field. Initialize values from customFieldValues input. On value changes, emit the current form values as Record<string, any>.

Import: CommonModule, ReactiveFormsModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatCheckboxModule, MatDatepickerModule, MatNativeDateModule, MatExpansionModule, MatIconModule.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` compiles without errors</verify>
  <done>CustomFieldFormComponent renders inputs for all 9 field types, groups by section, respects readonly mode, and emits value changes</done>
</task>

<task type="auto">
  <name>Task 2: Create EntityTimelineComponent and RelatedEntityTabsComponent</name>
  <files>
    globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  </files>
  <action>
**EntityTimelineComponent:**
- Selector: 'app-entity-timeline'
- Standalone: true
- Inputs:
  - entries: TimelineEntry[] (the timeline data, loaded by parent component)
  - isLoading: boolean (default false)
- Template: Vertical timeline layout using CSS (not a library):
  - Each entry rendered as a timeline item with:
    - Icon based on entry.type (mat-icon): created -> 'add_circle', updated -> 'edit', contact_linked -> 'person_add', contact_unlinked -> 'person_remove', deal_created -> 'handshake', activity -> 'task', note -> 'note', email -> 'email'
    - Title text (entry.title)
    - Description text if present (entry.description)
    - Timestamp formatted with DatePipe (e.g., "Feb 16, 2026 at 3:30 PM")
    - User name if present (entry.userName)
  - Timeline connector line between items (CSS border-left or pseudo-element)
  - Empty state message: "No activity yet" when entries is empty
  - Loading state with mat-spinner when isLoading is true
- Styling: Use a .timeline-container with .timeline-item entries. Each item has a .timeline-dot (colored circle with icon), .timeline-line (vertical connector), and .timeline-content (title + description + metadata). Use theme colors for dot background.

**RelatedEntityTabsComponent:**
- Selector: 'app-related-entity-tabs'
- Standalone: true
- Inputs:
  - tabs: TabConfig[] where TabConfig = { label: string, disabled: boolean, disabledLabel?: string }
  - activeTabIndex: number (default 0)
- Outputs:
  - tabChanged: EventEmitter<number> -- emits index when tab changes
- Template: Uses mat-tab-group with mat-tab for each tab config:
  - Active tabs show their label
  - Disabled tabs show label + " (coming soon)" and are disabled
  - Content for each tab is projected via ng-content with select attribute matching tab index
- This component is a thin wrapper around mat-tab-group that standardizes the tab configuration pattern across entity detail pages. Each entity detail page will provide the tab content via content projection or by using separate templates.

Actually, given that mat-tab-group already handles disabled tabs natively and content projection with mat-tab is straightforward, this component may be too thin. Instead, make it a helper that provides the standard tab configuration per entity type:

Alternative simpler approach -- just export tab configuration constants:
```typescript
export interface EntityTab {
  label: string;
  icon: string;
  enabled: boolean;
  routerLink?: string;
}

export const COMPANY_TABS: EntityTab[] = [
  { label: 'Details', icon: 'info', enabled: true },
  { label: 'Contacts', icon: 'people', enabled: true },
  { label: 'Deals', icon: 'handshake', enabled: false },
  { label: 'Quotes', icon: 'request_quote', enabled: false },
  { label: 'Activities', icon: 'task_alt', enabled: false },
  { label: 'Notes', icon: 'note', enabled: false },
];

export const CONTACT_TABS: EntityTab[] = [
  { label: 'Details', icon: 'info', enabled: true },
  { label: 'Company', icon: 'business', enabled: true },
  { label: 'Deals', icon: 'handshake', enabled: false },
  { label: 'Quotes', icon: 'request_quote', enabled: false },
  { label: 'Activities', icon: 'task_alt', enabled: false },
  { label: 'Notes', icon: 'note', enabled: false },
];
```

Use the component approach -- it will render mat-tab-group with the proper disabled state and "coming soon" labels for future tabs, and use ng-template/ng-container for content slots. This keeps entity detail pages clean.

Import: CommonModule, MatTabsModule, MatIconModule, MatProgressSpinnerModule, DatePipe.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` compiles without errors</verify>
  <done>EntityTimelineComponent renders vertical timeline with icons per event type. RelatedEntityTabsComponent provides standardized tab configuration with disabled "coming soon" tabs for future entity types.</done>
</task>

</tasks>

<verification>
- All 3 component files exist in shared/components/
- CustomFieldFormComponent handles all 9 field types
- EntityTimelineComponent renders timeline entries with icons
- RelatedEntityTabsComponent provides tab configs for Company and Contact
- ng build compiles without errors
</verification>

<success_criteria>
- CustomFieldFormComponent dynamically renders form inputs based on field definitions from CustomFieldService
- EntityTimelineComponent accepts TimelineEntry[] and displays vertical timeline with type-specific icons
- Tab configuration supports active tabs (Details, Contacts/Company) and disabled tabs (Deals, Quotes, Activities, Notes)
- All components are standalone and can be imported by entity feature modules
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-03-SUMMARY.md`
</output>
