---
phase: 03-core-crm-entities
plan: 09
type: execute
wave: 5
depends_on: ["03-06", "03-07", "03-08"]
files_modified:
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/app.routes.ts
autonomous: false

must_haves:
  truths:
    - "Navbar shows Companies, Contacts, Products navigation links"
    - "App routing lazy-loads company, contact, product feature routes"
    - "User can navigate from navbar to any entity list page"
    - "All entity CRUD flows work end-to-end (list -> detail -> form -> save -> list)"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      provides: "Updated navbar with CRM entity navigation links"
      contains: "companies"
    - path: "globcrm-web/src/app/app.routes.ts"
      provides: "Lazy-loaded routes for companies, contacts, products features"
      contains: "companies"
  key_links:
    - from: "app.routes.ts"
      to: "companies.routes.ts"
      via: "Lazy-loaded feature routes"
      pattern: "loadChildren.*companies"
    - from: "app.routes.ts"
      to: "contacts.routes.ts"
      via: "Lazy-loaded feature routes"
      pattern: "loadChildren.*contacts"
    - from: "app.routes.ts"
      to: "products.routes.ts"
      via: "Lazy-loaded feature routes"
      pattern: "loadChildren.*products"
    - from: "navbar.component.html"
      to: "/companies, /contacts, /products"
      via: "routerLink navigation"
      pattern: "routerLink.*companies"
---

<objective>
Wire all Phase 3 entity features into the application shell: add CRM navigation links to the navbar, register lazy-loaded routes in app.routes.ts, and verify the end-to-end flow works.

Purpose: Without routing and navigation, the entity pages are unreachable. This plan connects everything and provides a verification checkpoint to confirm all Phase 3 features work together.

Output: Updated navbar with CRM links, updated app routes, and verified E2E integration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-06-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-07-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-08-SUMMARY.md
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/app.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update navbar and app routes for CRM entity navigation</name>
  <files>
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
**navbar.component.html updates:**
Add CRM entity navigation links between the Dashboard and Team links. The nav link order should be:
Dashboard | Companies | Contacts | Products | Team | Settings

Update the nav links section:
```html
<!-- Nav Links -->
<a mat-button routerLink="/dashboard" routerLinkActive="active-link">Dashboard</a>
<a mat-button routerLink="/companies" routerLinkActive="active-link">Companies</a>
<a mat-button routerLink="/contacts" routerLinkActive="active-link">Contacts</a>
<a mat-button routerLink="/products" routerLinkActive="active-link">Products</a>
<a mat-button routerLink="/team-directory" routerLinkActive="active-link">Team</a>
<a mat-button routerLink="/settings/roles" routerLinkActive="active-link">Settings</a>
```

Per research Open Question 4: CRM entity links go in the primary navigation section, ordered as Dashboard first, then entity pages, then admin pages.

**app.routes.ts updates:**
Add lazy-loaded routes for all 3 entity features. Insert them after the dashboard route and before settings:

```typescript
{
  path: 'companies',
  canActivate: [authGuard],
  loadChildren: () =>
    import('./features/companies/companies.routes').then(
      (m) => m.COMPANY_ROUTES
    ),
},
{
  path: 'contacts',
  canActivate: [authGuard],
  loadChildren: () =>
    import('./features/contacts/contacts.routes').then(
      (m) => m.CONTACT_ROUTES
    ),
},
{
  path: 'products',
  canActivate: [authGuard],
  loadChildren: () =>
    import('./features/products/products.routes').then(
      (m) => m.PRODUCT_ROUTES
    ),
},
```

All three routes need authGuard to ensure only authenticated users can access them. Permission enforcement happens at the component level (via *appHasPermission and backend [Authorize(Policy)]).
  </action>
  <verify>
1. `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` -- builds without errors
2. Verify navbar HTML contains routerLink="/companies", routerLink="/contacts", routerLink="/products"
3. Verify app.routes.ts contains 3 new lazy-loaded route entries with authGuard
  </verify>
  <done>Navbar shows Companies, Contacts, Products links. App routes lazy-load all 3 entity features with authGuard protection.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of Phase 3 CRM entity features</name>
  <files>
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
Present the following verification steps to the user. All code changes are already complete from Task 1 and prior plans. This is a human verification checkpoint.

Complete Phase 3 features built:
- Backend: Company, Contact, Product domain entities with EF Core, RLS, repositories, and REST API controllers
- Frontend: Dynamic table list pages, detail pages with tabs and timeline, create/edit forms with custom fields
- Navigation: Navbar CRM links and lazy-loaded routes
- Seed data: Companies, contacts, products seeded for new organizations
- Permissions: Template roles updated with Company, Contact, Product entity permissions

Steps for the user to verify:
1. Start the backend: cd src/GlobCRM.Api and dotnet run
2. Start the frontend: cd globcrm-web and ng serve
3. Log in with test account
4. Click "Companies" in navbar -- verify dynamic table renders
5. Create a new company with custom fields -- verify it appears in list
6. Click company to see detail page with tabs and timeline
7. Click "Contacts" -- create a contact linked to the company via autocomplete
8. Verify contact list shows company name column
9. Click contact detail -- verify Company tab shows linked company
10. Click "Products" -- create a product with price, SKU, category
11. Verify product detail shows all fields
12. Check that permission directives show/hide buttons correctly
  </action>
  <verify>User confirms all CRUD flows work for Companies, Contacts, and Products with custom fields, dynamic tables, and relational navigation</verify>
  <done>User types "approved" confirming all Phase 3 success criteria are met, or describes issues to be fixed in gap closure plans</done>
</task>

</tasks>

<verification>
- navbar.component.html has Companies, Contacts, Products links
- app.routes.ts has 3 lazy-loaded entity routes
- ng build and dotnet build both pass
- Full CRUD flow works for all 3 entities
- Dynamic table, views, filters work on list pages
- Custom fields render in forms and detail pages
- Permission enforcement works (buttons shown/hidden, 403 on unauthorized API calls)
</verification>

<success_criteria>
Phase 3 success criteria from ROADMAP.md:
1. User can create, view, edit, and delete companies with custom fields
2. Company list page uses dynamic table and company detail shows entity timeline
3. User can create, view, edit, and delete contacts and link them to companies
4. Contact list page uses dynamic table and contact detail shows entity timeline
5. User can navigate from company to related contacts, deals, quotes, and activities
6. User can create products with name, description, unit price, SKU, and category for use in quotes
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-09-SUMMARY.md`
</output>
