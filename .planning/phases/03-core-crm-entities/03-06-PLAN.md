---
phase: 03-core-crm-entities
plan: 06
type: execute
wave: 4
depends_on: ["03-02", "03-03", "03-05"]
files_modified:
  - globcrm-web/src/app/features/companies/companies.routes.ts
  - globcrm-web/src/app/features/companies/company-list/company-list.component.ts
  - globcrm-web/src/app/features/companies/company-list/company-list.component.html
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.html
  - globcrm-web/src/app/features/companies/company-form/company-form.component.ts
autonomous: true

must_haves:
  truths:
    - "User can see a list of companies in a dynamic table with adjustable columns"
    - "User can create a new company via a form with core fields and custom fields"
    - "User can view company details with tabs (Details, Contacts, and disabled future tabs)"
    - "Company detail shows entity timeline sidebar"
    - "User can edit and delete companies from the detail page"
  artifacts:
    - path: "globcrm-web/src/app/features/companies/company-list/company-list.component.ts"
      provides: "Company list page with DynamicTableComponent, ViewSidebar, FilterPanel"
      contains: "CompanyListComponent"
    - path: "globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts"
      provides: "Company detail page with tabs, timeline, edit/delete actions"
      contains: "CompanyDetailComponent"
    - path: "globcrm-web/src/app/features/companies/company-form/company-form.component.ts"
      provides: "Company create/edit form with core fields and custom field integration"
      contains: "CompanyFormComponent"
    - path: "globcrm-web/src/app/features/companies/companies.routes.ts"
      provides: "Lazy-loaded routes: list, new, :id, :id/edit"
      contains: "COMPANY_ROUTES"
  key_links:
    - from: "company-list.component.ts"
      to: "CompanyStore"
      via: "Component-provided signal store for list state"
      pattern: "inject.*CompanyStore"
    - from: "company-list.component.ts"
      to: "DynamicTableComponent"
      via: "Template binding for data, columns, events"
      pattern: "app-dynamic-table"
    - from: "company-detail.component.ts"
      to: "EntityTimelineComponent"
      via: "Timeline sidebar with company events"
      pattern: "app-entity-timeline"
    - from: "company-form.component.ts"
      to: "CustomFieldFormComponent"
      via: "Renders custom field inputs alongside core fields"
      pattern: "app-custom-field-form"
---

<objective>
Build the complete Company feature UI: list page with dynamic table and saved views, detail page with tabs and timeline, and create/edit form with custom field integration.

Purpose: This implements COMP-01 through COMP-05 requirements -- the first user-facing CRM entity pages that validate the entire Phase 2 infrastructure (dynamic tables, views, permissions, custom fields) working together.

Output: Company list page, detail page, form component, and feature routes.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-crm-entities/03-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-02-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-03-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-05-SUMMARY.md
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/shared/components/saved-views/view.store.ts
@globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts
@globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.ts
@globcrm-web/src/app/core/permissions/permission.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompanyListComponent with dynamic table integration</name>
  <files>
    globcrm-web/src/app/features/companies/company-list/company-list.component.ts
    globcrm-web/src/app/features/companies/company-list/company-list.component.html
    globcrm-web/src/app/features/companies/companies.routes.ts
  </files>
  <action>
**CompanyListComponent** -- follow the research Angular Entity List Page Pattern exactly:

Standalone component with providers: [ViewStore, CompanyStore] (component-provided, not root).

Imports: CommonModule, RouterLink, MatButtonModule, MatIconModule, DynamicTableComponent, FilterPanelComponent, FilterChipsComponent, ViewSidebarComponent, HasPermissionDirective.

**Component logic:**
- Inject: ViewStore, CompanyStore, CustomFieldService, PermissionStore, Router
- On init:
  1. Call viewStore.loadViews('Company') to load saved views
  2. Load custom field definitions via customFieldService.getFieldsByEntityType('Company')
  3. Build column definitions by merging core field columns with custom field columns:
     - Core columns: name, industry, phone, email, city, country, ownerName, createdAt
     - Custom field columns: from loaded field definitions (fieldId=definition.id, label=definition.label, fieldType based on definition.fieldType)
  4. Set default visible columns (name, industry, email, city, ownerName, createdAt)
  5. Call companyStore.loadPage() to fetch initial data

- Event handlers:
  - `onViewSelected(view)`: Apply view's columns, filters, sorts to store and table
  - `onSortChanged({field, direction})`: Call companyStore.setSort(field, direction)
  - `onPageChanged(page)`: Call companyStore.setPage(page)
  - `onFilterApplied(filters)`: Call companyStore.setFilters(filters)
  - `onSearchChanged(search)`: Call companyStore.setSearch(search)
  - `onRowClicked(row)`: Navigate to /companies/{row.id}
  - `onRowEditClicked(row)`: Navigate to /companies/{row.id}/edit

**Template (company-list.component.html):**
```html
<div class="entity-list-layout">
  <app-view-sidebar
    [entityType]="'Company'"
    (viewSelected)="onViewSelected($event)" />

  <div class="entity-list-content">
    <div class="list-header">
      <h1>Companies</h1>
      <button mat-raised-button color="primary"
              *appHasPermission="'Company:Create'"
              routerLink="new">
        <mat-icon>add</mat-icon> New Company
      </button>
    </div>

    <app-filter-chips
      [filters]="companyStore.filters()"
      [columnDefinitions]="columnDefs()"
      (filterRemoved)="onFilterRemoved($event)"
      (filtersCleared)="onFiltersCleared()" />

    <app-filter-panel
      [columnDefinitions]="columnDefs()"
      [filters]="companyStore.filters()"
      (filtersApplied)="onFilterApplied($event)" />

    <app-dynamic-table
      entityType="Company"
      [data]="companyStore.items()"
      [columns]="activeViewColumns()"
      [columnDefinitions]="columnDefs()"
      [totalCount]="companyStore.totalCount()"
      [pageSize]="companyStore.pageSize()"
      [loading]="companyStore.isLoading()"
      (sortChanged)="onSortChanged($event)"
      (pageChanged)="onPageChanged($event)"
      (rowClicked)="onRowClicked($event)" />
  </div>
</div>
```

Use signals for reactive state: columnDefs as a signal, activeViewColumns as a computed signal.

**companies.routes.ts:**
```typescript
export const COMPANY_ROUTES: Routes = [
  { path: '', component: CompanyListComponent },
  { path: 'new', loadComponent: () => import('./company-form/company-form.component').then(m => m.CompanyFormComponent) },
  { path: ':id', loadComponent: () => import('./company-detail/company-detail.component').then(m => m.CompanyDetailComponent) },
  { path: ':id/edit', loadComponent: () => import('./company-form/company-form.component').then(m => m.CompanyFormComponent) },
];
```
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` compiles</verify>
  <done>CompanyListComponent renders dynamic table with saved views sidebar, filter panel, and New Company button guarded by permission. Routes defined for list, new, detail, edit.</done>
</task>

<task type="auto">
  <name>Task 2: Create CompanyDetailComponent and CompanyFormComponent</name>
  <files>
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.html
    globcrm-web/src/app/features/companies/company-form/company-form.component.ts
  </files>
  <action>
**CompanyDetailComponent:**
Follow the research Pattern 4 (Entity Detail Page with Tabs and Timeline).

Standalone component. Inject: ActivatedRoute, Router, CompanyService, PermissionStore.

On init: Extract :id from route params, call companyService.getById(id) and companyService.getTimeline(id) to load data.

**Template layout:**
```
Header: Back link + Company Name + [Edit] [Delete] buttons (permission-guarded)
  - Back: routerLink="/companies" with mat-icon "arrow_back"
  - Edit: *appHasPermission="'Company:Edit'" routerLink="edit"
  - Delete: *appHasPermission="'Company:Delete'" with confirm dialog

Subheader: Key fields displayed inline (Industry, Phone, Owner)

Tab group (mat-tab-group):
  - Details tab: Core fields display + CustomFieldFormComponent in readonly mode
  - Contacts tab: Mini-list of linked contacts (load from GET /api/companies/{id}/contacts)
    - Show contact name, email, job title in a simple mat-list
    - "View All" link to contacts list filtered by this company
  - Deals tab: disabled, label="Deals (Phase 4)"
  - Quotes tab: disabled, label="Quotes (Phase 6)"
  - Activities tab: disabled, label="Activities (Phase 5)"
  - Notes tab: disabled, label="Notes (Phase 11)"

Timeline sidebar: app-entity-timeline with entries from timeline API
```

Use a two-column layout on desktop: main content (tabs) takes ~65% width, timeline sidebar takes ~35% width. On mobile, stack vertically.

**Delete handling:** Show a confirmation dialog (MatDialog with simple confirm text). On confirm, call companyService.delete(id) then navigate to /companies.

**CompanyFormComponent:**
Used for both create and edit (determined by presence of :id route param).

Standalone component. Inject: ActivatedRoute, Router, CompanyService, FormBuilder.

**Form setup:**
- Reactive form with FormGroup containing all core fields:
  - name: ['', [Validators.required, Validators.maxLength(200)]]
  - industry, website, phone, email, address, city, state, country, postalCode, size, description: ['']
- For edit mode: on init, check if route has :id param. If yes, load company via service and patchValue to form.
- Custom fields: Include CustomFieldFormComponent below core fields. Listen to its valuesChanged output to capture custom field values.

**Template:**
```html
<div class="entity-form-container">
  <div class="form-header">
    <h1>{{ isEditMode ? 'Edit Company' : 'New Company' }}</h1>
  </div>

  <form [formGroup]="companyForm" (ngSubmit)="onSubmit()">
    <!-- Core fields in mat-form-field -->
    <div class="form-grid">
      <mat-form-field>
        <mat-label>Company Name</mat-label>
        <input matInput formControlName="name" required>
        <mat-error>Company name is required</mat-error>
      </mat-form-field>
      <!-- ... industry, website, phone, email, address fields ... -->
    </div>

    <!-- Custom fields -->
    <app-custom-field-form
      [entityType]="'Company'"
      [customFieldValues]="existingCustomFields"
      (valuesChanged)="onCustomFieldsChanged($event)" />

    <!-- Form actions -->
    <div class="form-actions">
      <button mat-button type="button" routerLink="/companies">Cancel</button>
      <button mat-raised-button color="primary" type="submit"
              [disabled]="companyForm.invalid || isSaving()">
        {{ isEditMode ? 'Save Changes' : 'Create Company' }}
      </button>
    </div>
  </form>
</div>
```

**Submit handling:**
- Build request from form values + custom field values
- Create mode: call companyService.create(), on success navigate to /companies/{newId}
- Edit mode: call companyService.update(id), on success navigate to /companies/{id}
- Show error toast/banner on failure

Use a form grid layout (2 columns on desktop, 1 on mobile) for core fields.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -10` compiles</verify>
  <done>CompanyDetailComponent shows company details with tabs (Details active, Contacts active, others disabled), timeline sidebar, and edit/delete actions. CompanyFormComponent handles both create and edit with core + custom fields.</done>
</task>

</tasks>

<verification>
- All company feature files exist in features/companies/
- Company list uses DynamicTableComponent with ViewSidebar
- Company detail has mat-tab-group with Details and Contacts active, others disabled
- Company form renders core fields + custom fields via CustomFieldFormComponent
- Routes: /companies (list), /companies/new (create), /companies/:id (detail), /companies/:id/edit (edit)
- Permission directives guard New, Edit, Delete buttons
- ng build compiles
</verification>

<success_criteria>
- COMP-01: CRUD via form and list (create, view in list, view detail, edit, delete)
- COMP-02: List page uses DynamicTableComponent with adjustable columns
- COMP-03: Detail page has Contacts tab (active) + Deals/Quotes/Activities/Notes tabs (disabled)
- COMP-04: Detail page shows entity timeline sidebar
- COMP-05: Custom fields render in both form and detail page via CustomFieldFormComponent
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-crm-entities/03-06-SUMMARY.md`
</output>
