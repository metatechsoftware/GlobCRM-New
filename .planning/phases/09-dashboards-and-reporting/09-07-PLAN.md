---
phase: 09-dashboards-and-reporting
plan: 07
type: execute
wave: 4
depends_on: ["09-03", "09-06"]
files_modified:
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.scss
  - globcrm-web/src/app/features/dashboard/dashboard.routes.ts
autonomous: true

must_haves:
  truths:
    - "User sees a configurable dashboard with real widget data on the main dashboard page"
    - "User can switch between personal and team-wide dashboards"
    - "User can toggle edit mode to add, remove, drag, and resize widgets"
    - "User can filter dashboard data by date range presets or custom dates"
    - "Dashboard layout persists across page navigations (saved to backend)"
    - "New users see a default dashboard with pre-configured KPI and chart widgets"
  artifacts:
    - path: "globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts"
      provides: "Main dashboard page replacing existing static dashboard"
      contains: "DashboardComponent"
    - path: "globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html"
      provides: "Dashboard page template with selector, date filter, grid, and edit controls"
      contains: "app-dashboard-grid"
    - path: "globcrm-web/src/app/features/dashboard/dashboard.routes.ts"
      provides: "Dashboard routing with DashboardStore provided at component level"
      contains: "DASHBOARD_ROUTES"
  key_links:
    - from: "globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts"
      to: "DashboardStore"
      via: "inject(DashboardStore) with component-level provider"
      pattern: "providers.*DashboardStore"
    - from: "globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts"
      to: "All dashboard sub-components"
      via: "imports array with grid, selector, date filter"
      pattern: "DashboardGridComponent|DashboardSelectorComponent|DateRangeFilterComponent"
    - from: "globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html"
      to: "/api/dashboards"
      via: "DashboardStore -> DashboardApiService -> backend"
      pattern: "store.loadDashboards|store.loadWidgetData"
---

<objective>
Replace the existing static dashboard page with the fully configurable dashboard featuring widget grid, selector, date range filter, and edit mode. Wire all components together through DashboardStore.

Purpose: This is the integration plan that ties everything together. The static greeting/stats/quick-actions dashboard is replaced with the configurable widget-based dashboard system. Users see their default dashboard on load, can switch between dashboards, filter by date range, and toggle edit mode to customize layout.
Output: Fully functional dashboard page with all sub-components wired through the signal store.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md
@.planning/phases/09-dashboards-and-reporting/09-03-SUMMARY.md
@.planning/phases/09-dashboards-and-reporting/09-06-SUMMARY.md

@globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts (existing static dashboard)
@globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html (existing template)
@globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.scss (existing styles)
@globcrm-web/src/app/features/dashboard/dashboard.routes.ts (existing routes)
@globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts
@globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace dashboard page with configurable dashboard</name>
  <files>
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.scss
  </files>
  <action>
    **dashboard.component.ts** -- REPLACE existing static dashboard:
    - Standalone component with providers: [DashboardStore] (component-provided per project pattern)
    - Imports: DashboardGridComponent, DashboardSelectorComponent, DateRangeFilterComponent, WidgetConfigDialogComponent, MatButtonModule, MatIconModule, MatDialogModule, MatSnackBarModule, RouterLink, AuthStore
    - Inject: DashboardStore, MatDialog, MatSnackBar, AuthStore

    On init (constructor or afterNextRender):
    1. Call store.loadDashboards() to fetch all dashboards
    2. Call store.loadTargets() to fetch all targets
    3. After dashboards load, store automatically selects default and calls loadWidgetData()

    Computed signals:
    - greeting: time-of-day greeting (keep from existing component)
    - firstName: from AuthStore (keep from existing component)
    - isAdmin: from AuthStore (User.IsInRole("Admin") equivalent)

    Methods:
    - onDashboardSelected(id: string): store.loadDashboard(id) then store.loadWidgetData()
    - onDateRangeChanged(range: DateRange): store.setDateRange(range) -- store auto-reloads widget data
    - onToggleEdit(): store.toggleEditMode()
    - onLayoutChanged(widgets: WidgetDto[]): store.saveLayout(widgets) with MatSnackBar "Layout saved" on success
    - onAddWidget(): Open WidgetConfigDialogComponent. On close, if result, add widget to active dashboard via store.updateDashboard() with new widget appended to existing widgets.
    - onEditWidget(widget: WidgetDto): Open WidgetConfigDialogComponent with widget data. On close, if result, update widget in active dashboard.
    - onRemoveWidget(widget: WidgetDto): Remove widget from active dashboard via store.updateDashboard() with widget filtered out.
    - onCreateDashboard(): Open a simple prompt dialog (MatDialog with inline component) for dashboard name + isTeamWide toggle. Call store.saveDashboard().
    - onDeleteDashboard(id: string): Confirm via dialog, then store.deleteDashboard().

    **dashboard.component.html** -- REPLACE entirely:
    ```
    <div class="dashboard">
      <!-- Header -->
      <header class="dashboard__header">
        <div class="dashboard__greeting">
          <h1 class="dashboard__title">{{ greeting() }}, {{ firstName() }}</h1>
          <p class="dashboard__subtitle">
            @if (store.activeDashboard(); as dashboard) {
              {{ dashboard.name }}
              @if (dashboard.isTeamWide) {
                <span class="dashboard__badge">Team</span>
              }
            }
          </p>
        </div>
        <div class="dashboard__actions">
          <app-date-range-filter
            [dateRange]="store.dateRange()"
            (dateRangeChanged)="onDateRangeChanged($event)"
          />
          <app-dashboard-selector
            [dashboards]="store.dashboards()"
            [activeDashboardId]="store.activeDashboard()?.id ?? null"
            (dashboardSelected)="onDashboardSelected($event)"
            (createDashboard)="onCreateDashboard()"
            (deleteDashboard)="onDeleteDashboard($event)"
          />
          <button mat-flat-button (click)="onToggleEdit()">
            <mat-icon>{{ store.isEditing() ? 'check' : 'edit' }}</mat-icon>
            {{ store.isEditing() ? 'Done' : 'Edit' }}
          </button>
        </div>
      </header>

      <!-- Add Widget button (edit mode only) -->
      @if (store.isEditing()) {
        <div class="dashboard__toolbar">
          <button mat-stroked-button (click)="onAddWidget()">
            <mat-icon>add</mat-icon>
            Add Widget
          </button>
        </div>
      }

      <!-- Dashboard Grid -->
      @if (store.activeDashboard(); as dashboard) {
        @if (store.isLoading()) {
          <div class="dashboard__loading">
            <mat-icon>hourglass_empty</mat-icon>
            Loading dashboard...
          </div>
        } @else {
          <app-dashboard-grid
            [widgets]="dashboard.widgets"
            [widgetData]="store.widgetData()"
            [targets]="store.targets()"
            [isEditing]="store.isEditing()"
            (layoutChanged)="onLayoutChanged($event)"
            (editWidget)="onEditWidget($event)"
            (removeWidget)="onRemoveWidget($event)"
          />
        }
      } @else if (!store.isLoading()) {
        <!-- No dashboards exist yet -->
        <div class="dashboard__empty">
          <mat-icon>dashboard_customize</mat-icon>
          <h2>No dashboards yet</h2>
          <p>Create your first dashboard to start tracking KPIs and metrics.</p>
          <button mat-flat-button color="primary" (click)="onCreateDashboard()">
            <mat-icon>add</mat-icon>
            Create Dashboard
          </button>
        </div>
      }
    </div>
    ```

    **dashboard.component.scss** -- REPLACE with new styles:
    - Keep max-width: 1120px and responsive padding from existing
    - dashboard__header: flex row with greeting on left, actions (date filter + selector + edit button) on right
    - dashboard__actions: flex row with gap, align items center
    - dashboard__badge: small pill badge for "Team" indicator
    - dashboard__toolbar: padding with add widget button
    - dashboard__loading: centered loading state with icon
    - dashboard__empty: centered empty state with illustration icon, heading, description, and create button
    - Remove all old styles (stat-card, quick-actions, checklist) -- these are replaced by widgets
    - Responsive: stack header vertically on mobile, hide date range presets on small screens

    IMPORTANT: The existing static dashboard (greeting + stat cards + quick actions + getting started checklist) is fully replaced. The greeting is kept but everything else changes to the configurable widget grid.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Dashboard page renders configurable widget grid, supports dashboard switching, date filtering, and edit mode</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard routes</name>
  <files>
    globcrm-web/src/app/features/dashboard/dashboard.routes.ts
  </files>
  <action>
    Update `dashboard.routes.ts` to include the DashboardStore provider at the route level. The routes themselves don't change (the dashboard is still at '' path), but ensure the component import path is correct.

    The route file should remain simple:
    ```typescript
    import { Routes } from '@angular/router';

    export const DASHBOARD_ROUTES: Routes = [
      {
        path: '',
        loadComponent: () =>
          import('./pages/dashboard/dashboard.component').then(
            (m) => m.DashboardComponent
          ),
      },
    ];
    ```

    Note: DashboardStore is provided at the component level (in DashboardComponent's providers array), not at the route level. This matches the existing pattern (DealStore, ActivityStore, etc. are all component-provided).

    If the routes file needs no changes (it may already be correct), just verify it's compatible and leave it as-is.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds. Verify dashboard route loads the new configurable dashboard component.</verify>
  <done>Dashboard routes correctly load the configurable dashboard component</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- Dashboard page shows configurable widget grid (not static stat cards)
- Greeting preserved from existing dashboard
- Dashboard selector shows personal + team dashboards
- Date range filter with presets works
- Edit mode enables drag/resize and shows add/edit/remove widget controls
- Empty state shown when no dashboards exist with create button
</verification>

<success_criteria>
- DASH-01: User can view configurable dashboards with drag-and-drop widgets
- DASH-02: Dashboard widgets include charts (bar, line, pie), KPI cards, leaderboards, and tables (via widget wrapper dispatch)
- DASH-04: Dashboard supports date range filters (via DateRangeFilterComponent)
- DASH-05: Admin can create team-wide dashboards (via create dialog with isTeamWide toggle)
- DASH-06: User can create personal dashboards (via create dialog)
- Dashboard layout changes are saved to backend and persist across page navigations
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-07-SUMMARY.md`
</output>
