---
phase: 09-dashboards-and-reporting
plan: 06
type: execute
wave: 3
depends_on: ["09-05"]
files_modified:
  - globcrm-web/src/app/features/dashboard/components/dashboard-grid/dashboard-grid.component.ts
  - globcrm-web/src/app/features/dashboard/components/widget-config-dialog/widget-config-dialog.component.ts
  - globcrm-web/src/app/features/dashboard/components/dashboard-selector/dashboard-selector.component.ts
  - globcrm-web/src/app/features/dashboard/components/date-range-filter/date-range-filter.component.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard grid uses angular-gridster2 with 12-column layout, drag-and-drop, and resize"
    - "Widget config dialog allows selecting metric type, chart type, and widget title"
    - "Dashboard selector allows switching between personal and team-wide dashboards"
    - "Date range filter provides preset ranges and custom date picker for dashboard filtering"
    - "Grid layout changes persist widget positions (X,Y,Cols,Rows) via store"
  artifacts:
    - path: "globcrm-web/src/app/features/dashboard/components/dashboard-grid/dashboard-grid.component.ts"
      provides: "Gridster2 grid rendering dashboard widgets with drag and resize"
      contains: "DashboardGridComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/widget-config-dialog/widget-config-dialog.component.ts"
      provides: "MatDialog for widget creation and configuration"
      contains: "WidgetConfigDialogComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/dashboard-selector/dashboard-selector.component.ts"
      provides: "Dashboard switcher dropdown"
      contains: "DashboardSelectorComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/date-range-filter/date-range-filter.component.ts"
      provides: "Date range picker with presets for dashboard filtering"
      contains: "DateRangeFilterComponent"
  key_links:
    - from: "globcrm-web/src/app/features/dashboard/components/dashboard-grid/dashboard-grid.component.ts"
      to: "angular-gridster2 GridsterModule"
      via: "gridster component with GridsterConfig"
      pattern: "GridsterModule|GridsterConfig"
    - from: "globcrm-web/src/app/features/dashboard/components/dashboard-grid/dashboard-grid.component.ts"
      to: "widget-wrapper component"
      via: "gridster-item containing widget-wrapper"
      pattern: "app-widget-wrapper"
---

<objective>
Create the dashboard grid (angular-gridster2), widget configuration dialog, dashboard selector, and date range filter components.

Purpose: These components form the dashboard UI framework. The grid provides the drag-and-drop widget layout (DASH-01), the config dialog enables widget creation/editing (DASH-02), the selector enables switching between personal/team dashboards (DASH-05/DASH-06), and the date range filter supports temporal data exploration (DASH-04).
Output: Four components that orchestrate the dashboard experience.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md
@.planning/phases/09-dashboards-and-reporting/09-04-SUMMARY.md
@.planning/phases/09-dashboards-and-reporting/09-05-SUMMARY.md

@globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
@globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts
@globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard grid and widget config dialog</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/dashboard-grid/dashboard-grid.component.ts
    globcrm-web/src/app/features/dashboard/components/widget-config-dialog/widget-config-dialog.component.ts
  </files>
  <action>
    **DashboardGridComponent** (inline template/styles):
    - Standalone, imports GridsterModule, WidgetWrapperComponent, MatButtonModule, MatIconModule
    - Inputs: widgets (WidgetDto[]), widgetData (Record of string to MetricResultDto), targets (TargetDto[]), isEditing (boolean)
    - Outputs: layoutChanged (EventEmitter of WidgetDto[]), editWidget (EventEmitter of WidgetDto), removeWidget (EventEmitter of WidgetDto)

    Gridster configuration (per research):
    ```
    gridOptions: GridsterConfig = {
      gridType: 'verticalFixed',
      fixedRowHeight: 200,
      compactType: 'compactUp',
      draggable: {
        enabled: false,  // toggled by isEditing input
        ignoreContent: true,
        dragHandleClass: 'widget-drag-handle',
      },
      resizable: {
        enabled: false,  // toggled by isEditing input
      },
      pushItems: true,
      swap: false,
      minCols: 12,
      maxCols: 12,
      minRows: 1,
      outerMargin: true,
      outerMarginTop: 16,
      outerMarginRight: 16,
      outerMarginBottom: 16,
      outerMarginLeft: 16,
      margin: 16,
      displayGrid: 'onDrag&Resize',
      itemChangeCallback: (item, itemComponent) => this.onItemChange(item),
      itemResizeCallback: (item, itemComponent) => this.onItemResize(item),
    };
    ```

    Use effect() to watch isEditing input and update gridOptions.draggable.enabled and gridOptions.resizable.enabled, then call gridOptions.api?.optionsChanged() to apply.

    Build gridItems as computed signal: map widgets to GridsterItem objects with { x, y, cols, rows } plus widget reference.

    Template:
    ```
    <gridster [options]="gridOptions" class="dashboard-grid">
      @for (item of gridItems(); track item.widget.id) {
        <gridster-item [item]="item">
          <app-widget-wrapper
            [widget]="item.widget"
            [data]="widgetData()[item.widget.id] ?? null"
            [target]="getTargetForWidget(item.widget)"
            [isEditing]="isEditing()"
            (edit)="editWidget.emit(item.widget)"
            (remove)="removeWidget.emit(item.widget)"
          />
        </gridster-item>
      }
    </gridster>
    ```

    Styles: Set gridster container to `height: calc(100vh - 180px)` to avoid the collapsed height pitfall from research. Use `overflow-y: auto` for scrolling when widgets exceed viewport.

    onItemChange: Emit layoutChanged with updated widget positions (map gridster items back to WidgetDto with new x/y/cols/rows).

    **WidgetConfigDialogComponent** (inline template/styles):
    - Standalone, imports MatDialogModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatButtonModule, ReactiveFormsModule
    - Inject MAT_DIALOG_DATA (optional, for editing existing widget), MatDialogRef
    - Data input: { widget?: WidgetDto } -- null for new widget, populated for edit

    Form (reactive):
    - title: string (required)
    - type: WidgetType (select dropdown with all 7 types)
    - metricType: MetricType (select dropdown with all 20 metrics -- grouped by entity: Deals, Activities, Quotes, Contacts, Companies, Requests)
    - Additional config fields shown conditionally based on type:
      - For KpiCard: format (number/currency/percent), icon (text input)
      - For BarChart/LineChart/PieChart: no extra config (metricType determines data)
      - For Leaderboard: valueFormat (number/currency)
      - For TargetProgress: targetId (select from available targets -- passed via dialog data)

    Default widget sizes per type:
    - KpiCard: cols=3, rows=1
    - BarChart/LineChart: cols=6, rows=2
    - PieChart: cols=4, rows=2
    - Leaderboard: cols=4, rows=2
    - Table: cols=6, rows=2
    - TargetProgress: cols=3, rows=1

    On save: close dialog with widget config object (CreateWidgetRequest shape). Per research pitfall, pass DEEP COPY of data to dialog -- don't modify store state until user confirms.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Dashboard grid renders widgets in gridster2 layout with drag/resize in edit mode, widget config dialog allows creating/editing widget configuration</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard selector and date range filter</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/dashboard-selector/dashboard-selector.component.ts
    globcrm-web/src/app/features/dashboard/components/date-range-filter/date-range-filter.component.ts
  </files>
  <action>
    **DashboardSelectorComponent** (inline template/styles):
    - Standalone, imports MatSelectModule, MatIconModule, MatButtonModule, MatMenuModule
    - Inputs: dashboards (DashboardDto[]), activeDashboardId (string|null)
    - Outputs: dashboardSelected (EventEmitter of string -- dashboard ID), createDashboard (EventEmitter), deleteDashboard (EventEmitter of string)

    Template: mat-select showing dashboard names grouped into "My Dashboards" (ownerId non-null) and "Team Dashboards" (ownerId null) using mat-optgroup. Show a "+" button to create new dashboard. Show a delete button (mat-icon-button) next to each personal dashboard (team dashboards only deletable by admin -- this is handled by hiding delete for team dashboards when user is not admin, check via AuthStore.userRole).

    Computed: personalDashboards (filter where ownerId !== null), teamDashboards (filter where ownerId === null).

    **DateRangeFilterComponent** (inline template/styles):
    - Standalone, imports MatButtonToggleModule, MatDatepickerModule, MatFormFieldModule, MatInputModule, provideNativeDateAdapter (at component level, matching existing pattern)
    - Inputs: dateRange (DateRange)
    - Outputs: dateRangeChanged (EventEmitter of DateRange)

    Preset ranges (as mat-button-toggle-group):
    - Today: start=today 00:00 UTC, end=today 23:59 UTC
    - This Week: start=Monday of current week, end=today
    - This Month: start=1st of current month, end=today
    - This Quarter: start=1st of current quarter, end=today
    - This Year: start=Jan 1st, end=today
    - Custom: shows mat-date-range-picker for custom start/end

    On preset selection, compute UTC ISO 8601 strings and emit dateRangeChanged. Per research pitfall, always convert local dates to UTC before emitting to avoid timezone boundary issues.

    Template:
    ```
    <div class="date-range-filter">
      <mat-button-toggle-group [value]="activePreset()" (change)="onPresetChange($event)">
        <mat-button-toggle value="today">Today</mat-button-toggle>
        <mat-button-toggle value="week">This Week</mat-button-toggle>
        <mat-button-toggle value="month">This Month</mat-button-toggle>
        <mat-button-toggle value="quarter">Quarter</mat-button-toggle>
        <mat-button-toggle value="year">Year</mat-button-toggle>
        <mat-button-toggle value="custom">Custom</mat-button-toggle>
      </mat-button-toggle-group>
      @if (activePreset() === 'custom') {
        <mat-form-field>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate placeholder="Start" [value]="customStart" (dateChange)="onCustomChange()">
            <input matEndDate placeholder="End" [value]="customEnd" (dateChange)="onCustomChange()">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker" />
          <mat-date-range-picker #picker />
        </mat-form-field>
      }
    </div>
    ```

    Default: "This Month" preset selected on init.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Dashboard selector groups dashboards by personal/team with create/delete actions, date range filter provides presets and custom picker with UTC conversion</done>
</task>

</tasks>

<verification>
- Angular build succeeds with all 4 components
- Gridster uses 12-column layout with verticalFixed grid type and 200px row height
- Drag/resize only enabled when isEditing is true
- Widget config dialog uses deep copy pattern (not two-way binding to store)
- Date range filter converts local dates to UTC ISO strings
- Dashboard selector groups by personal vs team-wide
</verification>

<success_criteria>
- Grid layout survives page resize without collapsing (explicit container height set)
- Widgets can be dragged and resized in edit mode, positions persisted via layoutChanged
- Config dialog allows creating all 7 widget types with appropriate metric selection
- Dashboard selector shows grouped personal/team dashboards
- Date range presets compute correct UTC boundaries
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-06-SUMMARY.md`
</output>
