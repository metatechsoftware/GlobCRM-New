---
phase: 09-dashboards-and-reporting
plan: 05
type: execute
wave: 2
depends_on: ["09-04"]
files_modified:
  - globcrm-web/src/app/features/dashboard/components/widgets/kpi-card/kpi-card.component.ts
  - globcrm-web/src/app/features/dashboard/components/widgets/chart-widget/chart-widget.component.ts
  - globcrm-web/src/app/features/dashboard/components/widgets/leaderboard/leaderboard.component.ts
  - globcrm-web/src/app/features/dashboard/components/widgets/table-widget/table-widget.component.ts
  - globcrm-web/src/app/features/dashboard/components/widgets/target-progress/target-progress.component.ts
  - globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
autonomous: true

must_haves:
  truths:
    - "KPI card widget displays a metric value with optional target progress bar"
    - "Chart widget renders bar, line, and pie charts using ng2-charts/Chart.js"
    - "Leaderboard widget displays ranked user list with values"
    - "Table widget renders a mini data table from series data"
    - "Target progress widget shows target vs actual with visual progress indicator"
    - "Widget wrapper dispatches to the correct widget component based on WidgetType"
  artifacts:
    - path: "globcrm-web/src/app/features/dashboard/components/widgets/kpi-card/kpi-card.component.ts"
      provides: "KPI metric card with value formatting and optional progress bar"
      contains: "KpiCardComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/widgets/chart-widget/chart-widget.component.ts"
      provides: "Chart.js bar/line/pie chart rendering via BaseChartDirective"
      contains: "ChartWidgetComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts"
      provides: "Dynamic widget dispatcher based on WidgetType"
      contains: "WidgetWrapperComponent"
  key_links:
    - from: "globcrm-web/src/app/features/dashboard/components/widgets/chart-widget/chart-widget.component.ts"
      to: "ng2-charts BaseChartDirective"
      via: "canvas baseChart directive"
      pattern: "BaseChartDirective|baseChart"
    - from: "globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts"
      to: "All 5 widget components"
      via: "@switch on widget type"
      pattern: "@switch.*widget.*type"
---

<objective>
Create the five widget components (KPI card, chart, leaderboard, table, target progress) and the widget wrapper that dispatches to the correct component based on type.

Purpose: These are the visual building blocks that render inside gridster grid items. Each widget takes data (MetricResultDto) as input and renders it visually. The widget wrapper is the bridge between the grid layout and the specific widget rendering.
Output: Five widget components and one wrapper component, all using inline templates.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md
@.planning/phases/09-dashboards-and-reporting/09-04-SUMMARY.md

@globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Five widget components (KPI, chart, leaderboard, table, target)</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/widgets/kpi-card/kpi-card.component.ts
    globcrm-web/src/app/features/dashboard/components/widgets/chart-widget/chart-widget.component.ts
    globcrm-web/src/app/features/dashboard/components/widgets/leaderboard/leaderboard.component.ts
    globcrm-web/src/app/features/dashboard/components/widgets/table-widget/table-widget.component.ts
    globcrm-web/src/app/features/dashboard/components/widgets/target-progress/target-progress.component.ts
  </files>
  <action>
    All widgets use inline template/styles (single .ts file) per project convention for simpler components.

    **KpiCardComponent** (kpi-card.component.ts):
    - Standalone component, imports MatIconModule
    - Inputs: title (string), value (number), icon (string, default 'trending_up'), color (string, default 'primary'), format ('number'|'currency'|'percent', default 'number'), target (number|null, default null)
    - Computed: formattedValue (uses Intl.NumberFormat for currency, percent, or plain number), progressPercent (value/target * 100, capped at 100)
    - Template: Card with icon, title, large formatted value. If target provided, show a CSS progress bar (div with width% based on progressPercent) and "X% of target" text below
    - Styles: Use project CSS variables (--color-surface, --color-border-subtle, --radius-lg, etc.). Color variants via data-color attribute for icon background. Progress bar uses --color-primary for fill

    **ChartWidgetComponent** (chart-widget.component.ts):
    - Standalone, imports BaseChartDirective from ng2-charts
    - Inputs: chartType ('bar'|'line'|'pie'|'doughnut'), data (MetricResultDto), title (string)
    - Computed: chartData (transforms MetricResultDto.series into Chart.js data format: labels from series.label, datasets[0].data from series.value). Use different color palettes for different chart types.
    - chartOptions: responsive=true, maintainAspectRatio=false (CRITICAL per research pitfall), plugins.legend.position='bottom', plugins.title.display=false
    - Template: `<canvas baseChart [data]="chartData()" [options]="chartOptions" [type]="chartType()">`
    - Handle widget resize: Listen for ResizeObserver on host element and call chart.update() -- this avoids the Chart.js resize pitfall from research. Use afterViewInit to set up ResizeObserver and afterDestroy to clean it up.
    - Color palette: Use 8 distinct colors matching the project's design system (primary, secondary, accent, info, success, warning, danger, and a neutral). Define as hex values since Chart.js needs actual colors, not CSS variables.

    **LeaderboardComponent** (leaderboard.component.ts):
    - Standalone, imports MatIconModule
    - Inputs: data (MetricResultDto), title (string), valueFormat ('number'|'currency', default 'number')
    - Computed: entries (maps series to ranked list with position number). Format value with Intl.NumberFormat.
    - Template: Ordered list with rank number (1, 2, 3...), name (from series label), and value. Top 3 get gold/silver/bronze color accents. Show up to 10 entries.
    - Styles: Clean list with alternating subtle backgrounds, rank badges

    **TableWidgetComponent** (table-widget.component.ts):
    - Standalone, imports nothing extra (pure HTML table)
    - Inputs: data (MetricResultDto), title (string), columns (array of {key: string, label: string}, default [{key:'label',label:'Name'},{key:'value',label:'Value'}])
    - Template: Simple HTML table rendering series data as rows. Headers from columns config. Values formatted based on type detection (currency if > 100 and not integer-like).
    - Styles: Compact table using project CSS variables, subtle row borders

    **TargetProgressComponent** (target-progress.component.ts):
    - Standalone, imports MatIconModule
    - Inputs: target (TargetDto), data (MetricResultDto|null)
    - Computed: progressPercent (target.currentValue / target.targetValue * 100), statusColor (green if >= 100%, yellow if >= 50%, red if < 50%), formattedCurrent/formattedTarget
    - Template: Target name, circular or linear progress indicator (use CSS conic-gradient for circular or mat-progress-bar-like div for linear), current value vs target value text, period label
    - Styles: Card layout matching KPI card style
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>All five widget components render their respective data types with proper formatting and responsive layouts</done>
</task>

<task type="auto">
  <name>Task 2: Widget wrapper component for type-based dispatch</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
  </files>
  <action>
    **WidgetWrapperComponent** (widget-wrapper.component.ts):
    - Standalone, imports all 5 widget components, MatIconModule, MatMenuModule
    - Inputs: widget (WidgetDto), data (MetricResultDto|null), target (TargetDto|null, for TargetProgress type), isEditing (boolean)
    - Outputs: edit (EventEmitter), remove (EventEmitter)

    Template structure:
    ```
    <div class="widget-wrapper">
      <div class="widget-wrapper__header">
        <span class="widget-drag-handle" *ngIf="isEditing()">
          <mat-icon>drag_indicator</mat-icon>
        </span>
        <h3 class="widget-wrapper__title">{{ widget().title }}</h3>
        @if (isEditing()) {
          <button [matMenuTriggerFor]="widgetMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #widgetMenu="matMenu">
            <button mat-menu-item (click)="edit.emit()">
              <mat-icon>settings</mat-icon> Configure
            </button>
            <button mat-menu-item (click)="remove.emit()">
              <mat-icon>delete</mat-icon> Remove
            </button>
          </mat-menu>
        }
      </div>
      <div class="widget-wrapper__content">
        @switch (widget().type) {
          @case ('KpiCard') {
            <app-kpi-card [title]="widget().title" [value]="data()?.value ?? 0"
              [icon]="widget().config['icon'] ?? 'trending_up'"
              [format]="widget().config['format'] ?? 'number'"
              [target]="widget().config['target'] ?? null" />
          }
          @case ('BarChart') {
            <app-chart-widget chartType="bar" [data]="data()" [title]="widget().title" />
          }
          @case ('LineChart') {
            <app-chart-widget chartType="line" [data]="data()" [title]="widget().title" />
          }
          @case ('PieChart') {
            <app-chart-widget chartType="pie" [data]="data()" [title]="widget().title" />
          }
          @case ('Leaderboard') {
            <app-leaderboard [data]="data()" [title]="widget().title"
              [valueFormat]="widget().config['valueFormat'] ?? 'number'" />
          }
          @case ('Table') {
            <app-table-widget [data]="data()" [title]="widget().title" />
          }
          @case ('TargetProgress') {
            <app-target-progress [target]="target()" [data]="data()" />
          }
        }
      </div>
    </div>
    ```

    Styles:
    - widget-wrapper fills 100% of gridster item
    - Header: flex with drag handle (visible only in edit mode), title, and action menu
    - Content: flex-grow to fill remaining space, overflow hidden
    - widget-drag-handle class is referenced by gridster's dragHandleClass config
    - Use project CSS variables for consistent styling
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Widget wrapper dispatches to correct widget component based on type, shows drag handle and action menu in edit mode</done>
</task>

</tasks>

<verification>
- Angular build succeeds with all 6 components
- ChartWidgetComponent uses BaseChartDirective with responsive=true and maintainAspectRatio=false
- WidgetWrapperComponent switches on all 7 WidgetType values
- All widgets use inline templates per project convention
- Widget drag handle uses class "widget-drag-handle" for gridster integration
</verification>

<success_criteria>
- KPI card: Displays formatted value with optional progress bar
- Chart widget: Renders bar, line, pie charts using Chart.js with responsive resize handling
- Leaderboard: Shows ranked user list with top-3 highlighting
- Table widget: Renders series data as compact HTML table
- Target progress: Shows current vs target with visual progress indicator
- Widget wrapper: Dispatches to correct component, provides edit/remove actions in edit mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-05-SUMMARY.md`
</output>
