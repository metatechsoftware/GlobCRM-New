---
phase: 09-dashboards-and-reporting
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/package.json
  - globcrm-web/src/app/app.config.ts
  - globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
  - globcrm-web/src/app/features/dashboard/services/dashboard-api.service.ts
  - globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts
autonomous: true

must_haves:
  truths:
    - "ng2-charts, chart.js, and angular-gridster2 packages installed and available"
    - "provideCharts registered in app.config.ts for Chart.js availability"
    - "TypeScript models define Dashboard, Widget, Target, and metric result interfaces"
    - "DashboardApiService provides HTTP methods for all 10 backend endpoints"
    - "DashboardStore manages dashboard state with signal store pattern"
  artifacts:
    - path: "globcrm-web/src/app/features/dashboard/models/dashboard.models.ts"
      provides: "TypeScript interfaces for Dashboard, Widget, Target, MetricResult, ChartDataPoint"
      contains: "interface DashboardDto"
    - path: "globcrm-web/src/app/features/dashboard/services/dashboard-api.service.ts"
      provides: "HTTP client for all dashboard API endpoints"
      contains: "class DashboardApiService"
    - path: "globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts"
      provides: "Signal store for dashboard state management"
      contains: "DashboardStore"
  key_links:
    - from: "globcrm-web/src/app/app.config.ts"
      to: "ng2-charts"
      via: "provideCharts(withDefaultRegisterables())"
      pattern: "provideCharts"
    - from: "globcrm-web/src/app/features/dashboard/services/dashboard-api.service.ts"
      to: "/api/dashboards"
      via: "HttpClient or ApiService"
      pattern: "api/dashboards"
---

<objective>
Install npm packages (ng2-charts, chart.js, angular-gridster2), register Chart.js providers, create TypeScript models, API service, and signal store for the dashboard feature.

Purpose: Establishes the frontend data layer that all widget and grid components depend on. Runs in Wave 1 parallel with backend Plan 01 since it only creates scaffolding (models, service, store) with no runtime backend dependency.
Output: Three npm packages installed, app.config.ts updated, models/service/store files created.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md

@globcrm-web/src/app/app.config.ts (provider registration point)
@globcrm-web/src/app/features/notifications/services/notification.service.ts (API service pattern)
@globcrm-web/src/app/features/notifications/stores/notification.store.ts (signal store pattern)
@globcrm-web/src/app/core/services/api.service.ts (base API service)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm packages and register Chart.js providers</name>
  <files>
    globcrm-web/package.json
    globcrm-web/src/app/app.config.ts
  </files>
  <action>
    Run: `cd globcrm-web && npm install ng2-charts chart.js angular-gridster2@19.0.0`

    Update `globcrm-web/src/app/app.config.ts`:
    - Add import: `import { provideCharts, withDefaultRegisterables } from 'ng2-charts';`
    - Add `provideCharts(withDefaultRegisterables())` to the providers array after provideAnimationsAsync()

    This makes Chart.js chart types (bar, line, pie, doughnut) available to any component using the BaseChartDirective.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds with new packages</verify>
  <done>Three packages installed, provideCharts registered in app.config.ts, Angular build succeeds</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
    globcrm-web/src/app/features/dashboard/services/dashboard-api.service.ts
    globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts
  </files>
  <action>
    Create directories: `globcrm-web/src/app/features/dashboard/models/`, `globcrm-web/src/app/features/dashboard/services/`, `globcrm-web/src/app/features/dashboard/stores/`

    **dashboard.models.ts:**
    ```
    // Widget types matching backend WidgetType enum
    export type WidgetType = 'KpiCard' | 'BarChart' | 'LineChart' | 'PieChart' | 'Leaderboard' | 'Table' | 'TargetProgress';

    // Metric types matching backend MetricType enum
    export type MetricType = 'DealCount' | 'DealPipelineValue' | 'DealsByStage' | 'DealsWon' | 'DealsLost' | 'WinRate' | 'AverageDealValue' | 'ActivityCount' | 'ActivitiesByType' | 'ActivitiesByStatus' | 'ActivitiesCompleted' | 'OverdueActivities' | 'QuoteTotal' | 'QuotesByStatus' | 'ContactsCreated' | 'CompaniesCreated' | 'RequestsByStatus' | 'RequestsByPriority' | 'SalesLeaderboard' | 'ActivityLeaderboard';

    export type TargetPeriod = 'Daily' | 'Weekly' | 'Monthly' | 'Quarterly' | 'Yearly';

    export interface WidgetDto {
      id: string;
      type: WidgetType;
      title: string;
      x: number;
      y: number;
      cols: number;
      rows: number;
      config: Record<string, any>;
      sortOrder: number;
    }

    export interface DashboardDto {
      id: string;
      name: string;
      description: string | null;
      ownerId: string | null;
      ownerName: string | null;
      isDefault: boolean;
      isTeamWide: boolean;
      widgets: WidgetDto[];
      createdAt: string;
      updatedAt: string;
    }

    export interface CreateDashboardRequest {
      name: string;
      description?: string;
      isTeamWide: boolean;
      isDefault: boolean;
      widgets: CreateWidgetRequest[];
    }

    export interface CreateWidgetRequest {
      type: WidgetType;
      title: string;
      x: number;
      y: number;
      cols: number;
      rows: number;
      config: Record<string, any>;
      sortOrder: number;
    }

    export interface UpdateDashboardRequest {
      name: string;
      description?: string;
      isDefault: boolean;
      widgets: CreateWidgetRequest[];
    }

    // Widget data (metrics)
    export interface ChartDataPoint {
      label: string;
      value: number;
    }

    export interface MetricResultDto {
      value: number;
      label: string;
      series: ChartDataPoint[] | null;
    }

    export interface WidgetMetricRequest {
      widgetId: string;
      metricType: MetricType;
      config: Record<string, any>;
    }

    export interface WidgetDataRequest {
      widgets: WidgetMetricRequest[];
      startDate: string;
      endDate: string;
    }

    export interface WidgetDataResponse {
      results: Record<string, MetricResultDto>;
    }

    // Targets
    export interface TargetDto {
      id: string;
      name: string;
      metricType: MetricType;
      period: TargetPeriod;
      targetValue: number;
      currentValue: number;
      progressPercent: number;
      ownerId: string | null;
      ownerName: string | null;
      startDate: string;
      endDate: string;
      createdAt: string;
      updatedAt: string;
    }

    export interface CreateTargetRequest {
      name: string;
      metricType: MetricType;
      period: TargetPeriod;
      targetValue: number;
      startDate: string;
      endDate: string;
      isTeamWide: boolean;
    }

    export interface UpdateTargetRequest {
      name: string;
      targetValue: number;
      startDate: string;
      endDate: string;
    }

    // Date range for dashboard filtering
    export interface DateRange {
      start: string | null;
      end: string | null;
    }

    // Gridster item extension for widgets
    export interface DashboardGridItem {
      x: number;
      y: number;
      cols: number;
      rows: number;
      widgetId: string;
      widget: WidgetDto;
    }
    ```

    **dashboard-api.service.ts:**
    Injectable service (providedIn: 'root'). Inject ApiService (the shared base service that handles auth headers and base URL).

    Methods:
    - getDashboards(): Observable of DashboardDto[] -- GET /api/dashboards
    - getDashboard(id: string): Observable of DashboardDto -- GET /api/dashboards/{id}
    - createDashboard(req: CreateDashboardRequest): Observable of DashboardDto -- POST /api/dashboards
    - updateDashboard(id: string, req: UpdateDashboardRequest): Observable of DashboardDto -- PUT /api/dashboards/{id}
    - deleteDashboard(id: string): Observable of void -- DELETE /api/dashboards/{id}
    - getWidgetData(dashboardId: string, req: WidgetDataRequest): Observable of WidgetDataResponse -- POST /api/dashboards/{id}/widget-data
    - getTargets(): Observable of TargetDto[] -- GET /api/targets
    - createTarget(req: CreateTargetRequest): Observable of TargetDto -- POST /api/targets
    - updateTarget(id: string, req: UpdateTargetRequest): Observable of TargetDto -- PUT /api/targets/{id}
    - deleteTarget(id: string): Observable of void -- DELETE /api/targets/{id}

    **dashboard.store.ts:**
    Signal store (component-provided, NOT root). Use signalStore from @ngrx/signals.

    State:
    - dashboards: DashboardDto[] (all user's dashboards)
    - activeDashboard: DashboardDto | null (currently viewed)
    - widgetData: Record of string to MetricResultDto (keyed by widgetId)
    - targets: TargetDto[]
    - dateRange: DateRange (default: current month -- first day to today)
    - isLoading: boolean
    - isEditing: boolean (edit mode for widget drag/resize)

    Methods:
    - loadDashboards(): Fetch all dashboards, set first/default as active
    - loadDashboard(id: string): Fetch specific dashboard with widgets
    - loadWidgetData(): Build WidgetDataRequest from active dashboard widgets + dateRange, call API, populate widgetData map
    - saveDashboard(req: CreateDashboardRequest): Create + reload
    - updateDashboard(id: string, req: UpdateDashboardRequest): Update + reload
    - deleteDashboard(id: string): Delete + reload
    - setDateRange(range: DateRange): Update dateRange, then loadWidgetData()
    - toggleEditMode(): Toggle isEditing
    - saveLayout(widgets: WidgetDto[]): Save widget positions after drag/resize
    - loadTargets(): Fetch all targets
    - createTarget(req: CreateTargetRequest): Create + reload targets
    - updateTarget(id: string, req: UpdateTargetRequest): Update + reload
    - deleteTarget(id: string): Delete + reload
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Models define all 15+ interfaces, API service covers all 10 endpoints, signal store manages dashboard state with date range and edit mode</done>
</task>

</tasks>

<verification>
- Angular build succeeds with ng2-charts, chart.js, and angular-gridster2 installed
- provideCharts registered in app.config.ts
- All TypeScript interfaces match backend DTO shapes
- API service methods cover all 10 backend endpoints
- Signal store is component-provided (not root)
</verification>

<success_criteria>
- Three npm packages installed and importable
- Chart.js registered globally via provideCharts
- TypeScript models match all backend DTOs (Dashboard, Widget, Target, MetricResult)
- API service provides Observable-based HTTP methods for all endpoints
- Signal store manages dashboards, active dashboard, widget data, date range, and edit mode
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-04-SUMMARY.md`
</output>
