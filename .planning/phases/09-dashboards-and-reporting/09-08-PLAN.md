---
phase: 09-dashboards-and-reporting
plan: 08
type: execute
wave: 5
depends_on: ["09-03", "09-06", "09-07"]
files_modified:
  - globcrm-web/src/app/features/dashboard/components/target-management/target-management.component.ts
  - globcrm-web/src/app/features/dashboard/components/target-form-dialog/target-form-dialog.component.ts
  - globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html
  - globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.scss
  - globcrm-web/src/app/features/dashboard/dashboard.routes.ts
autonomous: true

must_haves:
  truths:
    - "User can create, view, and delete KPI targets with metric, period, and target value"
    - "Target progress is displayed visually showing current vs target"
    - "User can click a widget to drill-down into the underlying entity list"
    - "Drill-down navigates to the entity list page with appropriate filters"
    - "Targets page is accessible from dashboard with tab or route"
  artifacts:
    - path: "globcrm-web/src/app/features/dashboard/components/target-management/target-management.component.ts"
      provides: "Target list with create/delete and progress visualization"
      contains: "TargetManagementComponent"
    - path: "globcrm-web/src/app/features/dashboard/components/target-form-dialog/target-form-dialog.component.ts"
      provides: "Dialog for creating/editing KPI targets"
      contains: "TargetFormDialogComponent"
  key_links:
    - from: "globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts"
      to: "Router navigation to entity list pages"
      via: "drill-down click handler with routerLink"
      pattern: "router.navigate.*deals|activities|contacts|companies|quotes|requests"
    - from: "globcrm-web/src/app/features/dashboard/components/target-management/target-management.component.ts"
      to: "DashboardStore targets"
      via: "store.targets() and store.createTarget/deleteTarget"
      pattern: "store.targets|store.createTarget|store.deleteTarget"
---

<objective>
Create target management UI (list + form dialog), add drill-down navigation to widgets, and wire targets into the dashboard page.

Purpose: Completes DASH-03 (target tracking with numeric goals) and DASH-04 (drill-down into underlying data). Users can set targets like "50 calls/week" or "$100K pipeline" and see progress. Clicking any widget opens the relevant entity list for deeper exploration.
Output: Target management component, target form dialog, drill-down wiring in widget wrapper, dashboard page updates.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md
@.planning/phases/09-dashboards-and-reporting/09-03-SUMMARY.md
@.planning/phases/09-dashboards-and-reporting/09-06-SUMMARY.md
@.planning/phases/09-dashboards-and-reporting/09-07-SUMMARY.md

@globcrm-web/src/app/features/dashboard/models/dashboard.models.ts
@globcrm-web/src/app/features/dashboard/stores/dashboard.store.ts
@globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
@globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts
@globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Target management and form dialog</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/target-management/target-management.component.ts
    globcrm-web/src/app/features/dashboard/components/target-form-dialog/target-form-dialog.component.ts
  </files>
  <action>
    **TargetManagementComponent** (inline template/styles):
    - Standalone, imports MatButtonModule, MatIconModule, MatDialogModule, MatSnackBarModule, TargetProgressComponent
    - Inputs: targets (TargetDto[])
    - Inject: MatDialog, MatSnackBar, DashboardStore

    Template: A panel/page showing all targets as TargetProgress cards in a grid (3 columns on desktop, 1 on mobile). Header with "Targets" title and "Add Target" button. Each target card shows the TargetProgressComponent with a delete button overlay.

    Methods:
    - onAddTarget(): Open TargetFormDialogComponent. On close with result, call store.createTarget(result). Show snackbar "Target created".
    - onEditTarget(target: TargetDto): Open TargetFormDialogComponent with target data. On close with result, call store.updateTarget(target.id, result). Show snackbar "Target updated".
    - onDeleteTarget(target: TargetDto): Confirm via snackbar or simple dialog, then store.deleteTarget(target.id).

    **TargetFormDialogComponent** (inline template/styles):
    - Standalone, imports MatDialogModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatButtonModule, MatDatepickerModule, ReactiveFormsModule, provideNativeDateAdapter (component level)
    - Inject MAT_DIALOG_DATA (optional: { target?: TargetDto }), MatDialogRef

    Form (reactive):
    - name: string (required, e.g., "50 calls this week")
    - metricType: MetricType (select from all 20 metrics, grouped by entity)
    - period: TargetPeriod (select: Daily, Weekly, Monthly, Quarterly, Yearly)
    - targetValue: number (required, min 1)
    - startDate: date (required)
    - endDate: date (required)
    - isTeamWide: boolean checkbox (default false, label "Team-wide target")

    When period changes, auto-compute startDate/endDate:
    - Daily: today -> today
    - Weekly: Monday of this week -> Sunday
    - Monthly: 1st of month -> last day of month
    - Quarterly: 1st of quarter -> last day of quarter
    - Yearly: Jan 1 -> Dec 31

    On save: Convert dates to UTC ISO strings, close dialog with CreateTargetRequest or UpdateTargetRequest.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds</verify>
  <done>Target management shows targets grid with progress visualization, form dialog enables target creation with period auto-dates</done>
</task>

<task type="auto">
  <name>Task 2: Widget drill-down and dashboard page integration</name>
  <files>
    globcrm-web/src/app/features/dashboard/components/widget-wrapper/widget-wrapper.component.ts
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.ts
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.html
    globcrm-web/src/app/features/dashboard/pages/dashboard/dashboard.component.scss
    globcrm-web/src/app/features/dashboard/dashboard.routes.ts
  </files>
  <action>
    **Widget drill-down in WidgetWrapperComponent:**
    - Add Router injection
    - Add a click handler on the widget content area (not on edit mode -- only in view mode)
    - Map MetricType to drill-down routes:
      - Deal metrics (DealCount, DealPipelineValue, DealsByStage, DealsWon, DealsLost, WinRate, AverageDealValue, SalesLeaderboard) -> /deals
      - Activity metrics (ActivityCount, ActivitiesByType, ActivitiesByStatus, ActivitiesCompleted, OverdueActivities, ActivityLeaderboard) -> /activities
      - Quote metrics (QuoteTotal, QuotesByStatus) -> /quotes
      - Contact metrics (ContactsCreated) -> /contacts
      - Company metrics (CompaniesCreated) -> /companies
      - Request metrics (RequestsByStatus, RequestsByPriority) -> /requests
    - When clicked (not in edit mode), navigate to the mapped route
    - Add visual cue: cursor pointer on hover (not in edit mode), subtle hover effect on widget content
    - For series-based widgets (charts), if a specific data point is clicked (Chart.js click event), pass a filter query param if applicable (e.g., click on "Proposal" stage in DealsByStage chart -> /deals?stage=Proposal). This is a best-effort enhancement -- if not feasible, just navigate to the list without filters.

    **Dashboard page updates:**
    - Add a "Targets" tab or collapsible section below the grid
    - Use mat-button-toggle or a simple expandable section: "Dashboard" view (grid) and "Targets" view
    - OR: Add targets as a row below the grid header area, always visible as compact progress bars
    - Recommended approach: Add a mat-tab-group with two tabs: "Dashboard" (the grid) and "Targets" (TargetManagementComponent). This keeps the layout clean and separates concerns.
    - Update the template to include:
      ```
      <mat-tab-group>
        <mat-tab label="Dashboard">
          <!-- existing grid content -->
        </mat-tab>
        <mat-tab label="Targets">
          <app-target-management [targets]="store.targets()" />
        </mat-tab>
      </mat-tab-group>
      ```
    - Import MatTabsModule and TargetManagementComponent in the dashboard component
    - Update styles for tab layout

    **Dashboard routes:**
    - If the routes file needs updates for targets sub-route, add it. Otherwise, targets are managed within the dashboard page via tabs (no separate route needed).
    - The route file likely needs no changes since targets are a tab within the dashboard page.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- build succeeds. Verify drill-down routing works by checking that widget wrapper has router.navigate calls for each metric entity type.</verify>
  <done>Widgets navigate to relevant entity list on click (drill-down), targets tab shows target management, dashboard page is fully integrated</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- Clicking a widget navigates to the correct entity list page
- Target management shows all targets with progress visualization
- Target form dialog auto-computes date ranges based on period selection
- Dashboard page has Dashboard and Targets tabs
- All 6 DASH requirements are addressed across the 8 plans
</verification>

<success_criteria>
- DASH-03: User can set numeric targets (50 calls/week, $100K pipeline) and track progress via TargetManagement
- DASH-04: Dashboard supports drill-down into underlying data via widget click navigation
- Target form auto-computes date ranges from period selection
- Drill-down maps all 20 metrics to correct entity routes
- Widget cursor changes to pointer in view mode to indicate drill-down
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-08-SUMMARY.md`
</output>
