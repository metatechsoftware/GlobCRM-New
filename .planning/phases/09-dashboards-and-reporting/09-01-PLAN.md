---
phase: 09-dashboards-and-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Dashboard.cs
  - src/GlobCRM.Domain/Entities/DashboardWidget.cs
  - src/GlobCRM.Domain/Entities/Target.cs
  - src/GlobCRM.Domain/Enums/WidgetType.cs
  - src/GlobCRM.Domain/Enums/TargetPeriod.cs
  - src/GlobCRM.Domain/Enums/MetricType.cs
  - src/GlobCRM.Domain/Interfaces/IDashboardRepository.cs
  - src/GlobCRM.Domain/Interfaces/ITargetRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DashboardConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DashboardWidgetConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/TargetConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Dashboard, DashboardWidget, and Target domain entities exist with correct properties and relationships"
    - "WidgetType, TargetPeriod, and MetricType enums define all required widget/metric categories"
    - "EF Core configurations use snake_case column naming and JSONB for widget config"
    - "Database migration creates tables with proper indexes"
    - "RLS policies enforce tenant isolation on dashboards and targets"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Dashboard.cs"
      provides: "Dashboard entity with OwnerId pattern (null=team, non-null=personal)"
      contains: "class Dashboard"
    - path: "src/GlobCRM.Domain/Entities/DashboardWidget.cs"
      provides: "Widget entity with gridster position (X,Y,Cols,Rows) and JSONB Config"
      contains: "class DashboardWidget"
    - path: "src/GlobCRM.Domain/Entities/Target.cs"
      provides: "KPI target entity with metric, period, target value, and current value"
      contains: "class Target"
    - path: "src/GlobCRM.Domain/Enums/MetricType.cs"
      provides: "20 metric types across Deals, Activities, Quotes, Contacts, Companies, Requests"
      contains: "enum MetricType"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "Dashboard, DashboardWidget, Target entities"
      via: "DbSet properties and ApplyConfiguration calls"
      pattern: "DbSet<Dashboard>"
---

<objective>
Create the domain entities, enums, EF Core configurations, database migration, and RLS policies for the dashboard and reporting subsystem.

Purpose: Establish the data foundation (Dashboard, DashboardWidget, Target) that all subsequent plans build upon. Dashboard follows the SavedView ownership pattern (OwnerId null = team-wide, non-null = personal).
Output: Three domain entities, three enums, two repository interfaces, three EF Core configurations, migration, and RLS policies.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-dashboards-and-reporting/09-RESEARCH.md

@src/GlobCRM.Domain/Entities/SavedView.cs (ownership pattern reference)
@src/GlobCRM.Domain/Entities/Notification.cs (recent entity pattern reference)
@src/GlobCRM.Infrastructure/Persistence/Configurations/NotificationConfiguration.cs (EF config pattern)
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs (DbSet registration)
@scripts/rls-setup.sql (RLS policy pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities, enums, and repository interfaces</name>
  <files>
    src/GlobCRM.Domain/Entities/Dashboard.cs
    src/GlobCRM.Domain/Entities/DashboardWidget.cs
    src/GlobCRM.Domain/Entities/Target.cs
    src/GlobCRM.Domain/Enums/WidgetType.cs
    src/GlobCRM.Domain/Enums/TargetPeriod.cs
    src/GlobCRM.Domain/Enums/MetricType.cs
    src/GlobCRM.Domain/Interfaces/IDashboardRepository.cs
    src/GlobCRM.Domain/Interfaces/ITargetRepository.cs
  </files>
  <action>
    Create three domain entities following existing codebase patterns:

    **Dashboard.cs** -- mirrors SavedView ownership pattern:
    - Id (Guid), TenantId (Guid), Name (string, required), Description (string?, optional)
    - OwnerId (Guid?, nullable) -- null = team-wide (admin creates), non-null = personal
    - IsDefault (bool, default false) -- marks the default dashboard for the user/team
    - CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Owner (ApplicationUser?), Widgets (ICollection of DashboardWidget)

    **DashboardWidget.cs** -- child entity (no TenantId, inherits via Dashboard FK):
    - Id (Guid), DashboardId (Guid)
    - Type (WidgetType enum), Title (string, required)
    - X (int), Y (int), Cols (int, default 2), Rows (int, default 2) -- gridster2 position/size
    - Config (Dictionary of string,object? -- JSONB) -- widget-specific configuration (metric, groupBy, chartType, etc.)
    - SortOrder (int)
    - Navigation: Dashboard (Dashboard)

    **Target.cs** -- tenant-scoped KPI target:
    - Id (Guid), TenantId (Guid)
    - OwnerId (Guid?, nullable) -- null = team target, non-null = personal target
    - MetricType (MetricType enum), Period (TargetPeriod enum)
    - TargetValue (decimal), Name (string, required)
    - StartDate (DateTimeOffset), EndDate (DateTimeOffset)
    - CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Owner (ApplicationUser?)

    **WidgetType.cs enum:** KpiCard, BarChart, LineChart, PieChart, Leaderboard, Table, TargetProgress

    **TargetPeriod.cs enum:** Daily, Weekly, Monthly, Quarterly, Yearly

    **MetricType.cs enum** (20 metrics from research):
    DealCount, DealPipelineValue, DealsByStage, DealsWon, DealsLost, WinRate, AverageDealValue,
    ActivityCount, ActivitiesByType, ActivitiesByStatus, ActivitiesCompleted, OverdueActivities,
    QuoteTotal, QuotesByStatus, ContactsCreated, CompaniesCreated,
    RequestsByStatus, RequestsByPriority, SalesLeaderboard, ActivityLeaderboard

    **IDashboardRepository.cs:** GetByIdAsync(Guid id), GetAllAsync(Guid? ownerId), CreateAsync(Dashboard), UpdateAsync(Dashboard), DeleteAsync(Guid id), GetDefaultAsync(Guid? ownerId)

    **ITargetRepository.cs:** GetByIdAsync(Guid id), GetAllAsync(Guid? ownerId), CreateAsync(Target), UpdateAsync(Target), DeleteAsync(Guid id), GetByMetricAsync(MetricType metric, Guid? ownerId)
  </action>
  <verify>Build succeeds: `dotnet build src/GlobCRM.Domain/`</verify>
  <done>Three entities, three enums, and two repository interfaces compile cleanly</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, DbContext update, migration, and RLS</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/DashboardConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DashboardWidgetConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/TargetConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    **DashboardConfiguration.cs:**
    - Table "dashboards", snake_case column names (HasColumnName everywhere)
    - Name: HasMaxLength(200), IsRequired
    - Description: HasMaxLength(1000)
    - OwnerId: FK to ApplicationUser with SetNull delete (matching SavedView pattern)
    - IsDefault: HasDefaultValue(false)
    - CreatedAt/UpdatedAt: IsRequired
    - HasMany Widgets -> Cascade delete
    - Index on (TenantId, OwnerId) as "idx_dashboards_tenant_owner"

    **DashboardWidgetConfiguration.cs:**
    - Table "dashboard_widgets", snake_case
    - DashboardId FK with Cascade delete
    - Type: stored as string (HasConversion of string)
    - Title: HasMaxLength(200), IsRequired
    - Config: HasColumnType("jsonb") with JSON converter for Dictionary (matching CustomFieldDefinition pattern)
    - X, Y, Cols, Rows as integers
    - SortOrder
    - Index on (DashboardId) as "idx_dashboard_widgets_dashboard"

    **TargetConfiguration.cs:**
    - Table "targets", snake_case
    - OwnerId: FK to ApplicationUser with SetNull delete
    - MetricType: stored as string
    - Period: stored as string
    - TargetValue: HasPrecision(18, 4)
    - Name: HasMaxLength(200), IsRequired
    - StartDate/EndDate: IsRequired
    - Index on (TenantId, OwnerId) as "idx_targets_tenant_owner"
    - Index on (TenantId, MetricType) as "idx_targets_tenant_metric"

    **ApplicationDbContext.cs** -- add:
    - DbSet<Dashboard> Dashboards
    - DbSet<DashboardWidget> DashboardWidgets
    - DbSet<Target> Targets
    - Apply three configurations in OnModelCreating
    - Global query filters for Dashboard (TenantId) and Target (TenantId). DashboardWidget has no filter (child entity inherits via Dashboard FK)

    **Migration:** Run `dotnet ef migrations add AddDashboardEntities --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api` then `dotnet ef database update --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api`

    **RLS (scripts/rls-setup.sql):** Add RLS policies for dashboards and targets tables (not dashboard_widgets -- child entity inherits). Follow existing pattern: ALTER TABLE ... ENABLE ROW LEVEL SECURITY; ALTER TABLE ... FORCE ROW LEVEL SECURITY; CREATE POLICY ... USING (tenant_id = current_setting('app.tenant_id')::uuid);
  </action>
  <verify>Migration applies cleanly and `dotnet build src/GlobCRM.Infrastructure/` succeeds. Check tables exist: `dotnet ef database update --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api`</verify>
  <done>Three database tables (dashboards, dashboard_widgets, targets) created with correct columns, indexes, query filters, and RLS policies</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds for both Domain and Infrastructure projects
- Migration applies without errors
- Database tables exist with correct snake_case columns
- RLS policies active on dashboards and targets tables
- DashboardWidget has no TenantId (child entity pattern)
</verification>

<success_criteria>
- Dashboard entity follows SavedView ownership pattern (OwnerId null = team-wide)
- DashboardWidget stores gridster2 position (X,Y,Cols,Rows) and JSONB Config
- Target entity supports all 20 MetricType values with configurable periods
- EF Core configurations use snake_case and JSONB where appropriate
- All three tables have proper indexes for query performance
</success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards-and-reporting/09-01-SUMMARY.md`
</output>
