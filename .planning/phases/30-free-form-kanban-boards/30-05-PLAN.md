---
phase: 30-free-form-kanban-boards
plan: 05
type: execute
wave: 5
depends_on: [30-04]
files_modified:
  - globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.ts
  - globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.html
  - globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.scss
  - globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.ts
  - globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.html
  - globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.scss
  - globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts
  - globcrm-web/src/app/features/boards/board-detail/board-detail.component.html
  - globcrm-web/src/app/features/boards/board-card/board-card.component.ts
autonomous: true
requirements:
  - KANB-06
  - KANB-07
  - KANB-10
  - KANB-11
  - KANB-12
  - KANB-15
  - KANB-16
  - KANB-17

must_haves:
  truths:
    - "User can click a card to open a right-side slide panel showing full card details"
    - "User can edit card title, rich text description (via RichTextEditorComponent), due date, and assignee in the card detail panel"
    - "User can manage colored labels on a card: add existing labels, create new board-scoped labels with name and color"
    - "User can add checklist items with text, toggle checked state, see progress indicator, and delete items"
    - "User can add comments on a card, see comments in chronological order with author info, and reply to create threaded discussion"
    - "User can link a card to a CRM entity by searching and selecting, and click the entity link to open the preview sidebar"
    - "User can filter visible cards by label, assignee, or due date range"
  artifacts:
    - path: "globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.ts"
      provides: "Right-side slide panel for card editing with all sub-features"
      contains: "CardDetailPanelComponent"
    - path: "globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.ts"
      provides: "Filter panel for cards by label, assignee, due date"
      contains: "BoardFilterPanelComponent"
  key_links:
    - from: "CardDetailPanelComponent"
      to: "RichTextEditorComponent"
      via: "Embedded for card description editing"
      pattern: "app-rich-text-editor"
    - from: "CardDetailPanelComponent"
      to: "PreviewSidebarStore"
      via: "Entity link click opens preview sidebar"
      pattern: "previewSidebarStore.*open"
    - from: "CardDetailPanelComponent"
      to: "BoardsService"
      via: "API calls for labels, checklists, comments, card updates"
      pattern: "boardsService\\.(updateCard|createLabel|createChecklistItem|createComment)"
    - from: "BoardFilterPanelComponent"
      to: "BoardStore.setCardFilter"
      via: "Filter changes update store filter state"
      pattern: "boardStore.*setCardFilter"
    - from: "BoardDetailComponent"
      to: "CardDetailPanelComponent"
      via: "isCardPanelOpen signal controls panel visibility"
      pattern: "isCardPanelOpen.*card-detail-panel"
---

<objective>
Build the card detail slide panel with rich text editing, labels, checklists, comments, and entity linking, plus the board filter panel for filtering cards by label, assignee, or due date.

Purpose: Complete the card interaction experience — users need to edit card details, manage checklists, discuss via comments, link cards to CRM entities, and filter board views. The card detail panel is the primary workspace for card-level operations.

Output: Working card detail panel that slides in from the right when a card is clicked, with all sub-features (labels, checklists, comments, entity link, rich text). Plus a filter panel for board-level card filtering.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-free-form-kanban-boards/30-RESEARCH.md
@.planning/phases/30-free-form-kanban-boards/30-CONTEXT.md
@.planning/phases/30-free-form-kanban-boards/30-04-SUMMARY.md

Reference components:
@globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.ts (slide panel pattern)
@globcrm-web/src/app/shared/components/rich-text-editor/rich-text-editor.component.ts (rich text editor)
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts (preview sidebar)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create card detail slide panel with description, labels, checklists, comments, and entity linking</name>
  <files>
    globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.ts
    globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.html
    globcrm-web/src/app/features/boards/card-detail-panel/card-detail-panel.component.scss
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.html
  </files>
  <action>
    Create CardDetailPanelComponent — right-side slide panel for card editing. Follow the integration-detail-panel pattern: CSS transform translateX(100%) when closed, translateX(0) when open, with transition animation.

    **Component setup:**
    - Standalone, ChangeDetectionStrategy.OnPush
    - Inputs: `isOpen` (boolean), `cardId` (string | null), `boardId` (string)
    - Outputs: `closed` (event emitter)
    - Inject BoardsService, BoardStore, PreviewSidebarStore, MatSnackBar, TranslocoService
    - When cardId changes, load full card data from store or via API
    - Load comments separately: boardsService.getComments(boardId, cardId)

    **Panel layout (scrollable, 420px width):**

    1. **Panel header:**
       - Close button (X icon) at top-right
       - Card title — editable inline input (large text, Plus Jakarta Sans 600). On blur/enter, call boardsService.updateCard() to save.
       - Archive button (archive icon) with tooltip

    2. **Sidebar metadata section (right column or stacked):**
       - **Assignee** (KANB-07): Display current assignee avatar + name, or "Unassigned" placeholder. Click opens a member picker dropdown (list team members from AuthStore or API). On select, call updateCard with new assigneeId.
       - **Due date** (KANB-08): Date picker input (mat-datepicker). Shows urgency color next to date. On change, call updateCard.
       - **Labels** (KANB-06): Show current card labels as colored chips with name. "+" button opens label picker:
         - Dropdown/popover showing all board labels (from boardStore.board().labels)
         - Click a label to toggle it on/off the card (addLabelToCard / removeLabelFromCard)
         - "Create label" button at bottom opens inline form: name input + color palette (8 preset colors). Creates label via createLabel, then adds to card.
       - **Entity link** (KANB-10, KANB-11): If linked, show entity type icon + name as a clickable badge. Click opens PreviewSidebarStore.open(linkedEntityType, linkedEntityId). Remove link button (X). If not linked, show "Link to entity" button that opens an entity search:
         - Entity type selector (dropdown: Contact, Company, Deal, Lead, Product, Quote, Request, Activity)
         - Name search input (calls existing entity list API with search query — reuse pattern from other pickers in the codebase)
         - Search results list with entity icon + name
         - On select: call updateCard with linkedEntityType, linkedEntityId, linkedEntityName

    3. **Description section** (KANB-12):
       - Section header "Description" with edit toggle
       - Embed existing RichTextEditorComponent (ngx-quill wrapper) for rich text editing
       - Show rendered HTML when not editing, switch to editor on click
       - Auto-save on blur or after debounce (call updateCard with new description)

    4. **Checklists section** (KANB-15):
       - Section header "Checklist" with progress bar (checked/total ratio, filled bar using --positive color for completed portion)
       - List of checklist items:
         - Each item: checkbox (mat-checkbox) + text. Click checkbox calls toggleChecklistItem. Checked items get strikethrough text.
         - Edit item text inline (click to edit, blur/enter to save via updateChecklistItem)
         - Delete item button (small X icon on hover)
       - "Add item" input at bottom: text input + enter to add (createChecklistItem)
       - Items ordered by sortOrder

    5. **Comments section** (KANB-16):
       - Section header "Comments" with count
       - Comment input at top: textarea with "Add a comment..." placeholder + Submit button
       - Comment list (chronological, oldest first):
         - Each comment: author avatar + name, content text, timestamp (relative time like "2 hours ago"), Reply button
         - Reply: click Reply, textarea appears below the comment with "Reply..." placeholder. On submit: createComment with parentCommentId
         - Replies indented below parent comment (max 2 levels per RESEARCH.md)
         - Edit own comment: three-dot menu with Edit/Delete options (only for author's own comments)
       - Comments loaded from boardsService.getComments() — already returns threaded structure from API

    **Wire into BoardDetailComponent:**
    - Add `<app-card-detail-panel>` to board-detail.component.html, controlled by boardStore.isCardPanelOpen and boardStore.selectedCardId
    - When card is clicked (from BoardCardComponent cardClicked output or from inline card click), call boardStore.openCard(cardId)
    - When panel closed, call boardStore.closeCardPanel()
    - Panel overlays the right side of the board (position: fixed or absolute, z-index above board content, with semi-transparent backdrop or just a shadow border)

    **Styles (card-detail-panel.component.scss):**
    - Panel: position fixed, right 0, top 0, bottom 0, width 420px, bg-card background, border-left border-subtle, shadow-lg, z-index 50
    - Slide animation: transform translateX(100%) when closed, translateX(0) when open, transition 0.3s cubic-bezier(0.4, 0, 0.2, 1)
    - Sections separated by border-subtle dividers, 16px padding
    - Label chips: small pill shapes with label color as background (10% opacity) and label color as text
    - Checklist progress bar: 4px height, radius-full, bg-elevated track, --positive fill
    - Comments: indented replies with left border-subtle line for visual hierarchy
    - Entity link badge: same style as card face but larger
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration development` — builds without errors
    2. Click a card — panel slides in from right
    3. Edit card title, description, due date, assignee — changes save
    4. Add/remove labels on a card
    5. Add checklist items, toggle checked state, see progress bar
    6. Add comments and reply to comments
    7. Link a card to an entity, click entity link opens preview sidebar
  </verify>
  <done>Card detail panel slides in from right with full editing: title, rich text description, assignee picker, due date picker, label management, checklist items with progress, threaded comments, and entity linking with preview sidebar integration.</done>
</task>

<task type="auto">
  <name>Task 2: Create board filter panel for filtering cards by label, assignee, and due date</name>
  <files>
    globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.ts
    globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.html
    globcrm-web/src/app/features/boards/board-filter-panel/board-filter-panel.component.scss
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.html
    globcrm-web/src/app/features/boards/board-card/board-card.component.ts
  </files>
  <action>
    Create BoardFilterPanelComponent — toggleable filter panel below the board header.

    **Filter panel layout (KANB-17):**
    - Collapsible section below board header, above columns
    - Toggle via "Filter" button in board header (mat-icon filter_list)
    - Shows active filter count badge on the button when filters are applied

    **Filter options:**
    - **Labels:** Display all board labels as clickable colored chips. Click to toggle filter on/off. Multiple labels can be selected (OR logic — show cards matching ANY selected label). Selected labels get orange border highlight.
    - **Assignee:** Dropdown or chip list showing team members who have cards on this board. Click to filter by assignee. "Unassigned" option to show cards with no assignee.
    - **Due date:** Quick filter buttons: "Overdue", "Due Today", "Due This Week", "No Due Date", "All". Only one due date filter active at a time.
    - **Clear All** button to reset all filters

    **Client-side filtering:**
    - Filters apply client-side on the loaded board data (not server-side)
    - BoardStore has `cardFilter` state and `setCardFilter` / `clearCardFilter` methods
    - In BoardDetailComponent, create a computed signal `filteredColumns` that takes `boardStore.board().columns` and filters cards within each column based on active filters:
      - Label filter: card.labels.some(l => selectedLabels.includes(l.labelId))
      - Assignee filter: card.assigneeId === selectedAssigneeId (or card.assigneeId === null for unassigned)
      - Due date filter: compare card.dueDate against today/week ranges
    - When filters active, cards that don't match are hidden (not removed from column — just visually hidden via CSS or @if)
    - Column card counts update to reflect visible cards
    - WIP limit comparison uses visible card count when filtering

    **Wire into BoardDetailComponent:**
    - Add `<app-board-filter-panel>` between board header and columns
    - isFilterOpen signal to toggle visibility
    - Pass board labels and unique assignees as inputs to filter panel
    - Filter panel emits filter changes, board detail applies to cardFilter in store

    **Also update BoardCardComponent:**
    - Add `hidden` input or apply CSS class when card doesn't match active filters
    - Smooth transition: fade out cards that don't match (opacity transition)

    **Styles:**
    - Filter panel: bg-card background, border-bottom border-subtle, padding 12px 16px, flex wrap for filter groups
    - Label chips: small colored pills (same style as card face labels but clickable)
    - Active filters: orange border, orange-glow background
    - Due date buttons: pill-style toggle buttons (similar to tab pills)
    - Transition: max-height collapse/expand for panel visibility
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration development` — builds without errors
    2. Click filter button in board header — filter panel toggles
    3. Select a label filter — only cards with that label are visible
    4. Select an assignee — only their cards visible
    5. Select "Overdue" — only overdue cards visible
    6. Clear All resets all filters
    7. Filter badge shows count of active filters
  </verify>
  <done>Board filter panel allows filtering cards by label, assignee, and due date with client-side filtering, active filter badges, and smooth card visibility transitions.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` — builds cleanly
2. Card detail panel works with all sub-features (description, labels, checklists, comments, entity link)
3. Filter panel filters cards correctly by label, assignee, and due date
4. Entity linking opens preview sidebar
5. Rich text editor works for card descriptions
6. Comments support threaded replies
</verification>

<success_criteria>
- Card detail panel slides in smoothly from right side
- All card editing features work: title, description (rich text), due date, assignee, labels, checklists, comments, entity link
- Checklist shows progress indicator
- Comments support threaded replies (2 levels)
- Entity link badge opens existing preview sidebar
- Filter panel correctly filters cards by label, assignee, and due date
- Active filter count badge shows on filter button
</success_criteria>

<output>
After completion, create `.planning/phases/30-free-form-kanban-boards/30-05-SUMMARY.md`
</output>
