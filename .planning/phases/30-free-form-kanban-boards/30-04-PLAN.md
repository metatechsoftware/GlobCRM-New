---
phase: 30-free-form-kanban-boards
plan: 04
type: execute
wave: 4
depends_on: [30-03]
files_modified:
  - globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts
  - globcrm-web/src/app/features/boards/board-detail/board-detail.component.html
  - globcrm-web/src/app/features/boards/board-detail/board-detail.component.scss
  - globcrm-web/src/app/features/boards/board-card/board-card.component.ts
  - globcrm-web/src/app/features/boards/board-card/board-card.component.html
  - globcrm-web/src/app/features/boards/board-card/board-card.component.scss
autonomous: true
requirements:
  - KANB-02
  - KANB-03
  - KANB-04
  - KANB-08
  - KANB-13

must_haves:
  truths:
    - "User sees a horizontal kanban board with fixed-width columns (~280px) and horizontal scroll when columns exceed viewport"
    - "User can add a new column via a persistent '+' button after the last column with inline name input"
    - "User can rename a column by clicking its name (inline edit) and delete a column via column header menu"
    - "User can create a new card via '+' button at the bottom of each column"
    - "User can drag-and-drop cards between columns and reorder within columns with optimistic UI and revert on API failure"
    - "User can drag-and-drop column headers to reorder columns horizontally"
    - "Cards display title, due date with urgency coloring (yellow approaching within 3 days, red overdue), assignee avatar, checklist progress, and label color bars"
    - "Columns show WIP limit badge and visual warning when card count exceeds the WIP limit"
    - "Lifted card style with drop shadow and slight rotation during drag, placeholder gap at insertion point"
  artifacts:
    - path: "globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts"
      provides: "Kanban board view with columns, cards, and dual-level drag-and-drop"
      contains: "BoardDetailComponent"
    - path: "globcrm-web/src/app/features/boards/board-card/board-card.component.ts"
      provides: "Individual card component with metadata display and hover actions"
      contains: "BoardCardComponent"
  key_links:
    - from: "BoardDetailComponent"
      to: "BoardStore.loadBoard()"
      via: "Route param id triggers board load"
      pattern: "boardStore.*loadBoard"
    - from: "BoardDetailComponent.onCardDrop"
      to: "BoardStore.moveCard()"
      via: "CDK cdkDropListDropped event handler"
      pattern: "cdkDropListDropped.*onCardDrop"
    - from: "BoardDetailComponent.onColumnDrop"
      to: "BoardStore.reorderColumns()"
      via: "CDK cdkDropListDropped on column container"
      pattern: "cdkDropListDropped.*onColumnDrop"
    - from: "BoardCardComponent"
      to: "card detail panel (Plan 05)"
      via: "Click event emitting card selection"
      pattern: "output.*cardClicked"
---

<objective>
Build the core kanban board view with columns, cards, and dual-level CDK drag-and-drop (cards within/across columns + column reordering).

Purpose: This is the heart of the Kanban boards feature — the interactive board where users manage columns and cards with drag-and-drop. It implements the locked user decisions: fixed-width columns with horizontal scroll, lifted card drag style with rotation, placeholder gaps, column border glow on drop targets, and WIP limit warnings.

Output: Working board detail page at /boards/:id showing columns with draggable cards and draggable columns.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-free-form-kanban-boards/30-RESEARCH.md
@.planning/phases/30-free-form-kanban-boards/30-CONTEXT.md
@.planning/phases/30-free-form-kanban-boards/30-03-SUMMARY.md

Reference components for CDK drag-drop patterns:
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.html
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create board detail component with columns and dual drag-and-drop</name>
  <files>
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.ts
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.html
    globcrm-web/src/app/features/boards/board-detail/board-detail.component.scss
  </files>
  <action>
    Create BoardDetailComponent — Standalone, ChangeDetectionStrategy.OnPush.

    **Imports:** CdkDropListGroup, CdkDropList, CdkDrag, CdkDragHandle, CdkDragPreview, CdkDragPlaceholder, moveItemInArray, transferArrayItem (from @angular/cdk/drag-drop), MatIconModule, MatButtonModule, MatMenuModule, MatTooltipModule, TranslocoPipe, BoardCardComponent, FormsModule (for inline edits).

    **Component setup:**
    - Route param `id` bound as input (via withComponentInputBinding)
    - Inject BoardStore (from component providers), Router, MatSnackBar, TranslocoService
    - On init effect: when `id` input changes, call `boardStore.loadBoard(id)`
    - Board data from `boardStore.board()` signal

    **Board header:**
    - Board name (large, Plus Jakarta Sans 700), editable inline (click to edit)
    - Board description (muted text, collapsible)
    - Board color shown as small colored dot
    - Back button (mat-icon-button, arrow_back) navigating to /boards
    - Three-dot menu: Edit Board, Delete Board options
    - Filter button that opens the card filter panel (created in Plan 05)

    **Column layout (horizontal scrolling):**
    - Outer container: `display: flex; overflow-x: auto; gap: 16px; padding: 16px;`
    - The column container is wrapped in a `CdkDropList` with `orientation="horizontal"` and `cdkDropListLockAxis="x"` for column reordering
    - Each column is a `CdkDrag` with `cdkDragHandle` on the column header area (a small drag grip icon)

    **Per-column structure:**
    - Column wrapper: `width: 280px; min-width: 280px; flex-shrink: 0;`
    - Column header:
      - Column name (editable inline — click name to edit, blur/enter to save via boardStore)
      - Card count badge
      - WIP limit badge: if wipLimit set, show "count/limit" — normal color when under limit, warning color (--caution or --negative) when count >= limit (KANB-13). When exceeded: column header background gets a subtle warning tint.
      - Column menu (MatMenu three-dot): Rename, Set WIP Limit, Change Color, Delete Column
      - Drag handle icon (drag_indicator) for column reordering
    - Column body: Wraps cards in a `CdkDropList` (part of `CdkDropListGroup` for cross-column transfer), vertical orientation
    - Column collapsed state (per CONTEXT.md): when collapsed, column shrinks to a thin vertical strip (~40px width) showing column name rotated 90deg and card count. Click the strip to expand. Use CSS transition for smooth collapse/expand.
    - Column footer: "+ Add card" button at the bottom of each column. Click shows inline title input (enter to create, escape to cancel).

    **"Add new column" button** — Persistent "+" button after the last column (per CONTEXT.md):
    - Displayed as a dashed-border card at the end of the column list
    - Click opens an inline name input; enter to create column, escape to cancel
    - New column gets SortOrder = max existing + 1.0

    **Card drag-and-drop (within and across columns):**
    - `CdkDropListGroup` wraps all column bodies
    - Each column body is a `CdkDropList` with `[cdkDropListData]="column.cards"` and unique `[id]="column.id"`
    - Each card is rendered via `<app-board-card>` wrapped in a `cdkDrag`
    - `CdkDragPreview`: Custom preview showing card title + due date, styled with `transform: scale(1.02) rotate(2deg)`, box-shadow, 0.95 opacity, max-width 280px (per CONTEXT.md locked decision)
    - `CdkDragPlaceholder`: Gap/line placeholder with dashed border and primary color tint (per CONTEXT.md)
    - Drop event handler `onCardDrop(event, targetColumnId)`:
      1. Same container: `moveItemInArray()` — reorder within column
      2. Different container: `transferArrayItem()` — move between columns
      3. Calculate new SortOrder using float midpoint: (beforeCard.sortOrder + afterCard.sortOrder) / 2. Edge cases: first position = first.sortOrder / 2, last position = last.sortOrder + 1.0
      4. Call `boardStore.moveCard(cardId, targetColumnId, newSortOrder)` — optimistic (already moved in array), API revert on failure
      5. After drop, check WIP limit on target column — if exceeded, show non-blocking snackbar warning "Column exceeds WIP limit"

    **Column drag-and-drop:**
    - Separate `CdkDropList` wrapping the column array (NOT inside CdkDropListGroup — separate drag system per RESEARCH.md anti-pattern warning)
    - `orientation="horizontal"`, `cdkDropListLockAxis="x"`
    - `CdkDragHandle` on column header drag grip icon
    - Drop event: `moveItemInArray()` on columns array, then call `boardStore.reorderColumns(newColumnOrder)`
    - Column drag preview: show column header only (not the full column with cards)

    **Board detail styles (board-detail.component.scss):**
    - Uses Warm Modern design tokens throughout
    - Column background: var(--bg-elevated) with border-subtle border, radius-lg
    - Column header: slightly different bg for visual separation
    - Horizontal scroll: smooth scroll, hide scrollbar on webkit (custom scrollbar styling)
    - Card drag preview: scale(1.02) rotate(2deg), shadow-xl, 0.95 opacity
    - Card placeholder: primary color 8% bg, dashed border primary 40%, radius-md
    - Column drop target: when a card is dragged over, column gets subtle border glow via `.cdk-drop-list-dragging` class
    - WIP exceeded: column header gets `--negative` or `--caution` tinted background
    - Column collapsed: width 40px, name rotated, card count badge, cursor pointer
    - Responsive: on mobile (<768px), columns stack vertically or horizontal scroll is touch-enabled
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration development` — builds without errors
    2. Navigate to /boards/{id} — see columns with cards
    3. Drag a card between columns — optimistic move works
    4. Drag a column header — columns reorder
    5. WIP limit warning appears when column is over limit
  </verify>
  <done>Board detail page renders with horizontal kanban columns, dual CDK drag-and-drop (cards + columns), inline column/card creation, WIP limit warnings, and proper drag styling (lifted card with rotation, placeholder gaps).</done>
</task>

<task type="auto">
  <name>Task 2: Create board card component with metadata display and hover actions</name>
  <files>
    globcrm-web/src/app/features/boards/board-card/board-card.component.ts
    globcrm-web/src/app/features/boards/board-card/board-card.component.html
    globcrm-web/src/app/features/boards/board-card/board-card.component.scss
  </files>
  <action>
    Create BoardCardComponent — Standalone, ChangeDetectionStrategy.OnPush. This renders a single card in the kanban column.

    **Inputs (Angular signal inputs):**
    - `card` — required CardDto input
    - `boardId` — required string input (for API calls)

    **Outputs (Angular signal outputs):**
    - `cardClicked` — emits card ID when user clicks the card (opens card detail panel in Plan 05)
    - `cardArchived` — emits card ID when user archives via hover action

    **Card face layout (per CONTEXT.md locked decision — Trello-style compact):**
    1. **Label color bars** — Thin color bars (4px height) across the top edge of the card. One bar per label, side by side. Colors from card.labels[].color. By default show just the color bars; on click/hover over the bars area, expand to show label names below the bars briefly (tooltip or expand animation — Claude's discretion).

    2. **Card title** — Always visible. Plus Jakarta Sans, weight 500, --text-primary. Truncate with ellipsis if longer than 2 lines.

    3. **Entity link badge** (if linkedEntityType is set) — Small chip/badge below the title showing entity type icon (from ENTITY_TYPE_REGISTRY via entityTypeIcon mapping: Contact=people, Company=business, Deal=handshake, Lead=person_search, etc.) + linkedEntityName. Clickable — clicking opens PreviewSidebarStore.open(linkedEntityType, linkedEntityId). Badge styled with --bg-elevated background, --text-secondary color, radius-full (pill shape).

    4. **Bottom metadata row** — Small icons along the bottom edge of the card:
      - **Assignee avatar** (if assigneeId set): Small circular avatar (24px) with initials from assigneeName, gradient orange-400 to orange-600 (per design system avatar pattern)
      - **Due date** (if dueDate set): Small calendar icon + date text. Urgency coloring per KANB-08:
        - Overdue (past due): --negative color (red #FB7185)
        - Approaching (within 3 days): --caution color (yellow #FBBF24)
        - Normal: --text-muted color
        Calculate urgency by comparing dueDate to current date.
      - **Checklist progress** (if checklistTotal > 0): Small check_box icon + "checked/total" text. Color: --positive if all checked, --text-muted otherwise.
      - **Comment count** (if commentCount > 0): Small chat_bubble_outline icon + count.

    5. **Hover actions** (per CONTEXT.md) — Small action icons that fade in on card hover, positioned top-right corner of the card:
      - Edit (edit icon) — emits cardClicked to open detail panel
      - Archive (archive icon) — emits cardArchived
      - Label (label icon) — opens quick label picker (or emits event for Plan 05)
      Use CSS opacity transition: 0 normally, 1 on card hover. Small icon buttons (24px) with semi-transparent background.

    **Card styles (board-card.component.scss):**
    - Card: bg-card background, border-subtle border, radius-md (10px), padding 12px
    - Hover: border-hover, translateY(-1px), shadow-sm
    - Label bars: height 4px, border-radius-full at top, gap 2px between bars
    - Metadata icons: 14px font-size, --text-faint color, gap 8px between items
    - Hover actions: opacity 0 → 1 transition (0.2s ease), absolute positioned top-right
    - Entity badge: inline-flex, small padding, pill shape, 12px font-size
    - Due date urgency colors: use CSS custom properties with conditional class binding
    - Assignee avatar: 24px circle with orange gradient, 10px white text
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration development` — builds without errors
    2. Cards render with title, label bars, metadata row
    3. Hover reveals action buttons
    4. Due date shows correct urgency coloring
    5. Entity link badge shows icon + name
  </verify>
  <done>BoardCardComponent renders compact Trello-style cards with label color bars, entity link badges, due date urgency indicators, assignee avatars, checklist progress, comment count, and hover action buttons.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` — builds cleanly
2. Board detail page shows at /boards/:id with horizontal columns
3. Cards display all metadata (labels, due date, assignee, checklist, comments)
4. Card drag-and-drop works within and across columns with lifted + rotated preview
5. Column drag-and-drop reorders columns horizontally
6. WIP limit exceeded shows warning on column header
7. Hover actions appear on card hover
</verification>

<success_criteria>
- Board detail renders with fixed-width columns and horizontal scroll
- Dual drag-and-drop works (cards + columns) without CDK conflicts
- Card face shows all required metadata in compact Trello-style layout
- Drag preview has rotation + shadow per locked decisions
- WIP limit warnings display when column is over capacity
- Urgency coloring works for due dates
</success_criteria>

<output>
After completion, create `.planning/phases/30-free-form-kanban-boards/30-04-SUMMARY.md`
</output>
