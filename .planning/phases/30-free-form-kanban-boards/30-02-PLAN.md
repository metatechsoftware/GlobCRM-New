---
phase: 30-free-form-kanban-boards
plan: 02
type: execute
wave: 2
depends_on: [30-01]
files_modified:
  - src/GlobCRM.Api/Controllers/BoardsController.cs
autonomous: true
requirements:
  - KANB-01
  - KANB-02
  - KANB-03
  - KANB-04
  - KANB-05
  - KANB-06
  - KANB-07
  - KANB-10
  - KANB-13
  - KANB-14
  - KANB-15
  - KANB-16

must_haves:
  truths:
    - "API supports full board CRUD (create with template columns, list filtered by visibility, get detail with columns+cards+labels, update, delete)"
    - "API supports column CRUD (add, rename, reorder, delete) and card CRUD (create, update, move between columns, archive)"
    - "API supports label management (create, update, delete, add to card, remove from card)"
    - "API supports checklist items (add, update, toggle, delete) and card comments (list threaded, add, update, delete)"
    - "Board creation accepts an optional template key that pre-populates columns with predefined names and WIP limits"
    - "Board list endpoint filters by visibility: Private=creator only, Team=team members, Public=all tenant users"
    - "Card move endpoint accepts targetColumnId + sortOrder for optimistic UI support"
    - "DTOs never expose raw entity IDs for navigation — use FromEntity factory methods"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/BoardsController.cs"
      provides: "Full REST API for boards, columns, cards, labels, checklists, comments"
      contains: "class BoardsController"
  key_links:
    - from: "BoardsController"
      to: "ApplicationDbContext"
      via: "EF Core queries with Include for eager loading"
      pattern: "_db\\.KanbanBoards"
    - from: "BoardsController.CreateBoard"
      to: "KanbanBoard + KanbanColumn entities"
      via: "Template-based column population on create"
      pattern: "templateKey.*columns"
    - from: "BoardsController.MoveCard"
      to: "KanbanCard.ColumnId + SortOrder"
      via: "PATCH endpoint updating column and sort position"
      pattern: "MoveCard.*targetColumnId.*sortOrder"
---

<objective>
Create the BoardsController with all REST API endpoints, DTOs (with FromEntity factories), request records, and FluentValidation validators for the Kanban boards feature.

Purpose: Provide the complete backend API that the Angular frontend will consume for board, column, card, label, checklist, and comment operations. The controller follows the DashboardsController pattern for ownership/visibility and includes template-based board creation.

Output: A single comprehensive BoardsController.cs file with ~25 endpoints, all DTOs, request records, and validators co-located in the same file (per project convention).
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-free-form-kanban-boards/30-RESEARCH.md
@.planning/phases/30-free-form-kanban-boards/30-01-SUMMARY.md

Reference controllers for patterns:
@src/GlobCRM.Api/Controllers/DashboardsController.cs (ownership/visibility, CRUD pattern)
@src/GlobCRM.Api/Controllers/IntegrationsController.cs (recent controller, DTOs co-located, FromEntity pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BoardsController with board, column, and card endpoints</name>
  <files>src/GlobCRM.Api/Controllers/BoardsController.cs</files>
  <action>
    Create BoardsController.cs with all endpoints, DTOs, request records, and validators co-located in the same file. Follow DashboardsController patterns: inject ApplicationDbContext + ITenantProvider, use `[Authorize]` at controller level, extract userId from ClaimTypes.NameIdentifier.

    **Injected dependencies:** ApplicationDbContext _db, ITenantProvider _tenantProvider, ILogger<BoardsController> _logger

    **DTOs (all with static FromEntity factory methods):**
    - `BoardListDto` — Id, Name, Description, Color, Visibility, CreatorId, CreatorName, ColumnCount, CardCount, CreatedAt, UpdatedAt
    - `BoardDetailDto` — Id, Name, Description, Color, Visibility, CreatorId, CreatorName, TeamId, Columns (List<ColumnDto>), Labels (List<LabelDto>), CreatedAt, UpdatedAt
    - `ColumnDto` — Id, Name, SortOrder, WipLimit, Color, IsCollapsed, Cards (List<CardDto>)
    - `CardDto` — Id, Title, Description, DueDate, AssigneeId, AssigneeName, SortOrder, IsArchived, LinkedEntityType, LinkedEntityId, LinkedEntityName, Labels (List<CardLabelDto>), ChecklistTotal, ChecklistChecked, CommentCount, CreatedAt, UpdatedAt
    - `CardLabelDto` — LabelId, Name, Color
    - `LabelDto` — Id, Name, Color
    - `ChecklistItemDto` — Id, Text, IsChecked, SortOrder
    - `CardCommentDto` — Id, Content, AuthorId, AuthorName, ParentCommentId, CreatedAt, UpdatedAt, Replies (List<CardCommentDto>)

    **Request records:**
    - `CreateBoardRequest` — Name (string), Description (string?), Color (string?), Visibility (BoardVisibility?), TeamId (Guid?), TemplateKey (string? — "sprint", "content", "sales")
    - `UpdateBoardRequest` — Name (string?), Description (string?), Color (string?), Visibility (BoardVisibility?), TeamId (Guid?)
    - `CreateColumnRequest` — Name (string), WipLimit (int?), Color (string?)
    - `UpdateColumnRequest` — Name (string?), WipLimit (int?), Color (string?)
    - `ReorderColumnsRequest` — ColumnIds (List<Guid>)
    - `CreateCardRequest` — Title (string), Description (string?), DueDate (DateTimeOffset?), AssigneeId (Guid?), ColumnId (Guid? — defaults to first column)
    - `UpdateCardRequest` — Title (string?), Description (string?), DueDate (DateTimeOffset?), AssigneeId (Guid?), LinkedEntityType (string?), LinkedEntityId (Guid?), LinkedEntityName (string?)
    - `MoveCardRequest` — TargetColumnId (Guid), SortOrder (double)
    - `CreateLabelRequest` — Name (string), Color (string)
    - `UpdateLabelRequest` — Name (string?), Color (string?)
    - `CreateChecklistItemRequest` — Text (string)
    - `UpdateChecklistItemRequest` — Text (string?), IsChecked (bool?)
    - `CreateCommentRequest` — Content (string), ParentCommentId (Guid?)
    - `UpdateCommentRequest` — Content (string)

    **Board endpoints:**
    - `GET /api/boards` — List boards filtered by visibility (same logic as DashboardsController: Public OR Private+creator match OR Team+team membership). Include column count and card count via aggregation. Order by Name.
    - `POST /api/boards` — Create board. If TemplateKey provided, populate with predefined columns from template definitions (Sprint: Backlog/To Do(5)/In Progress(3)/Review(2)/Done; Content: Ideas/Writing/Editing/Scheduled/Published; Sales: To Contact/Contacted/Follow Up/Meeting Set/Closed). Assign SortOrder 1.0, 2.0, 3.0... to template columns. Set CreatorId from JWT, TenantId from tenant provider.
    - `GET /api/boards/{id}` — Get board detail with columns (ordered by SortOrder), each column with non-archived cards (ordered by SortOrder), labels. Verify access via visibility check. Eager load: Columns -> Cards -> Labels -> Label, Cards -> ChecklistItems, Cards -> Assignee, Board -> Labels.
    - `PUT /api/boards/{id}` — Update board properties. Only creator or admin can update. Verify board belongs to current user or user is admin.
    - `DELETE /api/boards/{id}` — Delete board (cascade deletes columns, cards, etc.). Only creator or admin.

    **Column endpoints (nested under board):**
    - `POST /api/boards/{id}/columns` — Add column. SortOrder = max existing SortOrder + 1.0. Verify board access.
    - `PUT /api/boards/{id}/columns/{colId}` — Update column name, WIP limit, color.
    - `DELETE /api/boards/{id}/columns/{colId}` — Delete column. Move any remaining cards to the first column (by SortOrder) in the board, appending at the end. If it's the last column, reject with 400.
    - `PATCH /api/boards/{id}/columns/reorder` — Accept array of column IDs, assign SortOrder 1.0, 2.0, 3.0... in the given order.

    **Card endpoints (nested under board):**
    - `POST /api/boards/{id}/cards` — Create card. ColumnId optional (defaults to first column by SortOrder). SortOrder = max in target column + 1.0. Return created CardDto.
    - `PUT /api/boards/{id}/cards/{cardId}` — Update card properties (title, description, due date, assignee, entity link). Return updated CardDto.
    - `PATCH /api/boards/{id}/cards/{cardId}/move` — Move card: update ColumnId to targetColumnId, SortOrder to provided value. This is the critical drag-and-drop endpoint. Return updated CardDto.
    - `PATCH /api/boards/{id}/cards/{cardId}/archive` — Toggle IsArchived. Return updated CardDto.

    **Visibility helper method** (private):
    ```csharp
    private async Task<KanbanBoard?> GetBoardWithAccessCheck(Guid boardId, Guid userId)
    ```
    Returns board if user has access based on visibility rules, null otherwise. Used by all endpoints that accept a boardId.

    **Board template definitions** (private static):
    Define template column arrays as static data within the controller (or as a private nested class). Templates: sprint, content, sales — each with column names and optional WIP limits matching the RESEARCH.md definitions.
  </action>
  <verify>
    1. `cd src/GlobCRM.Api && dotnet build` compiles
    2. All board/column/card endpoints are defined with correct HTTP methods and routes
    3. DTOs have static FromEntity factory methods
    4. Visibility filtering logic is present in GetBoardWithAccessCheck
  </verify>
  <done>BoardsController has all board, column, and card CRUD endpoints with visibility-based access control, template-based board creation, and float-based card move support.</done>
</task>

<task type="auto">
  <name>Task 2: Add label, checklist, and comment endpoints to BoardsController</name>
  <files>src/GlobCRM.Api/Controllers/BoardsController.cs</files>
  <action>
    Add the remaining endpoints to BoardsController for labels, checklists, and comments.

    **Label endpoints:**
    - `POST /api/boards/{id}/labels` — Create board-scoped label with name and color. Return LabelDto.
    - `PUT /api/boards/{id}/labels/{labelId}` — Update label name/color. Return LabelDto.
    - `DELETE /api/boards/{id}/labels/{labelId}` — Delete label (cascade removes KanbanCardLabel join entries).
    - `POST /api/boards/{id}/cards/{cardId}/labels/{labelId}` — Add label to card. Verify both card and label belong to this board. Return 204 NoContent.
    - `DELETE /api/boards/{id}/cards/{cardId}/labels/{labelId}` — Remove label from card. Return 204 NoContent.

    **Checklist endpoints:**
    - `POST /api/boards/{id}/cards/{cardId}/checklist` — Add checklist item. SortOrder = max existing + 1.0. Return ChecklistItemDto.
    - `PUT /api/boards/{id}/cards/{cardId}/checklist/{itemId}` — Update checklist item text and/or isChecked. Return ChecklistItemDto.
    - `DELETE /api/boards/{id}/cards/{cardId}/checklist/{itemId}` — Delete checklist item. Return 204 NoContent.
    - `PATCH /api/boards/{id}/cards/{cardId}/checklist/{itemId}/toggle` — Toggle IsChecked boolean. Return ChecklistItemDto.

    **Comment endpoints:**
    - `GET /api/boards/{id}/cards/{cardId}/comments` — Get all comments for a card, organized as a tree (top-level comments with nested replies). Order by CreatedAt ascending. Return List<CardCommentDto>.
    - `POST /api/boards/{id}/cards/{cardId}/comments` — Add comment. Set AuthorId from JWT. If ParentCommentId provided, verify parent exists on same card. Return CardCommentDto.
    - `PUT /api/boards/{id}/cards/{cardId}/comments/{commentId}` — Update comment content. Only author can update. Return CardCommentDto.
    - `DELETE /api/boards/{id}/cards/{cardId}/comments/{commentId}` — Delete comment. Only author or admin. If comment has replies, also delete replies (cascade). Return 204 NoContent.

    **Comment tree building** (private helper):
    Build threaded comment tree from flat list: filter top-level (ParentCommentId == null), then recursively attach replies. Limit nesting to 2 levels for simplicity.

    **Validation:** Add FluentValidation validators for CreateBoardRequest (Name required, max 200), CreateCardRequest (Title required, max 500), CreateCommentRequest (Content required, max 5000), CreateLabelRequest (Name required max 50, Color required max 10), CreateChecklistItemRequest (Text required max 500).

    All endpoints must call `GetBoardWithAccessCheck` to verify the user can access the board before performing operations on its children.
  </action>
  <verify>
    1. `cd src/GlobCRM.Api && dotnet build` compiles
    2. Label, checklist, and comment endpoints are all defined with correct routes
    3. Comment tree building returns nested structure
    4. FluentValidation validators exist for all request types
  </verify>
  <done>BoardsController is complete with all ~25 endpoints covering boards, columns, cards, labels, checklists, and comments. All DTOs, request records, and validators are co-located. Visibility-based access control is applied consistently across all endpoints.</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — solution compiles cleanly
2. BoardsController.cs exists with all endpoints matching the API spec from 30-RESEARCH.md
3. All DTOs have static FromEntity factory methods
4. Board list endpoint filters by visibility (Private/Team/Public)
5. Card move endpoint accepts targetColumnId + sortOrder
6. Board creation with template key pre-populates columns
7. FluentValidation validators cover all request types
</verification>

<success_criteria>
- Solution compiles without errors
- All 25+ API endpoints are functional with correct HTTP methods and route patterns
- Board visibility filtering works for Private, Team, and Public boards
- Template-based board creation populates predefined columns
- Card move endpoint supports float-based SortOrder for optimistic UI
- Comments support threaded replies
- All request types have FluentValidation validators
</success_criteria>

<output>
After completion, create `.planning/phases/30-free-form-kanban-boards/30-02-SUMMARY.md`
</output>
