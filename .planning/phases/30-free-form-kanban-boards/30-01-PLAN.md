---
phase: 30-free-form-kanban-boards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/KanbanBoard.cs
  - src/GlobCRM.Domain/Entities/KanbanColumn.cs
  - src/GlobCRM.Domain/Entities/KanbanCard.cs
  - src/GlobCRM.Domain/Entities/KanbanLabel.cs
  - src/GlobCRM.Domain/Entities/KanbanCardLabel.cs
  - src/GlobCRM.Domain/Entities/KanbanChecklistItem.cs
  - src/GlobCRM.Domain/Entities/KanbanCardComment.cs
  - src/GlobCRM.Domain/Enums/BoardVisibility.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanBoardConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanColumnConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanLabelConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardLabelConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanChecklistItemConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardCommentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Migrations/App/
autonomous: true
requirements:
  - KANB-01
  - KANB-02
  - KANB-03
  - KANB-05
  - KANB-06
  - KANB-07
  - KANB-10
  - KANB-13
  - KANB-15
  - KANB-16

must_haves:
  truths:
    - "KanbanBoard entity exists with TenantId, Name, Description, Color, Visibility, CreatorId, TeamId properties"
    - "KanbanColumn entity exists with BoardId FK, Name, SortOrder (double), WipLimit (nullable int), Color"
    - "KanbanCard entity exists with ColumnId FK, Title, Description, DueDate, AssigneeId, SortOrder (double), IsArchived, LinkedEntityType, LinkedEntityId, LinkedEntityName"
    - "KanbanLabel, KanbanCardLabel join table, KanbanChecklistItem, and KanbanCardComment entities exist with correct relationships"
    - "BoardVisibility enum has Private, Team, Public values"
    - "EF Core migration creates all Kanban tables with correct indexes and FK constraints"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/KanbanBoard.cs"
      provides: "Board entity with visibility and ownership"
      contains: "class KanbanBoard"
    - path: "src/GlobCRM.Domain/Entities/KanbanCard.cs"
      provides: "Card entity with entity linking and float sort order"
      contains: "class KanbanCard"
    - path: "src/GlobCRM.Domain/Enums/BoardVisibility.cs"
      provides: "Board visibility enum"
      contains: "enum BoardVisibility"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSet registrations for all Kanban entities"
      contains: "DbSet<KanbanBoard>"
  key_links:
    - from: "KanbanColumn"
      to: "KanbanBoard"
      via: "BoardId FK with cascade delete"
      pattern: "HasOne.*Board.*WithMany.*Columns"
    - from: "KanbanCard"
      to: "KanbanColumn"
      via: "ColumnId FK with cascade delete"
      pattern: "HasOne.*Column.*WithMany.*Cards"
    - from: "KanbanBoard"
      to: "ApplicationDbContext"
      via: "DbSet registration + global query filter"
      pattern: "DbSet<KanbanBoard>"
---

<objective>
Create all backend domain entities, enum, EF Core configurations, and database migration for the Kanban boards feature.

Purpose: Establish the data foundation that all API endpoints and frontend features will build upon. Seven new entities (KanbanBoard, KanbanColumn, KanbanCard, KanbanLabel, KanbanCardLabel, KanbanChecklistItem, KanbanCardComment) plus the BoardVisibility enum.

Output: Domain entities, EF Core fluent configurations with proper relationships and indexes, DbSet registrations in ApplicationDbContext with global query filters, and a successful EF Core migration.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-free-form-kanban-boards/30-RESEARCH.md

Reference entities for patterns:
@src/GlobCRM.Domain/Entities/Dashboard.cs (ownership/visibility pattern)
@src/GlobCRM.Domain/Entities/Note.cs (polymorphic entity linking pattern)
@src/GlobCRM.Domain/Entities/Integration.cs (recent entity with TenantId + global query filter)
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs (DbSet registration + query filters)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain entities and BoardVisibility enum</name>
  <files>
    src/GlobCRM.Domain/Entities/KanbanBoard.cs
    src/GlobCRM.Domain/Entities/KanbanColumn.cs
    src/GlobCRM.Domain/Entities/KanbanCard.cs
    src/GlobCRM.Domain/Entities/KanbanLabel.cs
    src/GlobCRM.Domain/Entities/KanbanCardLabel.cs
    src/GlobCRM.Domain/Entities/KanbanChecklistItem.cs
    src/GlobCRM.Domain/Entities/KanbanCardComment.cs
    src/GlobCRM.Domain/Enums/BoardVisibility.cs
  </files>
  <action>
    Create 7 domain entities and 1 enum following established project patterns (TenantId, CreatedAt/UpdatedAt, IsSeedData, XML doc comments, namespace GlobCRM.Domain.Entities / GlobCRM.Domain.Enums).

    **BoardVisibility enum** (src/GlobCRM.Domain/Enums/BoardVisibility.cs):
    - Values: Private, Team, Public

    **KanbanBoard** (follows Dashboard.cs ownership pattern):
    - Id (Guid, default NewGuid), TenantId (Guid), Name (string), Description (string?), Color (string? — hex color for board accent), Visibility (BoardVisibility, default Private), CreatorId (Guid), TeamId (Guid? — required when Visibility == Team), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset), IsSeedData (bool)
    - Navigation: Creator (ApplicationUser?), Team (Team?), Columns (ICollection<KanbanColumn>), Labels (ICollection<KanbanLabel>)

    **KanbanColumn** (child of Board — inherits tenant isolation via BoardId FK):
    - Id (Guid), BoardId (Guid), Name (string), SortOrder (double — float-based for insertion), WipLimit (int? — null means no limit), Color (string?), IsCollapsed (bool, default false), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Board (KanbanBoard), Cards (ICollection<KanbanCard>)

    **KanbanCard** (child of Column):
    - Id (Guid), ColumnId (Guid), Title (string), Description (string? — HTML from rich text editor), DueDate (DateTimeOffset?), AssigneeId (Guid?), SortOrder (double — float-based), IsArchived (bool, default false)
    - Polymorphic entity link (same as Note.cs): LinkedEntityType (string?), LinkedEntityId (Guid?), LinkedEntityName (string? — denormalized for display)
    - CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Column (KanbanColumn), Assignee (ApplicationUser?), Labels (ICollection<KanbanCardLabel>), ChecklistItems (ICollection<KanbanChecklistItem>), Comments (ICollection<KanbanCardComment>)

    **KanbanLabel** (board-scoped):
    - Id (Guid), BoardId (Guid), Name (string), Color (string, default "#F97316" — orange), CreatedAt (DateTimeOffset)
    - Navigation: Board (KanbanBoard), CardLabels (ICollection<KanbanCardLabel>)

    **KanbanCardLabel** (join table — no TenantId, inherits via Label -> Board chain):
    - CardId (Guid), LabelId (Guid)
    - Navigation: Card (KanbanCard), Label (KanbanLabel)

    **KanbanChecklistItem** (child of Card):
    - Id (Guid), CardId (Guid), Text (string), IsChecked (bool, default false), SortOrder (double), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Card (KanbanCard)

    **KanbanCardComment** (follows FeedComment/ActivityComment pattern):
    - Id (Guid), CardId (Guid), Content (string), AuthorId (Guid?), ParentCommentId (Guid? — for threading), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Card (KanbanCard), Author (ApplicationUser?), ParentComment (KanbanCardComment?), Replies (ICollection<KanbanCardComment>)
  </action>
  <verify>
    `cd src/GlobCRM.Domain && dotnet build` compiles without errors. All 7 entity files and 1 enum file exist in correct directories.
  </verify>
  <done>All 7 Kanban domain entities and BoardVisibility enum exist with correct properties, navigation properties, defaults, and XML doc comments matching established project patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, DbSet registrations, global query filter, and migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanBoardConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanColumnConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanLabelConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardLabelConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanChecklistItemConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/KanbanCardCommentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Persistence/Migrations/App/
  </files>
  <action>
    Create EF Core fluent API configuration classes (IEntityTypeConfiguration<T>) for each entity. Follow established project patterns: snake_case table/column names via `.ToTable("kanban_*")`, HasKey, property configs with maxlength, FK relationships with cascade delete behavior, indexes.

    **KanbanBoardConfiguration:**
    - Table: "kanban_boards"
    - Global query filter: `.HasQueryFilter(b => b.TenantId == _tenantId)` (same pattern as Integration entity)
    - Indexes: (TenantId, Name) for listing, (TenantId, CreatorId) for filtering, (TenantId, Visibility) for visibility queries
    - FK: CreatorId -> ApplicationUser (SetNull on delete), TeamId -> Team (SetNull on delete)
    - Property: Name maxLength 200, Description maxLength 2000, Color maxLength 10

    **KanbanColumnConfiguration:**
    - Table: "kanban_columns"
    - No TenantId (inherits via Board FK) — no global query filter needed
    - FK: BoardId -> KanbanBoard (Cascade delete)
    - Index: (BoardId, SortOrder) for ordering
    - Property: Name maxLength 100, Color maxLength 10

    **KanbanCardConfiguration:**
    - Table: "kanban_cards"
    - No TenantId (inherits via Column -> Board chain) — no global query filter
    - FK: ColumnId -> KanbanColumn (Cascade delete), AssigneeId -> ApplicationUser (SetNull on delete)
    - Indexes: (ColumnId, SortOrder) for ordering, (ColumnId, IsArchived) for filtering archived cards, (LinkedEntityType, LinkedEntityId) for entity link lookups
    - Property: Title maxLength 500, Description no max (HTML), LinkedEntityType maxLength 50, LinkedEntityName maxLength 200

    **KanbanLabelConfiguration:**
    - Table: "kanban_labels"
    - FK: BoardId -> KanbanBoard (Cascade delete)
    - Index: (BoardId) for board-scoped label listing
    - Property: Name maxLength 50, Color maxLength 10

    **KanbanCardLabelConfiguration:**
    - Table: "kanban_card_labels"
    - Composite PK: (CardId, LabelId)
    - FK: CardId -> KanbanCard (Cascade delete), LabelId -> KanbanLabel (Cascade delete)

    **KanbanChecklistItemConfiguration:**
    - Table: "kanban_checklist_items"
    - FK: CardId -> KanbanCard (Cascade delete)
    - Index: (CardId, SortOrder) for ordering
    - Property: Text maxLength 500

    **KanbanCardCommentConfiguration:**
    - Table: "kanban_card_comments"
    - FK: CardId -> KanbanCard (Cascade delete), AuthorId -> ApplicationUser (SetNull), ParentCommentId -> KanbanCardComment (Restrict to prevent cascade cycles)
    - Index: (CardId, CreatedAt) for chronological listing
    - Property: Content maxLength 5000

    **ApplicationDbContext updates:**
    - Add 7 DbSets: KanbanBoards, KanbanColumns, KanbanCards, KanbanLabels, KanbanCardLabels, KanbanChecklistItems, KanbanCardComments
    - Add global query filter for KanbanBoard (same pattern as Integration: `builder.Entity<KanbanBoard>().HasQueryFilter(...)`)
    - Register all configuration classes via `modelBuilder.ApplyConfiguration(new KanbanBoardConfiguration(tenantId))` etc. in OnModelCreating

    **Migration:**
    Run from src/GlobCRM.Api:
    `dotnet ef migrations add AddKanbanBoardEntities --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure`
    Then: `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`
  </action>
  <verify>
    1. `cd src/GlobCRM.Api && dotnet build` compiles without errors
    2. Migration file exists in src/GlobCRM.Infrastructure/Persistence/Migrations/App/
    3. `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` succeeds
    4. Tables kanban_boards, kanban_columns, kanban_cards, kanban_labels, kanban_card_labels, kanban_checklist_items, kanban_card_comments exist in database
  </verify>
  <done>All 7 EF Core configuration classes exist with correct table names, relationships, indexes, and cascade behaviors. ApplicationDbContext has all DbSets registered with global query filter on KanbanBoard. Migration is created and applied successfully.</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — entire solution compiles cleanly
2. All 7 entity files exist in src/GlobCRM.Domain/Entities/
3. BoardVisibility enum exists in src/GlobCRM.Domain/Enums/
4. All 7 configuration files exist in src/GlobCRM.Infrastructure/Persistence/Configurations/
5. Migration file exists and was applied to database
6. KanbanBoard has global query filter for TenantId
</verification>

<success_criteria>
- Solution compiles without errors
- All domain entities have correct properties, navigation relationships, and defaults
- EF Core configurations use snake_case table/column naming
- Migration creates correct database schema
- KanbanBoard has TenantId-based global query filter for multi-tenant isolation
</success_criteria>

<output>
After completion, create `.planning/phases/30-free-form-kanban-boards/30-01-SUMMARY.md`
</output>
