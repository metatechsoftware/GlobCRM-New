---
phase: 17-webhooks
plan: 04
type: execute
wave: 4
depends_on: [17-03]
files_modified:
  - globcrm-web/src/app/features/settings/webhooks/webhook.models.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook.service.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook.store.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook-list.component.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook-edit.component.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook-detail.component.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook-delivery-log.component.ts
  - globcrm-web/src/app/features/settings/webhooks/webhook-test-dialog.component.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/app/features/settings/settings-hub.component.ts
autonomous: true
requirements:
  - WHOOK-01
  - WHOOK-04
  - WHOOK-05

must_haves:
  truths:
    - "Admin can view a list of webhook subscriptions with status indicators"
    - "Admin can create/edit a webhook subscription, selecting entity+event types with checkboxes"
    - "Admin can view subscription detail with filtered delivery log"
    - "Admin can view a global delivery log page with status badges and expandable rows"
    - "Admin can test a webhook with payload preview before sending"
    - "Admin can manually retry failed deliveries and re-enable disabled subscriptions"
    - "Webhook management is accessible from Settings navigation"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook.models.ts"
      provides: "TypeScript interfaces for webhook subscription, delivery log, requests"
      contains: "WebhookSubscription"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook.service.ts"
      provides: "API service for webhook CRUD, test, delivery logs, retry"
      contains: "WebhookService"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook.store.ts"
      provides: "Signal store for webhook state management"
      contains: "WebhookStore"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook-list.component.ts"
      provides: "Subscription list page with status chips and action buttons"
      contains: "WebhookListComponent"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook-edit.component.ts"
      provides: "Create/edit form with entity+event checkbox matrix"
      contains: "WebhookEditComponent"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook-detail.component.ts"
      provides: "Subscription detail with delivery log tab"
      contains: "WebhookDetailComponent"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook-delivery-log.component.ts"
      provides: "Global delivery log with status badges and expandable rows"
      contains: "WebhookDeliveryLogComponent"
    - path: "globcrm-web/src/app/features/settings/webhooks/webhook-test-dialog.component.ts"
      provides: "Test dialog with payload preview and send button"
      contains: "WebhookTestDialogComponent"
  key_links:
    - from: "globcrm-web/src/app/features/settings/webhooks/webhook.service.ts"
      to: "/api/webhooks"
      via: "ApiService HTTP calls"
      pattern: "api/webhooks"
    - from: "globcrm-web/src/app/features/settings/settings.routes.ts"
      to: "globcrm-web/src/app/features/settings/webhooks/"
      via: "Lazy-loaded routes under /settings/webhooks"
      pattern: "webhooks"
---

<objective>
Build the complete frontend for webhook management: subscription list, create/edit forms, subscription detail with delivery log, global delivery log page, and test dialog. All components under settings/webhooks with lazy-loaded routes.

Purpose: Give admins a complete UI for managing webhook subscriptions and monitoring delivery health — the observability layer for the webhook subsystem.
Output: 5 components, 1 service, 1 store, 1 models file, updated settings routes.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-webhooks/17-RESEARCH.md
@.planning/phases/17-webhooks/17-03-SUMMARY.md
@globcrm-web/src/app/features/settings/settings.routes.ts
@globcrm-web/src/app/features/settings/settings-hub.component.ts
@globcrm-web/src/app/features/settings/duplicate-rules/duplicate-rules.component.ts
@globcrm-web/src/app/features/settings/roles/role-list.component.ts
@globcrm-web/src/app/core/api/api.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Models, service, store, and list/edit components</name>
  <files>
    globcrm-web/src/app/features/settings/webhooks/webhook.models.ts
    globcrm-web/src/app/features/settings/webhooks/webhook.service.ts
    globcrm-web/src/app/features/settings/webhooks/webhook.store.ts
    globcrm-web/src/app/features/settings/webhooks/webhook-list.component.ts
    globcrm-web/src/app/features/settings/webhooks/webhook-edit.component.ts
  </files>
  <action>
    **1. Create webhook.models.ts:**
    - `WebhookSubscription` interface: id, name, url, secretMask, eventSubscriptions (string[]), includeCustomFields, isActive, isDisabled, consecutiveFailureCount, lastDeliveryAt (string|null), disabledAt (string|null), disabledReason (string|null), createdAt, updatedAt
    - `WebhookSubscriptionCreate` extends WebhookSubscription with `secret: string` (full secret on create)
    - `CreateWebhookRequest`: name, url, eventSubscriptions (string[]), includeCustomFields
    - `UpdateWebhookRequest`: Partial<CreateWebhookRequest> & { isActive?: boolean }
    - `WebhookDeliveryLog` interface: id, subscriptionId, subscriptionName, eventType, entityId, attemptNumber, success, httpStatusCode (number|null), responseBody (string|null), errorMessage (string|null), requestPayload, durationMs, createdAt
    - `PagedDeliveryLogs`: items (WebhookDeliveryLog[]), totalCount, page, pageSize
    - `WebhookTestPreview`: samplePayload (string)
    - Constants: `WEBHOOK_ENTITIES = ['Contact', 'Company', 'Deal', 'Lead', 'Activity']`
    - Constants: `WEBHOOK_EVENTS = ['Created', 'Updated', 'Deleted']`

    **2. Create webhook.service.ts:**
    - Injectable service using ApiService (inject() pattern)
    - Methods:
      - `getSubscriptions(): Observable<WebhookSubscription[]>` — GET /api/webhooks
      - `getSubscription(id: string): Observable<WebhookSubscription>` — GET /api/webhooks/{id}
      - `createSubscription(req: CreateWebhookRequest): Observable<WebhookSubscriptionCreate>` — POST /api/webhooks
      - `updateSubscription(id: string, req: UpdateWebhookRequest): Observable<WebhookSubscription>` — PUT /api/webhooks/{id}
      - `deleteSubscription(id: string): Observable<void>` — DELETE /api/webhooks/{id}
      - `regenerateSecret(id: string): Observable<{ secret: string }>` — POST /api/webhooks/{id}/regenerate-secret
      - `toggleSubscription(id: string): Observable<WebhookSubscription>` — POST /api/webhooks/{id}/toggle
      - `getDeliveryLogs(page: number, pageSize: number, subscriptionId?: string): Observable<PagedDeliveryLogs>` — GET /api/webhooks/delivery-logs
      - `getSubscriptionDeliveryLogs(id: string, page: number, pageSize: number): Observable<PagedDeliveryLogs>` — GET /api/webhooks/{id}/delivery-logs
      - `testWebhook(id: string, preview: boolean): Observable<any>` — POST /api/webhooks/{id}/test
      - `retryDelivery(logId: string): Observable<any>` — POST /api/webhooks/delivery-logs/{logId}/retry

    **3. Create webhook.store.ts:**
    - NgRx Signal Store with `providedIn: undefined` (per-component provider, not root)
    - State: subscriptions (WebhookSubscription[]), selectedSubscription (WebhookSubscription|null), deliveryLogs (PagedDeliveryLogs|null), loading, error
    - Methods: loadSubscriptions, loadSubscription, createSubscription, updateSubscription, deleteSubscription, toggleSubscription, regenerateSecret, loadDeliveryLogs, testWebhook, retryDelivery
    - Use `patchState` for updates, `tapResponse` pattern from existing stores

    **4. Create webhook-list.component.ts:**
    - Standalone component with OnPush change detection
    - Provides WebhookStore in component providers
    - Displays subscriptions in a mat-card list/table layout (NOT DynamicTable — this is settings)
    - Each subscription row shows: Name, URL (truncated), event count badge, status chip (Active/Disabled/Paused), failure count if > 0, last delivery time
    - Status chips: green "Active", red "Disabled" (auto-disabled), gray "Paused" (manually disabled)
    - Action buttons: View detail (navigate), Edit, Delete (with confirm dialog)
    - Top bar: "Add Webhook" button navigates to /settings/webhooks/new
    - Link to global delivery log: "View All Delivery Logs" button
    - Load subscriptions on init

    **5. Create webhook-edit.component.ts:**
    - Standalone component with OnPush, route param `id` for edit mode (absent = create)
    - Reactive form with fields:
      - Name (text input, required)
      - URL (text input, required, placeholder "https://...")
      - Include Custom Fields (toggle/checkbox)
    - Event subscription matrix: 5 entities x 3 events checkbox grid
      - Rows: Contact, Company, Deal, Lead, Activity
      - Columns: Created, Updated, Deleted
      - Checkboxes for each combination (e.g., Contact.Created, Deal.Updated)
      - Select All / Deselect All buttons for convenience
    - On save (create): Call store.createSubscription, navigate to list, show the returned secret in a one-time dialog (mat-dialog with copy-to-clipboard button, warning that it won't be shown again)
    - On save (edit): Call store.updateSubscription, navigate to detail
    - In edit mode: pre-populate form with existing subscription data, URL field shows current value
    - Use the `WEBHOOK_ENTITIES` and `WEBHOOK_EVENTS` constants for the matrix

    **Secret display dialog:** After creating a new subscription, show a mat-dialog with:
    - Title: "Webhook Secret"
    - Warning text: "This is the only time this secret will be shown. Copy it now."
    - Secret value in a code-styled box with a copy button
    - "I've copied the secret" button to close
    - Same dialog for regenerate-secret response
  </action>
  <verify>
    `cd globcrm-web && npx ng build` — 0 errors. Verify webhook.models.ts exports all interfaces. Verify webhook.service.ts has all 11 API methods. Verify webhook-list.component.ts renders subscription cards with status chips. Verify webhook-edit.component.ts has entity+event checkbox matrix.
  </verify>
  <done>Models, service, store, list, and edit components created. Subscription list shows status chips and actions. Edit form has entity+event checkbox matrix. Secret shown once on create via dialog with copy button.</done>
</task>

<task type="auto">
  <name>Task 2: Detail, delivery log, test dialog components, and settings route registration</name>
  <files>
    globcrm-web/src/app/features/settings/webhooks/webhook-detail.component.ts
    globcrm-web/src/app/features/settings/webhooks/webhook-delivery-log.component.ts
    globcrm-web/src/app/features/settings/webhooks/webhook-test-dialog.component.ts
    globcrm-web/src/app/features/settings/settings.routes.ts
    globcrm-web/src/app/features/settings/settings-hub.component.ts
  </files>
  <action>
    **1. Create webhook-detail.component.ts:**
    - Route param `id`, loads subscription detail and per-subscription delivery logs
    - Top section: Subscription info card showing:
      - Name, URL, Status (Active/Disabled/Paused chip), Secret mask (e.g., "whsec_****...abcd")
      - Event subscriptions as chips (e.g., "Contact Created", "Deal Updated")
      - Include Custom Fields: Yes/No
      - Created at, Last delivery, Consecutive failures
    - Action buttons:
      - Edit (navigate to /settings/webhooks/{id}/edit)
      - Test (opens test dialog)
      - Regenerate Secret (confirm dialog, then call service, show new secret in one-time dialog)
      - Enable/Disable toggle button
      - If auto-disabled: prominent "Re-enable" button with info message about why it was disabled
    - Bottom section: Delivery log table (reuse delivery log rendering pattern from global log)
      - Paginated, loads via store.loadDeliveryLogs with subscriptionId filter
      - Status badges, expandable rows (same as global log)
      - Retry button on failed entries

    **2. Create webhook-delivery-log.component.ts:**
    - Global delivery log page at /settings/webhooks/delivery-logs
    - Custom layout (NOT DynamicTable — per locked decision: purpose-built for webhook logs)
    - Table columns: Timestamp, Subscription Name, Event Type, Status (badge), HTTP Code, Duration, Actions
    - Status badges: green "Success" for success=true, red "Failed" for success=false, orange "Retrying" for failed with attempt < 7
    - Expandable rows: click a row to expand and show:
      - Full request payload (formatted JSON in a pre/code block with syntax-like mono font)
      - Response body (if available, truncated to 1KB)
      - Error message (if failed)
      - Attempt number
    - Retry button on failed entries: calls store.retryDelivery(logId), shows snackbar confirmation
    - Pagination: mat-paginator at bottom, default 25 per page
    - Optional subscription filter dropdown at top (loads subscription list for filter)

    **3. Create webhook-test-dialog.component.ts:**
    - Mat dialog opened from detail page
    - Two-step flow (per locked decision: preview payload first, then option to send):
      - Step 1 — Preview: On dialog open, call service.testWebhook(id, true) to get sample payload. Display the JSON in a formatted code block. Show "Send Test" and "Cancel" buttons.
      - Step 2 — Send: When "Send Test" clicked, call service.testWebhook(id, false) to enqueue actual delivery. Show success message "Test webhook sent! Check delivery logs for results." with "Close" button.
    - Loading indicator while fetching preview and while sending
    - Input: subscription ID (passed as dialog data)

    **4. Update settings.routes.ts:**
    - Add webhook routes with adminGuard:
      ```
      { path: 'webhooks', loadComponent: webhook-list }
      { path: 'webhooks/new', loadComponent: webhook-edit }
      { path: 'webhooks/delivery-logs', loadComponent: webhook-delivery-log }
      { path: 'webhooks/:id', loadComponent: webhook-detail }
      { path: 'webhooks/:id/edit', loadComponent: webhook-edit }
      ```
    - Order matters: 'webhooks/new' and 'webhooks/delivery-logs' must come BEFORE 'webhooks/:id' to avoid route matching conflicts

    **5. Update settings-hub.component.ts:**
    - Add a "Webhooks" card/link to the settings hub page
    - Icon: mat-icon "webhook" or "link" (use "link" if "webhook" not available)
    - Description: "Manage webhook subscriptions for external integrations"
    - Route: /settings/webhooks
    - Place after existing items (Duplicate Rules or similar)
  </action>
  <verify>
    `cd globcrm-web && npx ng build` — 0 errors. Verify settings.routes.ts has 5 new webhook routes with adminGuard. Verify webhook-detail.component.ts loads subscription and delivery logs. Verify webhook-delivery-log.component.ts has expandable rows and retry buttons. Verify webhook-test-dialog.component.ts has two-step preview/send flow. Verify settings-hub.component.ts shows Webhooks card.
  </verify>
  <done>Detail page shows subscription info with action buttons and filtered delivery log. Global delivery log has custom layout with status badges, expandable rows, and retry buttons. Test dialog supports preview-then-send flow. Settings routes registered with adminGuard. Settings hub shows Webhooks link.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build` — 0 errors
2. Navigate to /settings/webhooks — shows subscription list
3. /settings/webhooks/new — shows create form with entity+event checkbox matrix
4. /settings/webhooks/{id} — shows detail with delivery logs
5. /settings/webhooks/delivery-logs — shows global delivery log
6. Test dialog shows preview payload before sending
7. Failed deliveries have retry button
8. Disabled subscriptions show re-enable option
9. Secret shown once on create, masked everywhere else
10. Settings hub has Webhooks card
</verification>

<success_criteria>
- All 5 components + service + store + models created as standalone Angular components with OnPush
- Subscription list with status chips (Active/Disabled/Paused), action buttons
- Edit form with entity+event checkbox matrix for 5 entities x 3 events
- Detail page with subscription info, actions (test, regenerate, toggle), and delivery log
- Global delivery log with custom layout, status badges, expandable rows, pagination, retry
- Test dialog with two-step preview/send flow
- Secret dialog with copy button shown once on create and regenerate
- Settings routes and hub updated
- Frontend builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-webhooks/17-04-SUMMARY.md`
</output>
