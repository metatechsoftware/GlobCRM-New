---
phase: 17-webhooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/WebhookSubscription.cs
  - src/GlobCRM.Domain/Entities/WebhookDeliveryLog.cs
  - src/GlobCRM.Domain/Enums/WebhookEventType.cs
  - src/GlobCRM.Domain/Interfaces/IWebhookRepository.cs
  - src/GlobCRM.Domain/Interfaces/IDomainEvent.cs
  - src/GlobCRM.Infrastructure/DomainEvents/DomainEventInterceptor.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookSubscriptionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookDeliveryLogConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Webhooks/WebhookRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Migrations/App/
  - scripts/rls-setup.sql
autonomous: true
requirements:
  - WHOOK-01
  - WHOOK-04

must_haves:
  truths:
    - "WebhookSubscription entity stores URL, secret, event subscriptions (JSONB), active/disabled state, and consecutive failure count"
    - "WebhookDeliveryLog entity stores subscription reference, event type, entity ID, attempt number, success/failure, HTTP status, duration, and payloads"
    - "DomainEvent record captures both old and new property values for Modified entities"
    - "EF Core migration creates webhook tables with correct indexes and tenant isolation"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/WebhookSubscription.cs"
      provides: "Webhook subscription entity with event subscriptions, secret, failure tracking"
      contains: "class WebhookSubscription"
    - path: "src/GlobCRM.Domain/Entities/WebhookDeliveryLog.cs"
      provides: "Delivery attempt log entity with request/response details"
      contains: "class WebhookDeliveryLog"
    - path: "src/GlobCRM.Domain/Interfaces/IDomainEvent.cs"
      provides: "Enhanced DomainEvent record with OldPropertyValues parameter"
      contains: "OldPropertyValues"
    - path: "src/GlobCRM.Infrastructure/Webhooks/WebhookRepository.cs"
      provides: "EF Core repository for subscription and delivery log CRUD"
      contains: "class WebhookRepository"
  key_links:
    - from: "src/GlobCRM.Infrastructure/DomainEvents/DomainEventInterceptor.cs"
      to: "src/GlobCRM.Domain/Interfaces/IDomainEvent.cs"
      via: "Captures OriginalValue into OldPropertyValues dictionary"
      pattern: "OldPropertyValues.*OriginalValue"
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "src/GlobCRM.Domain/Entities/WebhookSubscription.cs"
      via: "DbSet registration and global query filter"
      pattern: "DbSet<WebhookSubscription>"
---

<objective>
Create the domain foundation for the webhook subsystem: entities, enums, repository interface/implementation, EF Core configurations with migration, RLS policies, and enhance the DomainEvent record to capture old property values for update change tracking.

Purpose: Establish the data layer that all subsequent webhook plans depend on -- subscription storage, delivery logging, and the enhanced domain event capture needed for old/new value pairs in webhook payloads.
Output: WebhookSubscription and WebhookDeliveryLog entities, EF configs, applied migration, RLS policies, repository, and DomainEvent with OldPropertyValues.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-webhooks/17-RESEARCH.md
@src/GlobCRM.Domain/Interfaces/IDomainEvent.cs
@src/GlobCRM.Infrastructure/DomainEvents/DomainEventInterceptor.cs
@src/GlobCRM.Domain/Entities/DuplicateMatchingConfig.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/EmailTemplateConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities, enums, repository interface, and DomainEvent enhancement</name>
  <files>
    src/GlobCRM.Domain/Entities/WebhookSubscription.cs
    src/GlobCRM.Domain/Entities/WebhookDeliveryLog.cs
    src/GlobCRM.Domain/Enums/WebhookEventType.cs
    src/GlobCRM.Domain/Interfaces/IWebhookRepository.cs
    src/GlobCRM.Domain/Interfaces/IDomainEvent.cs
    src/GlobCRM.Infrastructure/DomainEvents/DomainEventInterceptor.cs
  </files>
  <action>
    **1. Create WebhookSubscription entity** at `src/GlobCRM.Domain/Entities/WebhookSubscription.cs`:
    - Properties: Id (Guid), TenantId (Guid), Name (string), Url (string), Secret (string — HMAC secret, `whsec_` prefixed)
    - EventSubscriptions: `List<string>` — stores entity+event pairs like "Contact.Created", "Deal.Updated", "Company.Deleted"
    - IncludeCustomFields (bool, default false) — opt-in per subscription per locked decision
    - IsActive (bool, default true) — admin manual toggle
    - IsDisabled (bool, default false) — auto-disabled by consecutive failure threshold
    - ConsecutiveFailureCount (int, default 0)
    - LastDeliveryAt (DateTimeOffset?), DisabledAt (DateTimeOffset?), DisabledReason (string?)
    - CreatedByUserId (Guid), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Core 5 entities: Contact, Company, Deal, Lead, Activity — per locked decision

    **2. Create WebhookDeliveryLog entity** at `src/GlobCRM.Domain/Entities/WebhookDeliveryLog.cs`:
    - Properties: Id (Guid), TenantId (Guid), SubscriptionId (Guid), Subscription (navigation)
    - EventType (string — e.g. "Contact.Updated"), EntityId (string — the entity's ID)
    - AttemptNumber (int), Success (bool), HttpStatusCode (int?), ResponseBody (string? — truncated to 1KB)
    - ErrorMessage (string?), RequestPayload (string — full JSON payload), DurationMs (long)
    - CreatedAt (DateTimeOffset)

    **3. Create WebhookEventType enum** at `src/GlobCRM.Domain/Enums/WebhookEventType.cs`:
    - Values: Created, Updated, Deleted
    - This is a simple reference enum; the actual storage uses string format "Entity.EventType"

    **4. Create IWebhookRepository interface** at `src/GlobCRM.Domain/Interfaces/IWebhookRepository.cs`:
    - Methods: GetActiveSubscriptionsAsync(CancellationToken), GetSubscriptionByIdAsync(Guid, CancellationToken)
    - CreateSubscriptionAsync(WebhookSubscription, CancellationToken), UpdateSubscriptionAsync(WebhookSubscription, CancellationToken)
    - DeleteSubscriptionAsync(Guid, CancellationToken)
    - GetDeliveryLogsAsync(Guid? subscriptionId, int page, int pageSize, CancellationToken) — null subscriptionId = global
    - CreateDeliveryLogAsync(WebhookDeliveryLog, CancellationToken)
    - GetSubscriptionsForEventAsync(string entityName, string eventType, CancellationToken) — for matching
    - RegenerateSecretAsync(Guid subscriptionId, string newSecret, CancellationToken)

    **5. Enhance DomainEvent record** in `src/GlobCRM.Domain/Interfaces/IDomainEvent.cs`:
    - Add a 6th parameter: `Dictionary<string, object?>? OldPropertyValues` (default null for backward compatibility)
    - This is a backward-compatible change — existing consumers that don't use OldPropertyValues are unaffected

    **6. Update DomainEventInterceptor** in `src/GlobCRM.Infrastructure/DomainEvents/DomainEventInterceptor.cs`:
    - In the `CaptureEvents` method, for Modified entities, also capture OriginalValue:
    - Create a separate `oldValues` dictionary alongside `changedProperties`
    - For each `prop.IsModified`, set `oldValues[prop.Metadata.Name] = prop.OriginalValue`
    - Pass `oldValues` as the new `OldPropertyValues` parameter to the DomainEvent constructor
    - For Added/Deleted entities, pass null for OldPropertyValues
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` — compiles with 0 errors. Verify DomainEvent record has 6 parameters. Verify WebhookSubscription has EventSubscriptions as List of string. Verify IWebhookRepository interface compiles.
  </verify>
  <done>WebhookSubscription and WebhookDeliveryLog entities exist with all required properties. DomainEvent record has OldPropertyValues parameter. IWebhookRepository interface defines full CRUD + event matching. DomainEventInterceptor captures both old and new values for Modified entities.</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, migration, RLS policies, DbContext registration, and repository implementation</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookSubscriptionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookDeliveryLogConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Webhooks/WebhookRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Migrations/App/
    scripts/rls-setup.sql
  </files>
  <action>
    **1. Create WebhookSubscriptionConfiguration** at `src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookSubscriptionConfiguration.cs`:
    - Table name: `webhook_subscriptions` (snake_case convention)
    - Column mappings: id, tenant_id, name, url, secret, event_subscriptions (JSONB), include_custom_fields, is_active, is_disabled, consecutive_failure_count, last_delivery_at, disabled_at, disabled_reason, created_by_user_id, created_at, updated_at
    - JSONB column for EventSubscriptions using `.HasColumnType("jsonb")`
    - Global query filter: `.HasQueryFilter(e => e.TenantId == _tenantId)` — follow existing pattern in ApplicationDbContext
    - Indexes: (tenant_id, is_active, is_disabled) composite for subscription matching queries
    - MaxLength constraints: Name 200, Url 2048, Secret 100, DisabledReason 500

    **2. Create WebhookDeliveryLogConfiguration** at `src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookDeliveryLogConfiguration.cs`:
    - Table name: `webhook_delivery_logs` (snake_case)
    - Column mappings: all properties to snake_case
    - JSONB: RequestPayload does NOT need JSONB type — store as text (it's a serialized JSON string for signing fidelity)
    - FK: SubscriptionId -> WebhookSubscription with cascade delete (logs deleted when subscription deleted)
    - Global query filter by TenantId
    - Indexes: (subscription_id, created_at DESC) for per-subscription log queries, (tenant_id, created_at DESC) for global log queries
    - MaxLength: EventType 50, EntityId 50, ResponseBody 1024, ErrorMessage 2000, RequestPayload unlimited (text)

    **3. Register DbSets** in ApplicationDbContext.cs:
    - Add `public DbSet<WebhookSubscription> WebhookSubscriptions => Set<WebhookSubscription>();`
    - Add `public DbSet<WebhookDeliveryLog> WebhookDeliveryLogs => Set<WebhookDeliveryLog>();`
    - Place in a new `// Webhooks` comment section after the Duplicates section

    **4. Create and apply EF Core migration**:
    - Run: `cd src/GlobCRM.Api && dotnet ef migrations add AddWebhooks --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure`
    - Run: `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`

    **5. Add RLS policies** to `scripts/rls-setup.sql`:
    - `CREATE POLICY tenant_isolation_webhook_subscriptions ON webhook_subscriptions ...`
    - `CREATE POLICY tenant_isolation_webhook_delivery_logs ON webhook_delivery_logs ...`
    - Follow the exact pattern of existing RLS policies (using `current_setting('app.current_tenant')::uuid`)

    **6. Create WebhookRepository** at `src/GlobCRM.Infrastructure/Webhooks/WebhookRepository.cs`:
    - Implement IWebhookRepository using ApplicationDbContext
    - GetActiveSubscriptionsAsync: filter by IsActive=true AND IsDisabled=false
    - GetSubscriptionsForEventAsync: load active subscriptions, filter in-memory where EventSubscriptions contains the entity+event key
    - GetDeliveryLogsAsync: if subscriptionId provided, filter by it; otherwise return all for tenant. Order by CreatedAt DESC. Include Subscription navigation for name display. Use Skip/Take pagination.
    - RegenerateSecretAsync: load subscription, update Secret and UpdatedAt, save
    - Standard CRUD for the rest
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` — 0 errors. `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` — migration applied. Verify `webhook_subscriptions` and `webhook_delivery_logs` tables exist with correct columns and JSONB type on event_subscriptions.
  </verify>
  <done>EF Core configurations create webhook tables with proper snake_case naming, JSONB columns, indexes, and global query filters. Migration applied to database. RLS policies added. WebhookRepository implements IWebhookRepository with full CRUD, event matching, and paginated delivery log queries.</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors
2. DomainEvent record has 6 parameters including OldPropertyValues
3. WebhookSubscription.EventSubscriptions is List<string> stored as JSONB
4. WebhookDeliveryLog has FK to WebhookSubscription with cascade delete
5. Migration applied, tables exist in database
6. RLS policies exist for both webhook tables
</verification>

<success_criteria>
- WebhookSubscription and WebhookDeliveryLog entities fully defined with all properties from research
- DomainEvent enhanced with OldPropertyValues, backward compatible
- DomainEventInterceptor captures OriginalValue for modified properties
- EF Core configurations with JSONB, indexes, global query filters
- Migration created and applied
- RLS policies added to rls-setup.sql
- WebhookRepository implements IWebhookRepository with event matching and pagination
- Solution builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-webhooks/17-01-SUMMARY.md`
</output>
