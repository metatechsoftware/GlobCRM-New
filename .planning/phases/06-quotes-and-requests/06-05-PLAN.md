---
phase: 06-quotes-and-requests
plan: 05
type: execute
wave: 2
depends_on: ["06-04"]
files_modified:
  - globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts
  - globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts
autonomous: true

must_haves:
  truths:
    - "Quote list page displays quotes in DynamicTable with adjustable columns"
    - "Quote list shows status badges, grand total, contact/company names"
    - "Quote form has header fields (title, dates, entity links) and dynamic line items FormArray"
    - "Line items calculate live totals as user types (quantity, price, discount, tax)"
    - "Quote form displays subtotal, discount total, tax total, and grand total in real-time"
    - "User can add/remove line items and optionally link products"
  artifacts:
    - path: "globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts"
      provides: "Quote list page with DynamicTable, filters, saved views"
      contains: "QuoteListComponent"
    - path: "globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts"
      provides: "Quote create/edit form with line items FormArray"
      contains: "QuoteFormComponent"
  key_links:
    - from: "globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts"
      to: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      via: "DynamicTable for list rendering"
      pattern: "DynamicTableComponent"
    - from: "globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts"
      to: "globcrm-web/src/app/features/quotes/quote.models.ts"
      via: "calculateLineTotals and calculateQuoteTotals helpers"
      pattern: "calculateLineTotals"
---

<objective>
Build the Quote list page with DynamicTable and the Quote form with dynamic line items featuring live total calculations.

Purpose: Enable users to view, create, and edit quotes with the line-item builder that is core to the quote module.
Output: Quote list component, Quote form component with FormArray line items
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quotes-and-requests/06-RESEARCH.md
@.planning/phases/06-quotes-and-requests/06-04-SUMMARY.md

# Pattern references
@globcrm-web/src/app/features/deals/deal-list/deal-list.component.ts
@globcrm-web/src/app/features/deals/deal-form/deal-form.component.ts
@globcrm-web/src/app/features/activities/activity-list/activity-list.component.ts
@globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/features/quotes/quote.models.ts
@globcrm-web/src/app/features/quotes/quote.service.ts
@globcrm-web/src/app/features/quotes/quote.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quote list page with DynamicTable</name>
  <files>
    globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts
  </files>
  <action>
    Create QuoteListComponent using inline template (single .ts file) following DealListComponent/ActivityListComponent pattern:

    **Component setup:**
    - Standalone component with inline template and styles
    - providers: [QuoteStore] (component-provided, not root)
    - Inject QuoteStore, Router, MatSnackBar

    **Column definitions** (ColumnDefinition array):
    - quoteNumber (text, "Quote #", width 120px)
    - title (text, "Title", width 200px)
    - status (text, "Status", width 120px) -- render with status badge styling using QUOTE_STATUSES color
    - grandTotal (number, "Total", width 120px) -- format with Intl.NumberFormat currency (matching Product list pattern)
    - contactName (text, "Contact", width 150px)
    - companyName (text, "Company", width 150px)
    - dealTitle (text, "Deal", width 150px)
    - ownerName (text, "Owner", width 130px)
    - versionNumber (number, "Version", width 80px)
    - issueDate (date, "Issue Date", width 120px)
    - createdAt (date, "Created", width 120px)

    Default visible columns: quoteNumber, title, status, grandTotal, contactName, companyName, createdAt

    **Template:**
    - Page header with "Quotes" title and "New Quote" button (mat-raised-button, routerLink to /quotes/new)
    - DynamicTable component with columns, data from store, pagination, sorting events
    - FilterPanel for status filter (dropdown from QUOTE_STATUSES)
    - ViewSidebar for saved views (entityType: 'Quote')
    - Row click navigates to /quotes/:id

    **Behavior:**
    - OnInit: load quote list from store
    - Format grandTotal using Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }) before passing to table (matching product list pattern)
    - Status column shows colored badge (mat-chip or styled span with background color from QUOTE_STATUSES)
  </action>
  <verify>File exists at globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts and contains QuoteListComponent class with DynamicTableComponent in imports.</verify>
  <done>QuoteListComponent renders quotes in DynamicTable with 11 column definitions, status badges with color, currency-formatted grand totals, filter panel, saved views sidebar, and row click navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create Quote form with line items FormArray and live calculations</name>
  <files>
    globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts
  </files>
  <action>
    Create QuoteFormComponent using inline template (single .ts file) following DealFormComponent pattern, with the key addition of FormArray for line items:

    **Component setup:**
    - Standalone component with inline template and styles
    - Inject QuoteService (not store -- form uses service directly for create/update), ActivatedRoute, Router, MatSnackBar, FormBuilder
    - Edit mode: check route param :id -- if present, load existing quote and populate form

    **Form structure** (ReactiveFormsModule):
    ```
    quoteForm = fb.group({
      title: ['', [Validators.required, Validators.maxLength(500)]],
      description: [''],
      dealId: [null],
      contactId: [null],
      companyId: [null],
      issueDate: [new Date(), Validators.required],
      expiryDate: [null],
      notes: [''],
      lineItems: fb.array([], Validators.minLength(1)),
    });
    ```

    **Line items FormArray:**
    - Each line item is a FormGroup: { productId, description, quantity, unitPrice, discountPercent, taxPercent }
    - addLineItem(product?) method: push new FormGroup with defaults (qty: 1, price: 0, discount: 0, tax: 0). If product passed, pre-fill description and unitPrice from product.
    - removeLineItem(index) method: removeAt(index)
    - "Add Line Item" button at bottom of line items section
    - Each line item row shows calculated: lineTotal, discountAmount, taxAmount, netTotal (computed from calculateLineTotals helper, displayed as read-only)

    **Live total calculations:**
    - Use computed signal or valueChanges subscription on lineItems FormArray
    - On any line item value change, recalculate all line totals and quote totals using calculateQuoteTotals from quote.models.ts
    - Display summary at bottom: Subtotal, Discount Total, Tax Total, Grand Total (bold, larger font)

    **Entity linking (Deal, Contact, Company):**
    - Contact autocomplete: separate FormControl with Subject-based debounced search (300ms), calling ContactService or similar. Match the company autocomplete pattern from contact-form.
    - Company autocomplete: same pattern
    - Deal autocomplete: same pattern
    - Use mat-autocomplete for all three

    **Product search for line items:**
    - Small search input above line items or on each row to search products
    - When product selected, auto-fill description and unitPrice on the line item
    - Product search uses ProductService with debounced query

    **Template layout:**
    - Mat-card with form title "Create Quote" / "Edit Quote"
    - Section 1: Quote header fields (title, description, issueDate, expiryDate, notes) in mat-form-fields
    - Section 2: Entity links (deal, contact, company) with mat-autocomplete
    - Section 3: Line items table with columns: Description, Qty, Unit Price, Discount%, Tax%, Line Total, Actions (remove button). Add Line Item button. Use mat-table or CSS grid for layout.
    - Section 4: Totals summary (right-aligned): Subtotal, Discount, Tax, Grand Total
    - Action buttons: Save (primary), Cancel (navigates back)

    **Save behavior:**
    - Build request from form values
    - If edit mode: call quoteService.update(id, request)
    - If create mode: call quoteService.create(request)
    - On success: navigate to /quotes/:id (detail page) with snackbar
    - On error: show error snackbar

    **provideNativeDateAdapter** at component level for datepicker (matching deal-form pattern).
  </action>
  <verify>File exists at globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts and contains QuoteFormComponent class with FormArray lineItems.</verify>
  <done>QuoteFormComponent has reactive form with line items FormArray, live total calculations using calculateLineTotals/calculateQuoteTotals, entity linking via autocomplete, product search for line items, and create/edit save flow with navigation.</done>
</task>

</tasks>

<verification>
- Both component files exist
- QuoteListComponent uses DynamicTable with proper column definitions
- QuoteFormComponent has FormArray for line items
- Line item calculations produce correct totals
- Both components use inline templates (single .ts file)
</verification>

<success_criteria>
- Quote list displays all required columns with status badges and currency formatting
- Quote form supports add/remove line items with live calculation updates
- Form validates: title required, at least 1 line item, quantity > 0
- Entity linking works via autocomplete for deal, contact, company
- Product search auto-fills line item description and unit price
- Totals section shows subtotal, discount total, tax total, grand total in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/06-quotes-and-requests/06-05-SUMMARY.md`
</output>
