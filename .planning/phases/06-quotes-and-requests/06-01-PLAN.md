---
phase: 06-quotes-and-requests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Quote.cs
  - src/GlobCRM.Domain/Entities/QuoteLineItem.cs
  - src/GlobCRM.Domain/Entities/QuoteStatusHistory.cs
  - src/GlobCRM.Domain/Entities/Request.cs
  - src/GlobCRM.Domain/Entities/RequestWorkflow.cs
  - src/GlobCRM.Domain/Enums/QuoteStatus.cs
  - src/GlobCRM.Domain/Enums/RequestStatus.cs
  - src/GlobCRM.Domain/Enums/RequestPriority.cs
  - src/GlobCRM.Domain/Interfaces/IQuoteRepository.cs
  - src/GlobCRM.Domain/Interfaces/IRequestRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteLineItemConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteStatusHistoryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/RequestConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Quote and Request domain entities exist with all required properties"
    - "QuoteLineItem child entity captures product, quantity, unit price, discount, and tax per line"
    - "RequestWorkflow validates status transitions (New -> InProgress -> Resolved -> Closed)"
    - "EF Core migration creates quotes, quote_line_items, quote_status_history, and requests tables"
    - "RLS policies enforce tenant isolation on quotes and requests tables"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Quote.cs"
      provides: "Quote entity with line items, versioning, entity links, custom fields"
      contains: "class Quote"
    - path: "src/GlobCRM.Domain/Entities/QuoteLineItem.cs"
      provides: "Line item with product, quantity, unit price, discount, tax, computed amounts"
      contains: "class QuoteLineItem"
    - path: "src/GlobCRM.Domain/Entities/Request.cs"
      provides: "Request entity with status, priority, category, entity links"
      contains: "class Request"
    - path: "src/GlobCRM.Domain/Entities/RequestWorkflow.cs"
      provides: "Static workflow validation for request status transitions"
      contains: "static class RequestWorkflow"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and query filters for Quote and Request"
      contains: "DbSet<Quote>"
  key_links:
    - from: "src/GlobCRM.Domain/Entities/Quote.cs"
      to: "src/GlobCRM.Domain/Entities/QuoteLineItem.cs"
      via: "ICollection<QuoteLineItem> LineItems navigation"
      pattern: "ICollection<QuoteLineItem>"
    - from: "src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteConfiguration.cs"
      to: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      via: "ApplyConfigurationsFromAssembly discovers configuration"
      pattern: "IEntityTypeConfiguration<Quote>"
---

<objective>
Create all backend domain entities, enums, EF Core configurations, database migration, and RLS policies for the Quote and Request subsystems.

Purpose: Establish the complete data model for quotes (with line items, versioning, status tracking) and requests (with workflow, priority, category) that all subsequent plans depend on.
Output: Domain entities, EF Core configs, AddQuotesAndRequests migration, RLS policies
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quotes-and-requests/06-RESEARCH.md

# Pattern references (read these to match conventions exactly)
@src/GlobCRM.Domain/Entities/Deal.cs
@src/GlobCRM.Domain/Entities/DealProduct.cs
@src/GlobCRM.Domain/Entities/DealStageHistory.cs
@src/GlobCRM.Domain/Entities/Activity.cs
@src/GlobCRM.Domain/Entities/ActivityWorkflow.cs
@src/GlobCRM.Domain/Entities/ActivityStatusHistory.cs
@src/GlobCRM.Domain/Enums/ActivityStatus.cs
@src/GlobCRM.Domain/Enums/ActivityPriority.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealProductConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealStageHistoryConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quote and Request domain entities, enums, workflow, and repository interfaces</name>
  <files>
    src/GlobCRM.Domain/Entities/Quote.cs
    src/GlobCRM.Domain/Entities/QuoteLineItem.cs
    src/GlobCRM.Domain/Entities/QuoteStatusHistory.cs
    src/GlobCRM.Domain/Entities/Request.cs
    src/GlobCRM.Domain/Entities/RequestWorkflow.cs
    src/GlobCRM.Domain/Enums/QuoteStatus.cs
    src/GlobCRM.Domain/Enums/RequestStatus.cs
    src/GlobCRM.Domain/Enums/RequestPriority.cs
    src/GlobCRM.Domain/Interfaces/IQuoteRepository.cs
    src/GlobCRM.Domain/Interfaces/IRequestRepository.cs
  </files>
  <action>
    Create all domain layer files following exact patterns from Deal and Activity entities:

    **QuoteStatus enum** (src/GlobCRM.Domain/Enums/QuoteStatus.cs):
    - Values: Draft, Sent, Accepted, Rejected, Expired
    - Follow ActivityStatus enum pattern (simple enum, no attributes)

    **RequestStatus enum** (src/GlobCRM.Domain/Enums/RequestStatus.cs):
    - Values: New, InProgress, Resolved, Closed
    - Follow ActivityStatus enum pattern

    **RequestPriority enum** (src/GlobCRM.Domain/Enums/RequestPriority.cs):
    - Values: Low, Medium, High, Urgent
    - Follow ActivityPriority enum pattern exactly

    **Quote entity** (src/GlobCRM.Domain/Entities/Quote.cs):
    - Id (Guid, NewGuid default), TenantId (Guid)
    - QuoteNumber (string, auto-generated), Title (string), Description (string?)
    - Status (QuoteStatus, default Draft)
    - IssueDate (DateOnly), ExpiryDate (DateOnly?)
    - VersionNumber (int, default 1), OriginalQuoteId (Guid?, self-referencing FK)
    - DealId (Guid?), ContactId (Guid?), CompanyId (Guid?) -- direct FK links
    - OwnerId (Guid?) -- ApplicationUser FK
    - Subtotal, DiscountTotal, TaxTotal, GrandTotal (all decimal)
    - Notes (string?) -- for PDF terms/conditions
    - CustomFields (Dictionary<string, object?>), IsSeedData (bool)
    - CreatedAt, UpdatedAt (DateTimeOffset)
    - Navigation: OriginalQuote, Deal, Contact, Company, Owner, LineItems (ICollection<QuoteLineItem>)

    **QuoteLineItem entity** (src/GlobCRM.Domain/Entities/QuoteLineItem.cs):
    - Follow DealProduct pattern -- child entity with NO TenantId (inherits via Quote FK)
    - Id (Guid), QuoteId (Guid), ProductId (Guid?), Description (string)
    - SortOrder (int), Quantity (decimal, default 1), UnitPrice (decimal)
    - DiscountPercent (decimal), TaxPercent (decimal)
    - LineTotal, DiscountAmount, TaxAmount, NetTotal (all decimal, stored computed values)
    - Navigation: Quote, Product

    **QuoteStatusHistory entity** (src/GlobCRM.Domain/Entities/QuoteStatusHistory.cs):
    - Follow ActivityStatusHistory pattern -- child entity with NO TenantId
    - Id (Guid), QuoteId (Guid), FromStatus (QuoteStatus), ToStatus (QuoteStatus)
    - ChangedById (Guid?), ChangedAt (DateTimeOffset)
    - Navigation: Quote, ChangedBy (ApplicationUser)

    **Request entity** (src/GlobCRM.Domain/Entities/Request.cs):
    - Follow Activity entity pattern, simplified
    - Id (Guid), TenantId (Guid)
    - Subject (string), Description (string?)
    - Status (RequestStatus, default New), Priority (RequestPriority)
    - Category (string?) -- free text for flexibility
    - OwnerId (Guid?), AssignedToId (Guid?) -- dual ownership like Activity
    - ContactId (Guid?), CompanyId (Guid?) -- direct FK links
    - ResolvedAt (DateTimeOffset?), ClosedAt (DateTimeOffset?)
    - CustomFields (Dictionary<string, object?>), IsSeedData (bool)
    - CreatedAt, UpdatedAt (DateTimeOffset)
    - Navigation: Owner, AssignedTo (ApplicationUser), Contact, Company

    **RequestWorkflow static class** (src/GlobCRM.Domain/Entities/RequestWorkflow.cs):
    - Copy ActivityWorkflow pattern exactly
    - Transitions: New->[InProgress, Closed], InProgress->[Resolved, New], Resolved->[Closed, InProgress], Closed->[InProgress]
    - Methods: CanTransition(from, to), GetAllowedTransitions(from)

    **IQuoteRepository** (src/GlobCRM.Domain/Interfaces/IQuoteRepository.cs):
    - Follow IDealRepository pattern
    - GetPagedAsync(EntityQueryParams), GetByIdAsync(Guid), CreateAsync(Quote), UpdateAsync(Quote), DeleteAsync(Guid)
    - GetByIdWithLineItemsAsync(Guid) -- includes LineItems navigation
    - GetVersionsAsync(Guid originalQuoteId) -- get all versions of a quote

    **IRequestRepository** (src/GlobCRM.Domain/Interfaces/IRequestRepository.cs):
    - Follow IActivityRepository pattern (simplified -- no Kanban)
    - GetPagedAsync(EntityQueryParams), GetByIdAsync(Guid), CreateAsync(Request), UpdateAsync(Request), DeleteAsync(Guid)

    Also update Company.cs and Contact.cs to add navigation collections: ICollection<Quote> Quotes, ICollection<Request> Requests (follow existing ICollection<Deal> Deals pattern on Company).
  </action>
  <verify>dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj -- should compile with 0 errors</verify>
  <done>All 10 domain files created. Quote has 4 FK navigations (Deal, Contact, Company, Owner) + LineItems collection. Request has 4 FK navigations (Owner, AssignedTo, Contact, Company). RequestWorkflow validates all 4 status transitions. Repository interfaces define full CRUD + quote-specific methods.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update DbContext, add RLS policies, and generate migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteLineItemConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteStatusHistoryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/RequestConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create EF Core configurations following DealConfiguration and ActivityConfiguration patterns exactly:

    **QuoteConfiguration** (table: "quotes"):
    - snake_case column names for all properties
    - QuoteNumber: HasMaxLength(50), IsRequired
    - Title: HasMaxLength(500), IsRequired
    - Description: HasMaxLength(5000)
    - Status: HasConversion<string>() with HasMaxLength(20)
    - IssueDate: HasColumnType("date")
    - ExpiryDate: HasColumnType("date")
    - All decimal fields: HasPrecision(18, 2) for Subtotal, DiscountTotal, TaxTotal, GrandTotal
    - Notes: HasMaxLength(5000)
    - CustomFields: HasColumnType("jsonb") with System.Text.Json HasConversion for Dictionary
    - OriginalQuoteId FK: DeleteBehavior.SetNull (versions survive original deletion)
    - DealId FK: DeleteBehavior.SetNull
    - ContactId FK: DeleteBehavior.SetNull
    - CompanyId FK: DeleteBehavior.SetNull
    - OwnerId FK: DeleteBehavior.SetNull
    - Indexes: idx_quotes_tenant, idx_quotes_deal, idx_quotes_contact, idx_quotes_company, idx_quotes_owner, idx_quotes_original, idx_quotes_custom_fields_gin (GIN)

    **QuoteLineItemConfiguration** (table: "quote_line_items"):
    - NO TenantId (child entity inherits via Quote FK)
    - Quantity, UnitPrice: HasPrecision(18, 4)
    - DiscountPercent, TaxPercent: HasPrecision(5, 2)
    - LineTotal, DiscountAmount, TaxAmount, NetTotal: HasPrecision(18, 2)
    - Description: HasMaxLength(500)
    - ProductId FK: DeleteBehavior.SetNull (keep line item if product deleted)
    - QuoteId FK: DeleteBehavior.Cascade
    - Indexes: idx_quote_line_items_quote, idx_quote_line_items_product

    **QuoteStatusHistoryConfiguration** (table: "quote_status_history"):
    - NO TenantId (child entity inherits via Quote FK)
    - FromStatus, ToStatus: HasConversion<string>() with HasMaxLength(20)
    - QuoteId FK: DeleteBehavior.Cascade
    - ChangedById FK: DeleteBehavior.SetNull
    - Index: idx_quote_status_history_quote

    **RequestConfiguration** (table: "requests"):
    - snake_case column names for all properties
    - Subject: HasMaxLength(500), IsRequired
    - Description: HasMaxLength(5000)
    - Status: HasConversion<string>() with HasMaxLength(20)
    - Priority: HasConversion<string>() with HasMaxLength(20)
    - Category: HasMaxLength(200)
    - OwnerId FK: DeleteBehavior.SetNull
    - AssignedToId FK: DeleteBehavior.SetNull
    - ContactId FK: DeleteBehavior.SetNull
    - CompanyId FK: DeleteBehavior.SetNull
    - CustomFields: HasColumnType("jsonb") with System.Text.Json HasConversion
    - Indexes: idx_requests_tenant, idx_requests_contact, idx_requests_company, idx_requests_owner, idx_requests_assigned_to, idx_requests_custom_fields_gin (GIN)

    **ApplicationDbContext updates:**
    - Add DbSets: Quotes, QuoteLineItems, QuoteStatusHistories, Requests
    - Add query filters for Quote and Request (tenant isolation): entity.TenantId == _tenantId
    - QuoteLineItem and QuoteStatusHistory have NO query filter (child entities inherit via parent FK)

    **RLS policies** (scripts/rls-setup.sql):
    - Add RLS policies for "quotes" and "requests" tables following existing pattern
    - Enable ROW LEVEL SECURITY and FORCE ROW LEVEL SECURITY on both tables
    - CREATE POLICY with tenant_id = current_setting('app.current_tenant')::uuid

    **Generate migration:**
    - Run: dotnet ef migrations add AddQuotesAndRequests --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext --output-dir Persistence/Migrations/App
  </action>
  <verify>dotnet build -- should compile with 0 errors. Migration file should exist in src/GlobCRM.Infrastructure/Persistence/Migrations/App/ with AddQuotesAndRequests in the filename.</verify>
  <done>4 EF Core configurations created with snake_case naming, proper FK constraints, GIN indexes on JSONB columns. ApplicationDbContext has 4 new DbSets and 2 new query filters. RLS policies added for quotes and requests tables. Migration generated successfully.</done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with 0 errors
- All 14+ new files exist on disk
- Migration file contains CREATE TABLE for quotes, quote_line_items, quote_status_history, requests
- RLS policies added for quotes and requests tables in rls-setup.sql
- RequestWorkflow.CanTransition returns correct values for all transitions
</verification>

<success_criteria>
- All domain entities created with correct properties and navigation properties
- EF Core configurations use snake_case naming and proper FK constraints
- QuoteLineItem has no TenantId (child entity pattern)
- All decimal fields use appropriate precision (18,4 for quantities/prices, 18,2 for totals, 5,2 for percentages)
- Migration generates without errors
- RLS policies enforce tenant isolation
</success_criteria>

<output>
After completion, create `.planning/phases/06-quotes-and-requests/06-01-SUMMARY.md`
</output>
