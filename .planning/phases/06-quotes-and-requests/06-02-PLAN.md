---
phase: 06-quotes-and-requests
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/RequestRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
autonomous: true

must_haves:
  truths:
    - "QuoteRepository implements paged queries with filtering, sorting, and Include for LineItems"
    - "RequestRepository implements paged queries with filtering, sorting, and ownership scope"
    - "TenantSeeder creates sample quotes with line items and sample requests for new organizations"
    - "Both repositories registered in DI container"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteRepository.cs"
      provides: "Quote CRUD with line item Include, versioning queries, filter/sort/pagination"
      contains: "class QuoteRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/RequestRepository.cs"
      provides: "Request CRUD with filter/sort/pagination and ownership scope"
      contains: "class RequestRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs"
      provides: "Seed data for quotes and requests"
      contains: "Quote"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteRepository.cs"
      to: "src/GlobCRM.Domain/Interfaces/IQuoteRepository.cs"
      via: "implements interface"
      pattern: "IQuoteRepository"
    - from: "src/GlobCRM.Infrastructure/Persistence/Repositories/RequestRepository.cs"
      to: "src/GlobCRM.Domain/Interfaces/IRequestRepository.cs"
      via: "implements interface"
      pattern: "IRequestRepository"
---

<objective>
Implement QuoteRepository and RequestRepository with full query capabilities, and extend TenantSeeder with sample quote and request seed data.

Purpose: Enable data access for quotes (with line items, versioning, entity linking) and requests (with workflow status, ownership) that the API controllers will depend on.
Output: Two repository implementations, seed data, DI registration
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quotes-and-requests/06-RESEARCH.md
@.planning/phases/06-quotes-and-requests/06-01-SUMMARY.md

# Pattern references
@src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/CompanyRepository.cs
@src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@src/GlobCRM.Domain/Common/PagedResult.cs
@src/GlobCRM.Domain/Common/EntityQueryParams.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement QuoteRepository and RequestRepository</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/RequestRepository.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    Create both repository implementations following DealRepository and ActivityRepository patterns:

    **QuoteRepository** (implements IQuoteRepository):
    - Constructor: inject ApplicationDbContext
    - GetPagedAsync(EntityQueryParams): paginated query with filtering, sorting, Include for Contact/Company/Deal/Owner navigation. Support filters: status, contactId, companyId, dealId, ownerId. Sorting: quoteNumber, title, status, grandTotal, issueDate, createdAt (default: createdAt desc). Use ParameterReplacer expression composition pattern from CompanyRepository.
    - GetByIdAsync(Guid): single quote with Include for LineItems (ordered by SortOrder), Contact, Company, Deal, Owner
    - GetByIdWithLineItemsAsync(Guid): same as GetByIdAsync but specifically ensures LineItems are loaded with Product navigation on each item
    - CreateAsync(Quote): add and SaveChangesAsync
    - UpdateAsync(Quote): update and SaveChangesAsync
    - DeleteAsync(Guid): find and remove, then SaveChangesAsync
    - GetVersionsAsync(Guid originalQuoteId): query quotes where OriginalQuoteId == originalQuoteId OR Id == originalQuoteId, ordered by VersionNumber desc

    **RequestRepository** (implements IRequestRepository):
    - Constructor: inject ApplicationDbContext
    - GetPagedAsync(EntityQueryParams): paginated query with filtering, sorting, Include for Contact/Company/Owner/AssignedTo. Support filters: status, priority, category, contactId, companyId, ownerId, assignedToId. Sorting: subject, status, priority, category, createdAt (default: createdAt desc). Use ParameterReplacer pattern. Support ownership scope filtering (check both OwnerId and AssignedToId, matching Activity dual-ownership pattern).
    - GetByIdAsync(Guid): single request with Include for Contact, Company, Owner, AssignedTo
    - CreateAsync(Request): add and SaveChangesAsync
    - UpdateAsync(Request): update and SaveChangesAsync
    - DeleteAsync(Guid): find and remove, then SaveChangesAsync

    **DI Registration** (DependencyInjection.cs):
    - Add: services.AddScoped<IQuoteRepository, QuoteRepository>();
    - Add: services.AddScoped<IRequestRepository, RequestRepository>();
    - Place near existing repository registrations (IDealRepository, IActivityRepository, etc.)
  </action>
  <verify>dotnet build -- should compile with 0 errors. Both repositories registered in DI.</verify>
  <done>QuoteRepository supports paged queries with 6 filter fields, 6 sort fields, and line item eager loading. RequestRepository supports paged queries with 7 filter fields, 5 sort fields, and dual-ownership scope. Both registered in DI.</done>
</task>

<task type="auto">
  <name>Task 2: Add quote and request seed data to TenantSeeder</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/TenantSeeder.cs
  </files>
  <action>
    Extend TenantSeeder to create sample quotes and requests for new organizations, following the existing seed data pattern (DealProduct, Activity seed data):

    **Quote seed data** (3 sample quotes):
    1. "Website Redesign Proposal" -- Draft status, linked to first seeded company and contact, 3 line items:
       - "UI/UX Design" -- Qty: 1, UnitPrice: 5000, Discount: 0%, Tax: 10%
       - "Frontend Development" -- Qty: 80 (hours), UnitPrice: 150, Discount: 5%, Tax: 10%
       - "QA Testing" -- Qty: 20 (hours), UnitPrice: 100, Discount: 0%, Tax: 10%
       Calculate and store all line-level and quote-level totals using the same calculation logic from research (LineTotal = Qty*UnitPrice, DiscountAmount = LineTotal*DiscountPercent/100, TaxAmount = (LineTotal-DiscountAmount)*TaxPercent/100, NetTotal = LineTotal - DiscountAmount + TaxAmount).
    2. "Annual Support Contract" -- Sent status, linked to second seeded company, 2 line items
    3. "Product Bundle Offer" -- Accepted status, linked to first seeded deal, 2 line items using seeded products

    - QuoteNumber format: "Q-0001", "Q-0002", "Q-0003"
    - Set IssueDate to DateOnly from seed date, ExpiryDate to IssueDate + 30 days
    - Set OwnerId to the admin user
    - Set IsSeedData = true on all quotes and line items
    - Create QuoteStatusHistory entries for non-Draft quotes (Draft->Sent for quote 2, Draft->Sent->Accepted for quote 3)

    **Request seed data** (3 sample requests):
    1. "Login page not loading on mobile" -- Status: New, Priority: High, Category: "Bug", linked to first contact
    2. "Need export to CSV feature" -- Status: InProgress, Priority: Medium, Category: "Feature", linked to first company
    3. "Billing inquiry for Q3" -- Status: Resolved, Priority: Low, Category: "Billing", linked to second contact and company

    - Set OwnerId to admin user, AssignedToId to admin for InProgress/Resolved requests
    - Set ResolvedAt for the Resolved request
    - Set IsSeedData = true on all requests

    Use existing companyMap, contactMap, dealMap patterns to reference seeded entities by index. Build a quoteMap if needed for QuoteStatusHistory references.
  </action>
  <verify>dotnet build -- should compile with 0 errors. TenantSeeder contains Quote and Request seed data creation logic.</verify>
  <done>TenantSeeder creates 3 sample quotes (with 7 total line items and calculated totals) and 3 sample requests. All seed data properly links to existing seeded companies, contacts, and deals. QuoteStatusHistory entries created for non-Draft quotes.</done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with 0 errors
- QuoteRepository.cs and RequestRepository.cs exist in Repositories/ directory
- TenantSeeder references Quote and Request entities
- DependencyInjection.cs registers both repository implementations
</verification>

<success_criteria>
- Repositories implement full CRUD with paged queries matching existing repository conventions
- Quote repository includes line item eager loading with Product navigation
- Request repository supports dual-ownership scope (OwnerId + AssignedToId)
- Seed data creates realistic quotes with calculated line item totals
- Seed data creates requests across different status states
</success_criteria>

<output>
After completion, create `.planning/phases/06-quotes-and-requests/06-02-SUMMARY.md`
</output>
