---
phase: 06-quotes-and-requests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/quotes/quote.models.ts
  - globcrm-web/src/app/features/quotes/quote.service.ts
  - globcrm-web/src/app/features/quotes/quote.store.ts
  - globcrm-web/src/app/features/requests/request.models.ts
  - globcrm-web/src/app/features/requests/request.service.ts
  - globcrm-web/src/app/features/requests/request.store.ts
autonomous: true

must_haves:
  truths:
    - "Quote TypeScript models match all backend DTOs including line items"
    - "QuoteService has methods for all 9 controller endpoints including PDF download"
    - "QuoteStore manages list/detail state with pagination, sorting, and filtering"
    - "Request TypeScript models match all backend DTOs"
    - "RequestService has methods for all 8 controller endpoints"
    - "RequestStore manages list/detail state with pagination and filtering"
  artifacts:
    - path: "globcrm-web/src/app/features/quotes/quote.models.ts"
      provides: "Quote DTOs, line item models, request types, status constants"
      contains: "QuoteListDto"
    - path: "globcrm-web/src/app/features/quotes/quote.service.ts"
      provides: "API service for all quote endpoints including PDF blob download"
      contains: "QuoteService"
    - path: "globcrm-web/src/app/features/quotes/quote.store.ts"
      provides: "NgRx signal store for quote list/detail"
      contains: "QuoteStore"
    - path: "globcrm-web/src/app/features/requests/request.models.ts"
      provides: "Request DTOs, status constants, workflow transitions"
      contains: "RequestListDto"
    - path: "globcrm-web/src/app/features/requests/request.service.ts"
      provides: "API service for all request endpoints"
      contains: "RequestService"
    - path: "globcrm-web/src/app/features/requests/request.store.ts"
      provides: "NgRx signal store for request list/detail"
      contains: "RequestStore"
  key_links:
    - from: "globcrm-web/src/app/features/quotes/quote.service.ts"
      to: "globcrm-web/src/app/core/api/api.service.ts"
      via: "ApiService injection for JSON endpoints"
      pattern: "inject(ApiService)"
    - from: "globcrm-web/src/app/features/quotes/quote.service.ts"
      to: "HttpClient"
      via: "Direct HttpClient for blob PDF download"
      pattern: "inject(HttpClient)"
---

<objective>
Create the complete Angular data layer for both Quotes and Requests: TypeScript models, API services, and NgRx signal stores.

Purpose: Establish the frontend data layer that all Quote and Request UI components will consume. Runs in Wave 1 parallel with backend entity creation.
Output: 6 files (models + service + store for each entity)
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quotes-and-requests/06-RESEARCH.md

# Pattern references
@globcrm-web/src/app/features/deals/deal.models.ts
@globcrm-web/src/app/features/deals/deal.service.ts
@globcrm-web/src/app/features/deals/deal.store.ts
@globcrm-web/src/app/features/activities/activity.models.ts
@globcrm-web/src/app/features/activities/activity.service.ts
@globcrm-web/src/app/features/activities/activity.store.ts
@globcrm-web/src/app/shared/models/query.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quote TypeScript models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/quotes/quote.models.ts
    globcrm-web/src/app/features/quotes/quote.service.ts
    globcrm-web/src/app/features/quotes/quote.store.ts
  </files>
  <action>
    **quote.models.ts** -- follow deal.models.ts pattern:

    Interfaces:
    - QuoteListDto: id, quoteNumber, title, status, grandTotal, contactName?, companyName?, dealTitle?, ownerName?, versionNumber, issueDate, createdAt
    - QuoteDetailDto: extends QuoteListDto + description?, notes?, expiryDate?, lineItems: QuoteLineItemDto[], customFields: Record<string,any>, originalQuoteId?, versions?: QuoteVersionDto[]
    - QuoteLineItemDto: id, productId?, description, sortOrder, quantity, unitPrice, discountPercent, taxPercent, lineTotal, discountAmount, taxAmount, netTotal
    - QuoteVersionDto: id, versionNumber, status, createdAt
    - CreateQuoteRequest: title, description?, dealId?, contactId?, companyId?, issueDate, expiryDate?, notes?, lineItems: CreateQuoteLineItemRequest[], customFields?
    - CreateQuoteLineItemRequest: productId?, description, quantity, unitPrice, discountPercent, taxPercent
    - UpdateQuoteRequest: same as Create
    - UpdateQuoteStatusRequest: status (string)
    - TimelineEntry (reuse from shared/models/query.models.ts if exists, else define)

    Constants:
    - QUOTE_STATUSES: Array of { value, label, color } for Draft (grey), Sent (blue), Accepted (green), Rejected (red), Expired (orange)
    - QUOTE_TRANSITIONS: Record<string, string[]> matching backend QuoteWorkflow

    Helper:
    - calculateLineTotals(item: {quantity, unitPrice, discountPercent, taxPercent}): { lineTotal, discountAmount, taxAmount, netTotal } -- for live preview in form
    - calculateQuoteTotals(items: lineItem[]): { subtotal, discountTotal, taxTotal, grandTotal }

    **quote.service.ts** -- follow deal.service.ts pattern:

    @Injectable({ providedIn: 'root' })
    - Inject ApiService for JSON endpoints, HttpClient for blob
    - basePath = '/quotes'

    Methods (9 matching controller endpoints):
    1. getList(params: EntityQueryParams): Observable<PagedResult<QuoteListDto>>
    2. getById(id: string): Observable<QuoteDetailDto>
    3. create(request: CreateQuoteRequest): Observable<QuoteDetailDto>
    4. update(id: string, request: UpdateQuoteRequest): Observable<QuoteDetailDto>
    5. delete(id: string): Observable<void>
    6. updateStatus(id: string, request: UpdateQuoteStatusRequest): Observable<QuoteDetailDto>
    7. generatePdf(id: string): Observable<Blob> -- use HttpClient directly with responseType: 'blob' (matching ActivityService attachment download pattern)
    8. createNewVersion(id: string): Observable<QuoteDetailDto>
    9. getTimeline(id: string): Observable<TimelineEntry[]>

    **quote.store.ts** -- follow deal.store.ts pattern:

    Component-provided signal store (not root):
    - State: items, selectedItem, loading, error, totalCount, page, pageSize, sortField, sortDirection, filters
    - Methods: loadList, loadById, create, update, delete, updateStatus, setPage, setSort, setFilters, reset
    - Default sort: createdAt desc
    - Follow DealStore ViewFilter-based filter pattern
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile (or have expected errors from missing backend only).</verify>
  <done>Quote data layer complete: models define all DTOs with calculation helpers, service wraps all 9 API endpoints including blob PDF download, store manages reactive list/detail state with pagination/sorting/filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Create Request TypeScript models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/requests/request.models.ts
    globcrm-web/src/app/features/requests/request.service.ts
    globcrm-web/src/app/features/requests/request.store.ts
  </files>
  <action>
    **request.models.ts** -- follow activity.models.ts pattern (simplified):

    Interfaces:
    - RequestListDto: id, subject, status, priority, category?, contactName?, companyName?, ownerName?, assignedToName?, createdAt, resolvedAt?
    - RequestDetailDto: extends RequestListDto + description?, contactId?, companyId?, ownerId?, assignedToId?, closedAt?, customFields: Record<string,any>, allowedTransitions: string[]
    - CreateRequestRequest: subject, description?, priority (string), category?, contactId?, companyId?, assignedToId?, customFields?
    - UpdateRequestRequest: same as Create
    - UpdateRequestStatusRequest: status (string)

    Constants:
    - REQUEST_STATUSES: Array of { value, label, color } for New (blue), InProgress (orange), Resolved (green), Closed (grey)
    - REQUEST_PRIORITIES: Array of { value, label, color } for Low (green), Medium (blue), High (orange), Urgent (red) -- reuse ActivityPriority pattern
    - REQUEST_CATEGORIES: string[] = ['General', 'Bug', 'Feature', 'Support', 'Billing'] -- suggested categories for dropdown
    - ALLOWED_TRANSITIONS: Record<string, string[]> matching backend RequestWorkflow

    **request.service.ts** -- follow activity.service.ts pattern (simplified):

    @Injectable({ providedIn: 'root' })
    - Inject ApiService
    - basePath = '/requests'

    Methods (8 matching controller endpoints):
    1. getList(params: EntityQueryParams): Observable<PagedResult<RequestListDto>>
    2. getById(id: string): Observable<RequestDetailDto>
    3. create(request: CreateRequestRequest): Observable<RequestDetailDto>
    4. update(id: string, request: UpdateRequestRequest): Observable<RequestDetailDto>
    5. delete(id: string): Observable<void>
    6. updateStatus(id: string, request: UpdateRequestStatusRequest): Observable<RequestDetailDto>
    7. getAllowedTransitions(id: string): Observable<string[]>
    8. getTimeline(id: string): Observable<TimelineEntry[]>

    **request.store.ts** -- follow activity.store.ts pattern (simplified):

    Component-provided signal store (not root):
    - State: items, selectedItem, loading, error, totalCount, page, pageSize, sortField, sortDirection, filters
    - Methods: loadList, loadById, create, update, delete, updateStatus, setPage, setSort, setFilters, reset
    - Default sort: createdAt desc
    - Follow ActivityStore ViewFilter-based filter pattern
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile.</verify>
  <done>Request data layer complete: models define all DTOs with status/priority/category constants, service wraps all 8 API endpoints, store manages reactive list/detail state with pagination/sorting/filtering.</done>
</task>

</tasks>

<verification>
- All 6 files created in features/quotes/ and features/requests/
- QuoteService has 9 methods matching controller endpoints
- RequestService has 8 methods matching controller endpoints
- Both stores are component-provided (not root)
- calculateLineTotals and calculateQuoteTotals helpers work correctly
</verification>

<success_criteria>
- TypeScript interfaces match all backend DTOs exactly
- Services cover all API endpoints with correct HTTP methods and return types
- Stores follow DealStore/ActivityStore patterns for component-provided signal stores
- Quote calculation helpers produce correct values for frontend live preview
- PDF download uses HttpClient directly with responseType: 'blob'
</success_criteria>

<output>
After completion, create `.planning/phases/06-quotes-and-requests/06-04-SUMMARY.md`
</output>
