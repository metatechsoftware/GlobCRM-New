---
phase: 06-quotes-and-requests
plan: 06
type: execute
wave: 2
depends_on: ["06-04"]
files_modified:
  - globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
  - globcrm-web/src/app/features/requests/request-list/request-list.component.ts
  - globcrm-web/src/app/features/requests/request-form/request-form.component.ts
autonomous: true

must_haves:
  truths:
    - "Quote detail page shows header info, line items table, totals, and action buttons"
    - "User can download PDF from quote detail page"
    - "User can create new version from quote detail page"
    - "Quote detail shows version history and status with transition buttons"
    - "Request list page displays requests in DynamicTable with adjustable columns"
    - "Request form has fields for subject, priority, category, entity links, and assignment"
  artifacts:
    - path: "globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts"
      provides: "Quote detail page with line items, PDF download, versioning, status"
      contains: "QuoteDetailComponent"
    - path: "globcrm-web/src/app/features/requests/request-list/request-list.component.ts"
      provides: "Request list page with DynamicTable"
      contains: "RequestListComponent"
    - path: "globcrm-web/src/app/features/requests/request-form/request-form.component.ts"
      provides: "Request create/edit form"
      contains: "RequestFormComponent"
  key_links:
    - from: "globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts"
      to: "globcrm-web/src/app/features/quotes/quote.service.ts"
      via: "generatePdf and createNewVersion methods"
      pattern: "quoteService.generatePdf"
    - from: "globcrm-web/src/app/features/requests/request-list/request-list.component.ts"
      to: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      via: "DynamicTable for list rendering"
      pattern: "DynamicTableComponent"
---

<objective>
Build the Quote detail page (with PDF download, versioning, and status management), Request list page, and Request form.

Purpose: Complete the Quote view experience and establish the Request UI for CRUD operations.
Output: Quote detail component, Request list component, Request form component
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-quotes-and-requests/06-RESEARCH.md
@.planning/phases/06-quotes-and-requests/06-04-SUMMARY.md

# Pattern references
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
@globcrm-web/src/app/features/activities/activity-list/activity-list.component.ts
@globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts
@globcrm-web/src/app/features/quotes/quote.models.ts
@globcrm-web/src/app/features/quotes/quote.service.ts
@globcrm-web/src/app/features/requests/request.models.ts
@globcrm-web/src/app/features/requests/request.service.ts
@globcrm-web/src/app/features/requests/request.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quote detail page with PDF download, versioning, and status management</name>
  <files>
    globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
  </files>
  <action>
    Create QuoteDetailComponent using inline template (single .ts file) following DealDetailComponent pattern:

    **Component setup:**
    - Standalone component with inline template and styles
    - Inject QuoteService, ActivatedRoute, Router, MatSnackBar, MatDialog
    - Load quote detail on init from route param :id

    **Template layout:**
    - **Header section:** Quote number + version badge, title, status chip (colored from QUOTE_STATUSES)
    - **Action bar:** Edit button (routerLink to /quotes/:id/edit), Delete button, Generate PDF button, Create New Version button, Status transition buttons (show only allowed transitions based on current status)
    - **Info cards row:** Issue Date, Expiry Date, Grand Total (large bold), Contact (link to /contacts/:id), Company (link to /companies/:id), Deal (link to /deals/:id), Owner

    **Tabs** (mat-tab-group):
    1. **Line Items tab:** Table showing line items with columns: #, Description, Qty, Unit Price, Discount%, Tax%, Line Total, Net Total. Below table: Subtotal, Discount Total, Tax Total, Grand Total summary. Use CSS grid or mat-table for layout.
    2. **Details tab:** Description, Notes, custom fields display
    3. **Versions tab:** List of all versions (if originalQuoteId exists, fetch versions). Each version shows: version number, status, created date, link to that version's detail page.
    4. **Timeline tab:** Status change history from timeline endpoint

    **PDF download behavior:**
    - "Generate PDF" button with loading spinner (pdfGenerating signal)
    - Call quoteService.generatePdf(id) which returns Blob
    - Create temporary <a> element with URL.createObjectURL(blob), set download filename "Quote-{number}-v{version}.pdf", click, revoke URL
    - On error: show snackbar "Failed to generate PDF"
    - Follow the exact pattern from research document

    **Create New Version behavior:**
    - Confirmation dialog: "Create new version from Quote {number} v{version}?"
    - Call quoteService.createNewVersion(id)
    - On success: navigate to new version's detail page, show snackbar "Version {n} created"

    **Status transition behavior:**
    - Show buttons for each allowed transition (e.g., "Mark as Sent", "Accept", "Reject")
    - On click: call quoteService.updateStatus(id, { status: newStatus })
    - On success: reload quote detail, show snackbar

    **Delete behavior:**
    - Confirmation dialog using existing ConfirmDeleteDialogComponent pattern
    - On confirm: call quoteService.delete(id), navigate to /quotes, show snackbar
  </action>
  <verify>File exists at globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts and contains QuoteDetailComponent with generatePdf method.</verify>
  <done>QuoteDetailComponent shows full quote detail with line items table, totals summary, PDF download (blob -> createObjectURL -> download), version management, status transitions, and entity links as navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Create Request list page and Request form</name>
  <files>
    globcrm-web/src/app/features/requests/request-list/request-list.component.ts
    globcrm-web/src/app/features/requests/request-form/request-form.component.ts
  </files>
  <action>
    **RequestListComponent** -- inline template, following ActivityListComponent pattern:

    Component setup:
    - Standalone, providers: [RequestStore]
    - Inject RequestStore, Router, MatSnackBar

    Column definitions:
    - subject (text, "Subject", width 250px)
    - status (text, "Status", width 120px) -- colored badge from REQUEST_STATUSES
    - priority (text, "Priority", width 100px) -- colored from REQUEST_PRIORITIES
    - category (text, "Category", width 120px)
    - contactName (text, "Contact", width 150px)
    - companyName (text, "Company", width 150px)
    - ownerName (text, "Owner", width 130px)
    - assignedToName (text, "Assigned To", width 130px)
    - createdAt (date, "Created", width 120px)
    - resolvedAt (date, "Resolved", width 120px)

    Default visible: subject, status, priority, category, assignedToName, createdAt

    Template:
    - Page header with "Requests" title and "New Request" button
    - DynamicTable with columns, data from store, pagination, sorting
    - FilterPanel for status and priority filters
    - ViewSidebar for saved views (entityType: 'Request')
    - Row click navigates to /requests/:id

    **RequestFormComponent** -- inline template, following ActivityFormComponent pattern:

    Component setup:
    - Standalone, inject RequestService, ActivatedRoute, Router, MatSnackBar, FormBuilder
    - Edit mode: check route param :id, load existing request

    Form structure:
    ```
    requestForm = fb.group({
      subject: ['', [Validators.required, Validators.maxLength(500)]],
      description: [''],
      priority: ['Medium', Validators.required],
      category: [''],
      contactId: [null],
      companyId: [null],
      assignedToId: [null],
    });
    ```

    Template:
    - Mat-card with "Create Request" / "Edit Request" title
    - subject: mat-form-field (required)
    - description: mat-form-field textarea
    - priority: mat-select with options from REQUEST_PRIORITIES
    - category: mat-select with options from REQUEST_CATEGORIES + mat-option for custom text entry (or mat-autocomplete allowing free text)
    - Contact: mat-autocomplete with debounced search (matching contact-form pattern)
    - Company: mat-autocomplete with debounced search
    - Assigned To: mat-select loading team directory (matching deal-form owner pattern via ProfileService.getTeamDirectory)
    - Action buttons: Save, Cancel

    Save behavior:
    - Create: requestService.create(formValue) -> navigate to /requests/:id
    - Update: requestService.update(id, formValue) -> navigate to /requests/:id
    - Error: show snackbar

    provideNativeDateAdapter at component level (if date fields needed).
  </action>
  <verify>Files exist at request-list/request-list.component.ts and request-form/request-form.component.ts. Both contain proper component classes.</verify>
  <done>RequestListComponent renders requests in DynamicTable with 10 columns, status/priority badges, filters, and saved views. RequestFormComponent has form fields for all request properties with priority dropdown, category selection, entity linking via autocomplete, and team member assignment.</done>
</task>

</tasks>

<verification>
- All 3 component files exist
- QuoteDetailComponent has generatePdf method with blob download
- QuoteDetailComponent has createNewVersion method
- RequestListComponent uses DynamicTable with proper columns
- RequestFormComponent has all required form fields
</verification>

<success_criteria>
- Quote detail shows line items in formatted table with totals
- PDF download creates proper file in browser
- New version creation navigates to new version detail
- Status transition buttons show only allowed transitions
- Request list displays all columns with colored status/priority badges
- Request form supports entity linking and team member assignment
</success_criteria>

<output>
After completion, create `.planning/phases/06-quotes-and-requests/06-06-SUMMARY.md`
</output>
