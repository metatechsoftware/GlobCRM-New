---
phase: 27-localization-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/core/i18n/transloco-paginator-intl.ts
  - globcrm-web/src/assets/i18n/en.json
  - globcrm-web/src/assets/i18n/tr.json
autonomous: false
requirements: [LOCL-01, LOCL-04]
gap_closure: true

must_haves:
  truths:
    - "Navbar items (My Day, Companies, Deals, etc.) switch to Turkish when TR is selected"
    - "Sidebar group labels (CRM, Work, Connect, Admin) switch to Turkish when TR is selected"
    - "User menu items (My Profile, Security, Sign Out) switch to Turkish when TR is selected"
    - "Paginator labels (Items per page, Next page, etc.) display in Turkish when language is TR"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      provides: "Reactive nav groups via computed() + TranslocoPipe import"
      contains: "TranslocoPipe"
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      provides: "Transloco pipe bindings for user menu items"
      contains: "transloco"
    - path: "globcrm-web/src/app/core/i18n/transloco-paginator-intl.ts"
      provides: "Async-safe paginator label translation"
      contains: "selectTranslateObject"
    - path: "globcrm-web/src/assets/i18n/en.json"
      provides: "English nav group label keys"
      contains: "nav.groups"
    - path: "globcrm-web/src/assets/i18n/tr.json"
      provides: "Turkish nav group label keys"
      contains: "nav.groups"
  key_links:
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      to: "globcrm-web/src/assets/i18n/en.json"
      via: "translocoService.translate() with nav.* keys"
      pattern: "translate.*nav\\."
    - from: "globcrm-web/src/app/core/i18n/transloco-paginator-intl.ts"
      to: "globcrm-web/src/assets/i18n/en.json"
      via: "selectTranslateObject('common.paginator')"
      pattern: "selectTranslateObject.*common\\.paginator"
---

<objective>
Fix two UAT failures from Phase 27 localization: (1) navbar text staying English on language switch, (2) paginator labels staying English after language switch.

Purpose: Close the two code-level gaps identified in 27-UAT.md so that language switching works end-to-end across the navbar and paginator components.
Output: Fixed navbar and paginator components that reactively update when language changes.

NOTE: The third UAT gap (Tests 7+8 — org language settings 404) is a stale backend binary issue, NOT a code bug. The endpoint exists at OrganizationsController.cs line 240. The user simply needs to restart the backend with `cd src/GlobCRM.Api && dotnet run`. No code change is needed for that gap.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-localization-foundation/27-UAT.md
@.planning/debug/transloco-lang-switch-no-rerender.md
@.planning/debug/paginator-labels-stay-english.md
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/core/i18n/transloco-paginator-intl.ts
@globcrm-web/src/assets/i18n/en.json
@globcrm-web/src/assets/i18n/tr.json
@globcrm-web/src/app/core/i18n/language.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make navbar text reactive to language changes</name>
  <files>
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/assets/i18n/en.json
    globcrm-web/src/assets/i18n/tr.json
  </files>
  <action>
    Three changes are needed. The root cause is diagnosed in `.planning/debug/transloco-lang-switch-no-rerender.md`.

    **1. Add nav group label keys to both translation JSON files.**

    In `en.json`, add a `nav.groups` object (inside the existing `nav` key):
    ```json
    "groups": {
      "crm": "CRM",
      "work": "Work",
      "connect": "Connect",
      "admin": "Admin"
    }
    ```

    In `tr.json`, add the same structure with Turkish translations:
    ```json
    "groups": {
      "crm": "CRM",
      "work": "İş",
      "connect": "Bağlantı",
      "admin": "Yönetim"
    }
    ```

    **2. In `navbar.component.ts`:**

    a) Add imports at the top:
    ```typescript
    import { computed, inject, signal } from '@angular/core';
    import { TranslocoPipe } from '@jsverse/transloco';
    import { TranslocoService } from '@jsverse/transloco';
    ```

    b) Add `TranslocoPipe` to the component's `imports` array (after GlobalSearchComponent).

    c) Inject TranslocoService:
    ```typescript
    private readonly translocoService = inject(TranslocoService);
    ```

    d) Replace the static `readonly navGroups: NavGroup[]` field with a `computed()` signal that rebuilds the array whenever `currentLang()` changes. The `currentLang` signal is already defined on the component (line 57), so use it as a dependency:

    ```typescript
    readonly navGroups = computed(() => {
      // Reading currentLang() makes this reactive to language changes
      const lang = this.currentLang();
      const t = (key: string) => this.translocoService.translate(key);

      return [
        {
          label: '',
          items: [
            { route: '/my-day', icon: 'home', label: t('nav.myDay') },
            { route: '/analytics', icon: 'grid_view', label: t('nav.analytics') },
            { route: '/reports', icon: 'bar_chart', label: t('nav.reports') },
          ]
        },
        {
          label: t('nav.groups.crm'),
          items: [
            { route: '/companies', icon: 'business', label: t('nav.companies') },
            { route: '/contacts', icon: 'people', label: t('nav.contacts') },
            { route: '/leads', icon: 'person_search', label: t('nav.leads') },
            { route: '/products', icon: 'inventory_2', label: t('nav.products') },
            { route: '/deals', icon: 'handshake', label: t('nav.deals') },
          ]
        },
        {
          label: t('nav.groups.work'),
          items: [
            { route: '/activities', icon: 'task_alt', label: t('nav.activities') },
            { route: '/quotes', icon: 'request_quote', label: t('nav.quotes') },
            { route: '/requests', icon: 'support_agent', label: t('nav.requests') },
            { route: '/notes', icon: 'note', label: t('nav.notes') },
          ]
        },
        {
          label: t('nav.groups.connect'),
          items: [
            { route: '/emails', icon: 'email', label: t('nav.emails') },
            { route: '/email-templates', icon: 'drafts', label: t('nav.templates') },
            { route: '/sequences', icon: 'schedule_send', label: t('nav.sequences') },
            { route: '/workflows', icon: 'account_tree', label: t('nav.workflows') },
            { route: '/feed', icon: 'dynamic_feed', label: t('nav.feed') },
            { route: '/calendar', icon: 'calendar_month', label: t('nav.calendar') },
          ]
        },
        {
          label: t('nav.groups.admin'),
          items: [
            { route: '/duplicates', icon: 'compare_arrows', label: t('nav.duplicates') },
            { route: '/import', icon: 'upload_file', label: t('nav.import') },
            { route: '/team-directory', icon: 'groups', label: t('nav.team') },
            { route: '/settings', icon: 'settings', label: t('nav.settings') },
          ]
        },
      ];
    });
    ```

    Note: `navGroups` changes from a plain array to a `Signal<NavGroup[]>`. In the template, it's already used as `navGroups` (not `navGroups()`). Since it's now a signal, the template references MUST be updated to `navGroups()` — this is critical.

    **3. In `navbar.component.html`:**

    a) Replace ALL occurrences of `navGroups` with `navGroups()` since it's now a signal (there are 2 occurrences: line 23 desktop and line 115 mobile).

    b) Replace hardcoded user menu strings with transloco pipe bindings:
    - `<span>My Profile</span>` → `<span>{{ 'userMenu.myProfile' | transloco }}</span>`
    - `<span>Security</span>` → `<span>{{ 'userMenu.security' | transloco }}</span>`
    - `<span class="sidebar-user-menu__lang-label">{{ currentLang() === 'tr' ? 'Dil' : 'Language' }}</span>` → `<span class="sidebar-user-menu__lang-label">{{ 'userMenu.language' | transloco }}</span>`
    - `<span>Sign Out</span>` → `<span>{{ 'userMenu.signOut' | transloco }}</span>`
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build must succeed with no errors.
    Verify TranslocoPipe is in the imports array of NavbarComponent.
    Verify navGroups is a computed() signal.
    Verify all 4 user menu strings use the transloco pipe.
    Verify both en.json and tr.json have nav.groups keys.
  </verify>
  <done>
    NavbarComponent builds successfully. navGroups is a computed signal reactive to currentLang(). TranslocoPipe is imported. All user menu items use transloco pipe bindings. Both EN and TR JSON files contain nav.groups.crm, nav.groups.work, nav.groups.connect, nav.groups.admin keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix paginator race condition with selectTranslateObject</name>
  <files>globcrm-web/src/app/core/i18n/transloco-paginator-intl.ts</files>
  <action>
    The root cause is diagnosed in `.planning/debug/paginator-labels-stay-english.md`. The fix is to replace `langChanges$` (fires synchronously before translation HTTP load) with `selectTranslateObject('common.paginator')` (waits for translation file to load before emitting).

    Rewrite `transloco-paginator-intl.ts`:

    ```typescript
    import { Injectable, inject, DestroyRef } from '@angular/core';
    import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
    import { MatPaginatorIntl } from '@angular/material/paginator';
    import { TranslocoService } from '@jsverse/transloco';

    /**
     * Custom MatPaginatorIntl that reactively updates paginator labels
     * when the active Transloco language changes.
     *
     * Uses selectTranslateObject() which waits for the translation file
     * to be loaded before emitting, avoiding the race condition where
     * langChanges$ fires before HTTP translation fetch completes.
     */
    @Injectable()
    export class TranslatedPaginatorIntl extends MatPaginatorIntl {
      private readonly translocoService = inject(TranslocoService);
      private readonly destroyRef = inject(DestroyRef);

      constructor() {
        super();

        this.translocoService.selectTranslateObject('common.paginator')
          .pipe(takeUntilDestroyed(this.destroyRef))
          .subscribe((labels: Record<string, string>) => {
            this.itemsPerPageLabel = labels['itemsPerPage'] || 'Items per page';
            this.nextPageLabel = labels['nextPage'] || 'Next page';
            this.previousPageLabel = labels['previousPage'] || 'Previous page';
            this.firstPageLabel = labels['firstPage'] || 'First page';
            this.lastPageLabel = labels['lastPage'] || 'Last page';

            const ofLabel = labels['of'] || 'of';
            this.getRangeLabel = (page: number, pageSize: number, length: number) => {
              if (length === 0 || pageSize === 0) {
                return `0 ${ofLabel} ${length}`;
              }
              const startIndex = page * pageSize;
              const endIndex = Math.min(startIndex + pageSize, length);
              return `${startIndex + 1} \u2013 ${endIndex} ${ofLabel} ${length}`;
            };

            this.changes.next();
          });
      }
    }
    ```

    Key differences from the original:
    1. Uses `selectTranslateObject('common.paginator')` instead of `langChanges$` — this observable waits for the translation JSON to be loaded into memory before emitting.
    2. Receives the pre-translated labels object directly instead of calling `translate()` synchronously.
    3. Each label has a fallback default in case the key is missing.
    4. `selectTranslateObject` re-emits on every language change (after the new file loads), so labels update correctly on switch.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build must succeed.
    Verify the file uses `selectTranslateObject` and does NOT use `langChanges$`.
  </verify>
  <done>
    TranslatedPaginatorIntl uses selectTranslateObject('common.paginator') instead of langChanges$. The race condition is eliminated. Labels will update only after translation files are loaded.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify language switching works for navbar and paginator</name>
  <files></files>
  <action>
    Human verification of the two gap closure fixes. Present these verification steps to the user:

    Fixed two UAT failures:
    1. Navbar text (nav items + user menu) now reactively translates when switching languages via the EN/TR toggle
    2. Paginator labels now correctly translate by waiting for translation file load

    NOTE: For UAT tests 7+8 (org language settings 404), restart the backend: `cd src/GlobCRM.Api && dotnet run`. The endpoint exists in code — the running binary was stale.

    Verification steps:
    1. Start the frontend: `cd globcrm-web && npm start`
    2. Restart the backend (if not done): `cd src/GlobCRM.Api && dotnet run`
    3. Open http://localhost:4200 and log in
    4. Click the user avatar/name in the top-right to open the user menu
    5. Click "TR" on the language toggle
    6. Verify: All sidebar nav items change to Turkish (e.g., "My Day" becomes "Gunum", "Companies" becomes "Sirketler")
    7. Verify: Sidebar group labels change (e.g., "Work" becomes "Is", "Admin" becomes "Yonetim")
    8. Verify: User menu items change ("My Profile" becomes "Profilim", "Sign Out" becomes "Cikis Yap")
    9. Navigate to any list page with a paginator (e.g., Contacts)
    10. Verify: Paginator shows Turkish labels ("Sayfa basina oge" instead of "Items per page")
    11. Switch back to "EN" and verify everything reverts to English
    12. (Optional) Test org language settings: Settings > Organization > Language — should no longer 404 after backend restart
  </action>
  <verify>User confirms all verification steps pass</verify>
  <done>User types "approved" confirming language switching works correctly for navbar and paginator</done>
</task>

</tasks>

<verification>
- `cd globcrm-web && npx ng build --configuration=development` passes with no errors
- NavbarComponent imports TranslocoPipe
- navGroups is a computed() signal using translocoService.translate()
- User menu items use {{ 'key' | transloco }} bindings
- TranslatedPaginatorIntl uses selectTranslateObject (not langChanges$)
- Both en.json and tr.json have nav.groups keys
</verification>

<success_criteria>
- Switching to TR causes all navbar items, group labels, and user menu items to display in Turkish
- Switching to EN reverts all text to English
- Paginator labels on list pages display in Turkish when language is set to TR
- No build errors or runtime console errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-localization-foundation/27-06-SUMMARY.md`
</output>
