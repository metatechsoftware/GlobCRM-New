---
phase: 27-localization-foundation
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/shared/components/navbar/navbar.component.scss
  - globcrm-web/src/app/core/i18n/language.service.ts
autonomous: true
requirements:
  - LOCL-01
  - LOCL-02

must_haves:
  truths:
    - "User can click a language toggle (EN/TR) inside the user profile dropdown menu and the UI switches instantly without page reload"
    - "A small EN or TR text badge is visible near the user avatar without opening the menu"
    - "User's language preference persists across browser sessions via backend profile + localStorage cache"
    - "Login page uses localStorage cache for returning users; new users get browser-detected language"
    - "HTML lang attribute updates to 'en' or 'tr' on language switch for screen readers"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      provides: "Language toggle UI in user menu + lang badge near avatar"
      contains: "switchLanguage"
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      provides: "Language switching logic connected to LanguageService"
      contains: "LanguageService"
  key_links:
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      to: "globcrm-web/src/app/core/i18n/language.service.ts"
      via: "inject LanguageService, call switchLanguage()"
      pattern: "languageService\\.switchLanguage"
    - from: "globcrm-web/src/app/core/i18n/language.service.ts"
      to: "globcrm-web/src/app/features/profile/profile.service.ts"
      via: "updatePreferences({ language }) fire-and-forget"
      pattern: "updatePreferences"
---

<objective>
Build the language switcher UI in the navbar user dropdown menu and wire it to LanguageService for instant language switching with backend persistence.

Purpose: Give users the ability to switch between English and Turkish at runtime (LOCL-01) with preference persistence across sessions (LOCL-02).
Output: Working language toggle in user menu, visible lang badge, and full persistence chain (Transloco → localStorage → backend profile).
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-localization-foundation/27-RESEARCH.md
@.planning/phases/27-localization-foundation/27-01-SUMMARY.md
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/shared/components/navbar/navbar.component.scss
@globcrm-web/src/app/core/i18n/language.service.ts
@globcrm-web/src/app/features/profile/profile.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend persistence to LanguageService and wire profile sync on login</name>
  <files>
    globcrm-web/src/app/core/i18n/language.service.ts
  </files>
  <action>
    Update LanguageService (created in Plan 01) to add backend persistence:

    1. Inject `ProfileService` from `../../features/profile/profile.service`
    2. Update `switchLanguage(lang)` to also call `this.profileService.updatePreferences({ language: lang }).subscribe()` as fire-and-forget (inside try/catch or with empty error handler so it never blocks the UI)
    3. Add `syncFromProfile(profileLanguage: string | null | undefined)` method:
       - If profileLanguage is 'en' or 'tr', call `switchLanguage(profileLanguage)` — this syncs backend source of truth to local state
       - This should be called after login when the user profile is loaded, so the backend language overrides any stale localStorage value
    4. The persistence chain is:
       - On switch: Transloco → localStorage → backend (fire-and-forget)
       - On login: backend → localStorage → Transloco (via syncFromProfile)
       - On first visit (no login): localStorage → browser detection → Transloco (via initLanguage)
  </action>
  <verify>
    - `grep "ProfileService" src/app/core/i18n/language.service.ts` shows injection
    - `grep "updatePreferences" src/app/core/i18n/language.service.ts` shows backend persistence call
    - `grep "syncFromProfile" src/app/core/i18n/language.service.ts` shows the method exists
  </verify>
  <done>LanguageService persists language changes to backend profile (fire-and-forget), provides syncFromProfile() for post-login sync, and the full persistence chain (Transloco ↔ localStorage ↔ backend) is wired</done>
</task>

<task type="auto">
  <name>Task 2: Build language switcher toggle in navbar user menu with lang badge</name>
  <files>
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/shared/components/navbar/navbar.component.scss
  </files>
  <action>
    1. Update `navbar.component.ts`:
       - Inject `LanguageService` from `../../../core/i18n/language.service`
       - Expose `readonly currentLang = this.languageService.currentLang` (the signal from LanguageService)
       - Add `switchLanguage(lang: 'en' | 'tr')` method that calls `this.languageService.switchLanguage(lang)`

    2. Update `navbar.component.html`:
       **Desktop — Content Header (near the user menu trigger button):**
       - Add a small language badge `<span class="content-header__lang-badge">{{ currentLang() | uppercase }}</span>` placed BEFORE the user trigger button (after the notification center). This shows "EN" or "TR" without opening the menu.

       **Shared User Menu (mat-menu #userMenu):**
       - Between the "Security" button and the mat-divider before "Sign Out", insert:
         ```html
         <mat-divider></mat-divider>
         <div class="sidebar-user-menu__lang-toggle" (click)="$event.stopPropagation()">
           <mat-icon>language</mat-icon>
           <span class="sidebar-user-menu__lang-label">{{ currentLang() === 'tr' ? 'Dil' : 'Language' }}</span>
           <div class="lang-segmented">
             <button class="lang-segmented__btn"
                     [class.lang-segmented__btn--active]="currentLang() === 'en'"
                     (click)="switchLanguage('en')">EN</button>
             <button class="lang-segmented__btn"
                     [class.lang-segmented__btn--active]="currentLang() === 'tr'"
                     (click)="switchLanguage('tr')">TR</button>
           </div>
         </div>
         ```
       - The `(click)="$event.stopPropagation()"` on the container prevents the menu from closing when clicking the toggle
       - The label text self-translates (shows "Dil" in Turkish, "Language" in English) without needing Transloco — keeps the toggle working even before translations load

       **Mobile — Top Bar:**
       - Add a small language badge `<span class="topbar__lang-badge">{{ currentLang() | uppercase }}</span>` near the avatar button

    3. Update `navbar.component.scss`:
       - Style `.content-header__lang-badge`: small pill badge (font-size: 11px, font-weight: 700, padding: 2px 6px, border-radius: 4px, background: var(--color-surface-hover), color: var(--color-text-secondary), margin-right: 4px, letter-spacing: 0.05em)
       - Style `.sidebar-user-menu__lang-toggle`: flexbox row (display: flex, align-items: center, gap: 12px, padding: 10px 16px)
       - Style `.sidebar-user-menu__lang-label`: flex: 1, font-size: 14px
       - Style `.lang-segmented`: display: flex, border: 1.5px solid var(--color-border), border-radius: 8px, overflow: hidden
       - Style `.lang-segmented__btn`: padding: 4px 12px, font-size: 12px, font-weight: 600, border: none, background: transparent, cursor: pointer, color: var(--color-text-secondary), transition: background 0.15s, color 0.15s
       - Style `.lang-segmented__btn--active`: background: var(--color-primary), color: white
       - Style `.topbar__lang-badge`: same as content-header__lang-badge but adjust for mobile context
  </action>
  <verify>
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` builds without errors
    - `grep "lang-segmented" src/app/shared/components/navbar/navbar.component.html` shows toggle markup
    - `grep "lang-badge" src/app/shared/components/navbar/navbar.component.html` shows badge markup
    - `grep "LanguageService" src/app/shared/components/navbar/navbar.component.ts` shows injection
  </verify>
  <done>Language toggle with EN/TR segmented control appears in user dropdown menu (per locked decision), small lang badge visible near avatar on desktop and mobile, switching is instant without confirmation dialog, menu stays open when toggling</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` completes without errors
2. Language toggle visible in the user dropdown menu between Security and Sign Out
3. EN/TR badge visible near user avatar without opening menu
4. Clicking EN/TR toggle switches Transloco active language (observable via console log from missingHandler)
5. Language preference saved to localStorage as 'globcrm_language'
6. Backend profile preferences updated on language switch (fire-and-forget)
7. HTML lang attribute updates on switch (check document.documentElement.lang)
</verification>

<success_criteria>
- User can open profile dropdown → see EN/TR toggle → click to switch instantly (LOCL-01)
- Language preference persists in localStorage and backend profile (LOCL-02)
- EN/TR badge visible at a glance near avatar without opening menu (locked decision)
- Toggle is inside the user menu, not standalone in navbar (locked decision)
- No confirmation dialog on switch (locked decision)
- HTML lang attribute updates for accessibility (locked decision)
</success_criteria>

<output>
After completion, create `.planning/phases/27-localization-foundation/27-02-SUMMARY.md`
</output>
