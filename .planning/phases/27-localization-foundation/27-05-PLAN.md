---
phase: 27-localization-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/core/auth/auth.service.ts
autonomous: true
gap_closure: true
requirements:
  - LOCL-02
  - LOCL-07

must_haves:
  truths:
    - "After login, the user's backend language preference is restored (not just localStorage)"
    - "A user who switches to Turkish, logs out, clears localStorage, and logs back in sees the UI in Turkish"
    - "A new user with no personal language preference inherits the organization's default language on first login"
  artifacts:
    - path: "globcrm-web/src/app/core/auth/auth.service.ts"
      provides: "LanguageService injection and syncFromProfile() call after login"
      contains: "languageService"
  key_links:
    - from: "globcrm-web/src/app/core/auth/auth.service.ts"
      to: "globcrm-web/src/app/core/i18n/language.service.ts"
      via: "inject(LanguageService) and call syncFromProfile() inside handleLoginSuccess()"
      pattern: "languageService\\.syncFromProfile"
    - from: "globcrm-web/src/app/core/auth/auth.service.ts"
      to: "globcrm-web/src/app/features/profile/profile.service.ts"
      via: "profileService.getPreferences() to fetch the user's saved language after login"
      pattern: "profileService\\.getPreferences"
---

<objective>
Wire the missing `syncFromProfile()` call into the auth login flow so the user's backend language preference is restored after login and new users inherit the organization's default language.

Purpose: Close the one remaining gap from Phase 27 verification — the persistence read path is broken because `LanguageService.syncFromProfile()` is never called. The write path (saving language to backend on switch) works, but the read path (restoring from backend on login) does not.
Output: `AuthService.handleLoginSuccess()` fetches the user's saved language preference from the profile API and calls `languageService.syncFromProfile()` to restore it.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-localization-foundation/27-VERIFICATION.md
@.planning/phases/27-localization-foundation/27-02-SUMMARY.md
@.planning/phases/27-localization-foundation/27-04-SUMMARY.md
@globcrm-web/src/app/core/auth/auth.service.ts
@globcrm-web/src/app/core/i18n/language.service.ts
@globcrm-web/src/app/features/profile/profile.service.ts
@globcrm-web/src/app/core/auth/auth.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire syncFromProfile into AuthService login flow</name>
  <files>globcrm-web/src/app/core/auth/auth.service.ts</files>
  <action>
    Inject `LanguageService` and `ProfileService` into `AuthService`, then call `syncFromProfile()` after successful login/refresh to restore the user's backend language preference.

    1. Add imports at the top of `auth.service.ts`:
       ```typescript
       import { LanguageService } from '../i18n/language.service';
       import { ProfileService } from '../../features/profile/profile.service';
       ```

    2. Add injections inside the `AuthService` class (after the existing `private readonly router = inject(Router);` line):
       ```typescript
       private readonly languageService = inject(LanguageService);
       private readonly profileService = inject(ProfileService);
       ```

    3. At the end of the `handleLoginSuccess()` method (after the `this.permissionStore.loadPermissions();` line), add the language sync call:
       ```typescript
       // Restore user's language preference from backend profile (LOCL-02/LOCL-07).
       // Fire-and-forget: fetch preferences, then pass language to syncFromProfile().
       // syncFromProfile handles the resolution chain: user preference > org default > browser detection.
       try {
         this.profileService.getPreferences().subscribe({
           next: (prefs) => {
             this.languageService.syncFromProfile(prefs?.language);
           },
           error: () => {
             // If preferences fetch fails, syncFromProfile with null triggers org default fallback
             this.languageService.syncFromProfile(null);
           },
         });
       } catch {
         // Guard against injection errors during early bootstrap
       }
       ```

    Key design points:
    - This is fire-and-forget — language sync does NOT block login navigation or UI rendering
    - On successful preference fetch: passes the saved language to `syncFromProfile()`, which applies it directly
    - On preference fetch failure: passes `null`, which triggers `syncFromProfile()`'s org default language fallback (API call to `/api/organizations/default-language`), then browser detection, then 'en'
    - The try/catch guards against injection errors if this runs during very early bootstrap before all providers are ready
    - This call fires on EVERY login and token refresh (via `handleLoginSuccess`), which is correct — it ensures backend is always the source of truth, overriding any stale localStorage value
    - Do NOT call `syncFromProfile()` during scheduled token refreshes — it would be disruptive to switch language mid-session. Add a parameter to `handleLoginSuccess` to control this, or add an `isInitialLogin` flag to skip language sync on auto-refresh.

    IMPORTANT refinement — avoid syncing language on automatic token refresh:
    The `handleLoginSuccess()` method is called both on user-initiated login AND on automatic token refresh (every ~24 minutes). Syncing language on auto-refresh would be wasteful and potentially disruptive. To fix this:

    4. Add a `syncLanguage` boolean parameter to `handleLoginSuccess()`:
       ```typescript
       private handleLoginSuccess(response: LoginResponse, rememberMe: boolean, syncLanguage = true): void {
       ```

    5. Wrap the language sync block in a condition:
       ```typescript
       if (syncLanguage) {
         // Restore user's language preference from backend profile (LOCL-02/LOCL-07).
         // ... (the sync code from step 3)
       }
       ```

    6. In the `scheduleTokenRefresh` method, pass `syncLanguage: false` for the auto-refresh call:
       ```typescript
       this.handleLoginSuccess(response, shouldRemember, false);
       ```

    7. All existing calls to `handleLoginSuccess()` already pass only 2 args, so they default to `syncLanguage = true` (correct — login, createOrganization, joinOrganization, and initializeAuth all represent user-initiated auth events where language sync is appropriate).
  </action>
  <verify>
    - `grep "languageService" globcrm-web/src/app/core/auth/auth.service.ts` shows LanguageService injection
    - `grep "syncFromProfile" globcrm-web/src/app/core/auth/auth.service.ts` shows the call inside handleLoginSuccess
    - `grep "profileService.getPreferences" globcrm-web/src/app/core/auth/auth.service.ts` shows the preferences fetch
    - `grep "syncLanguage" globcrm-web/src/app/core/auth/auth.service.ts` shows the parameter to skip sync on auto-refresh
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` builds without errors
  </verify>
  <done>AuthService.handleLoginSuccess() injects LanguageService and ProfileService, fetches user preferences after login, and calls syncFromProfile(prefs.language) to restore the backend language preference. Auto token refreshes skip language sync. The full persistence chain is now wired: save (switchLanguage -> updatePreferences) and restore (handleLoginSuccess -> getPreferences -> syncFromProfile).</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` completes without errors
2. `grep -c "syncFromProfile" globcrm-web/src/app/core/auth/auth.service.ts` returns at least 1
3. `grep -c "languageService" globcrm-web/src/app/core/auth/auth.service.ts` returns at least 2 (injection + usage)
4. `grep -c "syncLanguage" globcrm-web/src/app/core/auth/auth.service.ts` returns at least 2 (parameter + usage)
5. No other files modified — this is a surgical one-file fix
</verification>

<success_criteria>
- LanguageService.syncFromProfile() is called from AuthService.handleLoginSuccess() after every user-initiated login
- User's backend language preference is fetched via ProfileService.getPreferences() and passed to syncFromProfile()
- When preferences fetch fails or language is null, syncFromProfile falls back to org default then browser detection (existing behavior in language.service.ts)
- Language sync does NOT fire on automatic token refresh (would be wasteful/disruptive)
- Angular build passes with no errors
- LOCL-02 persistence read path: COMPLETE (backend preference restored on login)
- LOCL-07 new user inheritance: COMPLETE (syncFromProfile's org default fallback is now reachable)
</success_criteria>

<output>
After completion, create `.planning/phases/27-localization-foundation/27-05-SUMMARY.md`
</output>
