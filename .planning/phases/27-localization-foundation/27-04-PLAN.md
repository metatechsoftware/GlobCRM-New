---
phase: 27-localization-foundation
plan: 04
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - globcrm-web/src/app/features/contacts/contacts.routes.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/assets/i18n/contacts/en.json
  - globcrm-web/src/assets/i18n/contacts/tr.json
  - globcrm-web/src/assets/i18n/settings/en.json
  - globcrm-web/src/assets/i18n/settings/tr.json
  - src/GlobCRM.Domain/Entities/Organization.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
  - src/GlobCRM.Api/Controllers/OrganizationsController.cs
  - src/GlobCRM.Application/Organizations/OrganizationDto.cs
  - globcrm-web/src/app/features/settings/settings-hub.component.ts
  - globcrm-web/src/app/core/i18n/language.service.ts
autonomous: true
requirements:
  - LOCL-05
  - LOCL-07

must_haves:
  truths:
    - "Navigating to contacts page lazy-loads only the contacts translation scope (contacts/en.json or contacts/tr.json)"
    - "Translation files for unvisited features are NOT loaded (verifiable in network tab)"
    - "Admin can set a default language for the organization in settings"
    - "Organization default language is persisted to the database"
    - "Settings hub has a Language card in the Organization section"
    - "New users with no personal language preference inherit the organization's default language on first login"
  artifacts:
    - path: "globcrm-web/src/assets/i18n/contacts/en.json"
      provides: "Contacts feature English translations"
      contains: "list"
    - path: "globcrm-web/src/assets/i18n/contacts/tr.json"
      provides: "Contacts feature Turkish translations"
      contains: "list"
    - path: "globcrm-web/src/assets/i18n/settings/en.json"
      provides: "Settings feature English translations"
      contains: "language"
    - path: "globcrm-web/src/assets/i18n/settings/tr.json"
      provides: "Settings feature Turkish translations"
      contains: "language"
    - path: "src/GlobCRM.Domain/Entities/Organization.cs"
      provides: "DefaultLanguage property on Organization entity"
      contains: "DefaultLanguage"
  key_links:
    - from: "globcrm-web/src/app/features/contacts/contacts.routes.ts"
      to: "globcrm-web/src/assets/i18n/contacts/"
      via: "provideTranslocoScope('contacts')"
      pattern: "provideTranslocoScope"
    - from: "globcrm-web/src/app/features/settings/settings.routes.ts"
      to: "globcrm-web/src/assets/i18n/settings/"
      via: "provideTranslocoScope('settings')"
      pattern: "provideTranslocoScope"
    - from: "src/GlobCRM.Api/Controllers/OrganizationsController.cs"
      to: "src/GlobCRM.Domain/Entities/Organization.cs"
      via: "GET/PUT default language endpoint"
      pattern: "DefaultLanguage"
    - from: "globcrm-web/src/app/core/i18n/language.service.ts"
      to: "globcrm-web/src/app/core/tenant/tenant.store.ts"
      via: "syncFromProfile() falls back to org default language"
      pattern: "tenantStore.*defaultLanguage"
---

<objective>
Implement scoped lazy-loading of translation files per feature route (contacts + settings as proof) and add Organization default language support on the backend with a settings UI card.

Purpose: Prove the per-feature translation lazy-loading pattern (LOCL-05) and enable admins to set an org-wide default language (LOCL-07).
Output: Contacts and settings scopes with lazy-loaded translations, Organization.DefaultLanguage in database, settings hub language card.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-localization-foundation/27-RESEARCH.md
@.planning/phases/27-localization-foundation/27-01-SUMMARY.md
@.planning/phases/27-localization-foundation/27-02-SUMMARY.md
@globcrm-web/src/app/core/i18n/language.service.ts
@globcrm-web/src/app/core/tenant/tenant.store.ts
@globcrm-web/src/app/features/contacts/contacts.routes.ts
@globcrm-web/src/app/features/settings/settings.routes.ts
@globcrm-web/src/app/features/settings/settings-hub.component.ts
@src/GlobCRM.Domain/Entities/Organization.cs
@src/GlobCRM.Api/Controllers/OrganizationsController.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
@src/GlobCRM.Application/Organizations/OrganizationDto.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scoped translation files and configure lazy-loading in feature routes</name>
  <files>
    globcrm-web/src/app/features/contacts/contacts.routes.ts
    globcrm-web/src/app/features/settings/settings.routes.ts
    globcrm-web/src/assets/i18n/contacts/en.json
    globcrm-web/src/assets/i18n/contacts/tr.json
    globcrm-web/src/assets/i18n/settings/en.json
    globcrm-web/src/assets/i18n/settings/tr.json
  </files>
  <action>
    1. Create `globcrm-web/src/assets/i18n/contacts/en.json` — contacts feature English translations:
       ```json
       {
         "title": "Contacts",
         "list": {
           "title": "Contacts",
           "addContact": "Add Contact",
           "importContacts": "Import Contacts",
           "empty": "No contacts found",
           "emptyDescription": "Create your first contact to get started"
         },
         "detail": {
           "title": "Contact Details",
           "tabs": {
             "summary": "Summary",
             "timeline": "Timeline",
             "activities": "Activities",
             "deals": "Deals",
             "emails": "Emails",
             "notes": "Notes",
             "attachments": "Attachments"
           },
           "fields": {
             "firstName": "First Name",
             "lastName": "Last Name",
             "email": "Email",
             "phone": "Phone",
             "mobile": "Mobile",
             "company": "Company",
             "jobTitle": "Job Title",
             "department": "Department",
             "address": "Address",
             "city": "City",
             "state": "State",
             "country": "Country",
             "zipCode": "Zip Code",
             "source": "Source",
             "owner": "Owner",
             "tags": "Tags",
             "description": "Description",
             "createdAt": "Created",
             "updatedAt": "Last Updated"
           }
         },
         "form": {
           "createTitle": "Create Contact",
           "editTitle": "Edit Contact",
           "saveSuccess": "Contact saved successfully",
           "deleteConfirm": "Are you sure you want to delete this contact?",
           "deleteSuccess": "Contact deleted successfully"
         }
       }
       ```

    2. Create `globcrm-web/src/assets/i18n/contacts/tr.json` — Turkish translations for contacts:
       ```json
       {
         "title": "Kişiler",
         "list": {
           "title": "Kişiler",
           "addContact": "Kişi Ekle",
           "importContacts": "Kişileri İçe Aktar",
           "empty": "Kişi bulunamadı",
           "emptyDescription": "Başlamak için ilk kişinizi oluşturun"
         },
         "detail": {
           "title": "Kişi Detayları",
           "tabs": {
             "summary": "Özet",
             "timeline": "Zaman Çizelgesi",
             "activities": "Aktiviteler",
             "deals": "Fırsatlar",
             "emails": "E-postalar",
             "notes": "Notlar",
             "attachments": "Ekler"
           },
           "fields": {
             "firstName": "Ad",
             "lastName": "Soyad",
             "email": "E-posta",
             "phone": "Telefon",
             "mobile": "Cep Telefonu",
             "company": "Şirket",
             "jobTitle": "Unvan",
             "department": "Departman",
             "address": "Adres",
             "city": "Şehir",
             "state": "İl",
             "country": "Ülke",
             "zipCode": "Posta Kodu",
             "source": "Kaynak",
             "owner": "Sahip",
             "tags": "Etiketler",
             "description": "Açıklama",
             "createdAt": "Oluşturulma",
             "updatedAt": "Son Güncelleme"
           }
         },
         "form": {
           "createTitle": "Kişi Oluştur",
           "editTitle": "Kişi Düzenle",
           "saveSuccess": "Kişi başarıyla kaydedildi",
           "deleteConfirm": "Bu kişiyi silmek istediğinizden emin misiniz?",
           "deleteSuccess": "Kişi başarıyla silindi"
         }
       }
       ```

    3. Create `globcrm-web/src/assets/i18n/settings/en.json` — settings feature English translations:
       ```json
       {
         "title": "Settings",
         "subtitle": "Configure your workspace, permissions, and integrations",
         "search": "Search settings...",
         "noResults": "No settings match",
         "clearSearch": "Clear search",
         "sections": {
           "organization": "Organization",
           "dataOperations": "Data Operations",
           "personal": "Personal"
         },
         "language": {
           "title": "Language",
           "description": "Set the default language for your organization",
           "defaultLanguage": "Default Language",
           "defaultLanguageHint": "New users will inherit this language preference",
           "english": "English",
           "turkish": "Turkish",
           "saveSuccess": "Default language updated successfully"
         },
         "items": {
           "roles": "Roles & Permissions",
           "rolesDesc": "Define user roles, access levels, and field visibility rules",
           "teams": "Teams",
           "teamsDesc": "Create teams and assign members for collaborative workflows",
           "customFields": "Custom Fields",
           "customFieldsDesc": "Add and manage custom data fields across all entities",
           "pipelines": "Pipelines",
           "pipelinesDesc": "Design deal pipeline stages and win/loss workflows",
           "duplicateDetection": "Duplicate Detection",
           "duplicateDetectionDesc": "Configure matching rules, thresholds, and merge strategies",
           "webhooks": "Webhooks",
           "webhooksDesc": "Manage event subscriptions for external integrations",
           "importData": "Import Data",
           "importDataDesc": "Import contacts, companies, or deals from CSV files",
           "importHistory": "Import History",
           "importHistoryDesc": "Review past import jobs, results, and error logs",
           "emailAccounts": "Email Accounts",
           "emailAccountsDesc": "Connect email accounts for sending and tracking messages",
           "notifications": "Notifications",
           "notificationsDesc": "Customize which events trigger alerts and how they are delivered"
         }
       }
       ```

    4. Create `globcrm-web/src/assets/i18n/settings/tr.json` — Turkish translations for settings (matching all keys from en.json).

    5. Update `globcrm-web/src/app/features/contacts/contacts.routes.ts`:
       - Import `provideTranslocoScope` from `@jsverse/transloco`
       - Wrap existing routes in a parent route with `providers: [provideTranslocoScope('contacts')]`:
         ```typescript
         export const CONTACT_ROUTES: Routes = [
           {
             path: '',
             providers: [provideTranslocoScope('contacts')],
             children: [
               { path: '', component: ContactListComponent },
               { path: 'new', loadComponent: () => ... },
               { path: ':id', loadComponent: () => ... },
               { path: ':id/edit', loadComponent: () => ... },
             ],
           },
         ];
         ```

    6. Update `globcrm-web/src/app/features/settings/settings.routes.ts`:
       - Import `provideTranslocoScope` from `@jsverse/transloco`
       - Add `provideTranslocoScope('settings')` to the root settings route providers
  </action>
  <verify>
    - `ls globcrm-web/src/assets/i18n/contacts/en.json globcrm-web/src/assets/i18n/contacts/tr.json` both exist
    - `ls globcrm-web/src/assets/i18n/settings/en.json globcrm-web/src/assets/i18n/settings/tr.json` both exist
    - `grep "provideTranslocoScope" globcrm-web/src/app/features/contacts/contacts.routes.ts` shows scope configuration
    - `grep "provideTranslocoScope" globcrm-web/src/app/features/settings/settings.routes.ts` shows scope configuration
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` builds without errors
  </verify>
  <done>Contacts and settings feature scopes configured with provideTranslocoScope, translation files created for both EN and TR, lazy-loading proven (navigating to contacts loads contacts/*.json only)</done>
</task>

<task type="auto">
  <name>Task 2: Add Organization DefaultLanguage backend support and settings hub language card</name>
  <files>
    src/GlobCRM.Domain/Entities/Organization.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
    src/GlobCRM.Api/Controllers/OrganizationsController.cs
    src/GlobCRM.Application/Organizations/OrganizationDto.cs
    globcrm-web/src/app/features/settings/settings-hub.component.ts
    globcrm-web/src/app/core/i18n/language.service.ts
  </files>
  <action>
    1. Update `src/GlobCRM.Domain/Entities/Organization.cs`:
       - Add property: `public string DefaultLanguage { get; set; } = "en";`
       - Add XML doc comment: `/// <summary>Default UI language for new users in this organization (en or tr).</summary>`

    2. Update `src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs`:
       - Add column configuration: `builder.Property(o => o.DefaultLanguage).HasColumnName("default_language").HasMaxLength(5).HasDefaultValue("en");`

    3. Create EF Core migration:
       - Run from `src/GlobCRM.Api`: `dotnet ef migrations add AddOrganizationDefaultLanguage --context TenantDbContext --output-dir Persistence/Migrations/Tenant --project ../GlobCRM.Infrastructure`
       - Verify the migration adds the `default_language` column with default value "en"
       - Apply migration: `dotnet ef database update --context TenantDbContext --project ../GlobCRM.Infrastructure`

    4. Update `src/GlobCRM.Application/Organizations/OrganizationDto.cs`:
       - Add `public string DefaultLanguage { get; set; } = "en";` to the DTO
       - Update `FromEntity()` to map the field

    5. Update `src/GlobCRM.Api/Controllers/OrganizationsController.cs`:
       - Add a `PUT /api/organizations/settings/language` endpoint (or add to existing settings endpoint):
         - Request record: `record UpdateDefaultLanguageRequest(string Language)` with validation (must be "en" or "tr")
         - Loads the current organization, sets `DefaultLanguage = request.Language`, saves
         - Requires Admin role: `[Authorize(Roles = "Admin")]`
         - Returns the updated OrganizationDto
       - Ensure the existing `GET /api/organizations/current` (or equivalent) returns `DefaultLanguage` in the response

    6. Update `globcrm-web/src/app/features/settings/settings-hub.component.ts`:
       - Add a new settings card in the "Organization" section:
         ```typescript
         {
           icon: 'language',
           label: 'Language',
           description: 'Set the default language for your organization',
           route: '/settings/language',
           adminOnly: true,
         }
         ```
       - This adds the card to the settings hub. The actual language settings page (route '/settings/language') can be a simple inline component or a dedicated component.
       - Create a minimal language settings component at `globcrm-web/src/app/features/settings/language/language-settings.component.ts`:
         - Standalone component with Angular Material select
         - Fetches current org default language from GET endpoint
         - Two-option dropdown: English / Turkish (Türkçe)
         - On change, calls PUT endpoint to update
         - Shows success snackbar on save
       - Add the route to `settings.routes.ts`: `{ path: 'language', loadComponent: () => import('./language/language-settings.component').then(m => m.LanguageSettingsComponent) }`

    7. Wire "new users inherit org default" in `LanguageService.syncFromProfile()` (in `globcrm-web/src/app/core/i18n/language.service.ts`):
       - Update `syncFromProfile(profileLanguage: string | null | undefined)` method:
         - If `profileLanguage` is 'en' or 'tr', use it directly (existing behavior — user has explicit preference)
         - If `profileLanguage` is null/undefined (new user with no personal preference), fall back to the organization's default language:
           - Inject `TenantStore` from `../../core/tenant/tenant.store`
           - Read `this.tenantStore.organization()?.defaultLanguage` (or equivalent getter)
           - If org default is 'en' or 'tr', call `switchLanguage(orgDefault)`
           - If org default is also missing, fall through to existing `detectLanguage()` (browser detection)
       - The resolution order becomes: **user profile preference → org default → browser detection → 'en'**
       - This ensures LOCL-07's "new users inherit it" requirement is met without modifying the invitation/user creation flow
       - NOTE: This modifies `language.service.ts` which is also modified by Plans 02 and 03. The change is isolated to the `syncFromProfile` method body (adding a fallback branch), which is distinct from Plan 02's `updatePreferences` call and Plan 03's `DateAdapter.setLocale()` addition.
  </action>
  <verify>
    - `cd src/GlobCRM.Api && dotnet build` builds without errors
    - `grep "DefaultLanguage" src/GlobCRM.Domain/Entities/Organization.cs` shows the property
    - `grep "default_language" src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs` shows column config
    - `grep "language" globcrm-web/src/app/features/settings/settings-hub.component.ts` shows the new settings card
    - `grep "tenantStore\|TenantStore" globcrm-web/src/app/core/i18n/language.service.ts` shows TenantStore injection for org default fallback
    - `grep "defaultLanguage\|DefaultLanguage" globcrm-web/src/app/core/i18n/language.service.ts` shows org default language fallback in syncFromProfile
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` builds without errors
  </verify>
  <done>Organization.DefaultLanguage persisted to database with migration, admin can view/update via PUT endpoint, settings hub has Language card, language settings page allows changing org default, and LanguageService.syncFromProfile() falls back to org default for new users with no personal preference</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` completes without errors
2. `cd src/GlobCRM.Api && dotnet build` completes without errors
3. Contacts and settings scopes lazy-load correctly (provideTranslocoScope configured)
4. Feature translation files exist: contacts/en.json, contacts/tr.json, settings/en.json, settings/tr.json
5. Organization.DefaultLanguage column exists in database with "en" default
6. Settings hub shows Language card in Organization section (admin only)
7. Language settings page allows changing org default language
</verification>

<success_criteria>
- Navigating to contacts loads contacts/en.json (or tr.json), not the global file — proving per-feature lazy loading (LOCL-05)
- Settings hub shows a Language card under Organization (admin only) (LOCL-07)
- Admin can set default language to English or Turkish, saved to backend (LOCL-07)
- New users with no personal language preference inherit the org default on login via syncFromProfile() fallback (LOCL-07)
- Translation files for contacts and settings have complete EN + TR key parity
- Feature scope pattern established and documented for Phase 28 to replicate across all features
</success_criteria>

<output>
After completion, create `.planning/phases/27-localization-foundation/27-04-SUMMARY.md`
</output>
