---
phase: 11-polish-and-completeness
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - globcrm-web/src/app/features/notes/note.models.ts
  - globcrm-web/src/app/features/notes/note.service.ts
  - globcrm-web/src/app/features/notes/note.store.ts
  - globcrm-web/src/app/features/notes/note-list/note-list.component.ts
  - globcrm-web/src/app/features/notes/note-list/note-list.component.html
  - globcrm-web/src/app/features/notes/note-list/note-list.component.scss
  - globcrm-web/src/app/features/notes/note-form/note-form.component.ts
  - globcrm-web/src/app/features/notes/note-detail/note-detail.component.ts
  - globcrm-web/src/app/features/notes/notes.routes.ts
  - globcrm-web/src/app/shared/components/rich-text-editor/rich-text-editor.component.ts
  - globcrm-web/angular.json
autonomous: true
must_haves:
  truths:
    - "User can view a paginated list of notes in a DynamicTable with title, entity, author, date columns"
    - "User can create a note with rich text body linked to any entity"
    - "User can edit and delete their own notes"
    - "Rich text editor provides formatting toolbar (bold, italic, lists, headers, links)"
    - "Note detail page shows full rich text content rendered as HTML"
  artifacts:
    - path: "globcrm-web/src/app/features/notes/note.models.ts"
      provides: "NoteListDto, NoteDetailDto, CreateNoteRequest, UpdateNoteRequest interfaces"
      contains: "NoteListDto"
    - path: "globcrm-web/src/app/features/notes/note.service.ts"
      provides: "NoteService with CRUD + entity-scoped query methods"
      contains: "class NoteService"
    - path: "globcrm-web/src/app/features/notes/note.store.ts"
      provides: "NoteStore signal store (component-provided)"
      contains: "NoteStore"
    - path: "globcrm-web/src/app/features/notes/note-list/note-list.component.ts"
      provides: "Notes list page with DynamicTable"
      contains: "class NoteListComponent"
    - path: "globcrm-web/src/app/features/notes/note-form/note-form.component.ts"
      provides: "Note create/edit form with rich text editor"
      contains: "class NoteFormComponent"
    - path: "globcrm-web/src/app/shared/components/rich-text-editor/rich-text-editor.component.ts"
      provides: "Reusable Quill rich text editor wrapper"
      contains: "class RichTextEditorComponent"
  key_links:
    - from: "note-list.component.ts"
      to: "NoteStore"
      via: "component-provided signal store"
      pattern: "providers.*NoteStore"
    - from: "note-form.component.ts"
      to: "RichTextEditorComponent"
      via: "template import"
      pattern: "RichTextEditorComponent|quill-editor"
    - from: "NoteService"
      to: "/api/notes"
      via: "ApiService HTTP calls"
      pattern: "api/notes"
---

<objective>
Create the complete frontend Notes feature: TypeScript models, API service, signal store, list page with DynamicTable, form with rich text editor (ngx-quill), detail page, and routes. Also create a shared RichTextEditorComponent wrapping ngx-quill.

Purpose: Delivers NOTE-01 (CRUD with rich text), NOTE-02 (DynamicTable list), and the rich text editing infrastructure.
Output: Full notes feature module with list, form, detail pages and reusable rich text editor.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-02-SUMMARY.md

@globcrm-web/src/app/features/companies/company-list/company-list.component.ts
@globcrm-web/src/app/features/companies/company-list/company-list.component.html
@globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts
@globcrm-web/src/app/features/quotes/quote-form/quote-form.component.ts
@globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ngx-quill + create shared RichTextEditorComponent + Note models, service, store</name>
  <files>
    globcrm-web/src/app/shared/components/rich-text-editor/rich-text-editor.component.ts
    globcrm-web/src/app/features/notes/note.models.ts
    globcrm-web/src/app/features/notes/note.service.ts
    globcrm-web/src/app/features/notes/note.store.ts
    globcrm-web/angular.json
  </files>
  <action>
    Install frontend packages:
    ```
    cd globcrm-web
    npm install ngx-quill@^27.0.0 quill@^2.0.0
    ```

    Add Quill CSS to angular.json styles array (before src/styles.scss):
    ```json
    "node_modules/quill/dist/quill.snow.css"
    ```

    Create RichTextEditorComponent as a reusable wrapper:
    - Standalone component importing QuillModule from ngx-quill and ReactiveFormsModule
    - Accepts formControlName binding (implements ControlValueAccessor via QuillModule integration)
    - Actually, use ngx-quill's quill-editor component directly -- it already supports formControlName
    - Instead, make a thin wrapper that configures toolbar and styling:
      - Input: placeholder (string, default "Write something..."), height (string, default "200px")
      - Template: `<quill-editor [formControl]="control" [styles]="{ height: height() }" [modules]="quillModules" [placeholder]="placeholder()" />`
      - quillModules config: toolbar with bold, italic, underline, strike | ordered list, bullet list | header [1,2,3,false] | link | clean
    - Export the component for use in note-form and potentially elsewhere
    - Import QuillModule in the component

    Create note.models.ts:
    - NoteListDto: id, title, plainTextBody, entityType, entityName, authorName, createdAt, updatedAt
    - NoteDetailDto: extends NoteListDto + body (full HTML), authorId, entityId
    - CreateNoteRequest: title, body, entityType, entityId, entityName
    - UpdateNoteRequest: title, body

    Create note.service.ts:
    - Inject ApiService
    - getList(params: EntityQueryParams & { entityType?: string, entityId?: string }): Observable<PagedResult<NoteListDto>>
    - getById(id: string): Observable<NoteDetailDto>
    - create(request: CreateNoteRequest): Observable<NoteDetailDto>
    - update(id: string, request: UpdateNoteRequest): Observable<NoteDetailDto>
    - delete(id: string): Observable<void>
    - getEntityNotes(entityType: string, entityId: string): Observable<NoteListDto[]>

    Create note.store.ts as a component-provided signal store (matching QuoteStore/CompanyStore pattern):
    - State: items (NoteListDto[]), selectedNote (NoteDetailDto | null), totalCount, page, pageSize, isLoading, error
    - Methods: loadNotes, loadNote, createNote, updateNote, deleteNote
    - Default sort: createdAt desc
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` -- check no compilation errors from new files.
  </verify>
  <done>ngx-quill installed with Quill 2. RichTextEditorComponent wraps quill-editor with standard toolbar config. Note models, service, and store follow established codebase patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Note list, form, detail pages + routes</name>
  <files>
    globcrm-web/src/app/features/notes/note-list/note-list.component.ts
    globcrm-web/src/app/features/notes/note-list/note-list.component.html
    globcrm-web/src/app/features/notes/note-list/note-list.component.scss
    globcrm-web/src/app/features/notes/note-form/note-form.component.ts
    globcrm-web/src/app/features/notes/note-detail/note-detail.component.ts
    globcrm-web/src/app/features/notes/notes.routes.ts
  </files>
  <action>
    Create NoteListComponent following CompanyListComponent / QuoteListComponent pattern:
    - Provides NoteStore at component level (providers: [NoteStore])
    - Uses DynamicTable with columns: Title, Entity Type, Entity Name, Author, Created At
    - Uses ViewSidebar for saved views (entity type "Note")
    - Uses FilterPanel for filters
    - "New Note" button navigates to /notes/new
    - Row click navigates to /notes/{id}
    - Page title "Notes" with note icon
    - PlainTextBody column shows truncated preview (first 100 chars)

    Create NoteFormComponent (use inline template matching deal-form/activity-form pattern):
    - Route param: :id (edit mode) or 'new' (create mode)
    - FormGroup with: title (required, maxLength 200), body (required -- rich text), entityType (required, select from Company/Contact/Deal/Quote/Request), entityId (required), entityName
    - Entity selection: entityType dropdown shows allowed types. When entityType selected, show autocomplete for entityId that searches the corresponding entity (use existing entity services -- CompanyService, ContactService, etc. -- to search). This follows the company autocomplete pattern from contact-form.
    - Actually, simpler approach: entityType mat-select + entityId text input with entity name autocomplete using a combined search approach. Or, use the GlobalSearchService to search across entity types. Or keep it simple: entityType dropdown, then a text input for entity name with Subject-based debounced search calling the appropriate service.
    - Body field uses the RichTextEditorComponent
    - Save calls NoteService.create or .update
    - Navigate back to /notes on success with snackbar confirmation
    - provideNativeDateAdapter not needed (no datepicker)

    Create NoteDetailComponent:
    - Loads note by :id route param via NoteService.getById
    - Displays title as page header
    - Displays body as rendered HTML using [innerHTML] binding (Angular auto-sanitizes)
    - Shows metadata: author name, entity link (clickable, navigates to entity), created/updated dates
    - Edit button navigates to /notes/{id}/edit (or /notes/{id} with edit query param)
    - Delete button with confirm dialog (reuse ConfirmDeleteDialogComponent)
    - Author-only edit/delete (check current user against authorId, or admin)

    Create notes.routes.ts:
    ```typescript
    export const NOTES_ROUTES: Routes = [
      { path: '', component: NoteListComponent },
      { path: 'new', component: NoteFormComponent },
      { path: ':id', component: NoteDetailComponent },
      { path: ':id/edit', component: NoteFormComponent },
    ];
    ```
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- builds without errors.
  </verify>
  <done>Notes list page shows paginated DynamicTable with saved views. Note form supports rich text editing with entity linking. Note detail renders full HTML content. Routes configured for list, create, edit, detail.</done>
</task>

</tasks>

<verification>
- `ng build` succeeds
- NoteListComponent renders DynamicTable with note data columns
- NoteFormComponent includes quill-editor for rich text body
- NoteDetailComponent renders HTML body safely with [innerHTML]
- Routes work: /notes (list), /notes/new (create), /notes/:id (detail), /notes/:id/edit (edit)
- NoteStore is component-provided (not root)
</verification>

<success_criteria>
Complete Notes frontend feature with list (DynamicTable), form (rich text via ngx-quill), detail page, signal store, and routes. Rich text editor available as shared component for reuse.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-03-SUMMARY.md`
</output>
