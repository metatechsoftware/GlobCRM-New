---
phase: 11-polish-and-completeness
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/GlobCRM.Domain/Common/INoteRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/NoteRepository.cs
  - src/GlobCRM.Api/Controllers/NotesController.cs
  - src/GlobCRM.Api/Controllers/AttachmentsController.cs
  - src/GlobCRM.Api/Controllers/CalendarController.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
autonomous: true
must_haves:
  truths:
    - "Notes API supports CRUD operations with rich text body and entity linking"
    - "Attachments API supports upload, download, delete for any entity type"
    - "Calendar API returns activities within a date range for efficient calendar rendering"
    - "Note and Attachment queries respect tenant isolation and RBAC ownership scope"
    - "Timeline endpoints return note entries for entity detail pages"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/NotesController.cs"
      provides: "Notes CRUD API with paged list, entity-scoped queries, timeline integration"
      contains: "class NotesController"
    - path: "src/GlobCRM.Api/Controllers/AttachmentsController.cs"
      provides: "Generic entity attachment upload/download/delete endpoints"
      contains: "class AttachmentsController"
    - path: "src/GlobCRM.Api/Controllers/CalendarController.cs"
      provides: "Date-range activity query for calendar rendering"
      contains: "class CalendarController"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/NoteRepository.cs"
      provides: "Note repository with paged queries, entity-scoped filtering, sorting"
      contains: "class NoteRepository"
  key_links:
    - from: "NotesController"
      to: "NoteRepository"
      via: "INoteRepository injection"
      pattern: "INoteRepository"
    - from: "AttachmentsController"
      to: "IFileStorageService"
      via: "DI injection for file operations"
      pattern: "IFileStorageService"
    - from: "CalendarController"
      to: "ActivityRepository"
      via: "IActivityRepository for date-range queries"
      pattern: "IActivityRepository"
---

<objective>
Create backend repositories and API controllers for Notes (full CRUD), generic Attachments (upload/download/delete for any entity), and Calendar (date-range activity aggregation).

Purpose: Provides the API layer needed by all frontend features in Wave 3 (notes, attachments, calendar).
Output: NotesController, AttachmentsController, CalendarController, NoteRepository
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-01-SUMMARY.md

@src/GlobCRM.Api/Controllers/ActivitiesController.cs
@src/GlobCRM.Api/Controllers/CompaniesController.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/CompanyRepository.cs
@src/GlobCRM.Domain/Common/PagedResult.cs
@src/GlobCRM.Domain/Common/EntityQueryParams.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: NoteRepository + NotesController with CRUD and entity-scoped queries</name>
  <files>
    src/GlobCRM.Domain/Common/INoteRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/NoteRepository.cs
    src/GlobCRM.Api/Controllers/NotesController.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    Create INoteRepository interface in Domain/Common (matching ICompanyRepository pattern):
    - GetPagedAsync(EntityQueryParams params, string? entityType, Guid? entityId, Guid userId, string scope, List<Guid>? teamMemberIds) -> PagedResult<NoteListDto>
    - GetByIdAsync(Guid id) -> Note?
    - AddAsync(Note note) -> Note
    - UpdateAsync(Note note)
    - DeleteAsync(Guid id)
    - GetEntityNotesForTimelineAsync(string entityType, Guid entityId) -> List<TimelineEntry>

    NoteListDto (define as record in controller file or repository, matching CompanyListDto pattern):
    - Id, Title, PlainTextBody (truncated to 200 chars for list display), EntityType, EntityName, AuthorName, CreatedAt, UpdatedAt

    Create NoteRepository following CompanyRepository pattern:
    - GetPagedAsync: Supports filter by entityType, entityId; sorting by title, createdAt, updatedAt; ownership scope (OwnerId = AuthorId for notes)
    - Include Author for AuthorName resolution
    - GetEntityNotesForTimelineAsync: Returns TimelineEntry objects with type="note" for entity timeline integration

    Create NotesController following CompaniesController pattern:
    - [Authorize] at controller level
    - GET /api/notes -- paged list with EntityQueryParams + optional entityType/entityId query params
    - GET /api/notes/{id} -- get single note (returns NoteDetailDto with full Body HTML)
    - POST /api/notes -- create note (accepts: title, body, entityType, entityId, entityName). Server-side: strip HTML to generate PlainTextBody (use simple regex to remove tags, or System.Text.RegularExpressions). Set AuthorId from current user.
    - PUT /api/notes/{id} -- update note (author-only or admin). Regenerate PlainTextBody on update.
    - DELETE /api/notes/{id} -- delete note (author-only or admin)
    - GET /api/notes/entity/{entityType}/{entityId} -- entity-scoped notes for tab content

    Permission policy: Use "Note" entity type permissions (Note:View, Note:Create, Note:Edit, Note:Delete). Add "Note" to the permission seeder's entity type list (EnsurePermissionsForAllEntityTypesAsync in TenantSeeder or PermissionService). Check how existing entity types are registered.

    Register INoteRepository in DependencyInjection.cs or CrmEntityServiceExtensions.cs (match existing registration pattern).

    Update existing entity timeline endpoints to include notes. Each entity controller (Companies, Contacts, Deals, Quotes, Requests) has a /timeline endpoint. Update those to also query NoteRepository.GetEntityNotesForTimelineAsync and merge results into the timeline. If timeline endpoints are in individual controllers, add the note timeline entries there. If there's a shared service, update that.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles. Controller has all 5 CRUD endpoints + entity-scoped endpoint.
  </verify>
  <done>NotesController provides full CRUD with entity-scoped queries. Notes appear in entity timelines. Repository handles paged queries with filtering and sorting. Permission enforcement matches existing entity patterns.</done>
</task>

<task type="auto">
  <name>Task 2: AttachmentsController + CalendarController</name>
  <files>
    src/GlobCRM.Api/Controllers/AttachmentsController.cs
    src/GlobCRM.Api/Controllers/CalendarController.cs
  </files>
  <action>
    Create AttachmentsController for generic entity attachment operations:
    - [Authorize] at controller level
    - POST /api/{entityType}/{entityId:guid}/attachments -- upload file (IFormFile)
      - Validate entityType is in allowed list: "company", "contact", "deal", "quote", "activity", "request", "note"
      - Validate file: max 25MB ([RequestSizeLimit(25 * 1024 * 1024)]), block dangerous extensions (.exe, .bat, .cmd, .ps1, .sh) -- reuse validation from existing ActivitiesController attachment endpoint
      - Save via IFileStorageService with tenantId partitioning, category "attachments"
      - Create Attachment entity, save to DB
      - Return 201 with AttachmentDto (id, fileName, contentType, fileSizeBytes, uploadedByName, uploadedAt)
    - GET /api/{entityType}/{entityId:guid}/attachments -- list attachments for entity
      - Query Attachments table filtered by EntityType + EntityId
      - Return List<AttachmentDto>
    - GET /api/attachments/{id:guid}/download -- download single attachment
      - Load attachment, get file from IFileStorageService, return File() with content type
    - DELETE /api/attachments/{id:guid} -- delete attachment
      - Author-only or admin (check UploadedById matches current user or User.IsInRole("Admin"))
      - Delete from storage + DB

    Create CalendarController for unified calendar data:
    - [Authorize] at controller level
    - GET /api/calendar?start={iso}&end={iso}&type={activityType?}&ownerId={guid?}&entityType={string?}&entityId={guid?}
      - Query activities where DueDate is between start and end dates
      - Optional filters: type (Task, Call, Meeting, etc.), ownerId, linked entityType/entityId
      - Apply RBAC ownership scope (matching ActivitiesController pattern -- check OwnerId and AssignedToId for scope)
      - Return List<CalendarEventDto> with: id, title (subject), start (dueDate ISO), end (dueDate ISO), color (priority-based), extendedProps (type, status, priority, assignedToName, ownerName)
      - This uses the existing ActivityRepository or queries ApplicationDbContext directly
      - The key difference from ActivityService.getList is that this endpoint is optimized for calendar: no pagination, just date-range bounded, lightweight DTOs

    Use existing IActivityRepository if it has a suitable method, or query ApplicationDbContext.Activities directly with Include for AssignedTo/Owner.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles. AttachmentsController has upload, list, download, delete endpoints. CalendarController has date-range query endpoint.
  </verify>
  <done>AttachmentsController provides generic file operations for any entity type with validation and tenant isolation. CalendarController provides date-range bounded activity queries optimized for calendar rendering with optional filters by type, owner, and entity.</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds for entire solution
- NotesController: GET list, GET by id, POST create, PUT update, DELETE, GET entity-scoped
- AttachmentsController: POST upload, GET list, GET download, DELETE
- CalendarController: GET with date range + optional filters
- Note timeline entries appear in entity timeline responses
- All controllers use [Authorize] and respect tenant isolation
</verification>

<success_criteria>
Complete backend API for Notes CRUD, generic Attachments, and Calendar date-range queries. All endpoints respect tenant isolation and RBAC. Notes integrate into entity timelines.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-02-SUMMARY.md`
</output>
