---
phase: 11-polish-and-completeness
plan: 07
type: execute
wave: 4
depends_on: ["11-03", "11-04", "11-05", "11-06"]
files_modified:
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
  - globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
  - globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
autonomous: true
must_haves:
  truths:
    - "Notes and Calendar appear as nav links in the navbar"
    - "App routes include /notes and /calendar with lazy loading"
    - "Notes tab is enabled on Company, Contact, Deal, Quote, Request detail pages"
    - "Attachments tab/section is available on entity detail pages"
    - "Entity detail pages show notes in the Notes tab and attachments in an Attachments section"
    - "Clicking a note in entity tab navigates to the note detail page"
  artifacts:
    - path: "globcrm-web/src/app/app.routes.ts"
      provides: "Routes for /notes and /calendar"
      contains: "notes|calendar"
    - path: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      provides: "Updated tab configs with Notes enabled + Attachments tab added"
      contains: "Notes.*enabled: true|Attachments"
  key_links:
    - from: "app.routes.ts"
      to: "notes.routes.ts"
      via: "Lazy-loaded route"
      pattern: "loadChildren.*notes"
    - from: "app.routes.ts"
      to: "calendar.routes.ts"
      via: "Lazy-loaded route"
      pattern: "loadChildren.*calendar"
    - from: "entity detail components"
      to: "EntityAttachmentsComponent"
      via: "Template import"
      pattern: "app-entity-attachments|EntityAttachmentsComponent"
---

<objective>
Wire all Phase 11 features into the application: add Notes and Calendar to navbar and app routes, enable Notes tab and add Attachments tab/section on all entity detail pages, and integrate entity-scoped notes and attachments.

Purpose: Connects all Phase 11 features (Notes, Calendar, Attachments, Responsive) into the existing application structure.
Output: Complete integration of all Phase 11 features with navbar, routing, and entity detail tabs.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-03-SUMMARY.md
@.planning/phases/11-polish-and-completeness/11-04-SUMMARY.md
@.planning/phases/11-polish-and-completeness/11-05-SUMMARY.md
@.planning/phases/11-polish-and-completeness/11-06-SUMMARY.md

@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: App routes + Navbar links for Notes and Calendar</name>
  <files>
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
  </files>
  <action>
    Update app.routes.ts to add /notes and /calendar routes:
    ```typescript
    {
      path: 'notes',
      canActivate: [authGuard],
      loadChildren: () =>
        import('./features/notes/notes.routes').then((m) => m.NOTES_ROUTES),
    },
    {
      path: 'calendar',
      canActivate: [authGuard],
      loadChildren: () =>
        import('./features/calendar/calendar.routes').then((m) => m.CALENDAR_ROUTES),
    },
    ```
    Place these before the catch-all redirect. Notes route after requests, Calendar route after feed.

    Update navbar.component.html to add Notes and Calendar nav links:
    - Add "Notes" link after "Requests" (per research recommendation):
      ```html
      <a routerLink="/notes" routerLinkActive="navbar__link--active" class="navbar__link">
        <mat-icon class="navbar__link-icon">note</mat-icon>
        Notes
      </a>
      ```
    - Add "Calendar" link between "Feed" and "Team" (per research recommendation):
      ```html
      <a routerLink="/calendar" routerLinkActive="navbar__link--active" class="navbar__link">
        <mat-icon class="navbar__link-icon">calendar_month</mat-icon>
        Calendar
      </a>
      ```

    Updated navbar link order will be:
    Dashboard | Companies | Contacts | Products | Deals | Activities | Quotes | Requests | Notes | Emails | Feed | Calendar | Team | Settings

    Also update the mobile drawer nav links (from Plan 06) to include Notes and Calendar in the same positions.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- builds.
  </verify>
  <done>App routes include /notes and /calendar with lazy loading and authGuard. Navbar shows Notes and Calendar links in correct positions on both desktop and mobile.</done>
</task>

<task type="auto">
  <name>Task 2: Enable Notes tab + add Attachments on entity detail pages</name>
  <files>
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
    globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
    globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
  </files>
  <action>
    Update related-entity-tabs.component.ts tab configurations:

    COMPANY_TABS: Enable Notes tab (change enabled: false to enabled: true). Add Attachments tab:
    ```typescript
    { label: 'Notes', icon: 'note', enabled: true },
    { label: 'Attachments', icon: 'attach_file', enabled: true },
    ```

    CONTACT_TABS: Same -- enable Notes, add Attachments:
    ```typescript
    { label: 'Notes', icon: 'note', enabled: true },
    { label: 'Attachments', icon: 'attach_file', enabled: true },
    ```

    DEAL_TABS: Add Notes and Attachments tabs:
    ```typescript
    { label: 'Notes', icon: 'note', enabled: true },
    { label: 'Attachments', icon: 'attach_file', enabled: true },
    ```

    For entity detail components (Company, Contact, Deal, Quote, Request), add the Notes and Attachments tab content:

    For each entity detail component:
    1. Import NoteService and EntityAttachmentsComponent
    2. Add notes signal: notes = signal<NoteListDto[]>([])
    3. Add notesLoaded signal to prevent redundant loads (matching activitiesLoaded pattern)
    4. On Notes tab selection: load entity-scoped notes via NoteService.getEntityNotes(entityType, entityId)
    5. Display notes in a simple list (title, preview text, author, date) with click to navigate to /notes/{id}
    6. "Add Note" button navigates to /notes/new?entityType=company&entityId={id}&entityName={name}

    For Attachments tab: embed `<app-entity-attachments [entityType]="'company'" [entityId]="companyId" />` (or appropriate entity type).

    Important: Tab templates are projected by index (contentChildren(TemplateRef)), so adding new tabs changes the index mapping. Ensure the ng-template elements in each detail component match the new tab order. Count carefully:
    - COMPANY_TABS after update: Details(0), Contacts(1), Deals(2), Activities(3), Quotes(4), Requests(5), Emails(6), Notes(7), Attachments(8)
    - Each existing ng-template must remain at the correct index. Add new ng-template elements at the end for Notes and Attachments.

    For Activity detail (which uses mat-tab-group directly, not RelatedEntityTabsComponent): Add an Attachments section or tab. Activity already has an Attachments tab from Phase 5 (ActivityAttachment). Consider whether to also show generic Attachments or keep the existing activity-specific attachment system. Decision: Keep activity's built-in attachment tab as-is. The EntityAttachmentsComponent is for entities that DON'T already have attachments (Companies, Contacts, Deals, Quotes, Requests). For activities, the existing system works. Just add Notes tab to activity detail if it uses a tab system.

    For Quote detail: Add Notes and Attachments tabs. Quote detail uses mat-tab-group directly (like Activity). Add the tab content.

    For Request detail: Add Notes and Attachments tabs (if using RelatedEntityTabsComponent or direct mat-tab-group).

    Check each detail component to see whether it uses RelatedEntityTabsComponent (Company, Contact use it) or direct mat-tab-group (Deal, Activity, Quote, Request might). Adapt accordingly.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- builds.
  </verify>
  <done>Notes tab enabled and functional on all entity detail pages showing entity-scoped notes. Attachments tab/section added to Company, Contact, Deal, Quote, Request detail pages using EntityAttachmentsComponent. Tab content indexed correctly.</done>
</task>

</tasks>

<verification>
- `ng build` succeeds
- /notes route loads NoteListComponent
- /calendar route loads CalendarComponent
- Navbar shows Notes and Calendar links (desktop and mobile)
- Company detail Notes tab loads entity-scoped notes
- Company detail Attachments tab shows EntityAttachmentsComponent
- Contact, Deal, Quote, Request detail pages similarly have Notes and Attachments
- Tab indices are correct (no misaligned content)
</verification>

<success_criteria>
All Phase 11 features fully integrated into the application. Notes and Calendar accessible from navbar. Every entity detail page supports Notes viewing/creation and Attachment upload/management. App routes properly configured with lazy loading.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-07-SUMMARY.md`
</output>
