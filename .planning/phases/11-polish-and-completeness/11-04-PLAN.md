---
phase: 11-polish-and-completeness
plan: 04
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - globcrm-web/src/app/shared/components/entity-attachments/entity-attachments.component.ts
  - globcrm-web/src/app/shared/services/attachment.service.ts
  - globcrm-web/src/app/shared/models/attachment.models.ts
  - globcrm-web/package.json
autonomous: true
must_haves:
  truths:
    - "EntityAttachmentsComponent accepts entityType and entityId inputs and manages file upload/list/download/delete"
    - "User can upload files up to 25MB with validation feedback"
    - "File list shows name, size, type icon, uploader, and date"
    - "User can download attached files and preview images inline via a mat-dialog"
    - "Dangerous file extensions are blocked on the frontend before upload"
  artifacts:
    - path: "globcrm-web/src/app/shared/services/attachment.service.ts"
      provides: "AttachmentService with upload, list, download, delete methods"
      contains: "class AttachmentService"
    - path: "globcrm-web/src/app/shared/models/attachment.models.ts"
      provides: "AttachmentDto interface"
      contains: "AttachmentDto"
    - path: "globcrm-web/src/app/shared/components/entity-attachments/entity-attachments.component.ts"
      provides: "Reusable attachment panel for any entity detail page"
      contains: "class EntityAttachmentsComponent"
  key_links:
    - from: "EntityAttachmentsComponent"
      to: "AttachmentService"
      via: "DI injection"
      pattern: "inject(AttachmentService)"
    - from: "AttachmentService"
      to: "/api/{entityType}/{entityId}/attachments"
      via: "HttpClient for FormData upload and blob download"
      pattern: "attachments"
    - from: "EntityAttachmentsComponent image preview"
      to: "MatDialog"
      via: "Opens dialog with image blob for image/* content types"
      pattern: "MatDialog.*image|openImagePreview"
---

<objective>
Create a reusable EntityAttachmentsComponent and AttachmentService for uploading, listing, downloading, and deleting file attachments on any entity detail page.

Purpose: Delivers ATCH-01 (upload to any entity), ATCH-02 (preview/download), ATCH-04 (metadata tracking) as a shared component.
Output: EntityAttachmentsComponent, AttachmentService, attachment models.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-02-SUMMARY.md

@globcrm-web/src/app/features/activities/activity.service.ts
@globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AttachmentService + attachment models</name>
  <files>
    globcrm-web/src/app/shared/models/attachment.models.ts
    globcrm-web/src/app/shared/services/attachment.service.ts
  </files>
  <action>
    Create attachment.models.ts:
    - AttachmentDto: id, fileName, contentType, fileSizeBytes, uploadedByName, uploadedById, uploadedAt
    - BLOCKED_EXTENSIONS: readonly string array ['.exe', '.bat', '.cmd', '.ps1', '.sh'] for client-side validation
    - MAX_FILE_SIZE: 25 * 1024 * 1024 (25MB)

    Create AttachmentService as a root-provided injectable service:
    - Uses HttpClient directly (not ApiService) for FormData upload and blob download (matching ActivityService attachment pattern from Phase 5)
    - Constructor injects HttpClient and reads base API URL from environment
    - Methods:
      - upload(entityType: string, entityId: string, file: File): Observable<AttachmentDto>
        - Creates FormData, appends file
        - POST to /api/{entityType}/{entityId}/attachments
      - list(entityType: string, entityId: string): Observable<AttachmentDto[]>
        - GET /api/{entityType}/{entityId}/attachments
      - download(attachmentId: string): Observable<Blob>
        - GET /api/attachments/{attachmentId}/download with responseType: 'blob'
      - delete(attachmentId: string): Observable<void>
        - DELETE /api/attachments/{attachmentId}
    - Utility methods:
      - validateFile(file: File): { valid: boolean, error?: string }
        - Check file size <= MAX_FILE_SIZE
        - Check extension not in BLOCKED_EXTENSIONS
        - Return error message if invalid
      - isImageContentType(contentType: string): boolean
        - Returns true if contentType starts with 'image/'
        - Used by EntityAttachmentsComponent to determine whether to show preview button
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- compiles.
  </verify>
  <done>AttachmentService handles file upload via FormData, blob download, list, and delete. Client-side file validation blocks dangerous extensions and oversized files. isImageContentType helper available for preview detection.</done>
</task>

<task type="auto">
  <name>Task 2: EntityAttachmentsComponent (reusable attachment panel with image preview)</name>
  <files>
    globcrm-web/src/app/shared/components/entity-attachments/entity-attachments.component.ts
  </files>
  <action>
    Create EntityAttachmentsComponent as a standalone component with inline template and styles:
    - Inputs: entityType (required string), entityId (required string)
    - Signals: attachments (AttachmentDto[]), isLoading (boolean), isUploading (boolean), error (string | null)

    On init (or via effect watching entityId): call AttachmentService.list() to load existing attachments.

    Template structure:
    - Header row: "Attachments" title + "Upload" button (mat-flat-button with upload_file icon)
    - Hidden file input triggered by Upload button click
    - Upload progress: mat-progress-bar mode="indeterminate" shown while isUploading
    - Attachment list: each item shows:
      - File type icon (use mat-icon: image for image/*, picture_as_pdf for pdf, description for doc/docx, table_chart for xls/xlsx, insert_drive_file for other)
      - File name (truncated if too long)
      - File size formatted (KB/MB): helper method formatFileSize(bytes)
      - Uploader name and date
      - Action buttons: Preview (mat-icon-button visibility icon, shown only for image/* types), Download (mat-icon-button download icon), Delete (mat-icon-button delete icon)
    - Empty state: "No attachments" with attach_file icon

    File selection handler (onFileSelected):
    - Validate via AttachmentService.validateFile()
    - If invalid: show snackbar with error message
    - If valid: set isUploading, call AttachmentService.upload(), on success add to attachments array, on error show snackbar

    Download handler:
    - Call AttachmentService.download(id)
    - Create blob URL via URL.createObjectURL
    - Create temporary anchor element, set href + download attribute, click, revoke URL

    Delete handler:
    - Show confirmation snackbar or simple confirm dialog
    - Call AttachmentService.delete(id)
    - Remove from local attachments array on success

    Image preview via mat-dialog (openImagePreview method):
    - For attachments where AttachmentService.isImageContentType(contentType) is true, show a "Preview" icon button
    - On click, call AttachmentService.download(id) to get the image blob
    - Create an object URL from the blob: URL.createObjectURL(blob)
    - Open a MatDialog with a simple inline component (or ng-template with MatDialogContent) that displays the image:
      - Dialog contains: `<img [src]="imageUrl" [alt]="fileName" style="max-width: 100%; max-height: 80vh;" />`
      - Dialog config: width 'auto', maxWidth '90vw', panelClass 'image-preview-dialog'
      - On dialog close (afterClosed): revoke the object URL via URL.revokeObjectURL to free memory
    - If using a simple dialog component, create it as a private standalone component within the same file (ImagePreviewDialogComponent) that receives imageUrl and fileName via MAT_DIALOG_DATA

    Styling: compact list layout matching the activity detail attachments tab UI. Each attachment row has flex layout with icon, name, meta, actions.

    Import: MatButtonModule, MatIconModule, MatProgressBarModule, MatSnackBarModule, MatDialogModule, DatePipe
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- compiles.
  </verify>
  <done>EntityAttachmentsComponent is a reusable shared component that accepts entityType + entityId inputs and provides complete file management: upload with validation, list with metadata, download, delete, and inline image preview via mat-dialog for image/* content types. Ready to embed in any entity detail page.</done>
</task>

</tasks>

<verification>
- `ng build` succeeds
- EntityAttachmentsComponent accepts entityType and entityId inputs
- AttachmentService has upload, list, download, delete methods
- File validation rejects .exe/.bat files and files over 25MB
- Download creates blob URL and triggers browser download
- Image preview button appears only for image/* content types
- Clicking preview opens mat-dialog with full-size image
- Component handles loading, uploading, empty, and error states
</verification>

<success_criteria>
Reusable EntityAttachmentsComponent ready for embedding in Company, Contact, Deal, Quote, Activity, Request, and Note detail pages. AttachmentService provides complete file management API integration. Image preview works inline via mat-dialog for image attachments.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-04-SUMMARY.md`
</output>
