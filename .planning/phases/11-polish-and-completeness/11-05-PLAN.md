---
phase: 11-polish-and-completeness
plan: 05
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - globcrm-web/src/app/features/calendar/calendar.component.ts
  - globcrm-web/src/app/features/calendar/calendar.component.html
  - globcrm-web/src/app/features/calendar/calendar.component.scss
  - globcrm-web/src/app/features/calendar/calendar.service.ts
  - globcrm-web/src/app/features/calendar/calendar.routes.ts
  - globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts
  - globcrm-web/package.json
autonomous: true
must_haves:
  truths:
    - "User can view activities in day, week, and month calendar views"
    - "User can switch between dayGridMonth, timeGridWeek, and timeGridDay views"
    - "User can drag-and-drop events to reschedule with optimistic update and revert on failure"
    - "User can click a date/time slot to create a new activity pre-filled with that date"
    - "User can filter calendar by activity type, owner, and linked entity type (all three dropdowns visible)"
    - "Calendar loads events by date range (not paginated) for efficient rendering"
  artifacts:
    - path: "globcrm-web/src/app/features/calendar/calendar.component.ts"
      provides: "Unified calendar page with FullCalendar day/week/month views"
      contains: "class CalendarComponent"
    - path: "globcrm-web/src/app/features/calendar/calendar.service.ts"
      provides: "CalendarService for date-range event queries with filters"
      contains: "class CalendarService"
    - path: "globcrm-web/src/app/features/calendar/calendar.routes.ts"
      provides: "Calendar route configuration"
      contains: "CALENDAR_ROUTES"
    - path: "globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts"
      provides: "Activity form reads dueDate queryParam for calendar pre-fill"
      contains: "queryParamMap.*dueDate"
  key_links:
    - from: "CalendarComponent"
      to: "CalendarService"
      via: "DI injection for event loading"
      pattern: "inject(CalendarService)"
    - from: "CalendarService"
      to: "/api/calendar"
      via: "ApiService HTTP call with date range params"
      pattern: "api/calendar"
    - from: "CalendarComponent eventDrop"
      to: "ActivityService"
      via: "PATCH dueDate on drag-and-drop"
      pattern: "activityService|updateDueDate|eventDrop"
    - from: "CalendarComponent handleDateClick"
      to: "activity-form.component.ts"
      via: "Router navigation with dueDate queryParam"
      pattern: "activities/new.*dueDate"
    - from: "activity-form.component.ts"
      to: "dueDate form control"
      via: "ActivatedRoute queryParamMap read on init"
      pattern: "queryParamMap.*dueDate.*patchValue"
    - from: "CalendarComponent handleDatesSet"
      to: "CalendarService.getEvents"
      via: "filterEntityType and filterEntityId signals passed as params"
      pattern: "filterEntityType|filterEntityId"
---

<objective>
Create a unified calendar page with FullCalendar day/week/month views, drag-and-drop rescheduling, date-click creation, and filters by type/owner/entity type. Install @fullcalendar/timegrid for time-based views. Also update activity-form to read dueDate from queryParams for calendar pre-fill.

Purpose: Delivers CALR-01 (day/week/month views), CALR-02 (create from calendar), CALR-03 (drag-and-drop reschedule), CALR-04 (multi-entity activities), CALR-05 (filters including entity type).
Output: Unified CalendarComponent at /calendar route with full FullCalendar integration. Activity form reads dueDate queryParam.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-02-SUMMARY.md

@globcrm-web/src/app/features/activities/activity-calendar/activity-calendar.component.ts
@globcrm-web/src/app/features/activities/activity-calendar/activity-calendar.component.html
@globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.ts
@globcrm-web/src/app/features/activities/activity.service.ts
@globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @fullcalendar/timegrid + CalendarService</name>
  <files>
    globcrm-web/src/app/features/calendar/calendar.service.ts
    globcrm-web/src/app/features/calendar/calendar.routes.ts
    globcrm-web/package.json
  </files>
  <action>
    Install @fullcalendar/timegrid:
    ```
    cd globcrm-web
    npm install @fullcalendar/timegrid@^6.1.20
    ```

    Create calendar.service.ts:
    - Inject ApiService
    - getEvents(start: string, end: string, filters?: { type?: string, ownerId?: string, entityType?: string, entityId?: string }): Observable<CalendarEventDto[]>
      - GET /api/calendar with query params: start, end, type, ownerId, entityType, entityId
      - Returns CalendarEventDto[]: id, title, start, end, color, extendedProps (type, status, priority, assignedToName, ownerName)
    - updateActivityDueDate(activityId: string, newDate: string): Observable<void>
      - PATCH /api/activities/{activityId} with body { dueDate: newDate }
      - Or use existing ActivityService.update() if it supports partial update
      - Check existing ActivitiesController -- if there's a PATCH endpoint for dueDate, use it. Otherwise, use PUT with the full activity object from a GET first. Simplest approach: add a lightweight PATCH endpoint or use existing update.
      - Actually, check if ActivityService already has an update method that can handle just a dueDate change. If the PUT requires all fields, just send the existing data with the new dueDate.

    Create calendar.routes.ts:
    ```typescript
    export const CALENDAR_ROUTES: Routes = [
      { path: '', component: CalendarComponent },
    ];
    ```
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- compiles with timegrid plugin.
  </verify>
  <done>@fullcalendar/timegrid installed. CalendarService queries /api/calendar with date range and optional filters including entityType and entityId. Routes configured.</done>
</task>

<task type="auto">
  <name>Task 2: CalendarComponent with day/week/month views, drag-drop, entity/type/owner filters + activity-form dueDate pre-fill</name>
  <files>
    globcrm-web/src/app/features/calendar/calendar.component.ts
    globcrm-web/src/app/features/calendar/calendar.component.html
    globcrm-web/src/app/features/calendar/calendar.component.scss
    globcrm-web/src/app/features/activities/activity-form/activity-form.component.ts
  </files>
  <action>
    Create CalendarComponent with separate template and styles files:

    Component class:
    - Inject CalendarService, ActivityService, Router, MatSnackBar, ProfileService (for owner dropdown)
    - Signals:
      - isLoading = signal(false)
      - events = signal<CalendarEventDto[]>([])
      - filterType = signal<string | null>(null)
      - filterOwnerId = signal<string | null>(null)
      - filterEntityType = signal<string | null>(null)   // NEW: 'contact' | 'company' | 'deal' | null
      - filterEntityId = signal<string | null>(null)     // NEW: optional ID, populated from route queryParam on load (for entity-context navigation from detail pages)
    - FullCalendar plugins: [dayGridPlugin, timeGridPlugin, interactionPlugin]
    - calendarOptions signal with:
      - initialView: 'dayGridMonth'
      - headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' }
      - editable: true (enables drag-and-drop)
      - eventStartEditable: true
      - eventDurationEditable: true
      - snapDuration: '00:15:00' (15-min snap)
      - slotDuration: '00:30:00' (30-min slots)
      - allDaySlot: true
      - height: 'auto'
      - eventDrop: handleEventDrop (drag-and-drop reschedule)
      - dateClick: handleDateClick (create new activity)
      - eventClick: handleEventClick (navigate to activity detail)
      - datesSet: handleDatesSet (reload events when date range changes)
      - events: [] (populated by service call)

    On component init:
    - Read 'entityType' and 'entityId' from route.snapshot.queryParamMap
    - If present, set filterEntityType() and filterEntityId() signals accordingly
    - This supports navigating to /calendar?entityType=contact&entityId=abc from a contact detail page

    handleDatesSet(dateInfo): Called when FullCalendar date range changes (view switch or navigation).
    - Extract start/end ISO strings from dateInfo
    - Call CalendarService.getEvents(start, end, {
        type: filterType(),
        ownerId: filterOwnerId(),
        entityType: filterEntityType(),
        entityId: filterEntityId()
      })
    - Map response to FullCalendar EventInput objects with priority-based coloring
    - Update calendarOptions.events

    Priority colors (matching existing activity calendar):
    - Low: #4caf50 (green), Medium: #2196f3 (blue), High: #ff9800 (orange), Urgent: #f44336 (red)

    handleEventDrop(info: EventDropArg): Optimistic reschedule.
    - Get new date from info.event.start
    - Call CalendarService.updateActivityDueDate(id, newDate)
    - On error: call info.revert() to snap event back + show snackbar "Failed to reschedule"

    handleDateClick(info: DateClickArg): Create new activity.
    - Navigate to /activities/new with queryParams { dueDate: info.dateStr }

    handleEventClick(info): Navigate to activity detail.
    - this.router.navigate(['/activities', info.event.id])

    Filter controls (above calendar) — THREE dropdowns:
    1. Entity type dropdown: mat-select with options:
       - "All Entities" (null), "Contacts" ('contact'), "Companies" ('company'), "Deals" ('deal')
       - Bound to filterEntityType signal
       - When changed: clear filterEntityId (reset entity-specific filtering), reload events
    2. Activity type dropdown: mat-select with options from ACTIVITY_TYPES constant (Task, Call, Meeting, etc.) + "All Types" option
       - Bound to filterType signal
    3. Owner dropdown: mat-select populated from ProfileService.getTeamDirectory (pageSize: 100) + "All Owners" option
       - Bound to filterOwnerId signal
    - When any filter changes: reload events with updated filter params
    - Use reactive approach: effect() watching all three filter signals, debounced reload

    Template structure:
    - Page header: "Calendar" title with calendar_month icon
    - Filter bar: entity type dropdown + activity type dropdown + owner dropdown in a flex row
    - FullCalendar component: `<full-calendar [options]="calendarOptions()" />`
    - Loading overlay: mat-progress-bar when isLoading

    Styling:
    - Match existing page layout patterns (_entity-list.scss class structure)
    - Filter bar with gap, flex-wrap for responsive
    - FullCalendar overrides: event font-size, cursor pointer on events

    UPDATE activity-form.component.ts to read dueDate from queryParams:
    - Inject ActivatedRoute (if not already injected)
    - In ngOnInit (or constructor), after building the form and in create mode (no :id route param):
      - Read dueDate from queryParams: `this.route.snapshot.queryParamMap.get('dueDate')`
      - If dueDate is present, parse it and patchValue the dueDate form control: `this.form.patchValue({ dueDate: new Date(dueDateParam) })`
      - This ensures clicking a date on the calendar pre-fills the activity form's due date field
    - Do NOT change any other behavior of the activity form -- this is a minimal addition
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- builds successfully.
    Grep confirms entity filter signals exist: `grep -n "filterEntityType\|filterEntityId" globcrm-web/src/app/features/calendar/calendar.component.ts`
    Grep confirms handleDatesSet passes entity params: `grep -A5 "handleDatesSet" globcrm-web/src/app/features/calendar/calendar.component.ts | grep -E "entityType|entityId"`
  </verify>
  <done>CalendarComponent shows activities in day/week/month views with FullCalendar. Drag-and-drop reschedules with optimistic update and revert on failure. Date click navigates to activity creation with dueDate queryParam. Activity form reads dueDate queryParam and pre-fills the dueDate field. Event click navigates to activity detail. Filter bar has three dropdowns: entity type, activity type, and owner. handleDatesSet passes all three filter params (type, ownerId, entityType, entityId) to CalendarService. Component reads entityType/entityId from queryParams on init for entity-context deep-linking.</done>
</task>

</tasks>

<verification>
- `ng build` succeeds
- CalendarComponent renders FullCalendar with three view options (month, week, day)
- View switcher buttons visible in calendar header toolbar
- Drag-and-drop calls API and reverts on failure
- Date click navigates to /activities/new?dueDate=...
- Activity form reads dueDate queryParam and pre-fills the due date field
- Event click navigates to /activities/{id}
- Filter bar has three dropdowns: entity type (All/Contacts/Companies/Deals), activity type, and owner
- Changing any filter dropdown reloads calendar events with updated params
- handleDatesSet passes entityType and entityId to CalendarService.getEvents
- Navigating to /calendar?entityType=contact&entityId=abc pre-selects the entity type filter
</verification>

<success_criteria>
Unified calendar page at /calendar displays activities from all entities in day/week/month views. Drag-and-drop rescheduling works with optimistic update pattern. Filter bar with three dropdowns (entity type, activity type, owner) — all three update the event query. Date-click navigates to activity form with dueDate pre-filled from queryParam. Event-click navigation functional.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-05-SUMMARY.md`
</output>
