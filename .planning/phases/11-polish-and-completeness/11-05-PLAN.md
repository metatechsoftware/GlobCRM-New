---
phase: 11-polish-and-completeness
plan: 05
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - globcrm-web/src/app/features/calendar/calendar.component.ts
  - globcrm-web/src/app/features/calendar/calendar.component.html
  - globcrm-web/src/app/features/calendar/calendar.component.scss
  - globcrm-web/src/app/features/calendar/calendar.service.ts
  - globcrm-web/src/app/features/calendar/calendar.routes.ts
  - globcrm-web/package.json
autonomous: true
must_haves:
  truths:
    - "User can view activities in day, week, and month calendar views"
    - "User can switch between dayGridMonth, timeGridWeek, and timeGridDay views"
    - "User can drag-and-drop events to reschedule with optimistic update and revert on failure"
    - "User can click a date/time slot to create a new activity pre-filled with that date"
    - "User can filter calendar by activity type, owner, or linked entity"
    - "Calendar loads events by date range (not paginated) for efficient rendering"
  artifacts:
    - path: "globcrm-web/src/app/features/calendar/calendar.component.ts"
      provides: "Unified calendar page with FullCalendar day/week/month views"
      contains: "class CalendarComponent"
    - path: "globcrm-web/src/app/features/calendar/calendar.service.ts"
      provides: "CalendarService for date-range event queries with filters"
      contains: "class CalendarService"
    - path: "globcrm-web/src/app/features/calendar/calendar.routes.ts"
      provides: "Calendar route configuration"
      contains: "CALENDAR_ROUTES"
  key_links:
    - from: "CalendarComponent"
      to: "CalendarService"
      via: "DI injection for event loading"
      pattern: "inject(CalendarService)"
    - from: "CalendarService"
      to: "/api/calendar"
      via: "ApiService HTTP call with date range params"
      pattern: "api/calendar"
    - from: "CalendarComponent eventDrop"
      to: "ActivityService"
      via: "PATCH dueDate on drag-and-drop"
      pattern: "activityService|updateDueDate|eventDrop"
---

<objective>
Create a unified calendar page with FullCalendar day/week/month views, drag-and-drop rescheduling, date-click creation, and filters by type/owner/entity. Install @fullcalendar/timegrid for time-based views.

Purpose: Delivers CALR-01 (day/week/month views), CALR-02 (create from calendar), CALR-03 (drag-and-drop reschedule), CALR-04 (multi-entity activities), CALR-05 (filters).
Output: Unified CalendarComponent at /calendar route with full FullCalendar integration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-and-completeness/11-RESEARCH.md
@.planning/phases/11-polish-and-completeness/11-02-SUMMARY.md

@globcrm-web/src/app/features/activities/activity-calendar/activity-calendar.component.ts
@globcrm-web/src/app/features/activities/activity-calendar/activity-calendar.component.html
@globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.ts
@globcrm-web/src/app/features/activities/activity.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @fullcalendar/timegrid + CalendarService</name>
  <files>
    globcrm-web/src/app/features/calendar/calendar.service.ts
    globcrm-web/src/app/features/calendar/calendar.routes.ts
    globcrm-web/package.json
  </files>
  <action>
    Install @fullcalendar/timegrid:
    ```
    cd globcrm-web
    npm install @fullcalendar/timegrid@^6.1.20
    ```

    Create calendar.service.ts:
    - Inject ApiService
    - getEvents(start: string, end: string, filters?: { type?: string, ownerId?: string, entityType?: string, entityId?: string }): Observable<CalendarEventDto[]>
      - GET /api/calendar with query params: start, end, type, ownerId, entityType, entityId
      - Returns CalendarEventDto[]: id, title, start, end, color, extendedProps (type, status, priority, assignedToName, ownerName)
    - updateActivityDueDate(activityId: string, newDate: string): Observable<void>
      - PATCH /api/activities/{activityId} with body { dueDate: newDate }
      - Or use existing ActivityService.update() if it supports partial update
      - Check existing ActivitiesController -- if there's a PATCH endpoint for dueDate, use it. Otherwise, use PUT with the full activity object from a GET first. Simplest approach: add a lightweight PATCH endpoint or use existing update.
      - Actually, check if ActivityService already has an update method that can handle just a dueDate change. If the PUT requires all fields, just send the existing data with the new dueDate.

    Create calendar.routes.ts:
    ```typescript
    export const CALENDAR_ROUTES: Routes = [
      { path: '', component: CalendarComponent },
    ];
    ```
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- compiles with timegrid plugin.
  </verify>
  <done>@fullcalendar/timegrid installed. CalendarService queries /api/calendar with date range and optional filters. Routes configured.</done>
</task>

<task type="auto">
  <name>Task 2: CalendarComponent with day/week/month views, drag-drop, filters</name>
  <files>
    globcrm-web/src/app/features/calendar/calendar.component.ts
    globcrm-web/src/app/features/calendar/calendar.component.html
    globcrm-web/src/app/features/calendar/calendar.component.scss
  </files>
  <action>
    Create CalendarComponent with separate template and styles files:

    Component class:
    - Inject CalendarService, ActivityService, Router, MatSnackBar, ProfileService (for owner dropdown)
    - Signals: isLoading, events (CalendarEventDto[]), filterType (string | null), filterOwnerId (string | null)
    - FullCalendar plugins: [dayGridPlugin, timeGridPlugin, interactionPlugin]
    - calendarOptions signal with:
      - initialView: 'dayGridMonth'
      - headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' }
      - editable: true (enables drag-and-drop)
      - eventStartEditable: true
      - eventDurationEditable: true
      - snapDuration: '00:15:00' (15-min snap)
      - slotDuration: '00:30:00' (30-min slots)
      - allDaySlot: true
      - height: 'auto'
      - eventDrop: handleEventDrop (drag-and-drop reschedule)
      - dateClick: handleDateClick (create new activity)
      - eventClick: handleEventClick (navigate to activity detail)
      - datesSet: handleDatesSet (reload events when date range changes)
      - events: [] (populated by service call)

    handleDatesSet(dateInfo): Called when FullCalendar date range changes (view switch or navigation).
    - Extract start/end ISO strings from dateInfo
    - Call CalendarService.getEvents(start, end, { type: filterType, ownerId: filterOwnerId })
    - Map response to FullCalendar EventInput objects with priority-based coloring
    - Update calendarOptions.events

    Priority colors (matching existing activity calendar):
    - Low: #4caf50 (green), Medium: #2196f3 (blue), High: #ff9800 (orange), Urgent: #f44336 (red)

    handleEventDrop(info: EventDropArg): Optimistic reschedule.
    - Get new date from info.event.start
    - Call CalendarService.updateActivityDueDate(id, newDate)
    - On error: call info.revert() to snap event back + show snackbar "Failed to reschedule"

    handleDateClick(info: DateClickArg): Create new activity.
    - Navigate to /activities/new with queryParams { dueDate: info.dateStr }
    - The activity form should read dueDate from query params to pre-fill (check if it already does; if not, note that the activity form will need a minor update to read queryParams.dueDate)

    handleEventClick(info): Navigate to activity detail.
    - this.router.navigate(['/activities', info.event.id])

    Filter controls (above calendar):
    - Activity type dropdown: mat-select with options from ACTIVITY_TYPES constant (Task, Call, Meeting, etc.) + "All Types" option
    - Owner dropdown: mat-select populated from ProfileService.getTeamDirectory (pageSize: 100) + "All Owners" option
    - When filter changes: reload events with new filter params
    - Use reactive approach: effect() watching filter signals, debounced reload

    Template structure:
    - Page header: "Calendar" title with calendar_month icon
    - Filter bar: type dropdown + owner dropdown in a flex row
    - FullCalendar component: `<full-calendar [options]="calendarOptions()" />`
    - Loading overlay: mat-progress-bar when isLoading

    Styling:
    - Match existing page layout patterns (_entity-list.scss class structure)
    - Filter bar with gap, flex-wrap for responsive
    - FullCalendar overrides: event font-size, cursor pointer on events
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` -- builds successfully.
  </verify>
  <done>CalendarComponent shows activities in day/week/month views with FullCalendar. Drag-and-drop reschedules with optimistic update and revert on failure. Date click navigates to activity creation. Event click navigates to activity detail. Filters by type and owner above calendar.</done>
</task>

</tasks>

<verification>
- `ng build` succeeds
- CalendarComponent renders FullCalendar with three view options (month, week, day)
- View switcher buttons visible in calendar header toolbar
- Drag-and-drop calls API and reverts on failure
- Date click navigates to /activities/new?dueDate=...
- Event click navigates to /activities/{id}
- Filter dropdowns for type and owner update calendar events
- datesSet handler reloads events when navigating or switching views
</verification>

<success_criteria>
Unified calendar page at /calendar displays activities from all entities in day/week/month views. Drag-and-drop rescheduling works with optimistic update pattern. Filters by activity type and owner. Date-click and event-click navigation functional.
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-and-completeness/11-05-SUMMARY.md`
</output>
