---
phase: 07-email-integration
plan: 07
type: execute
wave: 4
depends_on: ["07-03", "07-06"]
files_modified: []
autonomous: false
user_setup:
  - service: google-cloud
    why: "Gmail API OAuth 2.0 credentials required for email integration"
    env_vars:
      - name: "Gmail:ClientId"
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: "Gmail:ClientSecret"
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create Google Cloud project (or use existing)"
        location: "https://console.cloud.google.com"
      - task: "Enable Gmail API"
        location: "APIs & Services -> Library -> search 'Gmail API' -> Enable"
      - task: "Configure OAuth consent screen"
        location: "APIs & Services -> OAuth consent screen -> External -> Add gmail.modify scope"
      - task: "Create OAuth 2.0 Client ID (Web application)"
        location: "APIs & Services -> Credentials -> Create Credentials -> OAuth Client ID"
      - task: "Add authorized redirect URI: http://localhost:5233/api/email-accounts/callback"
        location: "OAuth Client ID settings -> Authorized redirect URIs"
      - task: "Add test user email to OAuth consent screen"
        location: "APIs & Services -> OAuth consent screen -> Test users -> Add users"
      - task: "Copy Client ID and Client Secret to appsettings.Development.json Gmail section"
        location: "APIs & Services -> Credentials -> OAuth 2.0 Client ID -> Copy"

must_haves:
  truths:
    - "User can connect Gmail account via OAuth flow in settings page"
    - "System syncs emails from Gmail after account connection"
    - "Emails appear in CRM email list and are linked to contacts"
    - "User can send email from CRM compose dialog"
    - "Email thread view shows conversation with chronological messages"
    - "Emails tab on Contact detail shows linked emails"
    - "Emails tab on Company detail shows linked emails"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification checkpoint: configure Google Cloud OAuth credentials, connect Gmail account, verify bidirectional sync and email sending.

Purpose: Verify the complete email integration works end-to-end before marking the phase complete. This checkpoint requires human action (Google Cloud Console setup) and human verification (testing the full flow).
Output: Verified email integration with connected Gmail account
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-01-SUMMARY.md
@.planning/phases/07-email-integration/07-02-SUMMARY.md
@.planning/phases/07-email-integration/07-03-SUMMARY.md
@.planning/phases/07-email-integration/07-04-SUMMARY.md
@.planning/phases/07-email-integration/07-05-SUMMARY.md
@.planning/phases/07-email-integration/07-06-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure Google Cloud OAuth credentials</name>
  <files></files>
  <action>
    User must set up Google Cloud Console for Gmail API OAuth:

    1. Go to https://console.cloud.google.com
    2. Create a new project (or use existing) named "GlobCRM"
    3. Enable the Gmail API: APIs & Services -> Library -> search "Gmail API" -> Enable
    4. Configure OAuth consent screen:
       - User Type: External
       - App name: GlobCRM
       - Support email: your email
       - Scopes: Add "https://www.googleapis.com/auth/gmail.modify"
       - Test users: Add your Gmail address (the one you'll connect)
    5. Create OAuth 2.0 credentials:
       - APIs & Services -> Credentials -> Create Credentials -> OAuth Client ID
       - Application type: Web application
       - Name: GlobCRM Dev
       - Authorized redirect URIs: http://localhost:5233/api/email-accounts/callback
    6. Copy the Client ID and Client Secret
    7. Update src/GlobCRM.Api/appsettings.Development.json:
       ```json
       "Gmail": {
         "ClientId": "YOUR_CLIENT_ID.apps.googleusercontent.com",
         "ClientSecret": "YOUR_CLIENT_SECRET"
       }
       ```
    8. Ensure the database is up to date: run `dotnet ef database update --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext`
    9. Type "configured" when Google Cloud credentials are set up and appsettings updated.
  </action>
  <verify>appsettings.Development.json contains non-empty Gmail:ClientId and Gmail:ClientSecret values.</verify>
  <done>Google Cloud project created with Gmail API enabled, OAuth consent screen configured, OAuth 2.0 Client ID created with correct redirect URI, credentials copied to appsettings.Development.json.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end email integration</name>
  <files></files>
  <action>
    Human verification of complete Phase 7 email integration:

    Start both backend and frontend:
    1. Run backend: `cd src/GlobCRM.Api && dotnet run`
    2. Run frontend: `cd globcrm-web && npx ng serve`
    3. Log in to the CRM

    **Test Gmail Connection:**
    4. Navigate to Settings -> Email Account
    5. Click "Connect Gmail" button
    6. Should redirect to Google OAuth consent screen
    7. Grant access with your Gmail account
    8. Should redirect back to settings page with "connected" status
    9. Verify Gmail address is displayed, status shows "Active"

    **Test Email Sync:**
    10. Click "Sync Now" button on settings page
    11. Navigate to Emails page (navbar link)
    12. Should see recent emails from your Gmail inbox
    13. Emails from known contacts should show linked contact names

    **Test Email Send:**
    14. Click "Compose" button on email list page
    15. Enter a recipient, subject, and body
    16. Click Send
    17. Verify email appears in your Gmail sent folder
    18. Verify email appears in CRM email list (after sync)

    **Test Thread View:**
    19. Click on an email that is part of a thread
    20. Should see all messages in the thread chronologically
    21. Most recent message should be expanded by default
    22. Click "Reply" -> compose dialog should have pre-filled thread context

    **Test Entity Tabs:**
    23. Navigate to a Contact that has received/sent emails
    24. Click the Emails tab
    25. Should see emails linked to this contact
    26. Click an email to navigate to detail view

    27. Navigate to a Company with linked contacts who have emails
    28. Click the Emails tab
    29. Should see company-scoped emails

    Type "approved" if all tests pass, or describe any issues found.
  </action>
  <verify>All 5 test areas pass: Gmail connection, email sync, email send, thread view, entity tabs.</verify>
  <done>All MAIL-01 through MAIL-07 requirements verified. Phase 7 complete.</done>
</task>

</tasks>

<verification>
- Google Cloud OAuth credentials configured and working
- Gmail account connects successfully via OAuth
- Background sync imports recent emails
- Sent emails appear in Gmail
- Thread view shows conversation correctly
- Entity tabs show linked emails
- Contact auto-linking works for known contacts
</verification>

<success_criteria>
- Complete OAuth flow works (connect, consent, callback, account created)
- Sync populates email list with real Gmail messages
- Send delivers email through Gmail API
- Thread view groups messages correctly
- Entity tabs load contact/company-scoped emails
- No errors in backend logs during sync cycle
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-07-SUMMARY.md`
</output>
