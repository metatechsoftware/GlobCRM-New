---
phase: 07-email-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/EmailAccount.cs
  - src/GlobCRM.Domain/Entities/EmailMessage.cs
  - src/GlobCRM.Domain/Entities/EmailThread.cs
  - src/GlobCRM.Domain/Enums/EmailSyncStatus.cs
  - src/GlobCRM.Domain/Interfaces/IEmailAccountRepository.cs
  - src/GlobCRM.Domain/Interfaces/IEmailMessageRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/EmailAccountConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/EmailMessageConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/EmailThreadConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "EmailAccount entity stores per-user OAuth connection with encrypted token fields"
    - "EmailMessage entity stores synced emails with Gmail identifiers and contact/company linking"
    - "EmailThread entity groups messages by Gmail thread ID"
    - "EF Core migration creates email_accounts, email_messages, and email_threads tables"
    - "RLS policies enforce tenant isolation on all three email tables"
    - "Unique composite index on (tenant_id, gmail_message_id) prevents duplicate synced messages"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/EmailAccount.cs"
      provides: "Per-user Gmail OAuth connection with token storage and sync state"
      contains: "class EmailAccount"
    - path: "src/GlobCRM.Domain/Entities/EmailMessage.cs"
      provides: "Synced email message with metadata, direction, and contact/company links"
      contains: "class EmailMessage"
    - path: "src/GlobCRM.Domain/Entities/EmailThread.cs"
      provides: "Thread grouping by Gmail thread ID"
      contains: "class EmailThread"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and query filters for email entities"
      contains: "DbSet<EmailAccount>"
  key_links:
    - from: "src/GlobCRM.Domain/Entities/EmailMessage.cs"
      to: "src/GlobCRM.Domain/Entities/EmailAccount.cs"
      via: "EmailAccountId FK for ownership"
      pattern: "EmailAccountId"
    - from: "src/GlobCRM.Domain/Entities/EmailMessage.cs"
      to: "src/GlobCRM.Domain/Entities/Contact.cs"
      via: "LinkedContactId nullable FK for auto-linking"
      pattern: "LinkedContactId"
---

<objective>
Create all backend domain entities, enum, EF Core configurations, database migration, and RLS policies for the Email subsystem (EmailAccount, EmailMessage, EmailThread).

Purpose: Establish the complete data model for email integration that all subsequent plans (Gmail services, API controllers, frontend) depend on.
Output: Domain entities, EF Core configs, AddEmailIntegration migration, RLS policies
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md

# Pattern references (read these to match conventions exactly)
@src/GlobCRM.Domain/Entities/Activity.cs
@src/GlobCRM.Domain/Entities/Quote.cs
@src/GlobCRM.Domain/Entities/Contact.cs
@src/GlobCRM.Domain/Entities/Company.cs
@src/GlobCRM.Domain/Interfaces/IActivityRepository.cs
@src/GlobCRM.Domain/Interfaces/IQuoteRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/QuoteConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Email domain entities, enum, and repository interfaces</name>
  <files>
    src/GlobCRM.Domain/Entities/EmailAccount.cs
    src/GlobCRM.Domain/Entities/EmailMessage.cs
    src/GlobCRM.Domain/Entities/EmailThread.cs
    src/GlobCRM.Domain/Enums/EmailSyncStatus.cs
    src/GlobCRM.Domain/Interfaces/IEmailAccountRepository.cs
    src/GlobCRM.Domain/Interfaces/IEmailMessageRepository.cs
  </files>
  <action>
    Create all domain layer files following exact patterns from Activity and Quote entities:

    **EmailSyncStatus enum** (src/GlobCRM.Domain/Enums/EmailSyncStatus.cs):
    - Values: Active, Paused, Error, Disconnected
    - Follow ActivityStatus enum pattern (simple enum, no attributes)

    **EmailAccount entity** (src/GlobCRM.Domain/Entities/EmailAccount.cs):
    - Id (Guid, NewGuid default), TenantId (Guid)
    - UserId (Guid) -- FK to ApplicationUser, the CRM user who owns this connection
    - GmailAddress (string) -- the connected Gmail address
    - EncryptedAccessToken (string) -- encrypted OAuth access token
    - EncryptedRefreshToken (string) -- encrypted OAuth refresh token
    - TokenIssuedAt (DateTimeOffset) -- when current access token was issued
    - TokenExpiresAt (DateTimeOffset) -- when access token expires
    - LastHistoryId (ulong?) -- Gmail history ID for incremental sync
    - LastSyncAt (DateTimeOffset?) -- timestamp of last successful sync
    - SyncStatus (EmailSyncStatus, default Active)
    - ErrorMessage (string?) -- stores last error for Error status
    - CreatedAt, UpdatedAt (DateTimeOffset)
    - Navigation: User (ApplicationUser)
    - NOTE: One account per user per tenant enforced by unique index

    **EmailMessage entity** (src/GlobCRM.Domain/Entities/EmailMessage.cs):
    - Id (Guid, NewGuid default), TenantId (Guid)
    - EmailAccountId (Guid) -- FK to EmailAccount
    - GmailMessageId (string) -- Gmail's message ID (unique per tenant)
    - GmailThreadId (string) -- Gmail's thread ID for grouping
    - Subject (string)
    - FromAddress (string), FromName (string)
    - ToAddresses (string) -- JSON array stored as string
    - CcAddresses (string?) -- JSON array stored as string
    - BccAddresses (string?) -- JSON array stored as string
    - BodyPreview (string?) -- first ~200 chars for list display
    - BodyHtml (string?) -- full HTML body
    - BodyText (string?) -- plain text body
    - HasAttachments (bool)
    - IsInbound (bool) -- true=received, false=sent from CRM
    - IsRead (bool)
    - IsStarred (bool)
    - LinkedContactId (Guid?) -- FK to Contact (auto-linked)
    - LinkedCompanyId (Guid?) -- FK to Company (auto-linked via contact)
    - LinkedContact (Contact?), LinkedCompany (Company?)
    - EmailAccount (EmailAccount) navigation
    - SentAt (DateTimeOffset) -- original email send timestamp
    - SyncedAt (DateTimeOffset) -- when synced to CRM
    - CreatedAt, UpdatedAt (DateTimeOffset)

    **EmailThread entity** (src/GlobCRM.Domain/Entities/EmailThread.cs):
    - Id (Guid, NewGuid default), TenantId (Guid)
    - GmailThreadId (string) -- Gmail's thread ID (unique per tenant)
    - Subject (string) -- subject of first message in thread
    - Snippet (string?) -- preview text
    - MessageCount (int, default 0)
    - LastMessageAt (DateTimeOffset) -- timestamp of most recent message
    - LinkedContactId (Guid?) -- FK to Contact (auto-linked from messages)
    - LinkedCompanyId (Guid?) -- FK to Company
    - LinkedContact (Contact?), LinkedCompany (Company?)
    - CreatedAt, UpdatedAt (DateTimeOffset)

    **IEmailAccountRepository** (src/GlobCRM.Domain/Interfaces/IEmailAccountRepository.cs):
    - GetByUserIdAsync(Guid userId) -- get current user's email account
    - GetAllActiveAccountsAsync() -- for background sync (all tenants' active accounts)
    - CreateAsync(EmailAccount), UpdateAsync(EmailAccount), DeleteAsync(Guid)

    **IEmailMessageRepository** (src/GlobCRM.Domain/Interfaces/IEmailMessageRepository.cs):
    - GetPagedAsync(EntityQueryParams params) -- for email list view
    - GetByIdAsync(Guid id) -- single message detail
    - GetByThreadIdAsync(string gmailThreadId) -- all messages in a thread
    - GetByContactIdAsync(Guid contactId, EntityQueryParams params) -- emails for contact detail tab
    - GetByCompanyIdAsync(Guid companyId, EntityQueryParams params) -- emails for company detail tab
    - CreateAsync(EmailMessage), UpdateAsync(EmailMessage), DeleteAsync(Guid)
    - ExistsByGmailMessageIdAsync(string gmailMessageId) -- duplicate check before sync
    - UpsertByGmailMessageIdAsync(EmailMessage message) -- insert or update on sync
    - GetThreadAsync(string gmailThreadId) -- get or create EmailThread
    - UpdateThreadAsync(EmailThread thread) -- update thread after message sync

    Also update Contact.cs and Company.cs to add navigation collections: ICollection<EmailMessage> EmailMessages (follow existing ICollection<Quote> Quotes pattern).
  </action>
  <verify>dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj -- should compile with 0 errors</verify>
  <done>All 6 domain files created. EmailAccount has encrypted token fields and sync status. EmailMessage has Gmail IDs, metadata, and contact/company auto-linking FKs. EmailThread groups messages by Gmail thread ID. Repository interfaces define all needed queries for sync, list, detail, and entity-scoped views.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update DbContext, add RLS policies, and generate migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/EmailAccountConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/EmailMessageConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/EmailThreadConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create EF Core configurations following ActivityConfiguration and QuoteConfiguration patterns exactly:

    **EmailAccountConfiguration** (table: "email_accounts"):
    - snake_case column names for all properties
    - GmailAddress: HasMaxLength(320), IsRequired
    - EncryptedAccessToken: IsRequired (no max length -- encrypted data varies)
    - EncryptedRefreshToken: IsRequired
    - SyncStatus: HasConversion<string>() with HasMaxLength(20)
    - ErrorMessage: HasMaxLength(2000)
    - LastHistoryId: HasColumnType("bigint") -- ulong maps to bigint in PostgreSQL
    - UserId FK: DeleteBehavior.Cascade (if user deleted, remove email account)
    - Indexes:
      - idx_email_accounts_tenant on (tenant_id)
      - idx_email_accounts_user UNIQUE on (tenant_id, user_id) -- one account per user per tenant
      - idx_email_accounts_sync_status on (sync_status) -- for background service to find active accounts

    **EmailMessageConfiguration** (table: "email_messages"):
    - snake_case column names for all properties
    - GmailMessageId: HasMaxLength(100), IsRequired
    - GmailThreadId: HasMaxLength(100), IsRequired
    - Subject: HasMaxLength(1000)
    - FromAddress: HasMaxLength(320), IsRequired
    - FromName: HasMaxLength(500)
    - ToAddresses: HasColumnType("jsonb"), IsRequired -- JSON array
    - CcAddresses: HasColumnType("jsonb") -- nullable JSON array
    - BccAddresses: HasColumnType("jsonb") -- nullable JSON array
    - BodyPreview: HasMaxLength(500)
    - BodyHtml, BodyText: no max length (full email body)
    - EmailAccountId FK: DeleteBehavior.Cascade (delete messages when account disconnected)
    - LinkedContactId FK: DeleteBehavior.SetNull
    - LinkedCompanyId FK: DeleteBehavior.SetNull
    - Indexes:
      - idx_email_messages_tenant_gmail_id UNIQUE on (tenant_id, gmail_message_id) -- prevent duplicates
      - idx_email_messages_thread on (gmail_thread_id) -- thread view lookups
      - idx_email_messages_contact on (linked_contact_id) -- contact detail emails tab
      - idx_email_messages_company on (linked_company_id) -- company detail emails tab
      - idx_email_messages_sent_at on (tenant_id, sent_at DESC) -- chronological listing
      - idx_email_messages_account on (email_account_id) -- account's messages

    **EmailThreadConfiguration** (table: "email_threads"):
    - snake_case column names for all properties
    - GmailThreadId: HasMaxLength(100), IsRequired
    - Subject: HasMaxLength(1000)
    - Snippet: HasMaxLength(500)
    - LinkedContactId FK: DeleteBehavior.SetNull
    - LinkedCompanyId FK: DeleteBehavior.SetNull
    - Indexes:
      - idx_email_threads_tenant_gmail_id UNIQUE on (tenant_id, gmail_thread_id)
      - idx_email_threads_contact on (linked_contact_id)
      - idx_email_threads_company on (linked_company_id)
      - idx_email_threads_last_message on (tenant_id, last_message_at DESC)

    **ApplicationDbContext updates:**
    - Add DbSets: EmailAccounts, EmailMessages, EmailThreads
    - Add query filters for all three entities (tenant isolation): entity.TenantId == _tenantId

    **RLS policies** (scripts/rls-setup.sql):
    - Add RLS policies for "email_accounts", "email_messages", and "email_threads" tables
    - Enable ROW LEVEL SECURITY and FORCE ROW LEVEL SECURITY on all three tables
    - CREATE POLICY with tenant_id = current_setting('app.current_tenant')::uuid

    **Generate migration:**
    - Run: dotnet ef migrations add AddEmailIntegration --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext --output-dir Persistence/Migrations/App
  </action>
  <verify>dotnet build -- should compile with 0 errors. Migration file should exist in src/GlobCRM.Infrastructure/Persistence/Migrations/App/ with AddEmailIntegration in the filename.</verify>
  <done>3 EF Core configurations created with snake_case naming, proper FK constraints, unique indexes for Gmail ID deduplication. ApplicationDbContext has 3 new DbSets and 3 new query filters. RLS policies added for all email tables. Migration generated successfully.</done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with 0 errors
- All 9+ new files exist on disk
- Migration file contains CREATE TABLE for email_accounts, email_messages, email_threads
- UNIQUE index exists on (tenant_id, gmail_message_id) for dedup
- UNIQUE index exists on (tenant_id, user_id) for one-account-per-user
- RLS policies added for all three tables in rls-setup.sql
</verification>

<success_criteria>
- All domain entities created with correct properties and navigation properties
- EF Core configurations use snake_case naming and proper FK constraints
- EmailMessage has unique composite index preventing duplicate Gmail messages
- EmailAccount has unique composite index enforcing one-per-user
- Migration generates without errors
- RLS policies enforce tenant isolation on all email tables
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-01-SUMMARY.md`
</output>
