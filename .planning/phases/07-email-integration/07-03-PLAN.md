---
phase: 07-email-integration
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - src/GlobCRM.Infrastructure/Persistence/Repositories/EmailAccountRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/EmailMessageRepository.cs
  - src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs
  - src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  - src/GlobCRM.Api/Controllers/EmailAccountsController.cs
  - src/GlobCRM.Api/Controllers/EmailsController.cs
  - src/GlobCRM.Api/Program.cs
autonomous: true

must_haves:
  truths:
    - "EmailAccountRepository and EmailMessageRepository implement all interface methods"
    - "EmailSyncBackgroundService polls every 5 minutes calling GmailSyncService"
    - "EmailAccountsController handles OAuth connect/callback/disconnect flow"
    - "EmailsController provides list, detail, thread view, send, and entity-scoped endpoints"
    - "Background service and Gmail services registered in Program.cs DI"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/EmailAccountRepository.cs"
      provides: "Repository for email account CRUD and active account queries"
      contains: "class EmailAccountRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/EmailMessageRepository.cs"
      provides: "Repository for email messages with paged queries, thread, and entity-scoped lookups"
      contains: "class EmailMessageRepository"
    - path: "src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs"
      provides: "Background polling service for periodic email sync"
      contains: "class EmailSyncBackgroundService"
    - path: "src/GlobCRM.Api/Controllers/EmailAccountsController.cs"
      provides: "OAuth flow endpoints: connect, callback, disconnect, status"
      contains: "class EmailAccountsController"
    - path: "src/GlobCRM.Api/Controllers/EmailsController.cs"
      provides: "Email CRUD, thread view, send, contact/company-scoped endpoints"
      contains: "class EmailsController"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/EmailAccountsController.cs"
      to: "src/GlobCRM.Infrastructure/Gmail/GmailOAuthService.cs"
      via: "OAuth flow orchestration"
      pattern: "GmailOAuthService"
    - from: "src/GlobCRM.Api/Controllers/EmailsController.cs"
      to: "src/GlobCRM.Infrastructure/Gmail/GmailSendService.cs"
      via: "Send endpoint delegates to GmailSendService"
      pattern: "GmailSendService"
    - from: "src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs"
      to: "src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs"
      via: "Polling loop calls SyncAllAccountsAsync"
      pattern: "GmailSyncService"
---

<objective>
Create email repositories, background sync service, and both API controllers (EmailAccountsController for OAuth flow, EmailsController for email operations).

Purpose: Wire the Gmail infrastructure to the API layer. This plan connects domain entities (Plan 01) with Gmail services (Plan 02) through repositories and controllers, and starts the background sync engine.
Output: 2 repositories, 1 background service, 2 API controllers, updated DI registration
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md
@.planning/phases/07-email-integration/07-01-SUMMARY.md
@.planning/phases/07-email-integration/07-02-SUMMARY.md

# Pattern references
@src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/QuoteRepository.cs
@src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
@src/GlobCRM.Api/Controllers/ActivitiesController.cs
@src/GlobCRM.Api/Controllers/QuotesController.cs
@src/GlobCRM.Api/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Email repositories and background sync service</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Repositories/EmailAccountRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/EmailMessageRepository.cs
    src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs
    src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
    src/GlobCRM.Api/Program.cs
  </files>
  <action>
    **EmailAccountRepository** (following QuoteRepository pattern):
    - Inject ApplicationDbContext
    - GetByUserIdAsync(Guid userId): query EmailAccounts where UserId == userId, FirstOrDefaultAsync
    - GetAllActiveAccountsAsync(): query EmailAccounts where SyncStatus == Active, use IgnoreQueryFilters() since this is called by background service across all tenants. Return list with TenantId populated.
    - CreateAsync, UpdateAsync, DeleteAsync: standard CRUD pattern matching QuoteRepository

    **EmailMessageRepository** (following ActivityRepository pattern for paged queries):
    - Inject ApplicationDbContext
    - GetPagedAsync(EntityQueryParams params): paged query with sorting and filtering
      - Default sort: SentAt DESC
      - Support search on Subject, FromAddress, FromName, BodyPreview
      - Support filter on IsInbound, IsRead, HasAttachments
      - Include LinkedContact name and LinkedCompany name in results (optional join)
    - GetByIdAsync(Guid id): single message with LinkedContact, LinkedCompany includes
    - GetByThreadIdAsync(string gmailThreadId): all messages with matching GmailThreadId, ordered by SentAt ASC (chronological for thread view)
    - GetByContactIdAsync(Guid contactId, EntityQueryParams params): paged, filtered by LinkedContactId
    - GetByCompanyIdAsync(Guid companyId, EntityQueryParams params): paged, filtered by LinkedCompanyId
    - CreateAsync, UpdateAsync, DeleteAsync: standard CRUD
    - ExistsByGmailMessageIdAsync(string gmailMessageId): AnyAsync with GmailMessageId match
    - UpsertByGmailMessageIdAsync(EmailMessage message): check exists, create or update
    - GetThreadAsync(string gmailThreadId): query EmailThreads by GmailThreadId, create new if not exists
    - UpdateThreadAsync(EmailThread thread): update thread stats (MessageCount, LastMessageAt, etc.)

    **EmailSyncBackgroundService** (src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs):
    - Inherits BackgroundService (Microsoft.Extensions.Hosting)
    - Inject IServiceScopeFactory, ILogger<EmailSyncBackgroundService>, IConfiguration
    - Read sync interval from config: Gmail:SyncIntervalMinutes (default 5)
    - ExecuteAsync(CancellationToken stoppingToken):
      - While loop with stoppingToken check
      - Create scope via _scopeFactory.CreateScope()
      - Resolve GmailSyncService from scope
      - Call syncService.SyncAllAccountsAsync(stoppingToken)
      - Catch and log exceptions (never let sync crash the background service)
      - await Task.Delay(interval, stoppingToken) -- catch OperationCanceledException on shutdown
    - Log at Information level: "Email sync cycle started", "Email sync cycle completed in {elapsed}ms"
    - Log at Error level on failure: "Email sync cycle failed: {message}"

    **Update CrmEntityServiceExtensions:**
    - Add to AddCrmEntityServices method:
      - services.AddScoped<IEmailAccountRepository, EmailAccountRepository>();
      - services.AddScoped<IEmailMessageRepository, EmailMessageRepository>();

    **Update Program.cs:**
    - Add after existing service registrations:
      - builder.Services.AddGmailServices(); (from GmailServiceExtensions)
      - builder.Services.AddHostedService<EmailSyncBackgroundService>(); (register background service)
    - Add required using statement for Gmail namespace
  </action>
  <verify>dotnet build -- should compile with 0 errors. Program.cs should contain AddGmailServices and AddHostedService calls.</verify>
  <done>EmailAccountRepository and EmailMessageRepository implement all interface methods with proper query patterns. EmailSyncBackgroundService polls every 5 minutes. Repositories registered in CrmEntityServiceExtensions. Gmail services and background service registered in Program.cs.</done>
</task>

<task type="auto">
  <name>Task 2: Create EmailAccountsController and EmailsController</name>
  <files>
    src/GlobCRM.Api/Controllers/EmailAccountsController.cs
    src/GlobCRM.Api/Controllers/EmailsController.cs
  </files>
  <action>
    **EmailAccountsController** (src/GlobCRM.Api/Controllers/EmailAccountsController.cs):
    - [ApiController], [Route("api/[controller]")], [Authorize]
    - Inject: GmailOAuthService, TokenEncryptionService, IEmailAccountRepository, ITenantProvider, ILogger
    - Get current userId from User.FindFirstValue(ClaimTypes.NameIdentifier)

    Endpoints:

    1. GET /api/email-accounts/status
       - Returns current user's email account status (connected/disconnected, gmail address, last sync, sync status)
       - If no account exists, return { connected: false }
       - If account exists, return { connected: true, gmailAddress, lastSyncAt, syncStatus, errorMessage }

    2. GET /api/email-accounts/connect
       - Generate a state parameter (random string or JWT with userId for CSRF protection)
       - Store state in session/cache or encode userId in state
       - Call GmailOAuthService.GetAuthorizationUrl(state)
       - Return { authorizationUrl: string } -- frontend redirects browser to this URL

    3. GET /api/email-accounts/callback?code={code}&state={state}
       - This is the OAuth redirect endpoint -- Google redirects here after user consents
       - Validate state parameter (extract userId, verify CSRF)
       - Call GmailOAuthService.ExchangeCodeAsync(code) to get TokenResponse
       - Encrypt tokens: TokenEncryptionService.Encrypt(accessToken), Encrypt(refreshToken)
       - Get user's Gmail address: create temp GmailService, call Users.GetProfile("me") to get emailAddress
       - Create or update EmailAccount entity with encrypted tokens, gmail address, sync status Active
       - Save via IEmailAccountRepository
       - Redirect browser back to Angular settings page: Redirect("/settings/email-accounts?connected=true")
       - NOTE: This is a GET endpoint that returns a Redirect, not JSON (it's an OAuth callback)

    4. POST /api/email-accounts/disconnect
       - Get current user's EmailAccount
       - If exists: revoke token via GmailOAuthService.RevokeTokenAsync, then delete account
       - Delete cascades to all EmailMessages (per FK config)
       - Return 204 NoContent

    5. POST /api/email-accounts/sync
       - Trigger manual sync for current user's account (don't wait for background service)
       - Get account, create GmailService, call GmailSyncService.SyncAccountAsync
       - Return 200 with sync result summary

    **EmailsController** (src/GlobCRM.Api/Controllers/EmailsController.cs):
    - [ApiController], [Route("api/[controller]")], [Authorize]
    - Inject: IEmailMessageRepository, IEmailAccountRepository, GmailSendService, ITenantProvider
    - Follow ActivitiesController pattern for CRUD structure

    Endpoints:

    1. GET /api/emails
       - Accept EntityQueryParams (page, pageSize, sortField, sortDirection, search, filters)
       - Call IEmailMessageRepository.GetPagedAsync
       - Return PagedResult<EmailListDto>
       - EmailListDto: id, subject, fromAddress, fromName, toAddresses (parsed), bodyPreview, sentAt, isInbound, isRead, isStarred, hasAttachments, gmailThreadId, linkedContactName?, linkedCompanyName?

    2. GET /api/emails/{id}
       - Call IEmailMessageRepository.GetByIdAsync
       - Return EmailDetailDto: extends EmailListDto + bodyHtml, bodyText, ccAddresses, bccAddresses, linkedContactId?, linkedCompanyId?, emailAccountId, gmailMessageId, syncedAt

    3. GET /api/emails/thread/{gmailThreadId}
       - Call IEmailMessageRepository.GetByThreadIdAsync
       - Return EmailThreadDto: threadId, subject, messageCount, messages: EmailDetailDto[] (ordered chronologically)

    4. POST /api/emails/send
       - Accept SendEmailRequest: to, subject, htmlBody, replyToThreadId? (optional)
       - Get current user's EmailAccount (must be connected)
       - If not connected, return 400 "No Gmail account connected"
       - Call GmailSendService.SendEmailAsync
       - Return created EmailDetailDto

    5. GET /api/emails/by-contact/{contactId}
       - Accept EntityQueryParams
       - Call IEmailMessageRepository.GetByContactIdAsync
       - Return PagedResult<EmailListDto> -- for contact detail Emails tab

    6. GET /api/emails/by-company/{companyId}
       - Accept EntityQueryParams
       - Call IEmailMessageRepository.GetByCompanyIdAsync
       - Return PagedResult<EmailListDto> -- for company detail Emails tab

    7. PATCH /api/emails/{id}/read
       - Mark email as read (update IsRead = true)
       - Return 204 NoContent

    8. PATCH /api/emails/{id}/star
       - Toggle IsStarred
       - Return EmailDetailDto with updated star state

    DTOs defined as records/classes inside or adjacent to controllers (follow existing controller DTO pattern):
    - EmailListDto, EmailDetailDto, EmailThreadDto, SendEmailRequest
  </action>
  <verify>dotnet build -- should compile with 0 errors. Both controllers should be accessible at /api/email-accounts and /api/emails.</verify>
  <done>EmailAccountsController handles complete OAuth lifecycle (connect, callback, disconnect, status, manual sync). EmailsController provides 8 endpoints for email list, detail, thread view, send, entity-scoped queries, and read/star state management. All DTOs defined for frontend consumption.</done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with 0 errors
- EmailAccountsController has 5 endpoints (status, connect, callback, disconnect, sync)
- EmailsController has 8 endpoints (list, detail, thread, send, by-contact, by-company, read, star)
- Background service registered as hosted service in Program.cs
- Repositories registered in CrmEntityServiceExtensions
- OAuth callback redirects to Angular settings page
</verification>

<success_criteria>
- OAuth flow endpoints handle the complete connect/disconnect lifecycle
- OAuth callback properly encrypts tokens and creates EmailAccount
- EmailsController matches all frontend API service methods
- Background sync service runs without blocking application startup
- Entity-scoped endpoints (by-contact, by-company) support pagination for detail tabs
- Manual sync endpoint allows on-demand sync trigger
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-03-SUMMARY.md`
</output>
