---
phase: 07-email-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/emails/email.models.ts
  - globcrm-web/src/app/features/emails/email.service.ts
  - globcrm-web/src/app/features/emails/email.store.ts
autonomous: true

must_haves:
  truths:
    - "Email TypeScript models match all backend DTOs including thread and account status"
    - "EmailService has methods for all controller endpoints (list, detail, thread, send, entity-scoped, read/star)"
    - "EmailAccountService has methods for OAuth flow (connect, disconnect, status, sync)"
    - "EmailStore manages list/detail state with pagination, sorting, and filtering"
  artifacts:
    - path: "globcrm-web/src/app/features/emails/email.models.ts"
      provides: "All email DTOs, account status, send request, thread view models"
      contains: "EmailListDto"
    - path: "globcrm-web/src/app/features/emails/email.service.ts"
      provides: "API services for email operations and account management"
      contains: "EmailService"
    - path: "globcrm-web/src/app/features/emails/email.store.ts"
      provides: "NgRx signal store for email list/detail"
      contains: "EmailStore"
  key_links:
    - from: "globcrm-web/src/app/features/emails/email.service.ts"
      to: "globcrm-web/src/app/core/api/api.service.ts"
      via: "ApiService injection for JSON endpoints"
      pattern: "inject(ApiService)"
---

<objective>
Create the complete Angular data layer for email integration: TypeScript models, API services (email operations + account management), and NgRx signal store.

Purpose: Establish the frontend data layer that all email UI components will consume. Runs in Wave 1 parallel with backend entity creation.
Output: 3 files (models + service + store)
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md

# Pattern references
@globcrm-web/src/app/features/quotes/quote.models.ts
@globcrm-web/src/app/features/quotes/quote.service.ts
@globcrm-web/src/app/features/quotes/quote.store.ts
@globcrm-web/src/app/features/activities/activity.models.ts
@globcrm-web/src/app/features/activities/activity.service.ts
@globcrm-web/src/app/features/activities/activity.store.ts
@globcrm-web/src/app/shared/models/query.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Email TypeScript models and constants</name>
  <files>
    globcrm-web/src/app/features/emails/email.models.ts
  </files>
  <action>
    **email.models.ts** -- follow quote.models.ts pattern:

    **Interfaces:**
    - EmailAccountStatusDto: connected (boolean), gmailAddress? (string), lastSyncAt? (string), syncStatus? (string), errorMessage? (string)
    - EmailListDto: id, subject, fromAddress, fromName, toAddresses (string[]), bodyPreview?, sentAt, isInbound, isRead, isStarred, hasAttachments, gmailThreadId, linkedContactName?, linkedCompanyName?
    - EmailDetailDto: extends EmailListDto + bodyHtml?, bodyText?, ccAddresses? (string[]), bccAddresses? (string[]), linkedContactId?, linkedCompanyId?, emailAccountId, gmailMessageId, syncedAt
    - EmailThreadDto: threadId, subject, messageCount, messages: EmailDetailDto[]
    - SendEmailRequest: to, subject, htmlBody, replyToThreadId? (optional string)
    - ConnectResponse: authorizationUrl (string)

    **Constants:**
    - EMAIL_SYNC_STATUSES: Array of { value, label, color } for Active (green), Paused (grey), Error (red), Disconnected (orange)

    **Note:** No workflow transitions for emails -- emails don't have status workflows like quotes/requests.
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile (or have expected errors from missing imports only, not type errors in this file).</verify>
  <done>Email models define all DTOs matching backend: EmailListDto, EmailDetailDto, EmailThreadDto, EmailAccountStatusDto, SendEmailRequest, ConnectResponse, plus sync status constants.</done>
</task>

<task type="auto">
  <name>Task 2: Create Email API services and signal store</name>
  <files>
    globcrm-web/src/app/features/emails/email.service.ts
    globcrm-web/src/app/features/emails/email.store.ts
  </files>
  <action>
    **email.service.ts** -- follow activity.service.ts pattern:

    @Injectable({ providedIn: 'root' })
    export class EmailService
    - Inject ApiService
    - emailBasePath = '/emails'
    - accountBasePath = '/email-accounts'

    **Email operation methods (8 matching EmailsController):**
    1. getList(params: EntityQueryParams): Observable<PagedResult<EmailListDto>>
    2. getById(id: string): Observable<EmailDetailDto>
    3. getThread(gmailThreadId: string): Observable<EmailThreadDto>
    4. send(request: SendEmailRequest): Observable<EmailDetailDto>
    5. getByContact(contactId: string, params: EntityQueryParams): Observable<PagedResult<EmailListDto>>
    6. getByCompany(companyId: string, params: EntityQueryParams): Observable<PagedResult<EmailListDto>>
    7. markAsRead(id: string): Observable<void>
    8. toggleStar(id: string): Observable<EmailDetailDto>

    **Account management methods (5 matching EmailAccountsController):**
    9. getAccountStatus(): Observable<EmailAccountStatusDto>
    10. connect(): Observable<ConnectResponse> -- returns { authorizationUrl } for frontend to redirect
    11. disconnect(): Observable<void>
    12. triggerSync(): Observable<void>

    Implementation notes:
    - All methods use ApiService (JSON endpoints), no blob downloads needed for email
    - getByContact and getByCompany use entity-scoped paths: /emails/by-contact/{id}, /emails/by-company/{id}
    - connect returns authorizationUrl; frontend opens window.location.href = url to start OAuth
    - disconnect is POST with no body, returns 204
    - triggerSync is POST with no body, returns 200

    **email.store.ts** -- follow activity.store.ts pattern:

    Component-provided signal store (not root):
    - State: items (EmailListDto[]), selectedItem (EmailDetailDto | null), selectedThread (EmailThreadDto | null), loading, error, totalCount, page, pageSize, sortField, sortDirection, filters, accountStatus (EmailAccountStatusDto | null)
    - Methods:
      - loadList() -- calls EmailService.getList with current params
      - loadById(id: string) -- calls EmailService.getById
      - loadThread(gmailThreadId: string) -- calls EmailService.getThread
      - send(request: SendEmailRequest) -- calls EmailService.send, then reloads list
      - markAsRead(id: string) -- calls EmailService.markAsRead, updates item in list
      - toggleStar(id: string) -- calls EmailService.toggleStar, updates item in list
      - loadByContact(contactId: string) -- calls EmailService.getByContact
      - loadByCompany(companyId: string) -- calls EmailService.getByCompany
      - loadAccountStatus() -- calls EmailService.getAccountStatus
      - setPage, setSort, setFilters, reset
    - Default sort: sentAt desc (most recent first)
    - Follow ActivityStore ViewFilter-based filter pattern
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile.</verify>
  <done>EmailService wraps all 12 API endpoints (8 email + 4 account). EmailStore manages reactive list/detail/thread state with pagination/sorting/filtering and account status tracking. Store is component-provided for per-page isolation.</done>
</task>

</tasks>

<verification>
- All 3 files created in features/emails/
- EmailService has 12 methods matching all controller endpoints
- EmailStore is component-provided (not root)
- Models match backend DTOs exactly
- No TypeScript compilation errors
</verification>

<success_criteria>
- TypeScript interfaces match all backend DTOs exactly
- EmailService covers all API endpoints with correct HTTP methods and return types
- EmailStore follows ActivityStore pattern for component-provided signal stores
- Account management methods support the complete connect/disconnect/status/sync flow
- Entity-scoped methods (getByContact, getByCompany) accept both entityId and query params
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-04-SUMMARY.md`
</output>
