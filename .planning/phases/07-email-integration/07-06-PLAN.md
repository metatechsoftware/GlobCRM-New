---
phase: 07-email-integration
plan: 06
type: execute
wave: 3
depends_on: ["07-04", "07-05"]
files_modified:
  - globcrm-web/src/app/features/emails/email-detail/email-detail.component.ts
  - globcrm-web/src/app/features/emails/emails.routes.ts
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/app.routes.ts
autonomous: true

must_haves:
  truths:
    - "Email detail page shows full thread with chronological messages and reply button"
    - "Emails tab enabled on Contact and Company detail pages showing entity-scoped emails"
    - "Email feature routes registered with lazy loading in app.routes.ts"
    - "Emails link appears in navbar between existing navigation items"
    - "Emails appear in contact and company timelines"
  artifacts:
    - path: "globcrm-web/src/app/features/emails/email-detail/email-detail.component.ts"
      provides: "Email thread detail view with message chain and reply action"
      contains: "EmailDetailComponent"
    - path: "globcrm-web/src/app/features/emails/emails.routes.ts"
      provides: "Email feature routing (list and detail)"
      contains: "emailRoutes"
    - path: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      provides: "Updated CONTACT_TABS and COMPANY_TABS with Emails tab enabled"
      contains: "Emails"
  key_links:
    - from: "globcrm-web/src/app/features/emails/email-detail/email-detail.component.ts"
      to: "globcrm-web/src/app/features/emails/email.store.ts"
      via: "EmailStore.loadThread for thread view"
      pattern: "EmailStore"
    - from: "globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts"
      to: "globcrm-web/src/app/features/emails/email.service.ts"
      via: "EmailService.getByContact for entity-scoped emails"
      pattern: "EmailService"
    - from: "globcrm-web/src/app/app.routes.ts"
      to: "globcrm-web/src/app/features/emails/emails.routes.ts"
      via: "Lazy-loaded email feature routes"
      pattern: "loadChildren.*emails"
---

<objective>
Create the email thread detail view, email feature routing, navbar link, and integrate Emails tab into Contact and Company detail pages.

Purpose: Complete the email UI by adding thread-based email detail view, connecting all routes, enabling email tabs on entity detail pages, and making emails accessible from the main navigation.
Output: Email detail component, feature routes, entity tab integration, navbar update
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md
@.planning/phases/07-email-integration/07-04-SUMMARY.md
@.planning/phases/07-email-integration/07-05-SUMMARY.md

# Pattern references
@globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
@globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/app.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email detail (thread view) component and feature routes</name>
  <files>
    globcrm-web/src/app/features/emails/email-detail/email-detail.component.ts
    globcrm-web/src/app/features/emails/emails.routes.ts
  </files>
  <action>
    **EmailDetailComponent** (inline template/styles, following quote-detail pattern):
    - Standalone component with ChangeDetectionStrategy.OnPush
    - Provide EmailStore at component level
    - Inject EmailStore, ActivatedRoute, Router, MatDialog, MatSnackBar
    - imports: CommonModule, MatButtonModule, MatIconModule, MatCardModule, MatChipsModule, MatDividerModule, MatProgressSpinnerModule, RouterLink

    On init:
    - Get email ID from route params
    - Load email detail via store.loadById(id)
    - When detail loaded, load full thread via store.loadThread(selectedItem.gmailThreadId)

    Template layout:
    - Back button to /emails list
    - Thread subject as page title (from first message or selectedItem.subject)
    - Thread metadata: message count, linked contact (clickable link to /contacts/:id), linked company

    **Message chain (thread view):**
    - Display each message in thread chronologically (oldest first, matching email client convention)
    - Each message rendered as a MatCard with:
      - Header: sender name + address, recipients (To, Cc), sent timestamp
      - Direction indicator: arrow_downward (inbound) or arrow_upward (sent)
      - Read/star status icons
      - Collapsed state by default (show sender + subject + preview), expandable on click
      - Expanded state: show full HTML body via [innerHTML] (sanitized), or plain text fallback
      - Attachment indicator if hasAttachments
    - Most recent message expanded by default, others collapsed
    - Visual threading: indentation or left border color to distinguish sent vs received

    **Actions:**
    - "Reply" button: opens EmailComposeComponent dialog with:
      - replyToThreadId set to gmailThreadId
      - to pre-filled with original sender's address
      - subject pre-filled with "Re: {originalSubject}"
    - "Mark as Read" / "Mark as Unread" toggle
    - Star toggle

    On reply dialog close with success: reload thread to show new message

    **emails.routes.ts:**
    ```typescript
    import { Routes } from '@angular/router';
    import { authGuard } from '../../core/auth/auth.guard';

    export const emailRoutes: Routes = [
      {
        path: '',
        loadComponent: () => import('./email-list/email-list.component').then(m => m.EmailListComponent),
        canActivate: [authGuard],
      },
      {
        path: ':id',
        loadComponent: () => import('./email-detail/email-detail.component').then(m => m.EmailDetailComponent),
        canActivate: [authGuard],
      },
    ];
    ```
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile.</verify>
  <done>EmailDetailComponent displays email thread with chronological message chain, expandable messages, reply action opening compose dialog, and read/star toggles. Feature routes defined with lazy loading for list and detail views.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate emails into entity tabs, navbar, and app routes</name>
  <files>
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
    **Enable Emails tab in related-entity-tabs:**
    - In CONTACT_TABS: change Emails entry from { label: 'Emails', icon: 'email', enabled: false } to { label: 'Emails', icon: 'email', enabled: true }
    - In COMPANY_TABS: add Emails tab entry { label: 'Emails', icon: 'email', enabled: true } -- insert after Activities/Requests tabs, before Notes tab
    - NOTE: Be careful with tab ordering -- contentChildren template indexing depends on tab position. Check existing tab index usage in contact-detail and company-detail components.

    **Contact detail Emails tab content:**
    - In contact-detail.component.ts, add the Emails tab template content
    - Inject EmailService
    - Add signal: contactEmails (EmailListDto[]), emailsLoaded (boolean)
    - On Emails tab selection (lazy load pattern matching existing Activities tab):
      - If !emailsLoaded(), load emails via EmailService.getByContact(contactId, { pageSize: 20, sortField: 'sentAt', sortDirection: 'desc' })
      - Set emailsLoaded = true
    - Display emails in a simple list (not full DynamicTable -- tab content uses simpler rendering):
      - Each email shows: from/to indicator, subject, bodyPreview, sentAt, read/star indicators
      - Click navigates to /emails/{id}
    - "View All Emails" link at bottom navigating to /emails with contact filter (or just link to /emails)
    - If no emails: "No emails linked to this contact"

    **Company detail Emails tab content:**
    - Same pattern as Contact detail but using EmailService.getByCompany(companyId, params)
    - Add signal: companyEmails (EmailListDto[]), emailsLoaded (boolean)
    - Same lazy-load on tab selection pattern
    - Same simple list rendering
    - "No emails linked to this company" empty state

    **Navbar update:**
    - Add "Emails" link to navbar between existing items
    - Follow existing pattern (mat-button with routerLink and routerLinkActive)
    - Position: after Requests and before Team (matching logical CRM workflow order)
    - Icon: email
    - Route: /emails

    **App routes update:**
    - Add email feature route in app.routes.ts:
      ```typescript
      {
        path: 'emails',
        loadChildren: () => import('./features/emails/emails.routes').then(m => m.emailRoutes),
        canActivate: [authGuard],
      },
      ```
    - Place after existing entity routes (deals, activities, quotes, requests)
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile. Verify navbar.component.html contains "Emails" link. Verify app.routes.ts contains emails route.</verify>
  <done>Emails tab enabled on Contact and Company detail pages with lazy-loaded entity-scoped email lists. Emails link added to navbar. Email feature routes registered in app.routes.ts with lazy loading. Tab ordering updated correctly with contentChildren indexing considered.</done>
</task>

</tasks>

<verification>
- All 7 files created/updated
- Email detail shows thread view with expandable messages
- Reply button opens compose dialog with pre-filled thread context
- CONTACT_TABS has Emails enabled
- COMPANY_TABS has Emails tab added and enabled
- Contact and Company detail pages load entity-scoped emails on tab selection
- Navbar shows Emails link with correct positioning
- app.routes.ts loads email feature routes lazily
- Angular build compiles without errors
</verification>

<success_criteria>
- Email thread view displays messages chronologically with expand/collapse
- Reply action pre-fills compose dialog with thread context
- Emails tab on Contact detail shows emails linked to that contact
- Emails tab on Company detail shows emails linked to that company
- Tab content lazy-loads on first selection (not on page load)
- Navbar Emails link navigates to /emails
- Email routes support both list (/emails) and detail (/emails/:id) views
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-06-SUMMARY.md`
</output>
