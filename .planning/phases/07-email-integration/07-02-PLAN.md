---
phase: 07-email-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
  - src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailOAuthService.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailServiceFactory.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailSendService.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailServiceExtensions.cs
  - src/GlobCRM.Api/appsettings.json
  - src/GlobCRM.Api/appsettings.Development.json
autonomous: true
user_setup:
  - service: google-cloud
    why: "Gmail API requires OAuth 2.0 credentials from Google Cloud Console"
    env_vars:
      - name: "Gmail:ClientId"
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: "Gmail:ClientSecret"
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create Google Cloud project and enable Gmail API"
        location: "Google Cloud Console -> APIs & Services -> Library -> Gmail API -> Enable"
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth Client ID"
      - task: "Set authorized redirect URI to http://localhost:5233/api/email-accounts/callback"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Edit OAuth Client"
      - task: "Configure OAuth consent screen with gmail.modify scope"
        location: "Google Cloud Console -> APIs & Services -> OAuth consent screen"

must_haves:
  truths:
    - "TokenEncryptionService encrypts/decrypts OAuth tokens using ASP.NET Core DataProtection"
    - "GmailOAuthService generates authorization URL and exchanges auth code for tokens"
    - "GmailServiceFactory creates authenticated GmailService instances per user"
    - "GmailSyncService performs both initial and incremental sync using history.list"
    - "GmailSendService sends emails via Gmail API using MimeKit for MIME construction"
    - "All Gmail services are registered via AddGmailServices DI extension"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs"
      provides: "DataProtection-based token encryption/decryption"
      contains: "class TokenEncryptionService"
    - path: "src/GlobCRM.Infrastructure/Gmail/GmailOAuthService.cs"
      provides: "OAuth 2.0 authorization URL generation and code exchange"
      contains: "class GmailOAuthService"
    - path: "src/GlobCRM.Infrastructure/Gmail/GmailServiceFactory.cs"
      provides: "Creates authenticated GmailService per user with auto token refresh"
      contains: "class GmailServiceFactory"
    - path: "src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs"
      provides: "Full and incremental Gmail sync with contact auto-linking"
      contains: "class GmailSyncService"
    - path: "src/GlobCRM.Infrastructure/Gmail/GmailSendService.cs"
      provides: "Email sending via Gmail API with MimeKit MIME construction"
      contains: "class GmailSendService"
    - path: "src/GlobCRM.Infrastructure/Gmail/GmailServiceExtensions.cs"
      provides: "DI registration for all Gmail services"
      contains: "AddGmailServices"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs"
      to: "src/GlobCRM.Domain/Interfaces/IEmailMessageRepository.cs"
      via: "Repository injection for persisting synced messages"
      pattern: "IEmailMessageRepository"
    - from: "src/GlobCRM.Infrastructure/Gmail/GmailServiceFactory.cs"
      to: "src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs"
      via: "Token decryption before creating Gmail client"
      pattern: "TokenEncryptionService"
    - from: "src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs"
      to: "src/GlobCRM.Domain/Interfaces/IContactRepository.cs"
      via: "Contact lookup for auto-linking emails"
      pattern: "IContactRepository"
---

<objective>
Create all Gmail infrastructure services: OAuth flow, token encryption, authenticated client factory, bidirectional sync engine, and email sending. Install NuGet packages (Google.Apis.Gmail.v1, MimeKit).

Purpose: Build the core Gmail integration layer that API controllers will orchestrate. This is the technical heart of email integration -- OAuth token management, incremental sync via history.list, contact auto-linking, and MIME-based sending.
Output: 6 Gmail service classes + NuGet packages + app settings configuration
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md
@.planning/phases/07-email-integration/07-01-SUMMARY.md

# Pattern references
@src/GlobCRM.Infrastructure/Email/EmailServiceExtensions.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@src/GlobCRM.Api/appsettings.json
@src/GlobCRM.Api/appsettings.Development.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install NuGet packages and create OAuth + token encryption services</name>
  <files>
    src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
    src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs
    src/GlobCRM.Infrastructure/Gmail/GmailOAuthService.cs
    src/GlobCRM.Infrastructure/Gmail/GmailServiceFactory.cs
    src/GlobCRM.Api/appsettings.json
    src/GlobCRM.Api/appsettings.Development.json
  </files>
  <action>
    **Install NuGet packages:**
    ```bash
    dotnet add src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj package Google.Apis.Gmail.v1
    dotnet add src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj package MimeKit
    ```
    Google.Apis.Auth comes as a transitive dependency of Google.Apis.Gmail.v1.

    **TokenEncryptionService** (src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs):
    - Inject IDataProtectionProvider
    - Create IDataProtector with purpose "GlobCRM.Gmail.Tokens"
    - Methods:
      - Encrypt(string plainText): string -- calls _protector.Protect()
      - Decrypt(string encrypted): string -- calls _protector.Unprotect()
    - DataProtection is already part of ASP.NET Core framework, no extra package needed
    - This handles key rotation automatically (old keys retained for decryption)

    **GmailOAuthService** (src/GlobCRM.Infrastructure/Gmail/GmailOAuthService.cs):
    - Inject IConfiguration to read Gmail:ClientId, Gmail:ClientSecret, Gmail:RedirectUri
    - Methods:
      - GetAuthorizationUrl(string state): string
        - Build Google OAuth URL with these params:
          - client_id from config
          - redirect_uri from config (e.g., http://localhost:5233/api/email-accounts/callback)
          - scope = "https://www.googleapis.com/auth/gmail.modify"
          - response_type = "code"
          - access_type = "offline" (required for refresh token)
          - prompt = "consent" (force consent to always get refresh token, even on re-auth)
          - state = passed parameter (for CSRF protection)
        - Use GoogleAuthorizationCodeRequestUrl from Google.Apis.Auth
      - ExchangeCodeAsync(string authCode): Task<TokenResponse>
        - Create GoogleAuthorizationCodeFlow with ClientSecrets and Gmail.modify scope
        - Call flow.ExchangeCodeForTokenAsync with auth code and redirect URI
        - Return TokenResponse containing AccessToken, RefreshToken, ExpiresInSeconds, IssuedUtc
      - RevokeTokenAsync(string refreshToken): Task
        - POST to https://oauth2.googleapis.com/revoke with token parameter
        - Used when user disconnects account (ensures refresh token invalidated at Google)

    **GmailServiceFactory** (src/GlobCRM.Infrastructure/Gmail/GmailServiceFactory.cs):
    - Inject IConfiguration, TokenEncryptionService
    - Method: CreateForAccountAsync(EmailAccount account): Task<GmailService>
      - Decrypt access and refresh tokens from EmailAccount
      - Build TokenResponse with decrypted tokens, ExpiresInSeconds=3600, IssuedUtc from account.TokenIssuedAt
      - Create GoogleAuthorizationCodeFlow with ClientSecrets
      - Create UserCredential(flow, account.GmailAddress, tokenResponse)
      - Return new GmailService with HttpClientInitializer=credential, ApplicationName="GlobCRM"
      - The Google SDK automatically refreshes expired access tokens using the refresh token

    **App settings configuration:**
    - Add Gmail section to appsettings.json:
      ```json
      "Gmail": {
        "ClientId": "",
        "ClientSecret": "",
        "RedirectUri": "http://localhost:5233/api/email-accounts/callback",
        "SyncIntervalMinutes": 5,
        "InitialSyncDays": 30,
        "MaxMessagesPerSync": 500
      }
      ```
    - Add placeholder values in appsettings.Development.json:
      ```json
      "Gmail": {
        "ClientId": "your-client-id.apps.googleusercontent.com",
        "ClientSecret": "your-client-secret"
      }
      ```
  </action>
  <verify>dotnet build src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj -- should compile with 0 errors after NuGet restore. Verify Google.Apis.Gmail.v1 and MimeKit appear in csproj PackageReference.</verify>
  <done>NuGet packages installed (Google.Apis.Gmail.v1 + MimeKit). TokenEncryptionService encrypts/decrypts tokens via DataProtection. GmailOAuthService handles authorization URL generation, code exchange, and token revocation. GmailServiceFactory creates authenticated GmailService per user with auto-refresh. App settings configured with Gmail section.</done>
</task>

<task type="auto">
  <name>Task 2: Create Gmail sync service, send service, and DI extension</name>
  <files>
    src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs
    src/GlobCRM.Infrastructure/Gmail/GmailSendService.cs
    src/GlobCRM.Infrastructure/Gmail/GmailServiceExtensions.cs
  </files>
  <action>
    **GmailSyncService** (src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs):
    - Inject: GmailServiceFactory, IEmailMessageRepository, IEmailAccountRepository, IContactRepository, IConfiguration, ILogger<GmailSyncService>
    - This is the core sync engine. It has two modes:

    Method: SyncAllAccountsAsync(CancellationToken ct)
    - Query all active email accounts (SyncStatus = Active) using IEmailAccountRepository.GetAllActiveAccountsAsync()
    - IMPORTANT: This runs cross-tenant, so the repository method must use IgnoreQueryFilters or a separate mechanism
    - For each account, call SyncAccountAsync wrapped in try/catch
    - On failure: set account.SyncStatus = Error, account.ErrorMessage = ex.Message, update account
    - Stagger accounts to avoid quota spikes (small Task.Delay between accounts)

    Method: SyncAccountAsync(EmailAccount account, CancellationToken ct)
    - Create GmailService via factory
    - If account.LastHistoryId is null: call InitialSyncAsync (first-time sync)
    - Else: call IncrementalSyncAsync
    - Update account.LastSyncAt = DateTimeOffset.UtcNow
    - Update account via repository

    Method: InitialSyncAsync(EmailAccount account, GmailService gmail, CancellationToken ct)
    - List messages from INBOX and SENT labels from the last N days (Gmail:InitialSyncDays config, default 30)
    - Use gmail.Users.Messages.List("me") with q="after:{epochSeconds}" and maxResults
    - Paginate through results (handle NextPageToken)
    - For each message ID, call SyncSingleMessageAsync
    - After processing all messages, get latest historyId from Gmail profile: gmail.Users.GetProfile("me")
    - Store account.LastHistoryId = profile.HistoryId

    Method: IncrementalSyncAsync(EmailAccount account, GmailService gmail, CancellationToken ct)
    - Use gmail.Users.History.List("me") with StartHistoryId = account.LastHistoryId
    - Set HistoryTypes to MessageAdded
    - Handle 404 response (expired historyId) by falling back to InitialSyncAsync
    - For each HistoryMessageAdded record, call SyncSingleMessageAsync
    - Update account.LastHistoryId = response.HistoryId

    Method: SyncSingleMessageAsync(GmailService gmail, string messageId, Guid tenantId, Guid emailAccountId, CancellationToken ct)
    - Check if message already exists: IEmailMessageRepository.ExistsByGmailMessageIdAsync
    - If exists, skip (idempotent)
    - Fetch full message: gmail.Users.Messages.Get("me", messageId) with Format = Full
    - Extract metadata from message.Payload.Headers: Subject, From, To, Cc, Bcc, Date
    - Parse From header to extract address and display name
    - Parse body: look for text/html and text/plain parts in message.Payload (handle multipart recursion)
    - Determine IsInbound: compare From address to account.GmailAddress (case-insensitive)
    - Check for UNREAD label to set IsRead (IsRead = !labels.Contains("UNREAD"))
    - Check for STARRED label to set IsStarred
    - Create BodyPreview from plain text body (first 200 chars, or strip HTML if no text part)
    - Build EmailMessage entity with all extracted data
    - **Contact auto-linking**: collect all participant email addresses (from, to, cc), query IContactRepository to find contacts with matching Email field (case-insensitive). If found, set LinkedContactId to first matching contact. If contact has CompanyId, set LinkedCompanyId.
    - **Thread management**: call IEmailMessageRepository.GetThreadAsync(gmailThreadId) to get-or-create EmailThread. Update thread's MessageCount, LastMessageAt, Subject (from first message), Snippet.
    - Save via IEmailMessageRepository.CreateAsync

    **GmailSendService** (src/GlobCRM.Infrastructure/Gmail/GmailSendService.cs):
    - Inject: GmailServiceFactory, IEmailMessageRepository, IEmailAccountRepository, IContactRepository, ILogger<GmailSendService>

    Method: SendEmailAsync(EmailAccount account, string to, string subject, string htmlBody, string? replyToGmailThreadId): Task<EmailMessage>
    - Create GmailService via factory
    - Build MimeKit MimeMessage:
      - message.From.Add(MailboxAddress.Parse(account.GmailAddress))
      - message.To.Add(MailboxAddress.Parse(to))
      - message.Subject = subject
      - message.Body = new TextPart("html") { Text = htmlBody }
    - If replyToGmailThreadId is not null:
      - This is a reply within a thread. Set the Gmail message's ThreadId so it groups correctly.
    - Serialize MimeMessage to base64url-encoded string:
      - Write to MemoryStream, Convert.ToBase64String, replace +/- with -/_, remove = padding
    - Create Google.Apis.Gmail.v1.Data.Message with Raw = base64url string
    - If replyToGmailThreadId, set message.ThreadId
    - Send via gmail.Users.Messages.Send(message, "me").ExecuteAsync()
    - Create EmailMessage entity from sent message (IsInbound=false, IsRead=true)
    - Auto-link contact if "to" address matches a known contact
    - Save via IEmailMessageRepository.CreateAsync
    - Return created EmailMessage

    **GmailServiceExtensions** (src/GlobCRM.Infrastructure/Gmail/GmailServiceExtensions.cs):
    - Follow EmailServiceExtensions pattern (AddEmailServices)
    - Method: AddGmailServices(this IServiceCollection services): IServiceCollection
    - Register:
      - services.AddSingleton<TokenEncryptionService>() (stateless, uses IDataProtectionProvider)
      - services.AddScoped<GmailOAuthService>()
      - services.AddScoped<GmailServiceFactory>()
      - services.AddScoped<GmailSyncService>()
      - services.AddScoped<GmailSendService>()
    - NOTE: Do NOT register BackgroundService here -- that goes in Plan 03 since it depends on repositories
  </action>
  <verify>dotnet build -- should compile with 0 errors. All 3 files should exist in src/GlobCRM.Infrastructure/Gmail/.</verify>
  <done>GmailSyncService handles full + incremental sync with contact auto-linking and thread management. GmailSendService sends emails via Gmail API using MimeKit MIME construction. GmailServiceExtensions registers all 5 Gmail services in DI container. Sync engine handles 404 on expired historyId by falling back to full re-sync.</done>
</task>

</tasks>

<verification>
- `dotnet build` compiles with 0 errors
- Google.Apis.Gmail.v1 and MimeKit are in GlobCRM.Infrastructure.csproj
- All 7 new files exist in src/GlobCRM.Infrastructure/Gmail/
- TokenEncryptionService uses IDataProtector with "GlobCRM.Gmail.Tokens" purpose
- GmailOAuthService includes prompt=consent and access_type=offline
- GmailSyncService has both InitialSync and IncrementalSync paths
- Gmail config section exists in appsettings.json
</verification>

<success_criteria>
- NuGet packages installed and building
- OAuth flow handles authorization URL, code exchange, and token revocation
- Sync service supports initial (date-range) and incremental (history.list) modes
- Sync service auto-links emails to contacts by matching email addresses
- Send service constructs RFC-compliant MIME messages via MimeKit
- All services registered via single AddGmailServices extension method
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-02-SUMMARY.md`
</output>
