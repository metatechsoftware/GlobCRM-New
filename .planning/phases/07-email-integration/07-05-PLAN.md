---
phase: 07-email-integration
plan: 05
type: execute
wave: 2
depends_on: ["07-04"]
files_modified:
  - globcrm-web/src/app/features/emails/email-list/email-list.component.ts
  - globcrm-web/src/app/features/emails/email-compose/email-compose.component.ts
  - globcrm-web/src/app/features/settings/email-accounts/email-account-settings.component.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
autonomous: true

must_haves:
  truths:
    - "Email list page displays emails using DynamicTable with subject, from, date, read/star indicators"
    - "Email compose dialog allows writing and sending emails with to, subject, and rich body"
    - "Email account settings page shows connection status and connect/disconnect buttons"
    - "Settings routes include email-accounts path"
  artifacts:
    - path: "globcrm-web/src/app/features/emails/email-list/email-list.component.ts"
      provides: "Email inbox list with DynamicTable, filters, and compose button"
      contains: "EmailListComponent"
    - path: "globcrm-web/src/app/features/emails/email-compose/email-compose.component.ts"
      provides: "MatDialog for composing and sending emails"
      contains: "EmailComposeComponent"
    - path: "globcrm-web/src/app/features/settings/email-accounts/email-account-settings.component.ts"
      provides: "Gmail account connection management page"
      contains: "EmailAccountSettingsComponent"
  key_links:
    - from: "globcrm-web/src/app/features/emails/email-list/email-list.component.ts"
      to: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      via: "DynamicTable for email list rendering"
      pattern: "DynamicTableComponent"
    - from: "globcrm-web/src/app/features/emails/email-compose/email-compose.component.ts"
      to: "globcrm-web/src/app/features/emails/email.service.ts"
      via: "EmailService.send for sending composed email"
      pattern: "EmailService"
    - from: "globcrm-web/src/app/features/settings/email-accounts/email-account-settings.component.ts"
      to: "globcrm-web/src/app/features/emails/email.service.ts"
      via: "EmailService.connect/disconnect/getAccountStatus"
      pattern: "EmailService"
---

<objective>
Create the email list page with DynamicTable, email compose dialog, and Gmail account settings page for connecting/disconnecting accounts.

Purpose: Build the primary email UI surfaces -- the inbox list for viewing synced emails, compose dialog for sending, and settings page for managing Gmail connection.
Output: 3 components + settings route update
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-integration/07-RESEARCH.md
@.planning/phases/07-email-integration/07-04-SUMMARY.md

# Pattern references
@globcrm-web/src/app/features/quotes/quote-list/quote-list.component.ts
@globcrm-web/src/app/features/activities/activity-list/activity-list.component.ts
@globcrm-web/src/app/features/settings/pipelines/pipeline-list/pipeline-list.component.ts
@globcrm-web/src/app/features/settings/settings.routes.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email list page and compose dialog</name>
  <files>
    globcrm-web/src/app/features/emails/email-list/email-list.component.ts
    globcrm-web/src/app/features/emails/email-compose/email-compose.component.ts
  </files>
  <action>
    **EmailListComponent** (inline template/styles, following quote-list pattern):
    - Standalone component with ChangeDetectionStrategy.OnPush
    - Provide EmailStore at component level (component-provided pattern)
    - Inject EmailStore, MatDialog, Router
    - imports: CommonModule, MatButtonModule, MatIconModule, MatMenuModule, MatChipsModule, DynamicTableComponent, FilterPanelComponent, ViewSidebarComponent

    Template structure:
    - Header bar: "Emails" title + "Compose" button (opens compose dialog) + filter/view controls
    - Show connection status banner if not connected: "Connect your Gmail account in Settings to see emails here" with link to /settings/email-accounts
    - DynamicTable with columns:
      - read indicator (mat-icon: mark_email_read / mark_email_unread, based on isRead)
      - star indicator (mat-icon: star / star_border, based on isStarred, clickable to toggle)
      - fromName/fromAddress (show fromName if available, else fromAddress; for sent emails show "To: {toAddresses[0]}")
      - subject
      - bodyPreview (truncated)
      - sentAt (formatted date)
      - hasAttachments indicator (mat-icon: attach_file)
      - linkedContactName (with link to contact detail)
    - Row click navigates to email detail: router.navigate(['/emails', email.id])
    - Unread emails styled with bold text (font-weight: 600)

    On init:
    - Load account status via store.loadAccountStatus()
    - If connected, load email list via store.loadList()

    Compose button handler:
    - Open EmailComposeComponent as MatDialog
    - On dialog close with result, reload list

    Star toggle handler:
    - Call store.toggleStar(id) -- optimistic update

    **EmailComposeComponent** (MatDialog, inline template/styles):
    - Standalone component
    - Inject MatDialogRef, EmailService, MatSnackBar
    - imports: CommonModule, ReactiveFormsModule, MatDialogModule, MatFormFieldModule, MatInputModule, MatButtonModule, MatIconModule

    Form fields:
    - to: email address input (required, email validator)
    - subject: text input (required)
    - htmlBody: textarea for email body (required). Use a simple textarea -- rich text editor deferred to Phase 11.
    - replyToThreadId: hidden field (set when replying to a thread, passed via MAT_DIALOG_DATA)

    Dialog layout:
    - Title: "Compose Email" (or "Reply" if replyToThreadId provided)
    - Form with to, subject, body fields
    - Cancel button + Send button
    - Show loading spinner on send button while sending
    - On send success: show snackbar "Email sent", close dialog with result
    - On send error: show snackbar with error message, keep dialog open

    Send handler:
    - Build SendEmailRequest from form values
    - Call EmailService.send(request).subscribe()
    - On success: dialogRef.close(true)
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile.</verify>
  <done>EmailListComponent shows email inbox using DynamicTable with read/star indicators, sender info, subject, preview, and attachments icon. Compose dialog sends emails via EmailService with to/subject/body form. Star toggling is optimistic. Connection status banner guides users to settings if not connected.</done>
</task>

<task type="auto">
  <name>Task 2: Create email account settings page and update settings routes</name>
  <files>
    globcrm-web/src/app/features/settings/email-accounts/email-account-settings.component.ts
    globcrm-web/src/app/features/settings/settings.routes.ts
  </files>
  <action>
    **EmailAccountSettingsComponent** (inline template/styles, following pipeline-list pattern):
    - Standalone component with ChangeDetectionStrategy.OnPush
    - Inject EmailService, ActivatedRoute, MatSnackBar
    - imports: CommonModule, MatButtonModule, MatIconModule, MatCardModule, MatProgressSpinnerModule

    State (signals):
    - accountStatus: signal<EmailAccountStatusDto | null>(null)
    - loading: signal<boolean>(false)
    - syncing: signal<boolean>(false)

    On init:
    - Load account status: EmailService.getAccountStatus().subscribe()
    - Check ActivatedRoute queryParams for 'connected=true' (set by OAuth callback redirect)
    - If connected=true, show success snackbar "Gmail account connected successfully!" and reload status

    Template:
    - Page title: "Email Account"
    - MatCard with account status display:

    If NOT connected:
    - Icon: email (large, grey)
    - Text: "No Gmail account connected"
    - Description: "Connect your Gmail account to sync emails with your CRM. Emails will be automatically linked to contacts and companies."
    - "Connect Gmail" button (primary, raised)
    - Click handler: call connect()

    If connected:
    - Icon: check_circle (large, green)
    - Gmail address displayed prominently
    - Status badge: Active (green) / Error (red with error message) / Paused (grey)
    - Last sync timestamp (formatted relative: "Last synced 3 minutes ago")
    - "Sync Now" button (calls triggerSync, shows spinner while syncing)
    - "Disconnect" button (warn color, with confirmation dialog)

    Methods:
    - connect(): call EmailService.connect(), redirect to authorizationUrl via window.location.href
    - disconnect(): show confirm dialog, then call EmailService.disconnect(), reload status, show snackbar
    - triggerSync(): set syncing=true, call EmailService.triggerSync(), reload status on complete, show snackbar

    **Update settings.routes.ts:**
    - Add route: { path: 'email-accounts', loadComponent: () => import('./email-accounts/email-account-settings.component').then(m => m.EmailAccountSettingsComponent) }
    - Place after existing settings routes (roles, teams, pipelines, custom-fields)
  </action>
  <verify>Run `npx ng build --configuration development 2>&1 | head -20` from globcrm-web/ -- should compile. settings.routes.ts should contain email-accounts path.</verify>
  <done>EmailAccountSettingsComponent shows Gmail connection status with connect/disconnect/sync buttons. OAuth connect redirects to Google consent via window.location.href. Callback redirect back to settings shows success snackbar. Settings routes updated with email-accounts path.</done>
</task>

</tasks>

<verification>
- All 4 files created/updated
- EmailListComponent uses DynamicTable with proper column config
- EmailComposeComponent sends via EmailService.send
- EmailAccountSettingsComponent handles connect/disconnect/sync flow
- settings.routes.ts includes email-accounts route
- Angular build compiles without errors
</verification>

<success_criteria>
- Email list shows inbox with read/unread/star indicators and clickable rows
- Compose dialog validates email input and sends via API
- Settings page shows connection status and handles OAuth redirect flow
- Connect button redirects to Google OAuth consent screen URL
- Disconnect properly revokes access and clears account
- Manual sync trigger works from settings page
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-integration/07-05-SUMMARY.md`
</output>
