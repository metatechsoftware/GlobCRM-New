---
phase: 24-my-day-personal-dashboard
plan: 05
type: execute
wave: 3
depends_on: [24-03]
files_modified:
  - globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.component.ts
  - globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts
  - globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.models.ts
  - globcrm-web/src/app/features/my-day/widgets/greeting-banner/greeting-banner.component.ts
  - globcrm-web/src/app/features/my-day/my-day.component.ts
  - globcrm-web/src/styles/tokens.css
autonomous: true
requirements:
  - MYDAY-07

must_haves:
  truths:
    - "Quick action buttons in greeting banner open a slide-in panel from the right (not a MatDialog)"
    - "Slide-in panel contains the existing form component in dialogMode for the selected entity type"
    - "After entity creation, the slide-in panel closes and My Day widgets refresh with a brief highlight animation on the new data"
    - "Slide-in panel has a header with entity type title, close button, and scrollable body"
    - "Slide-in panel and preview sidebar auto-close each other (mutually exclusive)"
  artifacts:
    - path: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.component.ts"
      provides: "Reusable slide-in panel container with form component switch"
      contains: "SlideInPanelComponent"
    - path: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts"
      provides: "Service to open/close slide-in panels via CDK Overlay"
      contains: "SlideInPanelService"
    - path: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.models.ts"
      provides: "Configuration and ref types for slide-in panels"
      contains: "SlideInConfig"
  key_links:
    - from: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts"
      to: "Angular CDK Overlay"
      via: "inject(Overlay)"
      pattern: "this\\.overlay\\.create"
    - from: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.component.ts"
      to: "existing form components"
      via: "@switch (config.entityType) with [dialogMode]='true'"
      pattern: "dialogMode.*true"
    - from: "globcrm-web/src/app/features/my-day/my-day.component.ts"
      to: "globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts"
      via: "inject and open on quick action"
      pattern: "inject\\(SlideInPanelService\\)"
---

<objective>
Build the slide-in panel infrastructure using Angular CDK Overlay and wire it to the greeting banner's quick action buttons. Quick actions (New Contact, New Deal, Log Activity, New Note, Send Email) open a right-side slide-in panel containing the existing form components in dialogMode. After creation, panels close and My Day data refreshes.

Purpose: Enables users to create entities directly from My Day without navigating away, keeping them in the dashboard context. This is a key productivity feature.
Output: SlideInPanelService + SlideInPanelComponent with CDK Overlay, wired to greeting banner quick actions, with post-creation refresh and highlight animation.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-my-day-personal-dashboard/24-RESEARCH.md
@.planning/phases/24-my-day-personal-dashboard/24-03-SUMMARY.md
@globcrm-web/src/app/shared/components/entity-form-dialog/entity-form-dialog.component.ts (form reuse pattern)
@globcrm-web/src/app/shared/components/entity-form-dialog/entity-form-dialog.models.ts (entity type definitions)
@globcrm-web/src/app/shared/stores/preview-sidebar.store.ts (mutual exclusion reference)
@globcrm-web/src/app/features/my-day/my-day.component.ts
@globcrm-web/src/app/features/my-day/widgets/greeting-banner/greeting-banner.component.ts
@globcrm-web/src/app/features/my-day/my-day.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build slide-in panel service, component, and models using CDK Overlay</name>
  <files>
    globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.models.ts
    globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts
    globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.component.ts
    globcrm-web/src/styles/tokens.css
  </files>
  <action>
    1. **Create `slide-in-panel.models.ts`:**
       - `SlideInEntityType = 'Contact' | 'Company' | 'Deal' | 'Activity' | 'Note' | 'Email'`
       - `SlideInConfig { entityType: SlideInEntityType; title?: string; }` — configuration for opening a panel
       - `SlideInPanelRef { afterClosed: Observable<SlideInResult | null> }` — returned when opening, allows subscribing to close
       - `SlideInResult { entity: { id: string; [key: string]: any }; entityType: string; }` — result after entity creation

    2. **Create `slide-in-panel.service.ts`:**
       - `@Injectable({ providedIn: 'root' })` — root-provided so it can be injected anywhere
       - Inject: `Overlay` (from `@angular/cdk/overlay`), `Injector`, `PreviewSidebarStore`
       - Private state: `overlayRef: OverlayRef | null`, `isOpen` signal
       - `open(config: SlideInConfig): SlideInPanelRef`:
         - First: close preview sidebar if open (`previewSidebarStore.close()`)
         - First: close existing panel if one is already open (`this.close()`)
         - Create overlay: `this.overlay.create({ positionStrategy: this.overlay.position().global().right('0').top('0').bottom('0'), width: '520px', hasBackdrop: true, backdropClass: 'slide-in-backdrop', panelClass: ['slide-in-panel', 'slide-in-panel--animate-in'], scrollStrategy: this.overlay.scrollStrategies.block() })`
         - Create `ComponentPortal<SlideInPanelComponent>` and attach to overlayRef
         - Pass config to component via injector (use `Injector.create` with a provide for `SLIDE_IN_CONFIG` InjectionToken)
         - Subscribe to backdrop click and escape key → close
         - Return `SlideInPanelRef` with `afterClosed` observable (Subject that emits on close)
       - `close(result?: SlideInResult)`: Dispose overlayRef, emit result on afterClosed subject, set isOpen to false
       - Subscribe to `PreviewSidebarStore.isOpen()` changes: when preview opens, close slide-in panel (mutual exclusion)

    3. **Create `slide-in-panel.component.ts`:**
       - Standalone component, OnPush
       - Inject `SLIDE_IN_CONFIG` token to get the config
       - Inject `SlideInPanelService` for close action
       - Template:
         ```html
         <div class="slide-in-panel__container">
           <div class="slide-in-panel__header">
             <h3>New {{ config.title || config.entityType }}</h3>
             <button mat-icon-button (click)="onClose()">
               <mat-icon>close</mat-icon>
             </button>
           </div>
           <div class="slide-in-panel__body">
             @switch (config.entityType) {
               @case ('Contact') {
                 <app-contact-form [dialogMode]="true" (entityCreated)="onEntityCreated($event)" (entityCreateError)="onCreateError()" />
               }
               @case ('Company') {
                 <app-company-form [dialogMode]="true" (entityCreated)="onEntityCreated($event)" (entityCreateError)="onCreateError()" />
               }
               @case ('Deal') {
                 <app-deal-form [dialogMode]="true" (entityCreated)="onEntityCreated($event)" (entityCreateError)="onCreateError()" />
               }
               @case ('Activity') {
                 <app-activity-form [dialogMode]="true" (entityCreated)="onEntityCreated($event)" (entityCreateError)="onCreateError()" />
               }
               @case ('Note') {
                 <app-note-form [dialogMode]="true" (entityCreated)="onEntityCreated($event)" (entityCreateError)="onCreateError()" />
               }
               @case ('Email') {
                 <!-- Email compose: route to /emails/compose or use existing email compose pattern -->
                 <p class="slide-in-panel__placeholder">Email compose coming soon</p>
               }
             }
           </div>
           <div class="slide-in-panel__footer">
             <button mat-button (click)="onClose()">Cancel</button>
             <button mat-flat-button color="primary" [disabled]="isSaving()" (click)="onSubmit()">
               @if (isSaving()) {
                 <mat-spinner diameter="18"></mat-spinner>
               }
               Create
             </button>
           </div>
         </div>
         ```
       - Styles (inline):
         - `.slide-in-panel__container`: height 100%, display flex, flex-direction column, background white, box-shadow for elevation
         - `.slide-in-panel__header`: flex row, justify space-between, align center, padding 16px 24px, border-bottom
         - `.slide-in-panel__body`: flex 1, overflow-y auto, padding 24px
         - `.slide-in-panel__footer`: flex row, justify flex-end, gap 8px, padding 16px 24px, border-top
       - Methods:
         - `onClose()`: call service.close(null)
         - `onEntityCreated(entity: any)`: call service.close({ entity, entityType: config.entityType })
         - `onCreateError()`: set isSaving to false, show snackbar
         - `onSubmit()`: trigger the active form's submit (use viewChild pattern from EntityFormDialogComponent)
       - Import all form components: ContactFormComponent, CompanyFormComponent, DealFormComponent, ActivityFormComponent, NoteFormComponent

    4. **Add global CSS for CDK Overlay panel** to `src/styles/tokens.css` (or create a new `slide-in-panel.scss` imported in styles.scss):
       - `.slide-in-backdrop`: background rgba(0, 0, 0, 0.3)
       - `.slide-in-panel`: animation slideInFromRight 250ms ease-out
       - `.slide-in-panel--animate-in`: transform translateX(0)
       - `@keyframes slideInFromRight { from { transform: translateX(100%); } to { transform: translateX(0); } }`
       - NOTE: CDK overlay panel classes are applied to the overlay pane element, which is OUTSIDE Angular component scope. These MUST be global styles, not component-scoped.
  </action>
  <verify>
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` compiles
    - SlideInPanelService is providedIn: 'root'
    - SlideInPanelComponent imports all 5 form components with [dialogMode]="true"
    - Global CSS has slide-in animation keyframes
    - SLIDE_IN_CONFIG injection token exists
  </verify>
  <done>
    - SlideInPanelService opens a CDK Overlay panel from the right with 520px width, backdrop, and slide-in animation
    - SlideInPanelComponent renders the correct form component based on entityType
    - Panel has header with title + close button, scrollable body with form, footer with cancel + create buttons
    - Mutual exclusion: opening slide-in closes preview sidebar, opening preview closes slide-in
    - Escape key and backdrop click close the panel
    - afterClosed observable emits the created entity result
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire quick actions to slide-in panel and add post-creation refresh with highlight</name>
  <files>
    globcrm-web/src/app/features/my-day/my-day.component.ts
    globcrm-web/src/app/features/my-day/my-day.component.html
    globcrm-web/src/app/features/my-day/my-day.store.ts
  </files>
  <action>
    1. **Update MyDayComponent** to wire quick actions:
       - Inject `SlideInPanelService`
       - Replace placeholder `onQuickAction(type: string)` with real implementation:
         ```typescript
         onQuickAction(type: string): void {
           const entityType = type as SlideInEntityType;
           // Map special cases
           const title = type === 'Email' ? 'Send Email' : `New ${type}`;
           const panelRef = this.slideInPanelService.open({ entityType, title });
           panelRef.afterClosed.subscribe(result => {
             if (result) {
               // Entity was created — refresh all widget data
               this.store.refreshData();
               // Set highlight on the new entity so user sees where it landed
               // The highlight is based on entity ID from the result
               if (result.entity?.id) {
                 this.store.setHighlight(result.entity.id);
               }
             }
           });
         }
         ```
       - For 'Email' quick action: since email compose is more complex (requires email account selection, recipient, etc.), route to `/emails/compose` instead of opening slide-in panel. Or open slide-in with a placeholder message. Decision: route to /emails (the email feature handles compose) — `if (type === 'Email') { this.router.navigate(['/emails']); return; }` — this is pragmatic since email compose has its own full-page UX.

    2. **Update MyDayStore** to support highlight animation:
       - Ensure `setHighlight(id: string)` method properly sets `highlightedItemId` and auto-clears after 2 seconds:
         ```typescript
         setHighlight(id: string): void {
           patchState(store, { highlightedItemId: id });
           setTimeout(() => {
             patchState(store, { highlightedItemId: null });
           }, 2000);
         }
         ```
       - Ensure `refreshData()` method re-calls `loadMyDay()` but without setting isLoading to true (to avoid full skeleton flash during refresh):
         ```typescript
         refreshData(): void {
           api.getMyDay().subscribe({
             next: (data) => patchState(store, { data }),
             error: () => {} // silent refresh failure
           });
         }
         ```

    3. **Add highlight/pulse CSS animation** in `my-day.component.scss`:
       - Define `.widget-item--highlighted` class:
         ```scss
         .widget-item--highlighted {
           animation: pulse-highlight 2s ease-out;
         }
         @keyframes pulse-highlight {
           0% { background-color: rgba(var(--color-primary-rgb, 255, 152, 0), 0.2); }
           100% { background-color: transparent; }
         }
         ```
       - This class gets applied to individual task/item rows when their ID matches highlightedItemId (already handled via input binding in widget components from 24-03 and 24-04)

    4. **Handle "Send Email" quick action** specifically:
       - Since the email compose experience is full-featured with recipient selection, template picking, etc., the "Send Email" quick action should navigate to the email compose page rather than opening a limited slide-in form
       - In `onQuickAction`: `if (type === 'Email') { this.router.navigate(['/emails'], { queryParams: { compose: true } }); return; }`
       - This is a pragmatic choice — email composition is complex enough that a slide-in panel would be too constrained
  </action>
  <verify>
    - `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` compiles
    - MyDayComponent injects SlideInPanelService
    - onQuickAction opens slide-in for Contact/Deal/Activity/Note and navigates for Email
    - afterClosed handler calls refreshData() and setHighlight()
    - Pulse animation CSS exists
    - refreshData() does NOT set isLoading to true (no skeleton flash)
  </verify>
  <done>
    - Quick action buttons (New Contact, New Deal, Log Activity, New Note) open slide-in panels from the right
    - Send Email quick action navigates to the email feature
    - After entity creation in slide-in panel, My Day data refreshes automatically
    - New item gets a brief pulse/highlight animation so user sees where the change landed
    - Slide-in panel closes after successful creation
    - No full-page loading skeleton during post-action refresh (seamless update)
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` passes
2. Quick action buttons open slide-in panels (not MatDialogs)
3. Forms in slide-in use [dialogMode]="true" (reusing existing form components)
4. Entity creation triggers My Day refresh
5. Slide-in panel has slide-in animation from right
6. Mutual exclusion between slide-in panel and preview sidebar works
</verification>

<success_criteria>
- Quick action buttons in greeting banner open slide-in panels from the right for Contact, Deal, Activity, and Note
- Slide-in panels contain existing form components in dialogMode — no new form code needed
- Panel has header with title and close button, scrollable body, footer with cancel/create
- After successful entity creation: panel closes, My Day data refreshes, new item pulses briefly
- CDK Overlay with backdrop, escape key close, slide-in animation
- Slide-in panel and preview sidebar are mutually exclusive (opening one closes the other)
- Send Email action navigates to email feature (pragmatic choice for complex compose UX)
</success_criteria>

<output>
After completion, create `.planning/phases/24-my-day-personal-dashboard/24-05-SUMMARY.md`
</output>
