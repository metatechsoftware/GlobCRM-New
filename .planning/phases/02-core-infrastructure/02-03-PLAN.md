---
phase: 02-core-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/ApplicationUser.cs
  - src/GlobCRM.Domain/Entities/UserPreferencesData.cs
  - src/GlobCRM.Domain/Entities/WorkSchedule.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ApplicationUserConfiguration.cs
  - src/GlobCRM.Infrastructure/Images/AvatarService.cs
  - src/GlobCRM.Infrastructure/Images/ImageServiceExtensions.cs
  - src/GlobCRM.Infrastructure/Storage/LocalFileStorageService.cs
  - src/GlobCRM.Infrastructure/Storage/IFileStorageService.cs
  - src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
autonomous: true

must_haves:
  truths:
    - "ApplicationUser has all rich profile fields: Phone, JobTitle, Department, Timezone, Language, Bio, AvatarUrl, AvatarColor, SocialLinks, WorkSchedule, ReportingManagerId, Skills"
    - "UserPreferencesData JSONB type has theme, language, timezone, date format, and email notification toggles"
    - "AvatarService processes images with SkiaSharp (resize to 256px full, 64px thumb, WebP format)"
    - "IFileStorageService abstraction exists with LocalFileStorageService implementation"
    - "SkiaSharp NuGet package installed"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/ApplicationUser.cs"
      provides: "Extended user profile with all fields"
      contains: "AvatarUrl"
    - path: "src/GlobCRM.Domain/Entities/UserPreferencesData.cs"
      provides: "JSONB preferences type"
      contains: "EmailNotifications"
    - path: "src/GlobCRM.Infrastructure/Images/AvatarService.cs"
      provides: "Server-side avatar processing"
      contains: "SKBitmap"
    - path: "src/GlobCRM.Infrastructure/Storage/IFileStorageService.cs"
      provides: "File storage abstraction"
      contains: "SaveFileAsync"
  key_links:
    - from: "src/GlobCRM.Domain/Entities/ApplicationUser.cs"
      to: "src/GlobCRM.Domain/Entities/UserPreferencesData.cs"
      via: "Preferences property (JSONB)"
      pattern: "UserPreferencesData Preferences"
    - from: "src/GlobCRM.Infrastructure/Images/AvatarService.cs"
      to: "SkiaSharp"
      via: "NuGet package dependency"
      pattern: "SKBitmap"
---

<objective>
Extend ApplicationUser with rich profile fields and JSONB preferences, create server-side avatar processing with SkiaSharp, and add file storage abstraction.

Purpose: Enables user profile editing with name, avatar, phone, job title, department, timezone, language, bio, social links, work schedule, reporting manager, and skills/tags. Preferences (theme, locale, notifications) stored as JSONB. Avatar images processed server-side with SkiaSharp.

Output: Extended ApplicationUser entity, UserPreferencesData/WorkSchedule value types, AvatarService, LocalFileStorageService, and updated EF Core configuration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md

@src/GlobCRM.Domain/Entities/ApplicationUser.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/ApplicationUserConfiguration.cs
@src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
@src/GlobCRM.Infrastructure/DependencyInjection.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ApplicationUser with profile fields and create value types</name>
  <files>
    src/GlobCRM.Domain/Entities/ApplicationUser.cs
    src/GlobCRM.Domain/Entities/UserPreferencesData.cs
    src/GlobCRM.Domain/Entities/WorkSchedule.cs
  </files>
  <action>
    **UserPreferencesData** (src/GlobCRM.Domain/Entities/UserPreferencesData.cs):
    - JSONB-mapped value type (not a separate table)
    - Properties: Theme (string, default "light" — "light" or "dark"), Language (string, default "en"), Timezone (string, default "UTC"), DateFormat (string, default "MM/dd/yyyy"), EmailNotifications (Dictionary<string, bool> with defaults: task_assigned=true, deal_updated=true, mention=true, weekly_report=true)
    - Per locked decision: theme (light/dark), language, timezone, date format + email notification toggles per event type

    **WorkSchedule** (src/GlobCRM.Domain/Entities/WorkSchedule.cs):
    - JSONB-mapped value type
    - Properties: WorkDays (List<string>, default ["Mon","Tue","Wed","Thu","Fri"]), StartTime (string, default "09:00"), EndTime (string, default "17:00")

    **ApplicationUser extension** — Add these properties to the existing ApplicationUser class:
    - Phone (string?)
    - JobTitle (string?)
    - Department (string?)
    - Timezone (string?, default "UTC")
    - Language (string?, default "en")
    - Bio (string?)
    - AvatarUrl (string? — relative path to uploaded avatar)
    - AvatarColor (string? — hex color for initials fallback circle, e.g., "#1976d2")
    - SocialLinks (Dictionary<string, string>? — JSONB, keys like "linkedin", "twitter", "github")
    - WorkSchedule (WorkSchedule? — JSONB)
    - ReportingManagerId (Guid?)
    - ReportingManager (ApplicationUser? — self-referential navigation)
    - Skills (List<string>? — JSONB array of skill/tag strings)
    - Preferences (UserPreferencesData — JSONB, initialize with new UserPreferencesData())

    Per locked decision: rich profile includes name (already exists as FirstName/LastName), email (already from Identity), avatar, phone, job title, department, timezone, language, bio, social links, work schedule, reporting manager, skills/tags.

    IMPORTANT: Do NOT remove any existing properties from ApplicationUser. Only add new ones.
  </action>
  <verify>
    `dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj` succeeds with 0 errors.
    ApplicationUser.cs contains all new profile properties.
    UserPreferencesData.cs and WorkSchedule.cs exist with correct properties.
  </verify>
  <done>ApplicationUser extended with all rich profile fields. UserPreferencesData and WorkSchedule JSONB value types created.</done>
</task>

<task type="auto">
  <name>Task 2: Update EF config, install SkiaSharp, create AvatarService and file storage, create migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/ApplicationUserConfiguration.cs
    src/GlobCRM.Infrastructure/Images/AvatarService.cs
    src/GlobCRM.Infrastructure/Images/ImageServiceExtensions.cs
    src/GlobCRM.Infrastructure/Storage/LocalFileStorageService.cs
    src/GlobCRM.Infrastructure/Storage/IFileStorageService.cs
    src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
  </files>
  <action>
    **Install SkiaSharp:**
    ```bash
    dotnet add src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj package SkiaSharp --version 3.*
    ```

    **ApplicationUserConfiguration update:**
    - Add column mappings for all new properties using snake_case: phone, job_title, department, timezone, language, bio, avatar_url, avatar_color, reporting_manager_id, skills
    - String max lengths: Phone (20), JobTitle (100), Department (100), Timezone (50), Language (10), Bio (1000), AvatarUrl (500), AvatarColor (7)
    - JSONB columns: social_links (jsonb, nullable), work_schedule (jsonb, nullable), skills (jsonb, nullable), preferences (jsonb with default `'{}'::jsonb`)
    - Self-referential FK: ReportingManagerId -> AspNetUsers with SET NULL on delete. Add `.HasForeignKey(u => u.ReportingManagerId).OnDelete(DeleteBehavior.SetNull)` — a user is NOT deleted when their manager is deleted
    - Index: idx_users_reporting_manager on reporting_manager_id

    **IFileStorageService** (src/GlobCRM.Infrastructure/Storage/IFileStorageService.cs):
    - Interface with methods:
      - `Task<string> SaveFileAsync(string tenantId, string category, string fileName, byte[] data, CancellationToken ct = default)` — returns relative path
      - `Task<byte[]?> GetFileAsync(string path, CancellationToken ct = default)`
      - `Task DeleteFileAsync(string path, CancellationToken ct = default)`
    - Per research open question: use local filesystem for Phase 2 with abstraction for later cloud swap

    **LocalFileStorageService** (src/GlobCRM.Infrastructure/Storage/LocalFileStorageService.cs):
    - Implements IFileStorageService
    - Base path: configurable via IConfiguration ("FileStorage:BasePath"), default "./uploads"
    - Directory structure: `{basePath}/{tenantId}/{category}/{fileName}` (tenant-partitioned)
    - SaveFileAsync: create directories if needed, write file, return relative path
    - GetFileAsync: read file bytes, return null if not found
    - DeleteFileAsync: delete file if exists, no error if not found

    **AvatarService** (src/GlobCRM.Infrastructure/Images/AvatarService.cs):
    - Dependencies: IFileStorageService
    - Method: `Task<(string fullPath, string thumbPath)> ProcessAndSaveAvatarAsync(string tenantId, Guid userId, Stream imageStream, CancellationToken ct = default)`
    - Process: Decode with SKBitmap, resize to 256x256 max (maintain aspect ratio) for full, 64x64 for thumb
    - Encode as WebP at quality 85
    - Save via IFileStorageService with category "avatars", filenames: `{userId}.webp` and `{userId}_thumb.webp`
    - Return both relative paths
    - Use SkiaSharp per research recommendation (free MIT license, NOT ImageSharp which costs $4999)

    **ImageServiceExtensions** (src/GlobCRM.Infrastructure/Images/ImageServiceExtensions.cs):
    - Extension method: `AddImageServices(this IServiceCollection services)` registering AvatarService as scoped
    - Also register IFileStorageService -> LocalFileStorageService as singleton

    **Migration:**
    - Run: `dotnet ef migrations add AddUserProfileFields -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api -c ApplicationDbContext`
    - Verify migration adds new columns to AspNetUsers table
    - NOTE: If running in parallel with Plans 01/02, migrations may conflict. If so, delete all three phase 2 migrations and create a single combined migration.
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    SkiaSharp package appears in Infrastructure.csproj.
    AvatarService.cs contains SKBitmap usage.
    IFileStorageService.cs defines SaveFileAsync, GetFileAsync, DeleteFileAsync.
    Migration file exists with "AddUserProfileFields" in the name.
  </verify>
  <done>ApplicationUser EF config updated with JSONB columns. SkiaSharp installed. AvatarService and LocalFileStorageService created. Migration generated.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. ApplicationUser has all 14 new profile properties
3. SkiaSharp package installed in Infrastructure project
4. AvatarService processes images to 256px and 64px WebP
5. LocalFileStorageService saves files in tenant-partitioned directory structure
6. EF Core migration adds columns to AspNetUsers table
7. JSONB columns configured for social_links, work_schedule, skills, preferences
</verification>

<success_criteria>
- ApplicationUser has all rich profile fields per locked decision
- UserPreferencesData has theme, language, timezone, date format, email notification toggles
- AvatarService works with SkiaSharp (MIT license, free)
- File storage has abstraction layer (IFileStorageService) for future cloud swap
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-03-SUMMARY.md`
</output>
