---
phase: 02-core-infrastructure
plan: 12
type: execute
wave: 5
depends_on: [02-10, 02-11]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Admin can create custom roles with per-entity permissions and field-level access controls"
    - "Admin can assign roles to users and organize them into teams"
    - "System enforces permissions across all API endpoints and UI elements"
    - "User can view and edit their own profile with name, avatar, and preferences"
    - "Admin can define custom fields with all supported types (text, number, date, dropdown, checkbox, multi-select, currency, file, relation)"
    - "Custom fields are stored in JSONB with GIN indexing and appear in dynamic tables"
    - "User can adjust table columns, save Views with filters and sorting, and switch between personal and team-wide Views"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of all Phase 2 functionality: RBAC, custom fields, dynamic tables, views, and user profiles.

Purpose: Validates that all 7 success criteria for Phase 2 are met through hands-on testing. Identifies and fixes any integration issues between the backend APIs and frontend pages.

Output: Verified Phase 2 functionality or documented issues for gap closure.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend integration verification — apply migrations, seed data, test API endpoints</name>
  <files></files>
  <action>
    **Step 1: Apply all Phase 2 migrations**
    ```bash
    dotnet ef database update -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api -c ApplicationDbContext
    ```
    If migrations fail, fix issues (common: FK ordering, duplicate column names, missing ExcludeFromMigrations for shared entities).

    **Step 2: Start the backend**
    ```bash
    cd src/GlobCRM.Api && dotnet run
    ```

    **Step 3: Verify role template seeding**
    - Start the app and check logs for role template seeding
    - Use curl or HTTP client to verify: `GET /api/roles` (with admin auth header + X-Tenant-Id header)
    - Expected: 4 template roles (Admin, Manager, Sales Rep, Viewer) with correct permissions

    **Step 4: Test RBAC API endpoints**
    - `POST /api/roles` — Create a custom role with permissions
    - `POST /api/roles/{id}/clone` — Clone a template role
    - `GET /api/roles/my-permissions` — Get effective permissions for current user
    - `POST /api/teams` — Create a team with default role
    - `POST /api/teams/{id}/members` — Add member to team
    - Verify permission cache invalidation (change role, check my-permissions changes)

    **Step 5: Test Custom Fields API**
    - `POST /api/custom-fields/sections` — Create a section
    - `POST /api/custom-fields` — Create fields of each type (text, number, date, dropdown, checkbox, multi-select, currency, file, relation)
    - `DELETE /api/custom-fields/{id}` — Soft delete a field
    - `POST /api/custom-fields/{id}/restore` — Restore it
    - Verify JSONB validation and options storage

    **Step 6: Test Views API**
    - `POST /api/views` — Create a saved view with columns, filters, sorts
    - `GET /api/views/{entityType}` — List views (should show both personal and team)
    - `POST /api/views/{id}/set-default` — Set team default

    **Step 7: Test Profile API**
    - `PUT /api/profile` — Update profile fields
    - `POST /api/profile/avatar` — Upload avatar (multipart)
    - `PUT /api/profile/preferences` — Update preferences
    - `GET /api/team-directory` — List team members with search

    **Fix any issues found** during testing. Common issues:
    - Missing using statements or DI registrations
    - JSONB serialization errors (ensure EnableDynamicJson is configured)
    - FK constraint violations in migrations
    - Global query filter issues (null tenant bypass)
    - CORS configuration for new endpoints
  </action>
  <verify>
    All API endpoints return expected responses.
    Migrations applied without errors.
    Role templates seeded for existing tenants.
    No 500 errors in backend logs.
  </verify>
  <done>All backend APIs verified working: roles, teams, custom fields, views, profile, team directory. Migrations applied. Data flows correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 2 end-to-end functionality</name>
  <files></files>
  <action>
    Present the following verification checklist to the user. The user will manually test each area.

    **Prerequisites:** Backend running on port 5233, Angular dev server running on port 4200. Login as admin user.

    **1. RBAC — Role Management (RBAC-01, RBAC-02)**
    - Navigate to /settings/roles
    - Verify 4 template roles visible (Admin, Manager, Sales Rep, Viewer)
    - Click "Clone" on Sales Rep template — enter new name — verify new custom role created
    - Edit the custom role — verify permission matrix shows entity x CRUD grid with scope dropdowns
    - Change some permissions — save — verify changes persist on reload

    **2. RBAC — Team Management (RBAC-03, RBAC-05)**
    - Navigate to /settings/teams
    - Create a new team with name and default role
    - Add a member to the team via autocomplete search
    - Verify member appears in team detail

    **3. User Profile (RBAC-04)**
    - Navigate to /profile
    - Edit profile fields: name, phone, job title, department, bio
    - Upload avatar — verify crop dialog appears — save — verify avatar displayed
    - Change theme preference to dark — verify preference saved
    - Navigate to /team-directory — verify org members listed with search

    **4. Custom Fields (CUST-01 through CUST-04)**
    - Navigate to /settings/custom-fields
    - Select "Contact" entity type
    - Create fields: text field, number field, dropdown field (with options), date field, checkbox, multi-select, currency, file, relation
    - Verify all 9 types can be created with validation rules
    - Delete a field — verify it disappears — enable "Show Deleted" — restore it

    **5. Dynamic Table and Views (VIEW-01 through VIEW-06)**
    - NOTE: Full dynamic table testing requires entity data (Phase 3). For now verify:
    - Check that the DynamicTableComponent renders without errors (can test on a placeholder page)
    - Verify column picker dropdown works (show/hide columns)
    - Verify view sidebar shows Personal/Team sections

    **6. Permission Enforcement (RBAC-06)**
    - As admin: verify all settings pages accessible
    - Check that *appHasPermission directive correctly shows/hides elements based on user role
  </action>
  <verify>User confirms all 6 verification areas pass, or provides list of issues for gap closure.</verify>
  <done>All Phase 2 success criteria verified by human testing. No critical issues found.</done>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:
1. Admin can create custom roles with per-entity permissions and field-level access controls
2. Admin can assign roles to users and organize them into teams
3. System enforces permissions across all API endpoints and UI elements
4. User can view and edit their own profile with name, avatar, and preferences
5. Admin can define custom fields with all supported types
6. Custom fields are stored in JSONB with GIN indexing
7. User can adjust table columns, save Views with filters and sorting, and switch between personal and team-wide Views
</verification>

<success_criteria>
All 7 Phase 2 success criteria verified through hands-on testing.
Backend APIs return correct responses.
Frontend pages render and function correctly.
No critical errors in console or logs.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-12-SUMMARY.md`
</output>
