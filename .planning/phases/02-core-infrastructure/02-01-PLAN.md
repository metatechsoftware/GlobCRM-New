---
phase: 02-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Role.cs
  - src/GlobCRM.Domain/Entities/RolePermission.cs
  - src/GlobCRM.Domain/Entities/RoleFieldPermission.cs
  - src/GlobCRM.Domain/Entities/Team.cs
  - src/GlobCRM.Domain/Entities/TeamMember.cs
  - src/GlobCRM.Domain/Entities/UserRoleAssignment.cs
  - src/GlobCRM.Domain/Enums/PermissionScope.cs
  - src/GlobCRM.Domain/Enums/FieldAccessLevel.cs
  - src/GlobCRM.Domain/Enums/EntityType.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/RoleConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/RolePermissionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/RoleFieldPermissionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/TeamConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/TeamMemberConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/UserRoleAssignmentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Role, RolePermission, RoleFieldPermission, Team, TeamMember, UserRoleAssignment entities exist with correct properties"
    - "PermissionScope (None/Own/Team/All), FieldAccessLevel (Hidden/ReadOnly/Editable), EntityType enums exist"
    - "EF Core configurations use snake_case and have correct FK relationships and unique constraints"
    - "ApplicationDbContext has DbSets and global query filters for all new tenant-scoped entities"
    - "RLS script updated with policies for new tables"
    - "EF Core migration created and applies without errors"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Role.cs"
      provides: "Custom role entity with TenantId, Name, Description, IsSystem, IsTemplate"
      contains: "class Role"
    - path: "src/GlobCRM.Domain/Entities/RolePermission.cs"
      provides: "Per-entity CRUD permission with scope"
      contains: "PermissionScope Scope"
    - path: "src/GlobCRM.Domain/Entities/Team.cs"
      provides: "Team entity with DefaultRoleId"
      contains: "DefaultRoleId"
    - path: "src/GlobCRM.Domain/Enums/PermissionScope.cs"
      provides: "Permission scope enum"
      contains: "None.*Own.*Team.*All"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and query filters for RBAC entities"
      contains: "DbSet<Role>"
  key_links:
    - from: "src/GlobCRM.Domain/Entities/RolePermission.cs"
      to: "src/GlobCRM.Domain/Entities/Role.cs"
      via: "RoleId FK"
      pattern: "Role.*Role"
    - from: "src/GlobCRM.Domain/Entities/TeamMember.cs"
      to: "src/GlobCRM.Domain/Entities/Team.cs"
      via: "TeamId FK"
      pattern: "Team.*Team"
    - from: "src/GlobCRM.Domain/Entities/UserRoleAssignment.cs"
      to: "src/GlobCRM.Domain/Entities/Role.cs"
      via: "RoleId FK"
      pattern: "Role.*Role"
---

<objective>
Create all RBAC domain entities, enums, and EF Core configurations for the permission system.

Purpose: Establishes the database schema for custom roles with per-entity CRUD permissions + ownership scope + field-level access, teams with default roles, and direct user-role assignments. This is the foundation all permission checks build on.

Output: Domain entities, enums, EF Core configurations, updated ApplicationDbContext, RLS script, and migration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md

# Phase 1 references (for established patterns)
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

# Existing domain entities to reference for pattern consistency
@src/GlobCRM.Domain/Entities/Organization.cs
@src/GlobCRM.Domain/Entities/ApplicationUser.cs
@src/GlobCRM.Domain/Entities/Invitation.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RBAC domain entities and enums</name>
  <files>
    src/GlobCRM.Domain/Enums/PermissionScope.cs
    src/GlobCRM.Domain/Enums/FieldAccessLevel.cs
    src/GlobCRM.Domain/Enums/EntityType.cs
    src/GlobCRM.Domain/Entities/Role.cs
    src/GlobCRM.Domain/Entities/RolePermission.cs
    src/GlobCRM.Domain/Entities/RoleFieldPermission.cs
    src/GlobCRM.Domain/Entities/Team.cs
    src/GlobCRM.Domain/Entities/TeamMember.cs
    src/GlobCRM.Domain/Entities/UserRoleAssignment.cs
  </files>
  <action>
    Create the Enums directory under Domain if it doesn't exist.

    **PermissionScope enum** (src/GlobCRM.Domain/Enums/PermissionScope.cs):
    - Values: None = 0, Own = 1, Team = 2, All = 3
    - Ordered so Max() gives most permissive (used for "most permissive wins" resolution)

    **FieldAccessLevel enum** (src/GlobCRM.Domain/Enums/FieldAccessLevel.cs):
    - Values: Hidden = 0, ReadOnly = 1, Editable = 2

    **EntityType enum** (src/GlobCRM.Domain/Enums/EntityType.cs):
    - Values: Contact, Company, Deal, Activity, Quote, Request, Product
    - These are the permission targets — entity types that can have CRUD permissions

    **Role entity** (src/GlobCRM.Domain/Entities/Role.cs):
    - Properties: Id (Guid), TenantId (Guid), Name (string, required), Description (string?), IsSystem (bool, default false — true for built-in roles that cannot be deleted), IsTemplate (bool, default false — true for clonable template roles), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Organization (via TenantId), ICollection<RolePermission> Permissions, ICollection<RoleFieldPermission> FieldPermissions

    **RolePermission entity** (src/GlobCRM.Domain/Entities/RolePermission.cs):
    - Properties: Id (Guid), RoleId (Guid), EntityType (string — stored as string not enum for flexibility), Operation (string — "View", "Create", "Edit", "Delete"), Scope (PermissionScope)
    - Navigation: Role

    **RoleFieldPermission entity** (src/GlobCRM.Domain/Entities/RoleFieldPermission.cs):
    - Properties: Id (Guid), RoleId (Guid), EntityType (string), FieldName (string — core field name or custom field ID as string), AccessLevel (FieldAccessLevel, default Editable)
    - Navigation: Role

    **Team entity** (src/GlobCRM.Domain/Entities/Team.cs):
    - Properties: Id (Guid), TenantId (Guid), Name (string, required), Description (string?), DefaultRoleId (Guid? — the role inherited by all team members), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Organization (via TenantId), Role? DefaultRole, ICollection<TeamMember> Members

    **TeamMember entity** (src/GlobCRM.Domain/Entities/TeamMember.cs):
    - Properties: Id (Guid), TeamId (Guid), UserId (Guid)
    - Navigation: Team, ApplicationUser User

    **UserRoleAssignment entity** (src/GlobCRM.Domain/Entities/UserRoleAssignment.cs):
    - Properties: Id (Guid), UserId (Guid), RoleId (Guid)
    - Navigation: ApplicationUser User, Role

    Follow existing entity patterns: Guid IDs, DateTimeOffset for timestamps, consistent naming. Do NOT add TenantId to RolePermission, RoleFieldPermission, TeamMember, or UserRoleAssignment — they are child records of tenant-scoped parents (Role, Team) and inherit tenant isolation through their parent FK.
  </action>
  <verify>
    `dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj` succeeds with 0 errors.
    All 9 files exist with correct properties.
  </verify>
  <done>All RBAC domain entities and enums created with correct properties, navigation properties, and FK references.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update ApplicationDbContext, update RLS script, and create migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/RoleConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/RolePermissionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/RoleFieldPermissionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/TeamConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/TeamMemberConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/UserRoleAssignmentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    **EF Core configurations** — Follow existing patterns from OrganizationConfiguration.cs:
    - Use snake_case table names: "roles", "role_permissions", "role_field_permissions", "teams", "team_members", "user_role_assignments"
    - Use snake_case column names for all properties
    - Configure string max lengths: Role.Name (100), Role.Description (500), RolePermission.EntityType (50), RolePermission.Operation (20), RoleFieldPermission.EntityType (50), RoleFieldPermission.FieldName (100), Team.Name (100), Team.Description (500)
    - Configure unique constraints: (tenant_id, name) on roles; (role_id, entity_type, operation) on role_permissions; (role_id, entity_type, field_name) on role_field_permissions; (tenant_id, name) on teams; (team_id, user_id) on team_members; (user_id, role_id) on user_role_assignments
    - Configure FK relationships with ON DELETE CASCADE for child records (role_permissions, role_field_permissions, team_members cascade from parent)
    - UserRoleAssignment: CASCADE on delete from both user and role sides
    - Team.DefaultRoleId: FK to Role with SET NULL on delete (if role deleted, team loses default)
    - Add indexes: idx_roles_tenant on roles(tenant_id), idx_teams_tenant on teams(tenant_id), idx_team_members_user on team_members(user_id), idx_user_role_assignments_user on user_role_assignments(user_id)
    - Store PermissionScope and FieldAccessLevel as SMALLINT (not string)

    **ApplicationDbContext update:**
    - Add DbSet<Role> Roles, DbSet<RolePermission> RolePermissions, DbSet<RoleFieldPermission> RoleFieldPermissions, DbSet<Team> Teams, DbSet<TeamMember> TeamMembers, DbSet<UserRoleAssignment> UserRoleAssignments
    - Add global query filters for Role and Team (tenant-scoped): `.HasQueryFilter(e => _tenantProvider == null || e.TenantId == _tenantProvider.TenantId)`
    - RolePermission, RoleFieldPermission, TeamMember, UserRoleAssignment do NOT need their own query filters — they are filtered through their parent's FK relationship
    - Register new configurations in OnModelCreating via ApplyConfigurationsFromAssembly (already in place) or explicit ApplyConfiguration calls

    **RLS script update** (scripts/rls-setup.sql):
    - Add RLS policies for "roles" and "teams" tables (tenant_id = current_setting('app.current_tenant')::uuid)
    - Enable RLS and FORCE RLS on both tables, following existing pattern
    - Child tables (role_permissions, etc.) do NOT need RLS — they are accessed through FK joins from tenant-filtered parents

    **Migration:**
    - Run: `dotnet ef migrations add AddRbacEntities -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api -c ApplicationDbContext`
    - Verify the migration creates all 6 tables with correct columns, FKs, and indexes
    - Do NOT run `dotnet ef database update` — migration file creation is sufficient
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    Migration file exists in src/GlobCRM.Infrastructure/Persistence/Migrations/ with "AddRbacEntities" in the name.
    The migration's Up() method creates tables: roles, role_permissions, role_field_permissions, teams, team_members, user_role_assignments.
  </verify>
  <done>EF Core configurations created with snake_case naming and proper constraints. ApplicationDbContext updated with DbSets and query filters. RLS script updated. Migration generated successfully.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors across all projects
2. All 15 new/modified files exist on disk
3. Migration file created with correct table definitions
4. Domain entities have correct properties and navigation properties
5. EF Core configurations have snake_case naming, unique constraints, and FK relationships
6. ApplicationDbContext has DbSets and global query filters for Role and Team
7. RLS script has policies for roles and teams tables
</verification>

<success_criteria>
- All RBAC domain entities (Role, RolePermission, RoleFieldPermission, Team, TeamMember, UserRoleAssignment) exist with correct properties
- All enums (PermissionScope, FieldAccessLevel, EntityType) exist with correct values
- EF Core migration generated successfully for all 6 new tables
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-01-SUMMARY.md`
</output>
