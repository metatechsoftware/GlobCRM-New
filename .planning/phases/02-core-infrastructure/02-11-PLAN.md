---
phase: 02-core-infrastructure
plan: 11
type: execute
wave: 4
depends_on: [02-08, 02-09]
files_modified:
  - globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.ts
  - globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.html
  - globcrm-web/src/app/features/settings/custom-fields/custom-field-edit-dialog.component.ts
  - globcrm-web/src/app/features/settings/custom-fields/custom-field-edit-dialog.component.html
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/app/shared/components/avatar/avatar.component.ts
  - globcrm-web/src/app/shared/components/avatar/avatar-upload.component.ts
  - globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.ts
  - globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.html
  - globcrm-web/src/app/features/profile/profile-view/profile-view.component.ts
  - globcrm-web/src/app/features/profile/team-directory/team-directory.component.ts
  - globcrm-web/src/app/features/profile/team-directory/team-directory.component.html
  - globcrm-web/src/app/features/profile/profile.routes.ts
  - globcrm-web/src/app/features/profile/profile.service.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/package.json
autonomous: true

must_haves:
  truths:
    - "Admin can view, create, edit, soft-delete, and restore custom field definitions per entity type"
    - "Custom field editor supports all 9 field types with validation rules and dropdown option management"
    - "User can view and edit their own profile with all rich fields"
    - "User can upload and crop avatar image with ngx-image-cropper"
    - "User can browse team directory showing all org members with search and pagination"
    - "Avatar component shows uploaded image or initials fallback with colored circle"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.ts"
      provides: "Custom field management page"
      contains: "CustomFieldListComponent"
    - path: "globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.ts"
      provides: "Profile edit page"
      contains: "ProfileEditComponent"
    - path: "globcrm-web/src/app/features/profile/team-directory/team-directory.component.ts"
      provides: "Team directory page"
      contains: "TeamDirectoryComponent"
    - path: "globcrm-web/src/app/shared/components/avatar/avatar.component.ts"
      provides: "Avatar display with initials fallback"
      contains: "AvatarComponent"
    - path: "globcrm-web/src/app/shared/components/avatar/avatar-upload.component.ts"
      provides: "Avatar upload with crop dialog"
      contains: "AvatarUploadComponent"
  key_links:
    - from: "globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.ts"
      to: "globcrm-web/src/app/core/custom-fields/custom-field.service.ts"
      via: "CustomFieldService for API calls"
      pattern: "CustomFieldService"
    - from: "globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.ts"
      to: "globcrm-web/src/app/features/profile/profile.service.ts"
      via: "ProfileService for API calls"
      pattern: "ProfileService"
---

<objective>
Build Angular custom field settings page, user profile pages (edit, view, team directory), and avatar components.

Purpose: Provides the admin UI for managing custom field definitions (CUST-01 through CUST-04) and the user-facing profile experience (RBAC-04) including rich profile editing, avatar upload with crop, preferences management, and team directory browsing.

Output: Custom field management page, profile edit/view pages, team directory, avatar component, avatar upload with crop, and profile service.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-infrastructure/02-08-SUMMARY.md
@.planning/phases/02-core-infrastructure/02-09-SUMMARY.md

@globcrm-web/src/app/core/custom-fields/custom-field.service.ts
@globcrm-web/src/app/core/custom-fields/custom-field.models.ts
@globcrm-web/src/app/core/api/api.service.ts
@globcrm-web/src/app/core/auth/auth.store.ts
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom field settings page with CRUD and field type management</name>
  <files>
    globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.ts
    globcrm-web/src/app/features/settings/custom-fields/custom-field-list.component.html
    globcrm-web/src/app/features/settings/custom-fields/custom-field-edit-dialog.component.ts
    globcrm-web/src/app/features/settings/custom-fields/custom-field-edit-dialog.component.html
    globcrm-web/src/app/features/settings/settings.routes.ts
  </files>
  <action>
    **Update settings.routes.ts:**
    - Add route: `custom-fields` → CustomFieldListComponent

    **CustomFieldListComponent:**
    - Top bar: entity type selector (mat-tab-group or mat-select with entity types: Contact, Company, Deal, Activity, Quote, Request, Product)
    - On entity type change: load fields via CustomFieldService.getFieldsByEntityType(entityType)
    - Display fields grouped by section (per research recommendation: admin-defined sections)
      - Each section rendered as a mat-expansion-panel with section name header
      - Fields without section grouped under "General" default section
      - Within each section: mat-table with columns: Label, Name, Type (chip), Required, Sort Order, Actions
    - Actions per field: Edit (opens dialog), Delete (soft-delete with confirm), Restore (shown for deleted fields)
    - "Show Deleted" toggle at top — when enabled, load deleted fields and show them with a "Deleted" badge and Restore action
    - "Add Field" button opening the edit dialog in create mode
    - "Manage Sections" button opening a section management panel (add, rename, reorder, delete sections)
    - Per locked decision: dual creation path — Settings page for bulk management (this page) + inline "Add Field" on entity pages (Phase 3)

    **CustomFieldEditDialogComponent** (mat-dialog):
    - Mode: 'create' or 'edit'
    - Form fields:
      - Name (mat-input — only editable in create mode, auto-generated from Label as snake_case)
      - Label (mat-input, required)
      - Field Type (mat-select — all 9 types, only editable in create mode)
      - Section (mat-select — from loaded sections, nullable)
      - Sort Order (mat-input, number)
    - Conditional fields based on FieldType:
      - **Text**: MinLength, MaxLength, RegexPattern inputs
      - **Number**: MinValue, MaxValue inputs
      - **Currency**: MinValue, MaxValue inputs (same as number)
      - **Date**: no extra validation fields
      - **Dropdown**: Options list with add/remove/reorder — each option has Value, Label, Color (color picker or text)
      - **MultiSelect**: Same as Dropdown
      - **Checkbox**: no extra fields
      - **File**: no extra validation fields
      - **Relation**: RelationEntityType (mat-select with entity types)
    - Validation section (collapsible):
      - Required (mat-checkbox)
      - Unique (mat-checkbox)
      - Conditional Required: Field (mat-select of other fields) + Value (mat-input)
    - Save/Cancel buttons
    - On save: call CustomFieldService.createField or updateField

    Per locked decision: advanced validation — required, min/max length/value, regex patterns, unique constraints, conditional required.
    Per locked decision: supported types — text, number, date, dropdown, checkbox, multi-select, currency, file, relation.

    Use Angular Material: MatDialogModule, MatTabsModule, MatTableModule, MatSelectModule, MatInputModule, MatButtonModule, MatCheckboxModule, MatExpansionModule, MatChipsModule, MatIconModule, MatSlideToggleModule.
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    CustomFieldListComponent shows fields grouped by section.
    CustomFieldEditDialogComponent supports all 9 field types with type-specific validation fields.
    Settings routes include custom-fields path.
  </verify>
  <done>Custom field management page created with entity type tabs, section grouping, field CRUD dialog, and soft-delete/restore capability.</done>
</task>

<task type="auto">
  <name>Task 2: Create profile pages, avatar components, team directory, and install ngx-image-cropper</name>
  <files>
    globcrm-web/src/app/shared/components/avatar/avatar.component.ts
    globcrm-web/src/app/shared/components/avatar/avatar-upload.component.ts
    globcrm-web/src/app/features/profile/profile.service.ts
    globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.ts
    globcrm-web/src/app/features/profile/profile-edit/profile-edit.component.html
    globcrm-web/src/app/features/profile/profile-view/profile-view.component.ts
    globcrm-web/src/app/features/profile/team-directory/team-directory.component.ts
    globcrm-web/src/app/features/profile/team-directory/team-directory.component.html
    globcrm-web/src/app/features/profile/profile.routes.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/package.json
  </files>
  <action>
    **Install ngx-image-cropper:**
    ```bash
    cd globcrm-web && npm install ngx-image-cropper@^9.1.0
    ```

    **AvatarComponent** (shared/components/avatar/avatar.component.ts):
    - Standalone component
    - Inputs: `avatarUrl: string | null`, `firstName: string`, `lastName: string`, `avatarColor: string | null`, `size: 'sm' | 'md' | 'lg'` (default 'md')
    - Logic:
      - If avatarUrl: show `<img>` with the URL
      - If no avatarUrl: show colored circle with initials (first letter of firstName + first letter of lastName)
      - Color: use avatarColor if provided, otherwise generate from name hash (deterministic)
      - Sizes: sm=32px, md=48px, lg=96px
    - Per locked decision: auto-generated colored circle with initials as fallback

    **AvatarUploadComponent** (shared/components/avatar/avatar-upload.component.ts):
    - Standalone component using ngx-image-cropper
    - Inputs: `currentAvatarUrl: string | null`
    - Outputs: `avatarUploaded: { avatarUrl: string }`
    - UI:
      - Show current avatar (or initials) with "Change Photo" overlay on hover
      - Hidden file input triggered by click
      - On file select: show ngx-image-cropper (ImageCropperComponent) in a mat-dialog
      - Cropper config: maintainAspectRatio=true, aspectRatio=1, resizeToWidth=256, format='webp'
      - Save button in dialog: take cropped blob, create FormData, POST to /api/profile/avatar
      - On success: emit avatarUploaded with new URL
      - "Remove Photo" button if current avatar exists: DELETE /api/profile/avatar
    - Per locked decision: avatar upload with crop dialog

    **ProfileService** (features/profile/profile.service.ts):
    - Injectable service using ApiService
    - Methods:
      - `getProfile(): Observable<ProfileDto>` — GET /api/profile
      - `getPublicProfile(userId: string): Observable<ProfileDto>` — GET /api/profile/{userId}
      - `updateProfile(data: UpdateProfileRequest): Observable<ProfileDto>` — PUT /api/profile
      - `uploadAvatar(file: Blob): Observable<{ avatarUrl: string }>` — POST /api/profile/avatar (multipart)
      - `deleteAvatar(): Observable<void>` — DELETE /api/profile/avatar
      - `getPreferences(): Observable<PreferencesDto>` — GET /api/profile/preferences
      - `updatePreferences(data: UpdatePreferencesRequest): Observable<PreferencesDto>` — PUT /api/profile/preferences
      - `getTeamDirectory(params: { search?: string, department?: string, page?: number, pageSize?: number }): Observable<PaginatedResult<TeamMemberDto>>` — GET /api/team-directory

    **ProfileEditComponent:**
    - Load profile via ProfileService.getProfile()
    - Form sections:
      1. **Personal Info**: AvatarUploadComponent at top, FirstName, LastName, Email (read-only), Phone, Bio
      2. **Work Info**: JobTitle, Department, ReportingManager (mat-autocomplete searching team directory), Skills (mat-chip-list with add/remove)
      3. **Social Links**: LinkedIn, Twitter, GitHub (mat-input for each)
      4. **Work Schedule**: Work days (checkboxes for Mon-Sun), Start time, End time (mat-input type="time")
      5. **Preferences**: Theme (mat-radio: Light/Dark), Language (mat-select), Timezone (mat-select with common timezones), Date Format (mat-select)
      6. **Notifications**: Email notification toggles (mat-slide-toggle for each: task_assigned, deal_updated, mention, weekly_report)
    - Save button: calls updateProfile + updatePreferences separately
    - Per locked decision: rich profile fields, configurable preferences with theme/language/timezone/date format and notification toggles

    **ProfileViewComponent:**
    - Load profile via ProfileService.getPublicProfile(userId)
    - Read-only display of public profile fields
    - Avatar at top, name, email, phone, job title, department, bio, social links, skills
    - Used when viewing another user's profile from team directory

    **TeamDirectoryComponent:**
    - Load via ProfileService.getTeamDirectory()
    - Search bar (mat-input with debounce 300ms)
    - Department filter (mat-select)
    - Grid of user cards: avatar + name + job title + department + email + phone
    - Click card → navigate to /profile/{userId} (profile view)
    - Pagination at bottom (mat-paginator)
    - Per locked decision: team directory with all org users viewable

    **Profile routes** (features/profile/profile.routes.ts):
    - `/profile` → ProfileEditComponent (own profile)
    - `/profile/:userId` → ProfileViewComponent (view other)
    - `/team-directory` → TeamDirectoryComponent

    **App routes update:**
    - Add lazy-loaded routes for profile and team-directory
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    ngx-image-cropper installed in package.json.
    AvatarComponent shows image or initials fallback.
    AvatarUploadComponent uses ngx-image-cropper in dialog.
    ProfileEditComponent has all form sections.
    TeamDirectoryComponent shows user cards with search.
    Profile routes registered in app.routes.ts.
  </verify>
  <done>Profile edit, profile view, team directory, avatar components created. User can manage profile, upload avatar with crop, and browse team directory.</done>
</task>

</tasks>

<verification>
1. `ng build` succeeds from globcrm-web/
2. Custom field settings: entity type tabs, section grouping, field CRUD dialog, all 9 types
3. Profile edit: personal info, work info, social links, work schedule, preferences, notifications
4. Avatar: shows image or initials fallback, upload with crop via ngx-image-cropper
5. Team directory: user cards with search and pagination
6. All routes registered and lazy-loaded
</verification>

<success_criteria>
- Admin can manage custom field definitions with all 9 types and validation rules
- User can edit profile with all rich fields per locked decision
- Avatar upload works with crop dialog
- Team directory shows all org members with search
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-11-SUMMARY.md`
</output>
