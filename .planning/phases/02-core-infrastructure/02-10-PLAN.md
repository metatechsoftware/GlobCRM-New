---
phase: 02-core-infrastructure
plan: 10
type: execute
wave: 4
depends_on: [02-09]
files_modified:
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/app/features/settings/roles/role-list.component.ts
  - globcrm-web/src/app/features/settings/roles/role-list.component.html
  - globcrm-web/src/app/features/settings/roles/role-edit.component.ts
  - globcrm-web/src/app/features/settings/roles/role-edit.component.html
  - globcrm-web/src/app/features/settings/roles/permission-matrix.component.ts
  - globcrm-web/src/app/features/settings/roles/permission-matrix.component.html
  - globcrm-web/src/app/features/settings/teams/team-list.component.ts
  - globcrm-web/src/app/features/settings/teams/team-list.component.html
  - globcrm-web/src/app/features/settings/teams/team-edit.component.ts
  - globcrm-web/src/app/features/settings/teams/team-edit.component.html
  - globcrm-web/src/app/app.routes.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all roles with name, type (system/custom), and user count"
    - "Admin can create/edit roles with permission matrix: rows=entity types, columns=CRUD, cells=scope dropdowns"
    - "Admin can clone a template role to create a custom role"
    - "Admin can view list of all teams with member count and default role"
    - "Admin can create/edit teams and manage members (add/remove)"
    - "Settings routes are lazy-loaded and protected with admin role check"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/roles/role-list.component.ts"
      provides: "Role management list page"
      contains: "RoleListComponent"
    - path: "globcrm-web/src/app/features/settings/roles/permission-matrix.component.ts"
      provides: "Permission matrix grid UI"
      contains: "PermissionMatrixComponent"
    - path: "globcrm-web/src/app/features/settings/teams/team-list.component.ts"
      provides: "Team management list page"
      contains: "TeamListComponent"
  key_links:
    - from: "globcrm-web/src/app/features/settings/roles/role-edit.component.ts"
      to: "globcrm-web/src/app/core/permissions/permission.service.ts"
      via: "PermissionService for role CRUD"
      pattern: "PermissionService"
    - from: "globcrm-web/src/app/features/settings/roles/permission-matrix.component.ts"
      to: "globcrm-web/src/app/core/permissions/permission.models.ts"
      via: "RolePermissionDto for matrix data"
      pattern: "RolePermissionDto"
---

<objective>
Build Angular admin settings pages for role management (with permission matrix) and team management.

Purpose: Provides the admin UI for creating and managing custom roles with per-entity CRUD permissions and field-level access (RBAC-01, RBAC-02, RBAC-03), and for organizing users into teams with default roles (RBAC-05). The permission matrix uses a grid layout with entity rows, CRUD columns, and scope dropdowns per research recommendation.

Output: Role list/edit pages with permission matrix, team list/edit pages with member management, settings routing.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-infrastructure/02-09-SUMMARY.md

@globcrm-web/src/app/core/permissions/permission.service.ts
@globcrm-web/src/app/core/permissions/permission.models.ts
@globcrm-web/src/app/core/permissions/permission.store.ts
@globcrm-web/src/app/app.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create role management pages with permission matrix</name>
  <files>
    globcrm-web/src/app/features/settings/settings.routes.ts
    globcrm-web/src/app/features/settings/roles/role-list.component.ts
    globcrm-web/src/app/features/settings/roles/role-list.component.html
    globcrm-web/src/app/features/settings/roles/role-edit.component.ts
    globcrm-web/src/app/features/settings/roles/role-edit.component.html
    globcrm-web/src/app/features/settings/roles/permission-matrix.component.ts
    globcrm-web/src/app/features/settings/roles/permission-matrix.component.html
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
    **Settings routes** (features/settings/settings.routes.ts):
    - Lazy-loaded feature routes under /settings
    - Children:
      - `roles` → RoleListComponent
      - `roles/new` → RoleEditComponent (create mode)
      - `roles/:id` → RoleEditComponent (edit mode)
      - `teams` → TeamListComponent (Plan 10 Task 2)
      - `teams/new` → TeamEditComponent
      - `teams/:id` → TeamEditComponent

    **App routes update:**
    - Add to app.routes.ts: `{ path: 'settings', loadChildren: () => import('./features/settings/settings.routes').then(m => m.SETTINGS_ROUTES), canActivate: [authGuard] }`

    **RoleListComponent:**
    - Load roles via PermissionService.getRoles()
    - Display as mat-table with columns: Name, Description, Type (System/Custom chip), Users, Actions
    - System/Template roles shown with a mat-chip badge
    - Actions per row:
      - Edit button (disabled for system roles)
      - Clone button (for template roles — opens dialog for new name, then clones)
      - Delete button (disabled for system roles, confirm dialog before delete)
    - "Create Role" button at top navigating to /settings/roles/new
    - Loading spinner while data loads
    - Error state with retry button

    **RoleEditComponent:**
    - Mode: 'create' or 'edit' based on route params (check for :id)
    - Form fields:
      - Name (mat-input, required, 1-100 chars)
      - Description (mat-input/textarea, optional)
    - Below form: embedded PermissionMatrixComponent
    - Save button: creates or updates role with current matrix state
    - On edit: load role via PermissionService.getRole(id), populate form and matrix
    - On save: collect form data + matrix permissions, call create/update API
    - Navigate back to role list on success with snackbar confirmation

    **PermissionMatrixComponent** (the core RBAC UI):
    - Per research recommendation: matrix grid — rows=entity types, columns=CRUD operations, cells=scope dropdowns
    - Inputs: `permissions: RolePermissionDto[]` (initial state)
    - Outputs: `permissionsChanged: RolePermissionDto[]` (emitted on any change)
    - Structure:
      ```
      | Entity      | View         | Create       | Edit         | Delete       |
      |-------------|--------------|--------------|--------------|--------------|
      | Contact     | [All ▼]      | [Team ▼]     | [Own ▼]      | [None ▼]     |
      | Company     | [All ▼]      | [All ▼]      | [All ▼]      | [All ▼]      |
      | Deal        | [Team ▼]     | [Team ▼]     | [Team ▼]     | [None ▼]     |
      | Activity    | ...          | ...          | ...          | ...          |
      | Quote       | ...          | ...          | ...          | ...          |
      | Request     | ...          | ...          | ...          | ...          |
      | Product     | ...          | ...          | ...          | ...          |
      ```
    - Entity types: all values from EntityType enum (Contact, Company, Deal, Activity, Quote, Request, Product)
    - Operations: View, Create, Edit, Delete
    - Each cell: mat-select with options [None, Own, Team, All]
    - Color coding: None=grey, Own=yellow, Team=blue, All=green (use option classes)
    - "Set all to..." row at top: quick-set dropdowns that apply a scope to all entities for that operation
    - On any change: rebuild the full permissions array and emit permissionsChanged
    - Use a 2D signal/computed for efficient reactive rendering

    Use Angular Material components: MatTableModule (for matrix grid), MatSelectModule, MatInputModule, MatButtonModule, MatChipsModule, MatDialogModule (for clone dialog), MatSnackBarModule.
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    RoleListComponent shows roles in a table.
    PermissionMatrixComponent renders entity×CRUD grid with scope dropdowns.
    RoleEditComponent has form + embedded matrix.
  </verify>
  <done>Role list, role edit with permission matrix grid, and role cloning created. Admin can manage roles with per-entity CRUD permissions.</done>
</task>

<task type="auto">
  <name>Task 2: Create team management pages with member management</name>
  <files>
    globcrm-web/src/app/features/settings/teams/team-list.component.ts
    globcrm-web/src/app/features/settings/teams/team-list.component.html
    globcrm-web/src/app/features/settings/teams/team-edit.component.ts
    globcrm-web/src/app/features/settings/teams/team-edit.component.html
  </files>
  <action>
    **TeamListComponent:**
    - Load teams via PermissionService.getTeams()
    - Display as mat-table with columns: Name, Description, Default Role, Members, Actions
    - Default Role shown as mat-chip
    - Actions: Edit, Delete (with confirm dialog)
    - "Create Team" button navigating to /settings/teams/new

    **TeamEditComponent:**
    - Mode: 'create' or 'edit' based on route params
    - Form fields:
      - Name (mat-input, required, 1-100 chars)
      - Description (mat-input/textarea, optional)
      - Default Role (mat-select — populated from PermissionService.getRoles(), nullable)
    - Member management section (only in edit mode):
      - Current members list showing name, email, avatar (using existing navbar avatar pattern), with remove button
      - "Add Member" button opening a dialog/autocomplete to search and select org users
      - Add member dialog: mat-autocomplete searching team directory (GET /api/team-directory?search=...), shows matching users, click to add
      - After add/remove: reload team detail to refresh member list
    - Save button: creates or updates team, then navigates back
    - On save success: snackbar confirmation

    **Add Member Dialog (inline or as a separate small component):**
    - mat-form-field with mat-autocomplete
    - On type: debounce 300ms, search team directory API
    - Show results as list items with avatar + name + email
    - On select: call PermissionService.addTeamMember(teamId, userId)
    - Close dialog on success

    Use Angular Material: MatTableModule, MatSelectModule, MatInputModule, MatButtonModule, MatAutocompleteModule, MatDialogModule, MatChipsModule, MatSnackBarModule, MatIconModule.
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    TeamListComponent shows teams in a table.
    TeamEditComponent has form + member management.
    Add member uses autocomplete search.
  </verify>
  <done>Team list and team edit pages created with member add/remove via autocomplete search. Admin can manage teams and assign users.</done>
</task>

</tasks>

<verification>
1. `ng build` succeeds from globcrm-web/
2. /settings/roles shows role list with CRUD actions
3. Role edit page has permission matrix with entity×CRUD grid
4. Permission matrix cells have scope dropdowns (None/Own/Team/All)
5. Role cloning works from template roles
6. /settings/teams shows team list with CRUD actions
7. Team edit has member add/remove via autocomplete
8. Settings routes are lazy-loaded under /settings
</verification>

<success_criteria>
- Admin can create, edit, clone, and delete roles with permission matrix UI
- Permission matrix shows entity types as rows, CRUD as columns, scope dropdowns as cells
- Admin can create, edit, and delete teams with default role selection
- Admin can add and remove team members via search autocomplete
- Settings routes protected with auth guard
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-10-SUMMARY.md`
</output>
