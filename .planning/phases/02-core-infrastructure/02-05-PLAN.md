---
phase: 02-core-infrastructure
plan: 05
type: execute
wave: 2
depends_on: [02-02]
files_modified:
  - src/GlobCRM.Domain/Interfaces/ICustomFieldRepository.cs
  - src/GlobCRM.Domain/Interfaces/IViewRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/CustomFieldRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/ViewRepository.cs
  - src/GlobCRM.Infrastructure/CustomFields/CustomFieldValidator.cs
  - src/GlobCRM.Infrastructure/CustomFields/CustomFieldServiceExtensions.cs
  - src/GlobCRM.Api/Controllers/CustomFieldsController.cs
  - src/GlobCRM.Api/Controllers/ViewsController.cs
autonomous: true

must_haves:
  truths:
    - "CustomFieldsController supports CRUD for field definitions and sections with admin authorization"
    - "CustomFieldValidator validates JSONB custom field values against field definitions (type, required, min/max, regex, unique)"
    - "ViewsController supports CRUD for saved views with personal/team distinction"
    - "Soft-deleted fields are excluded by default but restorable via dedicated endpoint"
    - "Views API returns both personal views and team-wide views for the current entity type"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/CustomFieldsController.cs"
      provides: "Custom field definition CRUD endpoints"
      contains: "CustomFieldsController"
    - path: "src/GlobCRM.Api/Controllers/ViewsController.cs"
      provides: "Saved view CRUD endpoints"
      contains: "ViewsController"
    - path: "src/GlobCRM.Infrastructure/CustomFields/CustomFieldValidator.cs"
      provides: "Server-side custom field value validation"
      contains: "ValidateAsync"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/CustomFieldRepository.cs"
      provides: "Custom field data access"
      contains: "GetFieldsByEntityTypeAsync"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/CustomFieldsController.cs"
      to: "src/GlobCRM.Infrastructure/Persistence/Repositories/CustomFieldRepository.cs"
      via: "ICustomFieldRepository injection"
      pattern: "ICustomFieldRepository"
    - from: "src/GlobCRM.Api/Controllers/ViewsController.cs"
      to: "src/GlobCRM.Infrastructure/Persistence/Repositories/ViewRepository.cs"
      via: "IViewRepository injection"
      pattern: "IViewRepository"
---

<objective>
Create API controllers and repositories for custom field definitions, sections, and saved views.

Purpose: Enables admins to define custom fields for any entity type (with validation rules and dropdown options) and users to save table view configurations. The CustomFieldValidator ensures data integrity when custom field values are submitted. This is the backend infrastructure that the dynamic table UI (frontend) and entity CRUD (Phase 3) will consume.

Output: CustomFieldsController, ViewsController, repositories, CustomFieldValidator, and DI registration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-infrastructure/02-02-SUMMARY.md

@src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
@src/GlobCRM.Domain/Entities/CustomFieldSection.cs
@src/GlobCRM.Domain/Entities/SavedView.cs
@src/GlobCRM.Domain/Enums/CustomFieldType.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Api/Controllers/OrganizationsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create repositories and CustomFieldValidator</name>
  <files>
    src/GlobCRM.Domain/Interfaces/ICustomFieldRepository.cs
    src/GlobCRM.Domain/Interfaces/IViewRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/CustomFieldRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/ViewRepository.cs
    src/GlobCRM.Infrastructure/CustomFields/CustomFieldValidator.cs
    src/GlobCRM.Infrastructure/CustomFields/CustomFieldServiceExtensions.cs
  </files>
  <action>
    **ICustomFieldRepository** (src/GlobCRM.Domain/Interfaces/ICustomFieldRepository.cs):
    - Methods:
      - `Task<List<CustomFieldDefinition>> GetFieldsByEntityTypeAsync(string entityType)` — active (non-deleted) fields
      - `Task<CustomFieldDefinition?> GetByIdAsync(Guid id)`
      - `Task<CustomFieldDefinition> CreateAsync(CustomFieldDefinition field)`
      - `Task UpdateAsync(CustomFieldDefinition field)`
      - `Task SoftDeleteAsync(Guid id)` — set IsDeleted=true, DeletedAt=now
      - `Task RestoreAsync(Guid id)` — set IsDeleted=false, DeletedAt=null
      - `Task<List<CustomFieldDefinition>> GetDeletedFieldsAsync(string entityType)` — for admin restore UI
      - `Task<List<CustomFieldSection>> GetSectionsAsync(string entityType)`
      - `Task<CustomFieldSection> CreateSectionAsync(CustomFieldSection section)`
      - `Task UpdateSectionAsync(CustomFieldSection section)`
      - `Task DeleteSectionAsync(Guid sectionId)` — hard delete (sections can be deleted; fields in section get sectionId=null)

    **IViewRepository** (src/GlobCRM.Domain/Interfaces/IViewRepository.cs):
    - Methods:
      - `Task<List<SavedView>> GetViewsByEntityTypeAsync(string entityType, Guid userId)` — returns personal views for this user + all team-wide views
      - `Task<SavedView?> GetByIdAsync(Guid id)`
      - `Task<SavedView?> GetTeamDefaultAsync(string entityType)` — get team default view
      - `Task<SavedView> CreateAsync(SavedView view)`
      - `Task UpdateAsync(SavedView view)`
      - `Task DeleteAsync(Guid id)`
      - `Task SetTeamDefaultAsync(Guid viewId)` — mark as team default, unset previous default

    **CustomFieldRepository** implementation:
    - Uses ApplicationDbContext
    - GetFieldsByEntityTypeAsync: query where EntityType matches, ordered by SortOrder. Include Section navigation.
    - GetDeletedFieldsAsync: use IgnoreQueryFilters() to bypass the soft-delete query filter, then filter IsDeleted=true and correct EntityType
    - RestoreAsync: use IgnoreQueryFilters() to find deleted field, set IsDeleted=false

    **ViewRepository** implementation:
    - Uses ApplicationDbContext
    - GetViewsByEntityTypeAsync: WHERE EntityType matches AND (OwnerId == userId OR OwnerId == null). Order by IsTeamDefault DESC, Name ASC.
    - SetTeamDefaultAsync: In a transaction, unset IsTeamDefault on all views for this entity type, then set on the target view.

    **CustomFieldValidator** (src/GlobCRM.Infrastructure/CustomFields/CustomFieldValidator.cs):
    - Dependencies: ICustomFieldRepository
    - Method: `Task<List<ValidationError>> ValidateAsync(string entityType, Dictionary<string, object?> customFieldValues)`
    - For each key in customFieldValues:
      1. Look up CustomFieldDefinition by Id (the key is the field ID as string)
      2. If field not found or deleted, add error "Unknown field"
      3. Validate value against FieldType:
         - Text: value must be string, check MinLength/MaxLength, RegexPattern
         - Number: value must be numeric, check MinValue/MaxValue
         - Date: value must be parseable as DateTimeOffset
         - Dropdown: value must be one of the defined Options
         - Checkbox: value must be boolean
         - MultiSelect: value must be List<string>, each must be in Options
         - Currency: value must be numeric (decimal), check MinValue/MaxValue
         - File: value must be string (file path/URL)
         - Relation: value must be string (related entity ID as Guid)
      4. Check Required validation: if field is Required and value is null/empty, add error
      5. Check Unique: if Unique=true, would need to query existing entities — defer this to Phase 3 when entities exist
    - Return list of ValidationError(string FieldId, string Message)
    - Per research pitfall #6: server-side validation is critical, do NOT rely solely on client-side

    **CustomFieldServiceExtensions** (src/GlobCRM.Infrastructure/CustomFields/CustomFieldServiceExtensions.cs):
    - Extension method: `AddCustomFieldServices(this IServiceCollection services)`
    - Register: ICustomFieldRepository -> CustomFieldRepository (Scoped), IViewRepository -> ViewRepository (Scoped), CustomFieldValidator (Scoped)
    - Update DependencyInjection.cs to call this extension method
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    CustomFieldRepository implements all ICustomFieldRepository methods.
    CustomFieldValidator validates all 9 field types.
    ViewRepository implements all IViewRepository methods.
  </verify>
  <done>Repositories and CustomFieldValidator created with full CRUD operations and type-aware validation.</done>
</task>

<task type="auto">
  <name>Task 2: Create CustomFieldsController and ViewsController API endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/CustomFieldsController.cs
    src/GlobCRM.Api/Controllers/ViewsController.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    **CustomFieldsController** (src/GlobCRM.Api/Controllers/CustomFieldsController.cs):
    - Route: `api/custom-fields`
    - Authorization: `[Authorize(Roles = "Admin")]` on the controller (admin-only for field management)
    - Dependencies: ICustomFieldRepository, ITenantProvider
    - Endpoints:
      - `GET api/custom-fields/{entityType}` — List active fields for entity type. Returns List<CustomFieldDefinitionDto>.
      - `GET api/custom-fields/{entityType}/deleted` — List soft-deleted fields (for restore UI).
      - `GET api/custom-fields/{id:guid}` — Get single field by ID.
      - `POST api/custom-fields` — Create field. Body: CreateCustomFieldRequest { EntityType, Name, Label, FieldType, SortOrder, SectionId?, Validation?, Options?, RelationEntityType? }. Sets TenantId from ITenantProvider. Returns 201 with created field.
      - `PUT api/custom-fields/{id:guid}` — Update field. Body: UpdateCustomFieldRequest { Label?, SortOrder?, SectionId?, Validation?, Options? }. Name and FieldType cannot be changed after creation.
      - `DELETE api/custom-fields/{id:guid}` — Soft delete field. Returns 204.
      - `POST api/custom-fields/{id:guid}/restore` — Restore soft-deleted field. Returns 200.
      - `GET api/custom-fields/sections/{entityType}` — List sections for entity type.
      - `POST api/custom-fields/sections` — Create section. Body: CreateSectionRequest { EntityType, Name, SortOrder, IsCollapsedByDefault }.
      - `PUT api/custom-fields/sections/{id:guid}` — Update section.
      - `DELETE api/custom-fields/sections/{id:guid}` — Delete section (hard delete).

    - Use DTOs for request/response (create inner record classes or separate DTO files). Do NOT expose domain entities directly.
    - FluentValidation: Create validators for CreateCustomFieldRequest (Name required 1-100 chars, Label required 1-200 chars, EntityType required, FieldType valid enum value, Options required when FieldType is Dropdown or MultiSelect).

    **ViewsController** (src/GlobCRM.Api/Controllers/ViewsController.cs):
    - Route: `api/views`
    - Authorization: `[Authorize]` on the controller (any authenticated user)
    - Dependencies: IViewRepository, ITenantProvider
    - Endpoints:
      - `GET api/views/{entityType}` — List views for entity type (personal + team-wide). Returns List<SavedViewDto> with isPersonal computed property.
      - `GET api/views/{id:guid}` — Get single view by ID.
      - `POST api/views` — Create view. Body: CreateViewRequest { EntityType, Name, Columns, Filters, Sorts, PageSize?, IsTeamDefault? }. OwnerId set from current user claims. If IsTeamDefault=true, require admin role.
      - `PUT api/views/{id:guid}` — Update view. Only the owner can update personal views. Admins can update team-wide views.
      - `DELETE api/views/{id:guid}` — Delete view. Only owner or admin can delete.
      - `POST api/views/{id:guid}/set-default` — Set as team default. Admin only. Returns 200.

    - Authorization logic: Personal views (OwnerId != null) can only be modified by the owner. Team-wide views (OwnerId == null) can only be modified by admins.
    - Use DTOs. CreateViewRequest must include at least one column.

    **DependencyInjection.cs update:**
    - Add call to `services.AddCustomFieldServices()` in AddInfrastructure method
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    CustomFieldsController has 11 endpoints for field and section CRUD.
    ViewsController has 6 endpoints for view CRUD.
    DependencyInjection.cs calls AddCustomFieldServices().
  </verify>
  <done>CustomFieldsController and ViewsController created with full REST endpoints, DTOs, validation, and proper authorization.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. CustomFieldsController: 11 endpoints (7 for fields, 4 for sections)
3. ViewsController: 6 endpoints (CRUD + set-default)
4. CustomFieldValidator validates all 9 field types
5. Soft delete works: DELETE marks as deleted, POST /restore brings back
6. Views support personal and team-wide with proper access control
7. DI registration wired in DependencyInjection.cs
</verification>

<success_criteria>
- Admin can CRUD custom field definitions and sections via API
- Admin can soft-delete and restore custom fields
- User can CRUD saved views (personal) and admin can manage team-wide views
- CustomFieldValidator enforces type-specific validation rules server-side
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-05-SUMMARY.md`
</output>
