---
phase: 02-core-infrastructure
plan: 08
type: execute
wave: 3
depends_on: [02-05]
files_modified:
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.scss
  - globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts
  - globcrm-web/src/app/shared/directives/column-resize.directive.ts
  - globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.ts
  - globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.html
  - globcrm-web/src/app/shared/components/filter-chips/filter-chips.component.ts
  - globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts
  - globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.html
  - globcrm-web/src/app/shared/components/saved-views/view.models.ts
  - globcrm-web/src/app/shared/components/saved-views/view.store.ts
  - globcrm-web/src/app/core/custom-fields/custom-field.models.ts
  - globcrm-web/src/app/core/custom-fields/custom-field.service.ts
autonomous: true

must_haves:
  truths:
    - "DynamicTableComponent renders mat-table with runtime-configurable columns from ViewColumn config"
    - "User can drag-drop column headers to reorder using CDK DragDrop"
    - "User can resize columns by dragging column borders via custom directive"
    - "User can show/hide columns via ColumnPicker dropdown"
    - "FilterPanel supports building advanced filter queries with field/operator/value"
    - "FilterChips show active filters as removable chips"
    - "ViewSidebar lists saved views grouped by Personal/Team with click-to-load"
    - "Page-based pagination with mat-paginator (default 25, options 10/25/50/100)"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      provides: "Reusable dynamic table component"
      contains: "DynamicTableComponent"
    - path: "globcrm-web/src/app/shared/directives/column-resize.directive.ts"
      provides: "Column resize directive"
      contains: "ColumnResizeDirective"
    - path: "globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts"
      provides: "Column show/hide picker"
      contains: "ColumnPickerComponent"
    - path: "globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts"
      provides: "Saved views sidebar"
      contains: "ViewSidebarComponent"
    - path: "globcrm-web/src/app/shared/components/saved-views/view.store.ts"
      provides: "View state management"
      contains: "ViewStore"
  key_links:
    - from: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      to: "globcrm-web/src/app/shared/components/saved-views/view.models.ts"
      via: "ViewColumn input type"
      pattern: "ViewColumn"
    - from: "globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts"
      to: "globcrm-web/src/app/shared/components/saved-views/view.store.ts"
      via: "ViewStore injection"
      pattern: "ViewStore"
---

<objective>
Build the reusable Angular dynamic table component with column configuration, drag-drop reorder, resize, filtering, and saved views sidebar.

Purpose: This is the core UI component that every entity list page will use (companies, contacts, deals, etc.). It wraps Angular Material mat-table with runtime column configuration from saved views, CDK drag-drop for column reorder, custom resize directive, and an expandable filter panel. The view sidebar lets users switch between saved views.

Output: DynamicTableComponent, ColumnPicker, ColumnResizeDirective, FilterPanel, FilterChips, ViewSidebar, ViewStore, and custom field models/service.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md

@globcrm-web/src/app/app.config.ts
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/core/api/api.service.ts
@globcrm-web/src/app/core/auth/auth.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DynamicTableComponent with mat-table, column reorder, resize, and pagination</name>
  <files>
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.scss
    globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts
    globcrm-web/src/app/shared/directives/column-resize.directive.ts
    globcrm-web/src/app/shared/components/saved-views/view.models.ts
    globcrm-web/src/app/core/custom-fields/custom-field.models.ts
  </files>
  <action>
    **view.models.ts** — TypeScript interfaces matching backend SavedView/ViewColumn/ViewFilter/ViewSort:
    ```
    ViewColumn: { fieldId: string, isCustomField: boolean, width: number, sortOrder: number, visible: boolean }
    ViewFilter: { fieldId: string, operator: string, value: string | null }
    ViewSort: { fieldId: string, direction: 'asc' | 'desc', sortOrder: number }
    SavedView: { id: string, entityType: string, name: string, ownerId: string | null, isTeamDefault: boolean, columns: ViewColumn[], filters: ViewFilter[], sorts: ViewSort[], pageSize: number }
    ColumnDefinition: { fieldId: string, label: string, isCustomField: boolean, fieldType: string, sortable: boolean, filterable: boolean }
    ```

    **custom-field.models.ts** — TypeScript interfaces matching backend custom field entities:
    ```
    CustomFieldDefinition: { id: string, entityType: string, name: string, label: string, fieldType: CustomFieldType, sortOrder: number, sectionId: string | null, validation: CustomFieldValidation, options: FieldOption[] | null, relationEntityType: string | null }
    CustomFieldType enum: Text, Number, Date, Dropdown, Checkbox, MultiSelect, Currency, File, Relation
    CustomFieldValidation: { required: boolean, minLength: number | null, maxLength: number | null, minValue: number | null, maxValue: number | null, regexPattern: string | null, unique: boolean }
    FieldOption: { value: string, label: string, color: string | null, sortOrder: number }
    ```

    **ColumnResizeDirective** (standalone directive):
    - Selector: `[appColumnResize]`
    - Listens to mousedown on a resize handle (pseudo-element or small div at right edge of header cell)
    - On mousedown: start tracking mousemove, calculate delta-x
    - Output: `columnResized` event emitting { fieldId, newWidth }
    - On mouseup: stop tracking
    - Add cursor: col-resize style on hover
    - ~50 lines per research recommendation

    **ColumnPickerComponent** (standalone component):
    - Inputs: allColumns (ColumnDefinition[]), visibleColumns (ViewColumn[])
    - Outputs: columnsChanged (ViewColumn[])
    - UI: mat-menu triggered by a "Columns" button (mat-icon-button with view_column icon)
    - Inside menu: checkboxes for each column (checked = visible)
    - When checkbox toggled: emit updated ViewColumn[] with visible flag changed
    - Use mat-checkbox inside mat-menu

    **DynamicTableComponent** (standalone component):
    - Inputs:
      - `entityType = input.required<string>()`
      - `data = input.required<any[]>()` — row data
      - `columns = input.required<ViewColumn[]>()` — current column config
      - `columnDefinitions = input.required<ColumnDefinition[]>()` — all available columns
      - `totalCount = input.required<number>()` — for pagination
      - `pageSize = input<number>(25)`
      - `loading = input<boolean>(false)`
    - Outputs:
      - `columnOrderChanged = output<ViewColumn[]>()`
      - `columnResized = output<{fieldId: string, width: number}>()`
      - `columnsVisibilityChanged = output<ViewColumn[]>()`
      - `sortChanged = output<ViewSort>()`
      - `pageChanged = output<{page: number, pageSize: number}>()`
      - `rowEditClicked = output<any>()`
    - Computed: `displayedColumns` — visible columns sorted by sortOrder, mapped to fieldId strings, plus "actions" column at end
    - Use mat-table with [dataSource]="data()"
    - Use mat-sort for column sorting
    - CDK drag-drop on header row for column reorder:
      - Wrap headers in cdkDropList (horizontal)
      - Each header cell is cdkDrag
      - On drop: recompute sortOrder for all columns, emit columnOrderChanged
    - Apply appColumnResize directive on each header cell
    - Each cell renders value using a helper method: getCellValue(row, fieldId) that handles both core fields (direct property access) and custom fields (row.customFields[fieldId])
    - mat-paginator at bottom with [pageSizeOptions]="[10, 25, 50, 100]", [pageSize]="pageSize()", [length]="totalCount()"
    - Loading overlay: show mat-progress-bar when loading() is true
    - Actions column: mat-icon-button with edit icon, emits rowEditClicked
    - Per locked decision: no inline cell editing, quick edit icon per row
    - Per research recommendation: page-based pagination with 25 default

    **Template structure:**
    ```html
    <div class="dynamic-table-wrapper">
      <!-- Toolbar: search + column picker -->
      <div class="table-toolbar">
        <mat-form-field appearance="outline" class="quick-search">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput placeholder="Quick search...">
        </mat-form-field>
        <app-column-picker [allColumns]="columnDefinitions()" [visibleColumns]="columns()" (columnsChanged)="columnsVisibilityChanged.emit($event)" />
      </div>

      <!-- Progress bar -->
      @if (loading()) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }

      <!-- Table -->
      <div class="table-container">
        <table mat-table [dataSource]="data()" matSort (matSortChange)="onSort($event)">
          <!-- Dynamic column definitions via @for loop -->
          <!-- Actions column -->
          <tr mat-header-row ...></tr>
          <tr mat-row ...></tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator ...></mat-paginator>
    </div>
    ```

    **SCSS:** Style the table container with horizontal scroll, sticky header, alternating row colors, hover highlight. Column resize handle styling (thin border-right with hover cursor).

    Use Angular Material imports: MatTableModule, MatSortModule, MatPaginatorModule, MatFormFieldModule, MatInputModule, MatIconModule, MatButtonModule, MatProgressBarModule, MatMenuModule, MatCheckboxModule
    CDK imports: CdkDragDrop, CdkDropList, CdkDrag, moveItemInArray

    Use ChangeDetectionStrategy.OnPush for performance.
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    DynamicTableComponent, ColumnPickerComponent, ColumnResizeDirective all exist.
    view.models.ts and custom-field.models.ts define all required interfaces.
  </verify>
  <done>DynamicTableComponent renders mat-table with dynamic columns, CDK drag-drop reorder, custom resize directive, column picker, sorting, pagination, and loading state.</done>
</task>

<task type="auto">
  <name>Task 2: Create FilterPanel, FilterChips, ViewSidebar, ViewStore, and CustomFieldService</name>
  <files>
    globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.ts
    globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.html
    globcrm-web/src/app/shared/components/filter-chips/filter-chips.component.ts
    globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.ts
    globcrm-web/src/app/shared/components/saved-views/view-sidebar.component.html
    globcrm-web/src/app/shared/components/saved-views/view.store.ts
    globcrm-web/src/app/core/custom-fields/custom-field.service.ts
  </files>
  <action>
    **CustomFieldService** (core/custom-fields/custom-field.service.ts):
    - Injectable service using ApiService
    - Methods:
      - `getFieldsByEntityType(entityType: string): Observable<CustomFieldDefinition[]>` — GET /api/custom-fields/{entityType}
      - `createField(field: CreateCustomFieldRequest): Observable<CustomFieldDefinition>` — POST /api/custom-fields
      - `updateField(id: string, field: UpdateCustomFieldRequest): Observable<CustomFieldDefinition>` — PUT /api/custom-fields/{id}
      - `deleteField(id: string): Observable<void>` — DELETE /api/custom-fields/{id}
      - `restoreField(id: string): Observable<void>` — POST /api/custom-fields/{id}/restore
      - `getSections(entityType: string): Observable<CustomFieldSection[]>` — GET /api/custom-fields/sections/{entityType}

    **FilterPanel** (standalone component):
    - Inputs: columnDefinitions (ColumnDefinition[]), activeFilters (ViewFilter[])
    - Outputs: filtersChanged (ViewFilter[])
    - UI: Expandable panel (mat-expansion-panel) with:
      - Add filter button that creates a new row
      - Each row: field selector (mat-select of column names) + operator selector (mat-select: equals, contains, gt, lt, gte, lte, in, between) + value input (text, number, or date depending on field type)
      - Remove button per row
      - Apply button that emits filtersChanged
    - Per locked decision: expandable advanced filter panel for complex queries
    - Operators should adapt to field type: text gets "equals"/"contains"/"starts with", numbers get comparison operators, dates get date-specific operators

    **FilterChips** (standalone component):
    - Inputs: filters (ViewFilter[]), columnDefinitions (ColumnDefinition[])
    - Outputs: filterRemoved (ViewFilter), filtersCleared ()
    - UI: Horizontal row of mat-chip elements, each showing "{fieldLabel} {operator} {value}" with remove (x) button
    - "Clear all" chip at end if filters exist
    - Per locked decision: filter chips for common fields

    **ViewStore** (NgRx Signal Store):
    - State: { views: SavedView[], activeViewId: string | null, isLoading: boolean }
    - Computed:
      - personalViews: filter views where ownerId is not null
      - teamViews: filter views where ownerId is null
      - activeView: find view by activeViewId
    - Methods:
      - loadViews(entityType: string): call GET /api/views/{entityType}, set views
      - selectView(viewId: string): set activeViewId
      - createView(view: CreateViewRequest): call POST /api/views, add to views
      - updateView(id: string, view: UpdateViewRequest): call PUT /api/views/{id}, update in views
      - deleteView(id: string): call DELETE /api/views/{id}, remove from views
      - saveCurrentState(name: string, columns: ViewColumn[], filters: ViewFilter[], sorts: ViewSort[], pageSize: number): create new personal view
    - Use ApiService for HTTP calls
    - Follow existing @ngrx/signals pattern from AuthStore

    **ViewSidebar** (standalone component):
    - Inputs: entityType (string)
    - Outputs: viewSelected (SavedView)
    - Dependencies: ViewStore (inject)
    - On init: call viewStore.loadViews(entityType)
    - UI: Left sidebar panel (can be a mat-sidenav or a fixed-width div)
      - "Views" header
      - "Team Views" section header with list of team views
      - "Personal Views" section header with list of personal views
      - Active view highlighted
      - Click on view: emit viewSelected, call viewStore.selectView
      - "Save current view" button at bottom (opens dialog to name the view)
      - Per locked decision: saved views displayed in left sidebar grouped by Personal / Team; click to load
    - Use mat-list or mat-nav-list for view items
    - Mark team default view with a star icon

    Template structure for ViewSidebar:
    ```html
    <div class="view-sidebar">
      <h3>Views</h3>
      <div class="view-group">
        <h4>Team Views</h4>
        <mat-nav-list>
          @for (view of viewStore.teamViews(); track view.id) {
            <mat-list-item [class.active]="view.id === viewStore.activeViewId()"
                           (click)="selectView(view)">
              @if (view.isTeamDefault) { <mat-icon>star</mat-icon> }
              {{ view.name }}
            </mat-list-item>
          }
        </mat-nav-list>
      </div>
      <div class="view-group">
        <h4>Personal Views</h4>
        <mat-nav-list>
          @for (view of viewStore.personalViews(); track view.id) {
            <mat-list-item ...>{{ view.name }}</mat-list-item>
          }
        </mat-nav-list>
      </div>
      <button mat-button (click)="saveView()">
        <mat-icon>save</mat-icon> Save Current View
      </button>
    </div>
    ```
  </action>
  <verify>
    `cd globcrm-web && ng build` succeeds with 0 errors (or only expected warnings).
    FilterPanel, FilterChips, ViewSidebar, ViewStore, CustomFieldService all exist.
    ViewStore follows @ngrx/signals pattern.
  </verify>
  <done>FilterPanel, FilterChips, ViewSidebar, ViewStore, and CustomFieldService created. Dynamic table ecosystem is complete for entity list pages to consume.</done>
</task>

</tasks>

<verification>
1. `ng build` succeeds from globcrm-web/
2. DynamicTableComponent renders with mat-table, sorting, pagination
3. Column reorder works via CDK drag-drop
4. Column resize works via custom directive
5. ColumnPicker shows/hides columns
6. FilterPanel builds filter queries
7. FilterChips display active filters
8. ViewSidebar lists Personal/Team views
9. ViewStore manages view state with @ngrx/signals
</verification>

<success_criteria>
- Reusable DynamicTableComponent ready for any entity list page
- Column configuration: show/hide, reorder (drag-drop), resize (drag borders)
- Filtering: quick search, filter chips, advanced filter panel
- Views sidebar with Personal/Team grouping and click-to-load
- Page-based pagination with configurable page sizes
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-08-SUMMARY.md`
</output>
