---
phase: 02-core-infrastructure
plan: 14
type: execute
wave: 1
depends_on: [02-02]
files_modified:
  - src/GlobCRM.Infrastructure/Persistence/Migrations/App/new_migration_AddGinIndexesForJsonbColumns.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "GIN indexes exist for custom_field_definitions.validation and custom_field_definitions.options JSONB columns"
    - "GIN indexes exist for saved_views.columns, saved_views.filters, and saved_views.sorts JSONB columns"
    - "Migration applies without errors on a PostgreSQL database"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Persistence/Migrations/App/*_AddGinIndexesForJsonbColumns.cs"
      provides: "EF Core migration that creates 5 GIN indexes on JSONB columns"
      contains: "USING GIN"
  key_links:
    - from: "new migration file"
      to: "custom_field_definitions table"
      via: "CREATE INDEX ... USING GIN (validation)"
      pattern: "idx_custom_field_definitions_validation_gin"
    - from: "new migration file"
      to: "saved_views table"
      via: "CREATE INDEX ... USING GIN (filters)"
      pattern: "idx_saved_views_filters_gin"
---

<objective>
Close Gap 2 from VERIFICATION.md: Add GIN indexes for all JSONB columns in custom_field_definitions and saved_views tables.

Purpose: The Phase 2 success criteria states "Custom fields are stored in JSONB with GIN indexing." JSONB columns exist in the migration but GIN indexes were not created. Without GIN indexes, JSONB queries (filtering by validation rules, searching options, querying saved view filters) will require full table scans, degrading performance as data grows.

Output: A new EF Core migration with 5 GIN indexes for JSONB columns.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-02-SUMMARY.md
@.planning/phases/02-core-infrastructure/02-VERIFICATION.md
@src/GlobCRM.Infrastructure/Persistence/Migrations/App/20260216153400_AddCustomFieldsAndViews.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EF Core migration with GIN indexes for all JSONB columns</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Migrations/App/*_AddGinIndexesForJsonbColumns.cs
  </files>
  <action>
    **Step 1: Generate new migration via EF Core CLI**

    Run from project root:
    ```bash
    dotnet ef migrations add AddGinIndexesForJsonbColumns \
      -p src/GlobCRM.Infrastructure \
      -s src/GlobCRM.Api \
      -c ApplicationDbContext \
      -o Persistence/Migrations/App
    ```

    **Step 2: Edit the generated migration**

    The auto-generated migration will likely be empty (since we're adding raw SQL indexes, not changing the model). Replace the Up() and Down() methods with raw SQL:

    ```csharp
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // GIN indexes for custom_field_definitions JSONB columns
        migrationBuilder.Sql(
            "CREATE INDEX idx_custom_field_definitions_validation_gin ON custom_field_definitions USING GIN (validation);");
        migrationBuilder.Sql(
            "CREATE INDEX idx_custom_field_definitions_options_gin ON custom_field_definitions USING GIN (options);");

        // GIN indexes for saved_views JSONB columns
        migrationBuilder.Sql(
            "CREATE INDEX idx_saved_views_columns_gin ON saved_views USING GIN (columns);");
        migrationBuilder.Sql(
            "CREATE INDEX idx_saved_views_filters_gin ON saved_views USING GIN (filters);");
        migrationBuilder.Sql(
            "CREATE INDEX idx_saved_views_sorts_gin ON saved_views USING GIN (sorts);");
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.Sql("DROP INDEX IF EXISTS idx_custom_field_definitions_validation_gin;");
        migrationBuilder.Sql("DROP INDEX IF EXISTS idx_custom_field_definitions_options_gin;");
        migrationBuilder.Sql("DROP INDEX IF EXISTS idx_saved_views_columns_gin;");
        migrationBuilder.Sql("DROP INDEX IF EXISTS idx_saved_views_filters_gin;");
        migrationBuilder.Sql("DROP INDEX IF EXISTS idx_saved_views_sorts_gin;");
    }
    ```

    **Step 3: Verify the migration compiles**
    ```bash
    dotnet build src/GlobCRM.Infrastructure
    ```

    **Step 4: Verify the migration is valid by listing migrations**
    ```bash
    dotnet ef migrations list -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api -c ApplicationDbContext
    ```
    Confirm AddGinIndexesForJsonbColumns appears as the latest migration.

    **IMPORTANT:** Do NOT run `dotnet ef database update` in this task â€” migration application happens during E2E verification or deployment. Just create and verify the migration compiles.

    **Pattern notes:**
    - The migration uses `migrationBuilder.Sql()` for raw SQL because EF Core has no built-in API for GIN indexes (EF Core's HasIndex().HasMethod("gin") works with NpgsqlEntityTypeBuilder but requires model changes in OnModelCreating which could regenerate a large migration).
    - Raw SQL keeps the migration minimal and focused.
    - Down() method drops indexes with IF EXISTS for safety.
    - Table names use snake_case matching the existing migration convention (custom_field_definitions, saved_views).
  </action>
  <verify>
    1. `dotnet build src/GlobCRM.Infrastructure` succeeds
    2. Migration file exists: `ls src/GlobCRM.Infrastructure/Persistence/Migrations/App/*AddGinIndexesForJsonbColumns.cs`
    3. Migration contains all 5 GIN index CREATE statements: `grep -c "USING GIN" src/GlobCRM.Infrastructure/Persistence/Migrations/App/*AddGinIndexesForJsonbColumns.cs` returns 5
    4. Migration contains all 5 DROP statements in Down: `grep -c "DROP INDEX" src/GlobCRM.Infrastructure/Persistence/Migrations/App/*AddGinIndexesForJsonbColumns.cs` returns 5
  </verify>
  <done>
    New EF Core migration exists with 5 GIN indexes:
    - idx_custom_field_definitions_validation_gin (custom_field_definitions.validation)
    - idx_custom_field_definitions_options_gin (custom_field_definitions.options)
    - idx_saved_views_columns_gin (saved_views.columns)
    - idx_saved_views_filters_gin (saved_views.filters)
    - idx_saved_views_sorts_gin (saved_views.sorts)
    Backend project builds successfully. Migration listed in migration history.
  </done>
</task>

</tasks>

<verification>
Gap 2 closure verification:
- New migration file exists with 5 GIN index CREATE statements
- Each JSONB column from VERIFICATION.md has a corresponding GIN index
- Migration compiles and is recognized by EF Core
- Down() method correctly drops all 5 indexes
</verification>

<success_criteria>
- Migration file created with all 5 GIN indexes for JSONB columns
- Backend solution builds without errors
- Migration appears in `dotnet ef migrations list`
- Both Up() and Down() methods are implemented correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-14-SUMMARY.md`
</output>
