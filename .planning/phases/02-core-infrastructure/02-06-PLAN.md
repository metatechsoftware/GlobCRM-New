---
phase: 02-core-infrastructure
plan: 06
type: execute
wave: 2
depends_on: [02-03]
files_modified:
  - src/GlobCRM.Api/Controllers/ProfileController.cs
  - src/GlobCRM.Api/Controllers/TeamDirectoryController.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
autonomous: true

must_haves:
  truths:
    - "User can view and update their own profile via API (name, phone, job title, department, timezone, language, bio, social links, work schedule, skills)"
    - "User can upload and crop avatar image which is processed server-side to full (256px) and thumb (64px)"
    - "User can update their preferences (theme, language, timezone, date format, email notifications)"
    - "Any authenticated user can browse the team directory showing all users in their organization"
    - "Profile API returns avatar URL or null (frontend handles initials fallback)"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/ProfileController.cs"
      provides: "User profile CRUD + avatar upload endpoints"
      contains: "ProfileController"
    - path: "src/GlobCRM.Api/Controllers/TeamDirectoryController.cs"
      provides: "Team directory listing endpoint"
      contains: "TeamDirectoryController"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/ProfileController.cs"
      to: "src/GlobCRM.Infrastructure/Images/AvatarService.cs"
      via: "AvatarService injection for avatar upload"
      pattern: "AvatarService"
    - from: "src/GlobCRM.Api/Controllers/ProfileController.cs"
      to: "src/GlobCRM.Domain/Entities/ApplicationUser.cs"
      via: "UserManager<ApplicationUser> for profile updates"
      pattern: "UserManager"
---

<objective>
Create API controllers for user profile management, avatar upload, preferences, and team directory.

Purpose: Enables users to view and edit their profiles (RBAC-04), upload avatars with server-side processing, configure personal preferences (theme, notifications), and browse the organization's team directory. These endpoints support the Angular profile pages in Plan 10.

Output: ProfileController with profile CRUD and avatar upload, TeamDirectoryController with org member listing, DI registration for image services.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-infrastructure/02-03-SUMMARY.md

@src/GlobCRM.Domain/Entities/ApplicationUser.cs
@src/GlobCRM.Infrastructure/Images/AvatarService.cs
@src/GlobCRM.Infrastructure/Storage/IFileStorageService.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@src/GlobCRM.Api/Controllers/OrganizationsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileController with profile CRUD, avatar upload, and preferences</name>
  <files>
    src/GlobCRM.Api/Controllers/ProfileController.cs
  </files>
  <action>
    **ProfileController** (src/GlobCRM.Api/Controllers/ProfileController.cs):
    - Route: `api/profile`
    - Authorization: `[Authorize]` on the controller
    - Dependencies: UserManager<ApplicationUser>, AvatarService, ITenantProvider

    **Endpoints:**

    1. `GET api/profile` — Get current user's profile
       - Get userId from claims, find user via UserManager
       - Return ProfileDto { Id, Email, FirstName, LastName, Phone, JobTitle, Department, Timezone, Language, Bio, AvatarUrl, AvatarColor, SocialLinks, WorkSchedule, ReportingManagerId, ReportingManagerName (resolved), Skills, Preferences, CreatedAt }
       - AvatarUrl should be the full relative path (frontend will prepend base URL)

    2. `GET api/profile/{userId:guid}` — Get any user's public profile (for team directory detail)
       - Same response shape but limited fields for non-self: exclude Preferences (private)
       - Verify the target user is in the same organization (tenant isolation)

    3. `PUT api/profile` — Update current user's profile
       - Body: UpdateProfileRequest { FirstName, LastName, Phone?, JobTitle?, Department?, Timezone?, Language?, Bio?, SocialLinks?, WorkSchedule?, ReportingManagerId?, Skills? }
       - Validate: FirstName and LastName required, max lengths (FirstName 50, LastName 50, Phone 20, JobTitle 100, Department 100, Bio 1000)
       - Get current user from UserManager, update properties, call UpdateAsync
       - Do NOT allow changing Email via this endpoint (separate flow)
       - Return updated ProfileDto

    4. `POST api/profile/avatar` — Upload avatar image
       - Accept multipart/form-data with single file named "avatar"
       - Validate: file must be image/png, image/jpeg, or image/webp; max 5MB
       - Call AvatarService.ProcessAndSaveAvatarAsync(tenantId, userId, fileStream)
       - Update user.AvatarUrl with returned full path
       - Call UserManager.UpdateAsync
       - Return { avatarUrl: string }

    5. `DELETE api/profile/avatar` — Remove avatar
       - Set user.AvatarUrl = null
       - Optionally delete file via IFileStorageService (nice-to-have, not critical)
       - Return 204

    6. `PUT api/profile/preferences` — Update user preferences
       - Body: UpdatePreferencesRequest { Theme?, Language?, Timezone?, DateFormat?, EmailNotifications? }
       - Merge with existing preferences (don't replace entire object if only some fields provided)
       - Return updated PreferencesDto

    7. `GET api/profile/preferences` — Get current user's preferences
       - Return user.Preferences as PreferencesDto

    **DTOs:** Create as inner records or in a separate DTOs namespace. ProfileDto, UpdateProfileRequest, UpdatePreferencesRequest, PreferencesDto.

    **Validation:** Use FluentValidation for UpdateProfileRequest (FirstName required, lengths). For avatar upload, validate in the controller action (file size, content type).
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    ProfileController has 7 endpoints.
    Avatar upload endpoint accepts multipart/form-data.
    Preferences endpoint merges partial updates.
  </verify>
  <done>ProfileController created with profile CRUD, avatar upload/delete, and preferences management endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Create TeamDirectoryController and wire image services DI</name>
  <files>
    src/GlobCRM.Api/Controllers/TeamDirectoryController.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
  </files>
  <action>
    **TeamDirectoryController** (src/GlobCRM.Api/Controllers/TeamDirectoryController.cs):
    - Route: `api/team-directory`
    - Authorization: `[Authorize]` (any authenticated user in the organization)
    - Dependencies: UserManager<ApplicationUser>, ApplicationDbContext, ITenantProvider

    **Endpoints:**

    1. `GET api/team-directory` — List all users in the organization
       - Query ApplicationUser WHERE OrganizationId == current tenant's OrganizationId AND IsActive == true
       - Support optional query parameters: search (filter by name/email), department (filter), page (default 1), pageSize (default 25)
       - Return paginated result: { items: TeamMemberDto[], totalCount: int, page: int, pageSize: int }
       - TeamMemberDto: { Id, FirstName, LastName, Email, JobTitle, Department, AvatarUrl, AvatarColor, Phone, IsActive }

    2. `GET api/team-directory/{userId:guid}` — Get detailed profile of a team member
       - Verify user is in same organization
       - Return TeamMemberDetailDto with all public profile fields (everything except Preferences)

    - Per locked decision: "Team directory: all users in the organization can view each other's profiles"
    - Search should be case-insensitive and search across FirstName, LastName, Email
    - Pagination follows page-based strategy per research recommendation

    **DependencyInjection.cs update:**
    - Add call to `services.AddImageServices()` in AddInfrastructure method
    - This registers AvatarService and LocalFileStorageService

    **Static file serving (optional but recommended):**
    - In Program.cs, add `app.UseStaticFiles()` configured to serve files from the uploads directory at path `/uploads`
    - This allows the frontend to load avatar images via URL
    - Alternatively, create a dedicated endpoint in ProfileController: `GET api/profile/avatar/{userId}` that streams the file — this is more secure as it can enforce tenant isolation
    - RECOMMENDATION: Use the endpoint approach for tenant isolation. Add `GET api/profile/avatar/{userId:guid}` that reads the file via IFileStorageService and returns it with correct content type.
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    TeamDirectoryController has 2 endpoints (list + detail).
    DependencyInjection.cs calls AddImageServices().
    List endpoint supports search, department filter, and pagination.
  </verify>
  <done>TeamDirectoryController created with paginated listing and detail endpoints. Image services wired into DI.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. ProfileController: 7 endpoints (get self, get other, update, avatar upload, avatar delete, get preferences, update preferences)
3. TeamDirectoryController: 2 endpoints (list with pagination, detail)
4. Avatar upload validates file type and size
5. Preferences update merges partial data
6. Team directory supports search and pagination
7. Image services registered in DI
</verification>

<success_criteria>
- User can view and edit own profile via API
- User can upload avatar which is processed to 256px and 64px WebP
- User can update preferences (theme, locale, notifications)
- Team directory lists all org members with search and pagination
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-06-SUMMARY.md`
</output>
