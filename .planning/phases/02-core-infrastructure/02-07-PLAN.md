---
phase: 02-core-infrastructure
plan: 07
type: execute
wave: 3
depends_on: [02-04]
files_modified:
  - src/GlobCRM.Api/Controllers/RolesController.cs
  - src/GlobCRM.Api/Controllers/TeamsController.cs
autonomous: true

must_haves:
  truths:
    - "Admin can CRUD custom roles with name, description, and full permission matrix"
    - "Admin can clone a role from a template to create a customized copy"
    - "Admin can assign roles to users directly and manage team memberships"
    - "Admin can CRUD teams with name, description, and default role"
    - "Permission cache is invalidated when role assignments or team memberships change"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/RolesController.cs"
      provides: "Role CRUD + permission management + user assignment endpoints"
      contains: "RolesController"
    - path: "src/GlobCRM.Api/Controllers/TeamsController.cs"
      provides: "Team CRUD + member management endpoints"
      contains: "TeamsController"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/RolesController.cs"
      to: "src/GlobCRM.Infrastructure/Authorization/PermissionService.cs"
      via: "IPermissionService.InvalidateUserPermissions on role changes"
      pattern: "InvalidateUserPermissions"
    - from: "src/GlobCRM.Api/Controllers/TeamsController.cs"
      to: "src/GlobCRM.Infrastructure/Authorization/PermissionService.cs"
      via: "IPermissionService.InvalidateUserPermissions on team changes"
      pattern: "InvalidateUserPermissions"
---

<objective>
Create API controllers for role management (CRUD, permissions, cloning) and team management (CRUD, members, default roles).

Purpose: Enables admins to create custom roles with per-entity CRUD permissions and field-level access, clone roles from templates, assign roles to users, and organize users into teams. These are the admin-facing endpoints for RBAC management (RBAC-01, RBAC-02, RBAC-03, RBAC-05).

Output: RolesController and TeamsController with full CRUD, permission/field-access management, and cache invalidation.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-infrastructure/02-04-SUMMARY.md

@src/GlobCRM.Domain/Entities/Role.cs
@src/GlobCRM.Domain/Entities/RolePermission.cs
@src/GlobCRM.Domain/Entities/RoleFieldPermission.cs
@src/GlobCRM.Domain/Entities/Team.cs
@src/GlobCRM.Domain/Entities/TeamMember.cs
@src/GlobCRM.Domain/Entities/UserRoleAssignment.cs
@src/GlobCRM.Domain/Enums/PermissionScope.cs
@src/GlobCRM.Domain/Enums/FieldAccessLevel.cs
@src/GlobCRM.Domain/Enums/EntityType.cs
@src/GlobCRM.Infrastructure/Authorization/PermissionService.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Api/Controllers/OrganizationsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RolesController with role CRUD, permissions, field access, cloning, and user assignment</name>
  <files>
    src/GlobCRM.Api/Controllers/RolesController.cs
  </files>
  <action>
    **RolesController** (src/GlobCRM.Api/Controllers/RolesController.cs):
    - Route: `api/roles`
    - Authorization: `[Authorize(Roles = "Admin")]` — only admins can manage roles
    - Dependencies: ApplicationDbContext, IPermissionService, ITenantProvider

    **Endpoints:**

    1. `GET api/roles` — List all roles for the tenant
       - Include permission count and user count as computed properties
       - Return List<RoleDto> { Id, Name, Description, IsSystem, IsTemplate, PermissionCount, AssignedUserCount, CreatedAt }

    2. `GET api/roles/{id:guid}` — Get role with full permissions
       - Include all RolePermissions and RoleFieldPermissions
       - Return RoleDetailDto { Id, Name, Description, IsSystem, IsTemplate, Permissions: List<RolePermissionDto>, FieldPermissions: List<RoleFieldPermissionDto> }
       - RolePermissionDto: { EntityType, Operation, Scope (as string: "none"/"own"/"team"/"all") }
       - RoleFieldPermissionDto: { EntityType, FieldName, AccessLevel (as string: "hidden"/"readonly"/"editable") }

    3. `POST api/roles` — Create new role
       - Body: CreateRoleRequest { Name, Description?, Permissions: List<PermissionEntry>, FieldPermissions?: List<FieldPermissionEntry> }
       - PermissionEntry: { EntityType, Operation, Scope }
       - FieldPermissionEntry: { EntityType, FieldName, AccessLevel }
       - Validate: Name required 1-100 chars, unique within tenant
       - Set TenantId from ITenantProvider, IsSystem=false, IsTemplate=false
       - Return 201 with RoleDetailDto

    4. `PUT api/roles/{id:guid}` — Update role
       - Cannot update IsSystem roles (return 400 "System roles cannot be modified")
       - Body: UpdateRoleRequest { Name?, Description?, Permissions?, FieldPermissions? }
       - If Permissions provided: delete existing RolePermissions for this role, insert new ones (full replacement)
       - If FieldPermissions provided: same full replacement pattern
       - After update: invalidate permissions for ALL users assigned to this role (query UserRoleAssignments + TeamMembers with this role)
       - Return updated RoleDetailDto

    5. `DELETE api/roles/{id:guid}` — Delete role
       - Cannot delete IsSystem roles (return 400)
       - Check if any users are assigned — if so, return 400 "Cannot delete role with assigned users"
       - Cascade deletes RolePermissions and RoleFieldPermissions via DB cascade
       - Return 204

    6. `POST api/roles/{id:guid}/clone` — Clone role
       - Per locked decision: admins can clone and customize template roles
       - Body: CloneRoleRequest { Name } — name for the new role
       - Copy all RolePermissions and RoleFieldPermissions from source role
       - New role: IsSystem=false, IsTemplate=false
       - Return 201 with new RoleDetailDto

    7. `GET api/roles/{id:guid}/users` — List users assigned to this role
       - Query UserRoleAssignments + TeamMembers (via team default role)
       - Return List<RoleUserDto> { UserId, FirstName, LastName, Email, AssignmentType ("direct" or "team:TeamName") }

    8. `POST api/roles/{id:guid}/assign` — Assign role to user
       - Body: { UserId }
       - Create UserRoleAssignment
       - Invalidate user's permission cache
       - Return 200

    9. `DELETE api/roles/{id:guid}/assign/{userId:guid}` — Remove role from user
       - Delete UserRoleAssignment
       - Invalidate user's permission cache
       - Return 204

    10. `GET api/roles/my-permissions` — Get current user's effective permissions (for frontend PermissionStore)
        - Does NOT require admin role — any authenticated user can get their own permissions
        - Override authorization for this endpoint: `[Authorize]` instead of admin-only
        - Call IPermissionService.GetAllPermissionsAsync(userId)
        - Return List<EffectivePermissionDto> { EntityType, Operation, Scope }

    **DTOs:** Define as inner records within the controller file or in a separate DTOs directory.

    **CRITICAL: Cache invalidation** — When roles are updated, deleted, or user assignments change, call `_permissionService.InvalidateUserPermissions(userId)` for all affected users. For role updates, query all users with that role.
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    RolesController has 10 endpoints.
    Clone endpoint copies permissions from source role.
    Cache invalidation called on role updates and assignment changes.
  </verify>
  <done>RolesController created with full CRUD, permission matrix management, role cloning, user assignment, and cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Create TeamsController with team CRUD and member management</name>
  <files>
    src/GlobCRM.Api/Controllers/TeamsController.cs
  </files>
  <action>
    **TeamsController** (src/GlobCRM.Api/Controllers/TeamsController.cs):
    - Route: `api/teams`
    - Authorization: `[Authorize(Roles = "Admin")]` — only admins can manage teams
    - Dependencies: ApplicationDbContext, IPermissionService, ITenantProvider

    **Endpoints:**

    1. `GET api/teams` — List all teams for the tenant
       - Include member count and default role name
       - Return List<TeamDto> { Id, Name, Description, DefaultRoleName, MemberCount, CreatedAt }

    2. `GET api/teams/{id:guid}` — Get team with members
       - Include all TeamMembers with user details
       - Return TeamDetailDto { Id, Name, Description, DefaultRoleId, DefaultRoleName, Members: List<TeamMemberDto>, CreatedAt }
       - TeamMemberDto: { UserId, FirstName, LastName, Email, AvatarUrl, AvatarColor }

    3. `POST api/teams` — Create team
       - Body: CreateTeamRequest { Name, Description?, DefaultRoleId? }
       - Validate: Name required 1-100 chars, unique within tenant
       - If DefaultRoleId provided, verify the role exists in this tenant
       - Set TenantId from ITenantProvider
       - Return 201 with TeamDetailDto

    4. `PUT api/teams/{id:guid}` — Update team
       - Body: UpdateTeamRequest { Name?, Description?, DefaultRoleId? (null to remove) }
       - If DefaultRoleId changes, invalidate permissions for ALL team members
       - Return updated TeamDetailDto

    5. `DELETE api/teams/{id:guid}` — Delete team
       - Cascade deletes TeamMembers via DB cascade
       - Invalidate permissions for all team members before deletion
       - Return 204

    6. `POST api/teams/{id:guid}/members` — Add member to team
       - Body: { UserId }
       - Validate: user exists in same tenant, not already a member
       - Create TeamMember
       - Invalidate user's permission cache (they now inherit team's default role)
       - Return 200

    7. `DELETE api/teams/{id:guid}/members/{userId:guid}` — Remove member from team
       - Delete TeamMember
       - Invalidate user's permission cache
       - Return 204

    8. `POST api/teams/{id:guid}/members/bulk` — Add multiple members at once
       - Body: { UserIds: List<Guid> }
       - Create TeamMembers for all, skip duplicates
       - Invalidate permissions for all added users
       - Return 200 with { added: int, skipped: int }

    **DTOs:** Define as inner records.

    **Cache invalidation:** Every team membership change or default role change must trigger cache invalidation for affected users. When default role changes, invalidate ALL members. When a member is added/removed, invalidate only that member.
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    TeamsController has 8 endpoints.
    Member management includes add, remove, and bulk add.
    Cache invalidation called on membership and default role changes.
  </verify>
  <done>TeamsController created with full CRUD, member management (including bulk), and proper cache invalidation.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors
2. RolesController: 10 endpoints including clone, assign, my-permissions
3. TeamsController: 8 endpoints including bulk member add
4. System roles cannot be modified or deleted
5. Role cloning copies all permissions
6. Cache invalidation on every role/team/assignment change
7. my-permissions endpoint accessible by any authenticated user
</verification>

<success_criteria>
- Admin can CRUD custom roles with per-entity CRUD permissions and field-level access
- Admin can clone template roles to create custom roles
- Admin can assign/unassign roles to users
- Admin can CRUD teams with default roles and manage members
- Permission cache invalidated on every relevant change
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-07-SUMMARY.md`
</output>
