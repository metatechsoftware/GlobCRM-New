---
phase: 02-core-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
  - src/GlobCRM.Domain/Entities/CustomFieldSection.cs
  - src/GlobCRM.Domain/Entities/CustomFieldValidation.cs
  - src/GlobCRM.Domain/Entities/FieldOption.cs
  - src/GlobCRM.Domain/Entities/SavedView.cs
  - src/GlobCRM.Domain/Entities/ViewColumn.cs
  - src/GlobCRM.Domain/Entities/ViewFilter.cs
  - src/GlobCRM.Domain/Entities/ViewSort.cs
  - src/GlobCRM.Domain/Enums/CustomFieldType.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldDefinitionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldSectionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/SavedViewConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "CustomFieldDefinition entity exists with all field types, validation JSONB, options JSONB, soft delete, and section reference"
    - "CustomFieldSection entity exists for admin-defined grouping of custom fields"
    - "SavedView entity exists with JSONB columns, filters, sorts, owner/team distinction, and page size"
    - "CustomFieldType enum includes all 9 required types"
    - "NpgsqlDataSourceBuilder uses EnableDynamicJson() for JSONB Dictionary serialization"
    - "EF Core migration created for custom_field_definitions, custom_field_sections, saved_views tables"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs"
      provides: "Custom field metadata entity"
      contains: "CustomFieldType FieldType"
    - path: "src/GlobCRM.Domain/Entities/SavedView.cs"
      provides: "Saved view entity with column/filter/sort config"
      contains: "List<ViewColumn> Columns"
    - path: "src/GlobCRM.Domain/Enums/CustomFieldType.cs"
      provides: "All supported custom field types"
      contains: "Text.*Number.*Date.*Dropdown.*Checkbox.*MultiSelect.*Currency.*File.*Relation"
    - path: "src/GlobCRM.Infrastructure/DependencyInjection.cs"
      provides: "EnableDynamicJson configuration"
      contains: "EnableDynamicJson"
  key_links:
    - from: "src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs"
      to: "src/GlobCRM.Domain/Entities/CustomFieldSection.cs"
      via: "SectionId FK"
      pattern: "SectionId"
    - from: "src/GlobCRM.Infrastructure/DependencyInjection.cs"
      to: "NpgsqlDataSourceBuilder"
      via: "EnableDynamicJson() call"
      pattern: "EnableDynamicJson"
---

<objective>
Create custom field and saved view domain entities with JSONB-backed value types, and configure Npgsql for dynamic JSON serialization.

Purpose: Establishes the schema for admin-defined custom fields (with 9 supported types, validation rules, dropdown options, soft delete, and section grouping) and user-saved table views (with column configuration, filters, sorting, and pagination). Enables JSONB Dictionary<string, object?> serialization via EnableDynamicJson().

Output: Domain entities, enums, EF Core configurations, updated ApplicationDbContext, EnableDynamicJson configuration, RLS script update, and migration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md

@src/GlobCRM.Domain/Entities/Organization.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom field and saved view domain entities and enums</name>
  <files>
    src/GlobCRM.Domain/Enums/CustomFieldType.cs
    src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
    src/GlobCRM.Domain/Entities/CustomFieldSection.cs
    src/GlobCRM.Domain/Entities/CustomFieldValidation.cs
    src/GlobCRM.Domain/Entities/FieldOption.cs
    src/GlobCRM.Domain/Entities/SavedView.cs
    src/GlobCRM.Domain/Entities/ViewColumn.cs
    src/GlobCRM.Domain/Entities/ViewFilter.cs
    src/GlobCRM.Domain/Entities/ViewSort.cs
  </files>
  <action>
    **CustomFieldType enum** (src/GlobCRM.Domain/Enums/CustomFieldType.cs):
    - Values: Text = 0, Number = 1, Date = 2, Dropdown = 3, Checkbox = 4, MultiSelect = 5, Currency = 6, File = 7, Relation = 8
    - Per locked decision: all 9 types must be supported

    **CustomFieldValidation** (src/GlobCRM.Domain/Entities/CustomFieldValidation.cs):
    - This is a JSONB-mapped value type (not a standalone table)
    - Properties: Required (bool), MinLength (int?), MaxLength (int?), MinValue (decimal?), MaxValue (decimal?), RegexPattern (string?), Unique (bool), ConditionalRequiredField (string?), ConditionalRequiredValue (string?)
    - Per locked decision: supports required, min/max length/value, regex patterns, unique constraints, conditional required

    **FieldOption** (src/GlobCRM.Domain/Entities/FieldOption.cs):
    - JSONB-mapped value type for dropdown/multi-select options
    - Properties: Value (string), Label (string), Color (string? — for display in chips), SortOrder (int)

    **CustomFieldSection** (src/GlobCRM.Domain/Entities/CustomFieldSection.cs):
    - Per research recommendation: admin-defined sections for custom field grouping
    - Properties: Id (Guid), TenantId (Guid), EntityType (string), Name (string), SortOrder (int), IsCollapsedByDefault (bool, default false), CreatedAt (DateTimeOffset)
    - Navigation: ICollection<CustomFieldDefinition> Fields

    **CustomFieldDefinition** (src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs):
    - Properties: Id (Guid), TenantId (Guid), EntityType (string), Name (string — internal snake_case name), Label (string — display label), FieldType (CustomFieldType), SortOrder (int), SectionId (Guid? — optional section grouping), Validation (CustomFieldValidation — JSONB), Options (List<FieldOption>? — JSONB for dropdown/multi-select), RelationEntityType (string? — target entity for Relation fields), IsDeleted (bool, default false), DeletedAt (DateTimeOffset?), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: CustomFieldSection? Section
    - Per locked decision: soft delete (IsDeleted + DeletedAt) for data preservation

    **ViewColumn** (src/GlobCRM.Domain/Entities/ViewColumn.cs):
    - JSONB-mapped value type
    - Properties: FieldId (string — core field name or CustomFieldDefinition.Id as string), IsCustomField (bool), Width (int, default 150), SortOrder (int), Visible (bool, default true)

    **ViewFilter** (src/GlobCRM.Domain/Entities/ViewFilter.cs):
    - JSONB-mapped value type
    - Properties: FieldId (string), Operator (string — "equals", "contains", "gt", "lt", "gte", "lte", "in", "between"), Value (string?)

    **ViewSort** (src/GlobCRM.Domain/Entities/ViewSort.cs):
    - JSONB-mapped value type
    - Properties: FieldId (string), Direction (string, default "asc"), SortOrder (int)

    **SavedView** (src/GlobCRM.Domain/Entities/SavedView.cs):
    - Properties: Id (Guid), TenantId (Guid), EntityType (string), Name (string), OwnerId (Guid? — null = team-wide, non-null = personal), IsTeamDefault (bool, default false), Columns (List<ViewColumn> — JSONB), Filters (List<ViewFilter> — JSONB), Sorts (List<ViewSort> — JSONB), PageSize (int, default 25), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: ApplicationUser? Owner
    - Per locked decision: personal views override team defaults; per research: page-based pagination with 25 default

    IMPORTANT: CustomFieldValidation, FieldOption, ViewColumn, ViewFilter, ViewSort are value types mapped to JSONB columns on their parent entities. They are NOT separate tables.
  </action>
  <verify>
    `dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj` succeeds with 0 errors.
    All 9 files exist with correct properties.
  </verify>
  <done>All custom field and saved view entities created with correct properties, JSONB value types, and navigation properties.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, configure EnableDynamicJson, update ApplicationDbContext and RLS, create migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldDefinitionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldSectionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/SavedViewConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
    scripts/rls-setup.sql
  </files>
  <action>
    **CustomFieldDefinitionConfiguration:**
    - Table: "custom_field_definitions", snake_case columns
    - Name: max 100, Label: max 200, EntityType: max 50, RelationEntityType: max 50
    - FieldType stored as SMALLINT
    - Validation property: `.HasColumnType("jsonb").HasDefaultValueSql("'{}'::jsonb")`
    - Options property: `.HasColumnType("jsonb")` (nullable)
    - Unique constraint: (tenant_id, entity_type, name) — but only WHERE NOT is_deleted. Use `.HasFilter("NOT is_deleted")` on the unique index
    - Index: idx_custom_field_definitions_tenant_entity on (tenant_id, entity_type) with filter WHERE NOT is_deleted
    - FK: SectionId to custom_field_sections with SET NULL on delete
    - Global query filter: soft delete filter `.HasQueryFilter(e => !e.IsDeleted)` combined with tenant filter

    **CustomFieldSectionConfiguration:**
    - Table: "custom_field_sections", snake_case columns
    - Name: max 100, EntityType: max 50
    - Unique constraint: (tenant_id, entity_type, name)
    - Index: idx_custom_field_sections_tenant_entity on (tenant_id, entity_type)

    **SavedViewConfiguration:**
    - Table: "saved_views", snake_case columns
    - Name: max 100, EntityType: max 50
    - Columns, Filters, Sorts as JSONB: `.HasColumnType("jsonb").HasDefaultValueSql("'[]'::jsonb")`
    - PageSize default 25
    - FK: OwnerId to AspNetUsers with SET NULL on delete
    - Index: idx_saved_views_tenant_entity on (tenant_id, entity_type)
    - Index: idx_saved_views_owner on (owner_id)

    **ApplicationDbContext update:**
    - Add DbSet<CustomFieldDefinition> CustomFieldDefinitions
    - Add DbSet<CustomFieldSection> CustomFieldSections
    - Add DbSet<SavedView> SavedViews
    - Add global query filters for all three (tenant-scoped)
    - CustomFieldDefinition needs BOTH tenant filter AND soft-delete filter: `e => (_tenantProvider == null || e.TenantId == _tenantProvider.TenantId) && !e.IsDeleted`

    **DependencyInjection.cs update:**
    - CRITICAL: Update the NpgsqlDataSource configuration to use EnableDynamicJson()
    - Find where the connection string is used with UseNpgsql and change to:
      ```csharp
      var dataSourceBuilder = new NpgsqlDataSourceBuilder(connectionString);
      dataSourceBuilder.EnableDynamicJson();
      var dataSource = dataSourceBuilder.Build();
      ```
    - Then use `options.UseNpgsql(dataSource)` instead of `options.UseNpgsql(connectionString)`
    - This is REQUIRED for Dictionary<string, object?> and List<T> JSONB serialization per research pitfall #3

    **RLS script update:**
    - Add RLS policies for custom_field_definitions, custom_field_sections, saved_views tables
    - Follow existing pattern: ENABLE ROW LEVEL SECURITY + FORCE ROW LEVEL SECURITY
    - Policy: tenant_id = current_setting('app.current_tenant')::uuid

    **Migration:**
    - Run: `dotnet ef migrations add AddCustomFieldsAndViews -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api -c ApplicationDbContext`
    - NOTE: If Plan 01 migration has not been applied yet (it won't be — plans run in parallel), the migration will build on top of it. This is fine — EF Core handles pending migrations correctly. If there are issues, create a single combined migration.
    - Verify migration creates: custom_field_definitions, custom_field_sections, saved_views tables
  </action>
  <verify>
    `dotnet build` succeeds with 0 errors.
    Migration file exists with "AddCustomFieldsAndViews" in the name.
    DependencyInjection.cs contains "EnableDynamicJson" call.
    ApplicationDbContext has DbSets for CustomFieldDefinition, CustomFieldSection, SavedView.
  </verify>
  <done>EF Core configurations, EnableDynamicJson, ApplicationDbContext updates, RLS script, and migration all created successfully.</done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with 0 errors across all projects
2. All new files exist on disk
3. Migration file created with correct table definitions (custom_field_definitions, custom_field_sections, saved_views)
4. EnableDynamicJson() configured on NpgsqlDataSourceBuilder in DependencyInjection.cs
5. CustomFieldDefinition has JSONB validation and options columns
6. SavedView has JSONB columns, filters, sorts columns
7. ApplicationDbContext has DbSets and query filters for all new entities
8. RLS script has policies for new tables
</verification>

<success_criteria>
- CustomFieldDefinition entity supports all 9 field types with validation rules and dropdown options
- SavedView entity supports column config, filters, sorting, and page-based pagination
- EnableDynamicJson() configured for JSONB Dictionary serialization
- EF Core migration generated successfully
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-02-SUMMARY.md`
</output>
