---
phase: 22-shared-foundation-entity-preview-sidebar
plan: 04
type: execute
wave: 4
depends_on: ["22-01", "22-03"]
files_modified:
  - globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
  - globcrm-web/src/app/features/feed/feed-list/feed-list.component.scss
autonomous: true
requirements:
  - PREVIEW-01
  - PREVIEW-05
  - PREVIEW-07

must_haves:
  truths:
    - "Clicking an entity name in the feed opens the preview sidebar instead of navigating away"
    - "Entity names in feed items are styled as links with underline on hover"
    - "Ctrl/Cmd+click on entity names navigates to the full detail page (standard link behavior)"
    - "Hovering over an entity name shows a lightweight tooltip with entity type icon + name (no API call)"
    - "Feed scroll position is preserved when opening and closing the preview sidebar"
    - "Clicking a different entity in the feed replaces the sidebar content (new stack root, not push)"
    - "Feed page remains scrollable and interactive while the sidebar is open"
  artifacts:
    - path: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      provides: "Feed entity links open preview sidebar"
      contains: "previewStore.open"
    - path: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.scss"
      provides: "Entity link hover styling"
      contains: "feed-entity-link"
  key_links:
    - from: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      to: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      via: "onEntityClick calls previewStore.open()"
      pattern: "previewStore\\.open"
    - from: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      to: "globcrm-web/src/app/shared/services/entity-type-registry.ts"
      via: "getEntityConfig for tooltip text/icon and getEntityRoute for navigation URLs"
      pattern: "getEntity(Config|Route)"
---

<objective>
Replace the feed's entity link navigation with preview sidebar integration. Entity names become styled links that open the preview sidebar on click, navigate on Ctrl/Cmd+click, and show hover tooltips. Feed scroll position is preserved throughout.

Purpose: This is the primary user-facing integration point -- the feed is where users discover entity changes, and clicking to peek at an entity without losing their feed position is the core PREVIEW-01 requirement.

Output: Updated feed-list component with sidebar-opening entity links, hover tooltips, and preserved scroll position.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-RESEARCH.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-01-SUMMARY.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-03-SUMMARY.md

@globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
@globcrm-web/src/app/features/feed/feed.models.ts
@globcrm-web/src/app/shared/services/entity-type-registry.ts
@globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace feed entity link navigation with preview sidebar integration</name>
  <files>
    globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
    globcrm-web/src/app/features/feed/feed-list/feed-list.component.scss
  </files>
  <action>
    **Part A: Import and inject dependencies**

    In `feed-list.component.ts`:
    1. Import `PreviewSidebarStore` from `shared/stores/preview-sidebar.store.ts`.
    2. Import `getEntityConfig` and `getEntityRoute` from `shared/services/entity-type-registry.ts`.
    3. Import `MatTooltipModule` from `@angular/material/tooltip`.
    4. Import `MatIconModule` (if not already imported).
    5. Add `MatTooltipModule` to the component's `imports` array.
    6. Inject the store: `readonly previewStore = inject(PreviewSidebarStore);`

    **Part B: Replace entity link in template**

    Find the existing entity link block:
    ```html
    @if (item.entityType && item.entityId) {
      <a class="feed-entity-link" (click)="navigateToEntity(item)">
        <mat-icon>open_in_new</mat-icon>
        View {{ item.entityType }}
      </a>
    }
    ```

    Replace with:
    ```html
    @if (item.entityType && item.entityId) {
      <a class="feed-entity-link"
         [matTooltip]="getEntityTooltip(item)"
         matTooltipShowDelay="300"
         (click)="onEntityClick($event, item)"
         (auxclick)="onEntityMiddleClick($event, item)">
        <mat-icon class="entity-link-icon">{{ getEntityIcon(item.entityType) }}</mat-icon>
        {{ item.entityName || ('View ' + item.entityType) }}
      </a>
    }
    ```

    **Part C: Update click handlers**

    Replace the existing `navigateToEntity` method with two new methods:

    ```typescript
    /** Handle entity link click -- normal click opens preview, Ctrl/Cmd+click navigates to detail. */
    onEntityClick(event: MouseEvent, item: FeedItemDto): void {
      if (!item.entityType || !item.entityId) return;

      // Ctrl/Cmd+click: navigate to full detail page
      if (event.ctrlKey || event.metaKey) {
        event.preventDefault();
        const route = getEntityRoute(item.entityType, item.entityId);
        this.router.navigateByUrl(route);
        return;
      }

      // Normal click: open preview sidebar
      this.previewStore.open({
        entityType: item.entityType,
        entityId: item.entityId,
        entityName: item.entityName ?? undefined,
      });
    }

    /** Handle middle-click to open in new tab (standard browser behavior via href). */
    onEntityMiddleClick(event: MouseEvent, item: FeedItemDto): void {
      // Middle click (button === 1) -- let browser handle if we add href, or navigate manually
      if (event.button === 1 && item.entityType && item.entityId) {
        const route = getEntityRoute(item.entityType, item.entityId);
        window.open(route, '_blank');
      }
    }
    ```

    **Part D: Add tooltip and icon helpers**

    ```typescript
    /** Get tooltip text for entity link hover (no API call -- uses data from feed item). */
    getEntityTooltip(item: FeedItemDto): string {
      const config = getEntityConfig(item.entityType ?? '');
      const name = item.entityName || item.entityType || '';
      return config ? `${config.label}: ${name}` : name;
    }

    /** Get Material icon for entity type from registry. */
    getEntityIcon(entityType: string | null): string {
      if (!entityType) return 'open_in_new';
      return getEntityConfig(entityType)?.icon ?? 'open_in_new';
    }
    ```

    **Part E: Remove the old `navigateToEntity` method.** It is fully replaced by `onEntityClick`.

    **Part F: Entity link styling**

    In the component's styles (or SCSS file if external), update the `.feed-entity-link` class:

    ```scss
    .feed-entity-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--color-primary);
      text-decoration: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      padding: 2px 0;
      transition: color 0.15s ease;

      &:hover {
        text-decoration: underline;
        color: var(--color-primary-dark, var(--color-primary));
      }

      .entity-link-icon {
        font-size: 16px;
        width: 16px;
        height: 16px;
      }
    }
    ```

    This implements the locked decision: "Styled as links with underline on hover."

    **Scroll position preservation note:** The push-content layout with `mode="side"` on the mat-sidenav naturally preserves scroll position because the mat-sidenav-content element maintains its scroll position when the sidenav opens/closes. The feed component is not destroyed or re-rendered. No special scroll handling code is needed -- the architecture from Plan 22-03 handles this. Verify during testing.
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` -- must compile.
    2. Start the app. Navigate to the feed page. Verify entity links show entity names (from the entityName field populated in Plan 22-01).
    3. Click an entity link -- preview sidebar should slide in from the right.
    4. Scroll down in the feed, click a different entity link -- sidebar should update, scroll position should be preserved.
    5. Ctrl/Cmd+click an entity link -- should navigate to the detail page.
    6. Hover over an entity link -- tooltip should appear after 300ms showing entity type + name.
    7. Press Escape -- sidebar should close.
    8. Click the feed area (outside sidebar) -- sidebar should close.
  </verify>
  <done>
    Feed entity links open the preview sidebar on normal click. Ctrl/Cmd+click navigates to the full detail page. Entity names display from the denormalized entityName field. Hover tooltip shows entity type + name after 300ms (no API call). Links are styled with underline on hover. Feed scroll position is preserved when opening/closing the sidebar. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` compiles
2. Feed entity links open preview sidebar (not navigate)
3. Ctrl/Cmd+click navigates to detail page
4. Hover tooltip displays after 300ms with entity type icon + name
5. Feed scroll position preserved when sidebar opens and closes
6. Clicking a different entity in the feed replaces sidebar content (new stack root)
7. Entity names show from the entityName field, falling back to "View {EntityType}" if null
</verification>

<success_criteria>
- No navigation occurs when clicking entity links in feed (sidebar opens instead)
- Ctrl/Cmd+click still provides direct navigation to detail pages
- Hover tooltips work client-side only (no API call)
- Feed scroll position never changes when sidebar opens/closes
- Entity link styling matches locked decision (underline on hover)
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-shared-foundation-entity-preview-sidebar/22-04-SUMMARY.md`
</output>
