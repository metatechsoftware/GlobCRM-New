---
phase: 22-shared-foundation-entity-preview-sidebar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  # Backend: entity_name denormalization + ShowInPreview flag
  - src/GlobCRM.Domain/Entities/FeedItem.cs
  - src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/FeedItemConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldDefinitionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Migrations/App  # new migration files
  - src/GlobCRM.Api/Controllers/FeedController.cs
  - src/GlobCRM.Api/Controllers/DealsController.cs
  - src/GlobCRM.Api/Controllers/LeadsController.cs
  - src/GlobCRM.Api/Controllers/ActivitiesController.cs
  - src/GlobCRM.Api/Controllers/CustomFieldsController.cs
  - src/GlobCRM.Infrastructure/Services/TenantSeeder.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs
  - src/GlobCRM.Infrastructure/Notifications/DueDateNotificationService.cs
  # Frontend: EntityTypeRegistry + tab refactor
  - globcrm-web/src/app/shared/services/entity-type-registry.ts
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
  - globcrm-web/src/app/features/feed/feed.models.ts
autonomous: true
requirements:
  - PREVIEW-07

must_haves:
  truths:
    - "EntityTypeRegistry provides icon, label, labelPlural, routePrefix, and color for all 6 entity types (Contact, Company, Deal, Lead, Activity, Product)"
    - "RelatedEntityTabsComponent emits tab label strings instead of numeric indices via the tabChanged output"
    - "All 5 detail pages using RelatedEntityTabsComponent (contact, company, deal, lead) and activity-detail (direct mat-tab-group) match on label strings, not index numbers"
    - "FeedItem entity has an EntityName string property that is persisted to the database and included in FeedItemDto"
    - "CustomFieldDefinition entity has a ShowInPreview boolean property (default false) persisted to the database"
    - "All feed item creation points populate EntityName from the source entity's display name"
    - "Existing feed items display entity names in API responses (backfill has populated entity_name for all pre-existing rows that have a matching source entity)"
  artifacts:
    - path: "globcrm-web/src/app/shared/services/entity-type-registry.ts"
      provides: "Centralized entity type metadata map"
      contains: "ENTITY_TYPE_REGISTRY"
    - path: "src/GlobCRM.Domain/Entities/FeedItem.cs"
      provides: "EntityName property on FeedItem"
      contains: "EntityName"
    - path: "src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs"
      provides: "ShowInPreview property"
      contains: "ShowInPreview"
  key_links:
    - from: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      to: "all detail page onTabChanged methods"
      via: "tabChanged output emitting string labels"
      pattern: "tabChanged\\.emit\\(tab\\.label\\)"
    - from: "src/GlobCRM.Api/Controllers/DealsController.cs"
      to: "src/GlobCRM.Domain/Entities/FeedItem.cs"
      via: "EntityName property on new FeedItem creation"
      pattern: "EntityName\\s*="
---

<objective>
Create shared infrastructure used by all subsequent Phase 22 plans: EntityTypeRegistry (frontend constant map of entity type metadata), tab index refactor (RelatedEntityTabsComponent emits label strings, all 6 detail pages match on labels), entity_name denormalization (new column on feed_items with backfill migration), and ShowInPreview flag on custom field definitions.

Purpose: These are cross-cutting changes that unblock the preview sidebar (EntityTypeRegistry for routing/icons, entity_name for hover tooltips), unblock Phase 23 (label-based tabs for safe tab insertion), and unblock preview custom fields (ShowInPreview flag).

Output: EntityTypeRegistry constant, refactored tab system, two EF Core migrations (entity_name + show_in_preview), updated feed item creation code, updated FeedItemDto.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-RESEARCH.md

@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
@globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
@globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
@globcrm-web/src/app/features/feed/feed.models.ts
@src/GlobCRM.Domain/Entities/FeedItem.cs
@src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/FeedItemConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldDefinitionConfiguration.cs
@src/GlobCRM.Api/Controllers/FeedController.cs
@src/GlobCRM.Api/Controllers/DealsController.cs
@src/GlobCRM.Api/Controllers/LeadsController.cs
@src/GlobCRM.Api/Controllers/ActivitiesController.cs
@src/GlobCRM.Api/Controllers/CustomFieldsController.cs
@src/GlobCRM.Infrastructure/Services/TenantSeeder.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: EntityTypeRegistry + Tab index refactor (frontend)</name>
  <files>
    globcrm-web/src/app/shared/services/entity-type-registry.ts
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
    globcrm-web/src/app/features/feed/feed.models.ts
  </files>
  <action>
    **Part A: EntityTypeRegistry**

    Create `globcrm-web/src/app/shared/services/entity-type-registry.ts` as a pure constant map (no injectable service needed). Define:

    ```typescript
    export interface EntityTypeConfig {
      icon: string;
      label: string;
      labelPlural: string;
      routePrefix: string;
      color: string;
    }

    export const ENTITY_TYPE_REGISTRY: Record<string, EntityTypeConfig> = {
      Contact:  { icon: 'person',      label: 'Contact',  labelPlural: 'Contacts',  routePrefix: '/contacts',  color: 'var(--color-info)' },
      Company:  { icon: 'business',    label: 'Company',  labelPlural: 'Companies', routePrefix: '/companies', color: 'var(--color-secondary)' },
      Deal:     { icon: 'handshake',   label: 'Deal',     labelPlural: 'Deals',     routePrefix: '/deals',     color: 'var(--color-warning)' },
      Lead:     { icon: 'trending_up', label: 'Lead',     labelPlural: 'Leads',     routePrefix: '/leads',     color: 'var(--color-success)' },
      Activity: { icon: 'task_alt',    label: 'Activity', labelPlural: 'Activities', routePrefix: '/activities', color: 'var(--color-accent)' },
      Product:  { icon: 'inventory_2', label: 'Product',  labelPlural: 'Products',  routePrefix: '/products',  color: 'var(--color-primary)' },
    };

    export function getEntityConfig(entityType: string): EntityTypeConfig | null {
      return ENTITY_TYPE_REGISTRY[entityType] ?? null;
    }

    export function getEntityRoute(entityType: string, entityId: string): string {
      const config = ENTITY_TYPE_REGISTRY[entityType];
      return config ? `${config.routePrefix}/${entityId}` : '/';
    }
    ```

    **Part B: Tab index refactor - RelatedEntityTabsComponent**

    In `related-entity-tabs.component.ts`, change the `tabChanged` output from `output<number>()` to `output<string>()`. Update the `onTabChange` method:

    ```typescript
    tabChanged = output<string>();

    onTabChange(index: number): void {
      const tab = this.tabs()[index];
      if (tab) {
        this.tabChanged.emit(tab.label);
      }
    }
    ```

    **Part C: Tab index refactor - All 5 detail page consumers**

    Update each detail page's `onTabChanged` method signature from `(index: number)` to `(label: string)` and replace index comparisons with label string matches:

    1. **contact-detail.component.ts**: Change `onTabChanged(index: number)` to `onTabChanged(label: string)`. Replace `if (index === 3)` with `if (label === 'Activities')`, `if (index === 4)` with `if (label === 'Quotes')`, `if (index === 5)` with `if (label === 'Requests')`, `if (index === 6)` with `if (label === 'Emails')`, `if (index === 7)` with `if (label === 'Notes')`.

    2. **company-detail.component.ts**: Change `onTabChanged(index: number)` to `onTabChanged(label: string)`. Replace `if (index === 1)` with `if (label === 'Contacts')`, `if (index === 3)` with `if (label === 'Activities')`, `if (index === 4)` with `if (label === 'Quotes')`, `if (index === 5)` with `if (label === 'Requests')`, `if (index === 6)` with `if (label === 'Emails')`, `if (index === 7)` with `if (label === 'Notes')`.

    3. **deal-detail.component.ts**: Change `onTabChanged(index: number)` to `onTabChanged(label: string)`. Replace `if (index === 3)` with `if (label === 'Activities')`, `if (index === 4)` with `if (label === 'Quotes')`, `if (index === 6)` with `if (label === 'Notes')`.

    4. **lead-detail.component.ts**: Change `onTabChanged(index: number)` to `onTabChanged(label: string)`. The lead has dynamic tabs built from a computed signal. Replace `if (index === 1)` with `if (label === 'Activities')`, `if (index === 2)` with `if (label === 'Notes')`. Check the actual lead tab definitions since they are computed dynamically -- match on the same labels used in the tab config.

    5. **activity-detail**: This page uses `mat-tab-group` directly (not RelatedEntityTabsComponent). In `activity-detail.component.html`, the `(selectedIndexChange)="onTabChange($event)"` stays but internally the handler changes. In `activity-detail.component.ts`, the `onTabChange(index: number)` method currently checks `if (index === 6)` for Notes. Since this page uses direct mat-tab-group without labels emitted, convert its handler to look up the tab label from the template. **Approach:** The activity-detail page has tabs defined in the HTML template directly. Add a local array constant mapping tab indices to labels (e.g., `private readonly TAB_LABELS = ['Details', 'Description', 'Related Contacts', 'Related Companies', 'Related Deals', 'Attachments', 'Notes']`). Then in `onTabChange(index: number)`, resolve the label and switch on it: `const label = this.TAB_LABELS[index]; if (label === 'Notes') this.loadActivityNotes();`. This keeps the mat-tab-group's `(selectedIndexChange)` API while making the handler label-aware.

    **Part D: FeedItemDto entityName**

    Add `entityName: string | null;` to the `FeedItemDto` interface in `globcrm-web/src/app/features/feed/feed.models.ts`. This property will be populated from the backend migration in Task 2.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` -- must compile with no errors. TypeScript type checking will catch any mismatch between the new string-type `tabChanged` output and consumers still expecting number.
  </verify>
  <done>
    EntityTypeRegistry exists with all 6 entity types. RelatedEntityTabsComponent emits tab label strings. All 5 detail pages (contact, company, deal, lead, activity) match on label strings instead of numeric indices. FeedItemDto includes entityName field. Angular build succeeds with no type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Backend entity_name + ShowInPreview migrations and feed item updates</name>
  <files>
    src/GlobCRM.Domain/Entities/FeedItem.cs
    src/GlobCRM.Domain/Entities/CustomFieldDefinition.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/FeedItemConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/CustomFieldDefinitionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Migrations/App  (new migration files)
    src/GlobCRM.Api/Controllers/FeedController.cs
    src/GlobCRM.Api/Controllers/DealsController.cs
    src/GlobCRM.Api/Controllers/LeadsController.cs
    src/GlobCRM.Api/Controllers/ActivitiesController.cs
    src/GlobCRM.Api/Controllers/CustomFieldsController.cs
    src/GlobCRM.Infrastructure/Services/TenantSeeder.cs
    src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs
    src/GlobCRM.Infrastructure/Notifications/DueDateNotificationService.cs
  </files>
  <action>
    **Part A: Domain entity changes**

    1. In `FeedItem.cs`, add property after `EntityId`:
       ```csharp
       /// <summary>
       /// Denormalized display name of the linked entity (for hover tooltips without extra API call).
       /// Populated at feed item creation time. May become stale if entity is renamed.
       /// </summary>
       public string? EntityName { get; set; }
       ```

    2. In `CustomFieldDefinition.cs`, add property after `IsDeleted`/before `DeletedAt`:
       ```csharp
       /// <summary>
       /// When true, this custom field is shown in entity preview sidebars.
       /// Defaults to false. Managed by admin in custom field settings.
       /// </summary>
       public bool ShowInPreview { get; set; } = false;
       ```

    **Part B: EF Core configurations**

    1. In `FeedItemConfiguration.cs`, add column mapping:
       ```csharp
       builder.Property(f => f.EntityName)
           .HasColumnName("entity_name")
           .HasMaxLength(200);
       ```

    2. In `CustomFieldDefinitionConfiguration.cs`, add column mapping:
       ```csharp
       builder.Property(c => c.ShowInPreview)
           .HasColumnName("show_in_preview")
           .HasDefaultValue(false);
       ```

    **Part C: EF Core migration**

    Run from `src/GlobCRM.Api`:
    ```bash
    dotnet ef migrations add AddEntityNameAndShowInPreview --context ApplicationDbContext --output-dir ../GlobCRM.Infrastructure/Persistence/Migrations/App --project ../GlobCRM.Infrastructure
    ```

    After the migration is generated, add a SQL backfill step in the `Up` method. After the `AddColumn` for `entity_name`, add raw SQL to populate existing rows:

    ```csharp
    // Backfill entity_name from source entities
    migrationBuilder.Sql(@"
        UPDATE feed_items fi SET entity_name = c.first_name || ' ' || c.last_name
        FROM contacts c WHERE fi.entity_type = 'Contact' AND fi.entity_id = c.id AND fi.entity_name IS NULL;

        UPDATE feed_items fi SET entity_name = co.name
        FROM companies co WHERE fi.entity_type = 'Company' AND fi.entity_id = co.id AND fi.entity_name IS NULL;

        UPDATE feed_items fi SET entity_name = d.title
        FROM deals d WHERE fi.entity_type = 'Deal' AND fi.entity_id = d.id AND fi.entity_name IS NULL;

        UPDATE feed_items fi SET entity_name = l.first_name || ' ' || l.last_name
        FROM leads l WHERE fi.entity_type = 'Lead' AND fi.entity_id = l.id AND fi.entity_name IS NULL;

        UPDATE feed_items fi SET entity_name = a.subject
        FROM activities a WHERE fi.entity_type = 'Activity' AND fi.entity_id = a.id AND fi.entity_name IS NULL;
    ");
    ```

    **Part D: Update FeedItemDto to include EntityName**

    In `FeedController.cs`, find the `FeedItemDto` record and add `EntityName` property:
    ```csharp
    public string? EntityName { get; init; }
    ```

    Update the `FromEntity` factory method (or LINQ projection) to map `EntityName = fi.EntityName`.

    **Part E: Update all feed item creation points to populate EntityName**

    Search for all `new FeedItem {` in the codebase and add `EntityName = ...`:

    1. **DealsController.cs** -- 3+ places creating `new FeedItem` for deal events. Add `EntityName = deal.Title` (or `created.Title` for create events).

    2. **LeadsController.cs** -- 3+ places creating `new FeedItem` for lead events. Add `EntityName = $"{lead.FirstName} {lead.LastName}"`.

    3. **ActivitiesController.cs** -- places creating `new FeedItem` for activity events. Add `EntityName = activity.Subject`.

    4. **FeedController.cs** -- social post creation (no entity link, so `EntityName` stays null). No change needed.

    5. **TenantSeeder.cs** -- seed data feed item creation. Add `EntityName` to seeded feed items matching the entity name pattern.

    6. Check for feed item creation in `GmailSyncService.cs` and `DueDateNotificationService.cs` (referenced in research). Add `EntityName` where EntityType/EntityId are set.

    **Part F: CustomFieldsController ShowInPreview**

    In `CustomFieldsController.cs`, find the DTO for custom field definitions and add `ShowInPreview` to the response DTO. Update the create/update request DTOs to accept `ShowInPreview` (optional, default false). Update the create and update endpoint handlers to map the field.

    Apply the migration: `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` from `src/GlobCRM.Api`.
  </action>
  <verify>
    1. Run `cd src/GlobCRM.Api && dotnet build` -- must compile with no errors.
    2. Run the migration: `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` -- must succeed.
    3. Verify the backfill: connect to the database and check `SELECT COUNT(*) FROM feed_items WHERE entity_name IS NOT NULL;` -- should be > 0 if seed data exists.
    4. Start the API: `cd src/GlobCRM.Api && dotnet run` and verify `GET /api/feed` returns items with `entityName` populated.
  </verify>
  <done>
    FeedItem has EntityName column with backfilled data. CustomFieldDefinition has ShowInPreview column (default false). All feed item creation points populate EntityName. FeedItemDto includes entityName in API responses. CustomFieldsController accepts and returns ShowInPreview. Migration applied successfully. Backend compiles and runs.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` compiles without errors
2. `cd src/GlobCRM.Api && dotnet build` compiles without errors
3. EF Core migration applies successfully
4. Entity type registry exports `ENTITY_TYPE_REGISTRY` with 6 entries
5. No numeric index comparisons remain in any detail page's tab change handler (grep for `=== 1)` etc.)
6. `GET /api/feed` response includes `entityName` field
</verification>

<success_criteria>
- EntityTypeRegistry constant is importable from `shared/services/entity-type-registry.ts`
- All detail pages use label-based tab matching -- inserting a new tab at any position will not break lazy loading
- Feed items have denormalized entity names in both database and API responses
- CustomFieldDefinition has ShowInPreview toggle available through API
- Both frontend and backend build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/22-shared-foundation-entity-preview-sidebar/22-01-SUMMARY.md`
</output>
