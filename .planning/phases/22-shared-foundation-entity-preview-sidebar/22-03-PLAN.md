---
phase: 22-shared-foundation-entity-preview-sidebar
plan: 03
type: execute
wave: 3
depends_on: ["22-01", "22-02"]
files_modified:
  # AppComponent layout changes
  - globcrm-web/src/app/app.component.ts
  # Sidebar shell
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/preview-skeleton.component.ts
  # Per-entity-type preview templates
  - globcrm-web/src/app/shared/components/entity-preview/contact-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/company-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/deal-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/lead-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/activity-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/product-preview.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/mini-stage-bar.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/mini-timeline.component.ts
  - globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts
  # Store and service
  - globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
  - globcrm-web/src/app/shared/services/entity-preview.service.ts
  # Models
  - globcrm-web/src/app/shared/models/entity-preview.models.ts
autonomous: true
requirements:
  - PREVIEW-02
  - PREVIEW-04
  - PREVIEW-05
  - PREVIEW-06

must_haves:
  truths:
    - "Preview sidebar slides in from the right at ~480px width as a push-content layout (feed compresses to make room) with smooth ~350ms ease animation"
    - "User can close the sidebar by pressing Escape key or clicking the feed area (outside the sidebar)"
    - "User can click 'Open full record' to navigate to the entity detail page and close the sidebar"
    - "Loading skeleton displays while preview data is being fetched"
    - "Error state shows a user-friendly message for deleted/not found entities (icon + message + close button)"
    - "Permission denied state shows a clear message for entities the user cannot access"
    - "PreviewSidebarStore maintains a navigation stack with push/pop/close operations (capped at 10)"
    - "Back button appears when navigation stack has more than 1 entry and pops to the previous preview"
    - "Each entity type has a dedicated preview template showing entity-appropriate fields"
    - "Deal and Lead previews show a mini stage progress bar with current stage highlighted"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts"
      provides: "Sidebar shell with header, back button, close, navigation"
      contains: "EntityPreviewSidebarComponent"
    - path: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      provides: "Root-level signal store for sidebar state and navigation stack"
      contains: "PreviewSidebarStore"
    - path: "globcrm-web/src/app/shared/services/entity-preview.service.ts"
      provides: "API service calling preview endpoint"
      contains: "EntityPreviewService"
    - path: "globcrm-web/src/app/shared/models/entity-preview.models.ts"
      provides: "TypeScript interfaces matching backend DTOs"
      contains: "EntityPreviewDto"
    - path: "globcrm-web/src/app/app.component.ts"
      provides: "mat-sidenav-container wrapping router-outlet with preview sidenav"
      contains: "mat-sidenav-container"
  key_links:
    - from: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      to: "globcrm-web/src/app/shared/services/entity-preview.service.ts"
      via: "Store methods call service to load preview data"
      pattern: "previewService\\.getPreview"
    - from: "globcrm-web/src/app/app.component.ts"
      to: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      via: "mat-sidenav [opened] bound to previewStore.isOpen()"
      pattern: "previewStore\\.isOpen\\(\\)"
    - from: "globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts"
      to: "Per-entity preview components"
      via: "@switch on entityType to render entity-specific template"
      pattern: "@switch.*entityType"
---

<objective>
Build the complete frontend preview sidebar: AppComponent layout refactor to use mat-sidenav-container with push-content mode, PreviewSidebarStore with navigation stack, EntityPreviewService, the sidebar shell component with header/back/close/loading/error states, and all 6 entity-type-specific preview template components.

Purpose: Creates the full sidebar UI that users interact with. After this plan, the sidebar can be opened programmatically (by Plan 22-04's feed integration) and displays entity previews with correct fields, associations, pipeline stage bars, and recent activities.

Output: Working preview sidebar shell, 6 entity preview components, store, service, models, AppComponent layout refactor.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-RESEARCH.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-01-SUMMARY.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-02-SUMMARY.md

@globcrm-web/src/app/app.component.ts
@globcrm-web/src/app/shared/services/entity-type-registry.ts
@globcrm-web/src/app/core/api/api.service.ts
@globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts
@globcrm-web/src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preview models, service, store, and AppComponent layout refactor</name>
  <files>
    globcrm-web/src/app/shared/models/entity-preview.models.ts
    globcrm-web/src/app/shared/services/entity-preview.service.ts
    globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
    globcrm-web/src/app/app.component.ts
  </files>
  <action>
    **Part A: TypeScript interfaces matching backend DTOs**

    Create `globcrm-web/src/app/shared/models/entity-preview.models.ts`:

    ```typescript
    export interface EntityPreviewDto {
      id: string;
      entityType: string;
      name: string;
      ownerName: string | null;
      ownerAvatarUrl: string | null;
      ownerId: string | null;
      fields: Record<string, any>;
      pinnedCustomFields: CustomFieldPreviewDto[];
      associations: AssociationChipDto[];
      pipelineStage: PipelineStagePreviewDto | null;
      recentActivities: RecentActivityDto[];
    }

    export interface CustomFieldPreviewDto {
      label: string;
      fieldType: string;
      value: any;
    }

    export interface AssociationChipDto {
      entityType: string;
      count: number;
      items: AssociationItemDto[];
    }

    export interface AssociationItemDto {
      id: string;
      name: string;
    }

    export interface PipelineStagePreviewDto {
      pipelineName: string;
      currentStageId: string;
      currentStageName: string;
      currentSortOrder: number;
      allStages: StageInfoDto[];
    }

    export interface StageInfoDto {
      id: string;
      name: string;
      sortOrder: number;
      color: string | null;
    }

    export interface RecentActivityDto {
      id: string;
      subject: string;
      type: string;
      status: string;
      createdAt: string;
    }

    export interface PreviewEntry {
      entityType: string;
      entityId: string;
      entityName?: string;
    }
    ```

    **Part B: EntityPreviewService**

    Create `globcrm-web/src/app/shared/services/entity-preview.service.ts`:

    ```typescript
    @Injectable({ providedIn: 'root' })
    export class EntityPreviewService {
      private readonly api = inject(ApiService);

      getPreview(entityType: string, entityId: string): Observable<EntityPreviewDto> {
        return this.api.get<EntityPreviewDto>(
          `entities/${entityType.toLowerCase()}/${entityId}/preview`
        );
      }
    }
    ```

    Note: The `ApiService` already prepends the base URL. Use lowercase entity type in the URL path to match the backend's `type.ToLower()` switch.

    **Part C: PreviewSidebarStore**

    Create `globcrm-web/src/app/shared/stores/preview-sidebar.store.ts` as a root-level signal store:

    ```typescript
    import { signalStore, withState, withComputed, withMethods, patchState } from '@ngrx/signals';
    import { computed, inject } from '@angular/core';
    import { EntityPreviewService } from '../services/entity-preview.service';
    import { EntityPreviewDto, PreviewEntry } from '../models/entity-preview.models';
    import { Router } from '@angular/router';
    import { getEntityRoute } from '../services/entity-type-registry';

    interface PreviewSidebarState {
      isOpen: boolean;
      stack: PreviewEntry[];
      currentData: EntityPreviewDto | null;
      isLoading: boolean;
      error: string | null;
    }

    const initialState: PreviewSidebarState = {
      isOpen: false,
      stack: [],
      currentData: null,
      isLoading: false,
      error: null,
    };

    const MAX_STACK_DEPTH = 10;

    export const PreviewSidebarStore = signalStore(
      { providedIn: 'root' },
      withState(initialState),
      withComputed((store) => ({
        currentEntry: computed(() => {
          const stack = store.stack();
          return stack.length > 0 ? stack[stack.length - 1] : null;
        }),
        canGoBack: computed(() => store.stack().length > 1),
      })),
      withMethods((store) => {
        const previewService = inject(EntityPreviewService);
        const router = inject(Router);

        function loadPreview(entry: PreviewEntry): void {
          previewService.getPreview(entry.entityType, entry.entityId).subscribe({
            next: (data) => patchState(store, { currentData: data, isLoading: false, error: null }),
            error: (err) => {
              const message = err.status === 404
                ? `This ${entry.entityType} was not found. It may have been deleted or merged.`
                : err.status === 403
                ? `You don't have permission to view this ${entry.entityType}.`
                : `Failed to load preview.`;
              patchState(store, { isLoading: false, error: message, currentData: null });
            },
          });
        }

        return {
          open(entry: PreviewEntry): void {
            patchState(store, { isOpen: true, stack: [entry], isLoading: true, error: null, currentData: null });
            loadPreview(entry);
          },
          pushPreview(entry: PreviewEntry): void {
            let newStack = [...store.stack(), entry];
            if (newStack.length > MAX_STACK_DEPTH) {
              newStack = newStack.slice(newStack.length - MAX_STACK_DEPTH);
            }
            patchState(store, { stack: newStack, isLoading: true, error: null, currentData: null });
            loadPreview(entry);
          },
          goBack(): void {
            const stack = store.stack();
            if (stack.length <= 1) return;
            const newStack = stack.slice(0, -1);
            const prevEntry = newStack[newStack.length - 1];
            patchState(store, { stack: newStack, isLoading: true, error: null, currentData: null });
            loadPreview(prevEntry);
          },
          close(): void {
            patchState(store, { isOpen: false, stack: [], currentData: null, error: null, isLoading: false });
          },
          openFullRecord(): void {
            const entry = store.stack()[store.stack().length - 1];
            if (entry) {
              const route = getEntityRoute(entry.entityType, entry.entityId);
              patchState(store, { isOpen: false, stack: [], currentData: null, error: null, isLoading: false });
              router.navigate([route]);
            }
          },
        };
      })
    );
    ```

    **Part D: AppComponent layout refactor**

    Refactor `app.component.ts` to wrap the main content area in `mat-sidenav-container`:

    1. Add imports: `MatSidenavModule` from `@angular/material/sidenav`, and `EntityPreviewSidebarComponent` (created in Task 2).
    2. Inject `PreviewSidebarStore`.
    3. Restructure the template:
       - Keep `<app-navbar />` OUTSIDE the sidenav-container (the navbar is fixed position, not affected by push).
       - Wrap the `<main>` content in `<mat-sidenav-container>`:

    ```html
    @if (showNavbar()) {
      <app-navbar />
    }
    <mat-sidenav-container class="app-sidenav-container"
                           [class.has-nav-sidebar]="showNavbar() && !isMobile()"
                           [class.nav-sidebar-collapsed]="showNavbar() && !isMobile() && sidebarState.isCollapsed()">
      <mat-sidenav-content class="app-content"
                           [class.app-content--with-topbar]="showNavbar() && isMobile()"
                           (click)="onContentClick()">
        <router-outlet />
      </mat-sidenav-content>

      @if (showNavbar()) {
        <mat-sidenav #previewDrawer
                     position="end"
                     mode="side"
                     [opened]="previewStore.isOpen()"
                     disableClose
                     class="preview-drawer">
          <app-entity-preview-sidebar />
        </mat-sidenav>
      }
    </mat-sidenav-container>
    ```

    CSS changes (replace existing .app-content styles):

    ```scss
    :host {
      display: block;
      height: 100vh;
    }

    .app-sidenav-container {
      height: 100vh;
    }

    .app-sidenav-container.has-nav-sidebar {
      margin-left: 240px;
      padding-top: 56px;
      transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .app-sidenav-container.nav-sidebar-collapsed {
      margin-left: 64px;
    }

    .app-content {
      height: 100%;
      overflow: auto;
    }

    .app-content--with-topbar {
      padding-top: 56px;
    }

    .preview-drawer {
      width: 480px;
      border-left: 1px solid var(--color-border);
    }

    ::ng-deep .preview-drawer .mat-drawer-inner-container {
      overflow-y: auto;
    }
    ```

    **CRITICAL:** The existing `.app-content--with-sidebar` class moved margin-left to `.app-sidenav-container.has-nav-sidebar`. The `mat-sidenav-content` gets `height: 100%` and `overflow: auto` so feed scrolling works within it. `mode="side"` ensures push-content behavior. `disableClose` is set because we handle closing manually (clicking the content area triggers `onContentClick()` which calls `previewStore.close()`).

    Add `onContentClick()` method that closes the preview sidebar when the user clicks the main content area:

    ```typescript
    onContentClick(): void {
      if (this.previewStore.isOpen()) {
        this.previewStore.close();
      }
    }
    ```

    Add a `@HostListener('document:keydown.escape')` or use the `(keydown.escape)` on the sidenav to call `previewStore.close()`. The existing template already has `(keydown.escape)` on the mat-sidenav -- add it if not present.

    **Animation:** MatSidenav with `mode="side"` uses its built-in CSS transition. To achieve the ~350ms ease animation per user decision, add a CSS transition override on the `.preview-drawer`:

    ```css
    ::ng-deep .mat-drawer.preview-drawer {
      transition: transform 350ms ease !important;
    }
    ```
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` -- must compile. Check that `PreviewSidebarStore` is importable as a root-provided store.
  </verify>
  <done>
    PreviewSidebarStore exists with open/pushPreview/goBack/close/openFullRecord methods. EntityPreviewService calls the backend endpoint. AppComponent uses mat-sidenav-container with push-content mode at 480px width. Preview sidebar opens/closes with smooth ~350ms animation. Escape key and content click close the sidebar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar shell component and all 6 entity-type preview templates</name>
  <files>
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
    globcrm-web/src/app/shared/components/entity-preview-sidebar/preview-skeleton.component.ts
    globcrm-web/src/app/shared/components/entity-preview/contact-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/company-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/deal-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/lead-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/activity-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/product-preview.component.ts
    globcrm-web/src/app/shared/components/entity-preview/mini-stage-bar.component.ts
    globcrm-web/src/app/shared/components/entity-preview/mini-timeline.component.ts
    globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts
  </files>
  <action>
    **Part A: EntityPreviewSidebarComponent (shell)**

    Create the sidebar shell at `globcrm-web/src/app/shared/components/entity-preview-sidebar/`. This is the container rendered inside the mat-sidenav. It handles:

    - **Header:** Entity type colored chip (using EntityTypeRegistry color + icon), entity name as primary text, back button (when `canGoBack`), close button (X icon), "Open full record" button.
    - **Loading state:** Shows `PreviewSkeletonComponent` when `isLoading`.
    - **Error state:** Shows error message with entity type icon, error text, and close button.
    - **Content:** `@switch` on `currentData().entityType` to render the correct per-entity preview component.

    Template structure (in entity-preview-sidebar.component.html):

    ```html
    <div class="preview-sidebar">
      <!-- Header -->
      <div class="preview-header">
        <div class="preview-header-left">
          @if (store.canGoBack()) {
            <button mat-icon-button (click)="store.goBack()" matTooltip="Back">
              <mat-icon>arrow_back</mat-icon>
            </button>
          }
          @if (entityConfig(); as config) {
            <span class="entity-type-badge" [style.background-color]="config.color">
              <mat-icon>{{ config.icon }}</mat-icon>
              {{ config.label }}
            </span>
          }
        </div>
        <div class="preview-header-right">
          <button mat-button color="primary" (click)="store.openFullRecord()">
            <mat-icon>open_in_new</mat-icon>
            Open full record
          </button>
          <button mat-icon-button (click)="store.close()" matTooltip="Close">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <!-- Entity name -->
      @if (store.currentData(); as data) {
        <div class="preview-entity-name">{{ data.name }}</div>
        @if (data.ownerName) {
          <div class="preview-owner">
            <img [src]="data.ownerAvatarUrl || '/assets/default-avatar.svg'"
                 class="owner-avatar" alt="Owner" />
            <span>{{ data.ownerName }}</span>
          </div>
        }
      }

      <!-- Content -->
      <div class="preview-body">
        @if (store.isLoading()) {
          <app-preview-skeleton />
        } @else if (store.error(); as error) {
          <div class="preview-error">
            <mat-icon>error_outline</mat-icon>
            <p>{{ error }}</p>
            <button mat-stroked-button (click)="store.close()">Close</button>
          </div>
        } @else if (store.currentData(); as data) {
          @switch (data.entityType) {
            @case ('Contact') { <app-contact-preview [data]="data" /> }
            @case ('Company') { <app-company-preview [data]="data" /> }
            @case ('Deal') { <app-deal-preview [data]="data" /> }
            @case ('Lead') { <app-lead-preview [data]="data" /> }
            @case ('Activity') { <app-activity-preview [data]="data" /> }
            @case ('Product') { <app-product-preview [data]="data" /> }
          }

          <!-- Associations section -->
          @if (data.associations.length > 0) {
            <app-association-chips
              [associations]="data.associations"
              (chipClick)="onAssociationClick($event)" />
          }

          <!-- Recent Activities section -->
          @if (data.recentActivities.length > 0) {
            <app-mini-timeline
              [activities]="data.recentActivities"
              [entityType]="data.entityType"
              [entityId]="data.id"
              (viewAllClick)="onViewAllActivities()" />
          }

          <!-- Pinned Custom Fields -->
          @if (data.pinnedCustomFields.length > 0) {
            <div class="preview-section">
              <div class="section-title">Custom Fields</div>
              @for (field of data.pinnedCustomFields; track field.label) {
                <div class="field-row">
                  <span class="field-label">{{ field.label }}</span>
                  <span class="field-value">{{ field.value ?? '-' }}</span>
                </div>
              }
            </div>
          }
        }
      </div>
    </div>
    ```

    Add `onAssociationClick` method that calls `store.pushPreview(...)` with the association's entity type and ID. Add `onViewAllActivities` that navigates to the entity's full detail page activities tab via `store.openFullRecord()`.

    **Styling (entity-preview-sidebar.component.scss):**

    - `.preview-sidebar` full height, flex column, white background
    - `.preview-header` sticky top, flex row, space-between, padding 12px 16px, border-bottom
    - `.entity-type-badge` small pill with icon + label, entity-type color background, white text, rounded
    - `.preview-entity-name` font-size 18px, font-weight 600, padding 16px 16px 4px
    - `.preview-owner` flex row, gap 8px, align-items center, padding 0 16px 16px, font-size 14px, muted color
    - `.owner-avatar` 24px circle
    - `.preview-body` flex-grow, overflow-y auto, padding 0 16px 16px
    - `.preview-error` centered column with icon, text, and close button, muted styling
    - `.preview-section` border-top 1px, padding-top 16px, margin-top 16px
    - `.section-title` font-size 12px, text-transform uppercase, letter-spacing, muted color, margin-bottom 8px
    - `.field-row` flex row, justify space-between, padding 4px 0
    - `.field-label` font-size 13px, muted color
    - `.field-value` font-size 13px, text-align right

    **Part B: PreviewSkeletonComponent**

    Create `preview-skeleton.component.ts` as a standalone component with inline template. Simple CSS pulse-animated placeholders:
    - Circle (32px) + two lines (avatar + name skeleton)
    - 6 rows of label-value pair skeletons (40% + 50% width)
    - 3 small chip skeletons
    - 3 timeline dot + line skeletons

    Use CSS `@keyframes pulse` with background-color cycling from `var(--color-bg-secondary)` to `var(--color-bg-tertiary, #e0e0e0)` at 1.5s infinite.

    **Part C: Per-entity preview components (all 6)**

    Each preview component is a standalone component that takes `data` as an `input<EntityPreviewDto>()` and renders entity-specific fields.

    Create under `globcrm-web/src/app/shared/components/entity-preview/`:

    1. **contact-preview.component.ts** -- Renders fields: Email (with mailto link), Phone, Job Title, Company Name, City. Use `.field-row` layout with label/value pairs.

    2. **company-preview.component.ts** -- Renders fields: Industry, Phone, Website (with external link), Size, City, Country.

    3. **deal-preview.component.ts** -- Renders fields: Value (formatted currency), Probability (%), Expected Close Date, Company Name, Pipeline Name. **Also includes `<app-mini-stage-bar>` for pipeline stage** if `data.pipelineStage` is present.

    4. **lead-preview.component.ts** -- Renders fields: Email, Phone, Company Name, Temperature (colored badge: Hot=red, Warm=orange, Cold=blue), Source. **Also includes `<app-mini-stage-bar>` for lead stage** if `data.pipelineStage` is present.

    5. **activity-preview.component.ts** -- Renders fields: Type, Status, Priority (colored badge), Due Date.

    6. **product-preview.component.ts** -- Renders fields: Unit Price (formatted currency), SKU, Category, Description (truncated).

    All 6 components follow the same pattern: standalone, OnPush, `input<EntityPreviewDto>()`, template with field rows. Keep each component small (~30-60 lines).

    **Part D: Shared sub-components**

    1. **mini-stage-bar.component.ts** -- Standalone component with `stages` and `currentStageId` inputs. Renders a horizontal flex row of stage segments. Past stages (sortOrder < current) get success color at 0.6 opacity. Current stage gets its stage color. Future stages get secondary background. Each segment has `matTooltip` showing stage name. Width: 100%, height: 6px segments with 2px gap.

    2. **mini-timeline.component.ts** -- Standalone component with `activities` input (RecentActivityDto[]), `entityType` and `entityId` inputs, and `viewAllClick` output. Renders a mini vertical timeline with:
       - Left: vertical line with dots (colored by activity type)
       - Right: activity subject, type badge, relative time (e.g., "2h ago")
       - Footer: "View all activities" link that emits `viewAllClick`

    3. **association-chips.component.ts** -- Standalone component with `associations` input (AssociationChipDto[]) and `chipClick` output(PreviewEntry). Renders Material chips:
       - If count <= 3: individual named chips (click emits {entityType, entityId, entityName})
       - If count > 3: single count chip (e.g., "7 Contacts") -- clicking navigates to the entity list page, not preview
       - Chip prefix icon from EntityTypeRegistry
       - Use `mat-chip-set` from `@angular/material/chips`
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` -- must compile. Visually verify: temporarily inject `PreviewSidebarStore` into a dev test and call `store.open({ entityType: 'Contact', entityId: '{some-id}' })` to see the sidebar appear.
  </verify>
  <done>
    EntityPreviewSidebarComponent renders inside AppComponent's mat-sidenav. Loading skeleton shows during fetch. Error state shows friendly message. All 6 entity types render their specific fields. Deal/Lead show mini stage bar. Association chips display with correct counts/names. Mini timeline shows last 3 activities. Back button navigates the stack. Close and Open full record work correctly. Angular build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` compiles without errors
2. Preview sidebar at 480px pushes main content left when opened
3. Escape key and content area click close the sidebar
4. Back button appears when stack > 1 and pops to previous preview
5. "Open full record" navigates to entity detail page and closes sidebar
6. Loading skeleton displays during API call
7. Error state shows for 404 and 403 responses
8. Each entity type renders its specific field layout
</verification>

<success_criteria>
- mat-sidenav-container in AppComponent wraps the router-outlet
- Preview sidebar opens at 480px with push-content mode
- PreviewSidebarStore manages open/close, navigation stack (max 10), loading, and error states
- All 6 entity types have dedicated preview templates
- Mini stage bar, mini timeline, and association chips render correctly
- Angular build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-shared-foundation-entity-preview-sidebar/22-03-SUMMARY.md`
</output>
