---
phase: 18-email-sequences
plan: 05
type: execute
wave: 4
depends_on: [18-04]
files_modified:
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
  - globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts
  - globcrm-web/src/app/features/contacts/contact-list/contact-list.component.html
  - globcrm-web/src/app/features/sequences/sequence-analytics/sequence-analytics.component.ts
  - globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts
  - globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.html
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
autonomous: true
requirements: [ESEQ-03, ESEQ-05, ESEQ-06]

must_haves:
  truths:
    - "DynamicTable supports generic row selection with checkboxes via enableSelection input"
    - "User can multi-select contacts in the contacts list and bulk-enroll them into a sequence"
    - "Bulk enrollment confirmation dialog shows count and notes already-enrolled contacts to be skipped"
    - "Sequence detail page shows summary metric cards (Total Enrolled, Active, Completed, Replied, Bounced)"
    - "Sequence detail page shows a funnel chart visualizing contact drop-off across steps"
    - "Per-step metrics show sent count, open rate, and click rate inline on step cards"
    - "Contact detail page has 'Enroll in Sequence' action in the actions menu"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      provides: "Generic row selection with SelectionModel from @angular/cdk/collections"
      contains: "enableSelection"
    - path: "globcrm-web/src/app/features/sequences/sequence-analytics/sequence-analytics.component.ts"
      provides: "Summary metric cards and funnel chart using Chart.js"
      contains: "SequenceAnalyticsComponent"
  key_links:
    - from: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      to: "@angular/cdk/collections"
      via: "SelectionModel for multi-row selection state"
      pattern: "SelectionModel"
    - from: "globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts"
      to: "globcrm-web/src/app/features/sequences/enrollment-dialog/enrollment-dialog.component.ts"
      via: "Opens enrollment dialog with selected contact IDs"
      pattern: "EnrollmentDialog"
    - from: "globcrm-web/src/app/features/sequences/sequence-analytics/sequence-analytics.component.ts"
      to: "ng2-charts"
      via: "Chart.js horizontal bar chart for funnel visualization"
      pattern: "BaseChartDirective|ChartData"
---

<objective>
Add generic row selection to DynamicTable for bulk enrollment, build sequence analytics with summary cards and funnel chart, integrate bulk enrollment from the contacts list, and add "Enroll in Sequence" to the contact detail page.

Purpose: Completes the enrollment experience (bulk from list, single from contact detail) and the analytics/tracking visualization.
Output: Enhanced DynamicTable with selection, sequence analytics component, contacts list bulk enrollment, contact detail enrollment action.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-email-sequences/18-RESEARCH.md
@.planning/phases/18-email-sequences/18-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DynamicTable row selection and contacts list bulk enrollment</name>
  <files>
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
    globcrm-web/src/app/features/contacts/contact-list/contact-list.component.ts
    globcrm-web/src/app/features/contacts/contact-list/contact-list.component.html
  </files>
  <action>
    **DynamicTable enhancement** — Add generic row selection per research recommendation (generic feature usable by all entity lists):
    - Import `SelectionModel` from `@angular/cdk/collections`.
    - Add input: `enableSelection = input(false)` — controls whether checkboxes appear.
    - Add output: `selectionChanged = output<any[]>()` — emits the array of currently selected row objects.
    - Create internal `selection = new SelectionModel<any>(true, [])` (allowMultiSelect=true).
    - When `enableSelection()` is true:
      - Prepend a "select" column to the displayed columns array.
      - Header cell: mat-checkbox for select-all (checked if all rows selected, indeterminate if some selected). On toggle: `selection.isSelected(row)` check, `selection.toggle(row)`, `toggleAllRows()`.
      - Row cell: mat-checkbox bound to `selection.isSelected(row)`. On change: `selection.toggle(row)`.
    - On selection change: emit `selectionChanged` output with `selection.selected`.
    - Clear selection when data changes (new page, new filters) via `selection.clear()`.
    - Add computed signal: `hasSelection = computed(() => this.selection.selected.length > 0)` and expose selectedCount.
    - This is a GENERIC enhancement — no sequence-specific code in DynamicTable.

    **Contacts list enhancement** — Add bulk enrollment action:
    - Enable selection on the contacts DynamicTable: `[enableSelection]="true"`.
    - Add a bulk action bar that appears when contacts are selected (floating bar at bottom or top bar, following common SaaS pattern): "X contacts selected" label + "Enroll in Sequence" button + "Clear Selection" button.
    - "Enroll in Sequence" button opens a sequence picker dialog (small dialog listing active sequences, search/filter, select one) THEN opens the enrollment confirmation dialog.
    - Enrollment confirmation dialog per locked decision: Shows "Enrolling {N} contacts in {SequenceName}". Shows warning "X contacts are already enrolled and will be skipped" if applicable. Confirm/Cancel buttons.
    - On confirm: call `sequenceService.bulkEnroll(sequenceId, { contactIds })`. Show snackbar with result ("Enrolled 15 contacts, 3 skipped (already enrolled)" per locked decision).
    - Clear selection after successful enrollment.
    - Import SequenceService and MatDialog in the contacts list component.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` — build succeeds. DynamicTable renders checkboxes when enableSelection is true. Contacts list shows bulk action bar when contacts are selected.
  </verify>
  <done>
    DynamicTable has generic row selection with SelectionModel. Contacts list supports multi-select with bulk enrollment into sequences via picker + confirmation dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sequence analytics component and contact detail enrollment action</name>
  <files>
    globcrm-web/src/app/features/sequences/sequence-analytics/sequence-analytics.component.ts
    globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts
    globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.html
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
  </files>
  <action>
    **sequence-analytics.component.ts** — Analytics visualization per locked decisions:
    - Standalone component with OnPush change detection.
    - Inputs: `analytics = input<SequenceAnalytics | null>(null)`, `stepMetrics = input<StepMetrics[]>([])`, `funnelData = input<FunnelData[]>([])`.
    - **Summary metric cards** per locked decision: Row of mat-cards showing Total Enrolled, Active, Completed, Replied, Bounced. Each card has: large number, label, and subtle color (use orange shades for primary metrics, gray for secondary). Follow the dashboard KPI card style.
    - **Funnel chart** per locked decision: Horizontal bar chart using ng2-charts (BaseChartDirective) showing contact drop-off from step 1 through completion.
      - Import `BaseChartDirective` from `ng2-charts` and `ChartData`, `ChartOptions` from `chart.js`.
      - Chart type: 'bar' with `indexAxis: 'y'` (horizontal bars per research pattern 5).
      - Labels: step names from funnelData (e.g., "Step 1: Welcome", "Step 2: Follow-up", ..., "Completed").
      - Data: counts from funnelData.
      - Colors: Orange gradient from dark to light (`#F97316`, `#FB923C`, `#FDBA74`, `#FED7AA`, etc.) per research.
      - Options: responsive, no legend, borderRadius 4, clean grid.
    - **Per-step metrics table** — Below funnel, a simple table or card list per discretion (inline summary with expandable detail): Step #, Template Name, Sent, Open Rate (%), Click Rate (%), with open rate marked "(estimated)" per research caveat about tracking pixel accuracy.

    **sequence-detail enhancement** — Integrate analytics:
    - Add SequenceAnalyticsComponent to the detail page template.
    - Call store.loadAnalytics(), store.loadStepMetrics(), store.loadFunnelData() on init.
    - Pass analytics, stepMetrics, funnelData signals to the analytics component.
    - Position analytics section between the header/status area and the enrollment list.

    **contact-detail enhancement** — Add "Enroll in Sequence" action per locked decision:
    - Find the actions menu (mat-menu) on the contact detail page.
    - Add menu item: "Enroll in Sequence" with an appropriate icon (schedule_send or playlist_add).
    - On click: Open a sequence picker dialog (list active sequences, search, select one). Then call `sequenceService.enrollContact(sequenceId, { contactId: this.contactId })`.
    - Show snackbar on success ("Contact enrolled in {SequenceName}").
    - Per locked decision: This action is available from the contact detail page actions menu.
    - Import SequenceService and MatDialog. Use lazy dialog import if possible to avoid loading sequence module eagerly.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` — build succeeds. Sequence detail shows analytics cards and funnel chart. Contact detail has "Enroll in Sequence" action.
  </verify>
  <done>
    Sequence analytics displays summary metric cards and funnel chart with per-step metrics. Contact detail page has "Enroll in Sequence" action in menu. Full analytics visualization complete.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` — succeeds
2. DynamicTable shows checkboxes when enableSelection is true
3. Contacts list allows multi-select and shows bulk enrollment action
4. Bulk enrollment dialog shows enrolled/skipped counts
5. Sequence detail shows summary metric cards (Total Enrolled, Active, Completed, Replied, Bounced)
6. Sequence detail shows horizontal funnel chart with contact drop-off
7. Per-step metrics show sent, open rate, click rate
8. Contact detail actions menu includes "Enroll in Sequence"
</verification>

<success_criteria>
- DynamicTable generic selection works with SelectionModel (usable by any entity list)
- Contacts list bulk enrollment flow: select contacts -> pick sequence -> confirm -> enrolled
- Analytics metric cards show all enrollment status counts
- Funnel chart visualizes step-by-step drop-off with Chart.js horizontal bars
- Per-step metrics display sent/open/click rates with "(estimated)" on open rates
- Contact detail page enrollment action available from actions menu
- Frontend builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-email-sequences/18-05-SUMMARY.md`
</output>
