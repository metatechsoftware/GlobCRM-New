---
phase: 18-email-sequences
plan: 04
type: execute
wave: 4
depends_on: [18-02, 18-03]
files_modified:
  - globcrm-web/src/app/features/sequences/sequence.models.ts
  - globcrm-web/src/app/features/sequences/sequence.service.ts
  - globcrm-web/src/app/features/sequences/sequence.store.ts
  - globcrm-web/src/app/features/sequences/sequences.routes.ts
  - globcrm-web/src/app/features/sequences/sequence-list/sequence-list.component.ts
  - globcrm-web/src/app/features/sequences/sequence-list/sequence-list.component.html
  - globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.ts
  - globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.html
  - globcrm-web/src/app/features/sequences/sequence-builder/step-item.component.ts
  - globcrm-web/src/app/features/sequences/sequence-builder/template-picker-dialog.component.ts
  - globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts
  - globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.html
  - globcrm-web/src/app/features/sequences/enrollment-dialog/enrollment-dialog.component.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
autonomous: true
requirements: [ESEQ-01, ESEQ-02, ESEQ-07]

must_haves:
  truths:
    - "User can view a list of sequences with key metrics (name, status, steps, enrolled, active, completed, reply rate)"
    - "User can create and edit a sequence with a vertical step list supporting drag-to-reorder via CDK"
    - "Each step shows template name, delay, and collapse/expand details with inline template preview"
    - "User can select email templates for each step via template picker dialog with rendered preview"
    - "User can configure delay as days + preferred time of day for each step"
    - "User can enroll contacts from the sequence detail page via contact picker dialog"
    - "User can pause/resume individual enrollments via row-level toggle"
    - "User can re-enroll contacts choosing start step (beginning, where left off, or specific step)"
    - "Sequences feature is accessible from navbar under Connect group"
  artifacts:
    - path: "globcrm-web/src/app/features/sequences/sequence.models.ts"
      provides: "TypeScript interfaces for Sequence, Step, Enrollment, Analytics, StepMetrics"
      contains: "SequenceListItem"
    - path: "globcrm-web/src/app/features/sequences/sequence.service.ts"
      provides: "HTTP service for all sequence API endpoints"
      contains: "SequenceService"
    - path: "globcrm-web/src/app/features/sequences/sequence.store.ts"
      provides: "NgRx Signal Store for sequence state management"
      contains: "SequenceStore"
    - path: "globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.ts"
      provides: "Sequence create/edit form with CDK drag-drop step reordering"
      contains: "SequenceBuilderComponent"
    - path: "globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts"
      provides: "Sequence detail page with enrollment list and pause/resume controls"
      contains: "SequenceDetailComponent"
  key_links:
    - from: "globcrm-web/src/app/features/sequences/sequence.service.ts"
      to: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      via: "HTTP calls to /api/sequences/* endpoints"
      pattern: "api/sequences"
    - from: "globcrm-web/src/app/features/sequences/sequences.routes.ts"
      to: "globcrm-web/src/app/app.routes.ts"
      via: "Lazy-loaded route registration"
      pattern: "loadChildren.*sequences"
    - from: "globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.ts"
      to: "@angular/cdk/drag-drop"
      via: "CdkDrag, CdkDropList, moveItemInArray for step reordering"
      pattern: "CdkDrag|CdkDropList|moveItemInArray"
---

<objective>
Build the complete frontend sequence feature: models, service, store, routes, list page, builder (create/edit with drag-drop step reordering), detail page with enrollment management, and enrollment dialog.

Purpose: Provides the primary user interface for creating and managing email sequences, enrolling contacts, and controlling enrollments.
Output: Full sequence feature with list, builder, detail, and enrollment dialog components.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-email-sequences/18-RESEARCH.md
@.planning/phases/18-email-sequences/18-01-SUMMARY.md
@.planning/phases/18-email-sequences/18-02-SUMMARY.md
@.planning/phases/18-email-sequences/18-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Models, service, store, routes, list page, and sequence builder</name>
  <files>
    globcrm-web/src/app/features/sequences/sequence.models.ts
    globcrm-web/src/app/features/sequences/sequence.service.ts
    globcrm-web/src/app/features/sequences/sequence.store.ts
    globcrm-web/src/app/features/sequences/sequences.routes.ts
    globcrm-web/src/app/features/sequences/sequence-list/sequence-list.component.ts
    globcrm-web/src/app/features/sequences/sequence-list/sequence-list.component.html
    globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.ts
    globcrm-web/src/app/features/sequences/sequence-builder/sequence-builder.component.html
    globcrm-web/src/app/features/sequences/sequence-builder/step-item.component.ts
    globcrm-web/src/app/features/sequences/sequence-builder/template-picker-dialog.component.ts
  </files>
  <action>
    **sequence.models.ts** — TypeScript interfaces matching the backend DTOs:
    - `SequenceListItem`: id, name, description, status (SequenceStatus), stepCount, totalEnrolled, activeEnrollments, completedEnrollments, replyRate, createdByUserName, createdAt
    - `SequenceDetail`: id, name, description, status, steps (SequenceStep[]), createdByUserId, createdByUserName, createdAt, updatedAt
    - `SequenceStep`: id, stepNumber, emailTemplateId, emailTemplateName, subjectOverride, delayDays, preferredSendTime, createdAt
    - `EnrollmentListItem`: id, contactId, contactName, contactEmail, status (EnrollmentStatus), currentStepNumber, stepsSent, startFromStep, lastStepSentAt, completedAt, repliedAt, replyStepNumber, pausedAt, bouncedAt, createdAt
    - `SequenceAnalytics`: totalEnrolled, active, completed, replied, bounced, unenrolled, paused
    - `StepMetrics`: stepNumber, templateName, sent, uniqueOpens, uniqueClicks, openRate, clickRate
    - `FunnelData`: stepNumber, stepName, count
    - `BulkEnrollResult`: enrolled, skipped, skippedContactIds
    - Enums: `SequenceStatus` (Draft, Active, Paused, Archived), `EnrollmentStatus` (Active, Paused, Completed, Replied, Bounced, Unenrolled)
    - Request types: CreateSequenceRequest, UpdateSequenceRequest, AddStepRequest, UpdateStepRequest, EnrollContactRequest, BulkEnrollRequest

    **sequence.service.ts** — Injectable service extending ApiService pattern:
    - All methods matching SequencesController endpoints:
      - getSequences(), getSequence(id), createSequence(req), updateSequence(id, req), deleteSequence(id)
      - addStep(sequenceId, req), updateStep(sequenceId, stepId, req), deleteStep(sequenceId, stepId), reorderSteps(sequenceId, stepIds)
      - enrollContact(sequenceId, req), bulkEnroll(sequenceId, req), getEnrollments(sequenceId, page, pageSize)
      - pauseEnrollment(sequenceId, enrollmentId), resumeEnrollment(sequenceId, enrollmentId), unenroll(sequenceId, enrollmentId)
      - bulkPauseEnrollments(sequenceId, enrollmentIds), bulkResumeEnrollments(sequenceId, enrollmentIds)
      - getAnalytics(sequenceId), getStepMetrics(sequenceId), getFunnelData(sequenceId)

    **sequence.store.ts** — NgRx Signal Store (component-provided, not root — following WebhookStore pattern from 17-04):
    - State: sequences, selectedSequence, enrollments, analytics, stepMetrics, funnelData, loading, error
    - Methods: loadSequences, loadSequence(id), createSequence, updateSequence, deleteSequence, addStep, updateStep, deleteStep, reorderSteps, enrollContact, bulkEnroll, loadEnrollments, pauseEnrollment, resumeEnrollment, unenroll, loadAnalytics, loadStepMetrics, loadFunnelData

    **sequences.routes.ts** — Lazy-loaded routes:
    - `''` → SequenceListComponent
    - `'new'` → SequenceBuilderComponent
    - `':id'` → SequenceDetailComponent
    - `':id/edit'` → SequenceBuilderComponent
    - All protected by permissionGuard for EmailSequence:View/Edit

    **sequence-list component** — Following entity list pattern:
    - Use DynamicTable if appropriate (check if sequences need custom column configuration). If sequences are simpler (fixed columns), use a standard mat-table instead (per discretion: sequence list uses fixed columns — Name, Status, Steps, Enrolled, Active, Completed, Reply Rate — not user-configurable custom fields).
    - Actually: Use a mat-table (not DynamicTable) since sequences don't have custom fields or saved Views. Follow the webhook-list pattern which also uses mat-table.
    - Columns: Name (link to detail), Status (chip with color: Draft=gray, Active=green, Paused=amber, Archived=gray), Steps (count), Enrolled (total), Active, Completed, Reply Rate (percentage).
    - "Create Sequence" button in header, leading to /sequences/new.
    - Empty state: campaign icon, "No sequences yet", "Create your first email sequence to automate outreach", CTA button per discretion recommendation.

    **sequence-builder component** — Create/edit sequence with vertical step list (per locked decision: HubSpot-style):
    - Top section: Name input, Description textarea, Status toggle (only shown in edit mode).
    - Step list section using `cdkDropList` for drag-to-reorder per locked decision. Import CdkDrag, CdkDropList, CdkDragHandle, moveItemInArray from @angular/cdk/drag-drop.
    - "Add Step" button at bottom of list.
    - On drop: call `moveItemInArray`, reassign stepNumber values, call service reorderSteps.
    - Each step rendered by StepItemComponent.
    - Save/Cancel buttons. On save: create or update sequence, then save steps.
    - Route param `:id` determines create vs edit mode (check for `input() id` binding via withComponentInputBinding).

    **step-item.component.ts** — Individual step card (per locked decision: collapse/expand for details):
    - Collapsed view: drag handle (mat-icon "drag_indicator" per discretion), step number badge, template name, delay summary ("Wait 2 days, send at 9:00 AM" per locked decision format), expand/collapse chevron, delete button.
    - Expanded view: Template selector (button opening template-picker-dialog), rendered preview of selected template shown inline (per locked decision: use iframe srcdoc sandbox similar to email template preview), subject line override input (per locked decision: defaults to template subject but allows override), delay days input (number), preferred send time input (time picker or mat-input type="time"), "Edit Template" link that opens template editor in new tab (per locked decision).
    - Inputs: step data. Outputs: stepChanged, stepDeleted.
    - Use OnPush change detection, standalone component.

    **template-picker-dialog.component.ts** — Dialog for selecting email template:
    - Inject MatDialogRef and MAT_DIALOG_DATA.
    - Load available templates from EmailTemplateService (existing service from Phase 14).
    - Display template cards with name, category, preview thumbnail.
    - On select: close dialog returning selected template { id, name, subject }.
    - Search/filter input for template name.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` — build succeeds. All files exist in features/sequences/.
  </verify>
  <done>
    Sequence models, service, store, routes, list page (mat-table with metrics), builder (CDK drag-drop step reordering with collapse/expand step cards, template picker, delay config), and template picker dialog are complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sequence detail page, enrollment dialog, and navigation</name>
  <files>
    globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts
    globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.html
    globcrm-web/src/app/features/sequences/enrollment-dialog/enrollment-dialog.component.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
    **sequence-detail component** — Main sequence management page:
    - Header: Sequence name, status chip, "Edit" button (navigates to /sequences/:id/edit), "Add Contacts" button (per locked decision: opens enrollment dialog from sequence detail page), status action buttons (Activate, Pause, Archive based on current status).
    - Summary section (placeholder for analytics — will be enhanced in 18-05): Show basic stats inline (Total Enrolled, Active, Completed, Replied using simple metric cards).
    - Steps overview: Read-only vertical list of steps showing step number, template name, delay, and inline per-step metrics (sent count, open rate %, click rate % as small badges per discretion recommendation). Click step to expand and see more detail.
    - Enrollment list: mat-table with columns: Contact Name (link to /contacts/:id), Email, Status (chip with color-coding: Active=green, Paused=amber, Completed=blue, Replied=purple, Bounced=red, Unenrolled=gray), Current Step, Steps Sent, Last Sent, Actions.
    - Actions column per locked decision: Pause/Resume toggle (mat-slide-toggle) for each enrollment row. Unenroll button (mat-icon-button with confirmation dialog).
    - Multi-select checkboxes per locked decision: mat-checkbox in first column for bulk pause/resume. Select-all header checkbox. Bulk action bar appears when items selected: "Pause Selected", "Resume Selected" buttons.
    - Pagination: mat-paginator for enrollment list.
    - Provider: `providers: [SequenceStore]` (component-provided store per webhook pattern).

    **enrollment-dialog component** — Contact picker + re-enrollment config:
    - MatDialog component. Data input: sequenceId (Guid), mode ('enroll' | 're-enroll'), enrollment? (for re-enrollment context).
    - Contact search: Text input with autocomplete dropdown. Use ApiService to search contacts (GET /api/contacts?search=...). Show contact name + email in results.
    - Selected contacts: Chip list showing selected contacts.
    - Per locked decision: If selected contact is already enrolled in OTHER sequences, show warning: "This contact is enrolled in {N} other sequences" but don't block.
    - Per locked decision re-enrollment: If mode is 're-enroll', show radio group for start position: "Start from beginning (Step 1)", "Resume from where they left off (Step {N})", or "Start from specific step" with step number dropdown.
    - Confirm button: calls enrollContact or bulkEnroll. On success: show snackbar with result ("Enrolled 5 contacts, 2 skipped (already enrolled)").

    **app.routes.ts** — Add lazy-loaded route:
    - `{ path: 'sequences', loadChildren: () => import('./features/sequences/sequences.routes').then(m => m.SEQUENCE_ROUTES), canActivate: [permissionGuard], data: { permission: 'EmailSequence:View' } }`

    **navbar** — Add "Sequences" navigation item:
    - Add to the Connect group (after "Email Templates" per Phase 14 pattern and before or after "Webhooks").
    - Icon: `schedule_send` or `forward_to_inbox` (a sequence/drip-related icon).
    - Route: `/sequences`.
    - Permission guard: check EmailSequence:View permission.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` — build succeeds. Navigation shows Sequences in navbar. Route /sequences loads correctly.
  </verify>
  <done>
    Sequence detail page shows enrollment list with pause/resume toggles and bulk actions. Enrollment dialog supports contact search, multi-sequence warning, and re-enrollment step selection. Sequences accessible from navbar with proper route guards.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` — succeeds
2. Navigate to /sequences — shows sequence list with metrics
3. Click "Create Sequence" — builder opens with step drag-drop
4. Steps show template name, delay, collapse/expand
5. Template picker dialog loads and returns selected template
6. Sequence detail shows enrollment list with pause/resume toggles
7. Enrollment dialog searches contacts and shows multi-sequence warning
8. Navbar shows "Sequences" in Connect group
</verification>

<success_criteria>
- Sequence list displays with name, status, steps, and enrollment metrics
- Builder supports drag-to-reorder steps with CDK
- Steps show template preview inline and allow subject override
- Detail page shows enrollment list with individual pause/resume
- Enrollment dialog supports single enrollment with contact search
- Re-enrollment supports choosing start step
- Navbar navigation works with permission guard
- Frontend builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-email-sequences/18-04-SUMMARY.md`
</output>
