---
phase: 25-preview-sidebar-polish-cross-feature-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Api/Controllers/TeamDirectoryController.cs
  - globcrm-web/src/app/shared/components/user-preview/user-preview-popover.component.ts
  - globcrm-web/src/app/shared/services/user-preview.service.ts
  - globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
autonomous: true
requirements:
  - PREVIEW-11

must_haves:
  truths:
    - "User can click an author name in the feed list and a popover appears showing the author's avatar, name, role, email, phone, and activity stats"
    - "Clicking the email address in the user preview popover navigates to the compose flow"
    - "Activity stats (deals assigned, tasks completed today, last active) are fetched in parallel and displayed in the popover"
    - "The popover closes when clicking outside, pressing Escape, or scrolling away"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/TeamDirectoryController.cs"
      provides: "GET /api/team-directory/{userId}/activity-stats endpoint"
      contains: "GetActivityStats"
    - path: "globcrm-web/src/app/shared/components/user-preview/user-preview-popover.component.ts"
      provides: "CDK Overlay popover component for user profile preview"
      contains: "UserPreviewPopoverComponent"
    - path: "globcrm-web/src/app/shared/services/user-preview.service.ts"
      provides: "Service to open/close user preview popover via CDK Overlay"
      contains: "UserPreviewService"
    - path: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      provides: "Clickable author names that open user preview popover"
      contains: "onAuthorClick"
  key_links:
    - from: "feed-list.component.ts"
      to: "user-preview.service.ts"
      via: "onAuthorClick calls userPreviewService.open()"
      pattern: "userPreviewService.*open"
    - from: "user-preview.service.ts"
      to: "user-preview-popover.component.ts"
      via: "CDK Overlay ComponentPortal attachment"
      pattern: "ComponentPortal.*UserPreviewPopoverComponent"
    - from: "user-preview-popover.component.ts"
      to: "TeamDirectoryController"
      via: "HTTP calls to GET /api/team-directory/{userId} and GET /api/team-directory/{userId}/activity-stats"
      pattern: "team-directory"
---

<objective>
Add user profile preview popover: clicking author names in the feed opens a lightweight CDK Overlay popover showing avatar, name, role, email, phone, and activity stats (deals assigned, tasks completed today, last active). Backend provides a new activity-stats endpoint.

Purpose: PREVIEW-11 — users can quickly see who performed an action and their recent activity without navigating away from the feed.
Output: New backend endpoint, UserPreviewService (CDK Overlay), UserPreviewPopoverComponent, clickable feed author names.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-RESEARCH.md
@src/GlobCRM.Api/Controllers/TeamDirectoryController.cs
@globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
@globcrm-web/src/app/features/feed/feed.models.ts
@globcrm-web/src/app/shared/components/avatar/avatar.component.ts
@globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend activity stats endpoint + frontend user preview service and popover</name>
  <files>
    src/GlobCRM.Api/Controllers/TeamDirectoryController.cs
    globcrm-web/src/app/shared/components/user-preview/user-preview-popover.component.ts
    globcrm-web/src/app/shared/services/user-preview.service.ts
  </files>
  <action>
    **Step 1: Add activity stats endpoint to TeamDirectoryController**

    Add a new DTO and endpoint to `TeamDirectoryController.cs`:

    DTO (add near other DTOs at top of file):
    ```csharp
    public record UserActivityStatsDto
    {
        public int DealsAssigned { get; init; }
        public int TasksCompletedToday { get; init; }
        public DateTimeOffset? LastActive { get; init; }
    }
    ```

    Endpoint (add after GetMemberDetail):
    ```csharp
    /// <summary>
    /// Gets activity stats for a team member: deals assigned, tasks completed today, last active time.
    /// All queries run in parallel for performance.
    /// </summary>
    [HttpGet("{userId:guid}/activity-stats")]
    [ProducesResponseType(typeof(UserActivityStatsDto), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<IActionResult> GetActivityStats(Guid userId, CancellationToken ct)
    {
        // Verify user exists in tenant
        var userExists = await _dbContext.Users
            .AsNoTracking()
            .AnyAsync(u => u.Id == userId, ct);

        if (!userExists)
            return NotFound(new { error = "User not found." });

        var today = DateTimeOffset.UtcNow.Date;

        // Run all stat queries sequentially (DbContext is not thread-safe)
        var dealsAssigned = await _dbContext.Deals
            .CountAsync(d => d.OwnerId == userId, ct);

        var tasksCompletedToday = await _dbContext.Activities
            .CountAsync(a => a.AssignedToId == userId && a.IsDone && a.UpdatedAt >= today, ct);

        var lastActive = await _dbContext.Set<GlobCRM.Domain.Entities.FeedItem>()
            .Where(f => f.AuthorId == userId)
            .OrderByDescending(f => f.CreatedAt)
            .Select(f => (DateTimeOffset?)f.CreatedAt)
            .FirstOrDefaultAsync(ct);

        return Ok(new UserActivityStatsDto
        {
            DealsAssigned = dealsAssigned,
            TasksCompletedToday = tasksCompletedToday,
            LastActive = lastActive
        });
    }
    ```

    IMPORTANT: Use sequential awaits (not Task.WhenAll) because DbContext is NOT thread-safe — this is a locked pattern from Phase 24 (STATE.md: "Sequential await for all EF Core queries").

    Build backend: `cd src/GlobCRM.Api && dotnet build`

    **Step 2: Create UserPreviewService (CDK Overlay manager)**

    Create `globcrm-web/src/app/shared/services/user-preview.service.ts`:

    This service manages a CDK Overlay popover for user profile previews. It uses `FlexibleConnectedPositionStrategy` to anchor to the click target element.

    ```typescript
    import { Injectable, Injector, InjectionToken, ElementRef, inject, signal } from '@angular/core';
    import { Overlay, OverlayRef } from '@angular/cdk/overlay';
    import { ComponentPortal } from '@angular/cdk/portal';
    import { UserPreviewPopoverComponent } from '../components/user-preview/user-preview-popover.component';

    export interface UserPreviewConfig {
      userId: string;
      userName: string;
    }

    export const USER_PREVIEW_CONFIG = new InjectionToken<UserPreviewConfig>('USER_PREVIEW_CONFIG');

    @Injectable({ providedIn: 'root' })
    export class UserPreviewService {
      private readonly overlay = inject(Overlay);
      private readonly injector = inject(Injector);

      private overlayRef: OverlayRef | null = null;
      readonly isOpen = signal(false);

      open(config: UserPreviewConfig, origin: ElementRef | HTMLElement): void {
        this.close();

        const elementRef = origin instanceof ElementRef ? origin : new ElementRef(origin);

        this.overlayRef = this.overlay.create({
          positionStrategy: this.overlay.position()
            .flexibleConnectedTo(elementRef)
            .withPositions([
              { originX: 'start', originY: 'bottom', overlayX: 'start', overlayY: 'top', offsetY: 4 },
              { originX: 'start', originY: 'top', overlayX: 'start', overlayY: 'bottom', offsetY: -4 },
              { originX: 'end', originY: 'bottom', overlayX: 'end', overlayY: 'top', offsetY: 4 },
            ]),
          width: '320px',
          hasBackdrop: true,
          backdropClass: 'cdk-overlay-transparent-backdrop',
          scrollStrategy: this.overlay.scrollStrategies.reposition(),
          panelClass: 'user-preview-popover-panel',
        });

        const portalInjector = Injector.create({
          providers: [{ provide: USER_PREVIEW_CONFIG, useValue: config }],
          parent: this.injector,
        });

        const portal = new ComponentPortal(UserPreviewPopoverComponent, null, portalInjector);
        this.overlayRef.attach(portal);

        this.overlayRef.backdropClick().subscribe(() => this.close());
        this.overlayRef.keydownEvents().subscribe((event) => {
          if (event.key === 'Escape') this.close();
        });

        this.isOpen.set(true);
      }

      close(): void {
        if (this.overlayRef) {
          this.overlayRef.dispose();
          this.overlayRef = null;
        }
        this.isOpen.set(false);
      }
    }
    ```

    **Step 3: Create UserPreviewPopoverComponent**

    Create `globcrm-web/src/app/shared/components/user-preview/user-preview-popover.component.ts`:

    Standalone component that:
    - Injects `USER_PREVIEW_CONFIG` for userId and userName
    - On init, calls `GET /api/team-directory/{userId}` for profile data and `GET /api/team-directory/{userId}/activity-stats` for activity stats (using `forkJoin` since these are independent HTTP calls)
    - Displays: avatar (using existing `AvatarComponent`), full name, job title, department, email (clickable → navigates to /emails?compose=true), phone, plus stats: "X deals", "Y tasks today", "Last active Z ago"
    - Uses the project's design tokens and styling patterns
    - Clicking email calls `Router.navigate(['/emails'], { queryParams: { compose: 'true' } })` and closes the popover

    The component should have:
    - `profile` signal (loaded from team-directory endpoint)
    - `stats` signal (loaded from activity-stats endpoint)
    - `isLoading` signal
    - A compact card layout matching the project's visual style (orange accent, design tokens)
    - A `getRelativeTime()` helper for the "Last active" display

    Template structure:
    ```
    <div class="user-preview">
      @if (isLoading()) { skeleton } @else {
        <div class="user-preview__header"> avatar + name + job title </div>
        <div class="user-preview__contact"> clickable email link, phone </div>
        <div class="user-preview__stats"> deals / tasks today / last active </div>
      }
    </div>
    ```

    Add global CSS for the popover panel in `globcrm-web/src/styles.scss`:
    ```scss
    .user-preview-popover-panel {
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    ```

    Build: `cd globcrm-web && npx ng build --configuration development`
  </action>
  <verify>
    Backend: `cd src/GlobCRM.Api && dotnet build` passes. Grep for `GetActivityStats` in TeamDirectoryController.cs.
    Frontend: `cd globcrm-web && npx ng build --configuration development` passes. Verify `user-preview-popover.component.ts` exists and contains `UserPreviewPopoverComponent`. Verify `user-preview.service.ts` exists and contains `UserPreviewService`.
  </verify>
  <done>
    Backend activity-stats endpoint returns deals assigned, tasks completed today, and last active time. Frontend UserPreviewService manages CDK Overlay popover lifecycle. UserPreviewPopoverComponent displays user profile with activity stats. Both backend and frontend build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make feed author names clickable for user preview popover</name>
  <files>
    globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
  </files>
  <action>
    **Step 1: Inject UserPreviewService in FeedListComponent**

    In `feed-list.component.ts`, add import:
    ```typescript
    import { UserPreviewService } from '../../../shared/services/user-preview.service';
    ```

    Add injection:
    ```typescript
    private readonly userPreviewService = inject(UserPreviewService);
    ```

    **Step 2: Make author name span clickable in template**

    Find the `<span class="feed-author-name">{{ item.authorName }}</span>` in the template and change it to:
    ```html
    <span class="feed-author-name feed-author-name--clickable"
          (click)="onAuthorClick($event, item)">{{ item.authorName }}</span>
    ```

    Also make comment author names clickable. Find `<span class="comment-author">{{ comment.authorName }}</span>` and change to:
    ```html
    <span class="comment-author comment-author--clickable"
          (click)="onAuthorClick($event, { authorId: comment.authorId, authorName: comment.authorName })">{{ comment.authorName }}</span>
    ```

    Note: The `comment` object from FeedStore should already have `authorId`. Verify by checking feed.models.ts. If `authorId` is missing from comments, just make the feed item author name clickable (not comments).

    **Step 3: Add the onAuthorClick handler**

    ```typescript
    onAuthorClick(event: MouseEvent, item: { authorId?: string; authorName: string }): void {
      event.stopPropagation();
      if (!item.authorId) return;

      const target = event.target as HTMLElement;
      this.userPreviewService.open(
        { userId: item.authorId, userName: item.authorName },
        target
      );
    }
    ```

    **Step 4: Add clickable cursor styling**

    Add to the component styles:
    ```css
    .feed-author-name--clickable {
      cursor: pointer;
      transition: color var(--duration-fast, 100ms);

      &:hover {
        color: var(--color-primary, #F97316);
      }
    }

    .comment-author--clickable {
      cursor: pointer;

      &:hover {
        color: var(--color-primary, #F97316);
      }
    }
    ```

    Build: `cd globcrm-web && npx ng build --configuration development`
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development` passes. Grep for `onAuthorClick` in feed-list.component.ts. Grep for `feed-author-name--clickable` in feed-list.component.ts. Grep for `userPreviewService` in feed-list.component.ts.
  </verify>
  <done>
    Feed author names are clickable with hover effect (orange color on hover, pointer cursor). Clicking opens the UserPreviewPopoverComponent via CDK Overlay anchored to the clicked name, showing avatar, profile info, and activity stats. Build passes.
  </done>
</task>

</tasks>

<verification>
1. Backend build: `cd src/GlobCRM.Api && dotnet build` passes
2. Frontend build: `cd globcrm-web && npx ng build --configuration development` passes
3. Activity stats endpoint: `grep "GetActivityStats" src/GlobCRM.Api/Controllers/TeamDirectoryController.cs`
4. User preview popover exists: `ls globcrm-web/src/app/shared/components/user-preview/user-preview-popover.component.ts`
5. User preview service exists: `ls globcrm-web/src/app/shared/services/user-preview.service.ts`
6. Feed author clickable: `grep "onAuthorClick" globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts`
7. CDK Overlay usage: `grep "flexibleConnectedTo" globcrm-web/src/app/shared/services/user-preview.service.ts`
</verification>

<success_criteria>
- Clicking a feed author name opens a popover anchored to the clicked name
- Popover shows avatar, full name, job title, email (clickable), phone, and activity stats
- Activity stats endpoint returns deals assigned, tasks completed today, and last active timestamp
- Popover closes on backdrop click, Escape key, or scroll reposition
- Clicking email in popover navigates to /emails?compose=true
- Backend and frontend builds pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-02-SUMMARY.md`
</output>
