---
phase: 13-leads
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Lead.cs
  - src/GlobCRM.Domain/Entities/LeadStage.cs
  - src/GlobCRM.Domain/Entities/LeadSource.cs
  - src/GlobCRM.Domain/Entities/LeadStageHistory.cs
  - src/GlobCRM.Domain/Entities/LeadConversion.cs
  - src/GlobCRM.Domain/Enums/EntityType.cs
  - src/GlobCRM.Domain/Enums/LeadTemperature.cs
  - src/GlobCRM.Domain/Interfaces/ILeadRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/LeadConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/LeadStageConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/LeadSourceConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/LeadStageHistoryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/LeadConversionConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/LeadRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - scripts/rls-setup.sql
autonomous: true
requirements:
  - LEAD-01
  - LEAD-03
  - LEAD-05

must_haves:
  truths:
    - "Lead entity exists with person fields (FirstName, LastName, Email, Phone), company string, stage FK, source FK, temperature enum, OwnerId, CustomFields JSONB, and conversion tracking fields"
    - "LeadStage entity is tenant-scoped with Name, SortOrder, Color, IsConverted, IsLost flags for terminal stage identification"
    - "LeadSource entity is tenant-scoped with Name field for configurable source list"
    - "Lead has full-text search vector across FirstName, LastName, Email, CompanyName"
    - "All tenant-scoped entities (Lead, LeadStage, LeadSource) have global query filters and RLS policies"
    - "Seed data creates 5 default stages, 7 default sources, and sample leads with varied stages/temperatures"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Lead.cs"
      provides: "Lead entity with person, pipeline, source, temperature, conversion tracking, custom fields"
      contains: "public class Lead"
    - path: "src/GlobCRM.Domain/Entities/LeadStage.cs"
      provides: "Configurable pipeline stage entity"
      contains: "public class LeadStage"
    - path: "src/GlobCRM.Domain/Entities/LeadSource.cs"
      provides: "Configurable lead source entity"
      contains: "public class LeadSource"
    - path: "src/GlobCRM.Domain/Entities/LeadStageHistory.cs"
      provides: "Stage transition audit trail"
      contains: "public class LeadStageHistory"
    - path: "src/GlobCRM.Domain/Entities/LeadConversion.cs"
      provides: "Conversion record linking lead to contact/company/deal"
      contains: "public class LeadConversion"
    - path: "src/GlobCRM.Domain/Enums/LeadTemperature.cs"
      provides: "Hot/Warm/Cold temperature enum"
      contains: "Hot"
    - path: "src/GlobCRM.Domain/Interfaces/ILeadRepository.cs"
      provides: "Repository interface with paged list, kanban, stage history, CRUD"
      exports: ["ILeadRepository"]
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/LeadRepository.cs"
      provides: "Full repository implementation with filtering, sorting, scope enforcement"
      contains: "class LeadRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Configurations/LeadConfiguration.cs"
      provides: "EF type config with JSONB, GIN indexes, full-text search vector"
      contains: "ToTable(\"leads\")"
  key_links:
    - from: "src/GlobCRM.Domain/Enums/EntityType.cs"
      to: "Lead permission policies"
      via: "Lead enum value"
      pattern: "Lead"
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "Lead, LeadStage, LeadSource, LeadStageHistory, LeadConversion"
      via: "DbSet properties and HasQueryFilter"
      pattern: "DbSet<Lead>"
    - from: "src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs"
      to: "ILeadRepository -> LeadRepository"
      via: "AddScoped DI registration"
      pattern: "AddScoped<ILeadRepository"
---

<objective>
Create the complete backend domain model and data infrastructure for the Lead entity, including all supporting entities (LeadStage, LeadSource, LeadStageHistory, LeadConversion), EF Core configurations, repository with full query support, database migration, tenant isolation, and seed data.

Purpose: Establishes the data foundation that all subsequent plans depend on -- API controllers, frontend components, and the conversion workflow all require these entities and repository to exist.
Output: Domain entities, EF configurations, repository implementation, migration, RLS policies, seed data for 5 stages + 7 sources + sample leads.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-leads/13-RESEARCH.md

@src/GlobCRM.Domain/Entities/Deal.cs
@src/GlobCRM.Domain/Entities/Contact.cs
@src/GlobCRM.Domain/Entities/DealStageHistory.cs
@src/GlobCRM.Domain/Entities/Pipeline.cs
@src/GlobCRM.Domain/Entities/PipelineStage.cs
@src/GlobCRM.Domain/Enums/EntityType.cs
@src/GlobCRM.Domain/Interfaces/IDealRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealStageHistoryConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
@src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain entities and enums</name>
  <files>
    src/GlobCRM.Domain/Entities/Lead.cs
    src/GlobCRM.Domain/Entities/LeadStage.cs
    src/GlobCRM.Domain/Entities/LeadSource.cs
    src/GlobCRM.Domain/Entities/LeadStageHistory.cs
    src/GlobCRM.Domain/Entities/LeadConversion.cs
    src/GlobCRM.Domain/Enums/EntityType.cs
    src/GlobCRM.Domain/Enums/LeadTemperature.cs
    src/GlobCRM.Domain/Interfaces/ILeadRepository.cs
  </files>
  <action>
    Create the Lead entity following the Contact.cs + Deal.cs hybrid pattern from RESEARCH.md Pattern 2:
    - Person fields: FirstName, LastName, Email?, Phone?, MobilePhone?, JobTitle?
    - Company: CompanyName? (string, NOT FK -- leads may reference non-existent companies)
    - Pipeline: LeadStageId (required FK to LeadStage), Stage nav property
    - Source: LeadSourceId? (nullable FK to LeadSource), Source nav property
    - Temperature: LeadTemperature enum (Hot, Warm, Cold) defaulting to Warm
    - Ownership: OwnerId? (nullable FK to ApplicationUser), Owner nav property -- per user decision, uses OwnerId like all other CRM entities for RBAC scope compatibility
    - Conversion tracking: IsConverted bool, ConvertedAt?, ConvertedByUserId?, ConvertedContactId?, ConvertedCompanyId?, ConvertedDealId? -- per discretion, mark as Converted + read-only (NOT soft-delete)
    - Standard CRM: CustomFields Dictionary<string, object?>, Description?, SearchVector NpgsqlTsVector, IsSeedData bool, CreatedAt, UpdatedAt
    - Computed: FullName => $"{FirstName} {LastName}".Trim()

    Create LeadStage entity (separate from Pipeline/PipelineStage per research recommendation):
    - Id Guid, TenantId Guid, Name string, SortOrder int, Color string (default "#1976d2"), IsConverted bool, IsLost bool, CreatedAt, UpdatedAt
    - Simpler than PipelineStage -- no probability, no required fields, no team scoping
    - Per user decision: two terminal stages (Converted=success, Lost=failure)

    Create LeadSource entity:
    - Id Guid, TenantId Guid, Name string, SortOrder int, IsDefault bool, CreatedAt, UpdatedAt
    - Per user decision: configurable per tenant, admin manages the source list

    Create LeadStageHistory entity following DealStageHistory.cs pattern:
    - Id Guid, LeadId Guid (required FK), FromStageId? Guid, ToStageId Guid, ChangedByUserId? Guid, ChangedAt DateTimeOffset, Notes? string
    - Nav properties: Lead, FromStage?, ToStage, ChangedByUser?

    Create LeadConversion entity for conversion audit trail:
    - Id Guid, LeadId Guid (required FK, unique -- one conversion per lead), ContactId Guid (required -- contact always created), CompanyId? Guid, DealId? Guid, ConvertedByUserId Guid, ConvertedAt DateTimeOffset, Notes? string
    - Nav properties: Lead, Contact, Company?, Deal?, ConvertedByUser

    Create LeadTemperature enum: Hot, Warm, Cold

    Add `Lead` value to existing EntityType enum (after Note).

    Create ILeadRepository interface following IDealRepository pattern with:
    - GetPagedAsync(EntityQueryParams, PermissionScope, Guid userId, List<Guid>? teamMemberIds, Guid? stageId, Guid? sourceId, LeadTemperature? temperature) -> PagedResult<Lead>
    - GetByIdAsync(Guid id) -> Lead?
    - GetByIdWithDetailsAsync(Guid id) -> Lead? (full navigation loading for detail page: Stage, Source, Owner, LeadConversion with Contact/Company/Deal)
    - GetForKanbanAsync(PermissionScope, Guid userId, List<Guid>? teamMemberIds, bool includeTerminal = false) -> List<Lead>
    - CreateAsync(Lead lead) -> Lead
    - UpdateAsync(Lead lead) -> Task
    - DeleteAsync(Guid id) -> Task
    - GetStageHistoryAsync(Guid leadId) -> List<LeadStageHistory>
    - GetStagesAsync() -> List<LeadStage>
    - GetSourcesAsync() -> List<LeadSource>
  </action>
  <verify>
    `cd src/GlobCRM.Domain && dotnet build` compiles without errors. All 5 entity files, 2 enum files, and 1 interface file exist.
  </verify>
  <done>
    Lead entity has all person, pipeline, source, temperature, ownership, conversion, and standard CRM fields. LeadStage has configurable stages with terminal flags. LeadSource is a configurable entity. LeadStageHistory tracks transitions. LeadConversion records conversion details. EntityType enum includes Lead. ILeadRepository has full CRUD + query + kanban + stage history interface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EF configurations, repository implementation, and DbContext registration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/LeadConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/LeadStageConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/LeadSourceConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/LeadStageHistoryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/LeadConversionConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/LeadRepository.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  </files>
  <action>
    Create LeadConfiguration following DealConfiguration.cs pattern:
    - ToTable("leads") with snake_case column names
    - JSONB custom_fields column with GIN index (idx_leads_custom_fields_gin)
    - HasGeneratedTsVectorColumn for SearchVector across FirstName, LastName, Email, CompanyName with GIN index (idx_leads_search_vector)
    - FK to LeadStage (required, Restrict on delete -- cannot delete stage with leads)
    - FK to LeadSource (optional, SetNull on delete)
    - FK to ApplicationUser Owner (optional, SetNull on delete)
    - Indexes: idx_leads_tenant_id, idx_leads_stage_id, idx_leads_source_id, idx_leads_owner_id, idx_leads_is_converted

    Create LeadStageConfiguration:
    - ToTable("lead_stages") with snake_case columns
    - Name required, max 100 chars
    - Color max 20 chars
    - TenantId required, index on (tenant_id, sort_order)

    Create LeadSourceConfiguration:
    - ToTable("lead_sources") with snake_case columns
    - Name required, max 100 chars
    - TenantId required, index on (tenant_id, sort_order)

    Create LeadStageHistoryConfiguration following DealStageHistoryConfiguration pattern:
    - ToTable("lead_stage_histories") with snake_case columns
    - FK to Lead (required, Cascade on delete)
    - FK to LeadStage FromStage (optional, SetNull)
    - FK to LeadStage ToStage (required, Restrict)
    - FK to ApplicationUser ChangedByUser (optional, SetNull)

    Create LeadConversionConfiguration:
    - ToTable("lead_conversions") with snake_case columns
    - FK to Lead (required, Cascade on delete), unique index on LeadId
    - FK to Contact (required, Restrict)
    - FK to Company (optional, SetNull)
    - FK to Deal (optional, SetNull)
    - FK to ApplicationUser ConvertedByUser (required, Restrict)

    Create LeadRepository implementing ILeadRepository:
    - Inject ApplicationDbContext
    - GetPagedAsync: Apply search (full-text via SearchVector), filters (stage, source, temperature, date range, custom fields), sorting (any property), ownership scope (Own/Team/All via OwnerId), pagination. Include Stage, Source, Owner navigations.
    - GetByIdAsync: Include Stage, Source, Owner
    - GetByIdWithDetailsAsync: Include Stage, Source, Owner, and eagerly load LeadConversion (if exists) with Contact, Company, Deal navigations via a separate query or conditional include
    - GetForKanbanAsync: Load all leads with Stage, Source, Owner. Filter by scope. Exclude terminal stages unless includeTerminal=true. Order by CreatedAt descending.
    - CRUD: Standard create/update/delete pattern from DealRepository
    - GetStageHistoryAsync: Include FromStage, ToStage, ChangedByUser. Order by ChangedAt descending.
    - GetStagesAsync/GetSourcesAsync: Simple ordered queries filtered by tenant (via global query filter)

    Update ApplicationDbContext:
    - Add DbSets: Leads, LeadStages, LeadSources, LeadStageHistories, LeadConversions
    - Add HasQueryFilter for Lead, LeadStage, LeadSource (all have TenantId -- filter by _tenantProvider.TenantId)
    - LeadStageHistory and LeadConversion inherit isolation via Lead FK (no separate filter needed, same as DealStageHistory pattern)

    Update CrmEntityServiceExtensions.AddCrmEntityServices():
    - Add `services.AddScoped<ILeadRepository, LeadRepository>();`
  </action>
  <verify>
    `cd src/GlobCRM.Infrastructure && dotnet build` compiles without errors. All 5 configuration files, LeadRepository.cs exist. ApplicationDbContext has Lead-related DbSets. CrmEntityServiceExtensions registers ILeadRepository.
  </verify>
  <done>
    All EF configurations produce correct PostgreSQL tables with snake_case names, JSONB + GIN indexes, full-text search, and proper FK relationships. LeadRepository implements all query methods with scope enforcement. DbContext has DbSets and tenant query filters. DI registration wired.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database migration, RLS policies, and seed data</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Migrations/App/ (new migration files)
    scripts/rls-setup.sql
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  </files>
  <action>
    Run EF Core migration from src/GlobCRM.Api:
    `dotnet ef migrations add AddLeadEntities --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure`
    Then apply: `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`

    Add RLS policies to scripts/rls-setup.sql following the existing pattern (e.g., deals, contacts):
    - leads table: ALTER TABLE leads ENABLE ROW LEVEL SECURITY; CREATE POLICY tenant_isolation_leads with USING (tenant_id = current_setting('app.current_tenant')::uuid)
    - lead_stages table: Same pattern
    - lead_sources table: Same pattern
    - lead_stage_histories: NO separate RLS needed (FK cascade from leads provides isolation, same as deal_stage_histories pattern -- check if deal_stage_histories has RLS; if it does, add for lead_stage_histories too; if not, skip)
    - lead_conversions: Same approach as lead_stage_histories

    Update TenantSeeder to add lead seed data inside the main SeedAsync method (follow the existing pattern of seeding after deals):
    - Create 5 LeadStages with IsSeedData=true:
      1. New (SortOrder=0, Color="#2196f3", IsConverted=false, IsLost=false)
      2. Contacted (SortOrder=1, Color="#ff9800", IsConverted=false, IsLost=false)
      3. Qualified (SortOrder=2, Color="#4caf50", IsConverted=false, IsLost=false)
      4. Lost (SortOrder=3, Color="#f44336", IsConverted=false, IsLost=true)
      5. Converted (SortOrder=4, Color="#9c27b0", IsConverted=false, IsLost=false, IsConverted=true)
    - Create 7 LeadSources with IsSeedData=true:
      Website, Referral, LinkedIn, Cold Call, Trade Show, Email Campaign, Other (per user decision)
    - Create 8-10 sample Lead records with IsSeedData=true:
      - Spread across New, Contacted, Qualified stages (no Lost/Converted for fresh demo)
      - Mix of Hot, Warm, Cold temperatures
      - Varied sources
      - Assign OwnerId to seeded users
      - Include CompanyName, Email, Phone for realistic data
    - Wrap in the same idempotent pattern as existing seed data (check for non-seed leads before seeding, delete existing seed leads before re-seeding on --reseed)

    Verify the backend builds and starts:
    `cd src/GlobCRM.Api && dotnet build`
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds. Migration file exists in Persistence/Migrations/App/. RLS script has leads, lead_stages, lead_sources policies. TenantSeeder creates stages, sources, and sample leads.
  </verify>
  <done>
    Database migration creates leads, lead_stages, lead_sources, lead_stage_histories, lead_conversions tables with all indexes. RLS policies enforce tenant isolation at database level. TenantSeeder creates 5 default stages (New, Contacted, Qualified, Lost, Converted), 7 default sources, and 8-10 sample leads with varied stages and temperatures.
  </done>
</task>

</tasks>

<verification>
- `cd src/GlobCRM.Api && dotnet build` compiles the entire solution without errors
- Migration file exists and can be applied to the database
- `scripts/rls-setup.sql` contains RLS policies for leads, lead_stages, lead_sources tables
- EntityType enum contains `Lead` value
- ApplicationDbContext has DbSet<Lead>, DbSet<LeadStage>, DbSet<LeadSource>, DbSet<LeadStageHistory>, DbSet<LeadConversion> with query filters
- CrmEntityServiceExtensions registers ILeadRepository
</verification>

<success_criteria>
- All domain entities compile with correct properties and relationships
- EF configurations produce correct PostgreSQL schema (snake_case, JSONB, GIN indexes, FTS)
- Repository implements paged queries with scope enforcement, kanban loading, and stage history
- Database migration runs cleanly
- Triple-layer tenant isolation complete (entity TenantId + query filter + RLS)
- Seed data creates realistic demo environment with stages, sources, and leads
</success_criteria>

<output>
After completion, create `.planning/phases/13-leads/13-01-SUMMARY.md`
</output>
