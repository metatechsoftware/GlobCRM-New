---
phase: 13-leads
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/GlobCRM.Api/Controllers/LeadsController.cs
  - src/GlobCRM.Api/Controllers/LeadSourcesController.cs
  - src/GlobCRM.Api/Controllers/LeadStagesController.cs
autonomous: true
requirements:
  - LEAD-01
  - LEAD-03
  - LEAD-04
  - LEAD-06

must_haves:
  truths:
    - "API supports full CRUD for leads with validation and permission policies"
    - "API supports lead stage transitions with forward-only enforcement and reopen action"
    - "API supports lead conversion to contact + optional company + optional deal in a single transaction"
    - "API provides Kanban endpoint returning leads grouped by stage"
    - "API provides timeline endpoint assembling lead history from stage changes, notes, activities"
    - "API supports admin CRUD for lead stages and lead sources"
    - "Conversion endpoint performs duplicate checking for contact email and company name"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/LeadsController.cs"
      provides: "Full CRUD + stage change + convert + kanban + timeline endpoints"
      contains: "class LeadsController"
    - path: "src/GlobCRM.Api/Controllers/LeadSourcesController.cs"
      provides: "Admin CRUD for configurable lead sources"
      contains: "class LeadSourcesController"
    - path: "src/GlobCRM.Api/Controllers/LeadStagesController.cs"
      provides: "Admin CRUD for configurable lead stages"
      contains: "class LeadStagesController"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/LeadsController.cs"
      to: "ILeadRepository"
      via: "constructor injection"
      pattern: "ILeadRepository"
    - from: "LeadsController.Convert"
      to: "ApplicationDbContext"
      via: "single SaveChangesAsync for atomic conversion"
      pattern: "SaveChangesAsync"
    - from: "LeadsController.UpdateStage"
      to: "LeadStageHistory"
      via: "stage history recording"
      pattern: "LeadStageHistory"
---

<objective>
Create the complete REST API layer for leads: LeadsController with full CRUD, stage transitions (forward-only + reopen), Kanban loading, timeline assembly, and the lead-to-contact/company/deal conversion endpoint; plus LeadStagesController and LeadSourcesController for admin configuration.

Purpose: Provides all backend endpoints the frontend needs for list, detail, form, Kanban, and conversion UI.
Output: Three controller files with DTOs, validators, and all lead management endpoints.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-leads/13-RESEARCH.md
@.planning/phases/13-leads/13-01-SUMMARY.md

@src/GlobCRM.Api/Controllers/DealsController.cs
@src/GlobCRM.Api/Controllers/ContactsController.cs
@src/GlobCRM.Api/Controllers/PipelinesController.cs
@src/GlobCRM.Api/Controllers/CompaniesController.cs
@src/GlobCRM.Domain/Entities/Lead.cs
@src/GlobCRM.Domain/Entities/LeadStage.cs
@src/GlobCRM.Domain/Entities/LeadSource.cs
@src/GlobCRM.Domain/Entities/LeadStageHistory.cs
@src/GlobCRM.Domain/Entities/LeadConversion.cs
@src/GlobCRM.Domain/Interfaces/ILeadRepository.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LeadsController with CRUD, stage transitions, Kanban, and timeline</name>
  <files>
    src/GlobCRM.Api/Controllers/LeadsController.cs
  </files>
  <action>
    Create LeadsController following DealsController.cs pattern with co-located DTOs, request records, and FluentValidation validators in the same file.

    **DTOs (static FromEntity factory methods):**
    - LeadListDto: Id, FirstName, LastName, FullName, Email, Phone, CompanyName, StageName, StageColor, SourceName, Temperature, OwnerName, IsConverted, CreatedAt, UpdatedAt
    - LeadDetailDto: All list fields + MobilePhone, JobTitle, Description, CustomFields, OwnerId, LeadStageId, LeadSourceId, ConvertedAt, ConvertedByUserName, ConvertedContactId, ConvertedCompanyId, ConvertedDealId, ConversionDetails (if converted)
    - LeadKanbanCardDto: Id, FullName, CompanyName, Email, SourceName, Temperature, OwnerName, OwnerInitials, DaysInStage (computed from last stage history entry or CreatedAt), CreatedAt
    - LeadStageDto: Id, Name, SortOrder, Color, IsConverted, IsLost
    - LeadTimelineEventDto: Type (string), Description, Timestamp, UserId?, UserName?

    **Request records:**
    - CreateLeadRequest: FirstName, LastName, Email?, Phone?, MobilePhone?, JobTitle?, CompanyName?, LeadStageId, LeadSourceId?, Temperature?, OwnerId?, Description?, CustomFields?
    - UpdateLeadRequest: Same fields as Create
    - UpdateLeadStageRequest: StageId (the target stage)
    - ReopenLeadRequest: StageId (the target non-terminal stage to reopen to)
    - ConvertLeadRequest (see Task 2)
    - CheckDuplicatesRequest: (none -- uses lead's existing data)

    **Validators (FluentValidation):**
    - CreateLeadValidator: FirstName required (max 100), LastName required (max 100), Email valid format if provided, Phone max 50
    - UpdateLeadValidator: Same rules

    **Endpoints:**
    1. GET /api/leads -- Paged list with filtering/sorting/search. Uses EntityQueryParams. Permission: Lead:View. Returns PagedResult<LeadListDto>.
    2. GET /api/leads/{id} -- Single lead detail. Permission: Lead:View. Returns LeadDetailDto.
    3. POST /api/leads -- Create lead. Permission: Lead:Create. Validates, creates Lead entity, sets TenantId from ITenantProvider, creates initial LeadStageHistory entry. Returns 201 with LeadDetailDto.
    4. PUT /api/leads/{id} -- Update lead. Permission: Lead:Update. Validates, updates. Returns LeadDetailDto.
    5. DELETE /api/leads/{id} -- Delete lead. Permission: Lead:Delete. Returns 204.
    6. PATCH /api/leads/{id}/stage -- Move lead to a new stage. Permission: Lead:Update. **Forward-only enforcement**: compare newStage.SortOrder > currentStage.SortOrder. Reject if moving backward (return 400 "Use reopen endpoint to move lead backward"). Reject if lead is already in a terminal stage (IsConverted or IsLost) with 400 "Cannot change stage of converted/lost lead". Record LeadStageHistory entry. Return updated LeadDetailDto.
    7. POST /api/leads/{id}/reopen -- Reopen a lead from terminal stage. Permission: Lead:Update. Validates target stage is NOT terminal. Records LeadStageHistory entry with Notes="Lead reopened". If lead was converted, clear IsConverted/ConvertedAt/ConvertedContactId/etc. Return LeadDetailDto.
    8. GET /api/leads/kanban -- Kanban board data. Permission: Lead:View. Returns all lead stages + leads grouped per stage. Include `includeTerminal` query param. Returns { stages: LeadStageDto[], leads: LeadKanbanCardDto[] }.
    9. GET /api/leads/{id}/timeline -- Timeline endpoint. Permission: Lead:View. Assemble chronological events from: lead creation, stage history, notes (EntityType="Lead"), activities (EntityType="Lead"), attachments, conversion event. Return List<LeadTimelineEventDto> ordered by Timestamp descending.

    **Important patterns to follow:**
    - Get current user ID and permission scope from IPermissionService (same as DealsController)
    - Set TenantId from ITenantProvider on create
    - Dispatch FeedItem + notifications in try/catch (failures don't fail primary operation)
    - Use JSON serialization with camelCase enum strings
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles. LeadsController.cs exists with all 9 endpoints, DTOs, request records, and validators.
  </verify>
  <done>
    LeadsController provides full CRUD (5 endpoints), forward-only stage transition + reopen (2 endpoints), Kanban data (1 endpoint), and timeline (1 endpoint). All endpoints have correct permission policies. Stage transitions enforce forward-only with backend validation. DTOs use static FromEntity factory methods. Validators use FluentValidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conversion endpoint with duplicate detection, and create admin controllers for stages and sources</name>
  <files>
    src/GlobCRM.Api/Controllers/LeadsController.cs
    src/GlobCRM.Api/Controllers/LeadSourcesController.cs
    src/GlobCRM.Api/Controllers/LeadStagesController.cs
  </files>
  <action>
    **Add to LeadsController -- Conversion endpoints:**

    10. GET /api/leads/{id}/convert/check-duplicates -- Permission: Lead:Update. Checks lead's email against existing contacts (case-insensitive exact match) and CompanyName against existing companies (case-insensitive contains). Returns { contactMatches: ContactMatchDto[], companyMatches: CompanyMatchDto[] }. ContactMatchDto: Id, FullName, Email, CompanyName. CompanyMatchDto: Id, Name, Phone, Website.

    11. POST /api/leads/{id}/convert -- Permission: Lead:Update. ConvertLeadRequest fields:
    - Contact fields (required, pre-filled from lead): FirstName, LastName, Email?, Phone?, MobilePhone?, JobTitle?
    - Company choice: ExistingCompanyId? (link to existing) OR CreateCompany bool + NewCompanyName? + NewCompanyWebsite? + NewCompanyPhone?
    - Deal choice: CreateDeal bool + DealTitle? + DealValue? + DealPipelineId?

    Conversion flow (single SaveChangesAsync per research pitfall #2):
    a. Validate lead exists, is not already Converted or Lost
    b. Create Contact entity from request fields, set TenantId
    c. If ExistingCompanyId provided: link contact to existing company. If CreateCompany: create Company entity, link contact.
    d. If CreateDeal: create Deal entity with first stage of the specified pipeline (or default pipeline), set CompanyId, link DealContact.
    e. Create LeadConversion record with all created entity IDs
    f. Mark lead: IsConverted=true, ConvertedAt=now, ConvertedByUserId, ConvertedContactId, ConvertedCompanyId?, ConvertedDealId?
    g. Move lead to the Converted stage (find stage where IsConverted=true)
    h. Create LeadStageHistory entry
    i. Single _db.SaveChangesAsync() -- atomic transaction
    j. Dispatch feed event + notifications in try/catch
    k. Return ConvertLeadResult: { ContactId, CompanyId?, DealId? }

    ConvertLeadValidator: FirstName required, LastName required. If CreateCompany then NewCompanyName required. If CreateDeal then DealTitle required and DealPipelineId required.

    **Create LeadStagesController** following PipelinesController admin pattern:
    - [Route("api/lead-stages")], [Authorize(Roles = "Admin")]
    - GET /api/lead-stages -- List all stages ordered by SortOrder
    - POST /api/lead-stages -- Create stage (validate Name required, max 100)
    - PUT /api/lead-stages/{id} -- Update stage (name, color, sort order). Cannot change IsConverted/IsLost on existing stages.
    - DELETE /api/lead-stages/{id} -- Delete stage only if no leads reference it (return 400 with count if leads exist)
    - POST /api/lead-stages/reorder -- Accept ordered list of stage IDs, update SortOrder values. Validate terminal stages cannot be reordered before non-terminal stages.
    - DTOs: LeadStageDto (Id, Name, SortOrder, Color, IsConverted, IsLost, LeadCount)

    **Create LeadSourcesController** with same admin pattern:
    - [Route("api/lead-sources")], [Authorize(Roles = "Admin")]
    - GET /api/lead-sources -- List all sources ordered by SortOrder
    - POST /api/lead-sources -- Create source (validate Name required, max 100)
    - PUT /api/lead-sources/{id} -- Update source name
    - DELETE /api/lead-sources/{id} -- Delete source only if no leads reference it (or set leads' SourceId to null)
    - DTOs: LeadSourceDto (Id, Name, SortOrder, IsDefault, LeadCount)

    **Web form capture API -- DEFERRED per research discretion recommendation.** Do NOT include any public/unauthenticated lead capture endpoint.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` compiles. LeadsController has convert + check-duplicates endpoints. LeadStagesController and LeadSourcesController exist with admin CRUD endpoints.
  </verify>
  <done>
    Conversion endpoint atomically creates Contact + optional Company + optional Deal in a single SaveChangesAsync, marks lead as Converted, records LeadConversion and LeadStageHistory. Duplicate check endpoint returns contact email and company name matches. LeadStagesController provides admin CRUD with reorder. LeadSourcesController provides admin CRUD. Web form capture correctly deferred.
  </done>
</task>

</tasks>

<verification>
- `cd src/GlobCRM.Api && dotnet build` compiles the entire solution
- LeadsController has 11 endpoints: GET list, GET detail, POST create, PUT update, DELETE, PATCH stage, POST reopen, GET kanban, GET timeline, GET check-duplicates, POST convert
- LeadStagesController has 5 endpoints: GET list, POST create, PUT update, DELETE, POST reorder
- LeadSourcesController has 4 endpoints: GET list, POST create, PUT update, DELETE
- All endpoints have correct [Authorize(Policy = "Permission:Lead:...")] or [Authorize(Roles = "Admin")] attributes
- Conversion uses single SaveChangesAsync (no partial commit risk)
- Stage transitions enforce forward-only on backend (SortOrder comparison)
</verification>

<success_criteria>
- Complete REST API for lead management with 20 total endpoints across 3 controllers
- Forward-only stage enforcement with explicit reopen action
- Atomic conversion creating contact + optional company + optional deal
- Duplicate detection for conversion (case-insensitive email + company name matching)
- Admin stage/source management with referential integrity checks on delete
- All DTOs use static FromEntity factories, all requests have FluentValidation validators
</success_criteria>

<output>
After completion, create `.planning/phases/13-leads/13-02-SUMMARY.md`
</output>
