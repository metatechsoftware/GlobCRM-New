---
phase: 13-leads
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - globcrm-web/src/app/features/leads/lead.models.ts
  - globcrm-web/src/app/features/leads/lead.service.ts
  - globcrm-web/src/app/features/leads/lead.store.ts
  - globcrm-web/src/app/features/leads/leads.routes.ts
  - globcrm-web/src/app/features/leads/lead-list/lead-list.component.ts
  - globcrm-web/src/app/features/leads/lead-list/lead-list.component.html
  - globcrm-web/src/app/features/leads/lead-list/lead-list.component.scss
  - globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.ts
  - globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.html
  - globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.scss
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
autonomous: true
requirements:
  - LEAD-01
  - LEAD-02
  - LEAD-03

must_haves:
  truths:
    - "User can navigate to /leads from the navbar and see a dynamic table of leads"
    - "Lead list supports configurable columns, sorting, filtering, search, pagination, and saved Views"
    - "User can switch between table view and Kanban board view"
    - "Kanban board shows leads in stage columns with drag-and-drop to advance stages"
    - "Kanban cards display lead name, company, source, temperature badge, owner, and days in stage"
    - "Temperature badges are visually distinct: red=hot, orange=warm, blue=cold"
  artifacts:
    - path: "globcrm-web/src/app/features/leads/lead.models.ts"
      provides: "All TypeScript interfaces for lead DTOs, requests, and enums"
      contains: "LeadListDto"
    - path: "globcrm-web/src/app/features/leads/lead.service.ts"
      provides: "API service with methods for all lead endpoints"
      contains: "LeadService"
    - path: "globcrm-web/src/app/features/leads/lead.store.ts"
      provides: "Signal Store with lead list state, Kanban state, filters, pagination"
      contains: "LeadStore"
    - path: "globcrm-web/src/app/features/leads/leads.routes.ts"
      provides: "Feature routes for list, kanban, new, detail, edit"
      contains: "LEAD_ROUTES"
    - path: "globcrm-web/src/app/features/leads/lead-list/lead-list.component.ts"
      provides: "Dynamic table list page with DynamicTableComponent and FilterPanelComponent"
      contains: "LeadListComponent"
    - path: "globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.ts"
      provides: "Kanban board with CDK drag-drop following deal-kanban pattern"
      contains: "LeadKanbanComponent"
  key_links:
    - from: "globcrm-web/src/app/features/leads/lead.service.ts"
      to: "/api/leads"
      via: "ApiService HTTP calls"
      pattern: "api/leads"
    - from: "globcrm-web/src/app/features/leads/lead.store.ts"
      to: "lead.service.ts"
      via: "inject(LeadService)"
      pattern: "LeadService"
    - from: "globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.ts"
      to: "lead.service.ts"
      via: "CDK drag-drop onDrop calls updateStage"
      pattern: "CdkDragDrop"
    - from: "globcrm-web/src/app/app.routes.ts"
      to: "leads.routes.ts"
      via: "lazy-loaded loadChildren"
      pattern: "leads"
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      to: "/leads"
      via: "navGroups CRM section"
      pattern: "leads"
---

<objective>
Create the frontend foundation (models, service, store, routes) and the two primary list views: dynamic table and Kanban board. Users can navigate to /leads, see their leads in a configurable table or drag-and-drop Kanban view, and perform basic navigation.

Purpose: Delivers the primary lead browsing experience -- the dynamic table for data-focused users and the Kanban board for visual pipeline management.
Output: Lead feature scaffolding (models, service, store, routes), list component with DynamicTable, Kanban component with CDK drag-drop, app route + navbar registration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-leads/13-RESEARCH.md
@.planning/phases/13-leads/13-02-SUMMARY.md

@globcrm-web/src/app/features/deals/deal.models.ts
@globcrm-web/src/app/features/deals/deal.service.ts
@globcrm-web/src/app/features/deals/deal.store.ts
@globcrm-web/src/app/features/deals/deals.routes.ts
@globcrm-web/src/app/features/deals/deal-list/deal-list.component.ts
@globcrm-web/src/app/features/deals/deal-list/deal-list.component.html
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.html
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/shared/models/query.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead models, service, store, and routes with app-level registration</name>
  <files>
    globcrm-web/src/app/features/leads/lead.models.ts
    globcrm-web/src/app/features/leads/lead.service.ts
    globcrm-web/src/app/features/leads/lead.store.ts
    globcrm-web/src/app/features/leads/leads.routes.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
    **Create lead.models.ts** following deal.models.ts pattern:
    - LeadTemperature enum: 'hot' | 'warm' | 'cold'
    - LeadListDto interface: id, firstName, lastName, fullName, email, phone, companyName, stageName, stageColor, sourceName, temperature (LeadTemperature), ownerName, isConverted, createdAt, updatedAt
    - LeadDetailDto interface: extends list fields + mobilePhone, jobTitle, description, customFields, ownerId, leadStageId, leadSourceId, convertedAt, convertedByUserName, convertedContactId, convertedCompanyId, convertedDealId
    - LeadKanbanCardDto interface: id, fullName, companyName, email, sourceName, temperature, ownerName, ownerInitials, daysInStage, createdAt
    - LeadStageDto interface: id, name, sortOrder, color, isConverted, isLost, leadCount?
    - LeadSourceDto interface: id, name, sortOrder, isDefault, leadCount?
    - LeadTimelineEventDto interface: type, description, timestamp, userId?, userName?
    - CreateLeadRequest / UpdateLeadRequest interfaces
    - UpdateLeadStageRequest: { stageId: string }
    - ConvertLeadRequest interface (contact fields + company choice + deal choice per API design)
    - ConvertLeadResult interface: { contactId, companyId?, dealId? }
    - DuplicateCheckResult interface: { contactMatches: ContactMatchDto[], companyMatches: CompanyMatchDto[] }
    - KanbanResponse interface: { stages: LeadStageDto[], leads: LeadKanbanCardDto[] }

    **Create lead.service.ts** following deal.service.ts pattern:
    - @Injectable({ providedIn: 'root' })
    - Inject ApiService
    - Methods: getList(params), getById(id), create(req), update(id, req), delete(id), updateStage(id, stageId), reopenLead(id, stageId), getKanban(includeTerminal?), getTimeline(id), checkDuplicates(id), convert(id, req), getStages(), getSources(), createStage(req), updateStage(id, req), deleteStage(id), reorderStages(ids), createSource(req), updateSource(id, req), deleteSource(id)
    - Build HttpParams from EntityQueryParams for list endpoint (same pattern as deal.service.ts)

    **Create lead.store.ts** following deal.store.ts pattern:
    - signalStore with withState: items (LeadListDto[]), totalCount, isLoading, detail (LeadDetailDto | null), stages (LeadStageDto[]), sources (LeadSourceDto[]), kanbanStages (LeadStageDto[]), kanbanLeads (LeadKanbanCardDto[]), search, sort, sortDirection, filters, page, pageSize, viewMode ('table' | 'kanban')
    - withMethods: loadPage(), loadDetail(id), loadKanban(), clearDetail(), setSort(), setFilters(), setSearch(), setPage(), setViewMode(), loadStages(), loadSources()
    - Per-page store (providers: [LeadStore] on list component, NOT providedIn: 'root')

    **Create leads.routes.ts** following deals.routes.ts pattern:
    - LEAD_ROUTES: Routes[] with:
      - '' -> LeadListComponent
      - 'kanban' -> LeadKanbanComponent (lazy)
      - 'new' -> LeadFormComponent (lazy)
      - ':id' -> LeadDetailComponent (lazy)
      - ':id/edit' -> LeadFormComponent (lazy)

    **Update app.routes.ts:**
    - Add leads route BEFORE deals (CRM group order: Companies, Contacts, Leads, Products, Deals):
    ```
    {
      path: 'leads',
      canActivate: [authGuard, permissionGuard('Lead', 'View')],
      loadChildren: () => import('./features/leads/leads.routes').then(m => m.LEAD_ROUTES),
    }
    ```

    **Update navbar.component.ts:**
    - Add `{ route: '/leads', icon: 'person_search', label: 'Leads' }` to the CRM navGroup, placed between Contacts and Products (logical grouping: Leads feed into Contacts/Deals)
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead.models.ts, lead.service.ts, lead.store.ts, leads.routes.ts all exist. app.routes.ts has /leads route. navbar shows Leads link.
  </verify>
  <done>
    All TypeScript interfaces match the backend DTOs. LeadService has methods for all 20 API endpoints. LeadStore manages list, detail, kanban, and filter state. Routes lazy-load all lead components. /leads route is guarded with authGuard + permissionGuard('Lead', 'View'). Navbar CRM group includes Leads.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lead list component with dynamic table</name>
  <files>
    globcrm-web/src/app/features/leads/lead-list/lead-list.component.ts
    globcrm-web/src/app/features/leads/lead-list/lead-list.component.html
    globcrm-web/src/app/features/leads/lead-list/lead-list.component.scss
  </files>
  <action>
    Create LeadListComponent following the deal-list or contact-list component pattern exactly:
    - Standalone component with ChangeDetectionStrategy.OnPush
    - providers: [LeadStore] (per-page store instance)
    - Inject LeadStore, Router
    - Uses DynamicTableComponent for the table display
    - Uses FilterPanelComponent for filter sidebar
    - styleUrl references shared 'src/styles/_entity-list.scss' (same as all other entity list pages)

    **Page header:**
    - Title "Leads" with lead count
    - Search bar (wired to store.setSearch)
    - View toggle buttons: Table / Kanban (using mat-button-toggle-group). Table is default. Kanban navigates to /leads/kanban.
    - "New Lead" button (mat-raised-button, color primary) linking to /leads/new
    - Filter toggle button

    **Dynamic table columns:**
    - Default visible: FullName (link to detail), Email, CompanyName, Stage (colored chip matching stage color), Source, Temperature (colored badge: red=hot, orange=warm, blue=cold), Owner, CreatedAt
    - Available but hidden by default: Phone, MobilePhone, JobTitle, UpdatedAt, IsConverted
    - Temperature column renders as a small colored badge/chip with the temperature text
    - Stage column renders as a colored chip with the stage color background
    - FullName column is clickable (navigates to /leads/:id)
    - Row click navigates to /leads/:id

    **FilterPanel filters:**
    - Stage (multi-select dropdown from store.stages)
    - Source (multi-select dropdown from store.sources)
    - Temperature (multi-select: Hot, Warm, Cold)
    - Owner (multi-select from team members)
    - Created date range
    - IsConverted toggle

    **Pagination:**
    - mat-paginator at bottom (same as all entity list pages)
    - Default page size 25, options [10, 25, 50, 100]

    **Saved Views:**
    - Integrate with ViewsController (EntityType="Lead") for saving/loading column configs and filters
    - Follow exact same pattern as deal-list or contact-list

    **Empty state:**
    - When no leads: centered icon (person_search) + "No leads found" + "Create your first lead to get started" text + "New Lead" button

    **Loading state:**
    - MatProgressSpinner centered while isLoading
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead-list component files exist. Navigate to /leads shows the dynamic table. Table has correct columns. Filter panel works.
  </verify>
  <done>
    Lead list page shows leads in a dynamic table with configurable columns, sorting, filtering, search, pagination, and saved Views. Temperature and stage columns render as colored badges/chips. View toggle allows switching to Kanban. Empty and loading states handled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create lead Kanban board component</name>
  <files>
    globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.ts
    globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.html
    globcrm-web/src/app/features/leads/lead-kanban/lead-kanban.component.scss
  </files>
  <action>
    Create LeadKanbanComponent following deal-kanban.component.ts pattern exactly:
    - Standalone component with ChangeDetectionStrategy.OnPush
    - providers: [LeadStore] (separate store instance for kanban state)
    - Uses @angular/cdk/drag-drop: CdkDragDrop, CdkDropList, CdkDropListGroup, moveItemInArray, transferArrayItem
    - Inject LeadStore (or LeadService directly), Router, MatSnackBar

    **Layout:**
    - Page header: "Leads Pipeline" title, view toggle (Table / Kanban -- Kanban active), "New Lead" button, toggle to show/hide terminal stages (Lost, Converted)
    - Horizontal scrollable container with one column per stage
    - Each column: stage name header with colored top border (stage.color), lead count badge, cards below
    - Terminal stage columns (Lost, Converted) shown only when toggle is on, styled differently (muted/grayed)

    **Kanban cards (per user decision -- temperature badge visible at a glance):**
    - Lead full name (bold, clickable -- navigates to /leads/:id)
    - Company name (secondary text)
    - Source name (small text or chip)
    - Temperature badge: colored circle/chip -- red (#f44336) for Hot, orange (#ff9800) for Warm, blue (#2196f3) for Cold (per user decision)
    - Owner avatar/initials (small circle in corner)
    - Days in stage (small text at bottom, e.g., "3d" or "12d")

    **Drag-and-drop behavior (per user decision: forward-only):**
    - CDK drag-drop with CdkDropListGroup connecting all non-terminal stage columns
    - Terminal columns (Lost, Converted) are drop targets but NOT drag sources (leads in terminal stages cannot be dragged)
    - onDrop handler:
      a. If same container: reorder within stage (moveItemInArray)
      b. If different container: check if moving forward (target stage SortOrder > source stage SortOrder). If moving backward, show snackbar "Leads can only move forward. Use Reopen to move backward." and reject.
      c. If valid forward move: optimistic update (transferArrayItem), then API call leadService.updateStage(leadId, targetStageId). On error: rollback (transferArrayItem back) + snackbar error.
      d. If dropping on a terminal stage (Lost): call updateStage. If dropping on Converted stage: show snackbar "Use the Convert Lead action on the detail page" and reject.

    **Responsiveness:**
    - Columns have min-width ~280px, horizontal scroll on smaller screens
    - Cards are full-width within their column

    **Loading state:** Skeleton columns while loading
    **Empty columns:** "No leads in this stage" placeholder text
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead-kanban component files exist. Kanban shows stage columns with lead cards. Drag-and-drop advances stages forward only.
  </verify>
  <done>
    Kanban board displays leads in stage columns with colored headers. Cards show name, company, source, temperature badge (red/orange/blue), owner initials, and days in stage. CDK drag-and-drop enforces forward-only progression with optimistic updates and error rollback. Terminal stages visible via toggle. View toggle allows switching back to table.
  </done>
</task>

</tasks>

<verification>
- `cd globcrm-web && npm run build` compiles without errors
- /leads route accessible in browser with authGuard + permissionGuard
- Navbar CRM section shows "Leads" with person_search icon
- Lead list shows DynamicTableComponent with correct columns and temperature/stage badges
- Kanban board shows stage columns with lead cards and drag-and-drop
- View toggle switches between /leads (table) and /leads/kanban
- Filters work: stage, source, temperature, owner, date range
- Pagination works with mat-paginator
</verification>

<success_criteria>
- Lead list page is fully functional with dynamic table, configurable columns, sorting, filtering, search, pagination, and saved Views -- identical in capability to all other entity list pages
- Kanban board displays leads in stage columns with temperature badges, drag-and-drop stage advancement (forward-only), and optimistic updates
- Navigation from navbar to /leads works. View toggle between table and Kanban works.
- All components are standalone with OnPush change detection and signal-based patterns
</success_criteria>

<output>
After completion, create `.planning/phases/13-leads/13-03-SUMMARY.md`
</output>
