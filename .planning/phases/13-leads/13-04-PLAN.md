---
phase: 13-leads
plan: 04
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.html
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.scss
  - globcrm-web/src/app/features/leads/lead-form/lead-form.component.ts
  - globcrm-web/src/app/features/leads/lead-form/lead-form.component.html
  - globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.ts
  - globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.html
  - globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.scss
autonomous: true
requirements:
  - LEAD-01
  - LEAD-03
  - LEAD-04
  - LEAD-05
  - LEAD-06

must_haves:
  truths:
    - "User can view a lead detail page with horizontal stage stepper, contact info, temperature badge, and Convert Lead button"
    - "Stage stepper is interactive -- clicking a future stage advances the lead with confirmation"
    - "Convert Lead button opens a multi-section dialog with Contact (required), Company (optional toggle), and Deal (optional toggle)"
    - "Conversion dialog pre-fills from lead data and warns about duplicate contacts (email) and companies (name)"
    - "User can create and edit leads with all standard fields plus stage, source, and temperature selection"
    - "Lead detail page shows Activities, Notes, Attachments, Timeline, and Conversion tabs"
    - "Conversion tab only appears after lead has been converted, showing linked records"
    - "Converted leads are read-only with a Converted banner and no edit/stage-change actions"
  artifacts:
    - path: "globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts"
      provides: "Detail page with stage stepper, tabs, convert button, read-only mode for converted leads"
      contains: "LeadDetailComponent"
    - path: "globcrm-web/src/app/features/leads/lead-form/lead-form.component.ts"
      provides: "Create/edit form with all lead fields, stage, source, and temperature selectors"
      contains: "LeadFormComponent"
    - path: "globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.ts"
      provides: "Conversion dialog with multi-section form and duplicate detection"
      contains: "LeadConvertDialogComponent"
  key_links:
    - from: "lead-detail.component.ts"
      to: "lead.service.ts"
      via: "loadDetail, updateStage, getTimeline"
      pattern: "LeadService"
    - from: "lead-detail.component.ts"
      to: "lead-convert-dialog.component.ts"
      via: "MatDialog.open"
      pattern: "MatDialog"
    - from: "lead-convert-dialog.component.ts"
      to: "/api/leads/{id}/convert/check-duplicates"
      via: "LeadService.checkDuplicates"
      pattern: "checkDuplicates"
    - from: "lead-convert-dialog.component.ts"
      to: "/api/leads/{id}/convert"
      via: "LeadService.convert"
      pattern: "convert"
    - from: "lead-detail.component.ts"
      to: "RelatedEntityTabsComponent"
      via: "Standard entity tabs (Activities, Notes, Attachments, Timeline)"
      pattern: "RelatedEntityTabsComponent"
---

<objective>
Create the lead detail page (with interactive stage stepper, entity tabs, and conversion button), the create/edit form, and the lead-to-contact/company/deal conversion dialog with duplicate detection.

Purpose: Delivers the complete single-lead experience: viewing full details with pipeline progression, creating/editing leads, and the critical conversion workflow that transforms leads into contacts, companies, and deals.
Output: Lead detail component with stepper + tabs, lead form component, lead conversion dialog component.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-leads/13-RESEARCH.md
@.planning/phases/13-leads/13-02-SUMMARY.md

@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.html
@globcrm-web/src/app/features/deals/deal-form/deal-form.component.ts
@globcrm-web/src/app/features/deals/deal-form/deal-form.component.html
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts
@globcrm-web/src/app/features/leads/lead.models.ts
@globcrm-web/src/app/features/leads/lead.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead detail page with interactive stage stepper and entity tabs</name>
  <files>
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.html
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.scss
  </files>
  <action>
    Create LeadDetailComponent following deal-detail.component.ts pattern:
    - Standalone component, ChangeDetectionStrategy.OnPush
    - Route param `id` bound via input() (withComponentInputBinding)
    - Inject LeadService, Router, MatDialog, MatSnackBar, ActivatedRoute
    - Load lead detail on init via LeadService.getById(id)
    - Load stages via LeadService.getStages() for the stepper

    **Page header area (per user decision):**
    - Top bar: Lead FullName (h1) + Temperature badge (colored chip: red=Hot, orange=Warm, blue=Cold) + Source tag (small chip) + Owner name
    - Edit button (mat-icon-button, edit icon) -- navigates to /leads/:id/edit. HIDDEN if lead is converted or lost.
    - Delete button (mat-icon-button, delete icon) with confirmation dialog. HIDDEN if lead is converted.
    - "Convert Lead" button (mat-raised-button, primary/orange color) -- PROMINENT, right-aligned in header. Opens LeadConvertDialogComponent via MatDialog. HIDDEN if lead is in a terminal stage (IsConverted or stage.IsLost).
    - If lead IsConverted: show a "Converted" banner (green background) at the top with conversion date and links to created Contact/Company/Deal

    **Horizontal stage stepper (per user decision: custom stepper, NOT MatStepper):**
    - Full-width row of connected stage indicators below the header
    - Each stage: circle with number or checkmark + name label below
    - Current stage: highlighted (filled circle with stage color)
    - Past stages (SortOrder < current): checkmark, muted styling
    - Future stages (SortOrder > current): empty circle, clickable
    - Terminal stages (Converted, Lost): special icons -- checkmark for Converted (green), X for Lost (red)
    - Clicking a future non-terminal stage: show MatDialog confirmation "Move lead to {stageName}?" with OK/Cancel. On OK: call LeadService.updateStage(id, stageId), reload detail.
    - Clicking past stages: no action (forward-only per user decision)
    - If lead is converted/lost: stepper is non-interactive (display only)
    - "Reopen" button appears next to the stepper ONLY when lead is in a terminal stage. Opens a dialog asking which active stage to return to. Calls LeadService.reopenLead(id, stageId).

    **Entity tabs (using mat-tab-group, same pattern as deal-detail):**
    - Overview tab: Lead contact info card (email, phone, mobile, job title, company), description, custom fields display
    - Activities tab: RelatedEntityTabsComponent with EntityType="Lead", entityId=lead.id (reuses shared component)
    - Notes tab: Same shared pattern
    - Attachments tab: EntityAttachmentsComponent with EntityType="Lead"
    - Timeline tab: EntityTimelineComponent loading from LeadService.getTimeline(id)
    - Conversion tab: ONLY shown when lead.isConverted === true. Shows:
      - Conversion date and converted by user
      - Link to created Contact (clickable, navigates to /contacts/:id)
      - Link to created Company if exists (clickable, navigates to /companies/:id)
      - Link to created Deal if exists (clickable, navigates to /deals/:id)
      - Conversion notes if any

    **Read-only mode for converted leads (per discretion: mark as Converted + read-only):**
    - When lead.isConverted: hide Edit button, hide Delete button, hide Convert button, make stepper non-interactive
    - Show "This lead has been converted" banner with links to created records

    **Loading state:** MatProgressSpinner centered while loading
    **Error state:** MatSnackBar on API errors, navigate back to /leads on 404
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead-detail component files exist. Detail page shows stepper, header with temperature/source, tabs, and Convert button.
  </verify>
  <done>
    Lead detail page shows horizontal stage stepper with interactive forward-only progression and confirmation. Header displays lead name, temperature badge, source, and prominent Convert Lead button. Five entity tabs (Overview, Activities, Notes, Attachments, Timeline) plus Conversion tab (post-conversion only). Converted leads are read-only with conversion banner and links. Reopen action available for terminal-stage leads.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lead form component for create and edit</name>
  <files>
    globcrm-web/src/app/features/leads/lead-form/lead-form.component.ts
    globcrm-web/src/app/features/leads/lead-form/lead-form.component.html
  </files>
  <action>
    Create LeadFormComponent following deal-form.component.ts pattern:
    - Standalone component, ChangeDetectionStrategy.OnPush
    - Route param `id` bound via input() -- if present, edit mode; if absent, create mode
    - Inject LeadService, Router, MatSnackBar, FormBuilder
    - Reactive form with FormGroup and validators

    **Form fields (organized in logical sections):**

    Section 1 -- Contact Information:
    - FirstName (mat-form-field, required, maxLength 100)
    - LastName (mat-form-field, required, maxLength 100)
    - Email (mat-form-field, email validator if provided)
    - Phone (mat-form-field, maxLength 50)
    - MobilePhone (mat-form-field, maxLength 50)
    - JobTitle (mat-form-field)

    Section 2 -- Company:
    - CompanyName (mat-form-field, free text -- not a FK per entity design)

    Section 3 -- Lead Details:
    - LeadStageId (mat-select, required, populated from LeadService.getStages()). Default to first non-terminal stage ("New").
    - LeadSourceId (mat-select, optional, populated from LeadService.getSources()). Include empty "None" option.
    - Temperature (mat-button-toggle-group with Hot/Warm/Cold options, styled with temperature colors: red/orange/blue). Default to Warm.
    - OwnerId (mat-select, populated from team members. Default to current user.)
    - Description (mat-form-field, textarea, multi-line)

    Section 4 -- Custom Fields (per user decision LEAD-05):
    - Render dynamic custom field inputs based on CustomFieldDefinitions for EntityType="Lead"
    - Follow the same custom field rendering pattern used by contact-form and deal-form
    - Load field definitions from CustomFieldsController (GET /api/custom-fields?entityType=Lead)

    **Edit mode behavior:**
    - Load existing lead data on init: LeadService.getById(id)
    - Populate form with lead data including custom fields
    - If lead is converted: redirect to detail page (cannot edit converted leads)
    - Submit calls LeadService.update(id, request)

    **Create mode behavior:**
    - Empty form with defaults (Temperature=Warm, Stage=first stage, Owner=current user)
    - Submit calls LeadService.create(request)

    **Submit flow:**
    - Validate form
    - Set loading state
    - Call create/update API
    - On success: MatSnackBar "Lead created/updated", navigate to /leads/:id (detail page)
    - On error: MatSnackBar with error message, clear loading

    **Form layout:**
    - Two-column layout on desktop (responsive to single column on mobile)
    - Section headers with mat-divider
    - Submit button (mat-raised-button primary) + Cancel button (mat-button, navigates back)
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead-form component files exist. Form has all fields with validation. Create and edit modes work correctly.
  </verify>
  <done>
    Lead form supports both create and edit modes. All person, company, stage, source, temperature, owner, description, and custom fields are editable. Temperature uses colored button toggle (red/orange/blue). Stages and sources load from API. Custom fields render dynamically. Form validates required fields. Converted leads redirect to detail (cannot edit).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create lead conversion dialog with duplicate detection</name>
  <files>
    globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.ts
    globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.html
    globcrm-web/src/app/features/leads/lead-convert/lead-convert-dialog.component.scss
  </files>
  <action>
    Create LeadConvertDialogComponent as a MatDialog component:
    - Standalone component, ChangeDetectionStrategy.OnPush
    - Inject MAT_DIALOG_DATA (receives { lead: LeadDetailDto }), MatDialogRef, LeadService, FormBuilder, MatSnackBar, Router
    - On open: immediately call LeadService.checkDuplicates(lead.id) to fetch potential matches

    **Dialog layout (per user decision: multi-step or sectioned form):**
    Use a sectioned form within a single dialog (NOT MatStepper -- simpler UX for a dialog):

    **Section 1 -- Create Contact (always visible, required):**
    - Header: "Contact" with a person icon
    - Pre-filled from lead data: FirstName, LastName, Email, Phone, MobilePhone, JobTitle
    - All fields editable (user can review and modify per user decision)
    - **Duplicate warning:** If checkDuplicates returned contactMatches (email match), show a yellow warning box below the email field: "A contact with this email already exists: {ContactName} ({Email}). This will create a new contact regardless." The warning is informational -- conversion always creates a new contact (simple approach; full dedup merge is Phase 16).

    **Section 2 -- Company (optional toggle):**
    - mat-slide-toggle "Create or link a company" (default off)
    - When toggled on, show two options (mat-radio-group):
      a. "Link to existing company" -- mat-autocomplete searching existing companies by name
      b. "Create new company" -- show fields: CompanyName (pre-filled from lead.companyName), Website, Phone
    - **Duplicate warning:** If checkDuplicates returned companyMatches (name match), show warning: "Company '{Name}' already exists. You can link to the existing company instead of creating a new one." Pre-select "Link to existing" option with the matched company.
    - Pre-fill CompanyName from lead data if available

    **Section 3 -- Deal (optional toggle):**
    - mat-slide-toggle "Create a deal" (default off)
    - When toggled on, show fields:
      - DealTitle (pre-filled as "{Lead FullName} - New Deal")
      - DealValue (mat-form-field, number input, optional)
      - DealPipelineId (mat-select, loaded from PipelinesController GET /api/pipelines, default to first pipeline)
    - Deal will be created at the first stage of the selected pipeline

    **Footer:**
    - "Convert Lead" button (mat-raised-button, primary/orange) -- disabled while loading
    - "Cancel" button (mat-button)
    - Loading spinner when conversion is in progress

    **Conversion flow on submit:**
    1. Validate: FirstName and LastName required. If CreateCompany + "Create new": NewCompanyName required. If CreateDeal: DealTitle required.
    2. Build ConvertLeadRequest from form values
    3. Call LeadService.convert(lead.id, request)
    4. On success:
       a. Close dialog with result (ConvertLeadResult)
       b. MatSnackBar "Lead converted successfully"
       c. Reload lead detail (parent component handles this on dialog close with result)
       d. Optionally navigate to created contact: Router.navigate(['/contacts', result.contactId])
    5. On error: MatSnackBar with error message, keep dialog open

    **Parent integration (lead-detail.component.ts):**
    - Convert button opens dialog: `this.dialog.open(LeadConvertDialogComponent, { data: { lead: this.lead }, width: '700px', disableClose: true })`
    - On dialog close with result: reload lead detail (now shows as Converted with Conversion tab)
  </action>
  <verify>
    `cd globcrm-web && npm run build` compiles. lead-convert-dialog component files exist. Dialog has three sections. Duplicate warnings display when matches found.
  </verify>
  <done>
    Conversion dialog opens with lead data pre-filled in Contact section. Company section toggleable with link-existing/create-new options and duplicate warning. Deal section toggleable with pipeline selection. Duplicate check runs on dialog open and shows warnings for email/company matches. Conversion submits atomically and reloads detail page showing Converted state with Conversion tab.
  </done>
</task>

</tasks>

<verification>
- `cd globcrm-web && npm run build` compiles without errors
- Lead detail page shows horizontal stage stepper with current stage highlighted
- Clicking future stage in stepper shows confirmation and advances lead
- Convert Lead button opens conversion dialog pre-filled from lead data
- Conversion dialog shows duplicate warnings when matches exist
- Created lead form has all fields with proper validation
- Edit form loads existing lead data
- Converted leads show read-only state with Conversion tab and links to created records
- Custom fields render on form and detail page
- Timeline tab shows lead history
</verification>

<success_criteria>
- Lead detail page fully functional with interactive stepper, 6 tabs (Overview + Activities + Notes + Attachments + Timeline + Conversion), temperature badge, source tag, and Convert button
- Stage stepper enforces forward-only with visual feedback and confirmation dialogs
- Lead form works for both create and edit with all fields, validation, custom fields, and temperature/stage/source selectors
- Conversion dialog pre-fills from lead, handles duplicate warnings, creates contact + optional company/deal, and transitions to converted state
- Converted leads are read-only with conversion details visible
</success_criteria>

<output>
After completion, create `.planning/phases/13-leads/13-04-SUMMARY.md`
</output>
