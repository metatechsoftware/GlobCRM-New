---
phase: 08-real-time-and-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Notification.cs
  - src/GlobCRM.Domain/Entities/NotificationPreference.cs
  - src/GlobCRM.Domain/Entities/FeedItem.cs
  - src/GlobCRM.Domain/Entities/FeedComment.cs
  - src/GlobCRM.Domain/Enums/NotificationType.cs
  - src/GlobCRM.Domain/Enums/NotificationChannel.cs
  - src/GlobCRM.Domain/Enums/FeedItemType.cs
  - src/GlobCRM.Domain/Interfaces/INotificationRepository.cs
  - src/GlobCRM.Domain/Interfaces/IFeedRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/NotificationConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/NotificationPreferenceConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/FeedItemConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/FeedCommentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Notification, NotificationPreference, FeedItem, FeedComment entities exist with correct properties"
    - "NotificationType, NotificationChannel, FeedItemType enums define all required values"
    - "EF Core configurations use snake_case naming and proper FK constraints"
    - "Database migration creates all four tables with correct columns and indexes"
    - "Global query filters isolate Notification, NotificationPreference, FeedItem by TenantId"
    - "RLS policies exist for all tenant-scoped tables"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Notification.cs"
      provides: "In-app notification entity"
      contains: "class Notification"
    - path: "src/GlobCRM.Domain/Entities/FeedItem.cs"
      provides: "Activity feed entry (system event or social post)"
      contains: "class FeedItem"
    - path: "src/GlobCRM.Domain/Enums/NotificationType.cs"
      provides: "Notification type enum"
      contains: "ActivityAssigned"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "src/GlobCRM.Domain/Entities/Notification.cs"
      via: "DbSet<Notification>"
      pattern: "DbSet<Notification>"
---

<objective>
Create domain entities, enums, EF Core configurations, migration, and RLS policies for the notification and feed subsystems.

Purpose: Establish the data model foundation that all notification and feed features will build upon.
Output: Four new domain entities, three enums, four EF Core configurations, a database migration, and updated RLS policies.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-and-notifications/08-RESEARCH.md
@src/GlobCRM.Domain/Entities/Activity.cs (entity pattern reference)
@src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityConfiguration.cs (config pattern reference)
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs (DbSet + query filter pattern)
@scripts/rls-setup.sql (RLS pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities and enums for notifications and feed</name>
  <files>
    src/GlobCRM.Domain/Entities/Notification.cs
    src/GlobCRM.Domain/Entities/NotificationPreference.cs
    src/GlobCRM.Domain/Entities/FeedItem.cs
    src/GlobCRM.Domain/Entities/FeedComment.cs
    src/GlobCRM.Domain/Enums/NotificationType.cs
    src/GlobCRM.Domain/Enums/NotificationChannel.cs
    src/GlobCRM.Domain/Enums/FeedItemType.cs
    src/GlobCRM.Domain/Interfaces/INotificationRepository.cs
    src/GlobCRM.Domain/Interfaces/IFeedRepository.cs
  </files>
  <action>
    Create three enums:

    **NotificationType.cs**: ActivityAssigned, DealStageChanged, Mention, DueDateApproaching, EmailReceived

    **NotificationChannel.cs**: InApp, Email

    **FeedItemType.cs**: SystemEvent, SocialPost

    Create four entities following the Activity.cs pattern (TenantId, audit timestamps, Guid Id with NewGuid):

    **Notification.cs**:
    - Id (Guid), TenantId (Guid), UserId (Guid, FK to ApplicationUser with SetNull)
    - Type (NotificationType enum), Title (string), Message (string)
    - EntityType (string?, nullable -- e.g. "Deal", "Activity"), EntityId (Guid?, nullable -- link to source entity)
    - IsRead (bool, default false), ReadAt (DateTimeOffset?, nullable)
    - CreatedAt (DateTimeOffset), CreatedById (Guid?, FK to ApplicationUser with SetNull -- who triggered it)
    - Navigation: User (ApplicationUser), CreatedBy (ApplicationUser)

    **NotificationPreference.cs**:
    - Id (Guid), TenantId (Guid), UserId (Guid, FK to ApplicationUser with Cascade)
    - NotificationType (NotificationType enum)
    - InAppEnabled (bool, default true), EmailEnabled (bool, default true)
    - Navigation: User (ApplicationUser)
    - Unique constraint on (TenantId, UserId, NotificationType)

    **FeedItem.cs**:
    - Id (Guid), TenantId (Guid)
    - Type (FeedItemType enum)
    - Content (string -- text content for social posts, description for system events)
    - EntityType (string?, nullable), EntityId (Guid?, nullable) -- for system events linking to source entity
    - AuthorId (Guid?, FK to ApplicationUser with SetNull)
    - CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: Author (ApplicationUser), Comments (ICollection of FeedComment)

    **FeedComment.cs** (child entity, no TenantId -- inherits via FeedItem FK):
    - Id (Guid), FeedItemId (Guid, FK to FeedItem with Cascade)
    - Content (string), AuthorId (Guid?, FK to ApplicationUser with SetNull)
    - CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
    - Navigation: FeedItem, Author (ApplicationUser)

    Create two repository interfaces:

    **INotificationRepository.cs**:
    - GetPagedAsync(Guid userId, int page, int pageSize) -> Task of PagedResult of Notification
    - GetUnreadCountAsync(Guid userId) -> Task of int
    - MarkAsReadAsync(Guid notificationId) -> Task
    - MarkAllAsReadAsync(Guid userId) -> Task
    - CreateAsync(Notification notification) -> Task
    - GetPreferencesAsync(Guid userId) -> Task of List of NotificationPreference
    - UpdatePreferenceAsync(NotificationPreference preference) -> Task

    **IFeedRepository.cs**:
    - GetFeedAsync(Guid userId, int page, int pageSize) -> Task of PagedResult of FeedItem
    - CreateFeedItemAsync(FeedItem item) -> Task
    - GetByIdAsync(Guid id) -> Task of FeedItem?
    - AddCommentAsync(FeedComment comment) -> Task
    - GetCommentsAsync(Guid feedItemId) -> Task of List of FeedComment
  </action>
  <verify>All files compile: `dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj`</verify>
  <done>All 9 files exist with correct properties, enum values, and repository interfaces</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, DbContext update, migration, and RLS</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/NotificationConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/NotificationPreferenceConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/FeedItemConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/FeedCommentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create four EF Core configurations following existing patterns (snake_case table names, Guid PKs):

    **NotificationConfiguration.cs**: Table "notifications", snake_case columns. Composite index on (tenant_id, user_id, is_read) for unread queries. Index on (tenant_id, created_at DESC) for paged listing. FK to ApplicationUser for UserId (SetNull on delete). FK to ApplicationUser for CreatedById (SetNull on delete). Map NotificationType enum to string column.

    **NotificationPreferenceConfiguration.cs**: Table "notification_preferences", snake_case columns. Unique index on (tenant_id, user_id, notification_type). FK to ApplicationUser for UserId (Cascade on delete). Map enums to string columns.

    **FeedItemConfiguration.cs**: Table "feed_items", snake_case columns. Index on (tenant_id, created_at DESC) for paged feed. Index on (entity_type, entity_id) for entity-scoped feed. FK to ApplicationUser for AuthorId (SetNull on delete). Map FeedItemType enum to string column.

    **FeedCommentConfiguration.cs**: Table "feed_comments", snake_case columns. FK to FeedItem for FeedItemId (Cascade on delete). FK to ApplicationUser for AuthorId (SetNull on delete). Index on (feed_item_id, created_at) for comment listing.

    **Update ApplicationDbContext.cs**:
    - Add 4 DbSets: Notifications, NotificationPreferences, FeedItems, FeedComments
    - Apply all 4 configurations in OnModelCreating
    - Add global query filters for Notification, NotificationPreference, and FeedItem (tenant-scoped, same pattern as existing)
    - FeedComment does NOT need query filter (filtered via FeedItem FK)

    **Run migration**: `dotnet ef migrations add AddNotificationsAndFeed --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api`

    **Update scripts/rls-setup.sql**: Add RLS policies for notifications, notification_preferences, and feed_items tables (same pattern as existing tables). feed_comments inherits isolation via feed_items FK.
  </action>
  <verify>`dotnet ef database update --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api` succeeds and tables are created. Verify with: `dotnet build src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj`</verify>
  <done>All four tables created in PostgreSQL with correct columns, indexes, FK constraints, query filters, and RLS policies</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds for both Domain and Infrastructure projects
- Migration applies cleanly to database
- All four new tables visible in database with correct column names (snake_case)
- Indexes exist on notification and feed tables for query performance
</verification>

<success_criteria>
- 4 domain entities with correct properties and relationships
- 3 enums with all required values
- 2 repository interfaces with full CRUD signatures
- 4 EF Core configurations with snake_case naming
- ApplicationDbContext has 4 new DbSets with query filters
- Migration creates tables successfully
- RLS policies added for tenant-scoped tables
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-01-SUMMARY.md`
</output>
