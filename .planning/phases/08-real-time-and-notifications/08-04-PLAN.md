---
phase: 08-real-time-and-notifications
plan: 04
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/GlobCRM.Api/Controllers/DealsController.cs
  - src/GlobCRM.Api/Controllers/ActivitiesController.cs
  - src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs
autonomous: true

must_haves:
  truths:
    - "Deal stage change dispatches DealStageChanged notification to deal owner"
    - "Activity assignment dispatches ActivityAssigned notification to assignee"
    - "Email received creates EmailReceived notification for account owner"
    - "All CRM mutations create SystemEvent feed items for activity stream"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/DealsController.cs"
      provides: "Deal stage change notification dispatch"
      contains: "NotificationDispatcher"
    - path: "src/GlobCRM.Api/Controllers/ActivitiesController.cs"
      provides: "Activity assignment notification dispatch"
      contains: "NotificationDispatcher"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/DealsController.cs"
      to: "NotificationDispatcher"
      via: "constructor injection"
      pattern: "_dispatcher.DispatchAsync"
    - from: "src/GlobCRM.Api/Controllers/ActivitiesController.cs"
      to: "NotificationDispatcher"
      via: "constructor injection"
      pattern: "_dispatcher.DispatchAsync"
---

<objective>
Integrate NotificationDispatcher into existing controllers to fire notifications on CRM events (NOTF-06) and create system event feed items (FEED-01).

Purpose: Wire up the notification system to actual CRM events so users receive real-time notifications for meaningful actions.
Output: Modified DealsController, ActivitiesController, and EmailsController with notification dispatch calls.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-and-notifications/08-RESEARCH.md
@.planning/phases/08-real-time-and-notifications/08-02-SUMMARY.md
@src/GlobCRM.Api/Controllers/DealsController.cs
@src/GlobCRM.Api/Controllers/ActivitiesController.cs
@src/GlobCRM.Api/Controllers/EmailsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire NotificationDispatcher into DealsController and ActivitiesController</name>
  <files>
    src/GlobCRM.Api/Controllers/DealsController.cs
    src/GlobCRM.Api/Controllers/ActivitiesController.cs
  </files>
  <action>
    **DealsController.cs modifications**:
    - Add NotificationDispatcher and IFeedRepository to constructor injection.
    - After successful deal stage change (the existing PATCH stage endpoint): dispatch DealStageChanged notification to deal.OwnerId with message "Deal '{deal.Name}' moved to {newStage.Name}". EntityType="Deal", EntityId=deal.Id. CreatedById = current user.
    - After successful deal creation: create FeedItem of type SystemEvent with content "Deal '{deal.Name}' was created", EntityType="Deal", EntityId=deal.Id.
    - After deal stage change: also create SystemEvent FeedItem with content "Deal '{deal.Name}' moved to {newStage.Name}".
    - Send "FeedUpdate" to tenant group via dispatcher after feed item creation.
    - IMPORTANT: Do NOT change the existing endpoint signatures, return types, or auth attributes. Only ADD notification dispatch calls after existing success logic.

    **ActivitiesController.cs modifications**:
    - Add NotificationDispatcher and IFeedRepository to constructor injection.
    - After successful activity creation (if AssignedToId is set and differs from current user): dispatch ActivityAssigned notification to AssignedToId with message "You were assigned to '{activity.Subject}'". EntityType="Activity", EntityId=activity.Id.
    - After successful activity update (if AssignedToId changed to a new user): dispatch ActivityAssigned notification to new AssignedToId.
    - After activity status change: create SystemEvent FeedItem with content "Activity '{subject}' status changed to {newStatus}".
    - After activity creation: create SystemEvent FeedItem "Activity '{subject}' was created".
    - After new activity comment: detect @mentions in comment content via regex `@(\w+)`, look up matching users in the tenant, dispatch Mention notifications to each matched user.
    - Send "FeedUpdate" to tenant group after feed item creation.
    - IMPORTANT: Wrap all dispatch calls in try/catch -- notification failures should NOT cause the primary operation to fail. Log errors.
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` succeeds. Existing deal and activity endpoints still return correct responses (no regression).</verify>
  <done>Deal stage changes dispatch DealStageChanged notifications and create feed events. Activity assignments dispatch ActivityAssigned notifications. Activity comments detect @mentions. All CRM mutations create SystemEvent feed items.</done>
</task>

<task type="auto">
  <name>Task 2: Wire NotificationDispatcher into EmailsController for email received events</name>
  <files>
    src/GlobCRM.Api/Controllers/EmailsController.cs
  </files>
  <action>
    **EmailsController.cs modifications**:
    - Add NotificationDispatcher to constructor injection.
    - The email sync creates new emails in the background service, not via the controller. So for EmailReceived notifications, we need to modify the EmailSyncBackgroundService or the GmailSyncService instead.
    - ALTERNATIVELY: If the EmailsController has any endpoint that handles incoming email processing or webhook, add dispatch there.
    - PRAGMATIC APPROACH: Since email sync happens in GmailSyncService (called by EmailSyncBackgroundService), modify GmailSyncService to accept NotificationDispatcher as a constructor dependency. After successfully syncing a new inbound email, dispatch an EmailReceived notification to the email account owner with message "New email from {senderName}: {subject}". EntityType="Email", EntityId=emailMessage.Id.
    - Check if GmailSyncService is in src/GlobCRM.Infrastructure/Gmail/GmailSyncService.cs. If so, add NotificationDispatcher injection there.
    - Also create a SystemEvent FeedItem for "New email received from {senderName}" for each new inbound email.
    - IMPORTANT: Only notify for new inbound emails (not sent emails). Only dispatch if the email was not already synced (new emails in the sync batch).
    - Wrap in try/catch -- sync must not fail due to notification errors.
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` succeeds. Email sync still works without errors.</verify>
  <done>New inbound emails trigger EmailReceived notifications to account owner and create feed events</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds
- Existing deal, activity, and email endpoints return same responses as before
- No regressions in existing functionality
- Notification dispatch calls wrapped in try/catch (won't break primary operations)
</verification>

<success_criteria>
- Deal stage changes -> DealStageChanged notification to owner + SystemEvent feed item
- Activity assignment -> ActivityAssigned notification to assignee + SystemEvent feed item
- Activity comment @mentions -> Mention notification to mentioned users
- New inbound email -> EmailReceived notification to account owner + SystemEvent feed item
- All dispatch calls are non-blocking (try/catch wrapped)
- No changes to existing endpoint contracts or auth
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-04-SUMMARY.md`
</output>
