---
phase: 08-real-time-and-notifications
plan: 05
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - globcrm-web/package.json
  - globcrm-web/src/app/core/signalr/signalr.service.ts
  - globcrm-web/src/app/features/notifications/notification.models.ts
  - globcrm-web/src/app/features/notifications/notification.service.ts
  - globcrm-web/src/app/features/notifications/notification.store.ts
  - globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/app.component.ts
autonomous: true

must_haves:
  truths:
    - "SignalR connection starts after login and stops on logout"
    - "User sees bell icon in navbar with unread notification count badge"
    - "Clicking bell opens notification center panel showing recent notifications"
    - "User can mark notifications as read/unread from the panel"
    - "New notifications appear in real-time without page refresh"
    - "NotificationStore is root-provided and persists across navigation"
  artifacts:
    - path: "globcrm-web/src/app/core/signalr/signalr.service.ts"
      provides: "SignalR connection wrapper"
      contains: "SignalRService"
    - path: "globcrm-web/src/app/features/notifications/notification.store.ts"
      provides: "Root-provided notification state management"
      contains: "NotificationStore"
    - path: "globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts"
      provides: "Bell icon dropdown notification panel"
      contains: "NotificationCenterComponent"
  key_links:
    - from: "globcrm-web/src/app/core/signalr/signalr.service.ts"
      to: "environment.apiUrl"
      via: "HubConnectionBuilder.withUrl"
      pattern: "withUrl.*hubs/crm"
    - from: "globcrm-web/src/app/features/notifications/notification.store.ts"
      to: "globcrm-web/src/app/core/signalr/signalr.service.ts"
      via: "subscription to notification$"
      pattern: "signalRService.notification\\$"
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      to: "notification-center.component.ts"
      via: "template reference"
      pattern: "app-notification-center"
---

<objective>
Install @microsoft/signalr, create SignalRService singleton, build notification feature (models, API service, store, notification center component), and integrate into navbar with bell icon badge.

Purpose: Deliver the core real-time notification experience -- bell icon with unread count and dropdown panel.
Output: SignalR client service, notification store, notification center component embedded in navbar.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-and-notifications/08-RESEARCH.md
@.planning/phases/08-real-time-and-notifications/08-02-SUMMARY.md
@.planning/phases/08-real-time-and-notifications/08-03-SUMMARY.md
@globcrm-web/src/app/core/auth/auth.store.ts (auth state for SignalR lifecycle)
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts (integrate bell icon)
@globcrm-web/src/app/app.component.ts (SignalR lifecycle integration)
@globcrm-web/src/app/core/api/api.service.ts (API service pattern)
@globcrm-web/src/app/features/emails/email.store.ts (store pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SignalR client and create SignalRService + notification models/service</name>
  <files>
    globcrm-web/package.json
    globcrm-web/src/app/core/signalr/signalr.service.ts
    globcrm-web/src/app/features/notifications/notification.models.ts
    globcrm-web/src/app/features/notifications/notification.service.ts
  </files>
  <action>
    **Install**: Run `cd globcrm-web && npm install @microsoft/signalr@10.0.0`

    **SignalRService** (providedIn: 'root'):
    - Import `* as signalR` from '@microsoft/signalr'
    - Inject AuthStore
    - Signals: connectionState ('disconnected' | 'connecting' | 'connected')
    - Private subjects: notificationSubject (Subject<NotificationDto>), feedUpdateSubject (Subject<FeedItemDto>), feedCommentSubject (Subject<FeedCommentDto>)
    - Public observables: notification$, feedUpdate$, feedComment$
    - start() method: build HubConnection with `withUrl(environment.apiUrl + '/hubs/crm', { accessTokenFactory: () => this.authStore.accessToken() ?? '' })`, `withAutomaticReconnect([0, 2000, 10000, 30000])`, `configureLogging(signalR.LogLevel.Warning)`. Register handlers: 'ReceiveNotification' -> notificationSubject.next(), 'FeedUpdate' -> feedUpdateSubject.next(), 'FeedCommentAdded' -> feedCommentSubject.next(). Set reconnecting/reconnected/close handlers updating connectionState. Start connection.
    - stop() method: stop connection, set state to disconnected, null out connection
    - IMPORTANT: Do NOT import environment directly in the service. Import from the environment file used by the project (check existing services like ApiService for the pattern).

    **notification.models.ts**:
    - NotificationDto: id, type (string), title, message, entityType, entityId, isRead, createdAt, createdByName
    - NotificationPreferenceDto: notificationType (string), inAppEnabled, emailEnabled
    - NotificationType enum (string): ActivityAssigned, DealStageChanged, Mention, DueDateApproaching, EmailReceived

    **notification.service.ts**: Inject ApiService.
    - getNotifications(page, pageSize) -> GET /api/notifications
    - getUnreadCount() -> GET /api/notifications/unread-count
    - markAsRead(id) -> PATCH /api/notifications/{id}/read
    - markAsUnread(id) -> PATCH /api/notifications/{id}/unread
    - markAllAsRead() -> POST /api/notifications/mark-all-read
    - getPreferences() -> GET /api/notifications/preferences
    - updatePreferences(prefs) -> PUT /api/notifications/preferences
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles without errors. Verify @microsoft/signalr in node_modules.</verify>
  <done>@microsoft/signalr installed, SignalRService manages WebSocket lifecycle with auto-reconnect, notification models and API service ready</done>
</task>

<task type="auto">
  <name>Task 2: NotificationStore, NotificationCenter component, navbar integration</name>
  <files>
    globcrm-web/src/app/features/notifications/notification.store.ts
    globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/app.component.ts
  </files>
  <action>
    **NotificationStore** (providedIn: 'root' -- CRITICAL: must be root, NOT component-provided):
    - Uses signalStore with withState, withComputed, withMethods
    - State: notifications (NotificationDto[]), unreadCount (number), isLoading (boolean), isOpen (boolean)
    - Computed: hasUnread (unreadCount > 0)
    - Methods:
      - loadNotifications(): calls NotificationService.getNotifications, patches state
      - loadUnreadCount(): calls NotificationService.getUnreadCount, patches state
      - markAsRead(id): calls service, updates notification in array, decrements unreadCount
      - markAllAsRead(): calls service, updates all notifications, sets unreadCount to 0
      - addNotification(dto): prepends to notifications array, increments unreadCount (for real-time push)
      - togglePanel(): toggles isOpen
    - On initialization: load unread count. Subscribe to SignalRService.notification$ to call addNotification.

    **NotificationCenterComponent** (inline template/styles):
    - Inject NotificationStore
    - Template: mat-icon-button with mat-icon "notifications" and mat-badge showing unreadCount (hidden when 0). Click toggles panel.
    - Panel: absolutely positioned dropdown (or mat-menu) showing list of recent notifications. Each item shows: icon based on type, title, message truncated, time ago. Unread items have distinct background. Click on item marks as read and navigates to entity (if entityType/entityId exist, use Router.navigate). "Mark all as read" link at top of panel.
    - Use @if for conditional panel display. Use relative time display (e.g., "5m ago", "2h ago") -- implement a simple pipe or function.
    - Style: fixed-width panel (360px), max-height 400px with overflow-y scroll, positioned below bell icon.

    **NavbarComponent modifications**:
    - Import NotificationCenterComponent
    - Add `<app-notification-center />` in the navbar template, positioned before the user menu (right side of navbar, between main nav links and user avatar menu).

    **AppComponent modifications**:
    - Inject SignalRService
    - Use effect() watching authStore.isAuthenticated():
      - When becomes true: call signalRService.start()
      - When becomes false: call signalRService.stop()
    - This ensures SignalR connects after login and disconnects on logout.
    - Also inject NotificationStore and call loadUnreadCount() when authenticated (ensure initial badge count).
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles. Run app, login, verify bell icon appears in navbar.</verify>
  <done>Bell icon with unread badge in navbar, dropdown notification panel with mark read/unread, real-time notification push via SignalR, connection lifecycle tied to auth state</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- Bell icon visible in navbar after login
- Unread count badge shows correct number
- Clicking bell opens notification panel
- SignalR connection established (check browser DevTools Network tab for WebSocket)
</verification>

<success_criteria>
- @microsoft/signalr@10.0.0 installed
- SignalRService connects on login, disconnects on logout, auto-reconnects
- NotificationStore is root-provided, maintains unread count across navigation
- Bell icon in navbar shows unread badge
- Notification panel lists recent notifications with mark read/unread
- Real-time notifications appear without page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-05-SUMMARY.md`
</output>
