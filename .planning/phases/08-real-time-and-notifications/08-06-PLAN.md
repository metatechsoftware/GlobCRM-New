---
phase: 08-real-time-and-notifications
plan: 06
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - globcrm-web/src/app/features/feed/feed.models.ts
  - globcrm-web/src/app/features/feed/feed.service.ts
  - globcrm-web/src/app/features/feed/feed.store.ts
  - globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
  - globcrm-web/src/app/features/feed/feed-post-form/feed-post-form.component.ts
  - globcrm-web/src/app/features/feed/feed.routes.ts
autonomous: true

must_haves:
  truths:
    - "User can view activity stream showing system events and social posts in chronological order"
    - "User can create social posts visible to team"
    - "User can comment on feed items"
    - "Feed updates in real-time when new posts or system events arrive"
  artifacts:
    - path: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      provides: "Feed list page combining activity stream and social posts"
      contains: "FeedListComponent"
    - path: "globcrm-web/src/app/features/feed/feed-post-form/feed-post-form.component.ts"
      provides: "Social post creation form"
      contains: "FeedPostFormComponent"
    - path: "globcrm-web/src/app/features/feed/feed.store.ts"
      provides: "Feed state management"
      contains: "FeedStore"
  key_links:
    - from: "globcrm-web/src/app/features/feed/feed.store.ts"
      to: "globcrm-web/src/app/core/signalr/signalr.service.ts"
      via: "subscription to feedUpdate$"
      pattern: "signalRService.feedUpdate\\$"
    - from: "globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts"
      to: "globcrm-web/src/app/features/feed/feed.store.ts"
      via: "component-provided store"
      pattern: "FeedStore"
---

<objective>
Build the activity feed feature with feed list page, social post creation, comment functionality, and real-time updates via SignalR.

Purpose: Deliver the news feed combining system activity stream with social posting for team collaboration (FEED-01 through FEED-05).
Output: Feed models, API service, signal store, feed list component, and post form component.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-and-notifications/08-RESEARCH.md
@.planning/phases/08-real-time-and-notifications/08-03-SUMMARY.md
@globcrm-web/src/app/core/api/api.service.ts (API pattern)
@globcrm-web/src/app/features/emails/email.store.ts (store pattern)
@globcrm-web/src/app/features/emails/email-list/email-list.component.ts (list component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Feed models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/feed/feed.models.ts
    globcrm-web/src/app/features/feed/feed.service.ts
    globcrm-web/src/app/features/feed/feed.store.ts
  </files>
  <action>
    **feed.models.ts**:
    - FeedItemDto: id, type ('SystemEvent' | 'SocialPost'), content, entityType, entityId, authorId, authorName, authorAvatarUrl, createdAt, commentCount
    - FeedCommentDto: id, content, authorId, authorName, authorAvatarUrl, createdAt
    - CreateFeedPostRequest: { content: string }
    - CreateCommentRequest: { content: string }
    - FeedItemType enum (string): SystemEvent = 'SystemEvent', SocialPost = 'SocialPost'

    **feed.service.ts** (providedIn: 'root'):
    - Inject ApiService
    - getFeed(page, pageSize): GET /api/feed?page={page}&pageSize={pageSize}
    - createPost(request: CreateFeedPostRequest): POST /api/feed
    - getFeedItem(id): GET /api/feed/{id}
    - addComment(feedItemId, request: CreateCommentRequest): POST /api/feed/{feedItemId}/comments
    - deleteFeedItem(id): DELETE /api/feed/{id}

    **feed.store.ts** (component-provided, NOT root -- each feed page gets its own instance):
    - signalStore with withState: items (FeedItemDto[]), selectedItem (FeedItemDto | null), comments (FeedCommentDto[]), isLoading, total, page, pageSize (default 20)
    - withComputed: none needed initially
    - withMethods:
      - loadFeed(): calls FeedService.getFeed, sets items and total
      - loadMore(): increments page, appends results to existing items
      - createPost(content): calls FeedService.createPost, prepends result to items
      - loadFeedItem(id): calls FeedService.getFeedItem, sets selectedItem and comments
      - addComment(feedItemId, content): calls FeedService.addComment, appends to comments, increments commentCount on the parent item
      - deleteFeedItem(id): calls FeedService.deleteFeedItem, removes from items
      - prependItem(item: FeedItemDto): adds to top of items list (for real-time updates)
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles.</verify>
  <done>Feed models, API service, and component-provided signal store ready for UI components</done>
</task>

<task type="auto">
  <name>Task 2: Feed list component, post form, and routes</name>
  <files>
    globcrm-web/src/app/features/feed/feed-list/feed-list.component.ts
    globcrm-web/src/app/features/feed/feed-post-form/feed-post-form.component.ts
    globcrm-web/src/app/features/feed/feed.routes.ts
  </files>
  <action>
    **FeedPostFormComponent** (inline template/styles):
    - Simple form with a mat-form-field textarea and a "Post" mat-raised-button.
    - Input: none. Output: EventEmitter<string> (postCreated).
    - On submit: emit content text, clear textarea.
    - Style: card-like container, avatar of current user on left, textarea on right, button below right-aligned.
    - Inject AuthStore for current user avatar initials display.

    **FeedListComponent** (inline template/styles):
    - Provides FeedStore at component level: `providers: [FeedStore]`
    - Inject FeedStore, SignalRService, Router
    - On init: call store.loadFeed(). Subscribe to signalRService.feedUpdate$ to call store.prependItem() for real-time. Subscribe to signalRService.feedComment$ for real-time comment count updates.
    - Template layout:
      - Page title "Feed" with mat-icon "dynamic_feed"
      - FeedPostFormComponent at the top (for creating social posts). On postCreated, call store.createPost(content).
      - Feed items list below. Each item is a mat-card showing:
        - Author avatar (initials circle with color, matching existing avatar pattern) + author name + relative time
        - Type indicator: mat-icon "auto_awesome" for SystemEvent (muted color), mat-icon "chat" for SocialPost
        - Content text
        - If entityType exists: clickable "View {entityType}" link that navigates to /{entityType.toLowerCase()}s/{entityId}
        - Comment count with mat-icon "comment". Click expands inline comment section.
        - Inline comment section (toggled): shows existing comments fetched on expand via store.loadFeedItem(id). Each comment: avatar + name + content + time. Add comment input at bottom.
      - "Load more" button at bottom (shown when items.length < total). Calls store.loadMore().
    - Style: max-width 680px centered, vertical card list with 12px gap.

    **feed.routes.ts**:
    - Default route '' loads FeedListComponent
    - Export as FEED_ROUTES

    On destroy: unsubscribe from SignalR subscriptions (use takeUntilDestroyed or manual unsubscribe).
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles.</verify>
  <done>Feed list page shows chronological mix of system events and social posts, users can create posts and comment on items, real-time updates via SignalR subscription</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- Feed feature has models, service, store, list component, post form, and routes
- FeedStore is component-provided (not root)
- Real-time subscription set up for feed updates
</verification>

<success_criteria>
- Feed list displays system events and social posts in chronological order (FEED-04)
- User can create social posts (FEED-02)
- User can comment on feed items (FEED-03)
- Feed shows system events from CRM actions (FEED-01)
- Real-time feed updates via SignalR (new posts appear without refresh)
- Feed respects tenant isolation via backend API (FEED-05)
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-06-SUMMARY.md`
</output>
