---
phase: 08-real-time-and-notifications
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/notifications/notification.store.ts
  - globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can mark a read notification as unread from the notification center UI"
    - "Unread count increments when a notification is marked as unread"
    - "Notification visual state changes from read to unread styling after marking as unread"
  artifacts:
    - path: "globcrm-web/src/app/features/notifications/notification.store.ts"
      provides: "markAsUnread(id) store method"
      contains: "markAsUnread"
    - path: "globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts"
      provides: "Mark as unread UI button on read notifications"
      contains: "markAsUnread"
  key_links:
    - from: "notification.store.ts"
      to: "notification.service.ts"
      via: "notificationService.markAsUnread(id)"
      pattern: "notificationService\\.markAsUnread"
    - from: "notification-center.component.ts"
      to: "notification.store.ts"
      via: "store.markAsUnread(notification.id)"
      pattern: "store\\.markAsUnread"
---

<objective>
Close the single verification gap for Phase 8 success criterion #2: "User can mark notifications as read/unread."

The mark-as-unread flow is 2/3 complete (backend PATCH endpoint + Angular service method exist). This plan wires the remaining 1/3: a store method and a UI control so users can actually mark read notifications as unread.

Purpose: Complete the read/unread toggle so Phase 8 achieves 8/8 must-haves.
Output: Working mark-as-unread from the notification center dropdown.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@globcrm-web/src/app/features/notifications/notification.store.ts
@globcrm-web/src/app/features/notifications/notification.service.ts
@globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts
@globcrm-web/src/app/features/notifications/notification.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add markAsUnread method to NotificationStore and mark-as-unread button to NotificationCenterComponent</name>
  <files>
    globcrm-web/src/app/features/notifications/notification.store.ts
    globcrm-web/src/app/features/notifications/notification-center/notification-center.component.ts
  </files>
  <action>
**notification.store.ts** -- Add a `markAsUnread(id: string)` method to the store's withMethods block, following the exact pattern of the existing `markAsRead(id)` method but in reverse:

```typescript
/** Marks a notification as unread and updates local state. */
markAsUnread(id: string): void {
  notificationService.markAsUnread(id).subscribe({
    next: () => {
      const notifications = store.notifications().map((n) =>
        n.id === id ? { ...n, isRead: false } : n
      );
      const wasRead = store.notifications().find((n) => n.id === id && n.isRead);
      patchState(store, {
        notifications,
        unreadCount: wasRead
          ? store.unreadCount() + 1
          : store.unreadCount(),
      });
    },
  });
},
```

Place it immediately after the `markAsRead` method for logical grouping.

**notification-center.component.ts** -- Add a small "mark as unread" button to each **read** notification item. The button should:

1. Appear only on notifications where `notification.isRead === true` (read notifications).
2. Use a mat-icon-button with `markunread` icon, positioned at the top-right of the notification item.
3. Stop click propagation (so clicking the button does not also trigger `onNotificationClick` which would navigate away).
4. Call `store.markAsUnread(notification.id)`.

In the template, inside the `@for` loop, add the button after the `notification-center__item-content` div but still inside the `notification-center__item` div:

```html
@if (notification.isRead) {
  <button
    mat-icon-button
    class="notification-center__unread-btn"
    (click)="onMarkAsUnread($event, notification)"
    title="Mark as unread"
    aria-label="Mark as unread"
  >
    <mat-icon>markunread</mat-icon>
  </button>
}
```

Add the click handler method to the component class:

```typescript
/** Mark a single notification as unread. Stops propagation to prevent navigation. */
onMarkAsUnread(event: MouseEvent, notification: NotificationDto): void {
  event.stopPropagation();
  this.store.markAsUnread(notification.id);
}
```

Add CSS for the unread button in the styles block:

```css
.notification-center__unread-btn {
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  line-height: 28px;
  align-self: center;
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-default);

  mat-icon {
    font-size: 16px;
    width: 16px;
    height: 16px;
    color: var(--color-text-muted);
  }
}

.notification-center__item:hover .notification-center__unread-btn {
  opacity: 1;
}
```

This shows the button only on hover of a read notification item, keeping the UI clean.
  </action>
  <verify>
1. Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build --configuration development 2>&1 | tail -20` -- must compile with zero errors.
2. Grep for `markAsUnread` in notification.store.ts -- method must exist.
3. Grep for `markAsUnread` in notification-center.component.ts -- button and handler must exist.
4. Grep for `notification-center__unread-btn` in notification-center.component.ts -- CSS must exist.
  </verify>
  <done>
- NotificationStore has markAsUnread(id) that calls notificationService.markAsUnread(id), flips isRead to false, and increments unreadCount.
- NotificationCenterComponent shows a mark-as-unread button on hover for read notifications.
- Clicking the button marks the notification as unread without navigating.
- Angular build compiles with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `ng build` compiles without errors.
2. `markAsUnread` method exists in NotificationStore with correct service call and state update.
3. Mark-as-unread button renders in template for read notifications only (`@if (notification.isRead)`).
4. Click handler calls `event.stopPropagation()` and `store.markAsUnread(notification.id)`.
5. CSS styles hide button by default and reveal on item hover.
</verification>

<success_criteria>
- Phase 8 success criterion #2 is fully satisfied: users can mark notifications as both read AND unread from the UI.
- The mark-as-unread flow connects end-to-end: UI button -> store method -> service HTTP call -> backend PATCH endpoint.
- Angular build passes with zero errors.
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-08-SUMMARY.md`
</output>
