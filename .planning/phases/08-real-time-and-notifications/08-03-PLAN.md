---
phase: 08-real-time-and-notifications
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/GlobCRM.Api/Controllers/NotificationsController.cs
  - src/GlobCRM.Api/Controllers/FeedController.cs
  - src/GlobCRM.Infrastructure/Notifications/DueDateNotificationService.cs
  - src/GlobCRM.Api/Program.cs
autonomous: true

must_haves:
  truths:
    - "User can fetch paged notifications with unread count via REST API"
    - "User can mark notifications as read/unread and mark all as read"
    - "User can get and update notification preferences per type"
    - "User can fetch paged feed combining system events and social posts"
    - "User can create social posts and add comments to feed items"
    - "Background service checks for approaching due dates and dispatches notifications"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/NotificationsController.cs"
      provides: "Notification REST endpoints"
      exports: ["GET /api/notifications", "PATCH /api/notifications/{id}/read", "GET /api/notifications/preferences"]
    - path: "src/GlobCRM.Api/Controllers/FeedController.cs"
      provides: "Feed REST endpoints"
      exports: ["GET /api/feed", "POST /api/feed", "POST /api/feed/{id}/comments"]
    - path: "src/GlobCRM.Infrastructure/Notifications/DueDateNotificationService.cs"
      provides: "Background service for due date approaching notifications"
      contains: "class DueDateNotificationService"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/NotificationsController.cs"
      to: "INotificationRepository"
      via: "constructor injection"
      pattern: "INotificationRepository"
    - from: "src/GlobCRM.Api/Controllers/FeedController.cs"
      to: "NotificationDispatcher"
      via: "constructor injection for real-time feed updates"
      pattern: "NotificationDispatcher"
---

<objective>
Create REST API controllers for notifications and feed, plus a background service for due-date-approaching notifications.

Purpose: Expose notification and feed data to the frontend and automate due date notification delivery.
Output: NotificationsController (7 endpoints), FeedController (5 endpoints), DueDateNotificationService.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-real-time-and-notifications/08-RESEARCH.md
@.planning/phases/08-real-time-and-notifications/08-01-SUMMARY.md
@.planning/phases/08-real-time-and-notifications/08-02-SUMMARY.md
@src/GlobCRM.Api/Controllers/EmailsController.cs (controller pattern reference)
@src/GlobCRM.Infrastructure/Gmail/EmailSyncBackgroundService.cs (BackgroundService pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: NotificationsController and FeedController</name>
  <files>
    src/GlobCRM.Api/Controllers/NotificationsController.cs
    src/GlobCRM.Api/Controllers/FeedController.cs
  </files>
  <action>
    **NotificationsController.cs**: [ApiController], [Route("api/notifications")], [Authorize].
    Inject INotificationRepository, extract userId from User.FindFirst(ClaimTypes.NameIdentifier).

    Endpoints:
    1. GET /api/notifications?page=1&pageSize=20 -- returns paged notifications for current user. Response includes items array and total count.
    2. GET /api/notifications/unread-count -- returns { count: N } of unread notifications.
    3. PATCH /api/notifications/{id}/read -- marks single notification as read. Returns 204.
    4. PATCH /api/notifications/{id}/unread -- marks single notification as unread (set IsRead=false, ReadAt=null). Returns 204.
    5. POST /api/notifications/mark-all-read -- marks all unread notifications as read for current user. Returns 204.
    6. GET /api/notifications/preferences -- returns list of NotificationPreferenceDto for current user. If user has no preferences yet, return defaults (all types with InApp=true, Email=true).
    7. PUT /api/notifications/preferences -- accepts list of NotificationPreferenceDto, upserts each. Returns 200.

    DTOs (define as records in the controller file or a separate Dtos folder):
    - NotificationDto: Id, Type, Title, Message, EntityType, EntityId, IsRead, CreatedAt, CreatedByName
    - NotificationPreferenceDto: NotificationType, InAppEnabled, EmailEnabled

    **FeedController.cs**: [ApiController], [Route("api/feed")], [Authorize].
    Inject IFeedRepository, NotificationDispatcher, IHubContext<CrmHub>, extract userId and tenantId from claims.

    Endpoints:
    1. GET /api/feed?page=1&pageSize=20 -- returns paged feed items with author info. Include comment count per item.
    2. POST /api/feed -- create social post. Accepts { content: string }. Sets AuthorId from current user, Type = SocialPost. Persist via repository. After create, send "FeedUpdate" to tenant group via IHubContext for real-time. Detect @mentions in content via regex `@(\w+)` and dispatch Mention notifications to matched users (lookup by username/name in ApplicationDbContext.Users). Return 201 with created FeedItemDto.
    3. GET /api/feed/{id} -- returns single feed item with all comments (each with author info).
    4. POST /api/feed/{id}/comments -- add comment to feed item. Accepts { content: string }. Sets AuthorId from current user. After create, send "FeedCommentAdded" to tenant group via IHubContext. Detect @mentions. Return 201 with FeedCommentDto.
    5. DELETE /api/feed/{id} -- delete feed item (author only or Admin). Returns 204.

    DTOs:
    - FeedItemDto: Id, Type, Content, EntityType, EntityId, AuthorId, AuthorName, AuthorAvatarUrl, CreatedAt, CommentCount
    - FeedCommentDto: Id, Content, AuthorId, AuthorName, AuthorAvatarUrl, CreatedAt
    - CreateFeedPostRequest: Content (string, required)
    - CreateCommentRequest: Content (string, required)
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` succeeds. Test with curl: `curl -H "Authorization: Bearer {token}" http://localhost:5233/api/notifications` returns 200 with empty list.</verify>
  <done>NotificationsController has 7 endpoints for notification CRUD and preferences. FeedController has 5 endpoints for feed listing, social posts, and comments with real-time push and @mention detection.</done>
</task>

<task type="auto">
  <name>Task 2: DueDateNotificationService background service</name>
  <files>
    src/GlobCRM.Infrastructure/Notifications/DueDateNotificationService.cs
    src/GlobCRM.Api/Program.cs
  </files>
  <action>
    **DueDateNotificationService.cs**: Follows EmailSyncBackgroundService pattern exactly.
    - Inherits BackgroundService
    - Constructor injects: IServiceScopeFactory, ILogger<DueDateNotificationService>
    - Configurable interval via configuration "Notifications:DueDateCheckIntervalHours" (default: 1 hour)
    - ExecuteAsync loop:
      1. Create scope, resolve ApplicationDbContext and NotificationDispatcher
      2. Query activities where DueDate is within next 24 hours AND Status is NOT Done/Cancelled AND no DueDateApproaching notification already sent for this activity+user combo (check Notifications table for existing notification with same EntityId + Type = DueDateApproaching + CreatedAt in last 24h)
      3. For each qualifying activity, dispatch notification to both OwnerId and AssignedToId (if different) via NotificationDispatcher
      4. Also create a FeedItem of type SystemEvent with message "Activity '{Subject}' is due soon" and entity link
      5. Catch all exceptions (never crash the host)
      6. Delay by configured interval

    **Update Program.cs**: Add `builder.Services.AddHostedService<DueDateNotificationService>();` after existing hosted service registration. Add `using GlobCRM.Infrastructure.Notifications;` import.
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` compiles. App starts without errors (background service logs startup message).</verify>
  <done>DueDateNotificationService runs hourly, checks for activities due within 24h, dispatches DueDateApproaching notifications without duplicates</done>
</task>

</tasks>

<verification>
- `dotnet build` succeeds
- API starts without DI errors
- GET /api/notifications returns 200
- GET /api/feed returns 200
- DueDateNotificationService logs startup in console
</verification>

<success_criteria>
- NotificationsController: 7 endpoints for listing, marking read/unread, mark-all-read, and preferences
- FeedController: 5 endpoints for feed listing, social posts with @mention detection, comments with real-time push
- DueDateNotificationService: hourly check for approaching due dates, dispatches without duplicates
- All endpoints require authorization
</success_criteria>

<output>
After completion, create `.planning/phases/08-real-time-and-notifications/08-03-SUMMARY.md`
</output>
