---
phase: 14-foundation-infrastructure-email-templates
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - globcrm-web/package.json
  - globcrm-web/src/app/features/email-templates/email-template.models.ts
  - globcrm-web/src/app/features/email-templates/email-template.service.ts
  - globcrm-web/src/app/features/email-templates/email-template.store.ts
  - globcrm-web/src/app/features/email-templates/email-templates.routes.ts
  - globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts
  - globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.html
  - globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.scss
  - globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
  - globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.html
  - globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.scss
  - globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.ts
  - globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.html
  - globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.scss
  - globcrm-web/src/app/app.routes.ts
autonomous: true
requirements:
  - ETMPL-01
  - ETMPL-02

must_haves:
  truths:
    - "User can see a list of email templates with visual HTML previews/thumbnails"
    - "User can create a new email template using a drag-and-drop Unlayer editor with blocks (header, columns, image, button, divider)"
    - "User can insert merge fields from a grouped panel (Contact, Company, Deal, Lead) including custom fields"
    - "User can edit an existing template and the Unlayer editor loads the saved design JSON"
    - "User can filter templates by category and search by name"
    - "Merge fields appear as styled chip/badge pills in the editor"
    - "Email templates feature is accessible via lazy-loaded route with permission guard"
  artifacts:
    - path: "globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts"
      provides: "Unlayer email editor wrapper with merge tag support"
      contains: "EmailEditorComponent"
    - path: "globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts"
      provides: "Template list page with HTML thumbnail previews"
      contains: "EmailTemplateListComponent"
    - path: "globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.ts"
      provides: "Grouped merge field browser panel"
      contains: "MergeFieldPanelComponent"
    - path: "globcrm-web/src/app/features/email-templates/email-template.store.ts"
      provides: "NgRx Signal Store for email template state"
      contains: "EmailTemplateStore"
    - path: "globcrm-web/src/app/features/email-templates/email-template.service.ts"
      provides: "API service for email template operations"
      contains: "EmailTemplateService"
  key_links:
    - from: "globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts"
      to: "angular-email-editor"
      via: "Unlayer EmailEditorModule import and @ViewChild editor reference"
      pattern: "EmailEditorModule"
    - from: "globcrm-web/src/app/features/email-templates/email-template.store.ts"
      to: "globcrm-web/src/app/features/email-templates/email-template.service.ts"
      via: "Store methods call service for API operations"
      pattern: "emailTemplateService"
    - from: "globcrm-web/src/app/app.routes.ts"
      to: "globcrm-web/src/app/features/email-templates/email-templates.routes.ts"
      via: "Lazy-loaded route with permissionGuard"
      pattern: "email-templates"
---

<objective>
Build the frontend email template feature with Unlayer drag-and-drop editor, template list page with HTML thumbnails, merge field panel for field insertion, NgRx Signal Store for state management, and lazy-loaded routing with permission guards.

Purpose: Delivers the user-facing email template creation and editing experience — the core WYSIWYG editor with Mailchimp-like drag-and-drop blocks and merge field insertion that template authors will use daily.

Output: Functional email template list page and editor with Unlayer integration, merge field panel, and state management.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-RESEARCH.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-CONTEXT.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-02-SUMMARY.md
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/features/leads/leads.routes.ts
@globcrm-web/src/app/features/leads/lead.models.ts
@globcrm-web/src/app/features/leads/lead.service.ts
@globcrm-web/src/app/features/leads/lead.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Unlayer, create models, service, store, and routes</name>
  <files>
    globcrm-web/package.json
    globcrm-web/src/app/features/email-templates/email-template.models.ts
    globcrm-web/src/app/features/email-templates/email-template.service.ts
    globcrm-web/src/app/features/email-templates/email-template.store.ts
    globcrm-web/src/app/features/email-templates/email-templates.routes.ts
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
    **Install Unlayer Angular package:**
    ```bash
    cd globcrm-web && npm install angular-email-editor
    ```

    **Create `email-template.models.ts`:**
    - `EmailTemplate` interface: id, name, subject, designJson, htmlBody, categoryId, categoryName, ownerId, ownerName, isShared, isSeedData, createdAt, updatedAt
    - `EmailTemplateListItem` interface (for list view): id, name, subject, categoryId, categoryName, isShared, ownerId, ownerName, htmlBody (for thumbnail), createdAt, updatedAt
    - `EmailTemplateCategory` interface: id, name, sortOrder, isSystem
    - `MergeField` interface: key, label, group, isCustomField
    - `MergeFieldGroup` type: `Record<string, MergeField[]>` (keyed by entity: contact, company, deal, lead)
    - `CreateEmailTemplateRequest` interface: name, subject?, designJson, htmlBody, categoryId?, isShared
    - `UpdateEmailTemplateRequest` interface: name, subject?, designJson, htmlBody, categoryId?, isShared
    - `PreviewRequest` interface: entityType?, entityId?
    - `PreviewResponse` interface: renderedHtml, renderedSubject
    - `CloneRequest` interface: name

    **Create `email-template.service.ts`:**
    - Injectable service, inject `ApiService`
    - Methods (all return `Observable`):
      - `getTemplates(params?: { categoryId?: string; isShared?: boolean; search?: string; page?: number; pageSize?: number })` → GET `/api/email-templates` with HttpParams
      - `getTemplate(id: string)` → GET `/api/email-templates/${id}`
      - `createTemplate(request: CreateEmailTemplateRequest)` → POST `/api/email-templates`
      - `updateTemplate(id: string, request: UpdateEmailTemplateRequest)` → PUT `/api/email-templates/${id}`
      - `deleteTemplate(id: string)` → DELETE `/api/email-templates/${id}`
      - `cloneTemplate(id: string, request: CloneRequest)` → POST `/api/email-templates/${id}/clone`
      - `previewTemplate(id: string, request: PreviewRequest)` → POST `/api/email-templates/${id}/preview`
      - `testSend(id: string, request: PreviewRequest)` → POST `/api/email-templates/${id}/test-send`
      - `getCategories()` → GET `/api/email-template-categories`
      - `createCategory(request: { name: string; sortOrder?: number })` → POST `/api/email-template-categories`
      - `updateCategory(id: string, request: { name: string; sortOrder?: number })` → PUT `/api/email-template-categories/${id}`
      - `deleteCategory(id: string)` → DELETE `/api/email-template-categories/${id}`
      - `getMergeFields()` → GET `/api/merge-fields`

    **Create `email-template.store.ts`:**
    - NgRx Signal Store (same pattern as LeadStore, ContactStore)
    - State: `templates` (EmailTemplateListItem[]), `selectedTemplate` (EmailTemplate | null), `categories` (EmailTemplateCategory[]), `mergeFields` (MergeFieldGroup), `loading` (boolean), `error` (string | null), `filters` ({ categoryId?: string; search?: string })
    - Computed signals: `filteredTemplates` (apply category/search filter from state)
    - Methods:
      - `loadTemplates()` — calls service.getTemplates, sets templates
      - `loadTemplate(id: string)` — calls service.getTemplate, sets selectedTemplate
      - `loadCategories()` — calls service.getCategories, sets categories
      - `loadMergeFields()` — calls service.getMergeFields, sets mergeFields
      - `createTemplate(request)` — calls service.createTemplate, adds to templates list
      - `updateTemplate(id, request)` — calls service.updateTemplate, updates in list
      - `deleteTemplate(id)` — calls service.deleteTemplate, removes from list
      - `cloneTemplate(id, name)` — calls service.cloneTemplate, adds clone to list
      - `setFilters(filters)` — updates filter state, reloads templates
    - Provider: listed in component `providers: []` (per-page store pattern)

    **Create `email-templates.routes.ts`:**
    - `EMAIL_TEMPLATE_ROUTES: Routes` array:
      - `{ path: '', component: EmailTemplateListComponent }` — list page
      - `{ path: 'new', component: EmailTemplateEditorComponent }` — create new
      - `{ path: ':id/edit', component: EmailTemplateEditorComponent }` — edit existing
    - Use `withComponentInputBinding()` for route param binding

    **Update `app.routes.ts`:**
    - Add email-templates route entry after the existing `import` route:
      ```typescript
      {
        path: 'email-templates',
        canActivate: [authGuard, permissionGuard('EmailTemplate', 'View')],
        loadChildren: () =>
          import('./features/email-templates/email-templates.routes').then(
            (m) => m.EMAIL_TEMPLATE_ROUTES
          ),
      },
      ```
  </action>
  <verify>
    - `cd globcrm-web && npm run build` succeeds (or at minimum `npx ng build --configuration development` compiles)
    - `angular-email-editor` appears in package.json dependencies
    - Routes registered in app.routes.ts
    - Service methods match the API endpoints from Plan 14-02
  </verify>
  <done>
    Unlayer package installed. Email template models, service, store, and routes created. App routes updated with lazy-loaded email-templates path guarded by authGuard and EmailTemplate:View permission. Frontend builds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Email template list page with thumbnails and category filter</name>
  <files>
    globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts
    globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.html
    globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.scss
  </files>
  <action>
    **Create `EmailTemplateListComponent`:**
    - Standalone component, `ChangeDetectionStrategy.OnPush`
    - Inject `EmailTemplateStore` (via `providers: [EmailTemplateStore]`), `Router`
    - On init: load templates and categories from store

    **Template layout:**
    - **Header section**: Title "Email Templates", search input (mat-form-field with search icon), "Create Template" button (mat-raised-button, color primary) — guarded with `*appHasPermission` for EmailTemplate:Create
    - **Category filter bar**: Horizontal chip list or tab bar showing "All" + each category name. Clicking a category filters the template list. Use mat-chip-listbox or mat-button-toggle-group.
    - **Template grid**: CSS grid layout (3 columns on desktop, 2 on tablet, 1 on mobile) showing template cards
    - **Each template card** (mat-card):
      - **Thumbnail area**: Render the template's `htmlBody` in a scaled-down iframe or a div with `transform: scale(0.25)` and `overflow: hidden` with fixed height (~200px visible). Use `srcdoc` attribute on an iframe for safe HTML rendering. Set iframe to `pointer-events: none` to prevent interaction.
      - **Info section below thumbnail**: Template name (bold), subject line (muted), category chip, "Shared"/"Personal" badge
      - **Action buttons**: Edit (navigate to `:id/edit`), Clone (opens simple name input dialog, calls store.cloneTemplate), Delete (confirm dialog, calls store.deleteTemplate). Guard Edit/Delete with `*appHasPermission` for EmailTemplate:Edit/Delete.
    - **Empty state**: "No email templates yet" message with "Create your first template" CTA button
    - **Loading state**: Show skeleton cards or mat-spinner while loading

    **Styling (SCSS):**
    - Use CSS custom properties from `tokens.css` for colors
    - Card hover effect with subtle elevation change
    - Thumbnail iframe: `width: 600px; height: 400px; transform: scale(0.33); transform-origin: top left;` inside a container with `width: 200px; height: 132px; overflow: hidden;`
    - Responsive grid: `display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px;`
    - Category filter chips: colored per category or use neutral styling

    **Clone dialog**: Use a simple `MatDialog` prompt or the existing `EntityFormDialogComponent` pattern to ask for a new template name before cloning.
  </action>
  <verify>
    - `cd globcrm-web && npm run build` succeeds
    - Component renders template cards in a grid layout
    - Category filter chips are visible
    - Template thumbnails use iframe with srcdoc
    - Clone and delete actions are wired to store methods
  </verify>
  <done>
    Email template list page shows visual thumbnail previews of each template in a responsive grid. Category chips filter templates. Search filters by name. Clone, edit, and delete actions available with permission guards. Empty and loading states handled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Unlayer editor component with merge field panel</name>
  <files>
    globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
    globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.html
    globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.scss
    globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.ts
    globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.html
    globcrm-web/src/app/features/email-templates/merge-field-panel/merge-field-panel.component.scss
  </files>
  <action>
    **Create `EmailTemplateEditorComponent`:**
    - Standalone component, `ChangeDetectionStrategy.OnPush`
    - Import `EmailEditorModule` from `angular-email-editor`
    - Use `input()` for route param `id` (optional — null for create, present for edit)
    - Inject `EmailTemplateStore`, `Router`, `ActivatedRoute`
    - `@ViewChild('editor') editor!: EmailEditorComponent;` for Unlayer editor reference

    **Editor page layout:**
    - **Top toolbar**: Template name input (mat-form-field inline), subject line input, category dropdown (mat-select populated from store.categories), "Shared" toggle (mat-slide-toggle), Save button, Back/Cancel button
    - **Main content area**: Full-width Unlayer editor taking remaining viewport height. Use `<email-editor #editor [options]="editorOptions" (loaded)="onEditorLoaded()" (ready)="onEditorReady()" minHeight="calc(100vh - 180px)"></email-editor>`
    - **Merge field panel**: Side panel or floating panel component (see below)

    **Unlayer editor options (`editorOptions`):**
    - `mergeTags`: Build from store.mergeFields signal. Structure:
      ```typescript
      {
        contact: {
          name: 'Contact',
          mergeTags: {
            first_name: { name: 'First Name', value: '{{contact.first_name}}' },
            last_name: { name: 'Last Name', value: '{{contact.last_name}}' },
            email: { name: 'Email', value: '{{contact.email}}' },
            // ... more fields from mergeFields signal
          }
        },
        company: { name: 'Company', mergeTags: { ... } },
        deal: { name: 'Deal', mergeTags: { ... } },
        lead: { name: 'Lead', mergeTags: { ... } }
      }
      ```
    - Custom merge tags include custom fields: `contact.custom.field_name`
    - `features.textEditor.spellChecker: true`
    - `displayMode: 'email'` (if available) for email-specific layout mode
    - Optionally set `appearance.theme: 'light'` and `appearance.panels.tools.dock: 'left'`

    **On editor ready (`onEditorReady()`):**
    - If editing (id is present): load template from store, then call `this.editor.loadDesign(JSON.parse(template.designJson))` to restore the Unlayer design state
    - If creating: editor starts with blank design (Unlayer default)
    - Load merge fields from store: `store.loadMergeFields()`
    - Update editor merge tags once merge fields load (use `effect()` to watch `store.mergeFields()` and call `this.editor.editor.setMergeTags(...)` when available)

    **Save flow:**
    - Call `this.editor.exportHtml((data: any) => { ... })` which provides `data.design` (JSON) and `data.html` (compiled HTML)
    - Build request with name, subject, `JSON.stringify(data.design)` as designJson, `data.html` as htmlBody, categoryId, isShared
    - If creating: call `store.createTemplate(request)`, navigate to list on success
    - If editing: call `store.updateTemplate(id, request)`, show success snackbar

    **Create `MergeFieldPanelComponent`:**
    - Standalone component receiving `mergeFields` signal as input
    - **Layout**: Grouped expandable sections (mat-expansion-panel) for each entity (Contact, Company, Deal, Lead)
    - Each section shows merge field items as clickable chips/buttons
    - **Click behavior**: Clicking a merge field chip copies the merge tag syntax (e.g., `{{contact.first_name}}`) to clipboard and shows a snackbar "Copied to clipboard — paste in editor". The Unlayer editor's built-in merge tag toolbar already handles drag insertion; this panel is a supplementary browser.
    - **Per user decision**: Merge fields appear as styled chip/badge pills with entity-specific colors:
      - Contact: blue chip
      - Company: green chip
      - Deal: orange chip
      - Lead: purple chip
    - Each chip shows: field label (e.g., "First Name"), with the entity prefix color-coded
    - Custom fields visually distinguished with a small "Custom" badge or italic text
    - **Fallback hint**: Show a small info icon/tooltip explaining that users can set fallback values using `{{ field | default: 'fallback' }}` syntax

    **Per locked decision — dual insertion methods:**
    1. **Toolbar dropdown**: Unlayer natively provides merge tag insertion via its built-in toolbar when `mergeTags` option is configured. This handles the toolbar dropdown menu grouped by entity.
    2. **Inline {{ typing**: Unlayer supports this natively when merge tags are configured — typing `{{` in the text editor triggers autocomplete. Verify this works with the configured merge tags.
    3. **Side panel**: The MergeFieldPanel provides a browsable list for copying merge tag syntax.
  </action>
  <verify>
    - `cd globcrm-web && npm run build` succeeds
    - Unlayer editor renders in the editor component
    - Merge tags are configured from API-loaded merge fields
    - Save exports both design JSON and HTML from Unlayer
    - Existing templates load their design JSON into the editor
    - Merge field panel shows grouped fields with colored chips
  </verify>
  <done>
    Unlayer drag-and-drop email editor embedded with full merge tag support (toolbar dropdown + inline {{ autocomplete). Editor saves both design JSON and HTML. Existing templates load design JSON for continued editing. Merge field panel provides browsable, color-coded field chips grouped by entity including custom fields.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npm run build` — Angular build succeeds
2. Navigate to `/email-templates` — list page loads with template cards
3. Template thumbnails show rendered HTML previews
4. Category chips filter the template list
5. Click "Create Template" — Unlayer editor opens with merge tag toolbar
6. Insert a merge field via Unlayer toolbar dropdown — renders as pill in editor
7. Save — stores design JSON and HTML, returns to list
8. Edit an existing template — Unlayer loads the saved design
9. Merge field panel shows grouped fields with entity-specific colors
</verification>

<success_criteria>
- Unlayer editor functional with drag-and-drop blocks
- Merge fields insertable via toolbar dropdown and visible as merge tags in editor
- Templates save with both design JSON (for editing) and HTML (for rendering)
- List page shows visual thumbnails of each template
- Category filtering and search work
- Permission guards enforce EmailTemplate CRUD access
</success_criteria>

<output>
After completion, create `.planning/phases/14-foundation-infrastructure-email-templates/14-03-SUMMARY.md`
</output>
