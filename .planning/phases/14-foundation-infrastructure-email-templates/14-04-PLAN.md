---
phase: 14-foundation-infrastructure-email-templates
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts
  - globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.html
  - globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.scss
  - globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
  - globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.html
  - globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts
  - globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.html
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
autonomous: true
requirements:
  - ETMPL-03
  - ETMPL-04
  - ETMPL-05

must_haves:
  truths:
    - "User can preview a template with sample data by default in a dialog"
    - "User can select a real CRM entity (Contact, Company, Deal, Lead) for accurate merge field preview"
    - "User can toggle between desktop (600px+) and mobile (320px) preview widths"
    - "User can send a test email of the rendered template to their own email"
    - "User can clone a template from the list page into a new copy with a custom name"
    - "User can filter templates by category on the list page"
    - "Email Templates navigation is accessible from the sidebar/navbar"
  artifacts:
    - path: "globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts"
      provides: "Preview dialog with desktop/mobile toggle and real entity selector"
      contains: "EmailTemplatePreviewComponent"
  key_links:
    - from: "globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts"
      to: "globcrm-web/src/app/features/email-templates/email-template.service.ts"
      via: "Preview calls service.previewTemplate and service.testSend"
      pattern: "previewTemplate|testSend"
    - from: "globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts"
      to: "globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts"
      via: "Editor toolbar Preview button opens PreviewDialog"
      pattern: "EmailTemplatePreviewComponent|MatDialog"
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      to: "email-templates route"
      via: "Navigation link in sidebar"
      pattern: "email-templates"
---

<objective>
Build the email template preview dialog with desktop/mobile toggle, real entity selector, and test send functionality. Add clone and category UI polish to the list page. Add email templates navigation to the sidebar/navbar.

Purpose: Completes the email template user experience with preview (sample and real data), responsive width testing, test send to own inbox, clone workflow, and navigation integration.

Output: Full-featured email template preview, test send, clone, and navigation — completing all ETMPL requirements.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-RESEARCH.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-CONTEXT.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-03-SUMMARY.md
@globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
@globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts
@globcrm-web/src/app/features/email-templates/email-template.service.ts
@globcrm-web/src/app/features/email-templates/email-template.store.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preview dialog with desktop/mobile toggle, entity selector, and test send</name>
  <files>
    globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.ts
    globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.html
    globcrm-web/src/app/features/email-templates/email-template-preview/email-template-preview.component.scss
    globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.ts
    globcrm-web/src/app/features/email-templates/email-template-editor/email-template-editor.component.html
  </files>
  <action>
    **Create `EmailTemplatePreviewComponent`:**
    - Standalone component opened as a MatDialog
    - Dialog data input: `{ templateId: string }` (the template ID to preview)
    - Inject `EmailTemplateService`, `MatSnackBar`

    **Preview dialog layout:**
    - **Header**: "Preview Template" title, close (X) button
    - **Control bar** (horizontal toolbar):
      1. **Device toggle**: Two icon buttons — desktop icon (monitor) and mobile icon (smartphone). Active state highlighted. Default: desktop.
      2. **Entity selector section**:
         - "Preview with:" label
         - Entity type dropdown (mat-select): options "Sample Data" (default), "Contact", "Company", "Deal", "Lead"
         - If entity type selected (not "Sample Data"): show a second search/autocomplete field (mat-autocomplete) to pick a specific entity by name. Use the existing entity search endpoints (e.g., `GET /api/contacts?search=...`) to populate autocomplete results.
      3. **Refresh button**: Re-renders preview with current entity selection
      4. **"Send Test" button** (mat-raised-button, color accent): Sends the rendered template to the current user's email
    - **Preview area**:
      - Container div that changes width based on device toggle:
        - Desktop: `width: 600px` (standard email width), centered
        - Mobile: `width: 320px`, centered
      - Smooth CSS transition on width change
      - Inside: an iframe with `srcdoc` attribute containing the rendered HTML
      - Subject line preview shown above the iframe: "Subject: {renderedSubject}" in a styled bar

    **Preview logic:**
    - On dialog open: call `service.previewTemplate(templateId, {})` with no entity (sample data). Set `renderedHtml` and `renderedSubject` from response.
    - On entity selection change: call `service.previewTemplate(templateId, { entityType, entityId })`. Update rendered content.
    - On "Refresh" click: re-call preview with current entity selection.
    - Loading state: show mat-spinner overlay on the preview iframe while loading.

    **Test send logic:**
    - On "Send Test" click: call `service.testSend(templateId, { entityType?, entityId? })` with current entity selection.
    - Show loading spinner on button during send.
    - On success: show snackbar "Test email sent to your inbox!"
    - On error: show snackbar with error message "Failed to send test email"

    **Entity autocomplete for real entity preview:**
    - When entity type is "Contact": use existing contact search API to find contacts by name
    - When "Company": use company search API
    - When "Deal": use deal search API
    - When "Lead": use lead search API
    - Use `debounceTime(300)` on the search input
    - Show entity name + identifying info in dropdown (e.g., "John Doe (john@example.com)" for contacts)
    - After selecting an entity, automatically refresh the preview

    **Wire preview button into editor component:**
    - Add a "Preview" button to the `EmailTemplateEditorComponent`'s top toolbar (next to Save button)
    - On click: first save the current template (exportHtml + save via store), then open `EmailTemplatePreviewComponent` dialog with the template ID
    - If template is new (not yet saved), show snackbar "Please save the template before previewing"

    **Styling (SCSS):**
    - Dialog width: `90vw`, max-width: `800px`, height: `85vh`
    - Preview container: centered with background color (`var(--surface-container)` or light gray) to simulate email client viewport
    - Device toggle buttons: use mat-button-toggle-group with icon buttons
    - Iframe: `border: none; width: 100%; height: 100%;` inside the responsive container
    - Smooth transition: `transition: width 0.3s ease` on the preview container
  </action>
  <verify>
    - `cd globcrm-web && npm run build` succeeds
    - Preview dialog opens from editor toolbar
    - Desktop/mobile toggle changes preview width
    - Entity selector shows autocomplete for real entities
    - Test send button calls API and shows snackbar
    - Sample data preview loads by default
  </verify>
  <done>
    Preview dialog renders templates with sample data by default, allows selecting real CRM entities for accurate merge field preview, toggles between desktop (600px) and mobile (320px) widths, and sends test emails to the user's inbox. Editor toolbar includes Preview button that saves and opens the dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clone dialog, category management polish, and navbar navigation</name>
  <files>
    globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.ts
    globcrm-web/src/app/features/email-templates/email-template-list/email-template-list.component.html
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
  </files>
  <action>
    **Enhance clone functionality on list page:**
    - When user clicks "Clone" on a template card, open a simple MatDialog with:
      - Title: "Clone Template"
      - Template name field (mat-form-field) pre-filled with "{original name} (Copy)"
      - Cancel and "Clone" buttons
    - On confirm: call `store.cloneTemplate(templateId, newName)`, show success snackbar "Template cloned successfully", refresh list
    - This can use a simple inline dialog component or leverage the existing `EntityFormDialogComponent` pattern if appropriate. If creating a dedicated dialog, keep it minimal — a single form field dialog.

    **Enhance category filter on list page (if not complete from Plan 14-03):**
    - Ensure category chips/tabs are functional:
      - "All" chip is selected by default (shows all templates)
      - Each category chip filters templates by categoryId via store.setFilters
      - Active chip is visually highlighted (filled vs outline)
    - If admin: show a small "Manage Categories" link/button that opens a simple inline management panel or routes to a settings page for category CRUD

    **Add "Email Templates" to navbar/sidebar:**
    - Read the existing navbar component to understand the navigation pattern
    - Add "Email Templates" navigation item with an appropriate Material icon (`mail_outline` or `description` or `drafts`)
    - Position: near the bottom of the main navigation, after "Import" or in a logical group
    - Guard visibility with `*appHasPermission` directive for `EmailTemplate:View` scope
    - Link to `/email-templates` route

    **Additional list page polish:**
    - Show "Shared" vs "Personal" badge on each template card using a small chip or icon
    - Show template owner name (if shared and created by another user)
    - "Seed" templates should show a small badge/indicator (e.g., "Starter" chip) so users know these are built-in
    - Template card hover: subtle scale transform (`transform: scale(1.02)`) with box-shadow transition for tactile feel
    - Confirm delete dialog: "Are you sure you want to delete '{templateName}'?" with Cancel and Delete (red) buttons. Use existing `ConfirmDeleteDialogComponent` if available, or create a simple confirm dialog inline.
  </action>
  <verify>
    - `cd globcrm-web && npm run build` succeeds
    - Clone dialog opens with pre-filled name, creates a copy on confirm
    - Category chips filter templates correctly
    - Navbar shows "Email Templates" link with correct icon
    - Shared/Personal badges visible on template cards
    - Delete confirmation dialog works
  </verify>
  <done>
    Clone dialog creates template copies with custom names. Category filter chips work on list page with visual active state. Navbar includes Email Templates navigation with permission guard. Template cards show shared/personal and starter badges. Delete has confirmation dialog. All ETMPL requirements fully delivered.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npm run build` — Angular build succeeds
2. Open editor, click "Preview" — preview dialog opens with sample data rendered
3. Switch to mobile width — iframe resizes to 320px with smooth transition
4. Select "Contact" entity type, pick a contact — preview re-renders with real data
5. Click "Send Test" — snackbar confirms email sent to user's inbox
6. On list page, click "Clone" on a template — dialog opens with pre-filled name, clone appears in list
7. Click category chips — templates filter by category
8. Navbar shows "Email Templates" link, navigates correctly
9. Delete template — confirmation dialog appears, template removed on confirm
</verification>

<success_criteria>
- Preview dialog functional with desktop/mobile toggle
- Real entity selector works for accurate merge field preview
- Test send delivers rendered template to user's email
- Clone creates a new template with user-chosen name
- Category filter works on list page
- Email Templates accessible from main navigation
- All 5 ETMPL requirements fully delivered across Plans 14-01 through 14-04
</success_criteria>

<output>
After completion, create `.planning/phases/14-foundation-infrastructure-email-templates/14-04-SUMMARY.md`
</output>
