---
phase: 26-integration-fix-preview-sidebar-myday-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
  - globcrm-web/src/app/shared/services/entity-preview.service.ts
  - globcrm-web/src/app/shared/services/entity-type-registry.ts
  - globcrm-web/src/app/shared/components/global-search/global-search.component.ts
autonomous: true
requirements:
  - MYDAY-08
  - MYDAY-11
gap_closure: true

must_haves:
  truths:
    - "Clicking an entity name in any My Day widget opens the preview sidebar (pushPreview sets isOpen:true)"
    - "Opening an entity preview from any context (feed, search, My Day, association chip) calls trackView to populate recently_viewed_entities"
    - "GlobalSearchComponent shows correct entity-specific icons (Lead shows 'trending_up', Quote shows 'request_quote') via EntityTypeRegistry"
    - "EntityTypeRegistry contains all 8 entity types including Quote and Request"
  artifacts:
    - path: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      provides: "pushPreview with isOpen:true + trackView call in loadPreview"
      contains: "isOpen: true"
    - path: "globcrm-web/src/app/shared/services/entity-preview.service.ts"
      provides: "trackView method for recently viewed tracking"
      contains: "trackView"
    - path: "globcrm-web/src/app/shared/services/entity-type-registry.ts"
      provides: "Complete entity type registry with Quote and Request"
      contains: "Quote"
    - path: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      provides: "Icon lookup via getEntityConfig instead of duplicate switch"
      contains: "getEntityConfig"
  key_links:
    - from: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      to: "globcrm-web/src/app/shared/services/entity-preview.service.ts"
      via: "previewService.trackView() call in loadPreview success handler"
      pattern: "previewService\\.trackView"
    - from: "globcrm-web/src/app/shared/services/entity-preview.service.ts"
      to: "/api/my-day/track-view"
      via: "HTTP POST to backend track-view endpoint"
      pattern: "api/my-day/track-view"
    - from: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      to: "globcrm-web/src/app/shared/services/entity-type-registry.ts"
      via: "getEntityConfig() import and call"
      pattern: "getEntityConfig\\(type\\)"
---

<objective>
Fix three cross-phase wiring issues discovered during the v1.2 milestone audit: (1) pushPreview() not setting isOpen:true, (2) trackView() never being called to populate recently viewed entities, (3) GlobalSearchComponent using a duplicate icon switch instead of EntityTypeRegistry.

Purpose: Close the remaining gaps so My Day widget entity links open the preview sidebar, the Recent Records widget has real data, and entity icons are consistent throughout the application.

Output: Four modified files with all three fixes applied.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-integration-fix-preview-sidebar-myday-wiring/26-RESEARCH.md
@globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
@globcrm-web/src/app/shared/services/entity-preview.service.ts
@globcrm-web/src/app/shared/services/entity-type-registry.ts
@globcrm-web/src/app/shared/components/global-search/global-search.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pushPreview isOpen + add Quote/Request to EntityTypeRegistry</name>
  <files>
    globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
    globcrm-web/src/app/shared/services/entity-type-registry.ts
  </files>
  <action>
    **Fix 1 — pushPreview isOpen (preview-sidebar.store.ts):**

    In the `pushPreview` method (line 85-97), add `isOpen: true` to the `patchState` call. The current patchState at line 90 has `stack`, `isLoading`, `error`, `currentData` but is missing `isOpen: true`. Add it as the first property:

    ```typescript
    patchState(store, {
      isOpen: true,  // ADD THIS — ensures sidebar opens when called from closed context (My Day widgets)
      stack: newStack,
      isLoading: true,
      error: null,
      currentData: null,
    });
    ```

    This is safe and idempotent: when the sidebar is already open (drill-down within sidebar), isOpen is already true so this is a no-op. When the sidebar is closed (My Day widget clicks), this correctly opens it.

    **Fix 2 — Add Quote and Request to EntityTypeRegistry (entity-type-registry.ts):**

    Add two new entries after the `Product` entry in `ENTITY_TYPE_REGISTRY` (line 26):

    ```typescript
    Quote:    { icon: 'request_quote', label: 'Quote',    labelPlural: 'Quotes',    routePrefix: '/quotes',    color: 'var(--color-warning)' },
    Request:  { icon: 'support_agent', label: 'Request',  labelPlural: 'Requests',  routePrefix: '/requests',  color: 'var(--color-danger)' },
    ```

    Icon values verified from navbar.component.ts and related-entity-tabs.component.ts. Color values verified from webhook-edit.component.ts. These must be added BEFORE Task 2 replaces the GlobalSearchComponent switch statement, to avoid icon regression for Quote and Request search results.
  </action>
  <verify>
    1. Open preview-sidebar.store.ts and confirm pushPreview's patchState includes `isOpen: true`
    2. Open entity-type-registry.ts and confirm ENTITY_TYPE_REGISTRY has 8 entries: Contact, Company, Deal, Lead, Activity, Product, Quote, Request
    3. Verify `getEntityConfig('Quote')?.icon` would return 'request_quote' and `getEntityConfig('Request')?.icon` would return 'support_agent'
    4. Run `cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` to check for compilation errors
  </verify>
  <done>
    pushPreview() sets isOpen:true so My Day widget entity links open the sidebar. EntityTypeRegistry contains all 8 entity types with correct icons, labels, routes, and colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire trackView to preview open + refactor GlobalSearchComponent icons</name>
  <files>
    globcrm-web/src/app/shared/services/entity-preview.service.ts
    globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
    globcrm-web/src/app/shared/components/global-search/global-search.component.ts
  </files>
  <action>
    **Fix 3 — Add trackView() method to EntityPreviewService (entity-preview.service.ts):**

    Add a new method after `getPreview()`:

    ```typescript
    trackView(entityType: string, entityId: string, entityName: string): Observable<void> {
      return this.api.post<void>('/api/my-day/track-view', { entityType, entityId, entityName });
    }
    ```

    This calls the existing backend `POST /api/my-day/track-view` endpoint (MyDayController.TrackView) which uses an upsert pattern with a unique index on (tenant_id, user_id, entity_type, entity_id). EntityPreviewService is root-scoped and already injected in PreviewSidebarStore, so no new DI wiring is needed.

    Do NOT inject or use MyDayService — it is component-scoped (not providedIn: 'root') and would cause a NullInjectorError.

    **Fix 4 — Wire trackView call in loadPreview success handler (preview-sidebar.store.ts):**

    In the `loadPreview` private function, add a fire-and-forget trackView call in the `next` handler, AFTER the existing patchState logic (after both the if/else branches at lines 50-60). Add this right before the closing `}` of the `next` handler:

    ```typescript
    // Track recently viewed entity for My Day Recent Records widget (fire-and-forget)
    previewService.trackView(
      entry.entityType,
      entry.entityId,
      data.name || entry.entityName || ''
    ).subscribe();
    ```

    This is called from `loadPreview` which is shared by `open()`, `pushPreview()`, `goBack()`, and `navigateTo()` — all correct tracking contexts. The `refreshCurrent()` method calls `previewService.getPreview()` directly (bypassing `loadPreview`), so it naturally does NOT re-track, which is desired behavior for silent data refreshes.

    Key pitfall avoidance:
    - MUST call `.subscribe()` — Observables are lazy, the HTTP request won't fire without it
    - Use `data.name` as primary entityName (authoritative from API), `entry.entityName` as fallback, empty string as final fallback
    - No error handler needed — errors are silently ignored (fire-and-forget pattern, matches backend feed/notification dispatch pattern)
    - Do NOT await or block on this call — preview data display must not depend on tracking success

    **Fix 5 — Replace GlobalSearchComponent icon switch with EntityTypeRegistry (global-search.component.ts):**

    1. Add import at the top of the file (alongside other imports):
       ```typescript
       import { getEntityConfig } from '../../services/entity-type-registry';
       ```

    2. Replace the entire `getEntityIcon` method body (lines 593-612) with:
       ```typescript
       getEntityIcon(type: string): string {
         return getEntityConfig(type)?.icon ?? 'search';
       }
       ```

    This deletes the 19-line switch statement and replaces it with a single-line call to the centralized registry. The fallback 'search' icon is preserved for any unrecognized entity types. Since Task 1 already added Quote and Request to the registry, all 7 entity types from the original switch (Company, Contact, Deal, Product, Activity, Quote, Request) plus Lead will resolve correctly.

    The key improvement: Lead entities in search results will now show 'trending_up' (from registry) instead of falling through to 'search' (the old switch had no Lead case).
  </action>
  <verify>
    1. Open entity-preview.service.ts and confirm `trackView` method exists with correct signature and POST to `/api/my-day/track-view`
    2. Open preview-sidebar.store.ts and confirm `previewService.trackView(...)subscribe()` call exists in the loadPreview `next` handler
    3. Confirm `refreshCurrent()` does NOT contain a trackView call (it bypasses loadPreview)
    4. Open global-search.component.ts and confirm `getEntityIcon` uses `getEntityConfig(type)?.icon ?? 'search'` (no switch statement)
    5. Confirm the import `import { getEntityConfig } from '../../services/entity-type-registry';` is present
    6. Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` — must compile with zero errors
  </verify>
  <done>
    trackView() is called on every preview open (via loadPreview shared path) to populate recently_viewed_entities for the My Day Recent Records widget. GlobalSearchComponent uses EntityTypeRegistry for all entity icons, eliminating the duplicate switch statement and correctly showing Lead icon as 'trending_up'.
  </done>
</task>

</tasks>

<verification>
1. **pushPreview isOpen fix:** The patchState in pushPreview includes `isOpen: true` — entity links from closed-sidebar contexts (My Day widgets, feed when sidebar is closed) will now both load data AND show the sidebar
2. **trackView wiring:** The loadPreview success handler calls `previewService.trackView().subscribe()` fire-and-forget — every preview open (from feed, search, My Day, association chips) populates the recently_viewed_entities table
3. **refreshCurrent isolation:** The refreshCurrent() method still bypasses loadPreview (calls getPreview directly) — silent refreshes do NOT re-track views
4. **EntityTypeRegistry completeness:** Registry has 8 entries (Contact, Company, Deal, Lead, Activity, Product, Quote, Request) with verified icons/colors
5. **GlobalSearchComponent refactor:** getEntityIcon delegates to getEntityConfig, eliminating duplicate icon map and correctly handling all entity types including Lead
6. **Build compiles:** `ng build --configuration development` passes with zero errors
</verification>

<success_criteria>
- pushPreview() in preview-sidebar.store.ts includes `isOpen: true` in its patchState call
- EntityPreviewService has a `trackView(entityType, entityId, entityName)` method that POSTs to `/api/my-day/track-view`
- loadPreview success handler calls `previewService.trackView().subscribe()` after data loads
- refreshCurrent() does NOT call trackView (verified by absence of trackView in that method)
- ENTITY_TYPE_REGISTRY contains Quote and Request entries with icons 'request_quote' and 'support_agent'
- GlobalSearchComponent.getEntityIcon uses `getEntityConfig(type)?.icon ?? 'search'` (no switch statement)
- Angular build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-integration-fix-preview-sidebar-myday-wiring/26-01-SUMMARY.md`
</output>
