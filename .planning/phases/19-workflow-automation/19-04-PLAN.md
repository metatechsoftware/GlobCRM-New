---
phase: 19-workflow-automation
plan: 04
type: execute
wave: 3
depends_on: [19-03]
files_modified:
  - globcrm-web/src/app/features/workflows/workflow.models.ts
  - globcrm-web/src/app/features/workflows/workflow.service.ts
  - globcrm-web/src/app/features/workflows/workflow.store.ts
  - globcrm-web/src/app/features/workflows/workflows.routes.ts
  - globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.ts
  - globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.html
  - globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.scss
  - globcrm-web/src/app/features/workflows/workflow-list/workflow-card.component.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
autonomous: true
requirements:
  - WFLOW-12

must_haves:
  truths:
    - "User can see all workflows in a card grid with name, status badge, last run info, and miniaturized flow diagram thumbnails"
    - "User can create a new workflow from the list page"
    - "User can enable/disable a workflow from the list card"
    - "Workflow feature is accessible from the sidebar navigation"
  artifacts:
    - path: "globcrm-web/src/app/features/workflows/workflow.models.ts"
      provides: "TypeScript interfaces for all workflow entities"
      contains: "WorkflowDefinition"
    - path: "globcrm-web/src/app/features/workflows/workflow.service.ts"
      provides: "API service for workflow CRUD, templates, logs"
      contains: "WorkflowService"
    - path: "globcrm-web/src/app/features/workflows/workflow.store.ts"
      provides: "Signal store for workflow state"
      contains: "WorkflowStore"
    - path: "globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.ts"
      provides: "Card grid list page with flow thumbnails"
      contains: "WorkflowListComponent"
    - path: "globcrm-web/src/app/features/workflows/workflow-list/workflow-card.component.ts"
      provides: "Individual workflow card with minimap preview"
      contains: "WorkflowCardComponent"
  key_links:
    - from: "workflow-list.component.ts"
      to: "workflow.store.ts"
      via: "inject(WorkflowStore)"
      pattern: "inject.*WorkflowStore"
    - from: "workflow.service.ts"
      to: "/api/workflows"
      via: "ApiService HTTP calls"
      pattern: "apiService.*workflows"
    - from: "app.routes.ts"
      to: "workflows.routes.ts"
      via: "Lazy-loaded route"
      pattern: "loadChildren.*workflows"
---

<objective>
Create the frontend service layer and workflow list page with card grid layout, flow diagram thumbnails, and status management.

Purpose: Establishes the Angular feature module (models, service, store, routes) and the primary list page where users browse, create, enable/disable, and manage their workflows. The card grid layout with miniaturized flow diagrams is a locked decision.

Output: TypeScript models, API service, signal store, lazy-loaded routes, card grid list component with flow thumbnails, navigation integration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md
@.planning/phases/19-workflow-automation/19-03-SUMMARY.md
@globcrm-web/src/app/features/sequences/sequence.models.ts
@globcrm-web/src/app/features/sequences/sequence.service.ts
@globcrm-web/src/app/features/sequences/sequence.store.ts
@globcrm-web/src/app/features/sequences/sequences.routes.ts
@globcrm-web/src/app/features/sequences/sequence-list/sequence-list.component.ts
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript models, API service, signal store, and routes</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow.models.ts
    globcrm-web/src/app/features/workflows/workflow.service.ts
    globcrm-web/src/app/features/workflows/workflow.store.ts
    globcrm-web/src/app/features/workflows/workflows.routes.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
Create the foundational files for the workflow feature. Follow the sequences feature as a pattern.

**workflow.models.ts:**

```typescript
// Core entity
export interface Workflow {
  id: string;
  name: string;
  description?: string;
  entityType: string;
  status: WorkflowStatus;
  isActive: boolean;
  triggerSummary: string[];
  executionCount: number;
  lastExecutedAt?: string;
  definition: WorkflowDefinition;
  createdByUserId: string;
  createdAt: string;
  updatedAt: string;
}

// Lightweight for list page
export interface WorkflowListItem {
  id: string;
  name: string;
  description?: string;
  entityType: string;
  status: WorkflowStatus;
  isActive: boolean;
  triggerSummary: string[];
  executionCount: number;
  lastExecutedAt?: string;
  nodeCount: number;
  createdAt: string;
  updatedAt: string;
}

export type WorkflowStatus = 'draft' | 'active' | 'paused';

// Visual flow definition (single source of truth for canvas + engine)
export interface WorkflowDefinition {
  nodes: WorkflowNode[];
  connections: WorkflowConnection[];
  triggers: WorkflowTriggerConfig[];
  conditions: WorkflowConditionGroup[];
  actions: WorkflowActionConfig[];
}

export interface WorkflowNode {
  id: string;
  type: 'trigger' | 'condition' | 'action' | 'branch' | 'wait';
  label: string;
  position: { x: number; y: number };
  config?: Record<string, any>;
}

export interface WorkflowConnection {
  id: string;
  sourceNodeId: string;
  targetNodeId: string;
  sourceOutput?: string; // "yes" | "no" for branch nodes
}

export interface WorkflowTriggerConfig {
  id: string;
  nodeId: string;
  triggerType: WorkflowTriggerType;
  eventType?: string;
  fieldName?: string;
  dateOffsetDays?: number;
  preferredTime?: string;
}

export type WorkflowTriggerType = 'recordCreated' | 'recordUpdated' | 'recordDeleted' | 'fieldChanged' | 'dateBased';

export interface WorkflowConditionGroup {
  id: string;
  nodeId: string;
  conditions: WorkflowCondition[];
}

export interface WorkflowCondition {
  field: string;
  operator: string;
  value?: string;
  fromValue?: string;
}

export interface WorkflowActionConfig {
  id: string;
  nodeId: string;
  actionType: WorkflowActionType;
  continueOnError: boolean;
  order: number;
  config: Record<string, any>;
}

export type WorkflowActionType = 'updateField' | 'sendNotification' | 'createActivity' | 'sendEmail' | 'fireWebhook' | 'enrollInSequence' | 'branch' | 'wait';

// Execution logs
export interface WorkflowExecutionLog {
  id: string;
  workflowId: string;
  workflowName?: string;
  triggerType: string;
  triggerEvent: string;
  entityId: string;
  entityType: string;
  conditionsEvaluated: boolean;
  conditionsPassed: boolean;
  status: WorkflowExecutionStatus;
  errorMessage?: string;
  startedAt: string;
  completedAt?: string;
  durationMs: number;
  actionLogs?: WorkflowActionLog[];
}

export type WorkflowExecutionStatus = 'succeeded' | 'partiallyFailed' | 'failed' | 'skipped';

export interface WorkflowActionLog {
  id: string;
  actionType: string;
  actionNodeId: string;
  order: number;
  status: string;
  errorMessage?: string;
  startedAt?: string;
  completedAt?: string;
  durationMs: number;
}

// Templates
export interface WorkflowTemplate {
  id: string;
  name: string;
  description?: string;
  category: string;
  entityType: string;
  isSystem: boolean;
  definition: WorkflowDefinition;
  createdByUserId?: string;
  createdAt: string;
}

export interface WorkflowTemplateListItem {
  id: string;
  name: string;
  description?: string;
  category: string;
  entityType: string;
  isSystem: boolean;
  nodeCount: number;
}

// Request types
export interface CreateWorkflowRequest {
  name: string;
  description?: string;
  entityType: string;
  definition: WorkflowDefinition;
}

export interface UpdateWorkflowRequest {
  name: string;
  description?: string;
  entityType: string;
  definition: WorkflowDefinition;
}

// Entity field for builder config panels
export interface EntityField {
  name: string;
  label: string;
  fieldType: string;
}
```

**workflow.service.ts:**
- Inject `ApiService`
- Methods (all return Observable):
  - `getWorkflows(params?)` → GET `/api/workflows` with entityType, status, page, pageSize
  - `getWorkflow(id)` → GET `/api/workflows/{id}`
  - `createWorkflow(request)` → POST `/api/workflows`
  - `updateWorkflow(id, request)` → PUT `/api/workflows/{id}`
  - `deleteWorkflow(id)` → DELETE `/api/workflows/{id}`
  - `updateStatus(id, isActive)` → PATCH `/api/workflows/{id}/status`
  - `activateWorkflow(id)` → POST `/api/workflows/{id}/activate`
  - `deactivateWorkflow(id)` → POST `/api/workflows/{id}/deactivate`
  - `duplicateWorkflow(id)` → POST `/api/workflows/{id}/duplicate`
  - `getExecutionLogs(workflowId, page?, pageSize?)` → GET `/api/workflows/{id}/logs`
  - `getExecutionLogDetail(workflowId, logId)` → GET `/api/workflows/{id}/logs/{logId}`
  - `getEntityFields(entityType)` → GET `/api/workflows/entity-fields/{entityType}`
  - `getTemplates(category?, entityType?)` → GET `/api/workflow-templates`
  - `getTemplate(id)` → GET `/api/workflow-templates/{id}`
  - `saveAsTemplate(workflowId, request)` → POST `/api/workflow-templates/from-workflow/{workflowId}`
  - `applyTemplate(templateId)` → POST `/api/workflow-templates/{templateId}/apply`
  - `deleteTemplate(id)` → DELETE `/api/workflow-templates/{id}`

**workflow.store.ts:**
- NgRx Signal Store with `providedIn: undefined` (per-page provider, following ContactStore pattern)
- State: `workflows` (WorkflowListItem[]), `selectedWorkflow` (Workflow | null), `executionLogs` (WorkflowExecutionLog[]), `templates` (WorkflowTemplateListItem[]), `loading` (boolean), `error` (string | null), `totalCount` (number), `currentPage` (number)
- Methods: `loadWorkflows(params?)`, `loadWorkflow(id)`, `createWorkflow(req)`, `updateWorkflow(id, req)`, `deleteWorkflow(id)`, `toggleStatus(id, isActive)`, `duplicateWorkflow(id)`, `loadExecutionLogs(workflowId, page?)`, `loadTemplates(category?, entityType?)`, `applyTemplate(templateId)`
- Each method calls the service and updates state via `patchState`

**workflows.routes.ts:**
- Follow sequences.routes.ts pattern
- Routes:
  - `''` → WorkflowListComponent
  - `'new'` → WorkflowBuilderComponent (lazy-loaded, created in 19-05)
  - `':id'` → WorkflowDetailComponent (lazy-loaded, created in 19-06)
  - `':id/edit'` → WorkflowBuilderComponent (lazy-loaded, created in 19-05)
  - `':id/logs'` → WorkflowLogsComponent (lazy-loaded, created in 19-06)
  - `':id/logs/:logId'` → WorkflowLogDetailComponent (lazy-loaded, created in 19-06)
- Export as `WORKFLOW_ROUTES`
- For components not yet created (19-05, 19-06), use lazy `loadComponent` pointing to placeholder paths — the executor for those plans will create the actual components

**app.routes.ts:**
- Add workflow route:
  ```typescript
  {
    path: 'workflows',
    canActivate: [authGuard, permissionGuard('Workflow', 'View')],
    loadChildren: () =>
      import('./features/workflows/workflows.routes').then(
        (m) => m.WORKFLOW_ROUTES
      ),
  },
  ```
- Insert after 'sequences' route for logical ordering

**navbar.component.ts:**
- Add workflow link to the 'Connect' group (after Sequences):
  `{ route: '/workflows', icon: 'account_tree', label: 'Workflows' }`
  (account_tree material icon represents branching/flow diagrams)
  </action>
  <verify>Build `cd globcrm-web && npx ng build --configuration=development 2>&1 | head -30` — check for compilation errors (component references to not-yet-created components will use lazy loading so won't fail). Verify models.ts, service.ts, store.ts exist.</verify>
  <done>TypeScript models for all workflow entities, API service with 17 methods, signal store with state management, lazy-loaded routes, app.routes.ts integration, and sidebar navigation link.</done>
</task>

<task type="auto">
  <name>Task 2: Workflow list page with card grid layout and flow diagram thumbnails</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.ts
    globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.html
    globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.scss
    globcrm-web/src/app/features/workflows/workflow-list/workflow-card.component.ts
  </files>
  <action>
Create the workflow list page using a card grid layout (locked decision: NOT a DynamicTable — card grid with miniaturized flow diagrams).

**WorkflowListComponent:**
- Standalone component with `ChangeDetectionStrategy.OnPush`
- `providers: [WorkflowStore]` (per-page store)
- Inject `WorkflowStore`, `Router`
- On init: `store.loadWorkflows()`
- Template layout:
  - Page header with title "Workflows" and "New Workflow" button (mat-raised-button, routes to /workflows/new)
  - Filter bar: entity type dropdown (All, Contact, Company, Deal, Lead, Activity) + status dropdown (All, Draft, Active, Paused)
  - Card grid: CSS Grid with `grid-template-columns: repeat(auto-fill, minmax(320px, 1fr))` and `gap: 1rem`
  - Empty state: centered message "No workflows yet" with "Create your first workflow" button
  - Loading state: 4 skeleton cards (same grid layout)
  - Pagination at bottom if > 20 workflows

**WorkflowCardComponent:**
- Standalone component, `ChangeDetectionStrategy.OnPush`
- Inputs: `workflow` (WorkflowListItem input signal)
- Outputs: `toggleStatus` (output signal), `duplicate` (output signal), `delete` (output signal)
- Template (per locked decision: card grid with miniaturized flow diagram thumbnails, name, status badge, and last run info):
  - **Top section (thumbnail):** Miniaturized flow diagram rendered as a simple SVG from node positions in the workflow definition
    - Read nodes from workflow's definition (available via nodeCount at minimum — for thumbnail, use a simplified approach: draw small circles at proportionally scaled node positions connected by lines)
    - If nodeCount == 0, show a placeholder "Empty workflow" graphic
    - The SVG thumbnail is non-interactive (display only, locked decision says "miniaturized version")
    - Node colors: trigger = blue (#3B82F6), condition = amber (#F59E0B), action = green (#10B981), branch = purple (#8B5CF6), wait = gray (#6B7280)
    - Height: ~120px, overflow hidden
  - **Middle section (info):**
    - Workflow name (h3, truncated with ellipsis)
    - Description (if present, 2-line clamp)
    - Entity type chip (e.g., "Contact" in a small badge)
    - Status badge: Draft (gray), Active (green), Paused (amber)
    - Trigger summary chips: show first 2-3 trigger summary strings as small chips
  - **Bottom section (actions):**
    - Last run info: "Last run: 2 hours ago" or "Never run" (using relative time pipe or computed signal)
    - Execution count: "45 runs" with small mat-icon 'bar_chart'
    - Action row: Toggle button (mat-slide-toggle for enable/disable — per WFLOW-12), overflow menu (mat-menu) with Edit, Duplicate, Delete options
  - Click anywhere on the card (except actions) navigates to workflow detail: `/workflows/{id}`

**Styling (workflow-list.component.scss):**
- Card styling: white background (dark mode: surface), rounded-lg border, subtle shadow, hover elevation
- Use CSS custom properties from `src/styles/tokens.css` for colors
- Responsive: 1 column on mobile, 2 on medium, 3 on large screens
- Status badge colors matching the design system
- Skeleton cards: pulsing placeholder animation matching existing skeleton patterns

**SVG Thumbnail approach (in WorkflowCardComponent):**
- Compute a simplified view from the WorkflowListItem:
  - Since the list DTO has `nodeCount` and `triggerSummary` but NOT the full definition, the thumbnail needs to be creative
  - Two approaches:
    1. (Preferred) Extend WorkflowListDto to include a lightweight `thumbnailData` field (array of {type, x, y} for each node) — this avoids sending the full definition for list view
    2. (Fallback) Render a schematic based on triggerSummary count and nodeCount — e.g., 1 trigger circle on left, lines to N action circles on right
  - Use approach 2 for now (no backend change needed). Render an SVG with:
    - Left: trigger node circles (count from triggerSummary.length)
    - Center: condition nodes if workflow has them (detect from trigger types)
    - Right: action nodes (nodeCount - triggerSummary.length)
    - Connected by bezier paths
    - All positioned within a 280x100 viewBox
  </action>
  <verify>Navigate to http://localhost:4200/workflows — card grid displays with workflow cards. Build succeeds without errors.</verify>
  <done>Workflow list page with card grid layout, filter bar, status badges, SVG flow diagram thumbnails, enable/disable toggle, and empty/loading states. Per locked decision: card grid with miniaturized flow diagrams (not DynamicTable).</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` — 0 errors
2. /workflows route loads the list page with card grid layout
3. Cards show workflow name, status badge, entity type, trigger summary, and SVG thumbnail
4. Enable/disable toggle works from card (calls PATCH /api/workflows/{id}/status)
5. Sidebar navigation shows "Workflows" link with account_tree icon
6. Filter dropdowns for entity type and status work
7. "New Workflow" button navigates to /workflows/new
</verification>

<success_criteria>
- Card grid layout with miniaturized flow diagram thumbnails (locked decision)
- Status badges (Draft/Active/Paused) visible on each card
- Enable/disable toggle without deleting (WFLOW-12)
- Responsive grid (1-3 columns)
- Proper loading and empty states
- Navigation integrated in sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-04-SUMMARY.md`
</output>
