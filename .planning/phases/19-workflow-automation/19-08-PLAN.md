---
phase: 19-workflow-automation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/core/auth/auth.interceptor.ts
autonomous: true
requirements: [WFLOW-01]
gap_closure: true

must_haves:
  truths:
    - "After a 401-retry token refresh, permissions are reloaded so new entity types are accessible without re-login"
    - "Normal request flow is unaffected -- permissions are NOT reloaded on every request"
  artifacts:
    - path: "globcrm-web/src/app/core/auth/auth.interceptor.ts"
      provides: "Permission reload after successful 401 token refresh"
      contains: "loadPermissions"
  key_links:
    - from: "auth.interceptor.ts"
      to: "PermissionStore.loadPermissions()"
      via: "inject(PermissionStore) called after setTokens in 401 refresh path"
      pattern: "permissionStore\\.loadPermissions"
---

<objective>
Add permission reload after 401-retry token refresh in the auth interceptor to prevent stale permission state when new entity types (like Workflow) are added between sessions.

Purpose: Future-proof permission loading so users don't need to manually re-login when backend adds new entity types with new permissions. This caused the UAT Test 1 failure where navigating to /workflows redirected to dashboard because PermissionStore lacked Workflow:View.
Output: Auth interceptor that reloads permissions after successful token refresh.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PermissionStore.loadPermissions() call after 401-retry token refresh</name>
  <files>
    globcrm-web/src/app/core/auth/auth.interceptor.ts
  </files>
  <action>
    In the auth interceptor's 401 catchError handler, after the successful token refresh path (after `authStore.setTokens(response.accessToken, response.refreshToken)` and the localStorage/sessionStorage persistence), add a call to reload permissions.

    Specific changes:
    1. Import `PermissionStore` from `'../permissions/permission.store'`
    2. Inside the `authInterceptor` function, inject PermissionStore: `const permissionStore = inject(PermissionStore);`
    3. After `authStore.setTokens(response.accessToken, response.refreshToken)` and the storage persistence block, add `permissionStore.loadPermissions();` (fire-and-forget, no await needed -- the permissions load asynchronously in the background while the retried request proceeds with the new token)

    This is a fire-and-forget call because:
    - The retried request already has the new JWT which the backend will accept
    - Permission state will update reactively via signals once the loadPermissions() response arrives
    - We don't want to block the retry on permission loading

    Do NOT add permission reload to the normal (non-401) request path. Only in the 401-retry switchMap after successful token refresh.
  </action>
  <verify>
    Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build 2>&1 | tail -5` -- build must complete with 0 errors.
    Verify the interceptor imports PermissionStore and calls loadPermissions() in the 401 refresh path.
  </verify>
  <done>
    Auth interceptor reloads permissions after successful 401 token refresh. Normal request flow unchanged. Build passes with 0 errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build` completes with 0 errors
2. auth.interceptor.ts contains `permissionStore.loadPermissions()` inside the 401-retry switchMap block
3. PermissionStore is imported and injected in the interceptor
</verification>

<success_criteria>
- After a 401-triggered token refresh, PermissionStore.loadPermissions() is called fire-and-forget
- Normal requests (non-401) do not trigger permission reload
- Angular build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-08-SUMMARY.md`
</output>
