---
phase: 19-workflow-automation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts
autonomous: true
requirements: [WFLOW-04, WFLOW-05, WFLOW-06, WFLOW-13]
gap_closure: true

must_haves:
  truths:
    - "Nodes added via Add Node menu appear as visible, draggable cards on the @foblex/flow canvas"
    - "All 5 node types (trigger, condition, action, branch, wait) render correctly with their colors, icons, and connectors"
    - "Connections can be drawn between nodes by dragging from output to input connectors"
    - "Custom templates saved from any entity type workflow appear in the template gallery regardless of current entity type"
    - "Template gallery 'All' tab shows all templates across all entity types"
  artifacts:
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts"
      provides: "Inline node templates with fNode as direct children of f-canvas"
      contains: "fNode"
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts"
      provides: "Template gallery loading all templates without entityType filter"
  key_links:
    - from: "workflow-canvas.component.ts"
      to: "f-canvas (ng-content select='[fNode]')"
      via: "div[fNode] as direct child of f-canvas"
      pattern: "<div fNode"
    - from: "template-gallery.component.ts"
      to: "WorkflowService.getTemplates()"
      via: "loadTemplates() without entityType parameter"
      pattern: "getTemplates\\(undefined\\)"
---

<objective>
Fix two critical UAT failures in the workflow builder: (1) nodes not rendering on the @foblex/flow canvas because wrapper components break content projection, and (2) custom templates not appearing in the template gallery due to over-aggressive entityType filtering.

Purpose: Unblock 7 skipped UAT tests (Tests 6-11, 13) that depend on working canvas nodes, and fix the template visibility issue.
Output: Working visual workflow canvas with draggable nodes and a template gallery that shows all templates.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-workflow-automation/19-05-SUMMARY.md
@.planning/debug/workflow-canvas-nodes-not-rendering.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inline node templates into workflow-canvas to fix f-canvas content projection</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts
  </files>
  <action>
    The root cause (confirmed in debug session): @foblex/flow's f-canvas uses `ng-content select="[fNode]"` for content projection, which only matches direct children. The 5 node wrapper components (app-trigger-node, etc.) place `fNode` on an inner div, not their host element. Angular content projection cannot reach inside child component templates.

    Fix: Replace the `@switch` block rendering `<app-trigger-node>`, `<app-condition-node>`, `<app-action-node>`, `<app-branch-node>`, `<app-wait-node>` with inline `<div fNode ...>` templates directly inside the `<f-canvas>` element. This ensures `[fNode]` is on a direct child of f-canvas.

    For each of the 5 node types, inline the template from the corresponding node component. The key elements for each node:

    **All nodes share:**
    - `<div fNode [fNodeId]="node.id" [fNodePosition]="node.position" class="workflow-node {type}-node" [class.selected]="selectedNodeId() === node.id" (click)="nodeSelected.emit(node.id)" (dblclick)="nodeDblClicked.emit(node.id)">`
    - Node content: icon, label, badge
    - Connectors (fNodeInput/fNodeOutput)

    **Per-type specifics:**
    - **trigger**: Blue (#3B82F6), bolt icon, output-only connector (no input), badge from config.triggerType mapping
    - **condition**: Amber (#F59E0B), filter_list icon, input+output connectors, badge from config.conditions summary
    - **action**: Green (#10B981), dynamic icon from config.actionType mapping, input+output connectors, badge from actionType mapping
    - **branch**: Purple (#8B5CF6), call_split icon, input connector + dual output_yes/output_no connectors with Yes/No labels
    - **wait**: Gray (#6B7280), hourglass_empty icon, input+output connectors, badge from config.duration+unit

    Move the badge/icon computation logic into helper methods on WorkflowCanvasComponent:
    - `getTriggerBadge(node: WorkflowNode): string` - maps triggerType to display text
    - `getActionIcon(node: WorkflowNode): string` - maps actionType to material icon name
    - `getActionBadge(node: WorkflowNode): string` - maps actionType to display text
    - `getConditionSummary(node: WorkflowNode): string` - extracts first condition field/operator
    - `getWaitSummary(node: WorkflowNode): string` - formats duration + unit

    Remove imports of the 5 node wrapper components from the imports array. Add the node styles (from the wrapper components) into the canvas component's styles section. Keep all existing connectors, event handlers, and zoom controls.

    Do NOT delete the node component files themselves -- they may be referenced elsewhere and removing them is out of scope. Just stop importing/using them in the canvas.

    IMPORTANT: Each inline node div MUST have `fNode` as an attribute directly on the div element, making it a direct child of f-canvas for content projection to work.
  </action>
  <verify>
    Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build 2>&1 | tail -5` -- build must complete with 0 errors.
    Verify the template contains `<div fNode` patterns as direct children inside `<f-canvas>`.
  </verify>
  <done>
    All 5 node types render as inline templates with fNode attribute directly on div elements that are direct children of f-canvas. Build passes with 0 errors. The wrapper component imports are removed from the canvas component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix template gallery to load all templates without entityType filter</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts
  </files>
  <action>
    The root cause: TemplateGalleryComponent.loadTemplates() (line 295) passes `this.entityType() || undefined` to `service.getTemplates()`, causing the API to filter by entity type. Templates saved from a "Deal" workflow won't appear when the gallery opens for a "Contact" workflow. The "All" tab means "all categories" but is scoped to the current entity type, which is confusing.

    Fix the template gallery to show ALL templates regardless of entity type:

    1. In `loadTemplates()`, change `this.service.getTemplates(undefined, this.entityType() || undefined)` to `this.service.getTemplates()` -- no category, no entityType filter. This fetches all system + custom templates.

    2. Update `filterTemplates()` to handle entity type filtering as a LOCAL concern. Add an entity type badge filter that shows all by default:
       - Keep the existing category tab filtering logic unchanged.
       - When `this.entityType()` has a value, templates matching that entity type should appear first (sorted), but templates from other entity types should still be visible (sorted after, with their entity type badge visible -- which already exists in the template).

    3. Do NOT add an `effect()` to reload when entityType changes. Instead, since we now load ALL templates on init, the local filter is sufficient. If the user changes entity type in the toolbar, the gallery just re-sorts locally.

    The net result: "All" tab shows ALL templates from all entity types. Category tabs filter by category across all entity types. The entityType badge on each template card already shows which entity type it belongs to, giving the user clarity.
  </action>
  <verify>
    Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build 2>&1 | tail -5` -- build must complete with 0 errors.
    Confirm `loadTemplates()` no longer passes entityType to the service call.
  </verify>
  <done>
    Template gallery loads all templates without entityType filter. Custom templates saved from any workflow entity type are visible in the gallery. Category tab filtering still works. Build passes with 0 errors.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build` completes with 0 errors
2. workflow-canvas.component.ts contains `<div fNode` as direct children of `<f-canvas>` (not wrapped in app-*-node components)
3. template-gallery.component.ts loadTemplates() calls `this.service.getTemplates()` without entityType parameter
4. All 5 node types have their visual elements (icon, label, badge, connectors) preserved in the inlined templates
</verification>

<success_criteria>
- Nodes added to the canvas via Add Node menu will render as visible, draggable, colored cards on the f-flow canvas
- All 5 node types display correctly: trigger (blue), condition (amber), action (green), branch (purple with dual outputs), wait (gray)
- Template gallery shows all templates across all entity types, with entity type badge visible on each card
- Angular build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-07-SUMMARY.md`
</output>
