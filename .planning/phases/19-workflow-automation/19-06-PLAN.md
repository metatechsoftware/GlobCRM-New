---
phase: 19-workflow-automation
plan: 06
type: execute
wave: 4
depends_on: [19-04]
files_modified:
  - globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.ts
  - globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.html
  - globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.scss
  - globcrm-web/src/app/features/workflows/workflow-logs/execution-log-list.component.ts
  - globcrm-web/src/app/features/workflows/workflow-logs/execution-log-detail.component.ts
  - globcrm-web/src/app/features/workflows/workflows.routes.ts
autonomous: true
requirements:
  - WFLOW-11
  - WFLOW-12

must_haves:
  truths:
    - "User can view a workflow detail page showing name, status, entity type, execution stats, and quick actions"
    - "User can view paginated execution logs for a workflow showing trigger, conditions, and overall status"
    - "User can drill into a specific execution log to see per-action results with success/failure, error messages, and timing"
    - "User can enable/disable a workflow from the detail page"
  artifacts:
    - path: "globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.ts"
      provides: "Workflow detail page with stats, actions, and embedded log list"
      contains: "WorkflowDetailComponent"
    - path: "globcrm-web/src/app/features/workflows/workflow-logs/execution-log-list.component.ts"
      provides: "Paginated execution log table"
      contains: "ExecutionLogListComponent"
    - path: "globcrm-web/src/app/features/workflows/workflow-logs/execution-log-detail.component.ts"
      provides: "Single execution detail with action-level breakdown"
      contains: "ExecutionLogDetailComponent"
  key_links:
    - from: "workflow-detail.component.ts"
      to: "workflow.store.ts"
      via: "inject(WorkflowStore)"
      pattern: "inject.*WorkflowStore"
    - from: "execution-log-list.component.ts"
      to: "workflow.service.ts"
      via: "getExecutionLogs"
      pattern: "getExecutionLogs"
    - from: "execution-log-detail.component.ts"
      to: "workflow.service.ts"
      via: "getExecutionLogDetail"
      pattern: "getExecutionLogDetail"
---

<objective>
Create the workflow detail page with execution statistics and the execution log viewing components for full audit trail visibility.

Purpose: Users need to monitor workflow performance, see execution history, and debug failures by drilling into individual execution logs. This is essential for WFLOW-11 (execution logs showing trigger, conditions, and action results).

Output: WorkflowDetailComponent with stats and actions, ExecutionLogListComponent with paginated log table, ExecutionLogDetailComponent with per-action breakdown, and route connections.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md
@.planning/phases/19-workflow-automation/19-04-SUMMARY.md
@globcrm-web/src/app/features/workflows/workflow.models.ts
@globcrm-web/src/app/features/workflows/workflow.service.ts
@globcrm-web/src/app/features/workflows/workflow.store.ts
@globcrm-web/src/app/features/workflows/workflows.routes.ts
@globcrm-web/src/app/features/sequences/sequence-detail/sequence-detail.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workflow detail page with stats and quick actions</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.ts
    globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.html
    globcrm-web/src/app/features/workflows/workflow-detail/workflow-detail.component.scss
    globcrm-web/src/app/features/workflows/workflows.routes.ts
  </files>
  <action>
Create the workflow detail page following the sequence-detail component pattern.

**WorkflowDetailComponent:**
- Standalone component, `ChangeDetectionStrategy.OnPush`
- `providers: [WorkflowStore]`
- Route param: `id` input (from route binding via `withComponentInputBinding()`)
- On init: `store.loadWorkflow(id)`, `store.loadExecutionLogs(id)`

- Template layout:
  1. **Header section:**
     - Back button → /workflows
     - Workflow name (h1)
     - Status badge (Draft/Active/Paused) — same styling as list card badges
     - Entity type chip
     - Action buttons:
       - "Edit" (mat-raised-button, routes to /workflows/{id}/edit)
       - "Activate" / "Deactivate" toggle (mat-button, calls store.toggleStatus)
       - "Duplicate" (mat-button, calls store.duplicateWorkflow)
       - "Save as Template" (mat-button, opens dialog to save as template — calls service.saveAsTemplate)
       - Overflow menu: Delete (with confirm dialog)

  2. **Stats cards row** (4 cards in a flex row):
     - Total Executions: `workflow.executionCount` with mat-icon 'play_circle'
     - Last Run: relative time of `workflow.lastExecutedAt` or "Never" with mat-icon 'schedule'
     - Success Rate: computed from recent execution logs (succeeded / total * 100) with mat-icon 'check_circle' in green
     - Failed: count of failed executions from recent logs with mat-icon 'error' in red

  3. **Description section** (if description exists):
     - Workflow description text

  4. **Trigger summary section:**
     - List of trigger summary items as chips/badges
     - Each shows the trigger type and configuration summary

  5. **Execution Logs section** (embedded):
     - Section header: "Execution History" with "View All" link to /workflows/{id}/logs
     - Embedded `<app-execution-log-list>` component showing the 5 most recent logs
     - Full pagination available on the dedicated logs page

  6. **Workflow Flow Preview** (optional — read-only miniaturized canvas):
     - If the full definition is loaded, render a small non-interactive flow preview
     - This can be an SVG-based rendering similar to the card thumbnails but larger
     - Or simply show a summary: "X triggers → Y conditions → Z actions"

- Styling:
  - Stats cards: same card style as dashboard KPI cards (rounded, shadow, colored icon)
  - Header: flex row with title + badges + actions
  - Use tokens.css variables for consistent theming
  - Responsive: stats cards wrap to 2x2 on mobile

- "Save as Template" dialog:
  - Simple mat-dialog with Name, Description, Category inputs
  - Category: dropdown with sales, engagement, operational, custom
  - On save: call `service.saveAsTemplate(workflowId, { name, description, category })`
  - Per locked decision: users can save their own workflows as tenant-scoped reusable templates

**Update workflows.routes.ts:**
- Ensure the `:id` route points to WorkflowDetailComponent:
  ```typescript
  {
    path: ':id',
    loadComponent: () =>
      import('./workflow-detail/workflow-detail.component').then(
        m => m.WorkflowDetailComponent
      ),
  }
  ```
- Also ensure `:id/logs` and `:id/logs/:logId` routes are connected to the log components (created in Task 2)
  </action>
  <verify>Navigate to http://localhost:4200/workflows/{id} — detail page loads with workflow info, stats cards, trigger summary, and recent execution logs. Build succeeds.</verify>
  <done>WorkflowDetailComponent with header (name, status, entity type, actions), stats cards (executions, last run, success rate, failures), trigger summary, embedded execution log preview, and "Save as Template" dialog. Routes connected.</done>
</task>

<task type="auto">
  <name>Task 2: Execution log list and detail components</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-logs/execution-log-list.component.ts
    globcrm-web/src/app/features/workflows/workflow-logs/execution-log-detail.component.ts
    globcrm-web/src/app/features/workflows/workflows.routes.ts
  </files>
  <action>
Create the execution log viewing components for full audit trail visibility (WFLOW-11).

**ExecutionLogListComponent:**
- Standalone component, `ChangeDetectionStrategy.OnPush`
- Inputs:
  - `workflowId` (required input signal: string)
  - `embedded` (input signal: boolean, default false) — when embedded in detail page, show fewer items and no pagination
- Inject: `WorkflowService`, `Router`
- State:
  - `logs` (signal: WorkflowExecutionLog[])
  - `totalCount` (signal: number)
  - `currentPage` (signal: number, default 1)
  - `loading` (signal: boolean)

- Template: mat-table (Angular Material table) with columns:
  - **Status icon**: colored circle or mat-icon based on execution status:
    - succeeded → green check_circle
    - partiallyFailed → amber warning
    - failed → red error
    - skipped → gray block
  - **Trigger**: `{triggerType}: {triggerEvent}` (e.g., "RecordCreated: Contact", "FieldChanged: Status")
  - **Entity**: entity type + truncated entity ID (link to entity if possible)
  - **Conditions**: "Passed" (green) / "Failed" (red) / "—" (if no conditions)
  - **Duration**: `{durationMs}ms` formatted
  - **Started**: relative time (e.g., "2 min ago") with tooltip showing full timestamp
  - **Actions column**: "View Details" button → navigates to /workflows/{workflowId}/logs/{logId}

- Pagination: mat-paginator at bottom (hidden when embedded mode)
- When embedded: show only first 5 rows, no pagination, add "View All Logs" link at bottom

- Empty state: "No executions yet. This workflow will log each run here."
- Loading: mat-spinner or skeleton rows

**ExecutionLogDetailComponent:**
- Standalone component, `ChangeDetectionStrategy.OnPush`
- Route params: `id` (workflow ID), `logId` (execution log ID) — both from route binding
- Inject: `WorkflowService`, `Router`
- On init: call `service.getExecutionLogDetail(workflowId, logId)`

- Template layout (WFLOW-11: showing trigger, conditions, and action results):

  1. **Header:**
     - Back button → /workflows/{id}/logs or /workflows/{id}
     - Title: "Execution Log"
     - Overall status badge (Succeeded/PartiallyFailed/Failed/Skipped)
     - Duration badge: "{X}ms"
     - Timestamp: started at (full datetime)

  2. **Trigger section:**
     - Card showing trigger info: type, event, entity type + entity ID (with link to entity)
     - "What triggered this execution"

  3. **Conditions section:**
     - Card showing: "Conditions Evaluated: Yes/No", "Conditions Passed: Yes/No"
     - If conditions failed: status badge "Skipped — conditions not met"

  4. **Actions timeline** (the main section):
     - Vertical timeline layout (similar to EntityTimelineComponent pattern) showing each action in order:
     - Each action entry:
       - **Status icon**: colored circle (green check, red X, gray skip)
       - **Action type**: bold label with mat-icon (same icons as builder nodes)
       - **Action node ID**: reference to the node in the workflow
       - **Duration**: "{X}ms"
       - **Status**: "Succeeded" / "Failed" / "Skipped"
       - **Error message** (if failed): displayed in a red alert box with monospace font
       - **Timing**: started at → completed at
     - Actions are shown in execution `order`
     - Failed action that halted the workflow: show a red "Execution stopped" marker after it
     - Actions after a halt (if ContinueOnError was false): show as "Not reached" in gray

  5. **Raw data section** (expandable, for debugging):
     - Collapsible panel with JSON view of the full execution log data
     - Useful for debugging complex workflows

- Styling:
  - Timeline: left-aligned vertical line with action entries branching off
  - Status colors: green for success, red for failure, amber for partial, gray for skip
  - Error message box: rounded, red background, monospace text, scrollable
  - Cards use standard mat-card with subtle shadow

**Update workflows.routes.ts** (final connections):
- Ensure all routes are properly connected:
  ```typescript
  {
    path: ':id/logs',
    loadComponent: () =>
      import('./workflow-logs/execution-log-list.component').then(
        m => m.ExecutionLogListComponent
      ),
  },
  {
    path: ':id/logs/:logId',
    loadComponent: () =>
      import('./workflow-logs/execution-log-detail.component').then(
        m => m.ExecutionLogDetailComponent
      ),
  }
  ```
- For the standalone log list route, the component needs to read `id` from the parent route to get the workflowId. Use `input()` binding or inject `ActivatedRoute`.
  </action>
  <verify>Navigate to http://localhost:4200/workflows/{id}/logs — paginated execution log table loads. Click "View Details" on a log → detail page shows trigger info, condition evaluation, and per-action timeline with statuses. Build succeeds.</verify>
  <done>ExecutionLogListComponent with paginated table showing status icons, trigger info, conditions result, duration, and timestamps — supports both standalone and embedded modes. ExecutionLogDetailComponent with trigger section, conditions section, and action timeline showing per-action status/error/duration. Routes fully connected. Full audit trail visibility for WFLOW-11.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` — 0 errors
2. /workflows/{id} — detail page loads with stats cards, trigger summary, and embedded recent logs
3. /workflows/{id}/logs — full paginated execution log table
4. /workflows/{id}/logs/{logId} — execution detail with trigger info, conditions, and action timeline
5. Status icons/colors correctly reflect succeeded/failed/partial/skipped states
6. Failed actions show error messages in red alert box
7. "Save as Template" dialog works from detail page
8. Enable/disable toggle works from detail page
</verification>

<success_criteria>
- Detailed execution logs showing trigger, conditions evaluated, and per-action results (WFLOW-11)
- Enable/disable from detail page (WFLOW-12)
- Stats cards provide at-a-glance workflow performance metrics
- Action timeline provides clear visual sequence of execution with timing and errors
- Both embedded (5 recent) and standalone (paginated) log views work
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-06-SUMMARY.md`
</output>
