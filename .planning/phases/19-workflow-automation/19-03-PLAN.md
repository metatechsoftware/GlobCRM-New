---
phase: 19-workflow-automation
plan: 03
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - src/GlobCRM.Api/Controllers/WorkflowsController.cs
  - src/GlobCRM.Api/Controllers/WorkflowTemplatesController.cs
  - src/GlobCRM.Api/Program.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
autonomous: true
requirements:
  - WFLOW-11
  - WFLOW-12
  - WFLOW-13

must_haves:
  truths:
    - "User can CRUD workflows via REST API with proper authorization"
    - "User can enable/disable workflows via PATCH endpoint without deleting them"
    - "User can view paginated execution logs showing trigger, conditions, and per-action results"
    - "Admin can browse system templates by category and apply them to create new workflows"
    - "User can save their own workflows as tenant-scoped custom templates"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/WorkflowsController.cs"
      provides: "Workflow CRUD, enable/disable, execution logs"
      contains: "WorkflowsController"
    - path: "src/GlobCRM.Api/Controllers/WorkflowTemplatesController.cs"
      provides: "Template gallery, save-as-template"
      contains: "WorkflowTemplatesController"
  key_links:
    - from: "WorkflowsController"
      to: "IWorkflowRepository"
      via: "DI injection for CRUD operations"
      pattern: "IWorkflowRepository"
    - from: "WorkflowsController"
      to: "WorkflowDomainEventHandler"
      via: "Cache invalidation on CRUD"
      pattern: "InvalidateCache"
---

<objective>
Create the Workflow REST API with CRUD operations, enable/disable toggle, execution log viewing, and template management endpoints.

Purpose: Provides the full API surface for the frontend to manage workflows, view execution history, and use/create templates. Co-located DTOs and validators follow the established controller file pattern.

Output: WorkflowsController with ~15 endpoints, WorkflowTemplatesController with ~5 endpoints, DTOs, validators, and Program.cs wiring for the date trigger recurring job.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md
@.planning/phases/19-workflow-automation/19-01-SUMMARY.md
@src/GlobCRM.Api/Controllers/WebhooksController.cs
@src/GlobCRM.Api/Controllers/SequencesController.cs
@src/GlobCRM.Api/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkflowsController with CRUD, enable/disable, and execution logs</name>
  <files>
    src/GlobCRM.Api/Controllers/WorkflowsController.cs
  </files>
  <action>
Create the WorkflowsController following the established controller pattern (DTOs, request records, and validators co-located in the same file). Authorization uses `[Authorize(Policy = "Permission:Workflow:View")]` etc.

**Route:** `[Route("api/[controller]")]` → `/api/workflows`

**DTOs (co-located in controller file):**

`WorkflowDto`:
- Id, Name, Description, EntityType, Status (string), IsActive
- TriggerSummary (List&lt;string&gt;), ExecutionCount, LastExecutedAt
- Definition (WorkflowDefinitionDto — full JSONB for builder), CreatedByUserId, CreatedAt, UpdatedAt
- Static `FromEntity(Workflow w)` factory method

`WorkflowListDto` (lightweight for list page — no full definition):
- Id, Name, Description, EntityType, Status, IsActive
- TriggerSummary, ExecutionCount, LastExecutedAt
- NodeCount (int — computed from Definition.Nodes.Count for card display)
- CreatedAt, UpdatedAt
- Static `FromEntity(Workflow w)` factory method

`WorkflowDefinitionDto`: mirrors WorkflowDefinition exactly (Nodes, Connections, Triggers, Conditions, Actions)

`WorkflowExecutionLogDto`:
- Id, WorkflowId, WorkflowName, TriggerType, TriggerEvent, EntityId, EntityType
- ConditionsEvaluated, ConditionsPassed, Status, ErrorMessage
- StartedAt, CompletedAt, DurationMs
- ActionLogs (List&lt;WorkflowActionLogDto&gt; — included when fetching detail)
- Static `FromEntity(WorkflowExecutionLog log)` factory method

`WorkflowActionLogDto`:
- Id, ActionType, ActionNodeId, Order, Status, ErrorMessage, StartedAt, CompletedAt, DurationMs
- Static `FromEntity(WorkflowActionLog log)` factory method

**Request records:**
- `CreateWorkflowRequest(string Name, string? Description, string EntityType, WorkflowDefinitionDto Definition)`
- `UpdateWorkflowRequest(string Name, string? Description, string EntityType, WorkflowDefinitionDto Definition)`
- `UpdateWorkflowStatusRequest(bool IsActive)`

**Validators (FluentValidation):**
- `CreateWorkflowValidator`: Name required 1-200 chars, EntityType required and must be in ["Contact", "Company", "Deal", "Lead", "Activity"], Definition required with at least one trigger
- `UpdateWorkflowValidator`: Same rules

**Endpoints:**

1. `GET /api/workflows` — List workflows (paginated)
   - Query params: `entityType?`, `status?` (string), `page=1`, `pageSize=20`
   - Returns: `PaginatedResponse&lt;WorkflowListDto&gt;`
   - Auth: `Permission:Workflow:View`

2. `GET /api/workflows/{id}` — Get workflow with full definition
   - Returns: `WorkflowDto`
   - Auth: `Permission:Workflow:View`

3. `POST /api/workflows` — Create workflow
   - Body: `CreateWorkflowRequest`
   - Compute TriggerSummary from Definition.Triggers (denormalize for fast matching)
   - Set Status = Draft, IsActive = false, CreatedByUserId from JWT
   - Invalidate WorkflowDomainEventHandler cache
   - Returns: 201 with `WorkflowDto`
   - Auth: `Permission:Workflow:Create`

4. `PUT /api/workflows/{id}` — Update workflow
   - Body: `UpdateWorkflowRequest`
   - Recompute TriggerSummary from updated Definition
   - Invalidate cache
   - Returns: `WorkflowDto`
   - Auth: `Permission:Workflow:Edit`

5. `DELETE /api/workflows/{id}` — Delete workflow
   - Cascade deletes execution logs and action logs (EF config)
   - Invalidate cache
   - Returns: 204
   - Auth: `Permission:Workflow:Delete`

6. `PATCH /api/workflows/{id}/status` — Enable/disable workflow (WFLOW-12)
   - Body: `UpdateWorkflowStatusRequest` with `IsActive` bool
   - When enabling: set IsActive = true, Status = Active
   - When disabling: set IsActive = false, Status = Paused
   - Invalidate cache
   - Returns: `WorkflowDto`
   - Auth: `Permission:Workflow:Edit`

7. `POST /api/workflows/{id}/activate` — Activate (set Status to Active + IsActive true)
   - Validate: workflow must have at least one trigger and one action
   - Invalidate cache
   - Returns: `WorkflowDto`
   - Auth: `Permission:Workflow:Edit`

8. `POST /api/workflows/{id}/deactivate` — Deactivate (set Status to Paused + IsActive false)
   - Invalidate cache
   - Returns: `WorkflowDto`
   - Auth: `Permission:Workflow:Edit`

9. `POST /api/workflows/{id}/duplicate` — Clone workflow
   - Create new workflow with "(Copy)" appended to name, Status = Draft, IsActive = false
   - Copy full Definition, reset ExecutionCount and LastExecutedAt
   - Returns: 201 with `WorkflowDto`
   - Auth: `Permission:Workflow:Create`

10. `GET /api/workflows/{id}/logs` — List execution logs for a workflow (WFLOW-11)
    - Query params: `page=1`, `pageSize=20`
    - Returns: `PaginatedResponse&lt;WorkflowExecutionLogDto&gt;` (without ActionLogs for list view)
    - Auth: `Permission:Workflow:View`

11. `GET /api/workflows/{id}/logs/{logId}` — Get execution log detail with action logs (WFLOW-11)
    - Returns: `WorkflowExecutionLogDto` with ActionLogs populated
    - Auth: `Permission:Workflow:View`

12. `GET /api/workflows/entity-fields/{entityType}` — Get available fields for an entity type
    - Used by the builder for trigger field selection and condition configuration
    - Return standard fields + custom fields (from CustomFieldDefinitions for the entity type)
    - Returns: `List&lt;EntityFieldDto&gt;` with Name, Label, FieldType
    - Auth: `Permission:Workflow:View`

Private helper: `ComputeTriggerSummary(WorkflowDefinitionDto definition)` — converts triggers to summary strings:
- RecordCreated trigger → "RecordCreated"
- RecordUpdated trigger → "RecordUpdated"
- RecordDeleted trigger → "RecordDeleted"
- FieldChanged trigger → "FieldChanged:{fieldName}"
- DateBased trigger → "DateBased:{fieldName}"
  </action>
  <verify>Build `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors. WorkflowsController.cs exists with all 12 endpoints.</verify>
  <done>WorkflowsController with 12 endpoints for CRUD, enable/disable, clone, execution logs, and entity field listing. DTOs, request records, and validators co-located. Cache invalidation on all mutations.</done>
</task>

<task type="auto">
  <name>Task 2: WorkflowTemplatesController, Program.cs wiring, and template seeder enhancement</name>
  <files>
    src/GlobCRM.Api/Controllers/WorkflowTemplatesController.cs
    src/GlobCRM.Api/Program.cs
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  </files>
  <action>
Create the template management API and wire up recurring jobs in Program.cs.

**WorkflowTemplatesController.cs:**

Route: `[Route("api/workflow-templates")]`

DTOs (co-located):

`WorkflowTemplateDto`:
- Id, Name, Description, Category, EntityType, IsSystem
- Definition (WorkflowDefinitionDto — full definition for applying)
- CreatedByUserId, CreatedAt
- Static `FromEntity(WorkflowTemplate t)` factory method

`WorkflowTemplateListDto` (lightweight for gallery):
- Id, Name, Description, Category, EntityType, IsSystem
- NodeCount (int — computed from Definition)
- Static `FromEntity(WorkflowTemplate t)` factory method

Request records:
- `SaveAsTemplateRequest(string Name, string? Description, string Category)`

Endpoints:

1. `GET /api/workflow-templates` — List templates (for gallery)
   - Query params: `category?` (string), `entityType?` (string)
   - Returns system templates first (IsSystem desc), then custom templates by name
   - Include both system templates AND tenant-scoped custom templates (per locked decision: shown alongside with "Custom" badge)
   - Returns: `List&lt;WorkflowTemplateListDto&gt;`
   - Auth: `Permission:Workflow:View`

2. `GET /api/workflow-templates/{id}` — Get template with full definition
   - Returns: `WorkflowTemplateDto`
   - Auth: `Permission:Workflow:View`

3. `POST /api/workflow-templates/from-workflow/{workflowId}` — Save workflow as template (WFLOW-13)
   - Body: `SaveAsTemplateRequest`
   - Per locked decision: users can save their own workflows as tenant-scoped reusable templates
   - Copy workflow's Definition to new WorkflowTemplate, IsSystem = false
   - Category defaults to "custom" if not in known categories
   - Returns: 201 with `WorkflowTemplateDto`
   - Auth: `Permission:Workflow:Create`

4. `POST /api/workflow-templates/{id}/apply` — Create workflow from template (WFLOW-13)
   - Per locked decision: applying template creates full copy, user edits freely, no link to original
   - Create new Workflow with template's Definition, Name = template.Name, Status = Draft, IsActive = false
   - Returns: 201 with `WorkflowDto` (from WorkflowsController DTO)
   - Auth: `Permission:Workflow:Create`

5. `DELETE /api/workflow-templates/{id}` — Delete custom template
   - Only allow deletion of non-system templates (IsSystem == false). Return 403 for system templates.
   - Returns: 204
   - Auth: `Permission:Workflow:Delete`

**Program.cs:**
- Add DateTriggerScanService recurring job registration after Hangfire server start:
  ```csharp
  app.UseHangfireDashboard(...);
  // Add after existing UseHangfireDashboard or Hangfire setup:
  RecurringJob.AddOrUpdate<DateTriggerScanService>(
      DateTriggerScanService.JobId,
      svc => svc.ScanAsync(),
      Cron.Hourly);
  ```
- Ensure the `using` for Hangfire and DateTriggerScanService namespace is present

**TenantSeeder enhancement:**
- The 3 system templates created in 19-01 need to be seeded per-tenant (not just once). Verify they are created with tenant context during org setup. If 19-01 already handles this via SeedWorkflowsAsync, confirm the templates are created correctly.
- Per locked decision template categories: "sales" (deal won, lead qualified, deal idle), "engagement" (welcome email, follow-up task), "operational" (high-value deal notify, new company enrich)
- Add 2 more templates to hit all locked decision categories:
  4. "Lead Qualified Alert" (category: "sales") — trigger: Lead.Updated, condition: Status changed to "Qualified", action: SendNotification
  5. "New Company Enrichment Task" (category: "operational") — trigger: Company.Created, action: CreateActivity (research and enrich company data)
  </action>
  <verify>Build `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors. WorkflowTemplatesController.cs exists with 5 endpoints. Program.cs includes DateTriggerScanService recurring job. Reseed `cd src/GlobCRM.Api && dotnet run -- --reseed` completes without errors.</verify>
  <done>WorkflowTemplatesController with 5 endpoints for template gallery, apply, save-as-template, and delete. Program.cs wires DateTriggerScanService as hourly recurring job. TenantSeeder creates 5 system templates covering all locked decision categories (sales, engagement, operational).</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors
2. WorkflowsController has 12 endpoints (CRUD, status toggle, activate/deactivate, clone, logs, entity fields)
3. WorkflowTemplatesController has 5 endpoints (list, get, save-as-template, apply, delete)
4. DTOs use static `FromEntity()` factory methods
5. FluentValidation validators enforce required fields
6. Cache invalidation called on all workflow mutations
7. DateTriggerScanService registered as hourly recurring job in Program.cs
8. Reseed creates demo workflows and 5 system templates
</verification>

<success_criteria>
- Full REST API surface for workflow management (CRUD, enable/disable, logs)
- Template gallery with system and custom templates (WFLOW-13)
- Execution log endpoints with action-level detail (WFLOW-11)
- Enable/disable without deletion (WFLOW-12)
- Proper authorization on all endpoints
- Date trigger scanner wired as recurring Hangfire job
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-03-SUMMARY.md`
</output>
