---
phase: 05-activities-and-workflow
plan: 07
type: execute
wave: 6
depends_on: ["05-06"]
files_modified:
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.scss
autonomous: true

must_haves:
  truths:
    - "Activity detail page shows core fields, status with workflow transitions, and tabbed sub-entity views"
    - "Comments tab allows adding, editing, and deleting comments"
    - "Attachments tab supports file upload, download, and delete"
    - "Time Log tab shows time entries and allows adding new entries"
    - "Links tab shows linked entities with inline search for adding new links"
    - "Timeline tab aggregates all activity events in chronological order"
    - "Follow/unfollow button toggles activity watching"
  artifacts:
    - path: "globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts"
      provides: "Activity detail page with tabs for comments, attachments, time log, links, timeline"
      contains: "ActivityDetailComponent"
  key_links:
    - from: "activity-detail.component.ts"
      to: "activity.service.ts"
      via: "service injection for all sub-resource operations"
      pattern: "inject.*ActivityService"
    - from: "activity-detail.component.ts"
      to: "EntityTimelineComponent"
      via: "template reference for timeline tab"
      pattern: "app-entity-timeline"
---

<objective>
Create the Activity detail page with tabs for Details, Comments, Attachments, Time Log, Links, and Timeline, plus follow/unfollow and status workflow controls.

Purpose: Implement ACTV-05 (comments), ACTV-06 (attachments), ACTV-07 (time tracking), ACTV-08 (audit trail / timeline), ACTV-10 (follow/watch), ACTV-12 (entity linking). This is the most complex detail page in the CRM with the most tabs and sub-entity interactions.
Output: Activity detail component with 6 tabs and full sub-entity CRUD.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.html
@globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts

# Prior plan summaries
@.planning/phases/05-activities-and-workflow/05-05-SUMMARY.md
@.planning/phases/05-activities-and-workflow/05-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Activity detail component with header, status controls, and tab structure</name>
  <files>
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.scss
  </files>
  <action>
    Create **activity-detail** component following deal-detail pattern but with more tabs:

    **Component class (activity-detail.component.ts):**
    - Standalone component
    - Inject ActivatedRoute, Router, ActivityService, MatSnackBar, MatDialog, AuthStore (for current user), PermissionStore
    - Load activity detail on init via ActivityService.getById(id) -- store as a signal
    - Load timeline via ActivityService.getTimeline(id) -- separate signal for timeline data

    **Header section:**
    - Back button to /activities
    - Activity subject as title
    - Type chip (Task/Call/Meeting with icon from ACTIVITY_TYPES)
    - Priority chip (color-coded from ACTIVITY_PRIORITIES)
    - Status chip with current status color

    **Status workflow controls:**
    - Status dropdown or button group showing ONLY allowed transitions from current status (use ALLOWED_TRANSITIONS constant from models)
    - Clicking a transition calls ActivityService.updateStatus(id, newStatus)
    - On success: reload activity detail, show snackbar "Status updated to {newStatus}"
    - If transitioning to Done: show brief confirmation since it marks completion

    **Follow/unfollow button:**
    - Determine if current user is following (check activity.followers for current userId)
    - Toggle button: "Follow" (outline) or "Following" (filled) with mat-icon "visibility"/"visibility_off"
    - Click calls ActivityService.follow(id) or ActivityService.unfollow(id)
    - Reload activity on success

    **Info sidebar (right side):**
    - Owner (name, avatar)
    - Assigned To (name, avatar)
    - Due Date (formatted, highlight red if overdue)
    - Created At
    - Updated At
    - Completed At (if Done)
    - Total Time: sum from time entries (formatted as "Xh Ym")
    - Followers count

    **Tab structure (mat-tab-group):**
    Define 6 tabs. For this task, implement the tab container and Details tab. Comments, Attachments, Time Log, Links, and Timeline tabs will have their content templates:

    1. **Details tab:** Description (rendered, not editable inline), Custom fields display, Edit button linking to /activities/:id/edit
    2. **Comments tab:** (content in next task action block below)
    3. **Attachments tab:** (content in next task action block below)
    4. **Time Log tab:** (content in next task action block below)
    5. **Links tab:** (content in next task action block below)
    6. **Timeline tab:** Use EntityTimelineComponent or inline timeline rendering. Map activity timeline entries to TimelineEntry format.

    **Tab content -- Comments (ACTV-05):**
    - List of comments ordered by CreatedAt (newest first)
    - Each comment shows: author name, avatar initials, timestamp, content
    - Edit button (mat-icon-button) visible only for comment author (authorId == currentUserId)
    - Delete button visible for author or admin
    - "Add comment" form at top: mat-form-field with textarea + Submit button
    - On add: call activityService.addComment(activityId, content), reload detail
    - On edit: inline edit (toggle textarea editable), call activityService.updateComment
    - On delete: confirm dialog, call activityService.deleteComment

    **Tab content -- Attachments (ACTV-06):**
    - List of attachments as cards: fileName, fileSize (formatted), uploadedBy, uploadedAt
    - Download button: calls activityService.downloadAttachment, triggers browser download
    - Delete button: visible for uploader or admin, calls activityService.deleteAttachment
    - Upload area: file input (hidden) + "Upload File" button. Validate max 25MB on client before upload. Show progress indicator during upload. Call activityService.uploadAttachment(id, file). Reload detail on success.

    **Tab content -- Time Log (ACTV-07):**
    - Table of time entries: date, duration (formatted "Xh Ym"), description, logged by
    - Total time summary at top
    - "Log Time" form: duration (number input, minutes), description (text), date (datepicker defaulting to today)
    - On submit: call activityService.addTimeEntry(id, request), reload detail
    - Delete button on each entry (user's own entries only)

    **Tab content -- Links (ACTV-12):**
    - List of linked entities grouped by entityType: Companies, Contacts, Deals
    - Each link shows: entityName as a clickable link (navigates to /companies/:id, /contacts/:id, /deals/:id), entityType badge, linkedAt timestamp
    - Unlink button (mat-icon-button with "link_off") calls activityService.deleteLink
    - "Link Entity" inline search panel following deal-detail pattern: type selector (Company/Contact/Deal), search input with debounce, results dropdown, click to link

    **Timeline tab (ACTV-08):**
    - Render timeline entries from ActivityService.getTimeline response
    - Use CSS-only timeline layout with vertical connector lines (same pattern as entity-timeline from Phase 3)
    - Each entry shows: icon (varies by type), description, user name, timestamp
    - Event type icons: created (add_circle), status_changed (swap_horiz), comment_added (comment), attachment_uploaded (attach_file), time_logged (schedule), entity_linked (link)

    **Styles (activity-detail.component.scss):**
    - Two-column layout: main content (tabs) left, info sidebar right
    - Tab content styling for comments list, attachment cards, time log table, links list
    - Timeline styling with vertical connector lines
    - Status chip colors, priority colors
    - Responsive: stack sidebar below tabs on small screens
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds.
    Activity detail component files exist with all 6 tabs.
  </verify>
  <done>Activity detail page renders all 6 tabs (Details, Comments, Attachments, Time Log, Links, Timeline) with full sub-entity CRUD, workflow status controls, follow/unfollow button, and info sidebar.</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- Detail page loads activity with all child collections
- Status transition buttons show only valid transitions
- Comments: add, edit (author only), delete (author/admin)
- Attachments: upload (25MB limit), download, delete (uploader/admin)
- Time entries: add with duration/date/description, delete (own only)
- Links: add via inline search, navigate to linked entity, remove link
- Timeline: chronological events with type-specific icons
- Follow button toggles correctly
</verification>

<success_criteria>
- Most complex detail page in the CRM renders all sub-entity tabs
- Workflow status controls enforce allowed transitions client-side
- Follow/unfollow toggle works (ACTV-10)
- All 5 sub-entity types have working CRUD in their respective tabs
- Timeline aggregates 6 event types for audit trail (ACTV-08)
- Entity links navigate to target entity detail pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-07-SUMMARY.md`
</output>
