---
phase: 05-activities-and-workflow
plan: 07
type: execute
wave: 6
depends_on: ["05-06"]
files_modified:
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
  - globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.scss
autonomous: true

must_haves:
  truths:
    - "Activity detail page shows core fields, status with workflow transitions, and tabbed sub-entity views"
    - "Comments tab allows adding, editing, and deleting comments"
    - "Attachments tab supports file upload, download, and delete"
    - "Time Log tab shows time entries and allows adding new entries"
    - "Links tab shows linked entities with inline search for adding new links"
    - "Timeline tab aggregates all activity events in chronological order"
    - "Follow/unfollow button toggles activity watching"
  artifacts:
    - path: "globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts"
      provides: "Activity detail page with tabs for comments, attachments, time log, links, timeline"
      contains: "ActivityDetailComponent"
  key_links:
    - from: "activity-detail.component.ts"
      to: "activity.service.ts"
      via: "service injection for all sub-resource operations"
      pattern: "inject.*ActivityService"
    - from: "activity-detail.component.ts"
      to: "EntityTimelineComponent"
      via: "template reference for timeline tab"
      pattern: "app-entity-timeline"
---

<objective>
Create the Activity detail page with tabs for Details, Comments, Attachments, Time Log, Links, and Timeline, plus follow/unfollow and status workflow controls.

Purpose: Implement ACTV-05 (comments), ACTV-06 (attachments), ACTV-07 (time tracking), ACTV-08 (audit trail / timeline), ACTV-10 (follow/watch), ACTV-12 (entity linking). This is the most complex detail page in the CRM with the most tabs and sub-entity interactions.
Output: Activity detail component with 6 tabs and full sub-entity CRUD.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.html
@globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts

# Prior plan summaries
@.planning/phases/05-activities-and-workflow/05-05-SUMMARY.md
@.planning/phases/05-activities-and-workflow/05-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity detail header, status controls, follow/unfollow, info sidebar, and Details tab</name>
  <files>
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.scss
  </files>
  <action>
    Create **activity-detail** component following deal-detail pattern. This task builds the page structure, header, sidebar, status controls, follow/unfollow, and the Details tab. The 5 sub-entity tabs (Comments, Attachments, Time Log, Links, Timeline) will have placeholder template sections that Task 2 fills in.

    **Component class (activity-detail.component.ts):**
    - Standalone component
    - Inject ActivatedRoute, Router, ActivityService, MatSnackBar, MatDialog, AuthStore (for current user), PermissionStore
    - Load activity detail on init via ActivityService.getById(id) -- store as a signal
    - Load timeline via ActivityService.getTimeline(id) -- separate signal for timeline data
    - Define signals/state for: activity, timeline, isFollowing (computed from activity.followers + current userId), activeTab

    **Header section:**
    - Back button to /activities
    - Activity subject as title
    - Type chip (Task/Call/Meeting with icon from ACTIVITY_TYPES)
    - Priority chip (color-coded from ACTIVITY_PRIORITIES)
    - Status chip with current status color

    **Status workflow controls:**
    - Status dropdown or button group showing ONLY allowed transitions from current status (use ALLOWED_TRANSITIONS constant from models)
    - Clicking a transition calls ActivityService.updateStatus(id, newStatus)
    - On success: reload activity detail, show snackbar "Status updated to {newStatus}"
    - If transitioning to Done: show brief confirmation since it marks completion

    **Follow/unfollow button:**
    - Determine if current user is following (check activity.followers for current userId)
    - Toggle button: "Follow" (outline) or "Following" (filled) with mat-icon "visibility"/"visibility_off"
    - Click calls ActivityService.follow(id) or ActivityService.unfollow(id)
    - Reload activity on success

    **Info sidebar (right side):**
    - Owner (name, avatar)
    - Assigned To (name, avatar)
    - Due Date (formatted, highlight red if overdue)
    - Created At
    - Updated At
    - Completed At (if Done)
    - Total Time: sum from time entries (formatted as "Xh Ym")
    - Followers count

    **Tab structure (mat-tab-group):**
    Define 6 tabs with mat-tab labels. Implement the Details tab content in this task. For Comments, Attachments, Time Log, Links, and Timeline tabs, include the mat-tab wrapper with a placeholder comment (e.g., `<!-- Tab content implemented in Task 2 -->`) so the template compiles and the tab scaffold is visible.

    1. **Details tab:** Description (rendered, not editable inline), Custom fields display, Edit button linking to /activities/:id/edit

    **Styles (activity-detail.component.scss) -- header and layout only:**
    - Two-column layout: main content (tabs) left, info sidebar right
    - Status chip colors, priority colors
    - Header layout with back button, title, chips, and action buttons
    - Info sidebar card styling
    - Responsive: stack sidebar below tabs on small screens
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds.
    Activity detail component files exist with header, sidebar, status controls, follow button, and 6 tab scaffolds (Details tab has content, other 5 have placeholder comments).
  </verify>
  <done>Activity detail page renders header with subject/type/priority/status chips, status workflow transition buttons showing only valid transitions, follow/unfollow toggle, info sidebar with all metadata fields, and a 6-tab layout with the Details tab fully implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Sub-entity tabs (Comments, Attachments, Time Log, Links, Timeline) and tab styles</name>
  <files>
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.ts
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.html
    globcrm-web/src/app/features/activities/activity-detail/activity-detail.component.scss
  </files>
  <action>
    Fill in the 5 remaining tab contents in the activity-detail component created by Task 1, and add all tab content styles. Replace the placeholder comments in each mat-tab with full implementations.

    **Comments tab (ACTV-05):**
    - List of comments ordered by CreatedAt (newest first)
    - Each comment shows: author name, avatar initials, timestamp, content
    - Edit button (mat-icon-button) visible only for comment author (authorId == currentUserId)
    - Delete button visible for author or admin
    - "Add comment" form at top: mat-form-field with textarea + Submit button
    - On add: call activityService.addComment(activityId, content), reload detail
    - On edit: inline edit (toggle textarea editable), call activityService.updateComment
    - On delete: confirm dialog, call activityService.deleteComment

    **Attachments tab (ACTV-06):**
    - List of attachments as cards: fileName, fileSize (formatted), uploadedBy, uploadedAt
    - Download button: calls activityService.downloadAttachment, triggers browser download
    - Delete button: visible for uploader or admin, calls activityService.deleteAttachment
    - Upload area: file input (hidden) + "Upload File" button. Validate max 25MB on client before upload (show snackbar error if exceeded). Show progress indicator during upload. Call activityService.uploadAttachment(id, file). Reload detail on success.

    **Time Log tab (ACTV-07):**
    - Table of time entries: date, duration (formatted "Xh Ym"), description, logged by
    - Total time summary at top
    - "Log Time" form: duration (number input, minutes), description (text), date (datepicker defaulting to today)
    - On submit: call activityService.addTimeEntry(id, request), reload detail
    - Delete button on each entry (user's own entries only)

    **Links tab (ACTV-12):**
    - List of linked entities grouped by entityType: Companies, Contacts, Deals
    - Each link shows: entityName as a clickable link (navigates to /companies/:id, /contacts/:id, /deals/:id), entityType badge, linkedAt timestamp
    - Unlink button (mat-icon-button with "link_off") calls activityService.deleteLink
    - "Link Entity" inline search panel following deal-detail pattern: type selector (Company/Contact/Deal), search input with debounce, results dropdown, click to link

    **Timeline tab (ACTV-08):**
    - Render timeline entries from ActivityService.getTimeline response
    - Use CSS-only timeline layout with vertical connector lines (same pattern as entity-timeline from Phase 3)
    - Each entry shows: icon (varies by type), description, user name, timestamp
    - Event type icons: created (add_circle), status_changed (swap_horiz), comment_added (comment), attachment_uploaded (attach_file), time_logged (schedule), entity_linked (link)

    **Add component class methods** for all tab operations:
    - Comment methods: addComment(), startEditComment(id), saveEditComment(id), deleteComment(id)
    - Attachment methods: onFileSelected(event), uploadAttachment(), downloadAttachment(id), deleteAttachment(id)
    - Time entry methods: addTimeEntry(), deleteTimeEntry(id)
    - Link methods: searchEntities(), linkEntity(type, id), unlinkEntity(linkId)
    - Add necessary form controls: commentForm (FormControl), editCommentContent signal/map, timeEntryForm (FormGroup with duration, description, date), linkSearchControl (FormControl), linkTypeControl, linkSearchResults signal

    **Styles (activity-detail.component.scss) -- tab content styles:**
    - Comments list with avatar initials, content, action buttons, and inline edit textarea
    - Attachment cards with file info, download/delete buttons
    - Time log table with striped rows and total summary
    - Links list grouped by entity type with entity badges and unlink button
    - Timeline styling with vertical connector lines, type-specific icon colors
    - Link search panel dropdown styling
    - provideNativeDateAdapter at component level for time log datepicker
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds.
    All 6 tabs have full content: Details (from Task 1), Comments with add/edit/delete, Attachments with upload/download/delete, Time Log with add/delete, Links with inline search, Timeline with 6 event type icons.
  </verify>
  <done>All 5 sub-entity tabs are fully implemented with CRUD operations: Comments (add, inline edit, delete with author/admin checks), Attachments (upload with 25MB validation, download, delete), Time Log (add with duration/date/description form, delete own entries), Links (grouped list with inline entity search and unlink), Timeline (chronological events with type-specific icons). All tab content styles are complete.</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- Detail page loads activity with all child collections
- Status transition buttons show only valid transitions
- Comments: add, edit (author only), delete (author/admin)
- Attachments: upload (25MB limit), download, delete (uploader/admin)
- Time entries: add with duration/date/description, delete (own only)
- Links: add via inline search, navigate to linked entity, remove link
- Timeline: chronological events with type-specific icons
- Follow button toggles correctly
</verification>

<success_criteria>
- Most complex detail page in the CRM renders all sub-entity tabs
- Workflow status controls enforce allowed transitions client-side
- Follow/unfollow toggle works (ACTV-10)
- All 5 sub-entity types have working CRUD in their respective tabs
- Timeline aggregates 6 event types for audit trail (ACTV-08)
- Entity links navigate to target entity detail pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-07-SUMMARY.md`
</output>
