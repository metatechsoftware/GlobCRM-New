---
phase: 05-activities-and-workflow
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/GlobCRM.Api/Controllers/ActivitiesController.cs
  - src/GlobCRM.Domain/Entities/ActivityWorkflow.cs
autonomous: true

must_haves:
  truths:
    - "ActivitiesController provides CRUD endpoints for activities"
    - "Status transition endpoint validates allowed transitions via ActivityWorkflow static map"
    - "Status changes create ActivityStatusHistory records and set CompletedAt on Done"
    - "Timeline endpoint aggregates creation, status changes, comments, attachments, time entries, links"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/ActivitiesController.cs"
      provides: "Activity REST API with CRUD, status transitions, and timeline"
      exports: ["GET /api/activities", "POST /api/activities", "PATCH /api/activities/{id}/status", "GET /api/activities/{id}/timeline"]
    - path: "src/GlobCRM.Domain/Entities/ActivityWorkflow.cs"
      provides: "Static workflow transition validation"
      contains: "CanTransition"
  key_links:
    - from: "ActivitiesController.cs"
      to: "IActivityRepository.cs"
      via: "constructor injection"
      pattern: "IActivityRepository"
    - from: "ActivitiesController.cs"
      to: "ActivityWorkflow.cs"
      via: "status transition validation"
      pattern: "ActivityWorkflow.CanTransition"
---

<objective>
Create the ActivitiesController with core CRUD endpoints, status transition with workflow validation, and timeline aggregation.

Purpose: Provide the primary API for activity management (ACTV-01, ACTV-03, ACTV-04, ACTV-08, ACTV-09, ACTV-11, ACTV-14). The controller handles activity lifecycle and the fixed workflow state machine. Sub-resource endpoints (comments, attachments, time entries, links, followers) are added in Plan 05-04.
Output: ActivitiesController with ~10 endpoints and ActivityWorkflow static validation class.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@src/GlobCRM.Api/Controllers/DealsController.cs
@src/GlobCRM.Api/Controllers/CompaniesController.cs

# Prior plan summaries
@.planning/phases/05-activities-and-workflow/05-01-SUMMARY.md
@.planning/phases/05-activities-and-workflow/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityWorkflow validation class</name>
  <files>
    src/GlobCRM.Domain/Entities/ActivityWorkflow.cs
  </files>
  <action>
    Create **ActivityWorkflow.cs** in src/GlobCRM.Domain/Entities/ as a static class:

    ```csharp
    public static class ActivityWorkflow
    {
        private static readonly Dictionary<ActivityStatus, ActivityStatus[]> AllowedTransitions = new()
        {
            [ActivityStatus.Assigned] = [ActivityStatus.Accepted, ActivityStatus.InProgress, ActivityStatus.Done],
            [ActivityStatus.Accepted] = [ActivityStatus.InProgress, ActivityStatus.Done],
            [ActivityStatus.InProgress] = [ActivityStatus.Review, ActivityStatus.Done, ActivityStatus.Assigned],
            [ActivityStatus.Review] = [ActivityStatus.Done, ActivityStatus.InProgress],
            [ActivityStatus.Done] = [ActivityStatus.InProgress],
        };

        public static bool CanTransition(ActivityStatus from, ActivityStatus to)
        {
            return AllowedTransitions.TryGetValue(from, out var allowed) && allowed.Contains(to);
        }

        public static ActivityStatus[] GetAllowedTransitions(ActivityStatus from)
        {
            return AllowedTransitions.TryGetValue(from, out var allowed) ? allowed : [];
        }
    }
    ```
  </action>
  <verify>`dotnet build src/GlobCRM.Domain/` succeeds.</verify>
  <done>ActivityWorkflow provides static transition validation with CanTransition and GetAllowedTransitions methods.</done>
</task>

<task type="auto">
  <name>Task 2: Create ActivitiesController with CRUD, status transition, Kanban data, and timeline</name>
  <files>
    src/GlobCRM.Api/Controllers/ActivitiesController.cs
  </files>
  <action>
    Create **ActivitiesController.cs** following DealsController pattern with these endpoints:

    **CRUD Endpoints:**

    1. **GET /api/activities** (list) - Permission: Activity:View. Accept EntityQueryParams (page, pageSize, sortBy, sortDir, filters[]). Also accept optional `linkedEntityType` and `linkedEntityId` query params for entity-scoped queries (ACTV-13). Call repository.GetPagedAsync with ownership scope. Map to ActivityListDto (id, subject, type, status, priority, dueDate, ownerName, assignedToName, customFields, createdAt, updatedAt). Return PagedResult<ActivityListDto>.

    2. **GET /api/activities/{id}** (detail) - Permission: Activity:View. Call repository.GetByIdWithDetailsAsync. Check ownership scope with IsWithinScope helper. Map to ActivityDetailDto (extends ListDto with description, completedAt, ownerId, assignedToId, comments[], attachments[], timeEntries[], followers[], links[], totalTimeMinutes). Calculate totalTimeMinutes from TimeEntries.Sum(te => te.DurationMinutes).

    3. **POST /api/activities** (create) - Permission: Activity:Create. Accept CreateActivityRequest {subject, description?, type, priority, dueDate?, assignedToId?, customFields?}. Validate with FluentValidation: subject required (3-500 chars), type must be valid ActivityType enum string, priority must be valid ActivityPriority enum string. Set OwnerId from JWT claims (current user). Set Status = ActivityStatus.Assigned (always starts as Assigned). Set TenantId from tenant context. Return 201 with ActivityDetailDto.

    4. **PUT /api/activities/{id}** (update) - Permission: Activity:Update. Accept UpdateActivityRequest {subject, description?, type, priority, dueDate?, assignedToId?, customFields?}. Validate ownership scope. Do NOT allow changing Status via PUT (use PATCH status endpoint). Update fields and UpdatedAt. Return ActivityDetailDto.

    5. **DELETE /api/activities/{id}** - Permission: Activity:Delete. Validate ownership scope. Delete activity (cascade deletes all children). Return 204.

    **Status Transition:**

    6. **PATCH /api/activities/{id}/status** - Permission: Activity:Update. Accept {status: string}. Parse to ActivityStatus enum. Validate transition via ActivityWorkflow.CanTransition(current, new). If invalid, return 400 with "Cannot transition from {current} to {new}". Create ActivityStatusHistory record (FromStatus, ToStatus, ChangedByUserId, ChangedAt). If transitioning TO Done, set CompletedAt = now. If transitioning FROM Done, clear CompletedAt. Update activity status. Return 204.

    **Kanban Data:**

    7. **GET /api/activities/kanban** - Permission: Activity:View. Call repository.GetByStatusGroupAsync with ownership scope. Group activities by Status. Return KanbanDto with status columns and activity cards (id, subject, type, priority, dueDate, assignedToName, ownerName).

    **Timeline:**

    8. **GET /api/activities/{id}/timeline** - Permission: Activity:View. Build timeline by aggregating:
       - Entity creation event (Activity.CreatedAt, type: "created")
       - Status changes (from ActivityStatusHistory, type: "status_changed", include fromStatus, toStatus, changedByName)
       - Comments (from ActivityComment, type: "comment_added", include content snippet, authorName)
       - Attachments (from ActivityAttachment, type: "attachment_uploaded", include fileName, uploadedByName)
       - Time entries (from ActivityTimeEntry, type: "time_logged", include duration, description, userName)
       - Entity links (from ActivityLink, type: "entity_linked", include entityType, entityName)
       Sort all entries by timestamp descending. Return as List<TimelineEntry> (reuse TimelineEntry type pattern from Company/Deal timeline but with activity-specific types).

    **Allowed Transitions:**

    9. **GET /api/activities/{id}/allowed-transitions** - Permission: Activity:View. Return ActivityWorkflow.GetAllowedTransitions(activity.Status) as string array. Frontend uses this to show valid drop targets on Kanban.

    **DTO Classes:** Define all DTOs as nested records/classes within the controller file or as a separate ActivitiesController file section, following DealsController pattern. Include:
    - ActivityListDto, ActivityDetailDto
    - ActivityCommentDto (id, content, authorName, authorId, createdAt, updatedAt)
    - ActivityAttachmentDto (id, fileName, contentType, fileSizeBytes, uploadedByName, uploadedAt)
    - ActivityTimeEntryDto (id, durationMinutes, description, entryDate, userName, createdAt)
    - ActivityFollowerDto (userId, userName, followedAt)
    - ActivityLinkDto (id, entityType, entityId, entityName, linkedAt)
    - CreateActivityRequest, UpdateActivityRequest, UpdateActivityStatusRequest
    - ActivityKanbanDto, ActivityKanbanColumnDto, ActivityKanbanCardDto

    **Authorization:** Use [Authorize(Policy = "Permission:Activity:View/Create/Update/Delete")] on each endpoint, not at controller level (Activity is not admin-only like Pipeline).

    **Helper methods:** Reuse GetCurrentUserId(), GetTeamMemberIds(), IsWithinScope() pattern from DealsController/CompaniesController.
  </action>
  <verify>
    `dotnet build` succeeds.
    ActivitiesController has 9 endpoints (5 CRUD + status + kanban + timeline + allowed-transitions).
  </verify>
  <done>ActivitiesController provides complete activity CRUD with workflow state machine validation, Kanban data grouping, timeline aggregation, and entity-scoped listing.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- All 9 endpoints compile and follow authorization patterns
- Status transition validates via ActivityWorkflow.CanTransition
- Timeline aggregates 6 event types from child entities
- Entity-scoped listing supports linkedEntityType + linkedEntityId params
</verification>

<success_criteria>
- CRUD endpoints follow CompaniesController/DealsController conventions
- Workflow state machine prevents invalid transitions (400 on disallowed)
- Status changes create audit trail (ActivityStatusHistory)
- CompletedAt set/cleared automatically on Done transitions
- Timeline provides comprehensive audit view (ACTV-08)
- Kanban data groups activities by fixed workflow status
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-03-SUMMARY.md`
</output>
