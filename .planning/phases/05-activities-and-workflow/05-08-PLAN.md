---
phase: 05-activities-and-workflow
plan: 08
type: execute
wave: 6
depends_on: ["05-06"]
files_modified:
  - globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.ts
  - globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.html
  - globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.scss
autonomous: true

must_haves:
  truths:
    - "Activity Kanban board displays fixed workflow columns (Assigned, Accepted, In Progress, Review, Done)"
    - "Cards show activity subject, type icon, priority color, due date, and assignee"
    - "Drag-and-drop moves activities between columns with optimistic UI update"
    - "Invalid transitions are prevented (card reverts to original column)"
  artifacts:
    - path: "globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.ts"
      provides: "Activity Kanban board with CDK drag-drop"
      contains: "ActivityKanbanComponent"
  key_links:
    - from: "activity-kanban.component.ts"
      to: "activity.service.ts"
      via: "service injection for Kanban data and status updates"
      pattern: "inject.*ActivityService"
    - from: "activity-kanban.component.ts"
      to: "CdkDragDrop"
      via: "CDK drag-drop for column transitions"
      pattern: "CdkDragDrop"
---

<objective>
Create the Activity Kanban board with fixed workflow columns and CDK drag-drop for status transitions.

Purpose: Implement ACTV-09 (board/Kanban view) using the fixed workflow columns (Assigned through Done). Reuses the exact CDK drag-drop pattern from the Deal Kanban board, but with static columns instead of dynamic pipeline stages.
Output: Activity Kanban component with drag-drop status transitions and optimistic UI updates.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern reference (primary)
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.html
@globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss

# Prior plan summaries
@.planning/phases/05-activities-and-workflow/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Activity Kanban board with CDK drag-drop</name>
  <files>
    globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.ts
    globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.html
    globcrm-web/src/app/features/activities/activity-kanban/activity-kanban.component.scss
  </files>
  <action>
    Create **activity-kanban** component following deal-kanban pattern:

    **Key differences from Deal Kanban:**
    - No pipeline selector (fixed workflow columns)
    - Columns are static from ACTIVITY_STATUSES constant (not loaded from API)
    - Transition validation before drop (ALLOWED_TRANSITIONS check)
    - Color-coded priority on cards instead of deal value

    **Component class (activity-kanban.component.ts):**
    - Standalone component
    - Import CdkDragDrop, CdkDropList, CdkDropListGroup, CdkDrag, moveItemInArray, transferArrayItem
    - Inject ActivityService, Router, MatSnackBar
    - On init: call ActivityService.getKanban() to load all activities grouped by status
    - Store columns as signal: `columns: WritableSignal<ActivityKanbanColumnDto[]>` initialized from ACTIVITY_STATUSES with empty activities arrays
    - Populate columns from Kanban API response

    **View mode switcher:** Same mat-button-toggle-group as list page. Kanban is active mode. List links to /activities, Calendar links to /activities/calendar.

    **Kanban layout:**
    - cdkDropListGroup wrapping all columns
    - Each column: cdkDropList with column status as ID
    - Column header: status label + count badge + status color strip at top
    - Each card: cdkDrag with activity data

    **Card content:**
    - Subject (truncated to ~60 chars)
    - Type icon (from ACTIVITY_TYPES -- task_alt, phone, groups)
    - Priority chip (color from ACTIVITY_PRIORITIES)
    - Due date (if set, formatted, red if overdue)
    - Assigned to name (small text)
    - Click card -> navigate to /activities/:id

    **Drop handler:**
    ```typescript
    onDrop(event: CdkDragDrop<ActivityKanbanCardDto[]>) {
      if (event.previousContainer === event.container) {
        // Same column reorder (no status change needed)
        moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
        return;
      }

      const activity = event.previousContainer.data[event.previousIndex];
      const fromStatus = event.previousContainer.id as ActivityStatus;
      const toStatus = event.container.id as ActivityStatus;

      // Client-side transition validation
      if (!ALLOWED_TRANSITIONS[fromStatus]?.includes(toStatus)) {
        this.snackBar.open(`Cannot move from ${fromStatus} to ${toStatus}`, 'OK', { duration: 3000 });
        return;
      }

      // Optimistic update: move card immediately
      transferArrayItem(event.previousContainer.data, event.container.data, event.previousIndex, event.currentIndex);

      // API call
      this.activityService.updateStatus(activity.id, toStatus).subscribe({
        error: () => {
          // Revert on failure
          transferArrayItem(event.container.data, event.previousContainer.data, event.currentIndex, event.previousIndex);
          this.snackBar.open('Failed to update status', 'OK', { duration: 3000 });
        }
      });
    }
    ```

    **Styles (activity-kanban.component.scss):**
    - Horizontal scrollable column layout (flex, overflow-x: auto)
    - Each column: fixed width (~280px), flex column, min-height for drop target
    - Column header with color strip (5px top border using status color)
    - Cards: mat-card with shadow, rounded corners, compact padding
    - Priority color indicator on left edge of card (4px left border)
    - Drag placeholder: dashed border, light background
    - CDK drag animations (cdk-drag-animating transition)
    - Overdue date highlighting (red text)
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds.
    Activity Kanban component files exist.
  </verify>
  <done>Activity Kanban board renders 5 fixed workflow columns with drag-drop status transitions, client-side transition validation, optimistic updates with error revert, and priority-colored activity cards.</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- Kanban renders 5 columns (Assigned through Done) from ACTIVITY_STATUSES
- Cards display subject, type icon, priority color, due date, assignee
- Drag-drop calls ActivityService.updateStatus with optimistic UI
- Invalid transitions show snackbar error and prevent card move
- Card click navigates to activity detail page
</verification>

<success_criteria>
- Fixed workflow columns (no pipeline selector needed)
- CDK drag-drop with transferArrayItem and moveItemInArray
- Client-side ALLOWED_TRANSITIONS validation before API call
- Optimistic update pattern: move immediately, revert on error
- View mode switcher links to list and calendar views
- Cards show relevant info: subject, type, priority, due date, assignee
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-08-SUMMARY.md`
</output>
