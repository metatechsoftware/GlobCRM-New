---
phase: 05-activities-and-workflow
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/activities/activity.models.ts
  - globcrm-web/src/app/features/activities/activity.service.ts
  - globcrm-web/src/app/features/activities/activity.store.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript models cover all activity DTOs (list, detail, create, update, comments, attachments, time entries, links, followers, Kanban)"
    - "ActivityService provides API methods for all 21 controller endpoints"
    - "ActivityStore manages list and detail state with pagination, filtering, and status grouping"
  artifacts:
    - path: "globcrm-web/src/app/features/activities/activity.models.ts"
      provides: "Activity TypeScript interfaces"
      contains: "ActivityListDto"
    - path: "globcrm-web/src/app/features/activities/activity.service.ts"
      provides: "Activity API service"
      contains: "class ActivityService"
    - path: "globcrm-web/src/app/features/activities/activity.store.ts"
      provides: "Activity signal store"
      contains: "ActivityStore"
  key_links:
    - from: "activity.service.ts"
      to: "ApiService"
      via: "HTTP client injection"
      pattern: "inject.*ApiService"
    - from: "activity.store.ts"
      to: "activity.service.ts"
      via: "service injection for data fetching"
      pattern: "inject.*ActivityService"
---

<objective>
Create the frontend data layer for Activities: TypeScript models, API service, and NgRx signal store.

Purpose: Establish the complete frontend foundation that all activity UI components depend on. This plan runs in Wave 1 (parallel with Plan 01 backend entities) since it has no backend dependency -- it defines the contract the API will fulfill.
Output: activity.models.ts, activity.service.ts, activity.store.ts in the activities feature directory.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@globcrm-web/src/app/features/deals/deal.models.ts
@globcrm-web/src/app/features/deals/deal.service.ts
@globcrm-web/src/app/features/deals/deal.store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Activity TypeScript models and API service</name>
  <files>
    globcrm-web/src/app/features/activities/activity.models.ts
    globcrm-web/src/app/features/activities/activity.service.ts
  </files>
  <action>
    Create the **activities** feature directory: `globcrm-web/src/app/features/activities/`

    Create **activity.models.ts** with these TypeScript interfaces following deal.models.ts pattern:

    ```typescript
    // Enums as string literal unions
    export type ActivityType = 'Task' | 'Call' | 'Meeting';
    export type ActivityStatus = 'Assigned' | 'Accepted' | 'InProgress' | 'Review' | 'Done';
    export type ActivityPriority = 'Low' | 'Medium' | 'High' | 'Urgent';

    // Workflow constants
    export const ACTIVITY_STATUSES: { value: ActivityStatus; label: string; color: string }[] = [
      { value: 'Assigned', label: 'Assigned', color: '#2196f3' },
      { value: 'Accepted', label: 'Accepted', color: '#ff9800' },
      { value: 'InProgress', label: 'In Progress', color: '#9c27b0' },
      { value: 'Review', label: 'Review', color: '#00bcd4' },
      { value: 'Done', label: 'Done', color: '#4caf50' },
    ];

    export const ACTIVITY_TYPES: { value: ActivityType; label: string; icon: string }[] = [
      { value: 'Task', label: 'Task', icon: 'task_alt' },
      { value: 'Call', label: 'Call', icon: 'phone' },
      { value: 'Meeting', label: 'Meeting', icon: 'groups' },
    ];

    export const ACTIVITY_PRIORITIES: { value: ActivityPriority; label: string; color: string }[] = [
      { value: 'Low', label: 'Low', color: '#4caf50' },
      { value: 'Medium', label: 'Medium', color: '#2196f3' },
      { value: 'High', label: 'High', color: '#ff9800' },
      { value: 'Urgent', label: 'Urgent', color: '#f44336' },
    ];

    export const ALLOWED_TRANSITIONS: Record<ActivityStatus, ActivityStatus[]> = {
      Assigned: ['Accepted', 'InProgress', 'Done'],
      Accepted: ['InProgress', 'Done'],
      InProgress: ['Review', 'Done', 'Assigned'],
      Review: ['Done', 'InProgress'],
      Done: ['InProgress'],
    };

    // List DTO (lightweight for table/Kanban/calendar)
    export interface ActivityListDto { ... } // id, subject, type, status, priority, dueDate, ownerName, assignedToName, customFields, createdAt, updatedAt

    // Detail DTO (full load for detail page)
    export interface ActivityDetailDto extends ActivityListDto { ... } // description, completedAt, ownerId, assignedToId, comments, attachments, timeEntries, followers, links, totalTimeMinutes

    // Sub-entity DTOs
    export interface ActivityCommentDto { ... } // id, content, authorName, authorId, createdAt, updatedAt
    export interface ActivityAttachmentDto { ... } // id, fileName, contentType, fileSizeBytes, uploadedByName, uploadedAt
    export interface ActivityTimeEntryDto { ... } // id, durationMinutes, description, entryDate, userName, createdAt
    export interface ActivityFollowerDto { ... } // userId, userName, followedAt
    export interface ActivityLinkDto { ... } // id, entityType, entityId, entityName, linkedAt

    // Kanban DTOs
    export interface ActivityKanbanDto { columns: ActivityKanbanColumnDto[] }
    export interface ActivityKanbanColumnDto { status: ActivityStatus; label: string; color: string; activities: ActivityKanbanCardDto[] }
    export interface ActivityKanbanCardDto { ... } // id, subject, type, priority, dueDate, assignedToName, ownerName

    // Request DTOs
    export interface CreateActivityRequest { ... } // subject, description?, type, priority, dueDate?, assignedToId?, customFields?
    export interface UpdateActivityRequest { ... } // same as create
    export interface UpdateActivityStatusRequest { status: string }
    export interface CreateCommentRequest { content: string }
    export interface CreateTimeEntryRequest { durationMinutes: number; description?: string; entryDate: string }
    export interface CreateLinkRequest { entityType: string; entityId: string; entityName?: string }
    ```

    Create **activity.service.ts** as an Injectable service following deal.service.ts pattern:

    Methods (matching all controller endpoints):
    - `getList(params)` - GET /api/activities with EntityQueryParams + optional linkedEntityType/linkedEntityId
    - `getById(id)` - GET /api/activities/{id}
    - `create(request)` - POST /api/activities
    - `update(id, request)` - PUT /api/activities/{id}
    - `delete(id)` - DELETE /api/activities/{id}
    - `updateStatus(id, status)` - PATCH /api/activities/{id}/status
    - `getAllowedTransitions(id)` - GET /api/activities/{id}/allowed-transitions
    - `getKanban()` - GET /api/activities/kanban
    - `getTimeline(id)` - GET /api/activities/{id}/timeline
    - `addComment(id, content)` - POST /api/activities/{id}/comments
    - `updateComment(id, commentId, content)` - PUT /api/activities/{id}/comments/{commentId}
    - `deleteComment(id, commentId)` - DELETE /api/activities/{id}/comments/{commentId}
    - `uploadAttachment(id, file)` - POST /api/activities/{id}/attachments (FormData)
    - `downloadAttachment(id, attachmentId)` - GET /api/activities/{id}/attachments/{attachmentId}/download (blob response)
    - `deleteAttachment(id, attachmentId)` - DELETE /api/activities/{id}/attachments/{attachmentId}
    - `addTimeEntry(id, request)` - POST /api/activities/{id}/time-entries
    - `deleteTimeEntry(id, entryId)` - DELETE /api/activities/{id}/time-entries/{entryId}
    - `addLink(id, request)` - POST /api/activities/{id}/links
    - `deleteLink(id, linkId)` - DELETE /api/activities/{id}/links/{linkId}
    - `follow(id)` - POST /api/activities/{id}/followers
    - `unfollow(id)` - DELETE /api/activities/{id}/followers

    Use ApiService for all HTTP calls. Build query params the same way DealService does.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds (or only type errors from missing imports, not structural issues).
    activity.models.ts and activity.service.ts exist.
  </verify>
  <done>Activity models define all DTOs and request types, ActivityService provides 21 API methods matching all controller endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Create ActivityStore NgRx signal store</name>
  <files>
    globcrm-web/src/app/features/activities/activity.store.ts
  </files>
  <action>
    Create **activity.store.ts** following DealStore pattern (component-provided, not root):

    State interface:
    ```typescript
    interface ActivityState {
      items: ActivityListDto[];
      selectedActivity: ActivityDetailDto | null;
      totalCount: number;
      page: number;
      pageSize: number;
      sortBy: string;
      sortDir: 'asc' | 'desc';
      filters: FilterParam[];
      isLoading: boolean;
      error: string | null;
    }
    ```

    Initial state: items [], selectedActivity null, totalCount 0, page 1, pageSize 25, sortBy 'createdAt', sortDir 'desc', filters [], isLoading false, error null.

    Computed signals:
    - `isEmpty`: items.length === 0 && !isLoading
    - `hasSelected`: selectedActivity !== null

    Methods:
    - `loadList()`: Call activityService.getList with current page/pageSize/sortBy/sortDir/filters. Set items and totalCount from response.
    - `loadById(id)`: Call activityService.getById. Set selectedActivity.
    - `setPage(page)`: Update page, call loadList.
    - `setPageSize(size)`: Update pageSize, reset page to 1, call loadList.
    - `setSort(sortBy, sortDir)`: Update sort, call loadList.
    - `setFilters(filters)`: Update filters, reset page to 1, call loadList.
    - `clearSelection()`: Set selectedActivity to null.

    Follow the exact withState/withComputed/withMethods pattern from DealStore. The store is component-provided (not providedIn: 'root') per established pattern.
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` succeeds.
    activity.store.ts exports ActivityStore.
  </verify>
  <done>ActivityStore provides reactive list and detail state management with pagination, sorting, filtering, following DealStore conventions.</done>
</task>

</tasks>

<verification>
- Angular build succeeds
- activity.models.ts defines all DTOs matching backend controller response shapes
- activity.service.ts provides 21 API methods for complete activity API coverage
- activity.store.ts follows component-provided signal store pattern
- ALLOWED_TRANSITIONS constant mirrors backend ActivityWorkflow for client-side validation
</verification>

<success_criteria>
- All TypeScript interfaces match the backend DTOs from Plans 03-04
- Service covers every controller endpoint including sub-resource CRUD
- Store manages list/detail state with pagination and filtering
- Constants for statuses, types, priorities, and transitions defined for reuse across UI components
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-05-SUMMARY.md`
</output>
