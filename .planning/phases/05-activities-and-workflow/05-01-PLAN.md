---
phase: 05-activities-and-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Activity.cs
  - src/GlobCRM.Domain/Entities/ActivityComment.cs
  - src/GlobCRM.Domain/Entities/ActivityAttachment.cs
  - src/GlobCRM.Domain/Entities/ActivityTimeEntry.cs
  - src/GlobCRM.Domain/Entities/ActivityFollower.cs
  - src/GlobCRM.Domain/Entities/ActivityLink.cs
  - src/GlobCRM.Domain/Entities/ActivityStatusHistory.cs
  - src/GlobCRM.Domain/Enums/ActivityType.cs
  - src/GlobCRM.Domain/Enums/ActivityStatus.cs
  - src/GlobCRM.Domain/Enums/ActivityPriority.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityCommentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityAttachmentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityTimeEntryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityFollowerConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityLinkConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityStatusHistoryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Activity entity exists with Subject, Description, Type, Status, Priority, DueDate, OwnerId, AssignedToId, CustomFields"
    - "Six child entities exist: Comment, Attachment, TimeEntry, Follower, Link, StatusHistory"
    - "Three enums define ActivityType (Task/Call/Meeting), ActivityStatus (Assigned-Done), ActivityPriority (Low-Urgent)"
    - "Database migration creates all 8 tables with proper FK constraints and GIN index on custom_fields"
    - "RLS policy isolates activities by tenant"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Activity.cs"
      provides: "Activity entity with workflow status and custom fields"
      contains: "public class Activity"
    - path: "src/GlobCRM.Domain/Enums/ActivityStatus.cs"
      provides: "Fixed workflow states enum"
      contains: "Assigned"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and query filter for Activity"
      contains: "DbSet<Activity>"
    - path: "scripts/rls-setup.sql"
      provides: "RLS policy for activities table"
      contains: "activities"
  key_links:
    - from: "ActivityConfiguration.cs"
      to: "Activity.cs"
      via: "EF Core entity type configuration"
      pattern: "IEntityTypeConfiguration<Activity>"
    - from: "ApplicationDbContext.cs"
      to: "Activity.cs"
      via: "DbSet registration and query filter"
      pattern: "DbSet<Activity>"
---

<objective>
Create all Activity domain entities, enums, EF Core configurations, database migration, and RLS policies.

Purpose: Establish the complete data model for the Activity feature (7 entity types + 3 enums), following the exact patterns from Phase 4 Deal entities. This is the backend foundation that all subsequent plans depend on.
Output: 7 entity classes, 3 enum types, 7 EF Core configurations, updated ApplicationDbContext, RLS script, and a database migration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references (read these for exact conventions)
@src/GlobCRM.Domain/Entities/Deal.cs
@src/GlobCRM.Domain/Entities/DealStageHistory.cs
@src/GlobCRM.Domain/Entities/DealContact.cs
@src/GlobCRM.Domain/Entities/DealProduct.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DealStageHistoryConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Activity domain entities and enums</name>
  <files>
    src/GlobCRM.Domain/Enums/ActivityType.cs
    src/GlobCRM.Domain/Enums/ActivityStatus.cs
    src/GlobCRM.Domain/Enums/ActivityPriority.cs
    src/GlobCRM.Domain/Entities/Activity.cs
    src/GlobCRM.Domain/Entities/ActivityComment.cs
    src/GlobCRM.Domain/Entities/ActivityAttachment.cs
    src/GlobCRM.Domain/Entities/ActivityTimeEntry.cs
    src/GlobCRM.Domain/Entities/ActivityFollower.cs
    src/GlobCRM.Domain/Entities/ActivityLink.cs
    src/GlobCRM.Domain/Entities/ActivityStatusHistory.cs
  </files>
  <action>
    Create 3 enum files in src/GlobCRM.Domain/Enums/:

    1. **ActivityType.cs**: Task, Call, Meeting
    2. **ActivityStatus.cs**: Assigned, Accepted, InProgress, Review, Done
    3. **ActivityPriority.cs**: Low, Medium, High, Urgent

    Create 7 entity files in src/GlobCRM.Domain/Entities/ following the Deal entity pattern exactly:

    4. **Activity.cs**: Main entity with:
       - Id (Guid), TenantId (Guid), Subject (string), Description (string?), Type (ActivityType), Status (ActivityStatus), Priority (ActivityPriority), DueDate (DateTimeOffset?), CompletedAt (DateTimeOffset?), OwnerId (Guid?), AssignedToId (Guid?), CustomFields (Dictionary<string, object?>), IsSeedData (bool), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset)
       - Navigation properties: Owner (ApplicationUser?), AssignedTo (ApplicationUser?)
       - Child collections: Comments, Attachments, TimeEntries, Followers, Links (ICollection)
       - Note: No StatusHistories collection needed on Activity (query separately like DealStageHistory)

    5. **ActivityComment.cs**: Id, ActivityId, Activity, Content (string), AuthorId (Guid?), Author (ApplicationUser?), CreatedAt, UpdatedAt. No TenantId (inherits via Activity FK).

    6. **ActivityAttachment.cs**: Id, ActivityId, Activity, FileName (string), StoragePath (string), ContentType (string), FileSizeBytes (long), UploadedById (Guid?), UploadedBy (ApplicationUser?), UploadedAt (DateTimeOffset). No TenantId.

    7. **ActivityTimeEntry.cs**: Id, ActivityId, Activity, DurationMinutes (decimal), Description (string?), EntryDate (DateOnly), UserId (Guid?), User (ApplicationUser?), CreatedAt. No TenantId.

    8. **ActivityFollower.cs**: Composite key (ActivityId + UserId). ActivityId, Activity, UserId, User (ApplicationUser), FollowedAt (DateTimeOffset). No TenantId.

    9. **ActivityLink.cs**: Id, ActivityId, Activity, EntityType (string "Contact"/"Company"/"Deal"), EntityId (Guid), EntityName (string? -- denormalized for display), LinkedAt (DateTimeOffset). No TenantId. No FK to target entities (polymorphic).

    10. **ActivityStatusHistory.cs**: Id, ActivityId, Activity, FromStatus (ActivityStatus), ToStatus (ActivityStatus), ChangedByUserId (Guid?), ChangedByUser (ApplicationUser?), ChangedAt (DateTimeOffset). No TenantId. Follows DealStageHistory pattern.
  </action>
  <verify>
    `dotnet build src/GlobCRM.Domain/` succeeds with 0 errors.
    All 10 files exist in the expected paths.
  </verify>
  <done>All 7 entity classes and 3 enums compile successfully, following Deal entity conventions for naming, nullability, and child entity patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update DbContext, add RLS, and generate migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityCommentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityAttachmentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityTimeEntryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityFollowerConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityLinkConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ActivityStatusHistoryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create 7 EF Core configuration files following DealConfiguration pattern:

    1. **ActivityConfiguration.cs**: Table "activities", snake_case columns, string conversions for Type/Status/Priority enums (HasConversion<string>), JSONB custom_fields with HasColumnType("jsonb") and HasDefaultValueSql("'{}'::jsonb"), FK to Owner and AssignedTo with SetNull delete, cascade delete to all child collections. Indexes: tenant_id, owner_id, assigned_to_id, status, due_date, GIN on custom_fields.

    2. **ActivityCommentConfiguration.cs**: Table "activity_comments", FK to Activity (Cascade), FK to Author (SetNull). Indexes: activity_id.

    3. **ActivityAttachmentConfiguration.cs**: Table "activity_attachments", FK to Activity (Cascade), FK to UploadedBy (SetNull). FileName max 500, ContentType max 255, StoragePath max 1000.

    4. **ActivityTimeEntryConfiguration.cs**: Table "activity_time_entries", FK to Activity (Cascade), FK to User (SetNull). DurationMinutes decimal(10,2).

    5. **ActivityFollowerConfiguration.cs**: Table "activity_followers", composite PK (ActivityId, UserId), FK to Activity (Cascade), FK to User (Cascade). No Id column.

    6. **ActivityLinkConfiguration.cs**: Table "activity_links", FK to Activity (Cascade). EntityType max 50, EntityName max 500. Index on (ActivityId, EntityType, EntityId) for duplicate prevention.

    7. **ActivityStatusHistoryConfiguration.cs**: Table "activity_status_histories", FK to Activity (Cascade), FK to ChangedByUser (SetNull). String conversions for FromStatus/ToStatus enums. Follows DealStageHistoryConfiguration pattern exactly.

    Update **ApplicationDbContext.cs**:
    - Add 7 DbSets: Activities, ActivityComments, ActivityAttachments, ActivityTimeEntries, ActivityFollowers, ActivityLinks, ActivityStatusHistories
    - Add global query filter for Activity (tenant-scoped): `builder.Entity<Activity>().HasQueryFilter(a => a.TenantId == _tenantProvider.GetTenantId())`
    - Child entities do NOT need query filters (access via Activity FK joins)

    Update **scripts/rls-setup.sql**:
    - Add RLS policy for "activities" table following the exact pattern of deals/pipelines
    - Child tables (activity_comments, activity_attachments, etc.) do NOT need RLS policies (accessed via FK joins from tenant-filtered activities)

    Generate migration:
    - Run `dotnet ef migrations add AddActivities --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext --output-dir Persistence/Migrations/App`
  </action>
  <verify>
    `dotnet build` succeeds (entire solution).
    Migration file exists in src/GlobCRM.Infrastructure/Persistence/Migrations/App/.
    ApplicationDbContext has all 7 new DbSets.
    scripts/rls-setup.sql contains "activities" RLS policy.
  </verify>
  <done>All 7 EF Core configurations follow DealConfiguration conventions, ApplicationDbContext has Activity DbSets with tenant query filter, RLS policy covers activities table, and migration is generated successfully.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- Migration file exists and contains CREATE TABLE for all 8 activity-related tables
- Activity entity has all fields from research spec (Subject, Description, Type, Status, Priority, DueDate, CompletedAt, OwnerId, AssignedToId, CustomFields)
- Child entities have no TenantId (inherit via Activity FK)
- RLS policy for activities table in scripts/rls-setup.sql
</verification>

<success_criteria>
- 7 domain entities and 3 enums compile successfully
- 7 EF Core configurations with snake_case naming, proper FK constraints, cascade rules
- ApplicationDbContext has 7 new DbSets and Activity query filter
- RLS policy for activities table
- Migration generated creating all 8 tables
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-01-SUMMARY.md`
</output>
