---
phase: 05-activities-and-workflow
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - src/GlobCRM.Api/Controllers/ActivitiesController.cs
autonomous: true

must_haves:
  truths:
    - "Users can add and list comments on activities"
    - "Users can upload and delete file attachments on activities"
    - "Users can log time entries on activities"
    - "Users can link and unlink activities to contacts, companies, and deals"
    - "Users can follow and unfollow activities"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/ActivitiesController.cs"
      provides: "Sub-resource endpoints for comments, attachments, time entries, links, followers"
      exports: ["POST /api/activities/{id}/comments", "POST /api/activities/{id}/attachments", "POST /api/activities/{id}/time-entries", "POST /api/activities/{id}/links", "POST /api/activities/{id}/followers"]
  key_links:
    - from: "ActivitiesController.cs (attachments)"
      to: "IFileStorageService"
      via: "constructor injection for file upload/delete"
      pattern: "IFileStorageService"
---

<objective>
Add sub-resource endpoints to ActivitiesController for comments, attachments, time entries, entity links, and followers.

Purpose: Complete the activity API surface for ACTV-05 (comments), ACTV-06 (attachments), ACTV-07 (time tracking), ACTV-10 (follow/watch), and ACTV-12 (entity linking). All are nested routes under /api/activities/{id}/.
Output: ~12 additional endpoints added to the existing ActivitiesController.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@src/GlobCRM.Api/Controllers/DealsController.cs

# Prior plan summaries
@.planning/phases/05-activities-and-workflow/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comment, time entry, and follower endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/ActivitiesController.cs
  </files>
  <action>
    Add the following nested resource endpoints to the existing ActivitiesController:

    **Comments (ACTV-05):**

    1. **POST /api/activities/{id}/comments** - Permission: Activity:Update. Accept {content: string}. Validate content not empty (1-5000 chars). Create ActivityComment with AuthorId from JWT. Return 201 with ActivityCommentDto.

    2. **PUT /api/activities/{id}/comments/{commentId}** - Permission: Activity:Update. Accept {content: string}. Only allow author to edit their own comment (AuthorId == currentUserId, otherwise 403). Update content and UpdatedAt. Return ActivityCommentDto.

    3. **DELETE /api/activities/{id}/comments/{commentId}** - Permission: Activity:Update. Only allow author to delete their own comment (or admin). Return 204.

    **Time Entries (ACTV-07):**

    4. **POST /api/activities/{id}/time-entries** - Permission: Activity:Update. Accept {durationMinutes: decimal, description?: string, entryDate: string (DateOnly)}. Validate durationMinutes > 0 and <= 1440 (max 24 hours). Create ActivityTimeEntry with UserId from JWT. Return 201 with ActivityTimeEntryDto.

    5. **DELETE /api/activities/{id}/time-entries/{entryId}** - Permission: Activity:Update. Only allow the user who created the entry to delete it (UserId == currentUserId, or admin). Return 204.

    **Followers (ACTV-10):**

    6. **POST /api/activities/{id}/followers** - Permission: Activity:View (any viewer can follow). Create ActivityFollower with UserId from JWT. If already following, return 200 (idempotent). Return 201 on new follow.

    7. **DELETE /api/activities/{id}/followers** - Permission: Activity:View. Remove ActivityFollower where UserId == currentUserId. Return 204.

    For all sub-resource endpoints: First load the Activity and verify it exists (404 if not). Apply ownership scope check for the parent activity. Inject the necessary services (IFileStorageService was already noted in plan but only used by attachments in Task 2).
  </action>
  <verify>
    `dotnet build` succeeds.
    7 new endpoints compile and use proper authorization policies.
  </verify>
  <done>Comments, time entries, and followers endpoints provide full CRUD for activity sub-resources with author-only edit/delete constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Add attachment upload/download/delete and entity link endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/ActivitiesController.cs
  </files>
  <action>
    Add attachment and entity link endpoints to ActivitiesController:

    **Attachments (ACTV-06):**

    1. **POST /api/activities/{id}/attachments** - Permission: Activity:Update. Accept IFormFile via multipart/form-data. Validate: file not null, file size <= 25MB (25 * 1024 * 1024 bytes), reject dangerous extensions (.exe, .bat, .cmd, .ps1, .sh). Use IFileStorageService to store file at path: `{tenantId}/activities/{activityId}/{Guid}_{originalFileName}`. Create ActivityAttachment record with FileName, StoragePath, ContentType (from file.ContentType), FileSizeBytes, UploadedById from JWT. Return 201 with ActivityAttachmentDto.

    2. **GET /api/activities/{id}/attachments/{attachmentId}/download** - Permission: Activity:View. Load attachment record. Use IFileStorageService to read file stream. Return FileStreamResult with correct ContentType and Content-Disposition: attachment header.

    3. **DELETE /api/activities/{id}/attachments/{attachmentId}** - Permission: Activity:Update. Only allow uploader or admin to delete. Use IFileStorageService to delete file from storage. Remove ActivityAttachment record. Return 204.

    **Entity Links (ACTV-12):**

    4. **POST /api/activities/{id}/links** - Permission: Activity:Update. Accept {entityType: string, entityId: Guid, entityName?: string}. Validate entityType is one of: "Contact", "Company", "Deal" (quotes and requests are Phase 6+, but accept them as strings for forward compatibility). If entityName not provided, look up the entity name from the appropriate repository (CompanyRepository, ContactRepository, DealRepository) for denormalization. Prevent duplicate links (same entityType + entityId on same activity). Return 201 with ActivityLinkDto.

    5. **DELETE /api/activities/{id}/links/{linkId}** - Permission: Activity:Update. Remove the ActivityLink record. Return 204.

    **Important for attachments:** Inject IFileStorageService via constructor. The existing LocalFileStorageService from Phase 2 handles the actual file I/O. Configure ASP.NET Core to accept large file uploads by adding `[RequestSizeLimit(26_214_400)]` (25MB + overhead) on the upload endpoint, or configure in Program.cs via `options.MultipartBodyLengthLimit`.

    **Important for entity links:** Inject ICompanyRepository, IContactRepository, IDealRepository for entity name lookup when entityName is not provided. This ensures denormalized names are accurate.
  </action>
  <verify>
    `dotnet build` succeeds.
    5 new endpoints (3 attachment + 2 link) compile.
    Attachment upload uses IFileStorageService.
    Entity link validates entityType against allowed values.
  </verify>
  <done>Attachment endpoints handle file upload/download/delete with 25MB limit, and entity link endpoints support polymorphic linking to Contact/Company/Deal with name denormalization.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- Total ActivitiesController endpoints: ~21 (9 from Plan 03 + 12 from Plan 04)
- Attachment upload validates file size (25MB max) and stores via IFileStorageService
- Comments and time entries enforce author-only edit/delete
- Entity links validate entityType and prevent duplicates
- Follow/unfollow is idempotent
</verification>

<success_criteria>
- Comments support add, edit (author only), delete (author/admin)
- Attachments upload to IFileStorageService, download with correct ContentType, delete both file and record
- Time entries validate duration range (0-1440 min)
- Entity links support Contact, Company, Deal with name denormalization
- Followers: follow is idempotent, unfollow removes current user's record
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-04-SUMMARY.md`
</output>
