---
phase: 05-activities-and-workflow
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/GlobCRM.Domain/Interfaces/IActivityRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs
  - src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
autonomous: true

must_haves:
  truths:
    - "ActivityRepository provides paged queries with filter, sort, pagination, and ownership scope"
    - "Repository supports status-based Kanban queries and entity-scoped activity queries"
    - "TenantSeeder creates sample activities linked to existing companies, contacts, and deals"
  artifacts:
    - path: "src/GlobCRM.Domain/Interfaces/IActivityRepository.cs"
      provides: "Activity repository interface"
      contains: "IActivityRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs"
      provides: "Activity repository implementation with filter/sort/scope"
      contains: "class ActivityRepository"
  key_links:
    - from: "ActivityRepository.cs"
      to: "IActivityRepository.cs"
      via: "interface implementation"
      pattern: "IActivityRepository"
    - from: "CrmEntityServiceExtensions.cs"
      to: "IActivityRepository.cs"
      via: "DI registration"
      pattern: "AddScoped.*IActivityRepository"
    - from: "TenantSeeder.cs"
      to: "Activity.cs"
      via: "seed data creation"
      pattern: "new Activity"
---

<objective>
Create the Activity repository with full filter/sort/pagination/ownership-scope pipeline and wire seed data into TenantSeeder.

Purpose: Provide the data access layer for all activity queries (list, detail, Kanban grouping, entity-scoped, timeline) following the CompanyRepository/DealRepository pattern exactly.
Output: IActivityRepository interface, ActivityRepository implementation, DI registration, and seed data for sample activities.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-activities-and-workflow/05-RESEARCH.md

# Pattern references
@src/GlobCRM.Domain/Interfaces/IDealRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Repositories/CompanyRepository.cs
@src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
@src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs

# Prior plan summary
@.planning/phases/05-activities-and-workflow/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Activity repository interface and implementation</name>
  <files>
    src/GlobCRM.Domain/Interfaces/IActivityRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/ActivityRepository.cs
    src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  </files>
  <action>
    Create **IActivityRepository.cs** in src/GlobCRM.Domain/Interfaces/ with methods following IDealRepository pattern:

    - `Task<PagedResult<Activity>> GetPagedAsync(EntityQueryParams queryParams, Guid? userId, PermissionScope scope, IEnumerable<Guid>? teamMemberIds, string? linkedEntityType = null, Guid? linkedEntityId = null)` -- main list query with optional entity-scoped filtering via ActivityLink
    - `Task<Activity?> GetByIdAsync(Guid id)` -- lightweight for permission checks
    - `Task<Activity?> GetByIdWithDetailsAsync(Guid id)` -- full load with all child collections for detail page
    - `Task<List<Activity>> GetByStatusGroupAsync(Guid? userId, PermissionScope scope, IEnumerable<Guid>? teamMemberIds)` -- for Kanban view, returns all non-Done activities grouped by status
    - `Task<List<ActivityStatusHistory>> GetStatusHistoryAsync(Guid activityId)` -- for timeline
    - `Task<Activity> CreateAsync(Activity activity)`
    - `Task UpdateAsync(Activity activity)`
    - `Task DeleteAsync(Activity activity)`

    Create **ActivityRepository.cs** following DealRepository pattern:

    - Inject ApplicationDbContext, IPermissionService
    - **GetPagedAsync**: Build base query from _db.Activities. Apply ownership scope filter (Own = OwnerId == userId OR AssignedToId == userId, Team = OwnerId in teamMemberIds OR AssignedToId in teamMemberIds, All = no filter). Apply filter params (Subject=contains, Type=equals, Status=equals, Priority=equals, DueDate=date range, AssignedTo=equals). If linkedEntityType and linkedEntityId are provided, join with ActivityLinks to filter by entity association. Apply switch-based sorting (Subject, Type, Status, Priority, DueDate, CreatedAt). Apply pagination. Include Owner and AssignedTo for name display.

    - **GetByIdWithDetailsAsync**: Include Owner, AssignedTo, Comments (with Author), Attachments (with UploadedBy), TimeEntries (with User), Followers (with User), Links. Order Comments by CreatedAt desc, TimeEntries by EntryDate desc.

    - **GetByStatusGroupAsync**: Same ownership scope as GetPagedAsync but no pagination. Filter out Status == Done by default. Include Owner and AssignedTo. Order by Priority desc, DueDate asc.

    - **GetStatusHistoryAsync**: Filter by ActivityId, include ChangedByUser, order by ChangedAt desc.

    - Ownership scope for Activity: "Own" scope should match activities where OwnerId == userId OR AssignedToId == userId (users should see activities they own OR are assigned to). "Team" scope: OwnerId in teamMemberIds OR AssignedToId in teamMemberIds. This is a deviation from Company/Deal (which only check OwnerId) because ACTV-04 assigns activities to different users.

    Register IActivityRepository/ActivityRepository in **CrmEntityServiceExtensions.cs** (add AddScoped line alongside existing repositories).
  </action>
  <verify>
    `dotnet build` succeeds.
    IActivityRepository has 8 methods.
    ActivityRepository implements all 8 methods.
    CrmEntityServiceExtensions registers IActivityRepository.
  </verify>
  <done>ActivityRepository provides paged queries with filter/sort/ownership-scope, Kanban grouping, entity-scoped queries via ActivityLink, and detail loading with all child collections.</done>
</task>

<task type="auto">
  <name>Task 2: Wire TenantSeeder with Activity seed data</name>
  <files>
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  </files>
  <action>
    Update **TenantSeeder.cs** to create sample activities after deals are seeded (activities link to seeded entities):

    Add an ActivitySeed record to the seed manifest with properties: Subject, Type (string), Status (string), Priority (string), DueDateOffset (int, days from now).

    Create 6 sample activities in the seed data:
    1. Task: "Follow up with Acme Corp" - Status: Assigned, Priority: High, DueDate: +3 days
    2. Call: "Quarterly review call" - Status: InProgress, Priority: Medium, DueDate: +1 day
    3. Meeting: "Product demo for new client" - Status: Accepted, Priority: High, DueDate: +7 days
    4. Task: "Prepare proposal document" - Status: Review, Priority: Medium, DueDate: -1 day (overdue)
    5. Task: "Update CRM records" - Status: Done, Priority: Low, DueDate: -3 days
    6. Call: "Onboarding call with new contact" - Status: Assigned, Priority: Urgent, DueDate: +2 days

    For each activity:
    - Set TenantId from the tenant being seeded
    - Set OwnerId to the admin user (same as deal OwnerId pattern)
    - Set AssignedToId to the admin user (self-assigned for seed data simplicity)
    - Set IsSeedData = true
    - Parse Type, Status, Priority from string to enum

    Create 2-3 ActivityLink records linking activities to seeded companies and contacts:
    - Activity 1 linked to first seeded company (EntityType: "Company")
    - Activity 2 linked to first seeded contact (EntityType: "Contact")
    - Activity 3 linked to first seeded deal (EntityType: "Deal")

    Create 2 sample ActivityComment records on Activity 1:
    - "Initial contact made, they seem interested" by admin user
    - "Sent follow-up email with pricing details" by admin user

    Create 1 sample ActivityTimeEntry on Activity 2:
    - 45 minutes, "Reviewed quarterly metrics and prepared talking points", today's date

    Use _db.Activities.AddRangeAsync() and _db.SaveChangesAsync() following the existing seed pattern.
  </action>
  <verify>
    `dotnet build` succeeds.
    TenantSeeder creates activities, links, comments, and time entries.
  </verify>
  <done>TenantSeeder creates 6 sample activities with varied types/statuses/priorities, 3 entity links, 2 comments, and 1 time entry for demo data.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- IActivityRepository interface has all required query methods
- ActivityRepository handles ownership scope with both OwnerId and AssignedToId
- Entity-scoped query filters by ActivityLink (linkedEntityType + linkedEntityId)
- TenantSeeder creates varied activity seed data with child records
</verification>

<success_criteria>
- Repository follows CompanyRepository/DealRepository pattern for filter/sort/pagination
- Ownership scope covers both OwnerId and AssignedToId for Activity entity
- Kanban query groups by status, excludes Done
- Entity-scoped queries support ACTV-13 (activities linked to specific entities)
- Seed data provides 6 activities with comments, time entries, and entity links
</success_criteria>

<output>
After completion, create `.planning/phases/05-activities-and-workflow/05-02-SUMMARY.md`
</output>
