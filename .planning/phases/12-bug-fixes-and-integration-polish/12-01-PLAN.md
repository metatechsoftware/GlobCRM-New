---
phase: 12-bug-fixes-and-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/emails/email.service.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/app.routes.ts
autonomous: true

must_haves:
  truths:
    - "Gmail connect initiates OAuth flow instead of returning 405 Method Not Allowed"
    - "Import page is discoverable via navbar navigation"
    - "Users without entity permission are redirected to dashboard instead of seeing a 403 error page"
  artifacts:
    - path: "globcrm-web/src/app/features/emails/email.service.ts"
      provides: "Correct GET method for connect endpoint"
      contains: "this.api.get<ConnectResponse>"
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      provides: "Import link in Admin nav group"
      contains: "route: '/import'"
    - path: "globcrm-web/src/app/app.routes.ts"
      provides: "Permission guards on 8 CRM entity routes"
      contains: "permissionGuard"
  key_links:
    - from: "globcrm-web/src/app/features/emails/email.service.ts"
      to: "EmailAccountsController [HttpGet('connect')]"
      via: "ApiService.get()"
      pattern: "api\\.get.*accountBasePath.*connect"
    - from: "globcrm-web/src/app/app.routes.ts"
      to: "globcrm-web/src/app/core/permissions/permission.guard.ts"
      via: "permissionGuard import and canActivate array"
      pattern: "permissionGuard\\('(Company|Contact|Deal|Activity|Quote|Request|Product|Note)', 'View'\\)"
---

<objective>
Fix the Gmail connect HTTP method bug, add the Import link to navbar, and wire permissionGuard into all CRM entity routes.

Purpose: Close 3 of the 4 remaining v1.0 audit gaps -- 1 critical integration bug (Gmail OAuth flow broken by wrong HTTP method) and 2 architectural improvements (navbar discoverability, route-level RBAC).
Output: Three corrected source files ready for production.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-bug-fixes-and-integration-polish/12-RESEARCH.md
@globcrm-web/src/app/features/emails/email.service.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/core/permissions/permission.guard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Gmail connect HTTP method and add Import to navbar</name>
  <files>
    globcrm-web/src/app/features/emails/email.service.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
    Two one-line fixes in separate files:

    1. In `email.service.ts` line 81, change the `connect()` method from:
       `return this.api.post<ConnectResponse>(`${this.accountBasePath}/connect`);`
       to:
       `return this.api.get<ConnectResponse>(`${this.accountBasePath}/connect`);`
       The backend `EmailAccountsController` uses `[HttpGet("connect")]`, so POST returns 405.

    2. In `navbar.component.ts`, add an Import entry to the Admin nav group (before Team):
       `{ route: '/import', icon: 'upload_file', label: 'Import' },`
       Insert this as the first item in the Admin group's items array (line ~98), before the Team entry.

    NOTE: The quote transitions bug (task 2 in audit) is already fixed -- `Accepted: []` is already correct in quote.models.ts. The dashboard saveLayout bug (task 3 in audit) is also already correct -- the optimistic update pattern does not patch with the 204 response body. Skip both.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` to confirm no compilation errors.
    Grep email.service.ts for `api.get.*connect` to confirm the fix.
    Grep navbar.component.ts for `/import` to confirm the addition.
  </verify>
  <done>
    email.service.ts connect() uses api.get (matches backend [HttpGet]).
    Navbar Admin group contains Import link with upload_file icon before Team.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add permissionGuard to CRM entity routes</name>
  <files>
    globcrm-web/src/app/app.routes.ts
  </files>
  <action>
    Add route-level permission guards to all 8 CRM entity routes in app.routes.ts:

    1. Add import at top of file:
       `import { permissionGuard } from './core/permissions/permission.guard';`

    2. Update canActivate arrays for these 8 routes (authGuard MUST remain first in array):
       - `/companies`: `canActivate: [authGuard, permissionGuard('Company', 'View')]`
       - `/contacts`: `canActivate: [authGuard, permissionGuard('Contact', 'View')]`
       - `/products`: `canActivate: [authGuard, permissionGuard('Product', 'View')]`
       - `/deals`: `canActivate: [authGuard, permissionGuard('Deal', 'View')]`
       - `/activities`: `canActivate: [authGuard, permissionGuard('Activity', 'View')]`
       - `/quotes`: `canActivate: [authGuard, permissionGuard('Quote', 'View')]`
       - `/requests`: `canActivate: [authGuard, permissionGuard('Request', 'View')]`
       - `/notes`: `canActivate: [authGuard, permissionGuard('Note', 'View')]`

    IMPORTANT: authGuard MUST be first in every canActivate array. If permissionGuard runs before authGuard, the PermissionStore may not be loaded because the user is not authenticated yet.

    Do NOT add permissionGuard to: /auth, /onboarding, /dashboard, /settings, /profile, /team-directory, /emails, /feed, /calendar, /import. These routes either are unauthenticated, have no matching RBAC entity type, or use different authorization strategies.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` to confirm no compilation errors.
    Count occurrences of `permissionGuard` in app.routes.ts -- should be exactly 9 (1 import + 8 route usages).
  </verify>
  <done>
    All 8 CRM entity routes have permissionGuard('EntityType', 'View') in canActivate array after authGuard.
    No other routes are modified. Build succeeds with no errors.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` completes without errors.
2. `email.service.ts` connect() method uses `this.api.get` not `this.api.post`.
3. `navbar.component.ts` Admin group includes `{ route: '/import', icon: 'upload_file', label: 'Import' }`.
4. `app.routes.ts` imports `permissionGuard` and applies it to exactly 8 CRM entity routes.
5. `authGuard` appears before `permissionGuard` in every canActivate array.
</verification>

<success_criteria>
- Gmail connect endpoint calls GET (matching backend [HttpGet("connect")])
- Import link appears in navbar Admin section
- 8 CRM entity routes enforce permission check at route level
- Angular build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-bug-fixes-and-integration-polish/12-01-SUMMARY.md`
</output>
