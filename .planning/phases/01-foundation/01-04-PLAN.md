---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/GlobCRM.Infrastructure/Email/SendGridEmailSender.cs
  - src/GlobCRM.Infrastructure/Email/EmailTemplates/VerificationEmailTemplate.cshtml
  - src/GlobCRM.Infrastructure/Email/EmailTemplates/PasswordResetEmailTemplate.cshtml
  - src/GlobCRM.Infrastructure/Email/EmailTemplates/InvitationEmailTemplate.cshtml
  - src/GlobCRM.Infrastructure/Email/EmailTemplates/BaseEmailTemplate.cshtml
  - src/GlobCRM.Infrastructure/Email/RazorEmailRenderer.cs
  - src/GlobCRM.Api/Controllers/OrganizationsController.cs
  - src/GlobCRM.Application/Organizations/CreateOrganizationCommand.cs
  - src/GlobCRM.Application/Organizations/CreateOrganizationValidator.cs
  - src/GlobCRM.Application/Organizations/OrganizationDto.cs
  - src/GlobCRM.Application/Organizations/CheckSubdomainQuery.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/OrganizationRepository.cs
autonomous: true
user_setup:
  - service: sendgrid
    why: "Transactional email delivery for verification, password reset, and invitation emails"
    env_vars:
      - name: SendGrid__ApiKey
        source: "SendGrid Dashboard -> Settings -> API Keys -> Create API Key (Full Access or Mail Send only)"
      - name: SendGrid__FromEmail
        source: "A verified sender email in SendGrid Dashboard -> Settings -> Sender Authentication"
      - name: SendGrid__FromName
        source: "Display name for emails (e.g., 'GlobCRM')"
    dashboard_config:
      - task: "Create a free SendGrid account"
        location: "https://signup.sendgrid.com/"
      - task: "Verify a sender email address"
        location: "SendGrid Dashboard -> Settings -> Sender Authentication -> Single Sender Verification"

must_haves:
  truths:
    - "Email service sends verification, password reset, and invitation emails via SendGrid"
    - "Email templates are branded HTML with GlobCRM styling"
    - "User can create a new organization with subdomain, business details, and admin account in a single request"
    - "Subdomain availability check returns real-time feedback"
    - "New organizations are seeded with sample data (contacts, companies, deal, pipeline)"
    - "Organization creation is wrapped in a database transaction for atomicity"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Email/SendGridEmailSender.cs"
      provides: "IEmailService implementation using SendGrid API"
    - path: "src/GlobCRM.Infrastructure/Email/EmailTemplates/InvitationEmailTemplate.cshtml"
      provides: "Branded invitation email with org name, inviter name, role, and join link"
    - path: "src/GlobCRM.Api/Controllers/OrganizationsController.cs"
      provides: "REST endpoints for create org, check subdomain, deactivate org"
    - path: "src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs"
      provides: "Seed data creation for new organizations"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/OrganizationsController.cs"
      to: "src/GlobCRM.Application/Organizations/CreateOrganizationCommand.cs"
      via: "Command pattern for org creation"
      pattern: "CreateOrganizationCommand"
    - from: "src/GlobCRM.Application/Organizations/CreateOrganizationCommand.cs"
      to: "src/GlobCRM.Infrastructure/Email/SendGridEmailSender.cs"
      via: "IEmailService for sending verification email after org creation"
      pattern: "IEmailService"
---

<objective>
Implement email service with branded templates and organization management endpoints.

Purpose: Enable transactional email delivery (verification, password reset, invitations) and the "Create Organization" signup flow including subdomain availability checking and seed data provisioning.

Output: Working SendGrid email service with 3 branded HTML email templates. Organization REST endpoints for creation (with full transaction), subdomain checking, and deactivation. Seed data service for new organizations.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement email service with SendGrid and branded Razor templates</name>
  <files>
    src/GlobCRM.Infrastructure/Email/SendGridEmailSender.cs
    src/GlobCRM.Infrastructure/Email/RazorEmailRenderer.cs
    src/GlobCRM.Infrastructure/Email/EmailTemplates/BaseEmailTemplate.cshtml
    src/GlobCRM.Infrastructure/Email/EmailTemplates/VerificationEmailTemplate.cshtml
    src/GlobCRM.Infrastructure/Email/EmailTemplates/PasswordResetEmailTemplate.cshtml
    src/GlobCRM.Infrastructure/Email/EmailTemplates/InvitationEmailTemplate.cshtml
  </files>
  <action>
    1. **RazorEmailRenderer.cs** -- Razor template rendering service:
       - Renders .cshtml templates to HTML strings
       - Accepts a model object for dynamic content
       - Uses RazorLight or Microsoft.AspNetCore.Mvc.Razor for rendering (RazorLight is simpler for standalone rendering)
       - Add `RazorLight` NuGet package if needed, or use embedded Razor engine

    2. **BaseEmailTemplate.cshtml** -- Shared base HTML email template:
       - Responsive HTML email layout (inline CSS for email client compatibility)
       - GlobCRM logo placeholder (text-based "GlobCRM" for Phase 1)
       - Brand colors: primary #1976d2, accent #00897b
       - Header section with logo
       - Body content slot (@RenderBody() or model.Content)
       - CTA button component (reusable styled button)
       - Footer: "Sent by GlobCRM" + unsubscribe placeholder
       - Per discretion: uniform GlobCRM branding, not per-tenant

    3. **VerificationEmailTemplate.cshtml:**
       - Model: { UserName, VerificationUrl }
       - Content: "Welcome to GlobCRM! Please verify your email address."
       - CTA button: "Verify Email" linking to VerificationUrl
       - Note: "This link expires in 24 hours."

    4. **PasswordResetEmailTemplate.cshtml:**
       - Model: { UserName, ResetUrl }
       - Content: "We received a request to reset your password."
       - CTA button: "Reset Password" linking to ResetUrl
       - Note: "If you didn't request this, you can safely ignore this email."
       - Note: "This link expires in 24 hours."

    5. **InvitationEmailTemplate.cshtml:**
       - Model: { InviterName, OrgName, Role, JoinUrl }
       - Per locked decision: invite email is branded and includes org name, inviter name, role, and join link
       - Content: "{InviterName} has invited you to join {OrgName} on GlobCRM as a {Role}."
       - CTA button: "Join {OrgName}" linking to JoinUrl
       - Note: "This invitation expires in 7 days."

    6. **SendGridEmailSender.cs** -- Implements IEmailService:
       - Constructor injects IConfiguration for SendGrid settings (ApiKey, FromEmail, FromName)
       - Constructor injects RazorEmailRenderer
       - SendVerificationEmailAsync(email, token, subdomain):
         - Build verification URL: `https://{subdomain}.globcrm.com/auth/verify-email?userId={userId}&code={urlEncodedToken}`
         - Render VerificationEmailTemplate with model
         - Send via SendGrid API
       - SendPasswordResetEmailAsync(email, token, subdomain):
         - Build reset URL: `https://{subdomain}.globcrm.com/auth/reset-password?email={email}&code={urlEncodedToken}`
         - Render PasswordResetEmailTemplate
         - Send via SendGrid
       - SendInvitationEmailAsync(email, orgName, inviterName, role, joinUrl):
         - Render InvitationEmailTemplate with all parameters per locked decision
         - Send via SendGrid
       - Include proper error handling and logging (Serilog)
       - Log success/failure for each email sent (per pitfall #4: email delivery fails silently)

    7. **Register in DependencyInjection.cs:**
       - Register SendGridEmailSender as IEmailService (scoped)
       - Register RazorEmailRenderer (singleton)
       - Also register as ASP.NET Core Identity's IEmailSender<ApplicationUser> adapter
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Verify all 4 email templates exist under EmailTemplates/.
    Verify SendGridEmailSender implements IEmailService with all 3 send methods.
  </verify>
  <done>
    SendGrid email service sends all 3 email types with branded HTML templates. Templates include GlobCRM branding with proper inline CSS for email clients. Invitation email includes org name, inviter name, role, and join link per locked decision. Error handling and logging on all email sends.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement organization management endpoints with seed data</name>
  <files>
    src/GlobCRM.Api/Controllers/OrganizationsController.cs
    src/GlobCRM.Application/Organizations/CreateOrganizationCommand.cs
    src/GlobCRM.Application/Organizations/CreateOrganizationValidator.cs
    src/GlobCRM.Application/Organizations/OrganizationDto.cs
    src/GlobCRM.Application/Organizations/CheckSubdomainQuery.cs
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/OrganizationRepository.cs
  </files>
  <action>
    1. **OrganizationDto.cs:**
       - Id, Name, Subdomain, Industry, CompanySize, IsActive, UserLimit, SetupCompleted, CreatedAt
       - Static factory method from Organization entity

    2. **CreateOrganizationCommand.cs:**
       - Properties: OrgName, Subdomain, Industry?, CompanySize?, Email, Password, FirstName, LastName
       - Handler class (not using MediatR -- simple handler pattern):
         a. Validate subdomain availability (case-insensitive, lowercase)
         b. Begin database transaction (per pitfall #5: atomicity)
         c. Create Organization record
         d. Register tenant in Finbuckle's tenant store
         e. Create ApplicationUser with UserManager
         f. Assign "Admin" role to the user
         g. Commit transaction
         h. Seed organization data (async, non-blocking -- queue or fire-and-forget with error handling)
         i. Generate email confirmation token and send verification email
         j. Return OrganizationDto
       - If any step fails, rollback transaction and return appropriate error

    3. **CreateOrganizationValidator.cs** (FluentValidation):
       - OrgName: required, 2-255 chars
       - Subdomain: required, 3-63 chars, lowercase alphanumeric + hyphens only, no leading/trailing hyphens, not in reserved list (www, api, admin, mail, app, help, support, status)
       - Email: required, valid email format
       - Password: required, min 8 chars (Identity validates strength)
       - FirstName, LastName: required, 1-100 chars

    4. **CheckSubdomainQuery.cs:**
       - Input: subdomain string
       - Handler: check Organization table for existing subdomain (case-insensitive)
       - Also check reserved subdomain list
       - Return: { available: bool, subdomain: string (normalized) }

    5. **TenantSeeder.cs** -- Implements ITenantSeeder:
       Per discretion recommendation from research:
       - 5 sample contacts (CEO, Sales Manager, Developer, Marketing Lead, Support Agent)
       - 2 sample companies (linked to contacts)
       - 1 demo deal (in "Proposal" stage, linked to contact and company)
       - 1 default pipeline with 5 stages: Lead, Qualified, Proposal, Negotiation, Closed Won/Lost
       - All seed data marked with `IsSeedData = true` flag for later bulk deletion

       NOTE: For Phase 1, since we don't have Contact/Company/Deal entities yet, the seeder should:
       - Create the seed data structure but only seed what's possible now (organization settings, maybe JSON seed data config)
       - OR create a pending seed manifest that Phase 3 (Core CRM Entities) will execute
       - At minimum: create the default pipeline stages as JSON config in the Organization record

    6. **OrganizationRepository.cs** -- Implements IOrganizationRepository:
       - CRUD operations on TenantDbContext.Organizations
       - SubdomainExistsAsync: case-insensitive check

    7. **OrganizationsController.cs:**
       - `POST /api/organizations` -- Create organization (no auth required, this IS the signup)
         - Validate request with CreateOrganizationValidator
         - Execute CreateOrganizationCommand
         - Return 201 with OrganizationDto
       - `GET /api/organizations/check-subdomain?name={subdomain}` -- Check availability (no auth required)
         - Execute CheckSubdomainQuery
         - Return 200 with { available, subdomain }
         - Per research: debounced on frontend, validated on submit for race conditions
       - `POST /api/organizations/{id}/deactivate` -- Deactivate org (auth required, Admin only)
         - Per locked decision: admin can deactivate (freeze) org, data preserved, reactivation possible
         - Set IsActive = false
       - `POST /api/organizations/{id}/reactivate` -- Reactivate org (auth required, Admin only)
         - Set IsActive = true

    8. **Register all services in DependencyInjection.cs:**
       - OrganizationRepository as IOrganizationRepository
       - TenantSeeder as ITenantSeeder
       - Command handlers
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Verify OrganizationsController has all 4 endpoints.
    Verify CreateOrganizationValidator validates subdomain format and reserved words.
    Verify CreateOrganizationCommand wraps org+user creation in a transaction.
  </verify>
  <done>
    Organization creation endpoint handles full signup flow: validate subdomain, create org in transaction, create admin user with role, trigger seed data and verification email. Subdomain availability check endpoint works with reserved word filtering. Admin can deactivate/reactivate org per locked decision. Seed data service ready (creates pipeline stages, defers entity seeding to Phase 3).
  </done>
</task>

</tasks>

<verification>
- `dotnet build GlobCRM.sln` compiles with 0 errors
- Email templates render valid HTML with GlobCRM branding
- POST /api/organizations creates org + user in single transaction
- GET /api/organizations/check-subdomain validates availability and reserved words
- Subdomain validation: 3-63 chars, lowercase alphanumeric + hyphens, no reserved words
- Invitation email template includes org name, inviter name, role, join link
- Organization creation seeds default pipeline data
</verification>

<success_criteria>
Email service sends all 3 email types (verification, password reset, invitation) via SendGrid with branded HTML templates. Organization creation endpoint handles the complete signup flow atomically. Subdomain availability checking works with real-time validation. Seed data provisioned for new organizations. Admin can deactivate/reactivate organizations per locked decision.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
