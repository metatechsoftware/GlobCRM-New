---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/angular.json
  - globcrm-web/package.json
  - globcrm-web/tsconfig.json
  - globcrm-web/src/app/app.config.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/app.component.ts
  - globcrm-web/src/app/core/auth/auth.service.ts
  - globcrm-web/src/app/core/auth/auth.store.ts
  - globcrm-web/src/app/core/auth/auth.guard.ts
  - globcrm-web/src/app/core/auth/auth.interceptor.ts
  - globcrm-web/src/app/core/auth/auth.models.ts
  - globcrm-web/src/app/core/tenant/tenant.service.ts
  - globcrm-web/src/app/core/tenant/tenant.store.ts
  - globcrm-web/src/app/core/api/api.service.ts
  - globcrm-web/src/environments/environment.ts
  - globcrm-web/src/environments/environment.development.ts
  - globcrm-web/src/styles.scss
autonomous: true

must_haves:
  truths:
    - "Angular 19 app compiles and serves on localhost:4200"
    - "Auth interceptor automatically attaches JWT bearer token to all API requests"
    - "Auth guard redirects unauthenticated users to login page"
    - "Auth store persists authentication state and restores session on app init from refresh token"
    - "Tenant service extracts tenant context from subdomain"
  artifacts:
    - path: "globcrm-web/src/app/core/auth/auth.service.ts"
      provides: "Login, logout, register, refresh token, password reset, 2FA methods"
    - path: "globcrm-web/src/app/core/auth/auth.store.ts"
      provides: "NgRx SignalStore with auth state (user, tokens, isAuthenticated)"
    - path: "globcrm-web/src/app/core/auth/auth.interceptor.ts"
      provides: "Functional HTTP interceptor that attaches Bearer token"
    - path: "globcrm-web/src/app/core/auth/auth.guard.ts"
      provides: "Route guard redirecting unauthenticated users to /auth/login"
    - path: "globcrm-web/src/app/core/tenant/tenant.service.ts"
      provides: "Subdomain extraction and tenant context"
  key_links:
    - from: "globcrm-web/src/app/core/auth/auth.interceptor.ts"
      to: "globcrm-web/src/app/core/auth/auth.service.ts"
      via: "inject(AuthService) to get access token"
      pattern: "inject\\(AuthService\\)"
    - from: "globcrm-web/src/app/app.config.ts"
      to: "globcrm-web/src/app/core/auth/auth.interceptor.ts"
      via: "provideHttpClient(withInterceptors([authInterceptor]))"
      pattern: "withInterceptors"
---

<objective>
Scaffold the Angular 19 frontend application and implement all core authentication services.

Purpose: Create the Angular shell with authentication plumbing (interceptor, guard, store, services) so auth pages (Plan 06) can be built on a solid foundation. The core services handle token management, session persistence, and tenant resolution.

Output: Working Angular 19 app with Angular Material, complete auth service layer (login, logout, register, refresh, password reset, 2FA), NgRx SignalStore for auth state, functional HTTP interceptor, route guard, and tenant service.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Angular 19 app with Material and project configuration</name>
  <files>
    globcrm-web/angular.json
    globcrm-web/package.json
    globcrm-web/tsconfig.json
    globcrm-web/src/app/app.config.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/app.component.ts
    globcrm-web/src/app/core/auth/auth.models.ts
    globcrm-web/src/environments/environment.ts
    globcrm-web/src/environments/environment.development.ts
    globcrm-web/src/styles.scss
  </files>
  <action>
    1. Create Angular 19 app with standalone components:
       ```bash
       ng new globcrm-web --style=scss --routing --skip-tests --standalone
       cd globcrm-web
       ng add @angular/material --theme=custom --typography --animations
       npm install @ngrx/signals
       ```

    2. Configure environments:
       - environment.ts: `apiUrl: 'https://api.globcrm.com'`, `production: true`
       - environment.development.ts: `apiUrl: 'http://localhost:5000'`, `production: false`

    3. Set up app.config.ts:
       - provideRouter(routes) with lazy-loaded feature routes
       - provideHttpClient(withInterceptors([authInterceptor]))
       - provideAnimationsAsync()
       - Angular Material providers

    4. Set up routing structure in app.routes.ts:
       - `/auth/*` -> lazy load auth feature module (login, signup, verify, forgot-password, reset-password, 2fa)
       - `/onboarding/*` -> lazy load onboarding feature (wizard)
       - `/dashboard` -> lazy load dashboard (placeholder landing page)
       - Default redirect: `/dashboard`
       - `/dashboard` guarded by authGuard

    5. Define auth TypeScript models (auth.models.ts):
       ```typescript
       export interface LoginRequest { email: string; password: string; rememberMe: boolean; }
       export interface LoginResponse { tokenType: string; accessToken: string; expiresIn: number; refreshToken: string; }
       export interface RegisterRequest { email: string; password: string; }
       export interface CreateOrgRequest { orgName: string; subdomain: string; industry?: string; companySize?: string; email: string; password: string; firstName: string; lastName: string; }
       export interface JoinOrgRequest { token: string; email: string; password: string; firstName: string; lastName: string; }
       export interface UserInfo { id: string; email: string; firstName: string; lastName: string; organizationId: string; organizationName: string; role: string; }
       export interface ForgotPasswordRequest { email: string; }
       export interface ResetPasswordRequest { email: string; resetCode: string; newPassword: string; }
       export interface TwoFactorRequest { twoFactorCode: string; }
       ```

    6. Set up base SCSS styles:
       - Import Angular Material theme
       - Define GlobCRM brand colors (primary: deep blue #1976d2, accent: teal #00897b)
       - Per discretion: uniform GlobCRM branding (not per-tenant) for Phase 1
       - Global typography and spacing utilities

    7. Create minimal app.component.ts (standalone, uses router-outlet).
  </action>
  <verify>
    Run `cd globcrm-web && npm install && ng build` -- must compile with 0 errors.
    Run `ng serve` -- must serve on localhost:4200.
  </verify>
  <done>
    Angular 19 app compiles and serves. Angular Material installed with custom theme. Routing structure defined with lazy loading. Auth models defined. Environment configs set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement core auth services, store, interceptor, guard, and tenant service</name>
  <files>
    globcrm-web/src/app/core/auth/auth.service.ts
    globcrm-web/src/app/core/auth/auth.store.ts
    globcrm-web/src/app/core/auth/auth.guard.ts
    globcrm-web/src/app/core/auth/auth.interceptor.ts
    globcrm-web/src/app/core/tenant/tenant.service.ts
    globcrm-web/src/app/core/tenant/tenant.store.ts
    globcrm-web/src/app/core/api/api.service.ts
  </files>
  <action>
    1. **AuthService** (auth.service.ts) -- Injectable, providedIn: 'root':
       - login(email, password, rememberMe): POST /api/auth/login?useCookies=false, returns LoginResponse
       - register(request: RegisterRequest): POST /api/auth/register
       - createOrganization(request: CreateOrgRequest): POST /api/organizations
       - joinOrganization(request: JoinOrgRequest): POST /api/organizations/join
       - confirmEmail(userId, code): GET /api/auth/confirmEmail?userId=&code=
       - resendConfirmationEmail(email): POST /api/auth/resendConfirmationEmail
       - forgotPassword(email): POST /api/auth/forgotPassword
       - resetPassword(email, resetCode, newPassword): POST /api/auth/resetPassword
       - refreshToken(refreshToken): POST /api/auth/refresh
       - get2faInfo(): POST /api/auth/manage/2fa (GET info)
       - enable2fa(code): POST /api/auth/manage/2fa (enable)
       - disable2fa(): POST /api/auth/manage/2fa (disable)
       - getUserInfo(): GET /api/auth/manage/info
       - logout(): Clear tokens, navigate to /auth/login
       - getAccessToken(): Returns current access token from store
       - checkSubdomainAvailability(subdomain): GET /api/organizations/check-subdomain?name=subdomain

       Store access token in memory (signal), refresh token in localStorage ONLY when rememberMe=true per locked decision. Schedule token refresh at 80% of expiry time using setTimeout.

    2. **AuthStore** (auth.store.ts) -- NgRx SignalStore:
       ```typescript
       export const AuthStore = signalStore(
         { providedIn: 'root' },
         withState<AuthState>({
           user: null,
           accessToken: null,
           refreshToken: null,
           isAuthenticated: false,
           isLoading: false,
           error: null,
           requiresTwoFactor: false,
         }),
         withComputed(/* isAuthenticated, userName, userRole, organizationName */),
         withMethods(/* setTokens, setUser, clearAuth, setLoading, setError */)
       );
       ```

       On app init: check localStorage for refresh token. If exists, attempt silent refresh. If successful, set isAuthenticated=true. If failed, clear and redirect to login.

    3. **AuthInterceptor** (auth.interceptor.ts) -- Functional interceptor:
       - inject(AuthStore) to read accessToken
       - If token exists, clone request with `Authorization: Bearer {token}` header
       - On 401 response: attempt token refresh, retry original request once. If refresh fails, logout.
       - Do NOT attach token to auth endpoints (login, register, refresh, forgot-password)
       - Use `catchError` + `switchMap` pattern for 401 retry

    4. **AuthGuard** (auth.guard.ts) -- Functional route guard (`CanActivateFn`):
       - inject(AuthStore) to check isAuthenticated
       - If authenticated, allow
       - If not, redirect to /auth/login with returnUrl query param
       - Check if refresh token exists in localStorage -- if so, attempt refresh before redirecting

    5. **TenantService** (tenant.service.ts) -- Injectable, providedIn: 'root':
       - Extract subdomain from window.location.hostname (e.g., "acme.globcrm.com" -> "acme")
       - In development: if hostname is "localhost", fall back to checking for X-Tenant-Id header approach or a dev override (e.g., localStorage 'dev-tenant')
       - getSubdomain(): string | null
       - isMainDomain(): boolean (no subdomain = main marketing/signup page)

    6. **TenantStore** (tenant.store.ts) -- NgRx SignalStore:
       - State: { subdomain: string | null, organization: OrganizationInfo | null }
       - Computed: isResolved, organizationName

    7. **ApiService** (api.service.ts) -- Injectable, providedIn: 'root':
       - Base HTTP service wrapping HttpClient
       - Uses environment.apiUrl as base
       - Methods: get<T>, post<T>, put<T>, delete<T>, patch<T>
       - Handles common error transformation
  </action>
  <verify>
    Run `cd globcrm-web && ng build` -- must compile with 0 errors.
    Verify auth.interceptor.ts uses functional interceptor pattern (HttpInterceptorFn).
    Verify auth.guard.ts uses functional guard pattern (CanActivateFn).
    Verify auth.store.ts uses @ngrx/signals signalStore.
  </verify>
  <done>
    AuthService handles all auth API calls with proper token management. AuthStore persists auth state with signals. AuthInterceptor attaches Bearer tokens and handles 401 retry. AuthGuard protects routes. TenantService extracts subdomain. All services compile and follow Angular 19 patterns (standalone, functional interceptors/guards).
  </done>
</task>

</tasks>

<verification>
- `ng build` compiles with 0 errors
- Auth interceptor uses functional pattern with `HttpInterceptorFn`
- Auth guard uses `CanActivateFn` pattern
- Auth store uses `@ngrx/signals` `signalStore`
- Token refresh logic schedules refresh at 80% of expiry
- Access token stored in memory (signal), refresh token in localStorage only with rememberMe
- Tenant service extracts subdomain from hostname
</verification>

<success_criteria>
Angular 19 app compiles and serves. All core auth services implemented: AuthService with full API methods, AuthStore with NgRx SignalStore, functional auth interceptor with 401 retry, functional auth guard with redirect, tenant service with subdomain extraction. Token management follows locked decision: 30-min access tokens, 30-day refresh with rememberMe, session persists across browser refresh via refresh token.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
