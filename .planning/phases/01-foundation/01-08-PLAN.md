---
phase: 01-foundation
plan: 08
type: execute
wave: 5
depends_on: ["01-07"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can sign up with email and password and receive verification email"
    - "User can log in with JWT session that persists across browser refresh"
    - "User can reset forgotten password via email link"
    - "User can enable two-factor authentication and log out from any page"
    - "System resolves tenant from subdomain and isolates all data per organization"
    - "Admin can invite users to their organization via email"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete Phase 1 authentication and multi-tenancy system end-to-end.

Purpose: Confirm all 6 success criteria from the ROADMAP are met before marking Phase 1 complete. This is a human verification checkpoint -- the user tests all flows in the running application.

Output: Verification that all Phase 1 flows work correctly end-to-end.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prepare development environment and start services</name>
  <files></files>
  <action>
    1. Ensure PostgreSQL is running and database is created:
       ```bash
       # If using Docker:
       docker run -d --name globcrm-db -e POSTGRES_PASSWORD=dev_password -e POSTGRES_DB=globcrm -p 5432:5432 postgres:17
       ```

    2. Apply EF Core migrations:
       ```bash
       dotnet ef database update -p src/GlobCRM.Infrastructure -s src/GlobCRM.Api
       ```

    3. Apply RLS script:
       ```bash
       psql -h localhost -U postgres -d globcrm -f scripts/rls-setup.sql
       ```

    4. Start the .NET backend:
       ```bash
       dotnet run --project src/GlobCRM.Api --launch-profile Development
       ```

    5. Start the Angular frontend:
       ```bash
       cd globcrm-web && ng serve
       ```

    6. Configure local development for subdomain testing:
       - Add to /etc/hosts: `127.0.0.1 testorg.localhost`
       - Or use X-Tenant-Id header in development

    7. Verify both services are running and responding.
  </action>
  <verify>
    Backend responds on configured port (e.g., http://localhost:5000).
    Frontend responds on http://localhost:4200.
    Database connection successful.
  </verify>
  <done>
    Development environment ready with all services running.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 1 flows end-to-end</name>
  <files></files>
  <action>
    Human verification of complete Phase 1 authentication and multi-tenancy system:
    - Organization creation with subdomain selection
    - Email verification flow
    - Login with JWT (30-min session, 30-day with Remember Me)
    - Password reset via email
    - Two-factor authentication (TOTP)
    - Logout from any page
    - Subdomain-based tenant resolution with data isolation
    - Admin user invitations with bulk support
    - Onboarding wizard (3 skippable steps)

    **Flow 1: Organization Creation (AUTH-01, AUTH-06)**
    1. Navigate to http://localhost:4200/auth/signup
    2. Click "Create Organization" tab
    3. Fill in org name, type a subdomain and verify real-time availability check works
    4. Fill in admin details (name, email, password)
    5. Submit -- should succeed and show "Check your email" page

    **Flow 2: Email Verification (AUTH-02)**
    6. Check email (or development email log) for verification link
    7. Click the verification link
    8. Verify the "Email verified" confirmation page appears

    **Flow 3: Login with JWT (AUTH-04)**
    9. Navigate to login page
    10. Log in with the admin credentials
    11. Verify redirect to onboarding wizard (first login)
    12. Complete or skip the wizard
    13. Verify dashboard page loads
    14. Refresh the browser -- session should persist (JWT refresh)
    15. Test "Remember me" by logging in with it checked, close browser, reopen -- should stay logged in

    **Flow 4: Password Reset (AUTH-03)**
    16. Log out
    17. Click "Forgot password?"
    18. Enter email and submit
    19. Check email for reset link
    20. Click reset link, enter new password
    21. Verify login works with new password

    **Flow 5: Two-Factor Authentication (AUTH-05)**
    22. Log in and navigate to Security Settings (user menu)
    23. Scan QR code with authenticator app
    24. Enter TOTP code and verify 2FA enables
    25. Verify recovery codes are displayed
    26. Log out and log in again -- should prompt for 2FA code
    27. Enter TOTP code -- should complete login

    **Flow 6: Logout (AUTH-08)**
    28. From any page, click user menu -> Log Out
    29. Verify redirect to login page
    30. Verify accessing /dashboard redirects to login (session cleared)

    **Flow 7: User Invitations (AUTH-07)**
    31. Log in as admin
    32. Navigate to onboarding wizard invite step (or find invitation management)
    33. Enter multiple email addresses for bulk invite
    34. Verify invitation emails are sent (check email or logs)
    35. Open invitation link in incognito/different browser
    36. Verify join form shows org name and role
    37. Complete join form -- account should be created
    38. Verify the invited user can log in to the same org

    **Flow 8: Tenant Isolation (AUTH-06)**
    39. Create a second organization with a different subdomain
    40. Verify each org only sees its own data (users, invitations)
    41. Verify API requests without tenant context are rejected for tenant-scoped endpoints
  </action>
  <verify>
    All 8 verification flows pass without errors. Type "approved" if all flows work, or describe any issues found.
  </verify>
  <done>
    All AUTH-01 through AUTH-08 requirements verified. Phase 1 complete.
  </done>
</task>

</tasks>

<verification>
All 6 ROADMAP success criteria verified:
1. User can sign up with email and password and receive verification email
2. User can log in with JWT session that persists across browser refresh
3. User can reset forgotten password via email link
4. User can enable two-factor authentication and log out from any page
5. System resolves tenant from subdomain and isolates all data per organization
6. Admin can invite users to their organization via email
</verification>

<success_criteria>
All 8 verification flows pass. All AUTH-01 through AUTH-08 requirements are met. Phase 1 is complete and ready for Phase 2 (Core Infrastructure -- RBAC, custom fields, dynamic tables).
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-08-SUMMARY.md`
</output>
