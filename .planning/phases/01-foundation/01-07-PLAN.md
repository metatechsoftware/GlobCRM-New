---
phase: 01-foundation
plan: 07
type: execute
wave: 4
depends_on: ["01-05", "01-06"]
files_modified:
  - globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.ts
  - globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.html
  - globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.scss
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/shared/components/navbar/navbar.component.scss
  - globcrm-web/src/app/features/onboarding/onboarding.routes.ts
  - globcrm-web/src/app/features/onboarding/wizard/wizard.component.ts
  - globcrm-web/src/app/features/onboarding/wizard/wizard.component.html
  - globcrm-web/src/app/features/onboarding/wizard/wizard.component.scss
  - globcrm-web/src/app/features/onboarding/wizard/invite-team-step/invite-team-step.component.ts
  - globcrm-web/src/app/features/onboarding/wizard/invite-team-step/invite-team-step.component.html
  - globcrm-web/src/app/features/onboarding/wizard/configure-basics-step/configure-basics-step.component.ts
  - globcrm-web/src/app/features/onboarding/wizard/configure-basics-step/configure-basics-step.component.html
  - globcrm-web/src/app/features/onboarding/wizard/explore-data-step/explore-data-step.component.ts
  - globcrm-web/src/app/features/onboarding/wizard/explore-data-step/explore-data-step.component.html
  - globcrm-web/src/app/app.component.ts
  - globcrm-web/src/app/app.component.html
autonomous: true

must_haves:
  truths:
    - "User can enable 2FA by scanning QR code with authenticator app"
    - "User sees recovery codes after enabling 2FA"
    - "User can log out from any page via navbar button"
    - "New org admin sees setup wizard on first login"
    - "Setup wizard has 3 steps: invite team, configure basics, explore seed data"
    - "Each wizard step is skippable"
  artifacts:
    - path: "globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.ts"
      provides: "2FA setup page with QR code, verification, and recovery codes"
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      provides: "Global navigation bar with user menu and logout button"
    - path: "globcrm-web/src/app/features/onboarding/wizard/wizard.component.ts"
      provides: "3-step onboarding wizard with stepper navigation"
  key_links:
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.ts"
      to: "globcrm-web/src/app/core/auth/auth.service.ts"
      via: "AuthService.logout() on logout button click"
      pattern: "authService.*logout"
    - from: "globcrm-web/src/app/features/onboarding/wizard/invite-team-step/invite-team-step.component.ts"
      to: "globcrm-web/src/app/core/auth/auth.service.ts"
      via: "API call to send invitations"
      pattern: "invit"
---

<objective>
Build the 2FA setup page, global logout capability, and the onboarding setup wizard.

Purpose: Complete all remaining frontend features for Phase 1: TOTP-based two-factor authentication setup, logout from any page via navbar, and the guided setup wizard for new organizations.

Output: 2FA setup page with QR code and recovery codes. Global navbar with logout button. 3-step onboarding wizard (invite team, configure basics, explore seed data) -- all steps skippable.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
@.planning/phases/01-foundation/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build 2FA setup page and global navbar with logout</name>
  <files>
    globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.ts
    globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.html
    globcrm-web/src/app/features/auth/two-factor/two-factor-setup.component.scss
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/shared/components/navbar/navbar.component.scss
    globcrm-web/src/app/app.component.ts
    globcrm-web/src/app/app.component.html
  </files>
  <action>
    1. **TwoFactorSetupComponent:**
       - Per discretion: TOTP app-based 2FA (Google Authenticator, Authy, Microsoft Authenticator)
       - Install qrcode library: `npm install qrcode @types/qrcode` (or use a lightweight QR code Angular component)
       - Page layout: settings-style page accessible from user menu

       Three states:
       a. **2FA not enabled:**
          - "Enable Two-Factor Authentication" heading
          - Step 1: "Scan this QR code with your authenticator app"
            - Call AuthService.get2faInfo() to get shared key and URI
            - Render QR code from the authenticator URI using qrcode library
            - Also show the shared key as text (manual entry fallback)
          - Step 2: "Enter the code from your authenticator app"
            - 6-digit code input (mat-form-field)
            - Submit calls AuthService.enable2fa(code)
          - On success: show recovery codes

       b. **Recovery codes displayed (after enabling):**
          - Show 10 recovery codes in a grid
          - "Save these codes in a safe place. Each code can only be used once."
          - "Download" button to save as text file
          - "I've saved my codes" button to dismiss
          - Per research: 10 recovery codes generated when 2FA is enabled

       c. **2FA already enabled:**
          - "Two-factor authentication is enabled" with green checkmark
          - "Disable 2FA" button (requires current TOTP code to disable)
          - "Regenerate recovery codes" button

    2. **NavbarComponent:**
       - Per locked decision: user can log out from any page
       - Angular Material toolbar (mat-toolbar)
       - Left: GlobCRM logo/text (link to /dashboard)
       - Right: User menu (mat-menu) triggered by avatar/initials button
         - Display: user full name + role
         - Menu items:
           - "Security Settings" -> /auth/two-factor (2FA setup)
           - Divider
           - "Log Out" -> calls AuthService.logout()
       - Show organization name in the toolbar
       - Conditionally rendered: only show when user is authenticated

    3. **Update app.component.ts/html:**
       - Include navbar above router-outlet
       - Show navbar only when authenticated (check AuthStore.isAuthenticated)
       - Do NOT show navbar on auth pages (login, signup, etc.)
       - Layout: navbar at top, router-outlet below

    4. **Update auth.routes.ts:**
       - Add route for two-factor setup: `{ path: 'two-factor', component: TwoFactorSetupComponent, canActivate: [authGuard] }`
  </action>
  <verify>
    Run `cd globcrm-web && ng build` -- must compile with 0 errors.
    Verify two-factor-setup component handles all 3 states (setup, recovery codes, already enabled).
    Verify navbar has logout button calling AuthService.logout().
    Verify app.component conditionally shows navbar for authenticated users.
  </verify>
  <done>
    2FA setup page with QR code generation, TOTP verification, recovery code display, and disable option. Global navbar with user menu and logout button. Navbar conditionally rendered for authenticated users. Logout accessible from any page per locked decision.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build onboarding setup wizard (3 steps, all skippable)</name>
  <files>
    globcrm-web/src/app/features/onboarding/onboarding.routes.ts
    globcrm-web/src/app/features/onboarding/wizard/wizard.component.ts
    globcrm-web/src/app/features/onboarding/wizard/wizard.component.html
    globcrm-web/src/app/features/onboarding/wizard/wizard.component.scss
    globcrm-web/src/app/features/onboarding/wizard/invite-team-step/invite-team-step.component.ts
    globcrm-web/src/app/features/onboarding/wizard/invite-team-step/invite-team-step.component.html
    globcrm-web/src/app/features/onboarding/wizard/configure-basics-step/configure-basics-step.component.ts
    globcrm-web/src/app/features/onboarding/wizard/configure-basics-step/configure-basics-step.component.html
    globcrm-web/src/app/features/onboarding/wizard/explore-data-step/explore-data-step.component.ts
    globcrm-web/src/app/features/onboarding/wizard/explore-data-step/explore-data-step.component.html
  </files>
  <action>
    1. **onboarding.routes.ts:**
       ```typescript
       export const onboardingRoutes: Routes = [
         { path: '', component: WizardComponent, canActivate: [authGuard] }
       ];
       ```

    2. **WizardComponent (parent):**
       - Per locked decision: guided setup wizard after org creation, skippable
       - Per discretion: 3-step wizard
       - Uses Angular Material Stepper (mat-stepper) with linear=false (allow skipping)
       - Steps: Invite Team -> Configure Basics -> Explore Data
       - "Skip All" button in the header to go directly to dashboard
       - On completion: call API to set organization's setup_completed=true, navigate to /dashboard
       - Check on init: if organization.setup_completed is already true, redirect to /dashboard

    3. **InviteTeamStepComponent (Step 1):**
       - Per locked decision: admin can bulk-invite by pasting or typing multiple email addresses
       - Large textarea for pasting multiple emails (one per line or comma-separated)
       - Parse and display each email as a chip (mat-chip-set)
       - Remove individual emails with X button on each chip
       - Role selector: Admin or Member (mat-select, default Member)
       - "Send Invitations" button -> calls invitations API
       - Show result: "{N} invitations sent, {M} skipped"
       - "Skip" button to proceed without inviting

    4. **ConfigureBasicsStepComponent (Step 2):**
       - Per discretion: minimal settings configuration
       - Fields:
         - Timezone (mat-select with common timezones, detect browser timezone as default)
         - Currency (mat-select: USD, EUR, GBP, etc., default USD)
         - Date format (mat-select: MM/DD/YYYY, DD/MM/YYYY, YYYY-MM-DD)
       - Save settings via API call (update organization settings)
       - "Skip" button to proceed with defaults

    5. **ExploreDataStepComponent (Step 3):**
       - Per discretion: brief tour of sample contacts/deals
       - Show summary of seed data created:
         - "We've added some sample data to help you explore GlobCRM:"
         - "5 sample contacts" with brief names
         - "2 sample companies"
         - "1 demo deal in your pipeline"
         - "A default sales pipeline with 5 stages"
       - "You can delete this sample data anytime from Settings."
       - "Start Using GlobCRM" button -> mark setup_completed and navigate to /dashboard
       - "Skip" button -> same behavior

    6. **Integration with auth flow:**
       - After org creation + email verification + first login: check if setup_completed is false
       - If false, redirect to /onboarding instead of /dashboard
       - This logic goes in the authGuard or in a separate onboarding guard on the dashboard route
  </action>
  <verify>
    Run `cd globcrm-web && ng build` -- must compile with 0 errors.
    Verify wizard has 3 steps with mat-stepper.
    Verify each step has a "Skip" button.
    Verify invite-team step supports bulk email input.
    Verify wizard checks setup_completed and redirects accordingly.
  </verify>
  <done>
    3-step onboarding wizard with Angular Material stepper. Step 1 (Invite Team) supports bulk email paste with chip display. Step 2 (Configure Basics) sets timezone, currency, date format. Step 3 (Explore Data) shows seed data summary. All steps skippable. Skip All button available. Wizard marks setup_completed on finish and redirects to dashboard.
  </done>
</task>

</tasks>

<verification>
- `ng build` compiles with 0 errors
- 2FA setup page renders QR code and accepts TOTP verification code
- Recovery codes displayed after 2FA enablement
- Navbar shows on authenticated pages with logout button
- Navbar hidden on auth pages (login, signup, etc.)
- Wizard has 3 steps using mat-stepper
- Each wizard step has Skip button
- Skip All button bypasses entire wizard
- Invite team step supports bulk email paste
- Wizard redirects to dashboard on completion
</verification>

<success_criteria>
2FA setup complete with QR code, TOTP verification, recovery codes, and disable option. Logout accessible from any page via navbar. Onboarding wizard guides new admins through 3 skippable steps: invite team (bulk email), configure basics (timezone/currency), explore seed data. Wizard respects setup_completed flag and redirects appropriately.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md`
</output>
