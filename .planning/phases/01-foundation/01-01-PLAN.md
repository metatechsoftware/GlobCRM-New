---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GlobCRM.sln
  - src/GlobCRM.Domain/GlobCRM.Domain.csproj
  - src/GlobCRM.Domain/Entities/Organization.cs
  - src/GlobCRM.Domain/Entities/ApplicationUser.cs
  - src/GlobCRM.Domain/Entities/Invitation.cs
  - src/GlobCRM.Domain/Entities/UserRole.cs
  - src/GlobCRM.Domain/Interfaces/ITenantProvider.cs
  - src/GlobCRM.Domain/Interfaces/IOrganizationRepository.cs
  - src/GlobCRM.Application/GlobCRM.Application.csproj
  - src/GlobCRM.Application/Common/IEmailService.cs
  - src/GlobCRM.Application/Common/ITenantSeeder.cs
  - src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Persistence/TenantDbContext.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ApplicationUserConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/InvitationConfiguration.cs
  - src/GlobCRM.Api/GlobCRM.Api.csproj
  - src/GlobCRM.Api/Program.cs
  - src/GlobCRM.Api/appsettings.json
  - src/GlobCRM.Api/appsettings.Development.json
  - scripts/rls-setup.sql
autonomous: true
user_setup:
  - service: postgresql
    why: "Database server for application data and tenant isolation"
    env_vars:
      - name: ConnectionStrings__DefaultConnection
        source: "Local PostgreSQL installation or Docker container"
    dashboard_config:
      - task: "Ensure PostgreSQL 17 is running locally or via Docker"
        location: "docker run -d --name globcrm-db -e POSTGRES_PASSWORD=dev_password -e POSTGRES_DB=globcrm -p 5432:5432 postgres:17"

must_haves:
  truths:
    - ".NET solution compiles with all 4 projects (Domain, Application, Infrastructure, Api)"
    - "Domain entities define Organization, ApplicationUser (extends IdentityUser<Guid>), Invitation with all required fields"
    - "EF Core DbContexts configured with entity type configurations and global query filters for tenant isolation"
    - "PostgreSQL RLS script ready for tenant-scoped tables"
  artifacts:
    - path: "GlobCRM.sln"
      provides: "Solution file referencing all 4 projects"
    - path: "src/GlobCRM.Domain/Entities/Organization.cs"
      provides: "Tenant entity with subdomain, industry, company_size, is_active, user_limit, setup_completed"
    - path: "src/GlobCRM.Domain/Entities/ApplicationUser.cs"
      provides: "Custom Identity user with OrganizationId, FirstName, LastName, IsActive"
    - path: "src/GlobCRM.Domain/Entities/Invitation.cs"
      provides: "Invitation entity with TenantId, Email, Role, Token, ExpiresAt, AcceptedAt"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "Tenant-scoped EF Core DbContext with global query filters"
    - path: "src/GlobCRM.Infrastructure/Persistence/TenantDbContext.cs"
      provides: "Tenant catalog DbContext (not scoped)"
    - path: "scripts/rls-setup.sql"
      provides: "PostgreSQL RLS policies and application database role"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "src/GlobCRM.Domain/Entities/*.cs"
      via: "DbSet properties and entity configurations"
      pattern: "DbSet<.*>"
    - from: "src/GlobCRM.Api/GlobCRM.Api.csproj"
      to: "src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj"
      via: "Project reference"
      pattern: "ProjectReference.*Infrastructure"
---

<objective>
Scaffold the complete .NET backend solution and define the domain model for GlobCRM Phase 1.

Purpose: Establish the foundational project structure, domain entities, and database schema that all subsequent plans depend on. This is a greenfield project with no existing code.

Output: Compilable .NET 10 solution with Domain, Application, Infrastructure, and Api layers. Domain entities for Organization, ApplicationUser, Invitation. EF Core DbContexts with tenant isolation query filters. PostgreSQL RLS script.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold .NET 10 solution with clean architecture projects</name>
  <files>
    GlobCRM.sln
    src/GlobCRM.Domain/GlobCRM.Domain.csproj
    src/GlobCRM.Application/GlobCRM.Application.csproj
    src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
    src/GlobCRM.Api/GlobCRM.Api.csproj
    src/GlobCRM.Api/Program.cs
    src/GlobCRM.Api/appsettings.json
    src/GlobCRM.Api/appsettings.Development.json
  </files>
  <action>
    Create the .NET 10 solution with 4 projects following clean architecture:

    1. Create solution and projects:
       ```bash
       dotnet new sln -n GlobCRM
       dotnet new classlib -n GlobCRM.Domain -o src/GlobCRM.Domain -f net10.0
       dotnet new classlib -n GlobCRM.Application -o src/GlobCRM.Application -f net10.0
       dotnet new classlib -n GlobCRM.Infrastructure -o src/GlobCRM.Infrastructure -f net10.0
       dotnet new webapi -n GlobCRM.Api -o src/GlobCRM.Api -f net10.0 --no-openapi
       ```

    2. Add project references (dependency direction: Api -> Infrastructure -> Application -> Domain):
       - Domain: no dependencies
       - Application: references Domain
       - Infrastructure: references Application (and Domain transitively)
       - Api: references Infrastructure (and Application/Domain transitively)

    3. Add NuGet packages:
       - Domain: (none)
       - Application: FluentValidation (11.x)
       - Infrastructure:
         - Microsoft.AspNetCore.Identity.EntityFrameworkCore
         - Npgsql.EntityFrameworkCore.PostgreSQL
         - Finbuckle.MultiTenant
         - Finbuckle.MultiTenant.AspNetCore
         - Finbuckle.MultiTenant.EntityFrameworkCore
         - SendGrid (9.x)
         - Serilog.AspNetCore (8.x)
       - Api:
         - Microsoft.AspNetCore.Authentication.JwtBearer
         - FluentValidation.AspNetCore

    4. Configure appsettings.json with sections for:
       - ConnectionStrings (DefaultConnection for PostgreSQL)
       - Jwt (Issuer, Audience, Key -- use placeholder values)
       - SendGrid (ApiKey placeholder)
       - App (BaseUrl: "globcrm.com")

    5. Configure appsettings.Development.json with:
       - ConnectionStrings pointing to localhost PostgreSQL
       - Development JWT key (256-bit minimum)
       - App BaseUrl: "localhost"

    6. Set up minimal Program.cs that compiles (services will be registered in later plans):
       - Add builder.Services and app pipeline skeleton
       - Add CORS policy for Angular dev server (http://localhost:4200)
       - Add Serilog logging configuration

    Do NOT set up Identity, Finbuckle, or JWT authentication in Program.cs yet -- those come in Plan 03. Just ensure the solution compiles.
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Run `dotnet run --project src/GlobCRM.Api` -- must start and respond on configured port.
  </verify>
  <done>
    .NET 10 solution with 4 projects compiles cleanly. Api project starts. Project references follow clean architecture dependency rules. All NuGet packages installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define domain entities, EF Core DbContexts, and RLS script</name>
  <files>
    src/GlobCRM.Domain/Entities/Organization.cs
    src/GlobCRM.Domain/Entities/ApplicationUser.cs
    src/GlobCRM.Domain/Entities/Invitation.cs
    src/GlobCRM.Domain/Entities/UserRole.cs
    src/GlobCRM.Domain/Interfaces/ITenantProvider.cs
    src/GlobCRM.Domain/Interfaces/IOrganizationRepository.cs
    src/GlobCRM.Application/Common/IEmailService.cs
    src/GlobCRM.Application/Common/ITenantSeeder.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Persistence/TenantDbContext.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/OrganizationConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ApplicationUserConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/InvitationConfiguration.cs
    scripts/rls-setup.sql
  </files>
  <action>
    1. Create domain entities:

    **Organization.cs:**
    - Id (Guid, PK, default gen_random_uuid)
    - Name (string, required, max 255)
    - Subdomain (string, required, max 63, unique)
    - Industry (string, nullable, max 100)
    - CompanySize (string, nullable, max 50)
    - IsActive (bool, default true) -- per locked decision: admin can deactivate/freeze org
    - UserLimit (int, default 10) -- per locked decision: soft user limit
    - SetupCompleted (bool, default false) -- wizard tracking
    - CreatedAt (DateTimeOffset, default UTC now)
    - UpdatedAt (DateTimeOffset, default UTC now)
    - Navigation: Users (ICollection), Invitations (ICollection)

    **ApplicationUser.cs** (extends IdentityUser<Guid>):
    - OrganizationId (Guid, FK to Organization)
    - Organization (navigation)
    - FirstName (string, required, max 100)
    - LastName (string, required, max 100)
    - IsActive (bool, default true)
    - CreatedAt (DateTimeOffset, default UTC now)
    - LastLoginAt (DateTimeOffset, nullable)

    **Invitation.cs:**
    - Id (Guid, PK)
    - TenantId (Guid, FK to Organization -- named TenantId for Finbuckle compatibility)
    - Email (string, required, max 255)
    - Role (string, required, default "Member") -- Admin or Member per locked decision
    - InvitedByUserId (Guid, FK to ApplicationUser)
    - InvitedByUser (navigation)
    - Token (string, required, unique) -- cryptographically random, not sequential
    - ExpiresAt (DateTimeOffset) -- 7 days from creation per locked decision
    - AcceptedAt (DateTimeOffset, nullable)
    - CreatedAt (DateTimeOffset, default UTC now)

    **UserRole.cs** (enum):
    - Admin = 0
    - Member = 1
    - Plus string constants: `public const string AdminRole = "Admin"; public const string MemberRole = "Member";`

    2. Create domain interfaces:

    **ITenantProvider.cs:** GetTenantId() -> Guid?, GetCurrentOrganizationAsync() -> Task<Organization?>
    **IOrganizationRepository.cs:** Standard CRUD + SubdomainExistsAsync(string subdomain) -> Task<bool>

    3. Create application interfaces:

    **IEmailService.cs:** SendVerificationEmailAsync, SendPasswordResetEmailAsync, SendInvitationEmailAsync (with params matching locked decision: orgName, inviterName, role, joinUrl)
    **ITenantSeeder.cs:** SeedOrganizationDataAsync(Guid organizationId)

    4. Create EF Core DbContexts:

    **TenantDbContext** (not tenant-scoped, holds Organization catalog):
    - DbSet<Organization> Organizations
    - Uses OrganizationConfiguration

    **ApplicationDbContext** (extends IdentityDbContext<ApplicationUser, IdentityRole<Guid>, Guid>):
    - Implements Finbuckle IMultiTenantDbContext
    - DbSet<Invitation> Invitations
    - Global query filters: filter Invitation by TenantId matching current tenant
    - NOTE: ApplicationUser is filtered by OrganizationId via global query filter
    - Apply entity configurations

    5. Create EF Core entity type configurations:
    - OrganizationConfiguration: unique index on Subdomain, constraints
    - ApplicationUserConfiguration: index on OrganizationId, FK to Organization
    - InvitationConfiguration: unique index on Token, index on TenantId+Email, FK constraints

    6. Create RLS script (scripts/rls-setup.sql):
    - Create application role `globcrm_app` (non-superuser)
    - Enable RLS on AspNetUsers table (filter by organization_id matching app.current_tenant)
    - Enable RLS on Invitations table (filter by tenant_id matching app.current_tenant)
    - Grant permissions to globcrm_app role
    - Include comments explaining the triple-layer defense strategy

    NOTE: Do NOT create the EF Core migration yet -- that requires Identity and Finbuckle to be configured in Program.cs (Plan 03). Just ensure all entities and DbContexts compile.
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Verify all entity files exist with correct properties using `find src -name "*.cs" | sort`.
    Verify RLS script exists at scripts/rls-setup.sql.
  </verify>
  <done>
    All domain entities defined with correct properties matching locked decisions. Both DbContexts compile with entity configurations. Global query filters configured for tenant isolation. RLS SQL script ready. Interfaces defined for email, tenant seeding, and tenant provision.
  </done>
</task>

</tasks>

<verification>
- `dotnet build GlobCRM.sln` compiles with 0 errors
- All 4 projects exist with correct project references
- All NuGet packages installed
- Domain entities have all fields from locked decisions
- EF Core configurations define all indexes and constraints
- RLS script handles tenant isolation for all tenant-scoped tables
</verification>

<success_criteria>
The .NET 10 solution compiles cleanly with Domain, Application, Infrastructure, and Api layers. Domain entities correctly model Organization (with subdomain, user_limit, is_active), ApplicationUser (with OrganizationId), and Invitation (with 7-day expiry, token). EF Core DbContexts have global query filters for tenant isolation. RLS SQL script is ready to execute against PostgreSQL.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
