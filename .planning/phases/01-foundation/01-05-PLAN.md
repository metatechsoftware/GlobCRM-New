---
phase: 01-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - src/GlobCRM.Api/Controllers/InvitationsController.cs
  - src/GlobCRM.Application/Invitations/SendInvitationCommand.cs
  - src/GlobCRM.Application/Invitations/SendInvitationValidator.cs
  - src/GlobCRM.Application/Invitations/AcceptInvitationCommand.cs
  - src/GlobCRM.Application/Invitations/InvitationDto.cs
  - src/GlobCRM.Application/Invitations/ResendInvitationCommand.cs
  - src/GlobCRM.Application/Auth/LogoutEndpoint.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/InvitationRepository.cs
autonomous: true

must_haves:
  truths:
    - "Admin can send invitations to multiple email addresses at once"
    - "Invitation emails are branded with org name, inviter name, role, and join link"
    - "Invitations expire after 7 days and admin can resend expired invitations"
    - "Invited user can accept invitation and create their account"
    - "Soft user limit warns admin when org reaches 10 users but does not block invitations"
    - "User can log out, clearing all tokens and redirecting to login"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/InvitationsController.cs"
      provides: "REST endpoints for send, accept, resend, list invitations"
    - path: "src/GlobCRM.Application/Invitations/SendInvitationCommand.cs"
      provides: "Bulk invitation sending with soft limit check"
    - path: "src/GlobCRM.Application/Invitations/AcceptInvitationCommand.cs"
      provides: "Invitation acceptance with user account creation"
  key_links:
    - from: "src/GlobCRM.Application/Invitations/SendInvitationCommand.cs"
      to: "src/GlobCRM.Application/Common/IEmailService.cs"
      via: "SendInvitationEmailAsync for each invited email"
      pattern: "IEmailService.*SendInvitationEmail"
    - from: "src/GlobCRM.Application/Invitations/AcceptInvitationCommand.cs"
      to: "Microsoft.AspNetCore.Identity.UserManager"
      via: "CreateAsync to create user account from invitation"
      pattern: "UserManager.*CreateAsync"
---

<objective>
Implement the invitation system and remaining authentication endpoints.

Purpose: Complete the backend for admin user invitations (send, accept, resend, bulk) and the logout endpoint. This completes all backend API functionality for Phase 1.

Output: Working invitation CRUD endpoints with bulk invite support, 7-day expiry, branded emails, soft user limit warnings, and invitation acceptance flow (user account creation).
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement invitation system with bulk invite, expiry, and acceptance</name>
  <files>
    src/GlobCRM.Api/Controllers/InvitationsController.cs
    src/GlobCRM.Application/Invitations/SendInvitationCommand.cs
    src/GlobCRM.Application/Invitations/SendInvitationValidator.cs
    src/GlobCRM.Application/Invitations/AcceptInvitationCommand.cs
    src/GlobCRM.Application/Invitations/ResendInvitationCommand.cs
    src/GlobCRM.Application/Invitations/InvitationDto.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/InvitationRepository.cs
  </files>
  <action>
    1. **InvitationDto.cs:**
       - Id, Email, Role, InviterName, Status (Pending/Accepted/Expired), ExpiresAt, CreatedAt, AcceptedAt

    2. **SendInvitationCommand.cs:**
       - Input: Emails (List<string>), Role (default "Member")
       - Per locked decision: admin can bulk-invite by pasting or typing multiple email addresses
       - Handler:
         a. Get current organization via ITenantProvider
         b. Get current user (inviter) from claims
         c. Check soft user limit (10 users per locked decision):
            - Count active users + pending invitations
            - If at/over limit: include warning in response but DO NOT block (soft limit)
            - Log warning: "Organization {orgName} has reached user limit of {limit}"
         d. For each email in Emails:
            - Normalize: trim + lowercase
            - Skip if user already exists in org
            - Skip if pending invitation already exists for this email
            - Create Invitation with:
              - TenantId = current org ID
              - Token = Guid.NewGuid().ToString("N") (cryptographically random per pitfall #6)
              - ExpiresAt = DateTime.UtcNow.AddDays(7) per locked decision
              - Role = specified role or "Member" default
              - InvitedByUserId = current user ID
            - Send branded invitation email via IEmailService.SendInvitationEmailAsync:
              - joinUrl: `https://{subdomain}.globcrm.com/auth/join/{token}`
              - orgName, inviterName, role per locked decision
         e. Return: { sent: int, skipped: int, warnings: string[] }

    3. **SendInvitationValidator.cs** (FluentValidation):
       - Emails: required, at least 1, max 50 (reasonable bulk limit), each must be valid email
       - Role: must be "Admin" or "Member"

    4. **AcceptInvitationCommand.cs:**
       - Input: Token, Email, Password, FirstName, LastName
       - Handler:
         a. Look up invitation by Token (not tenant-scoped -- need raw query or use TenantDbContext)
         b. Validate: invitation exists, not expired (ExpiresAt > now), not already accepted
         c. Validate: email matches invitation email (case-insensitive)
         d. Create ApplicationUser with:
            - Email, FirstName, LastName
            - OrganizationId = invitation.TenantId
            - EmailConfirmed = true (invitation IS the verification)
         e. Assign role from invitation
         f. Mark invitation as accepted (set AcceptedAt = now)
         g. Return: success with login credentials (or redirect URL)

    5. **ResendInvitationCommand.cs:**
       - Input: InvitationId
       - Handler:
         a. Find invitation, verify it belongs to current org
         b. Reset ExpiresAt to 7 days from now
         c. Generate new token (invalidate old link)
         d. Re-send invitation email
         e. Per locked decision: admin can resend expired invitations

    6. **InvitationRepository.cs:**
       - GetByTokenAsync(string token) -- raw query, not tenant-scoped (invitation token lookup is cross-tenant by design)
       - GetByOrganizationAsync(Guid orgId) -- list all invitations for an org
       - GetPendingByEmailAsync(Guid orgId, string email) -- check for existing pending invite

    7. **InvitationsController.cs:**
       - `POST /api/invitations` -- Send invitations (auth required, Admin role)
         - Accept { emails: string[], role?: string }
         - Execute SendInvitationCommand
         - Return 200 with { sent, skipped, warnings }
       - `POST /api/invitations/accept` -- Accept invitation (no auth required -- this IS signup)
         - Accept { token, email, password, firstName, lastName }
         - Execute AcceptInvitationCommand
         - Return 201 with user info
       - `POST /api/invitations/{id}/resend` -- Resend invitation (auth required, Admin role)
         - Execute ResendInvitationCommand
         - Return 200
       - `GET /api/invitations` -- List invitations for current org (auth required, Admin role)
         - Return list of InvitationDto
       - `GET /api/invitations/{token}/info` -- Get invitation info (no auth -- for join page display)
         - Return { orgName, inviterName, role, email, isExpired }
         - Do NOT expose sensitive data
       - `DELETE /api/invitations/{id}` -- Revoke invitation (auth required, Admin role)
         - Soft delete or mark as revoked

    8. **Register services in DependencyInjection.cs:**
       - InvitationRepository
       - Command handlers
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Verify InvitationsController has all 6 endpoints.
    Verify SendInvitationCommand handles bulk emails with deduplication.
    Verify AcceptInvitationCommand creates user with EmailConfirmed=true.
    Verify invitation token is cryptographically random (Guid.NewGuid).
  </verify>
  <done>
    Invitation system complete: bulk send with soft limit warning, 7-day expiry, branded email delivery, acceptance with account creation, resend with new token, revocation. All invitation emails include org name, inviter name, role, and join link per locked decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logout endpoint and backend integration smoke tests</name>
  <files>
    src/GlobCRM.Application/Auth/LogoutEndpoint.cs
    src/GlobCRM.Api/Program.cs
  </files>
  <action>
    1. **LogoutEndpoint.cs:**
       - `POST /api/auth/logout` (auth required)
       - For Phase 1: logout is primarily client-side (clear tokens)
       - Server-side: log the logout event, optionally invalidate the refresh token
       - Return 200 OK
       - Per locked decision: user can log out from any page (implementation is frontend-driven in Plan 07)

    2. **Update Program.cs** to map the logout endpoint:
       ```csharp
       app.MapPost("/api/auth/logout", LogoutEndpoint.Handle).RequireAuthorization();
       ```

    3. **API endpoint summary verification** -- Verify ALL Phase 1 endpoints exist:
       Auth endpoints (from Plan 03):
       - POST /api/auth/register
       - POST /api/auth/login-extended (custom JWT login)
       - POST /api/auth/refresh
       - GET  /api/auth/confirmEmail
       - POST /api/auth/resendConfirmationEmail
       - POST /api/auth/forgotPassword
       - POST /api/auth/resetPassword
       - POST /api/auth/manage/2fa
       - GET  /api/auth/manage/info
       - POST /api/auth/logout

       Organization endpoints (from Plan 04):
       - POST /api/organizations
       - GET  /api/organizations/check-subdomain
       - POST /api/organizations/{id}/deactivate
       - POST /api/organizations/{id}/reactivate

       Invitation endpoints (from this plan):
       - POST /api/invitations
       - POST /api/invitations/accept
       - POST /api/invitations/{id}/resend
       - GET  /api/invitations
       - GET  /api/invitations/{token}/info
       - DELETE /api/invitations/{id}

    4. **Verify the entire backend compiles and starts:**
       ```bash
       dotnet build GlobCRM.sln
       dotnet run --project src/GlobCRM.Api
       ```
       The API should start without errors (database connection may fail without PostgreSQL, but the app should bootstrap).
  </action>
  <verify>
    Run `dotnet build GlobCRM.sln` -- must compile with 0 errors.
    Run `dotnet run --project src/GlobCRM.Api --launch-profile Development` -- should start (may warn about DB).
    List all mapped endpoints (check Program.cs for all MapPost/MapGet/MapGroup calls).
  </verify>
  <done>
    Logout endpoint mapped. All Phase 1 backend endpoints verified: 10 auth endpoints, 4 organization endpoints, 6 invitation endpoints. Backend compiles and starts cleanly.
  </done>
</task>

</tasks>

<verification>
- `dotnet build GlobCRM.sln` compiles with 0 errors
- All 20 backend endpoints exist and are mapped
- Invitation send handles bulk emails with deduplication
- Invitation acceptance creates user with EmailConfirmed=true and correct role
- Invitation expiry is 7 days per locked decision
- Soft user limit (10) warns but does not block
- Invitation token is cryptographically random
- Logout endpoint exists at POST /api/auth/logout
</verification>

<success_criteria>
Complete invitation system working: admin can bulk-invite users, invitations expire after 7 days, admin can resend, invited users can accept and create accounts. Branded invitation emails sent with org name, inviter name, role, join link per locked decisions. Soft user limit warns at 10 users. Logout endpoint mapped. All 20 Phase 1 backend endpoints verified.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
