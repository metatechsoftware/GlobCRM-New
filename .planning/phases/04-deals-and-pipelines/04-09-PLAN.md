---
phase: 04-deals-and-pipelines
plan: 09
type: execute
wave: 4
depends_on: ["04-07", "04-08"]
files_modified:
  - globcrm-web/package.json
  - globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.ts
  - globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.html
  - globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.scss
  - globcrm-web/src/app/features/deals/deals.routes.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.html
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
autonomous: true

must_haves:
  truths:
    - "User can view deals in a monthly calendar view by expected close date"
    - "Calendar events are color-coded by pipeline stage"
    - "Clicking a calendar event navigates to the deal detail page"
    - "Deals route is wired in app.routes.ts with authGuard"
    - "Navbar includes Deals link between Products and Team"
    - "Company and Contact detail pages show enabled Deals tabs"
  artifacts:
    - path: "globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.ts"
      provides: "Calendar view using FullCalendar"
      contains: "class DealCalendarComponent"
    - path: "globcrm-web/src/app/features/deals/deals.routes.ts"
      provides: "Deal feature routes (list, kanban, calendar, new, detail, edit)"
      contains: "DEAL_ROUTES"
    - path: "globcrm-web/src/app/app.routes.ts"
      provides: "Deals route with authGuard"
      contains: "deals"
    - path: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      provides: "Deals navigation link in navbar"
      contains: "Deals"
  key_links:
    - from: "app.routes.ts"
      to: "deals.routes.ts"
      via: "Lazy-loaded route"
      pattern: "loadChildren.*deals.routes"
    - from: "DealCalendarComponent"
      to: "@fullcalendar/angular"
      via: "FullCalendarModule import"
      pattern: "FullCalendarModule"
    - from: "navbar.component.html"
      to: "/deals"
      via: "routerLink"
      pattern: "routerLink=\"/deals\""
    - from: "company-detail.component.html"
      to: "/deals?companyId=xxx"
      via: "3rd ng-template with routerLink"
      pattern: "routerLink.*deals.*companyId"
    - from: "contact-detail.component.html"
      to: "/deals?contactId=xxx"
      via: "3rd ng-template with routerLink"
      pattern: "routerLink.*deals.*contactId"
---

<objective>
Install FullCalendar, create the calendar view for deals, wire all deal routes, add Deals to the navbar, and enable Deals tabs on Company/Contact detail pages.

Purpose: Fulfills DEAL-05 (calendar view), completes the deals feature routing, and integrates deals into the overall application navigation. This is the final integration plan that connects all deal UI components.
Output: Calendar component, feature routes, app route, navbar link, enabled Deals tabs.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-08-SUMMARY.md
@.planning/phases/04-deals-and-pipelines/04-07-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install FullCalendar and create DealCalendarComponent</name>
  <files>
    globcrm-web/package.json
    globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.ts
    globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.html
    globcrm-web/src/app/features/deals/deal-calendar/deal-calendar.component.scss
  </files>
  <action>
    **Install FullCalendar packages:**
    ```bash
    cd globcrm-web && npm install @fullcalendar/angular @fullcalendar/core @fullcalendar/daygrid @fullcalendar/interaction
    ```

    **DealCalendarComponent (standalone, ChangeDetectionStrategy.OnPush):**

    Inject: DealService, PipelineService, Router

    **State (signals):**
    - pipelines: signal&lt;PipelineDto[]&gt;([])
    - selectedPipelineId: signal&lt;string | null&gt;(null) — filter by pipeline (null = all)
    - deals: signal&lt;DealListDto[]&gt;([])
    - calendarOptions: signal&lt;CalendarOptions&gt;(initial options)
    - isLoading: signal&lt;boolean&gt;(false)

    **On init:**
    1. Load pipelines
    2. Load deals (use DealService.getList with large pageSize, e.g., 500, to get all deals with expectedCloseDate)
    3. Map deals to calendar events

    **FullCalendar setup:**
    ```typescript
    import { FullCalendarModule } from '@fullcalendar/angular';
    import { CalendarOptions, EventInput } from '@fullcalendar/core';
    import dayGridPlugin from '@fullcalendar/daygrid';
    import interactionPlugin from '@fullcalendar/interaction';

    // Initial calendar options:
    calendarOptions = signal<CalendarOptions>({
      plugins: [dayGridPlugin, interactionPlugin],
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: '',
      },
      events: [],
      eventClick: (info) => {
        this.router.navigate(['/deals', info.event.id]);
      },
      height: 'auto',
    });
    ```

    **Map deals to events:**
    ```typescript
    private mapDealsToEvents(deals: DealListDto[]): EventInput[] {
      return deals
        .filter(d => d.expectedCloseDate != null)
        .map(d => ({
          id: d.id,
          title: `${d.title}${d.value ? ' - $' + d.value.toLocaleString() : ''}`,
          date: d.expectedCloseDate,
          backgroundColor: d.stageColor || '#1976d2',
          borderColor: d.stageColor || '#1976d2',
          extendedProps: {
            companyName: d.companyName,
            stageName: d.stageName,
            value: d.value,
          },
        }));
    }
    ```

    **Pipeline filter:**
    - Pipeline selector dropdown (mat-select) at top
    - "All Pipelines" option + individual pipelines
    - On change: reload deals with pipelineId filter, remap to events
    - When updating events, create a NEW array reference for FullCalendar change detection:
      `this.calendarOptions.update(opts => ({ ...opts, events: newEvents }))`

    **View mode switcher** (same as Kanban):
    - List (/deals), Kanban (/deals/kanban), Calendar (active)

    **Template:**
    ```html
    <div class="deal-calendar">
      <div class="calendar-toolbar">
        <!-- Pipeline selector and view mode buttons -->
      </div>
      <full-calendar [options]="calendarOptions()" />
    </div>
    ```

    **SCSS:**
    - Calendar fills available space, clean styling
    - Event styling with rounded corners
    - Toolbar consistent with Kanban toolbar

    Imports: CommonModule, MatCardModule, MatButtonModule, MatIconModule, MatSelectModule, MatFormFieldModule, MatButtonToggleModule, RouterLink, FullCalendarModule
  </action>
  <verify>
    1. `cd globcrm-web && npm ls @fullcalendar/angular` — package installed
    2. `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds
  </verify>
  <done>Calendar view renders deals by expected close date in a month grid, color-coded by stage, with pipeline filtering and click-to-navigate.</done>
</task>

<task type="auto">
  <name>Task 2: Wire deal routes, navbar link, and enable Deals tabs on Company/Contact</name>
  <files>
    globcrm-web/src/app/features/deals/deals.routes.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.html
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.html
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  </files>
  <action>
    **deals.routes.ts — Create deal feature routes:**
    Following the COMPANY_ROUTES pattern:
    ```typescript
    import { Routes } from '@angular/router';
    import { DealListComponent } from './deal-list/deal-list.component';

    export const DEAL_ROUTES: Routes = [
      { path: '', component: DealListComponent },
      {
        path: 'kanban',
        loadComponent: () =>
          import('./deal-kanban/deal-kanban.component').then(m => m.DealKanbanComponent),
      },
      {
        path: 'calendar',
        loadComponent: () =>
          import('./deal-calendar/deal-calendar.component').then(m => m.DealCalendarComponent),
      },
      {
        path: 'new',
        loadComponent: () =>
          import('./deal-form/deal-form.component').then(m => m.DealFormComponent),
      },
      {
        path: ':id',
        loadComponent: () =>
          import('./deal-detail/deal-detail.component').then(m => m.DealDetailComponent),
      },
      {
        path: ':id/edit',
        loadComponent: () =>
          import('./deal-form/deal-form.component').then(m => m.DealFormComponent),
      },
    ];
    ```

    **app.routes.ts — Add deals route:**
    Add between the products route and the empty redirect:
    ```typescript
    {
      path: 'deals',
      canActivate: [authGuard],
      loadChildren: () =>
        import('./features/deals/deals.routes').then(m => m.DEAL_ROUTES),
    },
    ```

    **navbar.component.html — Add Deals navigation link:**
    Add between Products and Team links (following the established order: Dashboard | Companies | Contacts | Products | **Deals** | Team | Settings):
    ```html
    <a routerLink="/deals" routerLinkActive="navbar__link--active" class="navbar__link">
      <mat-icon class="navbar__link-icon">handshake</mat-icon>
      Deals
    </a>
    ```

    **related-entity-tabs.component.ts — Enable Deals tabs:**
    Update COMPANY_TABS and CONTACT_TABS to enable the Deals tab:
    - In COMPANY_TABS: change `{ label: 'Deals', icon: 'handshake', enabled: false }` to `enabled: true`
    - In CONTACT_TABS: change `{ label: 'Deals', icon: 'handshake', enabled: false }` to `enabled: true`

    **company-detail.component.html — Add 3rd ng-template for Deals tab:**
    RelatedEntityTabsComponent maps tab content by index via `contentChildren(TemplateRef)`. Currently there are 2 ng-template blocks (index 0: Timeline, index 1: Contacts). Add a 3rd ng-template (index 2: Deals) inside the `<app-related-entity-tabs>` element:
    ```html
    <ng-template>
      <div class="tab-placeholder">
        <mat-icon>handshake</mat-icon>
        <p>View deals linked to this company</p>
        <a mat-button color="primary" [routerLink]="['/deals']" [queryParams]="{ companyId: company()?.id }">
          View Deals
        </a>
      </div>
    </ng-template>
    ```
    Add RouterLink to the component's imports array in company-detail.component.ts if not already present.

    **contact-detail.component.html — Add 3rd ng-template for Deals tab:**
    Same pattern — currently 2 ng-template blocks (index 0: Timeline, index 1: Company). Add a 3rd ng-template (index 2: Deals):
    ```html
    <ng-template>
      <div class="tab-placeholder">
        <mat-icon>handshake</mat-icon>
        <p>View deals linked to this contact</p>
        <a mat-button color="primary" [routerLink]="['/deals']" [queryParams]="{ contactId: contact()?.id }">
          View Deals
        </a>
      </div>
    </ng-template>
    ```
    Add RouterLink to the component's imports array in contact-detail.component.ts if not already present.

    Full tab content with inline deal list can be enhanced in future phases.
  </action>
  <verify>
    1. `cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds
    2. deals.routes.ts exists with all routes
    3. app.routes.ts contains 'deals' route
    4. navbar has Deals link
    5. COMPANY_TABS and CONTACT_TABS have Deals enabled
  </verify>
  <done>Deals feature is fully routed (list, kanban, calendar, new, detail, edit), accessible from navbar, and Deals tabs are enabled on Company and Contact detail pages.</done>
</task>

</tasks>

<verification>
- FullCalendar packages installed
- Angular builds without errors
- Calendar view renders deals by close date
- deals.routes.ts has 6 routes (list, kanban, calendar, new, detail, edit)
- app.routes.ts includes deals with authGuard
- Navbar shows Deals link with handshake icon
- COMPANY_TABS and CONTACT_TABS have Deals tab enabled
</verification>

<success_criteria>
Complete deal feature integration: calendar view works with FullCalendar, all deal pages are routable, navbar provides navigation, and Company/Contact detail pages can navigate to related deals.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-09-SUMMARY.md`
</output>
