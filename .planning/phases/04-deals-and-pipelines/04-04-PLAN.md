---
phase: 04-deals-and-pipelines
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/deals/deal.models.ts
  - globcrm-web/src/app/features/deals/deal.service.ts
  - globcrm-web/src/app/features/deals/pipeline.service.ts
  - globcrm-web/src/app/features/deals/deal.store.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript models exist for Deal, Pipeline, Stage, Kanban, and all request/response DTOs"
    - "DealService provides full API client for deal CRUD, stage transitions, entity linking, Kanban, and timeline"
    - "PipelineService provides API client for pipeline admin operations"
    - "DealStore manages list state with pagination, sorting, filtering, and detail loading"
  artifacts:
    - path: "globcrm-web/src/app/features/deals/deal.models.ts"
      provides: "All TypeScript interfaces for deal and pipeline DTOs"
      contains: "interface DealListDto"
    - path: "globcrm-web/src/app/features/deals/deal.service.ts"
      provides: "API client for deal endpoints"
      contains: "class DealService"
    - path: "globcrm-web/src/app/features/deals/pipeline.service.ts"
      provides: "API client for pipeline admin endpoints"
      contains: "class PipelineService"
    - path: "globcrm-web/src/app/features/deals/deal.store.ts"
      provides: "NgRx signal store for deal state management"
      contains: "DealStore"
  key_links:
    - from: "DealService"
      to: "ApiService"
      via: "HTTP client wrapper"
      pattern: "inject(ApiService)"
    - from: "DealStore"
      to: "DealService"
      via: "Service injection in store methods"
      pattern: "inject(DealService)"
---

<objective>
Create frontend TypeScript models, API services, and signal store for the deals and pipelines feature module.

Purpose: Establishes the frontend data layer that all deal UI components (list, form, detail, Kanban, calendar) will consume. Runs in parallel with backend plan 04-01 since it defines interfaces without runtime dependency.
Output: deal.models.ts, deal.service.ts, pipeline.service.ts, deal.store.ts in the deals feature directory.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deal and pipeline TypeScript models and API services</name>
  <files>
    globcrm-web/src/app/features/deals/deal.models.ts
    globcrm-web/src/app/features/deals/deal.service.ts
    globcrm-web/src/app/features/deals/pipeline.service.ts
  </files>
  <action>
    Create the deals feature directory and models/services following CompanyService/company.models.ts patterns:

    **deal.models.ts — All TypeScript interfaces:**

    Pipeline models:
    - PipelineDto: id, name, description, teamId, teamName, isDefault, stageCount, dealCount, createdAt
    - PipelineDetailDto: extends PipelineDto with stages: PipelineStageDto[]
    - PipelineStageDto: id, name, sortOrder, color, defaultProbability, isWon, isLost, requiredFields: Record&lt;string, any&gt;
    - CreatePipelineRequest: name, description?, teamId?, isDefault, stages: CreateStageRequest[]
    - UpdatePipelineRequest: same as Create
    - CreateStageRequest: name, sortOrder, color, defaultProbability, isWon, isLost, requiredFields?

    Deal models:
    - DealListDto: id, title, value, probability, expectedCloseDate, stageName, stageColor, pipelineName, companyName, ownerName, customFields, createdAt, updatedAt
    - DealDetailDto: extends list with description, actualCloseDate, pipelineId, pipelineStageId, companyId, ownerId, linkedContacts: LinkedContactDto[], linkedProducts: LinkedProductDto[]
    - LinkedContactDto: id, name (fullName)
    - LinkedProductDto: id, name, quantity, unitPrice
    - CreateDealRequest: title, value?, probability?, expectedCloseDate?, pipelineId, pipelineStageId?, companyId?, ownerId?, description?, customFields?
    - UpdateDealRequest: same fields as Create
    - UpdateStageRequest: stageId (for PATCH stage endpoint)
    - LinkProductRequest: productId, quantity?, unitPrice?
    - KanbanDto: pipelineId, pipelineName, stages: KanbanStageDto[]
    - KanbanStageDto: id, name, color, sortOrder, isWon, isLost, deals: DealKanbanCardDto[]
    - DealKanbanCardDto: id, title, value, companyName, ownerName, expectedCloseDate

    **deal.service.ts — Injectable API client (providedIn: 'root'):**
    Following CompanyService pattern exactly:
    - `getList(params: EntityQueryParams &amp; { pipelineId?: string; stageId?: string }): Observable&lt;PagedResult&lt;DealListDto&gt;&gt;` — build HttpParams including pipelineId/stageId
    - `getById(id: string): Observable&lt;DealDetailDto&gt;`
    - `create(request: CreateDealRequest): Observable&lt;DealListDto&gt;`
    - `update(id: string, request: UpdateDealRequest): Observable&lt;void&gt;`
    - `delete(id: string): Observable&lt;void&gt;`
    - `updateStage(id: string, stageId: string): Observable&lt;void&gt;` — PATCH /api/deals/{id}/stage
    - `linkContact(dealId: string, contactId: string): Observable&lt;void&gt;`
    - `unlinkContact(dealId: string, contactId: string): Observable&lt;void&gt;`
    - `linkProduct(dealId: string, request: LinkProductRequest): Observable&lt;void&gt;`
    - `unlinkProduct(dealId: string, productId: string): Observable&lt;void&gt;`
    - `getKanban(pipelineId: string, includeTerminal?: boolean): Observable&lt;KanbanDto&gt;`
    - `getTimeline(id: string): Observable&lt;TimelineEntry[]&gt;`
    - Private `buildQueryParams` method (same pattern as CompanyService)

    **pipeline.service.ts — Injectable API client (providedIn: 'root'):**
    - basePath = '/api/pipelines'
    - `getAll(): Observable&lt;PipelineDto[]&gt;`
    - `getById(id: string): Observable&lt;PipelineDetailDto&gt;`
    - `create(request: CreatePipelineRequest): Observable&lt;PipelineDto&gt;`
    - `update(id: string, request: UpdatePipelineRequest): Observable&lt;void&gt;`
    - `delete(id: string): Observable&lt;void&gt;`
    - `getStages(pipelineId: string): Observable&lt;PipelineStageDto[]&gt;`
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds or only has warnings (no errors).</verify>
  <done>All deal and pipeline TypeScript interfaces and API service methods exist, matching the backend DTO and endpoint contracts.</done>
</task>

<task type="auto">
  <name>Task 2: Create DealStore NgRx signal store</name>
  <files>
    globcrm-web/src/app/features/deals/deal.store.ts
  </files>
  <action>
    Follow the CompanyStore pattern exactly (component-provided, not root):

    **DealState interface:**
    - items: DealListDto[]
    - totalCount: number
    - page: number (default 1)
    - pageSize: number (default 25)
    - sortField: string | null
    - sortDirection: 'asc' | 'desc'
    - filters: ViewFilter[]
    - search: string
    - pipelineId: string | null (for pipeline filtering on list/Kanban)
    - isLoading: boolean
    - selectedDeal: DealDetailDto | null
    - isDetailLoading: boolean

    **Methods (same pattern as CompanyStore):**
    - loadPage(): void — fetch paged list using DealService.getList, passing pipelineId if set
    - setSort(field, direction): void — update sort + reload
    - setFilters(filters: ViewFilter[]): void — update filters + reload
    - setSearch(search: string): void — update search + reload (page reset to 1)
    - setPage(page: number): void — update page + reload
    - setPageSize(pageSize: number): void — update pageSize + reload (page reset to 1)
    - setPipelineId(pipelineId: string | null): void — update pipeline filter + reload (page reset to 1)
    - loadDetail(id: string): void — fetch deal detail via DealService.getById
    - clearDetail(): void — clear selectedDeal

    Use the same convertFilters helper function as CompanyStore for ViewFilter to FilterParam conversion.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>DealStore provides reactive state management for deal list and detail views, with pipeline filtering support, following the established CompanyStore pattern.</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- deal.models.ts exists with all DTO interfaces
- deal.service.ts has 12 API methods
- pipeline.service.ts has 6 API methods
- deal.store.ts follows CompanyStore pattern with pipeline filtering
</verification>

<success_criteria>
Frontend data layer for deals and pipelines is complete — models match backend DTOs, services cover all API endpoints, and the signal store manages list/detail state with pipeline filtering.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-04-SUMMARY.md`
</output>
