---
phase: 04-deals-and-pipelines
plan: 06
type: execute
wave: 2
depends_on: ["04-04"]
files_modified:
  - globcrm-web/src/app/features/deals/deal-list/deal-list.component.ts
  - globcrm-web/src/app/features/deals/deal-list/deal-list.component.html
  - globcrm-web/src/app/features/deals/deal-list/deal-list.component.scss
  - globcrm-web/src/app/features/deals/deal-form/deal-form.component.ts
  - globcrm-web/src/app/features/deals/deal-form/deal-form.component.html
autonomous: true

must_haves:
  truths:
    - "User can view deals in a dynamic table list view with pagination, sorting, and filtering"
    - "User can create a new deal with title, value, probability, expected close date, pipeline, stage, company, and owner"
    - "User can edit an existing deal"
    - "Deal list supports pipeline filtering via dropdown"
    - "Deal list uses DynamicTableComponent and ViewStore for configurable columns"
  artifacts:
    - path: "globcrm-web/src/app/features/deals/deal-list/deal-list.component.ts"
      provides: "Deal list page with dynamic table and pipeline filter"
      contains: "class DealListComponent"
    - path: "globcrm-web/src/app/features/deals/deal-form/deal-form.component.ts"
      provides: "Deal create/edit form with pipeline/stage selection"
      contains: "class DealFormComponent"
  key_links:
    - from: "DealListComponent"
      to: "DealStore"
      via: "Component-provided signal store"
      pattern: "providers.*DealStore"
    - from: "DealListComponent"
      to: "DynamicTableComponent"
      via: "Template usage"
      pattern: "app-dynamic-table"
    - from: "DealFormComponent"
      to: "DealService"
      via: "API calls for create/update"
      pattern: "inject(DealService)"
---

<objective>
Create the deal list page with dynamic table and the deal create/edit form, providing the standard CRUD interface for deals.

Purpose: Fulfills DEAL-01 (CRUD), DEAL-02 (dynamic table list), DEAL-06 (deal fields), and supports DEAL-09 (custom fields in form). This is the primary deal management interface alongside Kanban.
Output: DealListComponent with dynamic table, DealFormComponent with pipeline/stage selection.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-04-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DealListComponent with dynamic table and pipeline filter</name>
  <files>
    globcrm-web/src/app/features/deals/deal-list/deal-list.component.ts
    globcrm-web/src/app/features/deals/deal-list/deal-list.component.html
    globcrm-web/src/app/features/deals/deal-list/deal-list.component.scss
  </files>
  <action>
    Follow the CompanyListComponent pattern exactly:

    **DealListComponent (standalone, ChangeDetectionStrategy.OnPush):**

    Providers: [DealStore, ViewStore] (component-provided, not root)

    Inject: DealStore, ViewStore, PipelineService, Router, CustomFieldService, MatDialog

    **Column definitions (ColumnDefinition[]):**
    - title (text, visible, sortable)
    - value (number, visible, sortable)
    - probability (number, visible, sortable) — display as percentage
    - expectedCloseDate (date, visible, sortable) — "Close Date"
    - stageName (text, visible, sortable) — "Stage"
    - pipelineName (text, hidden, sortable) — "Pipeline"
    - companyName (text, visible, sortable) — "Company"
    - ownerName (text, visible, sortable) — "Owner"
    - createdAt (date, hidden, sortable)
    - updatedAt (date, hidden, sortable)

    **Pipeline filter dropdown:**
    - Load pipelines via PipelineService.getAll() on init
    - mat-select at top of page alongside search and view switcher buttons (Kanban, Calendar)
    - "All Pipelines" default option, then each pipeline by name
    - On selection: dealStore.setPipelineId(pipelineId)

    **View mode switcher buttons:**
    - Three buttons/toggles: List (active on this page), Kanban (links to /deals/kanban), Calendar (links to /deals/calendar)
    - Use mat-button-toggle-group or simple routerLink buttons

    **Dynamic table integration (same as CompanyListComponent):**
    - Pass columns, items (dealStore.items), totalCount, page, pageSize, sortField, sortDirection to DynamicTableComponent
    - Wire sort/page/search/filter events to DealStore methods
    - ViewStore for saved views (entityType = 'Deal')
    - FilterPanel with ViewStore.activeFilters
    - ViewSidebar for view management
    - Row click navigates to /deals/:id

    **Toolbar:**
    - "New Deal" button with *appHasPermission="'Deal:Create'" linking to /deals/new
    - Delete action with ConfirmDeleteDialogComponent

    Custom field columns: Load via CustomFieldService.getFieldsByEntity('Deal') and append to column definitions (same pattern as CompanyListComponent).

    Imports: CommonModule, MatCardModule, MatButtonModule, MatIconModule, MatSelectModule, MatFormFieldModule, MatButtonToggleModule, RouterLink, DynamicTableComponent, FilterPanelComponent, FilterChipsComponent, ViewSidebarComponent, HasPermissionDirective, ConfirmDeleteDialogComponent
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>Deal list page displays deals in a dynamic table with pipeline filtering, view mode switching, saved views, custom field columns, and CRUD actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create DealFormComponent for deal creation and editing</name>
  <files>
    globcrm-web/src/app/features/deals/deal-form/deal-form.component.ts
    globcrm-web/src/app/features/deals/deal-form/deal-form.component.html
  </files>
  <action>
    Follow the CompanyFormComponent pattern:

    **DealFormComponent (standalone, ChangeDetectionStrategy.OnPush):**

    Inject: DealService, PipelineService, ActivatedRoute, Router, MatSnackBar, CustomFieldService

    **Mode detection:** Edit mode if route has :id param, create mode otherwise. Load existing deal via DealService.getById() in edit mode.

    **Reactive Form (FormGroup):**
    - title: required, maxlength 500
    - description: optional textarea
    - value: optional number (currency input)
    - probability: optional number (0-100, display as percentage)
    - expectedCloseDate: optional date (mat-datepicker)
    - pipelineId: required select (populated from PipelineService.getAll())
    - pipelineStageId: optional select (populated from selected pipeline's stages, auto-select first stage if not specified)
    - companyId: optional autocomplete (same Company autocomplete pattern as ContactFormComponent — debounced search via CompanyService)
    - ownerId: optional select (populated from team directory)
    - customFields: FormGroup (dynamic, populated from CustomFieldService)

    **Pipeline-Stage cascade:**
    - When pipelineId changes, load stages for that pipeline via PipelineService.getStages()
    - If creating, auto-select first stage (lowest sortOrder)
    - If editing and pipeline hasn't changed, preserve current stage selection
    - When stage changes, auto-update probability to stage's defaultProbability (unless user manually overrode it)

    **Custom fields section:**
    - Use CustomFieldFormComponent (shared component from Phase 3)
    - Load field definitions for entity type 'Deal'
    - Pass current customFields values in edit mode

    **Save:**
    - Create: DealService.create(request) then navigate to /deals/:newId
    - Update: DealService.update(id, request) then navigate to /deals/:id
    - Show loading state, validation errors, snackbar on success/error
    - Cancel navigates back to /deals

    Layout: mat-card with form sections — Deal Info, Pipeline & Stage, Company & Owner, Custom Fields. Use provideNativeDateAdapter at component level for datepicker.

    Imports: CommonModule, MatCardModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatDatepickerModule, MatButtonModule, MatIconModule, MatSnackBarModule, MatAutocompleteModule, ReactiveFormsModule, RouterLink, CustomFieldFormComponent
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>Deal form supports creating and editing deals with pipeline/stage cascade selection, company autocomplete, owner selection, custom fields, and proper validation.</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- Deal list component exists with dynamic table, pipeline filter, and view mode switcher
- Deal form component exists with pipeline/stage cascade, company autocomplete, and custom fields
- Both components follow established patterns from CompanyListComponent/CompanyFormComponent
</verification>

<success_criteria>
User can view deals in a filterable, sortable dynamic table with saved views, create new deals with full field entry including pipeline/stage selection and company linking, and edit existing deals.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-06-SUMMARY.md`
</output>
