---
phase: 04-deals-and-pipelines
plan: 05
type: execute
wave: 2
depends_on: ["04-04"]
files_modified:
  - globcrm-web/src/app/features/settings/pipelines/pipeline-list.component.ts
  - globcrm-web/src/app/features/settings/pipelines/pipeline-edit.component.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view a list of all pipelines in settings"
    - "Admin can create a new pipeline with custom stages (name, color, probability, required fields)"
    - "Admin can edit an existing pipeline and reorder/add/remove stages"
    - "Admin can delete an empty pipeline"
    - "Pipeline settings pages are protected by adminGuard"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/pipelines/pipeline-list.component.ts"
      provides: "Pipeline list page with create/edit/delete actions"
      contains: "class PipelineListComponent"
    - path: "globcrm-web/src/app/features/settings/pipelines/pipeline-edit.component.ts"
      provides: "Pipeline editor with stage configuration form"
      contains: "class PipelineEditComponent"
    - path: "globcrm-web/src/app/features/settings/settings.routes.ts"
      provides: "Pipeline routes under /settings/pipelines"
      contains: "pipelines"
  key_links:
    - from: "PipelineEditComponent"
      to: "PipelineService"
      via: "API calls for CRUD"
      pattern: "inject(PipelineService)"
    - from: "settings.routes.ts"
      to: "pipeline components"
      via: "lazy-loaded routes with adminGuard"
      pattern: "pipelines"
---

<objective>
Create admin pipeline configuration pages in the settings section, allowing admins to create and manage deal pipelines with custom stages.

Purpose: Fulfills DEAL-03 (admin configures multiple pipelines with custom stages per team) and DEAL-10 (stage probabilities and required fields). Provides the pipeline configuration UI that deal creation/Kanban depends on.
Output: Pipeline list page, pipeline editor with stage management, settings routes updated.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PipelineListComponent and PipelineEditComponent</name>
  <files>
    globcrm-web/src/app/features/settings/pipelines/pipeline-list.component.ts
    globcrm-web/src/app/features/settings/pipelines/pipeline-edit.component.ts
  </files>
  <action>
    Create pipeline admin pages following the RoleListComponent/RoleEditComponent pattern:

    **PipelineListComponent (standalone):**
    - Inject PipelineService, Router, MatSnackBar
    - Load all pipelines on init via PipelineService.getAll()
    - Display as a mat-card table with columns: Name, Description, Team, Stages (count), Deals (count), Default (chip/badge), Actions
    - "New Pipeline" button at top linking to /settings/pipelines/new
    - Each row has Edit (routerLink to /settings/pipelines/:id) and Delete (with ConfirmDeleteDialogComponent)
    - Delete calls PipelineService.delete() with error handling (shows snackbar if pipeline has deals)
    - Default pipeline shows a mat-chip "Default"
    - Imports: MatCardModule, MatTableModule, MatButtonModule, MatIconModule, MatChipsModule, MatSnackBarModule, RouterLink, ConfirmDeleteDialogComponent

    **PipelineEditComponent (standalone):**
    - Inject PipelineService, ActivatedRoute, Router, MatSnackBar
    - Determine create vs edit mode from route params (id present = edit)
    - If editing, load pipeline with stages via PipelineService.getById()

    Pipeline form (Reactive Forms):
    - name: required, maxlength 200
    - description: optional textarea
    - teamId: optional select (populated from team directory or empty for all teams)
    - isDefault: checkbox

    Stage management section (FormArray):
    - Each stage has: name (required), color (color picker or text input with hex validation), defaultProbability (0-100 number, stored as 0-1), isWon (checkbox), isLost (checkbox)
    - "Add Stage" button appends a new stage FormGroup with defaults
    - Drag reorder stages using CdkDrag/CdkDropList (for sortOrder — use moveItemInArray)
    - Remove stage button (with confirmation if editing existing pipeline)
    - SortOrder auto-calculated from array index
    - Visual stage preview: small colored chip showing stage name and probability

    Required fields per stage (DEAL-10):
    - Each stage has an expandable section for required fields
    - Checkboxes for core deal fields: title (always required), value, probability, expectedCloseDate, companyId, ownerId
    - Stored as requiredFields object on the stage

    Save button:
    - Create mode: PipelineService.create() then navigate to /settings/pipelines
    - Edit mode: PipelineService.update() then navigate to /settings/pipelines
    - Show validation errors, loading state during save
    - Cancel button navigates back

    Imports: MatCardModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatCheckboxModule, MatButtonModule, MatIconModule, MatSnackBarModule, ReactiveFormsModule, CdkDrag, CdkDropList, RouterLink
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>Pipeline list and edit components exist with admin CRUD, stage management with drag-reorder, color/probability configuration, and required fields per stage.</done>
</task>

<task type="auto">
  <name>Task 2: Add pipeline routes to settings</name>
  <files>
    globcrm-web/src/app/features/settings/settings.routes.ts
  </files>
  <action>
    Add pipeline management routes to the existing settings.routes.ts, protected by adminGuard:

    Add these routes (following the same pattern as roles and teams):
    ```
    {
      path: 'pipelines',
      canActivate: [adminGuard],
      loadComponent: () => import('./pipelines/pipeline-list.component').then(m => m.PipelineListComponent),
    },
    {
      path: 'pipelines/new',
      canActivate: [adminGuard],
      loadComponent: () => import('./pipelines/pipeline-edit.component').then(m => m.PipelineEditComponent),
    },
    {
      path: 'pipelines/:id',
      canActivate: [adminGuard],
      loadComponent: () => import('./pipelines/pipeline-edit.component').then(m => m.PipelineEditComponent),
    },
    ```

    Place these AFTER the teams routes and BEFORE the custom-fields route. Pipeline configuration is an admin-level concept alongside roles and teams.
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds. Routes exist in settings.routes.ts.</verify>
  <done>Pipeline admin pages are routable under /settings/pipelines with adminGuard protection, following the established settings page pattern.</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- Pipeline list and edit components exist in settings/pipelines/
- Settings routes include pipelines with adminGuard
- Pipeline edit supports stage drag-reorder and required fields configuration
</verification>

<success_criteria>
Admin can navigate to /settings/pipelines, view all pipelines, create new pipelines with custom stages (including probabilities and required fields), edit existing pipelines, and delete empty pipelines.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-05-SUMMARY.md`
</output>
