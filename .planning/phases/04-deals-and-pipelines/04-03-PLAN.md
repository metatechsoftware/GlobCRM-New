---
phase: 04-deals-and-pipelines
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/GlobCRM.Api/Controllers/PipelinesController.cs
  - src/GlobCRM.Api/Controllers/DealsController.cs
autonomous: true

must_haves:
  truths:
    - "Admin can CRUD pipelines with stages via REST API"
    - "User can CRUD deals with ownership-scoped access via REST API"
    - "Stage transitions create DealStageHistory records"
    - "Deal timeline includes creation, updates, stage changes, and entity link events"
    - "Kanban endpoint returns all deals for a pipeline grouped by stage"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/PipelinesController.cs"
      provides: "Pipeline admin CRUD with stage management"
      contains: "class PipelinesController"
    - path: "src/GlobCRM.Api/Controllers/DealsController.cs"
      provides: "Deal CRUD + stage transition + entity linking + timeline + Kanban"
      contains: "class DealsController"
  key_links:
    - from: "DealsController.UpdateStage"
      to: "DealStageHistory creation"
      via: "Backend stage transition logic"
      pattern: "DealStageHistory"
    - from: "DealsController.GetKanban"
      to: "IDealRepository.GetByPipelineForKanbanAsync"
      via: "Repository method call"
      pattern: "GetByPipelineForKanbanAsync"
    - from: "PipelinesController"
      to: "IPipelineRepository"
      via: "DI injection"
      pattern: "IPipelineRepository"
---

<objective>
Create REST API controllers for Pipeline admin management and Deal CRUD with stage transitions, entity linking, Kanban data endpoint, and timeline.

Purpose: Exposes the backend functionality to the Angular frontend — pipeline configuration for admins, deal management for all users, and specialized endpoints for Kanban board and timeline views.
Output: PipelinesController with 6 endpoints, DealsController with 12+ endpoints.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-02-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PipelinesController with admin CRUD and stage management</name>
  <files>
    src/GlobCRM.Api/Controllers/PipelinesController.cs
  </files>
  <action>
    Follow the CompaniesController pattern but with admin-only access (Authorize(Roles = "Admin")):

    **Endpoints:**
    1. `GET /api/pipelines` — List all pipelines with stages. Returns List&lt;PipelineDto&gt;. No pagination needed (few pipelines per tenant).
    2. `GET /api/pipelines/{id}` — Get pipeline with ordered stages. Returns PipelineDetailDto.
    3. `POST /api/pipelines` — Create pipeline with stages. Request: { name, description?, teamId?, isDefault, stages: [{ name, sortOrder, color, defaultProbability, isWon, isLost, requiredFields? }] }. Validate: name required. If isDefault=true, unset other pipeline's IsDefault.
    4. `PUT /api/pipelines/{id}` — Update pipeline and stages. Full replacement of stages array (delete removed, add new, update existing). Check HasDealsInStageAsync before removing a stage that has deals — return 400 with "Stage '{name}' has active deals. Reassign deals before removing."
    5. `DELETE /api/pipelines/{id}` — Delete pipeline. Block if pipeline has any deals (return 400). Only allow deleting empty pipelines.
    6. `GET /api/pipelines/{id}/stages` — List stages for a pipeline (useful for dropdowns). Returns List&lt;PipelineStageDto&gt;.

    **DTOs (inline records):**
    - PipelineDto: id, name, description, teamId, teamName, isDefault, stageCount, dealCount, createdAt
    - PipelineDetailDto: extends PipelineDto with stages array
    - PipelineStageDto: id, name, sortOrder, color, defaultProbability, isWon, isLost, requiredFields
    - CreatePipelineRequest, UpdatePipelineRequest with FluentValidation

    **Authorization:** All endpoints use [Authorize(Roles = "Admin")] at controller level. Pipeline is admin-config, not entity-permissioned.

    Set TenantId from ITenantProvider on create.
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors.</verify>
  <done>PipelinesController has 6 REST endpoints for admin pipeline and stage management with proper authorization and validation.</done>
</task>

<task type="auto">
  <name>Task 2: Create DealsController with CRUD, stage transitions, entity linking, Kanban, and timeline</name>
  <files>
    src/GlobCRM.Api/Controllers/DealsController.cs
  </files>
  <action>
    Follow the CompaniesController pattern with ownership scope enforcement:

    **Core CRUD endpoints:**
    1. `GET /api/deals` — Paged deal list. Query params: page, pageSize, sortField, sortDirection, search, filters, pipelineId?, stageId?. Returns PagedResult&lt;DealListDto&gt;. Apply ownership scope via IPermissionService (same as CompaniesController).
    2. `GET /api/deals/{id}` — Deal detail with links. Returns DealDetailDto including linked contacts, products, stage info. Check ownership scope.
    3. `POST /api/deals` — Create deal. Request: { title, value?, probability?, expectedCloseDate?, pipelineId, pipelineStageId?, companyId?, ownerId?, description?, customFields? }. If pipelineStageId not provided, default to first stage of pipeline (SortOrder=0). Validate custom fields. Set TenantId. [Authorize(Policy = "Permission:Deal:Create")]
    4. `PUT /api/deals/{id}` — Update deal. If PipelineStageId changes, create DealStageHistory record. If new stage IsWon or IsLost, set ActualCloseDate. Auto-update Probability to stage's DefaultProbability when stage changes (unless user explicitly set Probability). Validate custom fields. [Authorize(Policy = "Permission:Deal:Update")]
    5. `DELETE /api/deals/{id}` — Delete deal. [Authorize(Policy = "Permission:Deal:Delete")]

    **Stage transition endpoint:**
    6. `PATCH /api/deals/{id}/stage` — Dedicated stage change endpoint (used by Kanban drag-drop). Request: { stageId }. Validates stage belongs to same pipeline. Creates DealStageHistory. Updates Probability. Sets ActualCloseDate on terminal stages. Returns 204 NoContent. [Authorize(Policy = "Permission:Deal:Update")]

    **Entity linking endpoints:**
    7. `POST /api/deals/{id}/contacts/{contactId}` — Link contact to deal. Creates DealContact. Returns 201. [Authorize(Policy = "Permission:Deal:Update")]
    8. `DELETE /api/deals/{id}/contacts/{contactId}` — Unlink contact. Deletes DealContact. Returns 204. [Authorize(Policy = "Permission:Deal:Update")]
    9. `POST /api/deals/{id}/products` — Link product. Request: { productId, quantity?, unitPrice? }. Creates DealProduct. Returns 201. [Authorize(Policy = "Permission:Deal:Update")]
    10. `DELETE /api/deals/{id}/products/{productId}` — Unlink product. Deletes DealProduct. Returns 204. [Authorize(Policy = "Permission:Deal:Update")]

    **View endpoints:**
    11. `GET /api/deals/kanban?pipelineId={id}&includeTerminal=false` — Get all deals for Kanban board. Returns KanbanDto with stages array, each containing its deals. Uses GetByPipelineForKanbanAsync. [Authorize(Policy = "Permission:Deal:View")]
    12. `GET /api/deals/{id}/timeline` — Deal timeline. Aggregates: creation event, update events, stage history events (from DealStageHistory), contact link/unlink events, product link/unlink events. Returns List&lt;TimelineEntry&gt;. [Authorize(Policy = "Permission:Deal:View")]

    **DTOs (inline records):**
    - DealListDto: id, title, value, probability, expectedCloseDate, stageName, stageColor, pipelineName, companyName, ownerName, customFields, createdAt, updatedAt
    - DealDetailDto: extends list with description, actualCloseDate, pipelineId, pipelineStageId, companyId, ownerId, linkedContacts (id, name), linkedProducts (id, name, quantity, unitPrice)
    - KanbanDto: pipelineId, pipelineName, stages: [{ id, name, color, sortOrder, isWon, isLost, deals: DealKanbanCardDto[] }]
    - DealKanbanCardDto: id, title, value, companyName, ownerName, expectedCloseDate

    **Authorization:** Controller-level [Authorize] with per-endpoint policy attributes. Ownership scope checked on list and detail (same IsWithinScope pattern as CompaniesController). GetTeamMemberIds helper (same pattern).
  </action>
  <verify>`dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors.</verify>
  <done>DealsController has 12 REST endpoints covering CRUD, stage transitions with history, entity linking, Kanban data, and timeline generation with proper ownership scope and permission enforcement.</done>
</task>

</tasks>

<verification>
- Solution builds with 0 errors
- PipelinesController exists with 6 endpoints (all admin-only)
- DealsController exists with 12 endpoints (permission-scoped)
- Stage transitions create DealStageHistory records
- Kanban endpoint returns structured stage+deals data
- Timeline aggregates creation, updates, stage changes, and link events
</verification>

<success_criteria>
Complete REST API for pipeline management and deal operations, ready for frontend consumption. Admin can configure pipelines, users can manage deals with stage transitions tracked in history.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-03-SUMMARY.md`
</output>
