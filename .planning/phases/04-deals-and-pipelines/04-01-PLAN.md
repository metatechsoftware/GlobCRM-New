---
phase: 04-deals-and-pipelines
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Pipeline.cs
  - src/GlobCRM.Domain/Entities/PipelineStage.cs
  - src/GlobCRM.Domain/Entities/Deal.cs
  - src/GlobCRM.Domain/Entities/DealContact.cs
  - src/GlobCRM.Domain/Entities/DealProduct.cs
  - src/GlobCRM.Domain/Entities/DealStageHistory.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/PipelineConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/PipelineStageConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DealContactConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DealProductConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DealStageHistoryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - scripts/rls-setup.sql
autonomous: true

must_haves:
  truths:
    - "Pipeline, PipelineStage, Deal, DealContact, DealProduct, DealStageHistory entities exist in Domain layer"
    - "EF Core configurations produce correct snake_case database schema"
    - "Migration creates all 6 tables with proper FK constraints and indexes"
    - "RLS policies isolate Pipeline and Deal data per tenant"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Pipeline.cs"
      provides: "Pipeline entity with TenantId, TeamId, IsDefault, Stages navigation"
      contains: "public class Pipeline"
    - path: "src/GlobCRM.Domain/Entities/Deal.cs"
      provides: "Deal entity with PipelineId, PipelineStageId, Value, Probability, OwnerId, CustomFields JSONB"
      contains: "public class Deal"
    - path: "src/GlobCRM.Domain/Entities/DealStageHistory.cs"
      provides: "Stage transition audit trail entity"
      contains: "public class DealStageHistory"
    - path: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      provides: "DbSets and query filters for Pipeline and Deal"
      contains: "DbSet<Deal>"
  key_links:
    - from: "Deal.PipelineStageId"
      to: "PipelineStage.Id"
      via: "non-nullable FK"
      pattern: "public Guid PipelineStageId"
    - from: "DealStageHistory.DealId"
      to: "Deal.Id"
      via: "FK with Cascade delete"
      pattern: "public Guid DealId"
---

<objective>
Create all 6 domain entities for the deals and pipelines subsystem, their EF Core configurations, database migration, and RLS policies.

Purpose: Establishes the data foundation for configurable deal pipelines with stage tracking, entity linking (contacts, products), and stage history audit trail.
Output: 6 domain entities, 6 EF Core configs, 1 migration, updated RLS script, updated ApplicationDbContext.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/03-core-crm-entities/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pipeline, PipelineStage, Deal, DealContact, DealProduct, DealStageHistory domain entities</name>
  <files>
    src/GlobCRM.Domain/Entities/Pipeline.cs
    src/GlobCRM.Domain/Entities/PipelineStage.cs
    src/GlobCRM.Domain/Entities/Deal.cs
    src/GlobCRM.Domain/Entities/DealContact.cs
    src/GlobCRM.Domain/Entities/DealProduct.cs
    src/GlobCRM.Domain/Entities/DealStageHistory.cs
  </files>
  <action>
    Create 6 domain entities following the established CRM entity pattern from Company.cs/Contact.cs:

    **Pipeline.cs** — Admin-configured pipeline (tenant-scoped):
    - Guid Id, Guid TenantId, string Name, string? Description
    - Guid? TeamId (optional team scope, FK to Team), Team? Team navigation
    - bool IsDefault (default pipeline for new deals)
    - DateTimeOffset CreatedAt/UpdatedAt
    - ICollection&lt;PipelineStage&gt; Stages, ICollection&lt;Deal&gt; Deals navigations

    **PipelineStage.cs** — Stage within a pipeline (child entity, no TenantId — inherits via Pipeline FK):
    - Guid Id, Guid PipelineId, Pipeline Pipeline navigation
    - string Name, int SortOrder, string Color (default "#1976d2")
    - decimal DefaultProbability (0.0-1.0, e.g., 0.25 for 25%)
    - bool IsWon, bool IsLost (terminal stages)
    - Dictionary&lt;string, object?&gt; RequiredFields (JSONB — stores field IDs that must be filled before entering this stage)
    - DateTimeOffset CreatedAt/UpdatedAt

    **Deal.cs** — Core CRM entity (tenant-scoped, triple-layer isolation):
    - Guid Id, Guid TenantId
    - string Title, decimal? Value, decimal? Probability
    - DateOnly? ExpectedCloseDate, DateOnly? ActualCloseDate
    - Guid PipelineId (non-nullable FK), Pipeline Pipeline
    - Guid PipelineStageId (non-nullable FK), PipelineStage Stage
    - Guid? OwnerId, ApplicationUser? Owner (ownership scoping)
    - Guid? CompanyId (nullable FK, same pattern as Contact.CompanyId), Company? Company
    - Dictionary&lt;string, object?&gt; CustomFields (JSONB with GIN index)
    - string? Description, bool IsSeedData
    - DateTimeOffset CreatedAt/UpdatedAt
    - ICollection&lt;DealContact&gt; DealContacts, ICollection&lt;DealProduct&gt; DealProducts navigations

    **DealContact.cs** — Many-to-many join (child entity, no TenantId):
    - Guid DealId, Deal Deal, Guid ContactId, Contact Contact
    - DateTimeOffset LinkedAt

    **DealProduct.cs** — Many-to-many join with quantity (child entity, no TenantId):
    - Guid DealId, Deal Deal, Guid ProductId, Product Product
    - int Quantity (default 1), decimal? UnitPrice (override product price)
    - DateTimeOffset LinkedAt

    **DealStageHistory.cs** — Stage transition audit (child entity, no TenantId):
    - Guid Id, Guid DealId, Deal Deal
    - Guid FromStageId, PipelineStage FromStage
    - Guid ToStageId, PipelineStage ToStage
    - Guid? ChangedByUserId, ApplicationUser? ChangedByUser
    - DateTimeOffset ChangedAt

    Also add navigation collection `public ICollection&lt;Deal&gt; Deals { get; set; } = new List&lt;Deal&gt;();` to the existing Company entity for the Deal-Company relationship.
  </action>
  <verify>Solution builds with `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors.</verify>
  <done>All 6 entity classes exist in src/GlobCRM.Domain/Entities/ with correct properties, navigations, and XML doc comments following the Company/Contact pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, update ApplicationDbContext, add RLS policies, generate migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/PipelineConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/PipelineStageConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DealContactConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DealProductConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DealStageHistoryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create 6 EF Core configurations following the CompanyConfiguration/ContactConfiguration pattern:

    **PipelineConfiguration.cs:**
    - Table "pipelines", snake_case columns (id, tenant_id, name, description, team_id, is_default, created_at, updated_at)
    - Name: required, maxlength 200
    - TeamId FK: optional, DeleteBehavior.SetNull (if team deleted, pipeline remains but loses team scope)
    - Index on tenant_id
    - HasMany(Stages) with cascade delete

    **PipelineStageConfiguration.cs:**
    - Table "pipeline_stages", snake_case columns
    - PipelineId FK: required, DeleteBehavior.Cascade (stages deleted with pipeline)
    - RequiredFields: JSONB column "required_fields" with default empty "{}" (same HasConversion pattern as CustomFields)
    - Color: maxlength 7, default "#1976d2"
    - DefaultProbability: decimal(3,2)
    - Composite index on (pipeline_id, sort_order)

    **DealConfiguration.cs:**
    - Table "deals", snake_case columns
    - Title: required, maxlength 500
    - Value: decimal(18,2) precision
    - Probability: decimal(3,2) precision
    - PipelineId FK: required, DeleteBehavior.Restrict (can't delete pipeline with deals)
    - PipelineStageId FK: required, DeleteBehavior.Restrict (can't delete stage with deals)
    - OwnerId FK: optional, DeleteBehavior.SetNull
    - CompanyId FK: optional, DeleteBehavior.SetNull
    - CustomFields: JSONB column "custom_fields" with GIN index (same pattern as CompanyConfiguration)
    - Indexes: tenant_id, owner_id, pipeline_id, company_id, expected_close_date

    **DealContactConfiguration.cs:**
    - Table "deal_contacts", composite PK on (DealId, ContactId)
    - DealId FK: Cascade, ContactId FK: Cascade (deleting deal or contact removes the link)
    - Index on contact_id for reverse lookups

    **DealProductConfiguration.cs:**
    - Table "deal_products", composite PK on (DealId, ProductId)
    - DealId FK: Cascade, ProductId FK: Cascade
    - Quantity: default 1
    - UnitPrice: decimal(18,4) precision (same as Product.UnitPrice)
    - Index on product_id

    **DealStageHistoryConfiguration.cs:**
    - Table "deal_stage_histories", snake_case columns
    - DealId FK: Cascade (history deleted with deal)
    - FromStageId FK: Restrict (can't delete stage with history)
    - ToStageId FK: Restrict
    - ChangedByUserId FK: SetNull
    - Index on deal_id for timeline queries, index on changed_at

    **ApplicationDbContext updates:**
    - Add 6 DbSets: Pipelines, PipelineStages, Deals, DealContacts, DealProducts, DealStageHistories
    - Add global query filters for Pipeline (TenantId) and Deal (TenantId) — same pattern as Company
    - PipelineStage, DealContact, DealProduct, DealStageHistory do NOT need query filters (child entities)
    - Apply all 6 configurations in OnModelCreating

    **RLS policies (scripts/rls-setup.sql):**
    - Add RLS for "pipelines" table (same pattern as companies/contacts/products)
    - Add RLS for "deals" table (same pattern)
    - NO RLS for pipeline_stages, deal_contacts, deal_products, deal_stage_histories (child tables accessed via FK joins)

    **Migration:**
    - Run: `dotnet ef migrations add AddDealsAndPipelines --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext --output-dir Persistence/Migrations/App`
  </action>
  <verify>
    1. `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors
    2. Migration file exists in src/GlobCRM.Infrastructure/Persistence/Migrations/App/
    3. `dotnet ef migrations list --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext` shows AddDealsAndPipelines
  </verify>
  <done>6 EF Core configurations with snake_case naming and proper FK/cascade rules, ApplicationDbContext has 6 new DbSets with query filters, RLS policies for pipelines and deals tables, migration generated successfully.</done>
</task>

</tasks>

<verification>
- Solution builds with 0 errors
- 6 entity files exist in src/GlobCRM.Domain/Entities/
- 6 configuration files exist in src/GlobCRM.Infrastructure/Persistence/Configurations/
- ApplicationDbContext has DbSets for all 6 entities
- Migration file generated and listed
- RLS policies added for pipelines and deals tables
</verification>

<success_criteria>
All 6 domain entities and EF Core configurations are created, ApplicationDbContext is updated, RLS policies are added, and the migration is generated — establishing the complete data foundation for the deals and pipelines subsystem.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-01-SUMMARY.md`
</output>
