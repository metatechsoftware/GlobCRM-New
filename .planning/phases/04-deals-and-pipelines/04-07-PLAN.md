---
phase: 04-deals-and-pipelines
plan: 07
type: execute
wave: 3
depends_on: ["04-06"]
files_modified:
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.html
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.scss
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
autonomous: true

must_haves:
  truths:
    - "User can view deal details with pipeline stage info, value, probability, and dates"
    - "Deal detail page shows linked contacts and products in tabs"
    - "Deal detail page shows entity timeline with stage history"
    - "User can link and unlink contacts and products from deal detail"
    - "DEAL_TABS configuration exists for the deal detail page"
  artifacts:
    - path: "globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts"
      provides: "Deal detail page with tabs, timeline, and entity linking"
      contains: "class DealDetailComponent"
    - path: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      provides: "DEAL_TABS configuration added"
      contains: "DEAL_TABS"
  key_links:
    - from: "DealDetailComponent"
      to: "DealService.getTimeline"
      via: "Timeline data loading"
      pattern: "getTimeline"
    - from: "DealDetailComponent"
      to: "DealService.linkContact/unlinkContact"
      via: "Entity linking API calls"
      pattern: "linkContact"
    - from: "DealDetailComponent"
      to: "RelatedEntityTabsComponent"
      via: "Template usage with DEAL_TABS"
      pattern: "app-related-entity-tabs"
---

<objective>
Create the deal detail page with tabbed layout showing deal info, linked contacts, linked products, and entity timeline with stage history.

Purpose: Fulfills DEAL-07 (link deals to contacts, companies, products) and DEAL-08 (deal detail page with entity timeline). Provides the complete deal view with relational navigation.
Output: DealDetailComponent with 5 tabs (Details, Contacts, Products, Activities, Timeline).
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-06-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DEAL_TABS config and create DealDetailComponent</name>
  <files>
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.html
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.scss
  </files>
  <action>
    **Update related-entity-tabs.component.ts:**
    Add DEAL_TABS configuration alongside existing COMPANY_TABS, CONTACT_TABS, PRODUCT_TABS:
    ```typescript
    export const DEAL_TABS: EntityTab[] = [
      { label: 'Details', icon: 'info', enabled: true },
      { label: 'Contacts', icon: 'people', enabled: true },
      { label: 'Products', icon: 'inventory_2', enabled: true },
      { label: 'Activities', icon: 'task_alt', enabled: false },
      { label: 'Timeline', icon: 'timeline', enabled: true },
    ];
    ```

    **DealDetailComponent (standalone, ChangeDetectionStrategy.OnPush):**

    Providers: [DealStore] (component-provided for per-page isolation)

    Inject: DealStore, DealService, ActivatedRoute, Router, MatSnackBar, MatDialog

    **On init:**
    - Load deal detail via dealStore.loadDetail(id) from route params
    - Load timeline via DealService.getTimeline(id)

    **Header section:**
    - Deal title (h2)
    - Stage badge (colored chip showing current stage name and pipeline name)
    - Value display (formatted currency)
    - Probability display (percentage)
    - Expected close date
    - Owner name
    - Company name (linked to /companies/:companyId)
    - Edit button (*appHasPermission="'Deal:Update'") linking to /deals/:id/edit
    - Delete button (*appHasPermission="'Deal:Delete'") with ConfirmDeleteDialogComponent

    **Tab content using RelatedEntityTabsComponent with DEAL_TABS:**

    Tab 0 — Details:
    - Description, actual close date, custom fields display
    - Pipeline and stage info
    - Created/updated timestamps

    Tab 1 — Contacts:
    - List of linked contacts (from dealDetailDto.linkedContacts)
    - Each contact row: name (linked to /contacts/:id), actions: unlink
    - "Link Contact" button: opens a dialog/autocomplete to search contacts and link via DealService.linkContact()
    - Unlink calls DealService.unlinkContact() with confirmation

    Tab 2 — Products:
    - List of linked products (from dealDetailDto.linkedProducts)
    - Each product row: name (linked to /products/:id), quantity, unit price, subtotal
    - "Link Product" button: opens a dialog to search products, set quantity/price, link via DealService.linkProduct()
    - Unlink calls DealService.unlinkProduct() with confirmation
    - Total value computed from linked products (sum of quantity * unitPrice)

    Tab 3 — Activities (disabled, "coming soon")

    Tab 4 — Timeline:
    - Use EntityTimelineComponent (shared from Phase 3)
    - Pass timeline entries from DealService.getTimeline()
    - Timeline shows: deal creation, updates, stage transitions (with from/to stage names), contact linked/unlinked, product linked/unlinked

    **Contact/Product link dialogs:**
    - Simple inline autocomplete or a dialog component
    - Contact linking: text search, select from results, call linkContact
    - Product linking: text search, select from results, enter quantity (default 1) and optional unit price override, call linkProduct
    - After linking, reload deal detail to refresh the tab data

    Imports: CommonModule, MatCardModule, MatButtonModule, MatIconModule, MatChipsModule, MatSnackBarModule, MatDialogModule, MatAutocompleteModule, MatFormFieldModule, MatInputModule, RouterLink, RelatedEntityTabsComponent, EntityTimelineComponent, HasPermissionDirective, ConfirmDeleteDialogComponent
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>Deal detail page shows all deal information in tabs: details with custom fields, linked contacts with link/unlink, linked products with quantities, and entity timeline with stage history.</done>
</task>

<task type="auto">
  <name>Task 2: Add stage_changed timeline type to shared query models</name>
  <files>
    globcrm-web/src/app/shared/models/query.models.ts
  </files>
  <action>
    Update the TimelineEntry type union to include deal-specific timeline event types:

    Add to the `type` union in TimelineEntry interface:
    - 'stage_changed' — for pipeline stage transitions
    - 'product_linked' — for product linkage events
    - 'product_unlinked' — for product removal events

    The existing types already include 'contact_linked', 'contact_unlinked', 'deal_created' which cover contact linking and deal creation events.

    Updated type union:
    ```typescript
    type: 'created' | 'updated' | 'contact_linked' | 'contact_unlinked' | 'deal_created' | 'stage_changed' | 'product_linked' | 'product_unlinked' | 'activity' | 'note' | 'email';
    ```
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>TimelineEntry type union includes stage_changed, product_linked, and product_unlinked event types for deal timeline display.</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- DEAL_TABS added to related-entity-tabs.component.ts
- DealDetailComponent exists with 5 tabs (Details, Contacts, Products, Activities, Timeline)
- Contact and product linking/unlinking works via DealService
- TimelineEntry type includes deal-specific event types
</verification>

<success_criteria>
Deal detail page provides a complete view of a deal with relational navigation to linked contacts and products, entity timeline with stage history, and CRUD actions with proper permission enforcement.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-07-SUMMARY.md`
</output>
