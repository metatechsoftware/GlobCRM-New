---
phase: 04-deals-and-pipelines
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Api/Controllers/DealsController.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Deal detail timeline shows stage change entries with swap_horiz icon and orange color"
    - "Stage history entries do not fall back to the generic grey circle icon"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/DealsController.cs"
      provides: "GetTimeline endpoint emitting type: stage_changed"
      contains: "Type = \"stage_changed\""
  key_links:
    - from: "src/GlobCRM.Api/Controllers/DealsController.cs"
      to: "globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts"
      via: "DealTimelineEntryDto.Type string value matched against TIMELINE_ICONS key"
      pattern: "stage_changed"
---

<objective>
Fix the type string mismatch between the backend timeline emitter and the frontend icon/color map so that deal stage change entries render with the correct visual indicator.

Purpose: SC7 is partially failing because `DealsController.GetTimeline` emits `Type = "stage_change"` but `EntityTimelineComponent.TIMELINE_ICONS` and `TIMELINE_COLORS` are keyed on `"stage_changed"`. The frontend falls back to a grey circle icon. Fixing the backend string closes the gap with zero risk of regression.

Output: `DealsController.cs` updated at line 666; stage history timeline entries render with the orange `swap_horiz` icon.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stage_change → stage_changed in DealsController.GetTimeline</name>
  <files>src/GlobCRM.Api/Controllers/DealsController.cs</files>
  <action>
    In `src/GlobCRM.Api/Controllers/DealsController.cs`, locate the `GetTimeline` method (around line 660).

    Find the foreach loop that iterates over `stageHistory` entries:

    ```csharp
    foreach (var history in stageHistory)
    {
        entries.Add(new DealTimelineEntryDto
        {
            Id = history.Id,
            Type = "stage_change",
            ...
    ```

    Change `Type = "stage_change"` to `Type = "stage_changed"` (add trailing 'd').

    This is the only change needed. Do NOT modify any other type strings ("created", "updated", "contact_added", etc.) — those are unrelated and already correct.

    The frontend `EntityTimelineComponent` at `globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts` has TIMELINE_ICONS and TIMELINE_COLORS keyed on `'stage_changed'` and the `TimelineEntry` type union in `globcrm-web/src/app/shared/models/query.models.ts` also uses `'stage_changed'` — no frontend changes are needed.
  </action>
  <verify>
    1. Confirm the string is changed: `grep -n "stage_change" src/GlobCRM.Api/Controllers/DealsController.cs` — should return zero matches for bare `"stage_change"` (i.e., no line with `"stage_change"` without the trailing 'd').
    2. Confirm the corrected value is present: `grep -n "stage_changed" src/GlobCRM.Api/Controllers/DealsController.cs` — should show line ~666 with `Type = "stage_changed"`.
    3. Build the backend to confirm no compilation errors: `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj --no-restore -v quiet`
  </verify>
  <done>
    `grep "stage_change[^d]" src/GlobCRM.Api/Controllers/DealsController.cs` returns no results.
    `grep "stage_changed" src/GlobCRM.Api/Controllers/DealsController.cs` returns exactly one match at the type assignment.
    `dotnet build` exits with code 0.
  </done>
</task>

</tasks>

<verification>
After the fix:

1. Static check — `grep -n '"stage_change"' src/GlobCRM.Api/Controllers/DealsController.cs` returns no lines (old bare string gone).
2. Static check — `grep -n '"stage_changed"' src/GlobCRM.Api/Controllers/DealsController.cs` returns one line inside the stage history loop.
3. Build check — `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj -v quiet` exits 0.
4. Cross-file alignment — `grep -n "stage_changed" globcrm-web/src/app/shared/components/entity-timeline/entity-timeline.component.ts` returns TIMELINE_ICONS and TIMELINE_COLORS entries, confirming the frontend already expects the corrected string.
</verification>

<success_criteria>
SC7 gap closed: the backend `DealsController.GetTimeline` endpoint emits `type: "stage_changed"` matching the frontend `EntityTimelineComponent` icon/color map key. Stage history entries in the deal detail timeline will render with the orange `swap_horiz` icon rather than the fallback grey circle. No other behavior is affected.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-10-SUMMARY.md` documenting the gap closure.
</output>
