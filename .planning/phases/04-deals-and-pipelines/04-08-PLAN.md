---
phase: 04-deals-and-pipelines
plan: 08
type: execute
wave: 3
depends_on: ["04-04"]
files_modified:
  - globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts
  - globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.html
  - globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss
autonomous: true

must_haves:
  truths:
    - "User can view deals as a Kanban board with columns per pipeline stage"
    - "User can drag and drop deal cards between stage columns"
    - "Drag-drop triggers optimistic UI update and API call to update deal stage"
    - "Failed stage transitions revert the card back to original column with error message"
    - "Kanban board has pipeline selector to switch between pipelines"
  artifacts:
    - path: "globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts"
      provides: "Kanban board with CDK drag-drop for deal stage transitions"
      contains: "class DealKanbanComponent"
  key_links:
    - from: "DealKanbanComponent"
      to: "DealService.getKanban"
      via: "Kanban data loading"
      pattern: "getKanban"
    - from: "DealKanbanComponent"
      to: "DealService.updateStage"
      via: "Stage transition on drop"
      pattern: "updateStage"
    - from: "DealKanbanComponent"
      to: "CdkDropListGroup + CdkDropList + CdkDrag"
      via: "Angular CDK drag-drop imports"
      pattern: "cdkDropListGroup"
---

<objective>
Create the deal Kanban board component with Angular CDK drag-and-drop for visual pipeline stage management.

Purpose: Fulfills DEAL-04 (Kanban board with drag-and-drop stage changes). This is the primary visual pipeline management interface, enabling users to see deal flow and move deals between stages intuitively.
Output: DealKanbanComponent with CDK drag-drop, pipeline selection, optimistic updates, and error handling.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DealKanbanComponent with CDK drag-drop stage transitions</name>
  <files>
    globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.ts
    globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.html
    globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss
  </files>
  <action>
    **DealKanbanComponent (standalone, ChangeDetectionStrategy.OnPush):**

    Inject: DealService, PipelineService, Router, MatSnackBar

    **State (signals):**
    - pipelines: signal&lt;PipelineDto[]&gt;([]) — all pipelines for selector
    - selectedPipelineId: signal&lt;string | null&gt;(null) — currently active pipeline
    - kanbanData: signal&lt;KanbanDto | null&gt;(null) — loaded Kanban data with stages and deals
    - isLoading: signal&lt;boolean&gt;(false)
    - includeTerminal: signal&lt;boolean&gt;(false) — toggle to show/hide Closed Won/Lost columns

    **On init:**
    1. Load pipelines via PipelineService.getAll()
    2. Select default pipeline (first with isDefault=true, or first in list)
    3. Load Kanban data via DealService.getKanban(pipelineId, includeTerminal)

    **Template structure:**

    Header toolbar:
    - Pipeline selector (mat-select with pipeline list)
    - "Show Closed" toggle (mat-slide-toggle for includeTerminal)
    - View mode buttons: List (/deals), Kanban (active), Calendar (/deals/calendar)
    - "New Deal" button with *appHasPermission="'Deal:Create'" linking to /deals/new

    Kanban board (horizontal scrollable container):
    ```html
    &lt;div class="kanban-board" cdkDropListGroup&gt;
      @for (stage of kanbanData()?.stages; track stage.id) {
        &lt;div class="kanban-column"&gt;
          &lt;div class="column-header" [style.border-top-color]="stage.color"&gt;
            &lt;span class="column-title"&gt;{{ stage.name }}&lt;/span&gt;
            &lt;span class="column-count"&gt;{{ stage.deals.length }}&lt;/span&gt;
            &lt;span class="column-total"&gt;{{ getColumnTotal(stage) | currency }}&lt;/span&gt;
          &lt;/div&gt;
          &lt;div cdkDropList
               [cdkDropListData]="stage.deals"
               (cdkDropListDropped)="onDrop($event, stage.id)"
               class="column-body"&gt;
            @for (deal of stage.deals; track deal.id) {
              &lt;div cdkDrag class="deal-card" (click)="openDeal(deal.id)"&gt;
                &lt;div class="deal-title"&gt;{{ deal.title }}&lt;/div&gt;
                @if (deal.value) {
                  &lt;div class="deal-value"&gt;{{ deal.value | currency }}&lt;/div&gt;
                }
                @if (deal.companyName) {
                  &lt;div class="deal-company"&gt;{{ deal.companyName }}&lt;/div&gt;
                }
                @if (deal.ownerName) {
                  &lt;div class="deal-owner"&gt;{{ deal.ownerName }}&lt;/div&gt;
                }
                @if (deal.expectedCloseDate) {
                  &lt;div class="deal-date"&gt;{{ deal.expectedCloseDate }}&lt;/div&gt;
                }
              &lt;/div&gt;
            }
          &lt;/div&gt;
        &lt;/div&gt;
      }
    &lt;/div&gt;
    ```

    **Drop handler (onDrop):**
    ```typescript
    onDrop(event: CdkDragDrop<DealKanbanCardDto[]>, targetStageId: string): void {
      if (event.previousContainer === event.container) {
        // Reorder within same column — just visual, no API call
        moveItemInArray(event.container.data, event.previousIndex, event.currentIndex);
        return;
      }

      // Cross-column transfer (stage change)
      const deal = event.previousContainer.data[event.previousIndex];
      const previousStageId = this.getStageIdForContainer(event.previousContainer);

      // Optimistic update: move card immediately
      transferArrayItem(
        event.previousContainer.data,
        event.container.data,
        event.previousIndex,
        event.currentIndex,
      );

      // API call to persist stage change
      this.dealService.updateStage(deal.id, targetStageId).subscribe({
        error: () => {
          // Revert on failure: move card back
          transferArrayItem(
            event.container.data,
            event.previousContainer.data,
            event.currentIndex,
            event.previousIndex,
          );
          this.snackBar.open('Failed to update deal stage', 'Dismiss', { duration: 3000 });
        },
      });
    }
    ```

    **Helper methods:**
    - getColumnTotal(stage): sum of deal.value for all deals in stage
    - getStageIdForContainer(container): resolve stage ID from the CdkDropList element
    - openDeal(id): navigate to /deals/:id
    - loadKanban(): load Kanban data for selected pipeline

    **Pipeline switching:**
    - On pipeline select change, reload Kanban data
    - On includeTerminal toggle, reload Kanban data

    **SCSS styling:**
    - .kanban-board: display flex, horizontal scroll (overflow-x: auto), gap between columns
    - .kanban-column: min-width 280px, max-width 320px, flex-shrink 0, background surface color
    - .column-header: bold title, deal count badge, total value, colored top border (4px)
    - .column-body: vertical scroll (overflow-y: auto, max-height calc(100vh - 200px)), padding for drop zone
    - .deal-card: mat-card style with shadow, padding, cursor pointer, hover elevation
    - .deal-title: font-weight 500
    - .deal-value: color primary, font-weight bold
    - .deal-company, .deal-owner, .deal-date: secondary text color, smaller font
    - CDK drag placeholder: dashed border, light background
    - CDK drag preview: slight rotation, elevated shadow
    - .cdk-drag-animating: smooth transition

    Imports: CommonModule, CurrencyPipe, MatCardModule, MatButtonModule, MatIconModule, MatSelectModule, MatFormFieldModule, MatSlideToggleModule, MatSnackBarModule, MatButtonToggleModule, RouterLink, CdkDropListGroup, CdkDropList, CdkDrag, HasPermissionDirective
  </action>
  <verify>`cd globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — build succeeds.</verify>
  <done>Kanban board renders pipeline stages as columns, deals as draggable cards, supports cross-column drag-drop with optimistic updates and error rollback, pipeline switching, and terminal stage toggling.</done>
</task>

<task type="auto">
  <name>Task 2: Style Kanban board with responsive layout and drag-drop animations</name>
  <files>
    globcrm-web/src/app/features/deals/deal-kanban/deal-kanban.component.scss
  </files>
  <action>
    Enhance the Kanban board SCSS for a polished visual experience:

    **Layout:**
    - Board container fills available width, horizontally scrollable
    - Columns have consistent width (300px), slight gap (16px)
    - Board has top toolbar (pipeline selector, view switcher) separated from column area

    **Column styling:**
    - Rounded corners, subtle background (surface-container color from theme)
    - Header: colored top border (stage color), bold title, deal count in badge, total value right-aligned
    - Body: scrollable with subtle scrollbar styling, min-height for empty columns
    - Empty column state: dashed border, "No deals" text

    **Card styling:**
    - White/surface background, rounded corners (8px), subtle shadow
    - Hover: elevated shadow, slight scale
    - Title prominent, value in primary color, company/owner/date in secondary text
    - Expected close date: show days until close (e.g., "in 15 days") or overdue indicator

    **Drag-drop animations:**
    - .cdk-drag-preview: slight rotation (2deg), elevated shadow, opacity 0.9
    - .cdk-drag-placeholder: dashed border, min-height matching card, light primary tint
    - .cdk-drag-animating: transition transform 250ms cubic-bezier(0, 0, 0.2, 1)
    - Drop zone highlight on dragover (light colored background)

    **Responsive considerations:**
    - On smaller screens, columns can scroll horizontally
    - Touch-friendly card sizes (min-height 80px, comfortable tap targets)

    Use CSS custom properties from the existing theme where possible (--mat-sys-surface, --mat-sys-primary, etc.).
  </action>
  <verify>SCSS file exists with the described styles. No SCSS compilation errors (verified by Angular build).</verify>
  <done>Kanban board has polished visual styling with responsive columns, card hover effects, and smooth drag-drop animations.</done>
</task>

</tasks>

<verification>
- Angular builds without errors
- DealKanbanComponent exists with CDK drag-drop integration
- Cross-column drag-drop triggers API call
- Failed transitions revert card position
- Pipeline selector switches Kanban data
- SCSS provides polished card and column styling
</verification>

<success_criteria>
User can view deals as a Kanban board organized by pipeline stages, drag deal cards between columns to change stages (with optimistic updates and error rollback), switch between pipelines, and toggle terminal stage visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-08-SUMMARY.md`
</output>
