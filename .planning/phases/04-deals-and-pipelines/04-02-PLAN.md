---
phase: 04-deals-and-pipelines
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/GlobCRM.Domain/Interfaces/IPipelineRepository.cs
  - src/GlobCRM.Domain/Interfaces/IDealRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/PipelineRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
autonomous: true

must_haves:
  truths:
    - "Pipeline repository supports full CRUD with stage management"
    - "Deal repository supports paged list with pipeline/stage filtering and ownership scope"
    - "TenantSeeder creates a default pipeline with stages and sample deals for new tenants"
  artifacts:
    - path: "src/GlobCRM.Domain/Interfaces/IPipelineRepository.cs"
      provides: "Pipeline repository interface with GetAllAsync, GetByIdWithStagesAsync"
      contains: "interface IPipelineRepository"
    - path: "src/GlobCRM.Domain/Interfaces/IDealRepository.cs"
      provides: "Deal repository interface with GetPagedAsync supporting pipeline/stage filters"
      contains: "interface IDealRepository"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs"
      provides: "Deal repository with ownership scope, pipeline filtering, search, sort, pagination"
      contains: "class DealRepository"
    - path: "src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs"
      provides: "Pipeline, stage, and deal seed data creation from manifest"
      contains: "Pipeline"
  key_links:
    - from: "DealRepository.GetPagedAsync"
      to: "Deal entity + Stage + Company + Owner includes"
      via: "EF Core eager loading"
      pattern: "Include.*Stage.*Include.*Company"
    - from: "TenantSeeder"
      to: "Pipeline + PipelineStage + Deal entities"
      via: "Entity creation from PipelineSeed/DealSeed manifest"
      pattern: "new Pipeline"
---

<objective>
Create repository interfaces and implementations for Pipeline and Deal entities, wire seed data creation in TenantSeeder, and register all services.

Purpose: Provides the data access layer with server-side query capabilities (filtering, sorting, pagination, ownership scoping) that controllers and frontend will consume.
Output: 2 repository interfaces, 2 repository implementations, updated TenantSeeder, updated DI registration.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deals-and-pipelines/04-RESEARCH.md
@.planning/phases/04-deals-and-pipelines/04-01-SUMMARY.md
@.planning/phases/03-core-crm-entities/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pipeline and Deal repository interfaces and implementations</name>
  <files>
    src/GlobCRM.Domain/Interfaces/IPipelineRepository.cs
    src/GlobCRM.Domain/Interfaces/IDealRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/PipelineRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/DealRepository.cs
    src/GlobCRM.Infrastructure/CrmEntities/CrmEntityServiceExtensions.cs
  </files>
  <action>
    Follow the CompanyRepository/ICompanyRepository pattern exactly:

    **IPipelineRepository.cs:**
    - `Task&lt;List&lt;Pipeline&gt;&gt; GetAllAsync()` — list all pipelines for tenant (admin list)
    - `Task&lt;Pipeline?&gt; GetByIdWithStagesAsync(Guid id)` — single pipeline with ordered stages
    - `Task&lt;Pipeline&gt; CreateAsync(Pipeline pipeline)` — create with stages
    - `Task UpdateAsync(Pipeline pipeline)` — update pipeline + stages
    - `Task DeleteAsync(Guid id)` — delete pipeline (will cascade delete stages)
    - `Task&lt;bool&gt; HasDealsInStageAsync(Guid stageId)` — check before stage removal

    **IDealRepository.cs:**
    - `Task&lt;PagedResult&lt;Deal&gt;&gt; GetPagedAsync(EntityQueryParams queryParams, PermissionScope scope, Guid userId, List&lt;Guid&gt;? teamMemberIds = null, Guid? pipelineId = null, Guid? stageId = null)` — paged list with pipeline/stage filters
    - `Task&lt;Deal?&gt; GetByIdAsync(Guid id)` — single deal with Stage, Company, Owner includes
    - `Task&lt;Deal?&gt; GetByIdWithLinksAsync(Guid id)` — deal with DealContacts.Contact, DealProducts.Product for detail page
    - `Task&lt;List&lt;Deal&gt;&gt; GetByPipelineForKanbanAsync(Guid pipelineId, PermissionScope scope, Guid userId, List&lt;Guid&gt;? teamMemberIds = null, bool includeTerminal = false)` — all deals for Kanban board (no pagination, filtered by terminal stage flag)
    - `Task&lt;Deal&gt; CreateAsync(Deal deal)` — create deal
    - `Task UpdateAsync(Deal deal)` — update deal
    - `Task DeleteAsync(Guid id)` — delete deal
    - `Task&lt;List&lt;DealStageHistory&gt;&gt; GetStageHistoryAsync(Guid dealId)` — stage history for timeline

    **PipelineRepository.cs:**
    - Inject ApplicationDbContext
    - GetAllAsync: include Stages ordered by SortOrder, ordered by IsDefault desc then Name
    - GetByIdWithStagesAsync: include Stages.OrderBy(SortOrder)
    - HasDealsInStageAsync: check _db.Deals.AnyAsync(d => d.PipelineStageId == stageId)

    **DealRepository.cs:**
    - Follow CompanyRepository pattern exactly for filter/sort/pagination pipeline
    - GetPagedAsync: Include Stage, Company, Owner. Apply pipeline/stage filters. Apply ownership scope (same ApplyOwnershipScope pattern as CompanyRepository). Search on Title, Company.Name, Owner firstName/lastName. Sort fields: title, value, probability, expectedCloseDate, createdAt, updatedAt, stageName, companyName, ownerName. Default sort: CreatedAt descending.
    - GetByPipelineForKanbanAsync: load all deals for a pipeline with Stage, Company, Owner includes. Filter by ownership scope. If !includeTerminal, exclude deals in IsWon or IsLost stages. Order by Value descending within each stage (client-side grouping).
    - GetByIdWithLinksAsync: Include Stage, Pipeline, Company, Owner, DealContacts.Contact, DealProducts.Product
    - GetStageHistoryAsync: include FromStage, ToStage, ChangedByUser, order by ChangedAt descending

    **CrmEntityServiceExtensions.cs update:**
    - Register IPipelineRepository -> PipelineRepository (scoped)
    - Register IDealRepository -> DealRepository (scoped)
  </action>
  <verify>
    1. `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors
    2. All 4 new files exist
    3. CrmEntityServiceExtensions registers both new repositories
  </verify>
  <done>Pipeline and Deal repositories implement full data access with ownership scope, pipeline filtering, Kanban loading, and stage history querying.</done>
</task>

<task type="auto">
  <name>Task 2: Wire TenantSeeder to create Pipeline, PipelineStage, and Deal seed data</name>
  <files>
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  </files>
  <action>
    The TenantSeeder already has PipelineSeed and DealSeed manifest structures. Wire the actual entity creation:

    In the SeedAsync method (or the entity creation section), after creating Companies and Contacts:

    1. **Create Pipeline entity** from manifest.Pipeline:
       - Name from PipelineSeed.Name (e.g., "Sales Pipeline")
       - IsDefault = true, TenantId = tenantId

    2. **Create PipelineStage entities** from PipelineSeed.Stages:
       - Map each StageSeed to a PipelineStage with Name, SortOrder, Color, DefaultProbability, IsWon, IsLost
       - Standard stages: Qualification (10%), Discovery (25%), Proposal (50%), Negotiation (75%), Closed Won (100%, IsWon=true), Closed Lost (0%, IsLost=true)

    3. **Create Deal entities** from manifest.Deals:
       - Map each DealSeed to a Deal with Title, Value, PipelineId, PipelineStageId (lookup by stage name), CompanyId (link to seeded company by name), OwnerId (from the created admin user), IsSeedData=true, TenantId
       - Set Probability from the deal's assigned stage's DefaultProbability
       - Set ExpectedCloseDate to future dates (e.g., 30, 60, 90 days from now)

    4. Add all entities to DbContext and SaveChangesAsync

    Ensure the PipelineSeed/DealSeed/StageSeed classes have all necessary properties. Update them if needed (add Color, DefaultProbability, IsWon, IsLost to StageSeed if missing).
  </action>
  <verify>
    1. `dotnet build src/GlobCRM.Api/GlobCRM.Api.csproj` — 0 errors
    2. TenantSeeder contains Pipeline, PipelineStage, and Deal creation logic
  </verify>
  <done>New tenants receive a default "Sales Pipeline" with 6 stages and sample deals linked to seeded companies, matching the established seed data pattern.</done>
</task>

</tasks>

<verification>
- Solution builds with 0 errors
- 4 new repository files exist
- CrmEntityServiceExtensions registers Pipeline and Deal repositories
- TenantSeeder creates pipeline, stages, and deals for new tenants
</verification>

<success_criteria>
Pipeline and Deal data access layer is complete with full query support (ownership scope, pipeline filtering, Kanban loading, stage history), and new tenants receive meaningful seed data.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deals-and-pipelines/04-02-SUMMARY.md`
</output>
