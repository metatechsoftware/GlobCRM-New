---
phase: 23-summary-tabs-on-detail-pages
plan: 02
type: execute
wave: 2
depends_on:
  - 23-01
files_modified:
  - globcrm-web/src/app/shared/components/quick-action-bar/quick-action-bar.component.ts
  - globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
  - globcrm-web/src/app/shared/components/summary-tab/summary.service.ts
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss
autonomous: true
requirements:
  - SUMMARY-02
  - SUMMARY-03
  - SUMMARY-06
  - SUMMARY-07

must_haves:
  truths:
    - "QuickActionBarComponent renders a horizontal action bar with Add Note and Log Activity buttons on all entity types, plus Send Email on Contact and Lead"
    - "QuickActionBarComponent buttons respect RBAC permissions via *appHasPermission directive"
    - "EntitySummaryTabComponent displays a card grid layout with key properties card showing 4-8 read-only fields per entity type"
    - "EntitySummaryTabComponent shows association count chips that emit events for tab navigation"
    - "EntitySummaryTabComponent shows stage/status indicator: pipeline stepper for Deal/Lead, status badges for Quote/Request"
    - "SummaryService provides methods to fetch summary data from all 6 entity endpoints"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/quick-action-bar/quick-action-bar.component.ts"
      provides: "QuickActionBarComponent with Add Note, Log Activity, Send Email outputs"
      contains: "QuickActionBarComponent"
    - path: "globcrm-web/src/app/shared/components/summary-tab/summary.models.ts"
      provides: "TypeScript interfaces matching backend summary DTOs for all 6 entity types"
      contains: "CompanySummaryDto"
    - path: "globcrm-web/src/app/shared/components/summary-tab/summary.service.ts"
      provides: "SummaryService with 6 get methods calling /api/{entity}/{id}/summary"
      contains: "SummaryService"
    - path: "globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts"
      provides: "EntitySummaryTabComponent with key properties, associations, stage indicator"
      contains: "EntitySummaryTabComponent"
    - path: "globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html"
      provides: "Card grid template with @switch blocks for entity-specific sections"
      contains: "summary-card"
    - path: "globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss"
      provides: "Responsive grid styles for summary cards"
      contains: "summary-grid"
  key_links:
    - from: "SummaryService"
      to: "/api/{entity}/{id}/summary"
      via: "ApiService.get() calls"
      pattern: "api\\.get.*summary"
    - from: "EntitySummaryTabComponent"
      to: "SummaryService"
      via: "not direct injection -- data passed as input signal from detail page"
      pattern: "input.*SummaryDto"
---

<objective>
Create the QuickActionBarComponent, SummaryService, summary TypeScript models, and the EntitySummaryTabComponent shell with key properties card, association count chips, and stage/status indicators.

Purpose: These are the shared building blocks for the summary tab. The QuickActionBarComponent is the horizontal action bar pinned at the top per user decision. The EntitySummaryTabComponent renders the card grid layout with identity-first reading order (key properties + stage at top, dynamic content below). The SummaryService provides API integration for all 6 entity endpoints.

Output: 6 new files forming the summary tab foundation -- models, service, quick action bar, and the main summary tab component with key properties and status indicators.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-RESEARCH.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-01-SUMMARY.md
@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/shared/components/entity-preview/mini-stage-bar.component.ts
@globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts
@globcrm-web/src/app/shared/services/entity-type-registry.ts
@globcrm-web/src/app/core/api/api.service.ts
@globcrm-web/src/app/core/permissions/has-permission.directive.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Summary models, service, and QuickActionBarComponent</name>
  <files>
    globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
    globcrm-web/src/app/shared/components/summary-tab/summary.service.ts
    globcrm-web/src/app/shared/components/quick-action-bar/quick-action-bar.component.ts
  </files>
  <action>
**summary.models.ts:** Create TypeScript interfaces matching all backend summary DTOs from Plan 23-01:

- `SummaryActivityDto` -- id, subject, type, status, dueDate (string|null), createdAt (string)
- `SummaryNoteDto` -- id, title, preview (string|null), authorName (string|null), createdAt (string)
- `SummaryAssociationDto` -- entityType, label, icon, count
- `DealPipelineSummaryDto` -- totalValue, totalDeals, winRate, dealsByStage: DealStageSummaryDto[]
- `DealStageSummaryDto` -- stageName, color, count, value
- `EmailEngagementDto` -- totalEmails, sentCount, receivedCount, lastSentAt (string|null), lastReceivedAt (string|null), isEnrolledInSequence, sequenceName (string|null)
- `DealStageInfoDto` -- id, name, color, sortOrder, isCurrent
- `LeadStageInfoDto` -- id, name, color, sortOrder, isCurrent, isTerminal
- `BaseSummaryFields` -- interface with recentActivities, upcomingActivities, recentNotes, associations, attachmentCount, lastContactedAt (string|null) -- shared across all 6 types
- `CompanySummaryDto extends BaseSummaryFields` -- name, industry, phone, email, website, ownerName, location, size, dealPipeline (DealPipelineSummaryDto|null)
- `ContactSummaryDto extends BaseSummaryFields` -- fullName, email, phone, jobTitle, companyName, ownerName, department, dealPipeline (DealPipelineSummaryDto|null), emailEngagement (EmailEngagementDto|null)
- `DealSummaryDto extends BaseSummaryFields` -- title, value, probability, expectedCloseDate, pipelineName, stageName, companyName, ownerName, stages (DealStageInfoDto[])
- `LeadSummaryDto extends BaseSummaryFields` -- fullName, email, phone, companyName, sourceName, temperature, ownerName, stages (LeadStageInfoDto[])
- `QuoteSummaryDto extends BaseSummaryFields` -- quoteNumber, title, status, grandTotal, contactName, companyName, issueDate, expiryDate
- `RequestSummaryDto extends BaseSummaryFields` -- subject, status, priority, category, contactName, companyName, ownerName, assignedToName
- `EntitySummaryData` -- discriminated union type: `CompanySummaryDto | ContactSummaryDto | DealSummaryDto | LeadSummaryDto | QuoteSummaryDto | RequestSummaryDto`

**summary.service.ts:** Create an `@Injectable({ providedIn: 'root' })` service:
- Inject `ApiService` via `inject(ApiService)`
- 6 methods: `getCompanySummary(id: string)`, `getContactSummary(id: string)`, etc.
- Each returns `Observable<XxxSummaryDto>` calling `this.api.get<XxxSummaryDto>(\`/api/{entity}/${id}/summary\`)`

**quick-action-bar.component.ts:** Create a standalone component:
- Inline template with a horizontal flexbox bar
- Inputs: `showSendEmail = input(false)` -- only true for Contact and Lead
- Outputs: `addNote = output<void>()`, `logActivity = output<void>()`, `sendEmail = output<void>()`
- Three `mat-stroked-button` buttons:
  - "Add Note" with `note_add` icon, guarded by `*appHasPermission="'Note:Create'"`
  - "Log Activity" with `add_task` icon, guarded by `*appHasPermission="'Activity:Create'"`
  - "Send Email" with `email` icon, guarded by `*appHasPermission="'Email:Create'"`, only shown `@if (showSendEmail())`
- Import `MatButtonModule`, `MatIconModule`, `HasPermissionDirective`
- Inline styles: `.quick-action-bar { display: flex; gap: 12px; padding: 12px 0; flex-wrap: wrap; }`
- Buttons should have a consistent small size with icon + text side by side
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. Grep confirms SummaryService has 6 get methods, QuickActionBarComponent has 3 output signals.
  </verify>
  <done>
    summary.models.ts defines all TypeScript interfaces matching backend DTOs.
    SummaryService provides 6 observable methods for fetching summary data.
    QuickActionBarComponent renders horizontal action bar with permission-guarded buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: EntitySummaryTabComponent with key properties, associations, and stage indicators</name>
  <files>
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss
  </files>
  <action>
Create the `EntitySummaryTabComponent` -- a shared component that renders the summary tab content as a card grid. This component receives data via inputs (not fetching data itself -- the detail page manages data loading).

**Component (.ts):**
- Standalone, `ChangeDetectionStrategy.OnPush`
- Inputs:
  - `entityType = input.required<string>()` -- 'Company'|'Contact'|'Deal'|'Lead'|'Quote'|'Request'
  - `data = input.required<EntitySummaryData>()` -- the summary DTO (discriminated by entityType)
  - `loading = input(false)` -- shows skeleton while loading
- Outputs:
  - `associationClicked = output<string>()` -- emits tab label (e.g., 'Contacts') when an association chip is clicked
  - `addNote = output<void>()`
  - `logActivity = output<void>()`
  - `sendEmail = output<void>()`
- Imports: `QuickActionBarComponent`, `MiniStageBarComponent` (from entity-preview), `MatChipsModule`, `MatIconModule`, `MatProgressSpinnerModule`, `CurrencyPipe`, `DatePipe`, `DecimalPipe`, `PercentPipe`, `HasPermissionDirective`
- Computed signals for type narrowing:
  - `isCompanyOrContact = computed(() => ['Company', 'Contact'].includes(this.entityType()))`
  - `isDealOrLead = computed(() => ['Deal', 'Lead'].includes(this.entityType()))`
  - `isContact = computed(() => this.entityType() === 'Contact')`
  - `showSendEmail = computed(() => ['Contact', 'Lead'].includes(this.entityType()))`

**Template (.html):**
Per user decisions: card grid layout, identity first, then dynamics.

Layout structure:
```
<div class="summary-container">
  <!-- Quick Action Bar - pinned at top per user decision -->
  <app-quick-action-bar
    [showSendEmail]="showSendEmail()"
    (addNote)="addNote.emit()"
    (logActivity)="logActivity.emit()"
    (sendEmail)="sendEmail.emit()" />

  @if (loading()) {
    <div class="summary-skeleton"><!-- loading placeholder --></div>
  } @else {
    <div class="summary-grid">
      <!-- ROW 1: Key Properties Card + Stage/Status Card -->
      <div class="summary-card key-properties-card">
        <h3 class="card-title"><mat-icon>info</mat-icon> Key Properties</h3>
        <div class="properties-grid">
          <!-- @switch (entityType()) for entity-specific property rendering -->
          <!-- Each property: <div class="property"><span class="property-label">Label</span><span class="property-value">Value</span></div> -->
        </div>
      </div>

      <!-- Stage/Status Card (entity-specific) -->
      @switch (entityType()) {
        @case ('Deal') { <!-- MiniStageBarComponent with deal stages --> }
        @case ('Lead') { <!-- MiniStageBarComponent with lead stages --> }
        @case ('Quote') { <!-- Status badge chip --> }
        @case ('Request') { <!-- Status + Priority badges --> }
      }

      <!-- ROW 2: Activities Card (hero content - largest visual prominence) -->
      <!-- This card gets full width on desktop for maximum visibility -->

      <!-- ROW 3: Associations + Notes + Meta cards -->
      <!-- Association chips, Notes preview, Last contacted + Attachments count -->
    </div>
  }
</div>
```

**Key Properties Card (@switch on entityType):**
- Company: Name, Industry, Phone, Email, Website, Owner, Location, Size
- Contact: Full Name, Email, Phone, Job Title, Company, Owner, Department
- Deal: Title, Value (currency pipe), Probability (percent pipe), Expected Close (date pipe), Pipeline > Stage, Company, Owner
- Lead: Full Name, Email, Phone, Company, Source, Temperature, Owner
- Quote: Quote Number, Title, Status, Grand Total (currency pipe), Contact, Company, Issue Date, Expiry Date
- Request: Subject, Status, Priority, Category, Contact, Company, Owner, Assigned To

**Stage/Status Indicator:**
- Deal: Reuse `MiniStageBarComponent` from entity-preview. Pass `stages` (converted to the format MiniStageBarComponent expects: allStages with name/color, currentStageId). Per user decision: "horizontal stage progress bar showing all pipeline stages with current stage highlighted -- stepped progress indicator"
- Lead: Same MiniStageBarComponent pattern but with LeadStageInfoDto. Show terminal stage indicator for IsConverted/IsLost.
- Quote: Material chip with colored background matching QUOTE_STATUSES color convention
- Request: Material chip for Status + separate chip for Priority

**Association Chips:**
- Render `data().associations` as Material chips with icon and count: e.g., `<mat-chip>people 5 Contacts</mat-chip>`
- On chip click, emit `associationClicked.emit(chip.label)` so the detail page can switch tabs

NOTE: Activities card, notes preview, deal pipeline chart, email engagement card, last contacted, and attachments count will be added in Plan 23-03. For now, leave placeholder `<!-- Activities card (23-03) -->` etc. comments in the template where those cards will go, but DO render the summary-grid structure and the key properties + stage + association cards fully.

**Styles (.scss):**
- `.summary-container` -- padding: 16px 0
- `.summary-grid` -- CSS grid: `grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px;`
- `.summary-card` -- background: white, border-radius: 8px, border: 1px solid var(--border-color, #e0e0e0), padding: 20px
- `.card-title` -- display: flex, align-items: center, gap: 8px, font-size: 14px, font-weight: 500, color: var(--text-secondary), margin-bottom: 16px, text-transform: uppercase, letter-spacing: 0.5px
- `.key-properties-card` -- grid-column: 1 / -1 on small screens (full width)
- `.properties-grid` -- display: grid, grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)), gap: 12px
- `.property` -- display: flex, flex-direction: column, gap: 2px
- `.property-label` -- font-size: 12px, color: var(--text-secondary), font-weight: 500, text-transform: uppercase
- `.property-value` -- font-size: 14px, color: var(--text-primary)
- `.associations-card .mat-mdc-chip` -- cursor: pointer
- `.stage-card` -- grid-column: 1 / -1 for Deal/Lead (full width for horizontal stepper)
- `.status-chips` -- display: flex, gap: 8px
- `.summary-skeleton` -- pulse animation placeholder (reuse pattern from preview-skeleton.component.ts)
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. EntitySummaryTabComponent exists with entityType, data, loading inputs and associationClicked, addNote, logActivity, sendEmail outputs.
  </verify>
  <done>
    EntitySummaryTabComponent renders a responsive card grid with key properties card (4-8 fields per entity type via @switch), stage/status indicators (MiniStageBarComponent for Deal/Lead, status chips for Quote/Request), and association count chips that emit tab navigation events. Quick action bar is pinned at top. Placeholder slots are ready for content widgets in Plan 23-03.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build` succeeds
2. QuickActionBarComponent has 3 buttons with permission guards
3. SummaryService has 6 get methods returning typed observables
4. EntitySummaryTabComponent renders key properties for all 6 entity types
5. Association chips are clickable and emit the tab label
6. Deal and Lead show MiniStageBarComponent for pipeline visualization
7. Quote shows status chip, Request shows status + priority chips
</verification>

<success_criteria>
All shared summary tab building blocks compile and render correctly: models match backend DTOs, service calls the right endpoints, quick action bar has permission-guarded buttons, and the summary tab component displays key properties, stage indicators, and association chips in a card grid layout.
</success_criteria>

<output>
After completion, create `.planning/phases/23-summary-tabs-on-detail-pages/23-02-SUMMARY.md`
</output>
