---
phase: 23-summary-tabs-on-detail-pages
plan: 04
type: execute
wave: 4
depends_on:
  - 23-01
  - 23-02
  - 23-03
files_modified:
  - globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
  - globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
  - globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.html
  - globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts
autonomous: true
requirements:
  - SUMMARY-01
  - SUMMARY-07

must_haves:
  truths:
    - "Summary tab is the first (default, index 0) tab on Company, Contact, Deal, Lead, Quote, and Request detail pages"
    - "Summary tab loads its data via SummaryService on initial page load (since it is the default tab)"
    - "Quick action Add Note opens a dialog, and on close summary data refreshes immediately"
    - "Quick action Log Activity opens a dialog, and on close summary data refreshes immediately"
    - "Quick action Send Email opens a dialog (Contact/Lead only), and on close summary data refreshes immediately"
    - "Summary data auto-refreshes when user performs mutations on sibling tabs (dirty-flag invalidation)"
    - "Association chip click switches to the corresponding tab on the detail page"
    - "Existing tab functionality on all 6 entity detail pages continues to work unchanged"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts"
      provides: "COMPANY_TABS, CONTACT_TABS, DEAL_TABS with Summary tab prepended at index 0"
      contains: "Summary"
    - path: "globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts"
      provides: "Company detail page with summary tab data loading, dirty-flag invalidation, and quick action dialog handlers"
      contains: "summaryData"
    - path: "globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts"
      provides: "Contact detail page with summary tab including email engagement"
      contains: "summaryData"
    - path: "globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts"
      provides: "Deal detail page with summary tab including stage progress"
      contains: "summaryData"
    - path: "globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts"
      provides: "Lead detail page with summary tab including stage progress"
      contains: "summaryData"
    - path: "globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts"
      provides: "Quote detail page with summary tab added to existing mat-tab-group"
      contains: "summaryData"
    - path: "globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts"
      provides: "Request detail page with summary tab added to existing mat-tab-group"
      contains: "summaryData"
  key_links:
    - from: "company-detail.component.ts"
      to: "SummaryService"
      via: "inject(SummaryService) and getCompanySummary() call"
      pattern: "summaryService\\.getCompanySummary"
    - from: "company-detail.component.ts onTabChanged"
      to: "summaryDirty signal"
      via: "dirty-flag check on Summary tab activation"
      pattern: "summaryDirty"
    - from: "EntitySummaryTabComponent associationClicked"
      to: "detail component onTabChanged"
      via: "output event triggers programmatic tab switch via RelatedEntityTabsComponent"
      pattern: "associationClicked"
---

<objective>
Insert the Summary tab at index 0 on all 6 entity detail pages, wire summary data loading with dirty-flag invalidation, and connect quick action dialog handlers for Add Note, Log Activity, and Send Email.

Purpose: This is the integration plan that brings everything together -- the backend endpoints (23-01), the shared components (23-02), and the content widgets (23-03) are all wired into each entity's detail page. After this plan, users see a rich at-a-glance overview as the default tab on every major entity detail page.

Output: All 6 entity detail pages have a Summary tab as the first tab with full data loading, auto-refresh on mutations, and quick action dialogs.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-RESEARCH.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-01-SUMMARY.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-02-SUMMARY.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-03-SUMMARY.md
@globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
@globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
@globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.html
@globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Insert Summary tab and wire Company, Contact, Deal, and Lead detail pages</name>
  <files>
    globcrm-web/src/app/shared/components/related-entity-tabs/related-entity-tabs.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
  </files>
  <action>
**Step 1: Update tab constants (related-entity-tabs.component.ts):**
Prepend `{ label: 'Summary', icon: 'dashboard', enabled: true }` at index 0 of:
- `COMPANY_TABS`
- `CONTACT_TABS`
- `DEAL_TABS`

Lead uses a computed `tabs()` signal in its detail component, not these constants. It will be handled in the detail component.

These are the 4 entity types that use `RelatedEntityTabsComponent` with label-based tab switching (Phase 22 refactor). Adding at index 0 is safe because tab matching is label-based, not index-based.

**Step 2: Wire Company detail page (company-detail.component.ts):**

Add imports: `SummaryService`, `EntitySummaryTabComponent`, `MatDialog` (if not already imported), summary DTO types.

Add signals:
```typescript
summaryData = signal<CompanySummaryDto | null>(null);
summaryLoading = signal(false);
summaryDirty = signal(false);
```

Inject: `private summaryService = inject(SummaryService)`, `private dialog = inject(MatDialog)` (if not already injected)

Add `loadSummary()` method:
```typescript
private loadSummary(): void {
  const id = this.companyId; // however the component gets the entity ID
  this.summaryLoading.set(true);
  this.summaryDirty.set(false);
  this.summaryService.getCompanySummary(id).subscribe({
    next: (data) => {
      this.summaryData.set(data);
      this.summaryLoading.set(false);
    },
    error: () => this.summaryLoading.set(false),
  });
}
```

Update `ngOnInit` (or wherever entity data loads): call `this.loadSummary()` since Summary is the default tab.

Update `onTabChanged(label: string)` method:
- Add case for `'Summary'`: if `!this.summaryData() || this.summaryDirty()`, call `this.loadSummary()`
- Existing tab cases remain unchanged

Add `markSummaryDirty()` method -- call this after any mutation on sibling tabs:
```typescript
markSummaryDirty(): void {
  this.summaryDirty.set(true);
}
```

Wire dirty-flag: wherever the detail page performs mutations (adding notes, linking contacts, creating activities, etc.), call `this.markSummaryDirty()` after the mutation succeeds. Look for existing subscribe/afterClosed handlers that refresh data and add `this.markSummaryDirty()` alongside.

Add quick action handlers:
```typescript
onSummaryAddNote(): void {
  // Open a simple note creation dialog with entity context
  // For now, navigate to note creation route with queryParams (matching existing pattern):
  this.router.navigate(['/notes/new'], {
    queryParams: { entityType: 'Company', entityId: this.companyId, entityName: this.company()?.name }
  });
  // OR if a NoteQuickAddDialogComponent exists (from 23-02/23-03), open it as dialog
  // After navigation/dialog close, mark dirty: this.markSummaryDirty();
}

onSummaryLogActivity(): void {
  // Open activity form dialog with entity link pre-filled
  // Use EntityFormDialogComponent or navigate to activity creation with entity context
  // After close, call this.loadSummary() for immediate refresh per user decision
}

onSummarySendEmail(): void {
  // Only for Contact/Lead -- open email compose dialog
  // After close, call this.loadSummary()
}
```

**IMPORTANT per user decision:** "After a quick action completes (note saved, activity logged), summary tab data auto-refreshes to reflect the change immediately." So in afterClosed() handlers, call `this.loadSummary()` directly, not just `markSummaryDirty()`.

Add `onAssociationClicked(tabLabel: string)` handler that programmatically switches to the clicked tab. The RelatedEntityTabsComponent should have a way to switch tabs programmatically -- use `ViewChild` to get the tab group and set the selected index, or find the index of the label in the tabs array and set `selectedIndex`.

Update template (inline or .html): Add an `<ng-template>` for the Summary tab at position 0 (before the existing Details template):
```html
<ng-template>
  <app-entity-summary-tab
    entityType="Company"
    [data]="summaryData()!"
    [loading]="summaryLoading()"
    (associationClicked)="onAssociationClicked($event)"
    (addNote)="onSummaryAddNote()"
    (logActivity)="onSummaryLogActivity()"
    (sendEmail)="onSummarySendEmail()" />
</ng-template>
```

Wrap the summary tab content in `@if (summaryData() || summaryLoading())` to handle the initial state.

**Step 3: Wire Contact detail page (contact-detail.component.ts):**
Same pattern as Company, but:
- Use `summaryService.getContactSummary(id)`
- Summary DTO is `ContactSummaryDto`
- `showSendEmail` is true for Contact (EntitySummaryTabComponent handles this via entityType input)
- Quick action Send Email should open the email compose interface for this contact

**Step 4: Wire Deal detail page (deal-detail.component.ts):**
Same pattern as Company, but:
- Use `summaryService.getDealSummary(id)`
- Summary DTO is `DealSummaryDto`
- No Send Email action (Deal has no direct email target)

**Step 5: Wire Lead detail page (lead-detail.component.ts):**
Lead uses a computed `tabs()` signal rather than a shared constant. Prepend `{ label: 'Summary', icon: 'dashboard', enabled: true }` at index 0 of the computed tabs array.
- Use `summaryService.getLeadSummary(id)`
- Summary DTO is `LeadSummaryDto`
- Send Email action is available (Leads have email addresses)

For all 4 detail pages:
- Import `EntitySummaryTabComponent` in the component's `imports` array
- Ensure `SummaryService` is injected
- The entity-specific quick action handlers (note creation, activity logging) should use existing dialog/navigation patterns from the codebase. Look at how notes are created from the detail pages currently and replicate that pattern, but open as a dialog or navigate and mark dirty on return.
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. All 4 detail pages import EntitySummaryTabComponent and have summaryData/summaryLoading/summaryDirty signals. Tab constants include 'Summary' at index 0.
  </verify>
  <done>
    COMPANY_TABS, CONTACT_TABS, and DEAL_TABS have Summary tab at index 0.
    Company, Contact, Deal, and Lead detail pages load summary data on init, refresh on dirty-flag, and have quick action dialog handlers that trigger immediate summary reload.
    Association chip clicks switch to the corresponding tab.
    All existing tab functionality is preserved (label-based matching is unaffected by index shift).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Quote and Request detail pages with Summary tab</name>
  <files>
    globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.ts
    globcrm-web/src/app/features/quotes/quote-detail/quote-detail.component.html
    globcrm-web/src/app/features/requests/request-detail/request-detail.component.ts
  </files>
  <action>
Quote and Request detail pages use raw `mat-tab-group` directly (not RelatedEntityTabsComponent). Per research recommendation, add the Summary tab directly to their existing `mat-tab-group` rather than refactoring them to use RelatedEntityTabsComponent (which would be risky mid-phase).

**Quote detail page (quote-detail.component.ts + .html):**

Add imports: `SummaryService`, `EntitySummaryTabComponent`, summary DTO types.

Add signals:
```typescript
summaryData = signal<QuoteSummaryDto | null>(null);
summaryLoading = signal(false);
summaryDirty = signal(false);
```

Inject `SummaryService`.

Add `loadSummary()` method (same pattern as Company).

Call `loadSummary()` in `ngOnInit`.

Add a `selectedTabIndex = signal(0)` if not already present, or use the existing tab tracking mechanism.

Add a `mat-tab` at position 0 (first tab) in the template's `mat-tab-group`:
```html
<mat-tab>
  <ng-template mat-tab-label>
    <mat-icon class="tab-icon">dashboard</mat-icon>
    Summary
  </ng-template>
  @if (summaryData() || summaryLoading()) {
    <app-entity-summary-tab
      entityType="Quote"
      [data]="summaryData()!"
      [loading]="summaryLoading()"
      (associationClicked)="onAssociationClicked($event)"
      (addNote)="onSummaryAddNote()"
      (logActivity)="onSummaryLogActivity()" />
  }
</mat-tab>
```

Handle tab change: If the component uses `(selectedTabChange)` on `mat-tab-group`, update the handler to check if the selected tab is Summary (index 0) and reload if dirty. If the component uses index-based tab handling, update it to account for the new Summary tab at index 0 (all existing tab indices shift +1).

IMPORTANT: Review the existing template carefully. If there are `(selectedTabChange)` handlers or index-based logic, update them to account for the Summary tab insertion at index 0. Since Quote uses raw mat-tab-group, any existing hardcoded indices need to shift by 1.

Add quick action handlers and markSummaryDirty() (same pattern as Company).

Wire dirty-flag into existing mutation handlers (status transitions, note creation, etc.).

**Request detail page (request-detail.component.ts):**
Same approach as Quote:
- Request uses raw `mat-tab-group` with inline template
- Add `mat-tab` for Summary at position 0
- Add summaryData/summaryLoading/summaryDirty signals
- Inject SummaryService, call loadSummary() on init
- Handle tab index shift for existing tabs
- Wire dirty-flag into status transition handlers
- Add quick action handlers

For both Quote and Request:
- Import `EntitySummaryTabComponent` in component imports
- Ensure the `mat-tab-group` has `(selectedTabChange)` handler that checks for Summary tab dirty reload
- No Send Email quick action (Quote/Request don't have direct email targets)
- The `onAssociationClicked(tabLabel)` method should switch to the tab matching the label -- find the tab index by label and set `selectedIndex` on the tab group
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. Quote and Request detail pages have Summary tab at index 0 with summaryData signals.
  </verify>
  <done>
    Quote detail page has Summary tab inserted at index 0 of its mat-tab-group with data loading, dirty-flag invalidation, and quick action handlers.
    Request detail page has Summary tab inserted at index 0 with the same functionality.
    All existing tabs on both pages continue to work correctly with updated indices.
    All 6 entity types now have Summary as the default first tab.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build` succeeds
2. All 6 entity detail pages show Summary as the first (default) tab
3. Summary data loads on initial page open for all 6 entity types
4. Quick action buttons appear on summary tab with correct permission guards
5. Clicking Add Note opens a dialog/navigation and refreshes summary on completion
6. Clicking an association chip switches to the corresponding tab
7. Making a mutation on a sibling tab (e.g., adding a note on the Notes tab) sets summaryDirty=true
8. Returning to the Summary tab after a mutation triggers a data reload
9. Existing tab functionality (Details, Contacts, Activities, etc.) continues to work on all 6 entity types
10. Quote and Request mat-tab-group indices are updated to account for Summary at position 0
</verification>

<success_criteria>
Summary tab appears as the first default tab on Company, Contact, Deal, Lead, Quote, and Request detail pages, with data loading, dirty-flag invalidation, quick action dialogs, and association chip navigation all working. Existing functionality is preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/23-summary-tabs-on-detail-pages/23-04-SUMMARY.md`
</output>
