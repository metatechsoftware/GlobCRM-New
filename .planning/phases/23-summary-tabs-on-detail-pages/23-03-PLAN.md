---
phase: 23-summary-tabs-on-detail-pages
plan: 03
type: execute
wave: 3
depends_on:
  - 23-02
files_modified:
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss
  - globcrm-web/src/app/shared/components/summary-tab/deal-pipeline-chart.component.ts
  - globcrm-web/src/app/shared/components/summary-tab/email-engagement-card.component.ts
autonomous: true
requirements:
  - SUMMARY-04
  - SUMMARY-05
  - SUMMARY-08
  - SUMMARY-09
  - SUMMARY-10
  - SUMMARY-11
  - SUMMARY-12

must_haves:
  truths:
    - "Summary tab shows last 3-5 recent activities with subject, status, and due date in condensed format"
    - "Summary tab shows upcoming activities (not done, due today+) in a visually distinct section"
    - "Summary tab shows last 2-3 notes with title and ~100 char truncated preview"
    - "Summary tab displays Last Contacted timestamp prominently"
    - "Summary tab shows attachments count badge"
    - "Company and Contact summary tabs show a CSS-only donut chart for deal pipeline with stage colors, total value, deal count, and win rate"
    - "Contact summary tab shows email engagement card with last sent, last received, total emails, and sequence enrollment status"
    - "Deal pipeline chart handles zero-deals state with empty state message"
    - "Email engagement card handles zero-emails state with placeholder message"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/summary-tab/deal-pipeline-chart.component.ts"
      provides: "CSS-only donut chart for deal pipeline summary"
      contains: "DealPipelineChartComponent"
    - path: "globcrm-web/src/app/shared/components/summary-tab/email-engagement-card.component.ts"
      provides: "Email engagement stats card for Contact summary"
      contains: "EmailEngagementCardComponent"
    - path: "globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html"
      provides: "Full summary tab template with all content widgets"
      contains: "activities-card"
  key_links:
    - from: "EntitySummaryTabComponent template"
      to: "DealPipelineChartComponent"
      via: "@if (isCompanyOrContact()) conditional rendering with dealPipeline input"
      pattern: "app-deal-pipeline-chart"
    - from: "EntitySummaryTabComponent template"
      to: "EmailEngagementCardComponent"
      via: "@if (isContact()) conditional rendering with emailEngagement input"
      pattern: "app-email-engagement-card"
---

<objective>
Add all content widgets to the EntitySummaryTabComponent: activities card (recent + upcoming), notes preview, last-contacted timestamp, attachments count badge, deal pipeline donut chart (Company/Contact), and email engagement card (Contact).

Purpose: Per user decisions, activities are the hero content of the summary tab. This plan fills in all the dynamic content sections that were placeholder slots in Plan 23-02, making the summary tab feature-complete before detail page integration.

Output: 2 new child components (DealPipelineChartComponent, EmailEngagementCardComponent) and updated EntitySummaryTabComponent template/styles with all content widgets rendered.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-RESEARCH.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-02-SUMMARY.md
@globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts
@globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
@globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss
@globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
@globcrm-web/src/app/shared/components/entity-preview/mini-timeline.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DealPipelineChartComponent and EmailEngagementCardComponent</name>
  <files>
    globcrm-web/src/app/shared/components/summary-tab/deal-pipeline-chart.component.ts
    globcrm-web/src/app/shared/components/summary-tab/email-engagement-card.component.ts
  </files>
  <action>
**DealPipelineChartComponent (deal-pipeline-chart.component.ts):**
Create a standalone component that renders a CSS-only donut chart for deal pipeline data.

- Standalone, OnPush
- Input: `pipeline = input.required<DealPipelineSummaryDto>()`
- Computed signals:
  - `hasDeals = computed(() => this.pipeline().totalDeals > 0)`
  - `chartSegments = computed(() => { ... })` -- converts dealsByStage into conic-gradient segments. For each stage, compute its percentage of totalDeals (by count or by value -- use count for visual proportions). Build a CSS `conic-gradient(...)` string with each stage's color spanning its percentage arc.
  - `formattedTotalValue = computed(() => ...)` -- format as currency abbreviation (e.g., "$1.2M", "$45K", "$500")
  - `formattedWinRate = computed(() => ...)` -- format as percentage (e.g., "67%")

- Template structure:
  ```
  @if (hasDeals()) {
    <div class="pipeline-chart-container">
      <div class="chart-section">
        <div class="donut-chart" [style.background]="chartSegments()"></div>
        <div class="chart-center">
          <span class="chart-center-value">{{ pipeline().totalDeals }}</span>
          <span class="chart-center-label">deals</span>
        </div>
      </div>
      <div class="chart-stats">
        <div class="stat">
          <span class="stat-value">{{ formattedTotalValue() }}</span>
          <span class="stat-label">Total Value</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ formattedWinRate() }}</span>
          <span class="stat-label">Win Rate</span>
        </div>
      </div>
      <div class="chart-legend">
        @for (stage of pipeline().dealsByStage; track stage.stageName) {
          <div class="legend-item">
            <span class="legend-dot" [style.backgroundColor]="stage.color"></span>
            <span class="legend-label">{{ stage.stageName }}</span>
            <span class="legend-count">{{ stage.count }}</span>
          </div>
        }
      </div>
    </div>
  } @else {
    <div class="pipeline-empty">
      <mat-icon>trending_up</mat-icon>
      <span>No deals yet</span>
    </div>
  }
  ```

- Inline styles for donut chart:
  - `.donut-chart` -- width: 120px, height: 120px, border-radius: 50%, position: relative. The `background` is the conic-gradient computed signal. Apply `mask: radial-gradient(circle at center, transparent 38px, black 38px)` and `-webkit-mask` same for the donut hole.
  - `.chart-center` -- position: absolute, inset: 0, display: flex, flex-direction: column, align-items: center, justify-content: center
  - `.pipeline-chart-container` -- display: flex, gap: 24px, align-items: center, flex-wrap: wrap
  - `.chart-stats` -- display: flex, flex-direction: column, gap: 12px
  - `.stat-value` -- font-size: 20px, font-weight: 600
  - `.stat-label` -- font-size: 12px, color: var(--text-secondary), text-transform: uppercase
  - `.chart-legend` -- display: flex, flex-wrap: wrap, gap: 8px 16px
  - `.legend-dot` -- width: 10px, height: 10px, border-radius: 50%
  - `.pipeline-empty` -- display: flex, align-items: center, gap: 8px, color: var(--text-secondary), padding: 16px 0

Per user decision: "full visual bar or donut chart, not just numbers". The conic-gradient approach is a real donut chart visualization.

**EmailEngagementCardComponent (email-engagement-card.component.ts):**
Create a standalone component for Contact email engagement stats.

- Standalone, OnPush
- Input: `engagement = input.required<EmailEngagementDto>()`
- Computed signals:
  - `hasEmails = computed(() => this.engagement().totalEmails > 0)`

- Template structure:
  ```
  @if (hasEmails()) {
    <div class="engagement-stats">
      <div class="engagement-row">
        <div class="engagement-stat">
          <mat-icon class="stat-icon">send</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ engagement().sentCount }}</span>
            <span class="stat-label">Sent</span>
          </div>
        </div>
        <div class="engagement-stat">
          <mat-icon class="stat-icon">inbox</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ engagement().receivedCount }}</span>
            <span class="stat-label">Received</span>
          </div>
        </div>
        <div class="engagement-stat">
          <mat-icon class="stat-icon">email</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ engagement().totalEmails }}</span>
            <span class="stat-label">Total</span>
          </div>
        </div>
      </div>
      <div class="engagement-timestamps">
        @if (engagement().lastSentAt) {
          <div class="timestamp-row">
            <span class="timestamp-label">Last sent:</span>
            <span class="timestamp-value">{{ engagement().lastSentAt | date:'mediumDate' }}</span>
          </div>
        }
        @if (engagement().lastReceivedAt) {
          <div class="timestamp-row">
            <span class="timestamp-label">Last received:</span>
            <span class="timestamp-value">{{ engagement().lastReceivedAt | date:'mediumDate' }}</span>
          </div>
        }
      </div>
      @if (engagement().isEnrolledInSequence) {
        <div class="sequence-badge">
          <mat-icon>playlist_play</mat-icon>
          <span>Enrolled in: {{ engagement().sequenceName }}</span>
        </div>
      }
    </div>
  } @else {
    <div class="engagement-empty">
      <mat-icon>email</mat-icon>
      <span>No email activity</span>
    </div>
  }
  ```

- Inline styles:
  - `.engagement-stats` -- display: flex, flex-direction: column, gap: 16px
  - `.engagement-row` -- display: flex, gap: 24px, flex-wrap: wrap
  - `.engagement-stat` -- display: flex, align-items: center, gap: 8px
  - `.stat-icon` -- color: var(--text-secondary), font-size: 20px
  - `.stat-value` -- font-size: 20px, font-weight: 600
  - `.stat-label` -- font-size: 12px, color: var(--text-secondary), text-transform: uppercase
  - `.engagement-timestamps` -- display: flex, flex-direction: column, gap: 4px
  - `.timestamp-label` -- font-size: 12px, color: var(--text-secondary)
  - `.timestamp-value` -- font-size: 14px
  - `.sequence-badge` -- display: inline-flex, align-items: center, gap: 4px, background: var(--primary-50, #fff3e0), color: var(--primary-700, #e65100), padding: 4px 12px, border-radius: 16px, font-size: 13px
  - `.engagement-empty` -- display: flex, align-items: center, gap: 8px, color: var(--text-secondary), padding: 16px 0

Per user decision: "dedicated email engagement card showing last sent, last received, total emails exchanged, and sequence enrollment status" -- "full engagement context, not hidden in a stats row".

Import `MatIconModule`, `DatePipe` in both components.
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. Both components exist with correct inputs.
  </verify>
  <done>
    DealPipelineChartComponent renders a CSS conic-gradient donut chart with stage legend, total value, win rate, and empty state.
    EmailEngagementCardComponent renders sent/received/total counts, timestamps, sequence enrollment, and empty state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete EntitySummaryTabComponent with all content widget cards</name>
  <files>
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.ts
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.scss
  </files>
  <action>
Update the EntitySummaryTabComponent created in Plan 23-02 to fill in all placeholder content widget sections.

**Component (.ts) updates:**
- Add imports for `DealPipelineChartComponent`, `EmailEngagementCardComponent`
- Add computed signal for type-narrowed data access:
  - `companyData = computed(() => this.entityType() === 'Company' ? this.data() as CompanySummaryDto : null)`
  - `contactData = computed(() => this.entityType() === 'Contact' ? this.data() as ContactSummaryDto : null)`
  - `dealPipeline = computed(() => this.companyData()?.dealPipeline ?? this.contactData()?.dealPipeline ?? null)`
  - `emailEngagement = computed(() => this.contactData()?.emailEngagement ?? null)`
- Add helper for relative time display:
  - `getRelativeTime(dateStr: string): string` -- returns "2h ago", "3d ago", "1w ago" etc. (copy pattern from MiniTimelineComponent)

**Template (.html) updates -- fill in placeholder slots:**

**Activities Card (hero content, full-width on desktop per user decision):**
Per user decision: "Activities & timeline should get the most visual prominence" and "whether to split recent/upcoming into separate cards or combine into one card with two sections" -- use single card with two sections.

```html
<div class="summary-card activities-card full-width">
  <h3 class="card-title"><mat-icon>task_alt</mat-icon> Activities</h3>

  <!-- Recent Activities Section -->
  @if (data().recentActivities.length > 0) {
    <div class="activities-section">
      <h4 class="section-subtitle">Recent</h4>
      @for (activity of data().recentActivities; track activity.id) {
        <div class="activity-row">
          <div class="activity-info">
            <span class="activity-subject">{{ activity.subject }}</span>
            <span class="activity-meta">{{ activity.type }} &middot; {{ activity.status }}</span>
          </div>
          <span class="activity-time">{{ getRelativeTime(activity.createdAt) }}</span>
        </div>
      }
    </div>
  }

  <!-- Upcoming Activities Section (visually distinct with accent border) -->
  @if (data().upcomingActivities.length > 0) {
    <div class="activities-section upcoming-section">
      <h4 class="section-subtitle">Upcoming</h4>
      @for (activity of data().upcomingActivities; track activity.id) {
        <div class="activity-row">
          <div class="activity-info">
            <span class="activity-subject">{{ activity.subject }}</span>
            <span class="activity-meta">{{ activity.type }} &middot; Due {{ activity.dueDate | date:'mediumDate' }}</span>
          </div>
        </div>
      }
    </div>
  }

  @if (data().recentActivities.length === 0 && data().upcomingActivities.length === 0) {
    <div class="empty-state"><mat-icon>event_busy</mat-icon> No activities</div>
  }
</div>
```

**Notes Preview Card:**
```html
<div class="summary-card notes-card">
  <h3 class="card-title"><mat-icon>note</mat-icon> Recent Notes</h3>
  @if (data().recentNotes.length > 0) {
    @for (note of data().recentNotes; track note.id) {
      <div class="note-row">
        <span class="note-title">{{ note.title }}</span>
        @if (note.preview) {
          <span class="note-preview">{{ note.preview }}</span>
        }
        <span class="note-meta">{{ note.authorName }} &middot; {{ getRelativeTime(note.createdAt) }}</span>
      </div>
    }
  } @else {
    <div class="empty-state"><mat-icon>note</mat-icon> No notes</div>
  }
</div>
```

**Meta Card (Last Contacted + Attachments Count):**
```html
<div class="summary-card meta-card">
  <div class="meta-item">
    <mat-icon>schedule</mat-icon>
    <div class="meta-content">
      <span class="meta-label">Last Contacted</span>
      @if (data().lastContactedAt) {
        <span class="meta-value">{{ data().lastContactedAt | date:'mediumDate' }}</span>
      } @else {
        <span class="meta-value empty">Never</span>
      }
    </div>
  </div>
  <div class="meta-item">
    <mat-icon>attach_file</mat-icon>
    <div class="meta-content">
      <span class="meta-label">Attachments</span>
      <span class="meta-value">{{ data().attachmentCount }}</span>
    </div>
  </div>
</div>
```

**Deal Pipeline Card (Company and Contact only):**
```html
@if (isCompanyOrContact() && dealPipeline()) {
  <div class="summary-card pipeline-card">
    <h3 class="card-title"><mat-icon>trending_up</mat-icon> Deal Pipeline</h3>
    <app-deal-pipeline-chart [pipeline]="dealPipeline()!" />
  </div>
}
```

**Email Engagement Card (Contact only):**
```html
@if (isContact() && emailEngagement()) {
  <div class="summary-card email-card">
    <h3 class="card-title"><mat-icon>email</mat-icon> Email Engagement</h3>
    <app-email-engagement-card [engagement]="emailEngagement()!" />
  </div>
}
```

**Styles (.scss) additions:**
- `.full-width` -- grid-column: 1 / -1 (spans full grid width)
- `.activities-card` -- the activities card gets full width per user decision for max visual prominence
- `.activities-section` -- margin-bottom: 16px
- `.upcoming-section` -- border-left: 3px solid var(--primary-color, #ff9800), padding-left: 12px, background: var(--primary-50, #fff3e0), border-radius: 0 8px 8px 0, padding: 12px
- `.section-subtitle` -- font-size: 12px, font-weight: 600, text-transform: uppercase, color: var(--text-secondary), margin-bottom: 8px
- `.activity-row` -- display: flex, justify-content: space-between, align-items: flex-start, padding: 8px 0, border-bottom: 1px solid var(--border-color, #f0f0f0)
- `.activity-row:last-child` -- border-bottom: none
- `.activity-subject` -- font-size: 14px, font-weight: 500
- `.activity-meta` -- font-size: 12px, color: var(--text-secondary)
- `.activity-time` -- font-size: 12px, color: var(--text-secondary), white-space: nowrap
- `.note-row` -- padding: 8px 0, border-bottom: 1px solid var(--border-color, #f0f0f0), display: flex, flex-direction: column, gap: 2px
- `.note-title` -- font-size: 14px, font-weight: 500
- `.note-preview` -- font-size: 13px, color: var(--text-secondary), line-height: 1.4, display: -webkit-box, -webkit-line-clamp: 2, -webkit-box-orient: vertical, overflow: hidden
- `.note-meta` -- font-size: 12px, color: var(--text-secondary)
- `.meta-card` -- display: flex, flex-direction: column, gap: 16px
- `.meta-item` -- display: flex, align-items: center, gap: 12px
- `.meta-label` -- font-size: 12px, color: var(--text-secondary), text-transform: uppercase
- `.meta-value` -- font-size: 16px, font-weight: 500
- `.meta-value.empty` -- color: var(--text-secondary), font-style: italic
- `.empty-state` -- display: flex, align-items: center, gap: 8px, color: var(--text-secondary), padding: 16px 0, font-size: 14px
- `.pipeline-card`, `.email-card` -- standard card styles, no extra grid-column override (fits within the auto-fill grid)
  </action>
  <verify>
    cd globcrm-web && npx ng build 2>&1 | tail -10
    Verify: Build succeeds. Template includes activities-card, notes-card, meta-card, pipeline-card (conditional), email-card (conditional).
  </verify>
  <done>
    EntitySummaryTabComponent now renders all content widgets: activities card with recent/upcoming sections (hero content, full width), notes preview with truncated text, last contacted timestamp, attachments count, deal pipeline donut chart (Company/Contact), and email engagement card (Contact). All empty states handled with placeholder messages.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build` succeeds
2. DealPipelineChartComponent renders conic-gradient donut with stage colors and handles zero-deals empty state
3. EmailEngagementCardComponent shows sent/received/total stats with timestamps and handles zero-emails
4. Activities card is full-width with two sections (Recent + Upcoming with accent border)
5. Notes card shows up to 3 notes with truncated preview
6. Meta card shows Last Contacted date and Attachments count
7. Deal Pipeline card only renders for Company and Contact entity types
8. Email Engagement card only renders for Contact entity type
</verification>

<success_criteria>
EntitySummaryTabComponent is feature-complete with all content widgets matching the user's locked decisions: activities as hero content with maximum visual prominence, card grid layout with clear separation, moderate density, no "View all" links, deal pipeline donut chart for Company/Contact, email engagement for Contact, and all empty states handled.
</success_criteria>

<output>
After completion, create `.planning/phases/23-summary-tabs-on-detail-pages/23-03-SUMMARY.md`
</output>
