---
phase: 10-data-operations
plan: 05
type: execute
wave: 3
depends_on: ["10-03"]
files_modified:
  - globcrm-web/src/app/shared/components/global-search/global-search.component.ts
  - globcrm-web/src/app/shared/components/global-search/search.service.ts
  - globcrm-web/src/app/shared/components/global-search/search.models.ts
  - globcrm-web/src/app/shared/components/global-search/recent-searches.service.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.html
autonomous: true

must_haves:
  truths:
    - "User can search across all entity types from a single search bar in the navbar"
    - "Search results appear as-you-type with debounced input (300ms, min 2 chars)"
    - "Results are grouped by entity type with title and subtitle"
    - "Clicking a result navigates to the entity detail page"
    - "Recent searches are saved in localStorage and shown on focus"
    - "Pressing Escape or clicking outside closes the search overlay"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      provides: "Search bar with overlay dropdown showing grouped results and recent searches"
      contains: "GlobalSearchComponent"
    - path: "globcrm-web/src/app/shared/components/global-search/search.service.ts"
      provides: "API service calling GET /api/search?q={term}"
      contains: "SearchService"
    - path: "globcrm-web/src/app/shared/components/global-search/recent-searches.service.ts"
      provides: "localStorage-based recent search history (last 10 terms)"
      contains: "RecentSearchesService"
  key_links:
    - from: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      to: "globcrm-web/src/app/shared/components/global-search/search.service.ts"
      via: "Subject-based debounced search pipe"
      pattern: "debounceTime.*switchMap.*search"
    - from: "globcrm-web/src/app/shared/components/navbar/navbar.component.html"
      to: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      via: "<app-global-search> selector in navbar template"
      pattern: "app-global-search"
---

<objective>
Build the global search frontend: search bar component in the navbar with debounced type-ahead, grouped results overlay, navigation on click, and localStorage recent searches.

Purpose: Delivers the cross-entity search UX (SRCH-01 through SRCH-04) enabling users to quickly find any record from anywhere in the app.
Output: Global search component integrated into navbar with recent search history.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-data-operations/10-RESEARCH.md
@.planning/phases/10-data-operations/10-03-SUMMARY.md
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.html
@globcrm-web/src/app/shared/services/api.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search models, API service, and recent searches service</name>
  <files>
    globcrm-web/src/app/shared/components/global-search/search.models.ts
    globcrm-web/src/app/shared/components/global-search/search.service.ts
    globcrm-web/src/app/shared/components/global-search/recent-searches.service.ts
  </files>
  <action>
    **Create search.models.ts:**
    ```typescript
    export interface SearchResponse {
      groups: SearchGroup[];
      totalCount: number;
    }

    export interface SearchGroup {
      entityType: string;
      items: SearchHit[];
    }

    export interface SearchHit {
      id: string;
      title: string;
      subtitle?: string;
      entityType: string;
      url: string;
    }
    ```

    **Create search.service.ts:**
    Injectable service using ApiService (existing shared service). Single method:
    - `search(term: string, maxPerType: number = 5): Observable<SearchResponse>` — GET /api/search?q={term}&maxPerType={maxPerType}

    **Create recent-searches.service.ts:**
    Injectable service (providedIn: 'root') for localStorage-based recent search management:
    - Private constant: STORAGE_KEY = 'globcrm_recent_searches', MAX_ITEMS = 10
    - `getRecent(): string[]` — Read from localStorage, parse JSON, return array (empty array on error/missing)
    - `addRecent(term: string): void` — Add term to front of list, deduplicate, trim to MAX_ITEMS, save to localStorage
    - `clearRecent(): void` — Remove key from localStorage
    - `removeRecent(term: string): void` — Remove specific term from list

    These are lightweight services, NOT signal stores. The global search component uses local component signals for state (per research anti-pattern guidance: no root-provided SearchStore).
  </action>
  <verify>
    `ng build --configuration development` compiles. search.models.ts, search.service.ts, recent-searches.service.ts exist.
  </verify>
  <done>
    Search service calls backend API. Recent searches service manages localStorage with 10-item cap. Models define SearchResponse/SearchGroup/SearchHit types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GlobalSearchComponent and integrate into navbar</name>
  <files>
    globcrm-web/src/app/shared/components/global-search/global-search.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.html
  </files>
  <action>
    **Create GlobalSearchComponent** (global-search.component.ts):
    Standalone component with inline template and styles. Imports: CommonModule, MatIconModule, MatInputModule, RouterLink, FormsModule.

    **Component state (signals):**
    - searchTerm = signal('')
    - results = signal<SearchResponse | null>(null)
    - isOpen = signal(false)
    - isLoading = signal(false)
    - recentSearches = signal<string[]>([])
    - showRecent = signal(false)

    **Search logic:**
    - Private searchSubject = new Subject<string>()
    - In constructor, set up pipe:
      ```typescript
      this.searchSubject.pipe(
        debounceTime(300),
        distinctUntilChanged(),
        filter(term => term.length >= 2),
        tap(() => this.isLoading.set(true)),
        switchMap(term => this.searchService.search(term).pipe(
          catchError(() => of({ groups: [], totalCount: 0 }))
        ))
      ).subscribe(response => {
        this.results.set(response);
        this.isLoading.set(false);
        this.isOpen.set(true);
        this.showRecent.set(false);
      });
      ```

    **Methods:**
    - onSearch(event: Event): Extract input value, set searchTerm, push to searchSubject. If term < 2 chars, clear results and close.
    - onFocus(): Load recent searches, show recent panel if no active search results.
    - selectResult(hit: SearchHit): Save term to recent, close overlay, navigate via Router.
    - selectRecent(term: string): Set searchTerm, push to searchSubject.
    - clearRecent(): Clear via RecentSearchesService, update signal.
    - close(): Set isOpen false, showRecent false.
    - onKeydown(event: KeyboardEvent): Escape key closes overlay.

    **Template structure:**
    ```html
    <div class="global-search" [class.active]="isOpen() || showRecent()">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        #searchInput
        type="text"
        placeholder="Search companies, contacts, deals..."
        [value]="searchTerm()"
        (input)="onSearch($event)"
        (focus)="onFocus()"
        (keydown)="onKeydown($event)"
        autocomplete="off" />
      @if (isLoading()) {
        <mat-icon class="loading-icon">hourglass_empty</mat-icon>
      }

      <!-- Search Results Overlay -->
      @if (isOpen() && results() && results()!.groups.length > 0) {
        <div class="search-overlay">
          @for (group of results()!.groups; track group.entityType) {
            <div class="search-group">
              <div class="group-header">{{ group.entityType }}s</div>
              @for (hit of group.items; track hit.id) {
                <a class="search-hit" (click)="selectResult(hit)">
                  <mat-icon class="entity-icon">{{ getEntityIcon(hit.entityType) }}</mat-icon>
                  <div class="hit-content">
                    <span class="hit-title">{{ hit.title }}</span>
                    @if (hit.subtitle) {
                      <span class="hit-subtitle">{{ hit.subtitle }}</span>
                    }
                  </div>
                </a>
              }
            </div>
          }
        </div>
      }

      <!-- No Results -->
      @if (isOpen() && results() && results()!.groups.length === 0 && searchTerm().length >= 2) {
        <div class="search-overlay">
          <div class="no-results">No results found for "{{ searchTerm() }}"</div>
        </div>
      }

      <!-- Recent Searches -->
      @if (showRecent() && !isOpen() && recentSearches().length > 0) {
        <div class="search-overlay">
          <div class="recent-header">
            <span>Recent Searches</span>
            <button mat-icon-button (click)="clearRecent()">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
          @for (term of recentSearches(); track term) {
            <a class="recent-item" (click)="selectRecent(term)">
              <mat-icon>history</mat-icon>
              <span>{{ term }}</span>
            </a>
          }
        </div>
      }
    </div>
    ```

    **Helper:** getEntityIcon(type: string): Returns 'business' for Company, 'person' for Contact, 'handshake' for Deal.

    **Styles (inline):**
    - .global-search: relative position, flex row, background rgba(255,255,255,0.1), border-radius 8px, padding 8px 12px, width 300px (expandable)
    - .search-overlay: absolute positioned below input, background white, border-radius 8px, box-shadow, max-height 400px, overflow-y auto, z-index 1000, min-width 400px
    - .search-group: padding, border-bottom
    - .group-header: uppercase, small font, color gray, padding
    - .search-hit: flex row, padding 8px 12px, hover background, cursor pointer, text-decoration none, color inherit
    - .hit-title: font-weight 500
    - .hit-subtitle: font-size 0.85em, color gray
    - .recent-item: flex row, padding, hover background, cursor pointer
    - .no-results: padding 16px, text-align center, color gray

    **Click outside handling:** Use @HostListener('document:click') to close overlay when clicking outside (check ElementRef.nativeElement.contains). Match notification panel pattern from Phase 08-05.

    **Integrate into navbar:**
    - Add `<app-global-search></app-global-search>` to navbar template, positioned between the logo/nav links and the right-side user actions (notification bell, profile).
    - Import GlobalSearchComponent in navbar component's imports array.
  </action>
  <verify>
    `ng build --configuration development` compiles. Navigate to any page, click search bar in navbar, type "acme", see debounced search results grouped by entity type. Click a result to navigate. Focus empty search bar to see recent searches. Escape closes overlay.
  </verify>
  <done>
    Global search bar in navbar with: 300ms debounced type-ahead, grouped results (Company/Contact/Deal), entity icons, click-to-navigate, recent searches from localStorage (last 10), click-outside-to-close, Escape key support. No root-provided store -- local component signals only.
  </done>
</task>

</tasks>

<verification>
- `ng build --configuration development` passes
- Search bar visible in navbar on all pages
- Typing "acm" returns Company results (prefix matching)
- Results grouped by entity type with icons
- Clicking result navigates to entity detail page
- Recent searches shown on focus, saved to localStorage
- Overlay closes on Escape, click outside, or result selection
- Minimum 2-character query enforced
</verification>

<success_criteria>
Global search is fully functional in the navbar: responsive type-ahead search across Company, Contact, Deal with grouped results, navigation, and recent search history. All SRCH requirements addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/10-data-operations/10-05-SUMMARY.md`
</output>
