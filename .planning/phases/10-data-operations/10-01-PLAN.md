---
phase: 10-data-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/ImportJob.cs
  - src/GlobCRM.Domain/Entities/ImportJobError.cs
  - src/GlobCRM.Domain/Enums/ImportStatus.cs
  - src/GlobCRM.Domain/Enums/ImportEntityType.cs
  - src/GlobCRM.Domain/Interfaces/IImportRepository.cs
  - src/GlobCRM.Domain/Interfaces/ISearchService.cs
  - src/GlobCRM.Domain/Entities/Company.cs
  - src/GlobCRM.Domain/Entities/Contact.cs
  - src/GlobCRM.Domain/Entities/Deal.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ImportJobConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ImportJobErrorConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
autonomous: true

must_haves:
  truths:
    - "ImportJob and ImportJobError entities exist with all required properties"
    - "ImportStatus and ImportEntityType enums exist"
    - "Company, Contact, Deal have SearchVector tsvector property"
    - "EF Core configurations add HasGeneratedTsVectorColumn with GIN indexes"
    - "Migration runs successfully creating import tables and search vector columns"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/ImportJob.cs"
      provides: "Import job tracking entity with TenantId, UserId, EntityType, Status, file path, row counts, mappings JSONB, duplicate strategy"
      contains: "ImportJob"
    - path: "src/GlobCRM.Domain/Entities/ImportJobError.cs"
      provides: "Per-row import error entity"
      contains: "ImportJobError"
    - path: "src/GlobCRM.Domain/Enums/ImportStatus.cs"
      provides: "Pending, Mapping, Previewing, Processing, Completed, Failed enum"
      contains: "ImportStatus"
    - path: "src/GlobCRM.Domain/Enums/ImportEntityType.cs"
      provides: "Contact, Company, Deal enum"
      contains: "ImportEntityType"
    - path: "src/GlobCRM.Domain/Interfaces/IImportRepository.cs"
      provides: "Import job CRUD interface"
      exports: ["IImportRepository"]
    - path: "src/GlobCRM.Domain/Interfaces/ISearchService.cs"
      provides: "Cross-entity search interface"
      exports: ["ISearchService"]
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/Configurations/ImportJobConfiguration.cs"
      to: "src/GlobCRM.Domain/Entities/ImportJob.cs"
      via: "IEntityTypeConfiguration<ImportJob>"
      pattern: "ImportJobConfiguration.*IEntityTypeConfiguration<ImportJob>"
    - from: "src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs"
      to: "src/GlobCRM.Domain/Entities/Company.cs"
      via: "HasGeneratedTsVectorColumn for SearchVector"
      pattern: "HasGeneratedTsVectorColumn"
---

<objective>
Create the domain foundation for Phase 10: ImportJob/ImportJobError entities with enums, add SearchVector tsvector properties to Company/Contact/Deal for full-text search, configure EF Core mappings with GIN indexes, and run migration.

Purpose: Establishes the data model for both CSV import tracking and global search before backend services are built.
Output: Domain entities, enums, interfaces, EF Core configurations, and migration for import tables + search vector columns.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-data-operations/10-RESEARCH.md
@src/GlobCRM.Domain/Entities/Company.cs
@src/GlobCRM.Domain/Entities/Contact.cs
@src/GlobCRM.Domain/Entities/Deal.cs
@src/GlobCRM.Domain/Entities/Dashboard.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/DashboardConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import domain entities, enums, and interfaces + add SearchVector to existing entities</name>
  <files>
    src/GlobCRM.Domain/Entities/ImportJob.cs
    src/GlobCRM.Domain/Entities/ImportJobError.cs
    src/GlobCRM.Domain/Enums/ImportStatus.cs
    src/GlobCRM.Domain/Enums/ImportEntityType.cs
    src/GlobCRM.Domain/Interfaces/IImportRepository.cs
    src/GlobCRM.Domain/Interfaces/ISearchService.cs
    src/GlobCRM.Domain/Entities/Company.cs
    src/GlobCRM.Domain/Entities/Contact.cs
    src/GlobCRM.Domain/Entities/Deal.cs
  </files>
  <action>
    **Create ImportStatus enum** (src/GlobCRM.Domain/Enums/ImportStatus.cs):
    Values: Pending, Mapping, Previewing, Processing, Completed, Failed. Follow existing enum pattern (e.g., RequestStatus.cs).

    **Create ImportEntityType enum** (src/GlobCRM.Domain/Enums/ImportEntityType.cs):
    Values: Contact, Company, Deal. Simple enum matching the three importable entity types.

    **Create ImportJob entity** (src/GlobCRM.Domain/Entities/ImportJob.cs):
    Follow existing entity pattern from Dashboard.cs / Company.cs:
    - Guid Id with NewGuid default
    - Guid TenantId (tenant isolation)
    - Guid UserId + ApplicationUser? User navigation (who initiated)
    - ImportEntityType EntityType
    - ImportStatus Status = ImportStatus.Pending
    - string OriginalFileName
    - string StoredFilePath (IFileStorageService path for uploaded CSV)
    - int TotalRows, ProcessedRows, SuccessCount, ErrorCount, DuplicateCount
    - List<ImportFieldMapping> Mappings (value object for JSONB storage)
    - string DuplicateStrategy = "skip" (skip/overwrite/merge)
    - DateTimeOffset CreatedAt, StartedAt?, CompletedAt?
    - ICollection<ImportJobError> Errors navigation

    **Create ImportFieldMapping value object** (in ImportJob.cs file):
    - string CsvColumn
    - string EntityField
    - bool IsCustomField

    **Create ImportJobError entity** (src/GlobCRM.Domain/Entities/ImportJobError.cs):
    - Guid Id with NewGuid default
    - Guid ImportJobId + ImportJob navigation
    - int RowNumber
    - string FieldName
    - string ErrorMessage
    - string? RawValue

    **Create IImportRepository interface** (src/GlobCRM.Domain/Interfaces/IImportRepository.cs):
    - Task<ImportJob> GetByIdAsync(Guid id)
    - Task<ImportJob> CreateAsync(ImportJob job)
    - Task UpdateAsync(ImportJob job)
    - Task<List<ImportJob>> GetByUserAsync(Guid userId, int page, int pageSize)

    **Create ISearchService interface** (src/GlobCRM.Domain/Interfaces/ISearchService.cs):
    - Task<GlobalSearchResult> SearchAsync(string term, Guid userId, int maxPerType = 5)
    Define GlobalSearchResult and SearchHit DTOs in this file:
    - GlobalSearchResult has List<SearchGroup> Groups
    - SearchGroup has string EntityType, List<SearchHit> Items
    - SearchHit has Guid Id, string Title, string? Subtitle, string EntityType, string Url

    **Add SearchVector property to Company, Contact, Deal entities**:
    Add `public NpgsqlTsVector SearchVector { get; set; } = null!;` to each entity.
    Add `using NpgsqlTypes;` at the top of each file.
    Place the property after CustomFields and before IsSeedData.
  </action>
  <verify>
    `dotnet build src/GlobCRM.Domain/GlobCRM.Domain.csproj` compiles without errors. Verify ImportJob.cs, ImportJobError.cs, ImportStatus.cs, ImportEntityType.cs, IImportRepository.cs, ISearchService.cs exist. Verify Company.cs, Contact.cs, Deal.cs have SearchVector property.
  </verify>
  <done>
    All domain entities, enums, and interfaces compile. Company, Contact, Deal have NpgsqlTsVector SearchVector property.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, register DbSets, and run migration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/ImportJobConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ImportJobErrorConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/CompanyConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ContactConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/DealConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  </files>
  <action>
    **Create ImportJobConfiguration** (Configurations/ImportJobConfiguration.cs):
    Follow DashboardConfiguration pattern:
    - Table name: "import_jobs"
    - Snake_case column mapping for all properties
    - Mappings property: HasColumnType("jsonb") with HasDefaultValueSql("'[]'::jsonb") — use System.Text.Json HasConversion for List<ImportFieldMapping> (matching existing JSONB patterns with Dictionary properties)
    - UserId FK: HasOne(User).WithMany().HasForeignKey(UserId).OnDelete(SetNull) — import survives user deletion
    - Errors navigation: HasMany(Errors).WithOne(ImportJob).HasForeignKey(ImportJobId).OnDelete(Cascade)
    - Indexes: idx_import_jobs_tenant on TenantId, idx_import_jobs_tenant_user on (TenantId, UserId), idx_import_jobs_status on Status
    - DuplicateStrategy: HasMaxLength(20)
    - OriginalFileName: HasMaxLength(500)
    - StoredFilePath: HasMaxLength(1000)

    **Create ImportJobErrorConfiguration** (Configurations/ImportJobErrorConfiguration.cs):
    - Table name: "import_job_errors"
    - Snake_case column mapping
    - No TenantId (child entity, inherits via ImportJob FK)
    - FieldName: HasMaxLength(200)
    - ErrorMessage: HasMaxLength(1000)
    - RawValue: HasMaxLength(2000), nullable
    - Index on ImportJobId

    **Update CompanyConfiguration**: Add SearchVector configuration AFTER existing indexes:
    ```csharp
    builder.HasGeneratedTsVectorColumn(
        c => c.SearchVector,
        "english",
        c => new { c.Name, c.Industry, c.Email, c.City })
        .HasColumnName("search_vector");

    builder.HasIndex(c => c.SearchVector)
        .HasMethod("GIN")
        .HasDatabaseName("idx_companies_search_vector");
    ```

    **Update ContactConfiguration**: Add SearchVector:
    ```csharp
    builder.HasGeneratedTsVectorColumn(
        c => c.SearchVector,
        "english",
        c => new { c.FirstName, c.LastName, c.Email, c.JobTitle })
        .HasColumnName("search_vector");

    builder.HasIndex(c => c.SearchVector)
        .HasMethod("GIN")
        .HasDatabaseName("idx_contacts_search_vector");
    ```

    **Update DealConfiguration**: Add SearchVector:
    ```csharp
    builder.HasGeneratedTsVectorColumn(
        d => d.SearchVector,
        "english",
        d => new { d.Title, d.Description })
        .HasColumnName("search_vector");

    builder.HasIndex(d => d.SearchVector)
        .HasMethod("GIN")
        .HasDatabaseName("idx_deals_search_vector");
    ```

    **Update ApplicationDbContext**: Add DbSet<ImportJob> ImportJobs and DbSet<ImportJobError> ImportJobErrors. Add global query filter for ImportJob (tenant isolation matching existing pattern).

    **Run migration**:
    ```bash
    dotnet ef migrations add AddImportAndSearchVector --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext --output-dir Persistence/Migrations/App
    dotnet ef database update --project src/GlobCRM.Infrastructure --startup-project src/GlobCRM.Api --context ApplicationDbContext
    ```
  </action>
  <verify>
    `dotnet build` succeeds. Migration file exists in Persistence/Migrations/App. `dotnet ef database update` completes without errors. Verify import_jobs and import_job_errors tables created, and search_vector columns added to companies, contacts, deals tables.
  </verify>
  <done>
    Import tables and search vector columns exist in database. EF Core configurations correctly map all properties with snake_case naming, JSONB for mappings, and GIN indexes for SearchVector columns.
  </done>
</task>

</tasks>

<verification>
- `dotnet build` passes with no errors
- Migration runs successfully
- ImportJob, ImportJobError tables exist with correct columns
- companies.search_vector, contacts.search_vector, deals.search_vector columns exist with GIN indexes
- All domain interfaces (IImportRepository, ISearchService) are defined
</verification>

<success_criteria>
Domain foundation for both import tracking and global search is in place. All entities, enums, interfaces, and EF Core configurations exist. Database migration adds import tables and tsvector columns with GIN indexes.
</success_criteria>

<output>
After completion, create `.planning/phases/10-data-operations/10-01-SUMMARY.md`
</output>
