---
phase: 10-data-operations
plan: 04
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - globcrm-web/src/app/features/import/import.models.ts
  - globcrm-web/src/app/features/import/import.service.ts
  - globcrm-web/src/app/features/import/stores/import.store.ts
  - globcrm-web/src/app/features/import/import-wizard/import-wizard.component.ts
  - globcrm-web/src/app/features/import/import-wizard/step-upload.component.ts
  - globcrm-web/src/app/features/import/import-wizard/step-mapping.component.ts
  - globcrm-web/src/app/features/import/import-wizard/step-preview.component.ts
  - globcrm-web/src/app/features/import/import-wizard/step-progress.component.ts
autonomous: true

must_haves:
  truths:
    - "User can upload a CSV file and see parsed column headers"
    - "User can map CSV columns to entity fields (core + custom) with skip option"
    - "User can preview import results with validation errors and duplicate count before executing"
    - "User can choose duplicate strategy (skip/overwrite/merge) during mapping"
    - "User sees real-time progress bar during import execution via SignalR"
    - "User sees completion summary with success/error counts"
  artifacts:
    - path: "globcrm-web/src/app/features/import/import.models.ts"
      provides: "TypeScript interfaces for import job, mapping, preview, progress"
      contains: "ImportJob"
    - path: "globcrm-web/src/app/features/import/import.service.ts"
      provides: "API service with upload, mapping, preview, execute, getJob methods"
      contains: "ImportService"
    - path: "globcrm-web/src/app/features/import/import-wizard/import-wizard.component.ts"
      provides: "Multi-step stepper wizard orchestrating upload->map->preview->progress steps"
      contains: "ImportWizardComponent"
  key_links:
    - from: "globcrm-web/src/app/features/import/import.service.ts"
      to: "POST /api/imports/upload"
      via: "HttpClient FormData upload"
      pattern: "upload.*FormData"
    - from: "globcrm-web/src/app/features/import/import-wizard/step-progress.component.ts"
      to: "SignalR ImportProgress event"
      via: "SignalRService subscription for real-time progress"
      pattern: "ImportProgress"
---

<objective>
Build the frontend import wizard: TypeScript models, API service, signal store, and a multi-step stepper component (Upload -> Map -> Preview -> Progress) with real-time SignalR progress tracking.

Purpose: Delivers the user-facing import experience (IMPT-01 through IMPT-05) with a guided wizard flow that prevents mistakes through preview and confirmation.
Output: Complete import feature module with 4-step wizard.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-data-operations/10-RESEARCH.md
@.planning/phases/10-data-operations/10-02-SUMMARY.md
@globcrm-web/src/app/features/dashboard/services/dashboard.service.ts
@globcrm-web/src/app/features/activities/services/activity.service.ts
@globcrm-web/src/app/shared/services/signalr.service.ts
@globcrm-web/src/app/features/settings/pages/custom-fields/custom-fields.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import models, API service, and signal store</name>
  <files>
    globcrm-web/src/app/features/import/import.models.ts
    globcrm-web/src/app/features/import/import.service.ts
    globcrm-web/src/app/features/import/stores/import.store.ts
  </files>
  <action>
    **Create import.models.ts:**
    ```typescript
    export type ImportEntityType = 'Contact' | 'Company' | 'Deal';
    export type ImportStatus = 'Pending' | 'Mapping' | 'Previewing' | 'Processing' | 'Completed' | 'Failed';
    export type DuplicateStrategy = 'skip' | 'overwrite' | 'merge';

    export interface ImportFieldMapping {
      csvColumn: string;
      entityField: string;
      isCustomField: boolean;
    }

    export interface ImportJob {
      id: string;
      entityType: ImportEntityType;
      status: ImportStatus;
      originalFileName: string;
      totalRows: number;
      processedRows: number;
      successCount: number;
      errorCount: number;
      duplicateCount: number;
      mappings: ImportFieldMapping[];
      duplicateStrategy: DuplicateStrategy;
      createdAt: string;
      startedAt?: string;
      completedAt?: string;
      errors: ImportJobError[];
    }

    export interface ImportJobError {
      id: string;
      rowNumber: number;
      fieldName: string;
      errorMessage: string;
      rawValue?: string;
    }

    export interface UploadResponse {
      importJobId: string;
      headers: string[];
      sampleRows: Record<string, string>[];
      totalRows: number;
    }

    export interface PreviewResponse {
      validCount: number;
      invalidCount: number;
      duplicateCount: number;
      errors: PreviewError[];
      duplicates: DuplicateMatch[];
    }

    export interface PreviewError {
      rowNumber: number;
      fieldName: string;
      errorMessage: string;
      rawValue?: string;
    }

    export interface DuplicateMatch {
      rowIndex: number;
      existingEntityId: string;
      matchField: string;
      matchValue: string;
    }

    export interface ImportProgress {
      importJobId: string;
      processedRows: number;
      totalRows: number;
      successCount: number;
      errorCount: number;
      status: ImportStatus;
    }

    // Entity field definitions for mapping UI
    export interface EntityFieldDef {
      key: string;
      label: string;
      required: boolean;
      type: string;
    }

    export const COMPANY_CORE_FIELDS: EntityFieldDef[] = [
      { key: 'name', label: 'Company Name', required: true, type: 'text' },
      { key: 'industry', label: 'Industry', required: false, type: 'text' },
      { key: 'website', label: 'Website', required: false, type: 'text' },
      { key: 'phone', label: 'Phone', required: false, type: 'text' },
      { key: 'email', label: 'Email', required: false, type: 'text' },
      { key: 'address', label: 'Address', required: false, type: 'text' },
      { key: 'city', label: 'City', required: false, type: 'text' },
      { key: 'state', label: 'State', required: false, type: 'text' },
      { key: 'country', label: 'Country', required: false, type: 'text' },
      { key: 'postalCode', label: 'Postal Code', required: false, type: 'text' },
      { key: 'size', label: 'Company Size', required: false, type: 'text' },
      { key: 'description', label: 'Description', required: false, type: 'text' },
    ];

    export const CONTACT_CORE_FIELDS: EntityFieldDef[] = [
      { key: 'firstName', label: 'First Name', required: true, type: 'text' },
      { key: 'lastName', label: 'Last Name', required: true, type: 'text' },
      { key: 'email', label: 'Email', required: false, type: 'text' },
      { key: 'phone', label: 'Phone', required: false, type: 'text' },
      { key: 'mobilePhone', label: 'Mobile Phone', required: false, type: 'text' },
      { key: 'jobTitle', label: 'Job Title', required: false, type: 'text' },
      { key: 'department', label: 'Department', required: false, type: 'text' },
      { key: 'address', label: 'Address', required: false, type: 'text' },
      { key: 'city', label: 'City', required: false, type: 'text' },
      { key: 'state', label: 'State', required: false, type: 'text' },
      { key: 'country', label: 'Country', required: false, type: 'text' },
      { key: 'postalCode', label: 'Postal Code', required: false, type: 'text' },
      { key: 'companyName', label: 'Company Name (link by name)', required: false, type: 'text' },
      { key: 'description', label: 'Description', required: false, type: 'text' },
    ];

    export const DEAL_CORE_FIELDS: EntityFieldDef[] = [
      { key: 'title', label: 'Deal Title', required: true, type: 'text' },
      { key: 'value', label: 'Value', required: false, type: 'number' },
      { key: 'probability', label: 'Probability', required: false, type: 'number' },
      { key: 'expectedCloseDate', label: 'Expected Close Date', required: false, type: 'date' },
      { key: 'pipelineName', label: 'Pipeline (name lookup)', required: false, type: 'text' },
      { key: 'stageName', label: 'Stage (name lookup)', required: false, type: 'text' },
      { key: 'companyName', label: 'Company (name lookup)', required: false, type: 'text' },
      { key: 'description', label: 'Description', required: false, type: 'text' },
    ];
    ```

    **Create import.service.ts:**
    Use HttpClient directly (not ApiService) for FormData upload, matching ActivityService attachment pattern:
    - `upload(file: File, entityType: ImportEntityType): Observable<UploadResponse>` — POST FormData to /api/imports/upload?entityType={type}
    - `saveMapping(importJobId: string, mappings: ImportFieldMapping[], duplicateStrategy: DuplicateStrategy): Observable<void>` — POST /api/imports/{id}/mapping
    - `preview(importJobId: string): Observable<PreviewResponse>` — POST /api/imports/{id}/preview
    - `execute(importJobId: string): Observable<void>` — POST /api/imports/{id}/execute
    - `getJob(importJobId: string): Observable<ImportJob>` — GET /api/imports/{id}
    - `getJobs(page: number, pageSize: number): Observable<ImportJob[]>` — GET /api/imports?page={p}&pageSize={s}

    **Create import.store.ts:**
    Component-provided SignalStore (matching DashboardStore pattern). State:
    - currentJob: ImportJob | null
    - uploadResponse: UploadResponse | null
    - previewResponse: PreviewResponse | null
    - progress: ImportProgress | null
    - loading: boolean
    - error: string | null
    - step: number (0-3 for wizard steps)

    Methods: upload, saveMapping, preview, execute, setStep, updateProgress, reset.
    The store does NOT subscribe to SignalR directly -- the wizard component handles that.
  </action>
  <verify>
    `ng build --configuration development` compiles. Models, service, and store files exist with correct types.
  </verify>
  <done>
    Import TypeScript models define all DTOs. ImportService has methods for all 6 API endpoints. ImportStore manages wizard state with step tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create import wizard component with 4-step stepper (Upload, Mapping, Preview, Progress)</name>
  <files>
    globcrm-web/src/app/features/import/import-wizard/import-wizard.component.ts
    globcrm-web/src/app/features/import/import-wizard/step-upload.component.ts
    globcrm-web/src/app/features/import/import-wizard/step-mapping.component.ts
    globcrm-web/src/app/features/import/import-wizard/step-preview.component.ts
    globcrm-web/src/app/features/import/import-wizard/step-progress.component.ts
  </files>
  <action>
    All components use inline templates/styles (single .ts file) matching deal-form, activity-form patterns.

    **ImportWizardComponent** (import-wizard.component.ts):
    Uses MatStepper (mat-stepper) with 4 steps. Component-provided ImportStore.
    - Step 1: Upload — entity type selection + file upload
    - Step 2: Mapping — CSV column to entity field mapping
    - Step 3: Preview — validation results + confirm
    - Step 4: Progress — real-time progress + completion summary
    Steps are linear (user can't skip ahead). Each step component receives ImportStore via inject().

    **StepUploadComponent** (step-upload.component.ts):
    - MatSelect for entity type (Contact, Company, Deal)
    - File input (accept=".csv") with drag-and-drop zone styling
    - On file select: call store.upload(file, entityType)
    - Show file name, size, and row count after upload
    - "Next" button enabled when uploadResponse is set
    - Load custom field definitions for the selected entity type via CustomFieldsService (existing service)

    **StepMappingComponent** (step-mapping.component.ts):
    - Display CSV columns from uploadResponse.headers
    - For each column: MatSelect dropdown with entity fields (core fields from constant arrays + custom fields loaded from API)
    - Auto-match: on init, attempt to match CSV headers to entity fields by name similarity (case-insensitive, trimmed)
    - "Skip" option (empty value) for unmapped columns
    - MatRadioGroup for duplicate strategy: Skip duplicates, Overwrite existing, Merge (update non-empty)
    - Show sample data preview (first 3 rows) next to each mapping for reference
    - "Next" button calls store.saveMapping and moves to preview

    **StepPreviewComponent** (step-preview.component.ts):
    - Call store.preview() on step entry
    - Display summary cards: Valid rows (green), Invalid rows (red), Duplicate rows (yellow)
    - Expandable error list showing row number, field, error message, raw value
    - Expandable duplicate list showing row index, match field, match value
    - "Execute Import" button (primary) calls store.execute()
    - "Back" button to adjust mappings

    **StepProgressComponent** (step-progress.component.ts):
    - Subscribe to SignalRService for "ImportProgress" events matching current job ID
    - MatProgressBar in determinate mode: (processedRows / totalRows) * 100
    - Display: processedRows / totalRows processed, successCount successes, errorCount errors
    - On completion (status === 'Completed' or 'Failed'):
      - Show completion banner with summary
      - If errors: show first 10 errors in a table (rowNumber, fieldName, errorMessage)
      - "Import Another" button resets store and returns to step 1
      - "View Import History" link to /settings/imports
  </action>
  <verify>
    `ng build --configuration development` compiles. Navigate to import wizard, upload a CSV, map fields, preview, and execute. SignalR progress bar updates in real time.
  </verify>
  <done>
    4-step import wizard is fully functional: entity type selection + file upload -> column-to-field mapping with auto-match and custom fields -> preview with validation/duplicate summary -> real-time progress with completion summary. All steps use ImportStore for state management.
  </done>
</task>

</tasks>

<verification>
- `ng build --configuration development` passes
- Import wizard renders 4 steps in MatStepper
- File upload sends CSV and receives headers + sample
- Field mapping shows core fields + custom fields with auto-match
- Preview shows valid/invalid/duplicate counts with error details
- Progress bar updates via SignalR during execution
- Completion summary shows success/error counts
</verification>

<success_criteria>
Frontend import wizard guides user through complete import flow: upload CSV -> map columns to entity fields -> preview validation results -> execute with real-time progress -> see completion summary. All IMPT requirements are addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/10-data-operations/10-04-SUMMARY.md`
</output>
