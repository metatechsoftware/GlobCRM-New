---
phase: 29-integration-marketplace
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Integration.cs
  - src/GlobCRM.Domain/Entities/IntegrationActivityLog.cs
  - src/GlobCRM.Domain/Enums/IntegrationStatus.cs
  - src/GlobCRM.Domain/Enums/IntegrationAction.cs
  - src/GlobCRM.Domain/Interfaces/IIntegrationRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/IntegrationConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/IntegrationActivityLogConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/IntegrationRepository.cs
  - src/GlobCRM.Infrastructure/Services/CredentialEncryptionService.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
autonomous: true
requirements:
  - INTG-06
  - INTG-10

must_haves:
  truths:
    - "Integration and IntegrationActivityLog entities exist with tenant-scoped isolation"
    - "Credential encryption service can encrypt and decrypt JSON credential blobs"
    - "EF Core migration creates integrations and integration_activity_logs tables with correct schema"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Integration.cs"
      provides: "Integration entity with TenantId, IntegrationKey, Status, EncryptedCredentials, CredentialMask"
      contains: "class Integration"
    - path: "src/GlobCRM.Domain/Entities/IntegrationActivityLog.cs"
      provides: "Activity log entity with FK to Integration"
      contains: "class IntegrationActivityLog"
    - path: "src/GlobCRM.Domain/Enums/IntegrationStatus.cs"
      provides: "Connected, Disconnected enum"
      contains: "enum IntegrationStatus"
    - path: "src/GlobCRM.Domain/Enums/IntegrationAction.cs"
      provides: "Connected, Disconnected, TestSuccess, TestFailed enum"
      contains: "enum IntegrationAction"
    - path: "src/GlobCRM.Infrastructure/Services/CredentialEncryptionService.cs"
      provides: "AES-256 encryption via DataProtection"
      contains: "class CredentialEncryptionService"
    - path: "src/GlobCRM.Infrastructure/Persistence/Repositories/IntegrationRepository.cs"
      provides: "Repository implementation for Integration queries"
      contains: "class IntegrationRepository"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "Integration entity"
      via: "DbSet<Integration> and global query filter"
      pattern: "DbSet<Integration>"
    - from: "src/GlobCRM.Infrastructure/Services/CredentialEncryptionService.cs"
      to: "IDataProtectionProvider"
      via: "DI constructor injection"
      pattern: "CreateProtector.*Integration\\.Credentials"
---

<objective>
Create the backend domain model and infrastructure for integration marketplace: entities, enums, EF Core configurations, database migration, credential encryption service, and repository.

Purpose: All backend API work depends on these domain entities and infrastructure services. The Integration entity stores per-tenant connection state with encrypted credentials. The IntegrationActivityLog entity records connect/disconnect/test events.
Output: Two new database tables (integrations, integration_activity_logs), CredentialEncryptionService, IntegrationRepository, and supporting domain types.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-integration-marketplace/29-RESEARCH.md

@src/GlobCRM.Domain/Entities/WebhookSubscription.cs (entity pattern reference)
@src/GlobCRM.Domain/Entities/WebhookDeliveryLog.cs (child entity pattern)
@src/GlobCRM.Infrastructure/Gmail/TokenEncryptionService.cs (encryption pattern to clone)
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs (DbSet + query filter registration)
@src/GlobCRM.Infrastructure/DependencyInjection.cs (service registration pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create domain entities, enums, and repository interface</name>
  <files>
    src/GlobCRM.Domain/Entities/Integration.cs
    src/GlobCRM.Domain/Entities/IntegrationActivityLog.cs
    src/GlobCRM.Domain/Enums/IntegrationStatus.cs
    src/GlobCRM.Domain/Enums/IntegrationAction.cs
    src/GlobCRM.Domain/Interfaces/IIntegrationRepository.cs
  </files>
  <action>
    Create `IntegrationStatus` enum with values: `Connected`, `Disconnected`.

    Create `IntegrationAction` enum with values: `Connected`, `Disconnected`, `TestSuccess`, `TestFailed`.

    Create `Integration` entity following the existing entity pattern (see WebhookSubscription.cs):
    - `Id` (Guid)
    - `TenantId` (Guid) -- for multi-tenant isolation
    - `IntegrationKey` (string) -- matches frontend catalog key slug (e.g., "slack", "gmail")
    - `Status` (IntegrationStatus) -- Connected or Disconnected
    - `EncryptedCredentials` (string?) -- AES-256 encrypted JSON blob of all credentials
    - `CredentialMask` (string?) -- masked display value like "........a1b2" (last 4 chars of primary credential)
    - `ConnectedByUserId` (Guid)
    - `ConnectedAt` (DateTimeOffset)
    - `DisconnectedAt` (DateTimeOffset?)
    - `CreatedAt` (DateTimeOffset)
    - `UpdatedAt` (DateTimeOffset)
    - Navigation: `ICollection<IntegrationActivityLog> ActivityLogs`

    Create `IntegrationActivityLog` entity:
    - `Id` (Guid)
    - `TenantId` (Guid)
    - `IntegrationId` (Guid) -- FK to Integration
    - `Action` (IntegrationAction)
    - `PerformedByUserId` (Guid)
    - `PerformedByUserName` (string) -- denormalized for display
    - `Details` (string?) -- optional detail text (e.g., "Test failed: connection timeout")
    - `CreatedAt` (DateTimeOffset)
    - Navigation: `Integration Integration`

    Create `IIntegrationRepository` interface:
    - `Task<Integration?> GetByKeyAsync(string integrationKey)` -- find by key for current tenant
    - `Task<List<Integration>> GetAllAsync()` -- all integrations for current tenant
    - `Task<Integration?> GetByIdAsync(Guid id)` -- single integration by ID
    - `Task<List<IntegrationActivityLog>> GetActivityLogsAsync(Guid integrationId, int limit = 50)` -- activity log for an integration
    - `Task AddAsync(Integration integration)`
    - `Task AddActivityLogAsync(IntegrationActivityLog log)`
    - `Task SaveChangesAsync()`
  </action>
  <verify>Run `dotnet build C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/src/GlobCRM.Domain/GlobCRM.Domain.csproj` -- must compile cleanly.</verify>
  <done>Integration and IntegrationActivityLog entities exist with all properties, IntegrationStatus and IntegrationAction enums defined, IIntegrationRepository interface defined. Domain project builds.</done>
</task>

<task type="auto">
  <name>Task 2: Create EF Core configurations, migration, encryption service, repository, and DI registration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/IntegrationConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/IntegrationActivityLogConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/IntegrationRepository.cs
    src/GlobCRM.Infrastructure/Services/CredentialEncryptionService.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
    scripts/rls-setup.sql
  </files>
  <action>
    Create `IntegrationConfiguration` (IEntityTypeConfiguration):
    - Table name: `integrations` (snake_case)
    - `IntegrationKey`: `varchar(50)`, required
    - `EncryptedCredentials`: `text`, nullable
    - `CredentialMask`: `varchar(50)`, nullable
    - `ConnectedByUserId`: required
    - `PerformedByUserName`: not needed here (that's on the log)
    - Index: unique composite on `(TenantId, IntegrationKey)` -- one connection per integration per tenant
    - `Status` stored as string (follows JsonStringEnumConverter pattern)
    - `CreatedAt`, `UpdatedAt`: standard timestamp columns
    - All column names in snake_case per project convention

    Create `IntegrationActivityLogConfiguration`:
    - Table name: `integration_activity_logs`
    - FK to Integration (`IntegrationId`) with cascade delete
    - `Action` stored as string
    - `PerformedByUserName`: `varchar(200)`, required
    - `Details`: `text`, nullable
    - Index on `IntegrationId` + `CreatedAt` descending (for activity log queries)
    - All columns snake_case

    Update `ApplicationDbContext`:
    - Add `DbSet<Integration> Integrations`
    - Add `DbSet<IntegrationActivityLog> IntegrationActivityLogs`
    - Add global query filter for `Integration` on `TenantId` (same pattern as other entities)
    - Add global query filter for `IntegrationActivityLog` on `TenantId`

    Create `CredentialEncryptionService` (clone of `TokenEncryptionService`):
    - Constructor takes `IDataProtectionProvider`
    - Purpose string: `"GlobCRM.Integration.Credentials"`
    - `Encrypt(string plainText)` and `Decrypt(string encrypted)` methods
    - Place in `src/GlobCRM.Infrastructure/Services/` (not Gmail folder)

    Create `IntegrationRepository` implementing `IIntegrationRepository`:
    - Constructor injects `ApplicationDbContext`
    - `GetByKeyAsync` filters by `IntegrationKey` (tenant filter applied automatically by global query filter)
    - `GetAllAsync` returns all integrations for tenant
    - `GetByIdAsync` finds by Id
    - `GetActivityLogsAsync` queries logs ordered by `CreatedAt` descending with limit
    - Standard Add/SaveChanges pattern

    Update `DependencyInjection.cs`:
    - Register `CredentialEncryptionService` as singleton (same as TokenEncryptionService)
    - Register `IIntegrationRepository` / `IntegrationRepository` as scoped

    Create EF migration by running:
    `dotnet ef migrations add AddIntegrationMarketplace --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure` (from src/GlobCRM.Api)

    Update `scripts/rls-setup.sql`:
    - Add RLS policy for `integrations` table (same pattern as other tenant-scoped tables)
    - Add RLS policy for `integration_activity_logs` table
  </action>
  <verify>
    Run `dotnet build C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/GlobCRM.slnx` -- entire solution must compile.
    Run `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` from `src/GlobCRM.Api/` to apply migration.
  </verify>
  <done>Database has `integrations` and `integration_activity_logs` tables. CredentialEncryptionService encrypts/decrypts with DataProtection. IntegrationRepository provides query methods. Global query filters ensure tenant isolation. RLS policies updated.</done>
</task>

</tasks>

<verification>
- `dotnet build GlobCRM.slnx` passes
- `integrations` table exists in database with correct columns (id, tenant_id, integration_key, status, encrypted_credentials, credential_mask, connected_by_user_id, connected_at, disconnected_at, created_at, updated_at)
- `integration_activity_logs` table exists with correct columns and FK to integrations
- Unique index on (tenant_id, integration_key) prevents duplicate connections
- CredentialEncryptionService registered in DI
</verification>

<success_criteria>
Backend domain model complete: two new entities, two enums, EF Core configurations with snake_case columns, migration applied, CredentialEncryptionService operational, IntegrationRepository registered. All existing tests/builds pass.
</success_criteria>

<output>
After completion, create `.planning/phases/29-integration-marketplace/29-01-SUMMARY.md`
</output>
