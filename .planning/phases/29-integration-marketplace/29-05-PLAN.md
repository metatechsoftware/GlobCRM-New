---
phase: 29-integration-marketplace
plan: 05
type: execute
wave: 4
depends_on: ["29-04"]
files_modified:
  - globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.ts
  - globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.scss
  - globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
  - globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.scss
  - globcrm-web/src/app/features/settings/settings-hub.component.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/assets/i18n/settings/en.json
  - globcrm-web/src/assets/i18n/settings/tr.json
autonomous: false
requirements:
  - INTG-07
  - INTG-08
  - INTG-10
  - INTG-12

must_haves:
  truths:
    - "User can click an integration card to open a right-side detail panel"
    - "Detail panel shows integration description, connection status, masked credentials (never raw), and activity log"
    - "Admin can Connect/Disconnect/Test from inside the detail panel"
    - "Activity log shows chronological connect/disconnect/test events with user names and timestamps"
    - "Settings hub has an Integrations card that routes to the marketplace page"
    - "All marketplace UI strings use Transloco translation keys"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.ts"
      provides: "Right-side overlay detail panel with integration info and activity log"
      contains: "IntegrationDetailPanelComponent"
    - path: "globcrm-web/src/assets/i18n/settings/en.json"
      provides: "English translation keys for integration marketplace"
      contains: "integrations"
    - path: "globcrm-web/src/assets/i18n/settings/tr.json"
      provides: "Turkish translation keys for integration marketplace"
      contains: "integrations"
  key_links:
    - from: "integration-detail-panel.component.ts"
      to: "integration.service.ts"
      via: "getActivityLog() for loading activity log entries"
      pattern: "getActivityLog"
    - from: "integration-marketplace.component.ts"
      to: "integration-detail-panel.component.ts"
      via: "CDK Overlay or template-driven panel toggle"
      pattern: "IntegrationDetailPanelComponent"
    - from: "settings-hub.component.ts"
      to: "/settings/integrations"
      via: "Integrations card with route link"
      pattern: "integrations"
    - from: "settings.routes.ts"
      to: "integration-marketplace.component.ts"
      via: "loadComponent lazy route"
      pattern: "integration-marketplace"
---

<objective>
Create the integration detail panel (right-side drawer), add the route and settings hub card, and add Transloco i18n support for all marketplace UI strings.

Purpose: The detail panel is the primary interface for viewing integration details (INTG-08), masked credentials (INTG-07), and activity log (INTG-10). The settings hub card and route make the marketplace discoverable. i18n ensures all strings are translatable.
Output: Complete integration marketplace feature: browsable, connectable, with detail panel, activity log, settings hub entry, and full i18n coverage.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-integration-marketplace/29-CONTEXT.md
@.planning/phases/29-integration-marketplace/29-RESEARCH.md
@.planning/phases/29-integration-marketplace/29-03-SUMMARY.md
@.planning/phases/29-integration-marketplace/29-04-SUMMARY.md

@globcrm-web/src/app/features/settings/settings-hub.component.ts (hub card registration)
@globcrm-web/src/app/features/settings/settings.routes.ts (route registration)
@globcrm-web/src/assets/i18n/settings/en.json (existing settings translations)
@globcrm-web/src/assets/i18n/settings/tr.json (existing settings translations)
@globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
@globcrm-web/src/app/features/settings/integrations/integration.models.ts
@globcrm-web/src/app/features/settings/integrations/integration.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detail panel component with activity log and masked credentials</name>
  <files>
    globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.ts
    globcrm-web/src/app/features/settings/integrations/integration-detail-panel.component.scss
    globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
    globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.scss
  </files>
  <action>
    Create `IntegrationDetailPanelComponent` (standalone, OnPush):

    **Implementation approach:** Use a template-driven panel inside the marketplace component template (not CDK Overlay). The panel is a fixed-position right-side drawer that slides in/out. This is simpler than CDK Overlay and avoids the complexity mentioned in the research about panel/sidebar conflicts. Use CSS transform for the slide animation.

    **Inputs:**
    - `integration` (IntegrationViewModel | null) -- when non-null, panel is open
    - `isAdmin` (boolean) -- controls action button visibility
    - `activityLog` (IntegrationActivityLogEntry[]) -- activity log entries

    **Outputs:**
    - `close` (EventEmitter<void>)
    - `connect` (EventEmitter<IntegrationCatalogItem>)
    - `disconnect` (EventEmitter<IntegrationViewModel>)
    - `testConnection` (EventEmitter<IntegrationViewModel>)

    **Template layout (linear flow, per locked decision -- not tabs):**

    1. **Header section:**
       - Brand icon (40x40) + integration name + status badge + close button (mat-icon-button with "close" icon)

    2. **Description section:**
       - Integration description text from catalog
       - Category chip (read-only)

    3. **Connection section** (only visible when connected):
       - "Connected" status with green indicator
       - Masked credentials displayed as read-only fields: label + `........XXXX` value (per locked decision, no reveal option)
       - "Connected at" timestamp
       - "Connected by" user name (if available from connection data -- may need API enhancement or just show the timestamp)

    4. **Actions section** (admin-only, per INTG-12):
       - If not connected: "Connect" button (primary color)
       - If connected: "Test Connection" button (default) + "Disconnect" button (warn color)
       - Test result display: inline beneath the test button showing green checkmark with "Connection test passed" or red X with failure message (per research discretion -- inline, not toast)

    5. **Activity Log section:**
       - Section header: "Activity Log"
       - Simple chronological list (newest first):
         - Each entry: action icon (link for connected, link_off for disconnected, verified for test success, error for test failed) + action text + user name + relative timestamp
       - Empty state: "No activity recorded yet"

    **Panel SCSS:**
    - Fixed position, right: 0, top: 0, bottom: 0
    - Width: 480px (per research -- matches preview sidebar)
    - Background: surface color, box-shadow for elevation
    - z-index above the grid but below MatDialog
    - Slide-in animation via CSS transform: `translateX(100%)` -> `translateX(0)`
    - Sections separated by `mat-divider`

    **Backdrop:**
    - Semi-transparent overlay (dims grid background) per locked decision
    - Clicking backdrop closes the panel
    - Escape key closes the panel (HostListener for keydown.escape)

    **Update marketplace component:**
    - Add `selectedIntegration = signal<IntegrationViewModel | null>(null)` state
    - Add `activityLog = signal<IntegrationActivityLogEntry[]>([])` state
    - Replace the TODO in `onViewDetails()`:
      - Set `selectedIntegration` to the clicked integration
      - Call `integrationService.getActivityLog(integration.connection.id)` if connected, set activityLog on response
      - If not connected, set empty activityLog
    - Add `onClosePanel()` that sets `selectedIntegration` to null and clears activityLog
    - Wire panel outputs to existing connect/disconnect/test handlers
    - Add backdrop div and panel component to template, conditionally shown when `selectedIntegration()` is non-null

    **Update marketplace SCSS:**
    - Add backdrop styling (position fixed, inset 0, background rgba(0,0,0,0.3), z-index)
    - Responsive: on mobile (< 768px), panel takes full width
  </action>
  <verify>Run `cd C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/globcrm-web && npx ng build --configuration development 2>&1 | head -20` -- must compile.</verify>
  <done>Detail panel slides in from right when integration card is clicked. Panel shows description, connection status, masked credentials (never raw values), admin action buttons, and chronological activity log. Backdrop dims the grid and allows click-to-close. Panel is 480px wide with responsive full-width on mobile.</done>
</task>

<task type="auto">
  <name>Task 2: Add settings hub card, route registration, and Transloco i18n keys</name>
  <files>
    globcrm-web/src/app/features/settings/settings-hub.component.ts
    globcrm-web/src/app/features/settings/settings.routes.ts
    globcrm-web/src/assets/i18n/settings/en.json
    globcrm-web/src/assets/i18n/settings/tr.json
  </files>
  <action>
    **Update `settings.routes.ts`:**
    Add integrations route to the children array (no `adminGuard` -- non-admins can view per INTG-12):
    ```typescript
    {
      path: 'integrations',
      loadComponent: () =>
        import('./integrations/integration-marketplace.component').then(
          (m) => m.IntegrationMarketplaceComponent
        ),
    },
    ```

    **Update `settings-hub.component.ts`:**
    Add an "Integrations" card to the Organization section of the settings hub data model. Follow the existing pattern for card entries:
    - icon: `'hub'`
    - labelKey: `'settings.items.integrations'`
    - descriptionKey: `'settings.items.integrationsDesc'`
    - route: `'/settings/integrations'`
    - adminOnly: `false` (non-admins can view read-only per INTG-12)

    **Update `globcrm-web/src/assets/i18n/settings/en.json`:**
    Add integration marketplace translation keys under a new `integrations` section:
    ```json
    {
      "items": {
        "integrations": "Integrations",
        "integrationsDesc": "Browse and manage third-party integrations"
      },
      "integrations": {
        "title": "Integrations",
        "search": "Search integrations...",
        "categories": {
          "all": "All",
          "communication": "Communication",
          "accounting": "Accounting",
          "marketing": "Marketing",
          "storage": "Storage",
          "calendar": "Calendar",
          "developerTools": "Developer Tools"
        },
        "status": {
          "connected": "Connected",
          "notConnected": "Not Connected"
        },
        "popular": "Popular",
        "connect": "Connect",
        "disconnect": "Disconnect",
        "testConnection": "Test Connection",
        "viewDetails": "View Details",
        "connectDialog": {
          "title": "Connect {{name}}",
          "cancel": "Cancel",
          "connect": "Connect",
          "fieldRequired": "This field is required"
        },
        "disconnectDialog": {
          "title": "Disconnect {{name}}?",
          "message": "This will remove your stored credentials. You can reconnect later.",
          "cancel": "Cancel",
          "disconnect": "Disconnect"
        },
        "detail": {
          "description": "Description",
          "category": "Category",
          "connectionInfo": "Connection Info",
          "credentials": "Credentials",
          "connectedAt": "Connected at",
          "activityLog": "Activity Log",
          "noActivity": "No activity recorded yet",
          "testPassed": "Connection test passed",
          "testFailed": "Connection test failed"
        },
        "snackbar": {
          "connected": "Connected to {{name}}",
          "disconnected": "Disconnected from {{name}}",
          "testSuccess": "Connection test passed",
          "testFailed": "Connection test failed",
          "connectError": "Failed to connect to {{name}}"
        },
        "empty": "No integrations found"
      }
    }
    ```
    Merge these keys into the existing settings EN JSON (don't overwrite other keys).

    **Update `globcrm-web/src/assets/i18n/settings/tr.json`:**
    Add Turkish translations for all the same keys:
    - "Integrations" -> "Entegrasyonlar"
    - "Search integrations..." -> "Entegrasyon ara..."
    - "All" -> "Tumu"
    - "Communication" -> "Iletisim"
    - "Accounting" -> "Muhasebe"
    - "Marketing" -> "Pazarlama"
    - "Storage" -> "Depolama"
    - "Calendar" -> "Takvim"
    - "Developer Tools" -> "Gelistirici Araclari"
    - "Connected" -> "Bagli"
    - "Not Connected" -> "Bagli Degil"
    - "Popular" -> "Populer"
    - "Connect" -> "Baglan"
    - "Disconnect" -> "Baglantiyi Kes"
    - "Test Connection" -> "Baglanti Testi"
    - "View Details" -> "Detaylari Gor"
    - And all other keys with appropriate Turkish translations
    Use proper Turkish characters (ü, ö, ç, ş, ğ, ı, İ) throughout.

    **Update all marketplace components to use Transloco:**
    - Replace any hardcoded strings in templates with `{{ 'settings.integrations.xxx' | transloco }}` pipe
    - For dynamic strings (snackbar messages), use `TranslocoService.translate()` with interpolation params
    - Import `TranslocoPipe` in all component `imports` arrays
    - Import `TranslocoService` via `inject()` where programmatic translation needed (snackbar messages)
  </action>
  <verify>
    Run `cd C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/globcrm-web && npx ng build --configuration development 2>&1 | head -20` -- must compile.
    Verify EN and TR JSON files have matching key sets for the new integrations section.
  </verify>
  <done>Settings hub has Integrations card visible to all users. Route `/settings/integrations` loads the marketplace component. All UI strings use Transloco translation keys with EN and TR translations. Integration marketplace is fully discoverable and localized.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete integration marketplace</name>
  <what-built>Complete integration marketplace with card grid, category filter, search, connect/disconnect dialogs, detail panel with activity log, settings hub entry, and i18n support.</what-built>
  <how-to-verify>
    1. Start backend: `cd src/GlobCRM.Api && dotnet run`
    2. Start frontend: `cd globcrm-web && npm start`
    3. Log in as Admin user at http://localhost:4200
    4. Navigate to Settings -- verify "Integrations" card appears in the hub
    5. Click Integrations card -- verify marketplace page loads with 12 integration cards in responsive grid
    6. Verify Popular badges on: Slack, Gmail, WhatsApp, Mailchimp, Google Calendar
    7. Test category filter: click "Communication" chip -- should show 5 integrations
    8. Test search: type "Slack" -- should filter to just Slack
    9. Click "Connect" on Slack card -- verify dialog opens with "Bot Token" field
    10. Enter any value and click Connect -- verify card updates to show "Connected" with green left border
    11. Click the connected Slack card to open detail panel -- verify panel slides in from right with:
        - Description, status, masked credential (........XXXX format), activity log showing "Connected" event
    12. Click "Test Connection" in detail panel -- verify success message appears inline
    13. Click "Disconnect" -- verify confirmation dialog, then card returns to disconnected state
    14. Switch language to Turkish -- verify all strings translate
    15. Log in as non-admin Member user -- verify cards are visible but no Connect/Disconnect/Test buttons
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Settings hub shows Integrations card
- Route `/settings/integrations` loads marketplace
- Detail panel opens on card click with masked credentials and activity log
- All strings use Transloco keys
- EN and TR JSON files have matching key sets for integrations section
- Non-admin users see read-only view
</verification>

<success_criteria>
Complete integration marketplace feature: settings hub entry, route, card grid with search/filter, connect/disconnect dialogs, detail panel with masked credentials and activity log, RBAC enforcement (admin-only actions), and full EN/TR i18n coverage. User verified via checkpoint.
</success_criteria>

<output>
After completion, create `.planning/phases/29-integration-marketplace/29-05-SUMMARY.md`
</output>
