---
phase: 29-integration-marketplace
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/GlobCRM.Api/Controllers/IntegrationsController.cs
autonomous: true
requirements:
  - INTG-04
  - INTG-05
  - INTG-06
  - INTG-07
  - INTG-09
  - INTG-10

must_haves:
  truths:
    - "API returns list of tenant integrations with masked credentials (never raw encrypted values)"
    - "Admin can connect an integration via POST with credentials that get encrypted and stored"
    - "Admin can disconnect an integration which clears credentials and logs the event"
    - "Admin can test a connection which decrypts credentials and simulates validation"
    - "Activity log endpoint returns chronological events for an integration"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/IntegrationsController.cs"
      provides: "All 5 API endpoints: list, connect, disconnect, test, activity log"
      contains: "class IntegrationsController"
  key_links:
    - from: "IntegrationsController"
      to: "CredentialEncryptionService"
      via: "DI injection for encrypt/decrypt"
      pattern: "CredentialEncryptionService"
    - from: "IntegrationsController"
      to: "IIntegrationRepository"
      via: "DI injection for data access"
      pattern: "IIntegrationRepository"
    - from: "IntegrationsController DTOs"
      to: "Integration entity"
      via: "FromEntity factory method excludes EncryptedCredentials"
      pattern: "FromEntity.*CredentialMask"
---

<objective>
Create the IntegrationsController with all API endpoints for the integration marketplace: list connections, connect, disconnect, test, and activity log.

Purpose: The frontend needs these endpoints to manage integration lifecycle. Security-critical: credentials must be encrypted on write and never returned in plaintext -- only masked values exposed via DTOs.
Output: Complete IntegrationsController with 5 endpoints, DTOs with static FromEntity factories, and FluentValidation validators.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-integration-marketplace/29-RESEARCH.md
@.planning/phases/29-integration-marketplace/29-01-SUMMARY.md

@src/GlobCRM.Api/Controllers/WebhooksController.cs (controller + DTO + MaskSecret pattern)
@src/GlobCRM.Domain/Entities/Integration.cs
@src/GlobCRM.Domain/Entities/IntegrationActivityLog.cs
@src/GlobCRM.Infrastructure/Services/CredentialEncryptionService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IntegrationsController with all endpoints, DTOs, and validators</name>
  <files>
    src/GlobCRM.Api/Controllers/IntegrationsController.cs
  </files>
  <action>
    Create `IntegrationsController` following the project pattern (DTOs, request records, and validators co-located in the same controller file).

    **DTOs (inside the controller file):**

    `IntegrationDto`:
    - `Id` (Guid)
    - `IntegrationKey` (string)
    - `Status` (string -- "Connected" or "Disconnected")
    - `CredentialMask` (string?) -- masked value like "........a1b2", NEVER the encrypted value
    - `ConnectedByUserId` (Guid?)
    - `ConnectedAt` (DateTimeOffset?)
    - `DisconnectedAt` (DateTimeOffset?)
    - Static `FromEntity(Integration entity)` factory -- explicitly maps only safe fields, EXCLUDES `EncryptedCredentials`

    `IntegrationActivityLogDto`:
    - `Id` (Guid)
    - `Action` (string)
    - `PerformedByUserName` (string)
    - `Details` (string?)
    - `CreatedAt` (DateTimeOffset)
    - Static `FromEntity(IntegrationActivityLog log)` factory

    **Request records:**

    `ConnectIntegrationRequest`:
    - `IntegrationKey` (string) -- the catalog slug like "slack"
    - `Credentials` (Dictionary<string, string>) -- key/value pairs like { "apiKey": "xoxb-...", "webhookUrl": "https://..." }

    `ConnectIntegrationValidator` (FluentValidation):
    - `IntegrationKey` must not be empty, max 50 chars
    - `Credentials` must not be empty (at least one entry)

    **Endpoints:**

    1. `GET /api/integrations` -- `[Authorize]` (any authenticated user)
       - Returns `List<IntegrationDto>` for current tenant
       - Uses `IIntegrationRepository.GetAllAsync()`
       - Maps via `IntegrationDto.FromEntity()`

    2. `POST /api/integrations/connect` -- `[Authorize(Roles = "Admin")]`
       - Accepts `ConnectIntegrationRequest`
       - Validates with `new ConnectIntegrationValidator()`
       - Checks if already connected by key (return 409 Conflict if so)
       - Serializes `Credentials` dictionary to JSON string
       - Encrypts via `CredentialEncryptionService.Encrypt(jsonString)`
       - Extracts mask: last 4 chars of the first credential value, prefixed with "........"
       - Creates `Integration` entity with Status = Connected, stores encrypted blob + mask
       - Creates `IntegrationActivityLog` with Action = Connected
       - Returns 201 with `IntegrationDto`

    3. `POST /api/integrations/{id}/disconnect` -- `[Authorize(Roles = "Admin")]`
       - Finds integration by ID (404 if not found)
       - Sets Status = Disconnected
       - Clears `EncryptedCredentials` (set to null)
       - Clears `CredentialMask` (set to null)
       - Sets `DisconnectedAt` to current time
       - Creates `IntegrationActivityLog` with Action = Disconnected
       - Returns 200 with updated `IntegrationDto`

    4. `POST /api/integrations/{id}/test` -- `[Authorize(Roles = "Admin")]`
       - Finds integration by ID (404 if not found)
       - Returns 400 if Status is not Connected
       - Decrypts credentials via `CredentialEncryptionService.Decrypt()`
       - **Simulates test**: For v1.3, always return success (add TODO comment for real API validation)
       - Creates `IntegrationActivityLog` with Action = TestSuccess and Details = "Connection test passed (simulated)"
       - Returns 200 with `{ success: true, message: "Connection test passed" }`

    5. `GET /api/integrations/{id}/activity` -- `[Authorize]` (any authenticated user)
       - Returns `List<IntegrationActivityLogDto>` for the integration
       - Uses `IIntegrationRepository.GetActivityLogsAsync(id, 50)`
       - Maps via `IntegrationActivityLogDto.FromEntity()`

    **DI injection in constructor:**
    - `IIntegrationRepository`
    - `CredentialEncryptionService`
    - `IHttpContextAccessor` (to get current user ID/name for activity logs)

    **Security pattern:** The `MaskCredential` private method takes the raw credentials dictionary, picks the first value, and returns `"........" + value[^4..]` (last 4 chars). If value is shorter than 4 chars, return `"........****"`. Same logic as `WebhooksController.MaskSecret()` but adapted for credentials dictionary.

    **User identification:** Extract user ID from `HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)` and user name from claims (same pattern as other controllers).
  </action>
  <verify>
    Run `dotnet build C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/GlobCRM.slnx` -- must compile cleanly.
    Manually verify the DTO `FromEntity` method does NOT map `EncryptedCredentials` field (security critical).
  </verify>
  <done>
    IntegrationsController exists with 5 endpoints. GET /api/integrations returns masked data only. POST connect encrypts credentials before storage. POST disconnect clears credentials. POST test decrypts and simulates validation. GET activity returns chronological events. All endpoints use proper authorization (Admin for mutations, any auth user for reads). Solution builds.
  </done>
</task>

</tasks>

<verification>
- `dotnet build GlobCRM.slnx` passes
- IntegrationsController has 5 endpoints with correct HTTP methods and routes
- IntegrationDto.FromEntity() excludes EncryptedCredentials (grep for "EncryptedCredentials" in DTO mapping -- should not appear)
- Admin-only endpoints use `[Authorize(Roles = "Admin")]`
- Read endpoints use `[Authorize]` (no role restriction)
- ConnectIntegrationValidator validates required fields
</verification>

<success_criteria>
Complete API layer for integration marketplace: 5 endpoints (list, connect, disconnect, test, activity), DTOs with masked credentials, FluentValidation, proper authorization. Security verified: encrypted credentials never exposed in API responses.
</success_criteria>

<output>
After completion, create `.planning/phases/29-integration-marketplace/29-02-SUMMARY.md`
</output>
