---
phase: 29-integration-marketplace
plan: 04
type: execute
wave: 3
depends_on: ["29-02", "29-03"]
files_modified:
  - globcrm-web/src/app/features/settings/integrations/integration.service.ts
  - globcrm-web/src/app/features/settings/integrations/integration.store.ts
  - globcrm-web/src/app/features/settings/integrations/integration-connect-dialog.component.ts
  - globcrm-web/src/app/features/settings/integrations/integration-disconnect-dialog.component.ts
  - globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
autonomous: true
requirements:
  - INTG-04
  - INTG-05
  - INTG-09
  - INTG-12

must_haves:
  truths:
    - "Admin can click Connect on a card and enter dynamic credential fields in a dialog"
    - "After connecting, the card updates to show Connected status with green border accent"
    - "Admin can disconnect an integration via confirmation dialog"
    - "Admin can test a connection and see success/failure result"
    - "Non-admin users see read-only status (no Connect/Disconnect/Test buttons)"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/integrations/integration.service.ts"
      provides: "API service with connect, disconnect, test, list, activity log methods"
      contains: "IntegrationService"
    - path: "globcrm-web/src/app/features/settings/integrations/integration.store.ts"
      provides: "SignalStore managing integration connections state"
      contains: "IntegrationStore"
    - path: "globcrm-web/src/app/features/settings/integrations/integration-connect-dialog.component.ts"
      provides: "MatDialog with dynamic credential form fields"
      contains: "IntegrationConnectDialogComponent"
    - path: "globcrm-web/src/app/features/settings/integrations/integration-disconnect-dialog.component.ts"
      provides: "Confirmation dialog for disconnect"
      contains: "IntegrationDisconnectDialogComponent"
  key_links:
    - from: "integration.service.ts"
      to: "/api/integrations"
      via: "ApiService HTTP calls"
      pattern: "api/integrations"
    - from: "integration.store.ts"
      to: "integration.service.ts"
      via: "inject(IntegrationService) in withMethods"
      pattern: "inject.*IntegrationService"
    - from: "integration-marketplace.component.ts"
      to: "integration.store.ts"
      via: "inject(IntegrationStore) and connects to connections signal"
      pattern: "inject.*IntegrationStore"
    - from: "integration-connect-dialog.component.ts"
      to: "CredentialFieldDef"
      via: "MAT_DIALOG_DATA with catalog item credential fields"
      pattern: "credentialFields"
---

<objective>
Wire the frontend marketplace to the backend API: create IntegrationService, IntegrationStore (signalStore), connect dialog with dynamic credential fields, and disconnect confirmation dialog. Update the marketplace component to use the store.

Purpose: This plan brings the marketplace to life by connecting the static catalog grid (Plan 03) to the live backend API (Plan 02). Users can now actually connect, disconnect, and test integrations.
Output: Working connect/disconnect flow with dynamic credential dialogs, store-managed state, and RBAC-based visibility.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-integration-marketplace/29-RESEARCH.md
@.planning/phases/29-integration-marketplace/29-02-SUMMARY.md
@.planning/phases/29-integration-marketplace/29-03-SUMMARY.md

@globcrm-web/src/app/features/settings/webhooks/webhook.service.ts (API service pattern)
@globcrm-web/src/app/features/settings/webhooks/webhook.store.ts (signalStore pattern)
@globcrm-web/src/app/features/settings/integrations/integration.models.ts
@globcrm-web/src/app/features/settings/integrations/integration-catalog.ts
@globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IntegrationService, IntegrationStore, and connect/disconnect dialogs</name>
  <files>
    globcrm-web/src/app/features/settings/integrations/integration.service.ts
    globcrm-web/src/app/features/settings/integrations/integration.store.ts
    globcrm-web/src/app/features/settings/integrations/integration-connect-dialog.component.ts
    globcrm-web/src/app/features/settings/integrations/integration-disconnect-dialog.component.ts
  </files>
  <action>
    Create `IntegrationService` (injectable, following webhook.service.ts pattern):
    - Inject `ApiService` (from core/api/)
    - Methods:
      - `getConnections(): Observable<IntegrationConnection[]>` -- GET `/api/integrations`
      - `connect(integrationKey: string, credentials: Record<string, string>): Observable<IntegrationConnection>` -- POST `/api/integrations/connect` with body `{ integrationKey, credentials }`
      - `disconnect(id: string): Observable<IntegrationConnection>` -- POST `/api/integrations/{id}/disconnect`
      - `testConnection(id: string): Observable<{ success: boolean; message: string }>` -- POST `/api/integrations/{id}/test`
      - `getActivityLog(id: string): Observable<IntegrationActivityLogEntry[]>` -- GET `/api/integrations/{id}/activity`

    Create `IntegrationStore` using `signalStore` pattern (following webhook.store.ts):
    - State: `{ connections: IntegrationConnection[], loading: boolean, error: string | null }`
    - `withMethods`:
      - `const svc = inject(IntegrationService);`
      - `loadConnections()`: calls `svc.getConnections()`, patches state with results
      - `connectIntegration(integrationKey: string, credentials: Record<string, string>)`: calls `svc.connect()`, on success adds to connections array, returns observable
      - `disconnectIntegration(id: string)`: calls `svc.disconnect()`, updates connection in array
      - `testConnection(id: string)`: calls `svc.testConnection()`, returns observable with result
    - NOT `providedIn: 'root'` -- this is a per-page store, provided in the marketplace component's `providers` array

    Create `IntegrationConnectDialogComponent` (standalone, MatDialog):
    - Dialog data (via `MAT_DIALOG_DATA`): `{ catalogItem: IntegrationCatalogItem }`
    - Template:
      - Dialog title: "Connect {integrationName}" with brand icon
      - Reactive form built dynamically from `catalogItem.credentialFields`:
        - For each `CredentialFieldDef`, add a `FormControl` with `Validators.required` if field.required
        - Input type matches `field.type` ('password' for secrets, 'text' for URLs)
        - Placeholder from `field.placeholder`
        - Validation error message for required fields
      - Cancel button (mat-dialog-close)
      - Connect button (mat-raised-button, primary) -- disabled until form valid
      - On submit: close dialog with `{ credentials: formValues }` result
    - No direct API call -- the marketplace component handles the API call after dialog closes

    Create `IntegrationDisconnectDialogComponent` (standalone, MatDialog):
    - Dialog data: `{ integrationName: string }`
    - Simple confirmation dialog:
      - Title: "Disconnect {integrationName}?"
      - Body: "This will remove your stored credentials. You can reconnect later."
      - Cancel button (mat-dialog-close with false)
      - Disconnect button (mat-raised-button, warn color, closes with true)
  </action>
  <verify>Run `cd C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/globcrm-web && npx ng build --configuration development 2>&1 | head -20` -- must compile.</verify>
  <done>IntegrationService provides all 5 API methods. IntegrationStore manages connection state with load/connect/disconnect/test methods. IntegrationConnectDialogComponent renders dynamic credential fields from catalog definition. IntegrationDisconnectDialogComponent provides disconnect confirmation. All compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire marketplace component to store and dialogs with RBAC</name>
  <files>
    globcrm-web/src/app/features/settings/integrations/integration-marketplace.component.ts
  </files>
  <action>
    Update `IntegrationMarketplaceComponent` to use the store and dialogs:

    **Providers:** Add `IntegrationStore` to component's `providers: []` array (per-page store pattern).

    **Injections:**
    - `IntegrationStore` (via `inject()`)
    - `MatDialog` (via `inject()`)
    - `AuthStore` (already injected for admin check)

    **Lifecycle:**
    - In constructor or `ngOnInit`, call `this.integrationStore.loadConnections()` to fetch existing connections from API

    **Update computed signals:**
    - Replace the static empty `connections` signal with `this.integrationStore.connections`
    - The `integrations` computed signal now merges INTEGRATION_CATALOG with live connection data from store

    **Event handlers (called from card component outputs):**

    `onConnect(catalogItem: IntegrationCatalogItem)`:
    - Open `IntegrationConnectDialogComponent` via `MatDialog.open()` with `{ data: { catalogItem } }`
    - On dialog close with result (not cancelled):
      - Call `this.integrationStore.connectIntegration(catalogItem.key, result.credentials)`
      - On success: show snackbar "Connected to {name}" (use MatSnackBar)
      - On error: show snackbar with error message

    `onDisconnect(integration: IntegrationViewModel)`:
    - Open `IntegrationDisconnectDialogComponent` with `{ data: { integrationName: integration.catalog.name } }`
    - On dialog close with `true`:
      - Call `this.integrationStore.disconnectIntegration(integration.connection!.id)`
      - On success: show snackbar "Disconnected from {name}"

    `onTestConnection(integration: IntegrationViewModel)`:
    - Call `this.integrationStore.testConnection(integration.connection!.id)`
    - On success: show snackbar "Connection test passed" (success)
    - On failure: show snackbar "Connection test failed" (error)

    `onViewDetails(integration: IntegrationViewModel)`:
    - For now, just log to console -- the detail panel will be wired in Plan 05
    - Add a TODO comment: `// Plan 05 will open detail panel here`

    **Update card component:**
    - Add `disconnect` and `testConnection` output events to IntegrationCardComponent
    - For connected cards (admin only): show a small mat-icon-button menu (three dots) with "Test Connection" and "Disconnect" options
    - Non-admin users: no action buttons at all (per INTG-12 locked decision)

    **RBAC enforcement:**
    - `isAdmin` computed signal controls visibility of Connect button on cards, disconnect menu, and test option
    - Non-admins see the grid with status badges but no action buttons
  </action>
  <verify>
    Run `cd C:/Users/maliy/Documents/MetaTech/Projects/GlobCRM-New/globcrm-web && npx ng build --configuration development 2>&1 | head -20` -- must compile.
  </verify>
  <done>Marketplace component loads connections from API on init, merges with catalog for display. Connect button opens dialog with dynamic credential fields, submits to API. Disconnect opens confirmation dialog, calls API on confirm. Test connection calls API and shows result via snackbar. Non-admin users see read-only status only. All state managed through IntegrationStore.</done>
</task>

</tasks>

<verification>
- `ng build --configuration development` compiles without errors
- IntegrationService has methods for all 5 API endpoints
- IntegrationStore manages state with patchState pattern
- Connect dialog dynamically renders credential fields from catalog definition
- Disconnect dialog shows confirmation with integration name
- Marketplace component wires store, loads on init, handles connect/disconnect/test events
- Non-admin users cannot see Connect/Disconnect/Test buttons (RBAC check)
</verification>

<success_criteria>
Full connect/disconnect/test lifecycle working through frontend. Admin clicks Connect on a card, enters credentials in dynamic dialog, card updates to Connected state with green border. Admin can disconnect with confirmation. Admin can test connection. Non-admin sees read-only status. All state flows through IntegrationStore backed by IntegrationService API calls.
</success_criteria>

<output>
After completion, create `.planning/phases/29-integration-marketplace/29-04-SUMMARY.md`
</output>
