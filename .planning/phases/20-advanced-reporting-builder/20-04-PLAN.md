---
phase: 20-advanced-reporting-builder
plan: 04
type: execute
wave: 4
depends_on: [20-03]
files_modified:
  - globcrm-web/src/app/features/reports/report.models.ts
  - globcrm-web/src/app/features/reports/report.service.ts
  - globcrm-web/src/app/features/reports/report.store.ts
  - globcrm-web/src/app/features/reports/reports.routes.ts
  - globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.ts
  - globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html
  - globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.scss
  - globcrm-web/src/app/features/reports/report-gallery/report-card.component.ts
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
autonomous: true
requirements: [RPT-04, RPT-05]

must_haves:
  truths:
    - "Report gallery shows card grid with mini chart SVG thumbnails, entity type badge, and last-run date"
    - "Gallery supports category filtering and search"
    - "ReportStore manages gallery state and report execution state"
    - "Lazy-loaded routes for gallery and builder pages are wired"
    - "Navigation link appears in sidebar under Analytics group"
  artifacts:
    - path: "globcrm-web/src/app/features/reports/report.models.ts"
      provides: "TypeScript interfaces for all report entities"
      contains: "interface Report"
    - path: "globcrm-web/src/app/features/reports/report.service.ts"
      provides: "API service with methods for report CRUD, execution, field metadata, export"
      contains: "class ReportService"
    - path: "globcrm-web/src/app/features/reports/report.store.ts"
      provides: "NgRx Signal Store for report state management"
      contains: "ReportStore"
    - path: "globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.ts"
      provides: "Card grid gallery page for browsing saved reports"
      contains: "class ReportGalleryComponent"
  key_links:
    - from: "globcrm-web/src/app/features/reports/report.service.ts"
      to: "ReportsController API"
      via: "HTTP calls via ApiService"
      pattern: "api/reports"
    - from: "globcrm-web/src/app/app.routes.ts"
      to: "globcrm-web/src/app/features/reports/reports.routes.ts"
      via: "Lazy-loaded feature route"
      pattern: "loadChildren.*reports"
---

<objective>
Create the Angular frontend foundation for the reports feature: TypeScript models, API service, NgRx Signal Store, lazy-loaded routes, report gallery page with card grid and SVG chart thumbnails, builder shell component, and sidebar navigation.

Purpose: Establish the frontend plumbing and the gallery landing page so users can browse, search, and navigate to saved reports.
Output: Complete report feature module structure with gallery page, service layer, and routes.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-RESEARCH.md
@.planning/phases/20-advanced-reporting-builder/20-03-SUMMARY.md

# Patterns to follow:
@globcrm-web/src/app/features/workflows/workflow.models.ts
@globcrm-web/src/app/features/workflows/workflow.service.ts
@globcrm-web/src/app/features/workflows/workflow.store.ts
@globcrm-web/src/app/features/workflows/workflows.routes.ts
@globcrm-web/src/app/features/workflows/workflow-list/workflow-list.component.ts
@globcrm-web/src/app/features/workflows/workflow-list/workflow-card.component.ts
@globcrm-web/src/app/app.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript models, API service, signal store, routes, and navigation</name>
  <files>
    globcrm-web/src/app/features/reports/report.models.ts
    globcrm-web/src/app/features/reports/report.service.ts
    globcrm-web/src/app/features/reports/report.store.ts
    globcrm-web/src/app/features/reports/reports.routes.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
    **report.models.ts** — TypeScript interfaces matching the backend DTOs:

    ```typescript
    // Core entities
    export interface Report { id: string; name: string; description?: string; entityType: string; chartType: ReportChartType; categoryId?: string; categoryName?: string; definition: ReportDefinition; ownerId?: string; ownerName?: string; isShared: boolean; isSeedData: boolean; lastRunAt?: string; lastRunRowCount?: number; createdAt: string; updatedAt: string; }
    export interface ReportListItem { id: string; name: string; description?: string; entityType: string; chartType: ReportChartType; categoryName?: string; ownerName?: string; isShared: boolean; isSeedData: boolean; lastRunAt?: string; lastRunRowCount?: number; }
    export interface ReportCategory { id: string; name: string; description?: string; sortOrder: number; }

    // Definition types
    export interface ReportDefinition { fields: ReportField[]; filterGroup?: ReportFilterGroup; groupings: ReportGrouping[]; chartConfig?: ReportChartConfig; }
    export interface ReportField { fieldId: string; label: string; fieldType: string; aggregation?: AggregationType; sortOrder: number; }
    export interface ReportFilterGroup { logic: FilterLogic; conditions: ReportFilterCondition[]; groups: ReportFilterGroup[]; }
    export interface ReportFilterCondition { fieldId: string; operator: string; value?: string; valueTo?: string; }
    export interface ReportGrouping { fieldId: string; dateTruncation?: string; }
    export interface ReportChartConfig { chartType: ReportChartType; colorScheme?: string; showLegend: boolean; showDataLabels: boolean; }

    // Enums
    export type ReportChartType = 'table' | 'bar' | 'line' | 'pie' | 'funnel';
    export type AggregationType = 'count' | 'sum' | 'average' | 'min' | 'max';
    export type FilterLogic = 'and' | 'or';

    // Field metadata
    export interface ReportFieldMetadata { systemFields: ReportFieldInfo[]; customFields: ReportFieldInfo[]; formulaFields: ReportFieldInfo[]; relatedFields: ReportFieldInfo[]; }
    export interface ReportFieldInfo { fieldId: string; label: string; category: string; dataType: string; isAggregatable: boolean; isGroupable: boolean; relatedEntity?: string; relatedField?: string; }

    // Execution results
    export interface ReportExecutionResult { rows: Record<string, any>[]; totalCount: number; aggregates?: ReportAggregateResult[]; columnHeaders: string[]; }
    export interface ReportAggregateResult { fieldId: string; label: string; aggregation: AggregationType; value: any; }

    // Request types
    export interface CreateReportRequest { name: string; description?: string; entityType: string; chartType: ReportChartType; categoryId?: string; definition: ReportDefinition; }
    export interface UpdateReportRequest { name: string; description?: string; chartType: ReportChartType; categoryId?: string; definition: ReportDefinition; }
    export interface ExecuteReportRequest { page?: number; pageSize?: number; drillDownFilter?: ReportFilterCondition; }

    // Paginated response
    export interface PagedReportResponse { items: ReportListItem[]; totalCount: number; }
    ```

    **report.service.ts** — API service following WorkflowService pattern:
    - Inject ApiService
    - Methods matching all 14 controller endpoints:
      - `getReports(params?: { categoryId?, entityType?, search?, page?, pageSize? })` -> `Observable<PagedReportResponse>`
      - `getReport(id: string)` -> `Observable<Report>`
      - `createReport(request: CreateReportRequest)` -> `Observable<Report>`
      - `updateReport(id: string, request: UpdateReportRequest)` -> `Observable<Report>`
      - `deleteReport(id: string)` -> `Observable<void>`
      - `executeReport(id: string, request?: ExecuteReportRequest)` -> `Observable<ReportExecutionResult>`
      - `getFieldMetadata(entityType: string)` -> `Observable<ReportFieldMetadata>`
      - `toggleShare(id: string, isShared: boolean)` -> `Observable<void>`
      - `cloneReport(id: string, name: string)` -> `Observable<Report>`
      - `exportCsv(id: string)` -> `Observable<{ jobId: string }>`
      - `getCategories()` -> `Observable<ReportCategory[]>`
      - `createCategory(name: string, description?: string)` -> `Observable<ReportCategory>`
      - `updateCategory(id: string, name: string, description?: string)` -> `Observable<ReportCategory>`
      - `deleteCategory(id: string)` -> `Observable<void>`

    **report.store.ts** — NgRx Signal Store (component-provided, NOT root) following WorkflowStore pattern:
    ```typescript
    export const ReportStore = signalStore(
      withState({
        reports: [] as ReportListItem[],
        categories: [] as ReportCategory[],
        selectedReport: null as Report | null,
        executionResult: null as ReportExecutionResult | null,
        fieldMetadata: null as ReportFieldMetadata | null,
        loading: false,
        executing: false,
        exporting: false,
        error: null as string | null,
        totalCount: 0,
        currentPage: 1,
        selectedCategory: null as string | null,
        selectedEntityType: null as string | null,
        searchQuery: '',
      }),
      withMethods((store) => {
        const service = inject(ReportService);
        return {
          loadReports, loadReport, createReport, updateReport, deleteReport,
          executeReport, loadFieldMetadata, toggleShare, cloneReport, exportCsv,
          loadCategories, setFilter (category/entityType/search)
        };
      })
    );
    ```

    **reports.routes.ts** — Lazy-loaded routes:
    - `''` -> ReportGalleryComponent (list page)
    - `'new'` -> ReportBuilderComponent (create mode)
    - `':id'` -> ReportBuilderComponent (view/edit mode, loads report by id)
    - `':id/edit'` -> ReportBuilderComponent (edit mode)

    **app.routes.ts** — Add reports route:
    ```typescript
    { path: 'reports', loadChildren: () => import('./features/reports/reports.routes').then(m => m.REPORT_ROUTES), canActivate: [permissionGuard('Report', 'View')] }
    ```

    **navbar.component.ts** — Add "Reports" navigation link with `bar_chart` Material icon in the Analytics group (near Dashboard). Text: "Reports", route: "/reports".
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>TypeScript models cover all report entities and DTOs. ReportService has 14 API methods. ReportStore manages gallery and execution state. Routes lazy-loaded with permission guard. Navigation link added.</done>
</task>

<task type="auto">
  <name>Task 2: Report gallery page with card grid, category filtering, and builder shell component</name>
  <files>
    globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.ts
    globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html
    globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.scss
    globcrm-web/src/app/features/reports/report-gallery/report-card.component.ts
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
  </files>
  <action>
    **ReportGalleryComponent** — Gallery page following WorkflowListComponent pattern:
    - `providers: [ReportStore]` (component-provided)
    - OnInit: load categories, load reports
    - Template layout:
      - Header row: "Reports" title + "New Report" button (primary, navigates to /reports/new)
      - Filter bar: Category dropdown (mat-select with "All Categories" default), Entity Type dropdown (mat-select), Search input (mat-form-field with search icon)
      - Card grid: CSS Grid responsive layout (1 col mobile, 2 cols md, 3 cols lg)
      - Each card: `<app-report-card>` with click handler navigating to /reports/{id}
      - Loading skeleton: 6 pulsing placeholder cards
      - Empty state: illustration placeholder, "No reports found" message, "Create your first report" button
    - Computed signal for filtered reports (client-side category/entity type filtering after API load)

    **ReportCardComponent** — Individual card following WorkflowCardComponent pattern:
    - Input: `report = input.required<ReportListItem>()`
    - Output: `viewReport = output<void>()`
    - Template:
      - **Mini chart thumbnail area** (top ~120px): Render SVG schematic thumbnails based on chartType (NOT real chart.js canvas — per research recommendation). Use colored SVG shapes:
        - Bar: 4-5 vertical bars of varying height in primary orange gradient
        - Line: Smooth SVG path line with area fill in orange gradient
        - Pie: SVG circle with 3-4 colored arc segments
        - Funnel: Trapezoid shapes narrowing downward in orange gradient
        - Table: SVG grid lines suggesting a data table
      - **Info area** (bottom):
        - Report name (h3, truncated with ellipsis)
        - Meta row: Entity type chip (small mat-chip with entity icon), Chart type badge
        - Last run text: "Last run {relativeTime}" or "Never run" (use a computed signal with relative date formatting)
        - Shared badge: mat-icon "people" if isShared, "person" if personal
        - Seed badge: "Starter" chip if isSeedData
    - Card hover: subtle shadow elevation and border color change
    - Styling: `.report-card` with border-radius, shadow, overflow hidden. Thumbnail area has light gray background.
    - **Per user decision:** Card grid consistent with workflow/template card grids.

    **ReportBuilderComponent** — Shell/placeholder for Plans 05 and 06:
    - Create a basic component with the two-panel layout structure:
      - Left sidebar (320px) with placeholder "Configuration panels will go here"
      - Right preview area with placeholder "Report results will appear here"
    - Route param `id` input binding via `id = input<string>()`
    - OnInit: if id exists, load report from store
    - This shell will be expanded by Plans 05 (sidebar panels) and 06 (viewer components)

    **Styles** — Use consistent card grid from `_entity-list.scss` pattern where applicable. Report gallery uses its own SCSS for the card grid since it's not a DynamicTable page.
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>Report gallery shows responsive card grid with SVG chart thumbnails, entity type badges, category/entity type filtering, search, and navigation to report builder. Builder shell has two-panel layout ready for sidebar and viewer components.</done>
</task>

</tasks>

<verification>
- Angular build passes with 0 errors
- /reports route loads the gallery component
- /reports/new and /reports/:id load the builder component
- Navigation link visible in sidebar
- Card grid is responsive (1/2/3 columns)
</verification>

<success_criteria>
Users can browse the report gallery with visually rich cards showing chart type thumbnails, filter by category and entity type, search by name, and navigate to the report builder. The frontend foundation (models, service, store, routes) is ready for builder and viewer components.
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-04-SUMMARY.md`
</output>
