---
phase: 20-advanced-reporting-builder
plan: 03
type: execute
wave: 3
depends_on: [20-01, 20-02]
files_modified:
  - src/GlobCRM.Api/Controllers/ReportsController.cs
  - src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - src/GlobCRM.Api/Program.cs
autonomous: true
requirements: [RPT-02, RPT-03, RPT-05, RPT-06, RPT-07]

must_haves:
  truths:
    - "ReportsController exposes CRUD endpoints for reports and categories"
    - "ReportsController has an execute endpoint that runs the report and returns paginated results"
    - "ReportsController has a field-metadata endpoint returning available fields per entity type"
    - "CSV export triggers a Hangfire background job and returns a job ID"
    - "Reports can be shared (IsShared toggle) and cloned"
    - "6 seed starter reports are created per tenant via TenantSeeder"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/ReportsController.cs"
      provides: "REST API for report CRUD, execution, field metadata, sharing, cloning, and CSV export"
      contains: "class ReportsController"
    - path: "src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs"
      provides: "Hangfire background job for full-dataset CSV generation and file storage"
      contains: "class ReportCsvExportJob"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/ReportsController.cs"
      to: "src/GlobCRM.Infrastructure/Reporting/ReportQueryEngine.cs"
      via: "Service injection for report execution"
      pattern: "ReportQueryEngine"
    - from: "src/GlobCRM.Api/Controllers/ReportsController.cs"
      to: "src/GlobCRM.Infrastructure/Reporting/ReportFieldMetadataService.cs"
      via: "Service injection for field discovery"
      pattern: "ReportFieldMetadataService"
    - from: "src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs"
      to: "src/GlobCRM.Infrastructure/Reporting/ReportQueryEngine.cs"
      via: "Query engine for full dataset extraction"
      pattern: "ReportQueryEngine"
---

<objective>
Build the ReportsController with all REST endpoints (CRUD, execute, field metadata, share, clone, CSV export), the ReportCsvExportJob Hangfire background job, and seed 6 starter reports in TenantSeeder.

Purpose: Expose the report engine to the frontend via REST API, enable background CSV export for large datasets, and seed demo reports for the gallery.
Output: ReportsController.cs, ReportCsvExportJob.cs, TenantSeeder updates.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-RESEARCH.md
@.planning/phases/20-advanced-reporting-builder/20-01-SUMMARY.md
@.planning/phases/20-advanced-reporting-builder/20-02-SUMMARY.md

# Patterns to follow:
@src/GlobCRM.Api/Controllers/WorkflowsController.cs
@src/GlobCRM.Infrastructure/BackgroundJobs/TenantScope.cs
@src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReportsController with CRUD, execute, field metadata, share, clone, and CSV export endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/ReportsController.cs
    src/GlobCRM.Api/Program.cs
  </files>
  <action>
    Create `ReportsController` at `src/GlobCRM.Api/Controllers/ReportsController.cs` following the WorkflowsController pattern. DTOs, request records, and validators co-located in the same file.

    **Inject:** IReportRepository, ReportQueryEngine, ReportFieldMetadataService, IPermissionService, IBackgroundJobClient (Hangfire), ITenantProvider.

    **Endpoints (all under [Route("api/reports")]):**

    1. `GET /api/reports` — List reports with optional filters (categoryId, entityType, search). Include shared reports and seed data. Paginated. Returns `PagedResponse<ReportListDto>`.

    2. `GET /api/reports/{id}` — Get single report with full definition. Returns `ReportDto`.

    3. `POST /api/reports` — Create report. Accepts `CreateReportRequest` { Name, Description?, EntityType, CategoryId?, ChartType, Definition }. Sets OwnerId to current user. Validates name required, entity type valid. Returns 201 with `ReportDto`.

    4. `PUT /api/reports/{id}` — Update report. Only owner or admin can update. Accepts `UpdateReportRequest` { Name, Description?, CategoryId?, ChartType, Definition }. Returns `ReportDto`.

    5. `DELETE /api/reports/{id}` — Delete report. Only owner or admin can delete. Cannot delete seed data. Returns 204.

    6. `POST /api/reports/{id}/execute` — Execute report. Accepts `ExecuteReportRequest` { Page?, PageSize? (default 50), DrillDownFilter? }. Resolves user's permission scope for the report's entity type. Calls ReportQueryEngine.ExecuteReportAsync(). Updates report.LastRunAt and LastRunRowCount. Returns `ReportExecutionResultDto`.

    7. `GET /api/reports/fields/{entityType}` — Get available fields for entity type. Calls ReportFieldMetadataService.GetFieldsForEntityTypeAsync(). Returns `ReportFieldMetadataResult`.

    8. `PATCH /api/reports/{id}/share` — Toggle share. Accepts `{ IsShared: bool }`. Only owner can share. Returns 200.

    9. `POST /api/reports/{id}/clone` — Clone report. Accepts `{ Name: string }`. Creates copy with new owner, IsShared = false, IsSeedData = false. Returns 201 with `ReportDto`.

    10. `POST /api/reports/{id}/export-csv` — Trigger CSV export. Enqueues ReportCsvExportJob via Hangfire. Returns 202 with `{ jobId }`.

    11. `GET /api/reports/categories` — List all report categories. Returns `List<ReportCategoryDto>`.

    12. `POST /api/reports/categories` — Create category. Admin only. Returns 201.

    13. `PUT /api/reports/categories/{id}` — Update category. Admin only. Returns 200.

    14. `DELETE /api/reports/categories/{id}` — Delete category. Admin only. Returns 204.

    **DTOs (co-located in same file):**
    - `ReportListDto` — Id, Name, Description, EntityType, ChartType, CategoryName, OwnerName, IsShared, IsSeedData, LastRunAt, LastRunRowCount. Static `FromEntity(Report r)`.
    - `ReportDto` — Full report with Definition as nested object. Static `FromEntity(Report r)`.
    - `ReportCategoryDto` — Id, Name, Description, SortOrder. Static `FromEntity()`.
    - `ReportExecutionResultDto` — Rows (List<Dictionary<string, object?>>), TotalCount, Aggregates, ColumnHeaders.
    - `CreateReportRequest`, `UpdateReportRequest`, `ExecuteReportRequest` — request records.

    **Validators** — FluentValidation for CreateReportRequest: Name required (1-200 chars), EntityType required and must be valid (Contact, Deal, Company, Lead, Activity, Quote, Request, Product).

    **Authorization:**
    - `[Authorize(Policy = "Permission:Report:View")]` on GET endpoints
    - `[Authorize(Policy = "Permission:Report:Create")]` on POST create
    - `[Authorize(Policy = "Permission:Report:Edit")]` on PUT/PATCH
    - `[Authorize(Policy = "Permission:Report:Delete")]` on DELETE

    **Program.cs** — Wire AddReportingServices() if not already done in Plan 02's DependencyInjection.cs update. Ensure the ReportCsvExportJob type is accessible to Hangfire.
  </action>
  <verify>Build succeeds: `cd src/GlobCRM.Api && dotnet build`</verify>
  <done>ReportsController exposes 14 REST endpoints for full report management, execution, field metadata, sharing, cloning, and CSV export trigger.</done>
</task>

<task type="auto">
  <name>Task 2: ReportCsvExportJob Hangfire background job and seed 6 starter reports in TenantSeeder</name>
  <files>
    src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  </files>
  <action>
    **ReportCsvExportJob.cs** — Hangfire background job following existing TenantScope pattern in BackgroundJobs/:

    ```csharp
    public class ReportCsvExportJob
    {
        // Inject: ApplicationDbContext, ReportQueryEngine, IFileStorageService, ITenantProvider
        // Also inject IHubContext<CrmHub> for SignalR notification when export completes

        [Queue("default")]
        public async Task ExecuteAsync(Guid reportId, Guid userId, Guid tenantId)
        {
            TenantScope.SetCurrentTenant(tenantId);
            try
            {
                // 1. Load report
                // 2. Execute full query with no pagination (page=1, pageSize=100000 as hard limit)
                //    Use PermissionScope.All for the export (already authorized at controller level)
                // 3. Stream results to CSV using StringBuilder with proper RFC 4180 escaping:
                //    - Header row from column labels
                //    - Data rows with comma separator
                //    - Quote values containing commas, quotes, or newlines
                //    - Escape quotes by doubling them
                // 4. Store CSV via IFileStorageService:
                //    Path: "exports/reports/{tenantId}/{reportId}_{timestamp}.csv"
                // 5. Send SignalR notification to user via CrmHub:
                //    Group: "user_{userId}", Method: "ReportExportComplete"
                //    Payload: { reportId, reportName, downloadUrl, rowCount }
            }
            finally
            {
                TenantScope.ClearCurrentTenant();
            }
        }
    }
    ```

    Register ReportCsvExportJob in DI (add to ReportingServiceExtensions if needed — Hangfire resolves from DI automatically).

    **TenantSeeder.cs** — Add report seeding following the existing pattern (cleanup IsSeedData first, then create):

    Seed **3 categories:**
    1. "Sales Reports" — SortOrder 1
    2. "Pipeline Analysis" — SortOrder 2
    3. "Team Performance" — SortOrder 3

    Seed **6 starter reports** (all IsSeedData = true, IsShared = true):

    1. **"Deals by Stage"** — Entity: Deal, Chart: Funnel, Category: Pipeline Analysis
       - Fields: Stage name (related.Stage.name), Count, Sum of value
       - Grouping: related.Stage.name
       - No filters

    2. **"Revenue by Month"** — Entity: Deal, Chart: Bar, Category: Sales Reports
       - Fields: CreatedAt (month truncation), Sum of value, Count
       - Grouping: createdAt with DateTruncation "month"
       - No filters

    3. **"Contacts by Company Industry"** — Entity: Contact, Chart: Pie, Category: Sales Reports
       - Fields: related.Company.industry, Count
       - Grouping: related.Company.industry
       - No filters

    4. **"Activities This Week"** — Entity: Activity, Chart: Bar, Category: Team Performance
       - Fields: status, Count
       - Grouping: status
       - Filter: dueDate >= start of current week (use relative date or leave as example filter)

    5. **"Quotes by Status"** — Entity: Quote, Chart: Pie, Category: Sales Reports
       - Fields: status, Count, Sum of totalAmount
       - Grouping: status
       - No filters

    6. **"Top Deal Owners"** — Entity: Deal, Chart: Bar, Category: Team Performance
       - Fields: related.Owner.lastName, Count, Sum of value
       - Grouping: related.Owner.lastName
       - No filters

    Build each report's Definition as a properly structured ReportDefinition object with Fields, FilterGroup (null for most), Groupings, and ChartConfig.

    Add cleanup in seeder: `_db.Reports.RemoveRange(_db.Reports.Where(r => r.IsSeedData)); _db.ReportCategories.RemoveRange(_db.ReportCategories.Where(c => c.IsSeedData));` before seeding.
  </action>
  <verify>
    Build succeeds: `cd src/GlobCRM.Api && dotnet build`
    Reseed demo data: `cd src/GlobCRM.Api && dotnet run -- --reseed` (verify no errors)
  </verify>
  <done>ReportCsvExportJob generates CSV via Hangfire with SignalR completion notification. TenantSeeder creates 3 categories and 6 starter reports per tenant demonstrating all chart types and common reporting patterns.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- `dotnet run -- --reseed` seeds reports successfully
- All 14 controller endpoints compile with correct route attributes and authorization
- ReportCsvExportJob follows TenantScope pattern for tenant isolation
</verification>

<success_criteria>
The complete backend API is operational: users can CRUD reports, execute them with pagination, discover available fields, share/clone reports, trigger CSV export, and see 6 starter reports in the gallery. The API is ready for frontend consumption.
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-03-SUMMARY.md`
</output>
