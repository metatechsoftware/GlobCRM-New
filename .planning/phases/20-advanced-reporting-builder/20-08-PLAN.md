---
phase: 20-advanced-reporting-builder
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html
  - globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
  - globcrm-web/src/app/features/reports/report.store.ts
autonomous: true
gap_closure: true
requirements: [RPT-01, RPT-02, RPT-04]

must_haves:
  truths:
    - "Gallery shows error message when API fails instead of silent empty state"
    - "Entity type dropdown shows clean label text without mat-icon ligature leak"
    - "Error messages from store are visible in the builder sidebar area, not just preview"
    - "Recursive filter group delete button removes the child group from parent"
  artifacts:
    - path: "globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html"
      provides: "Error display block between loading and empty state"
      contains: "store.error()"
    - path: "globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts"
      provides: "mat-select-trigger for entity type dropdown"
      contains: "mat-select-trigger"
    - path: "globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts"
      provides: "(removeRequest) binding on recursive child and onChildGroupRemove handler"
      contains: "removeRequest"
    - path: "globcrm-web/src/app/features/reports/report-builder/report-builder.component.html"
      provides: "Error display in sidebar near field selector panel"
      contains: "store.error()"
    - path: "globcrm-web/src/app/features/reports/report.store.ts"
      provides: "loadFieldMetadata sets loading state for feedback"
      contains: "loadFieldMetadata"
  key_links:
    - from: "report-gallery.component.html"
      to: "ReportStore.error"
      via: "store.error() display"
      pattern: "store\\.error\\(\\)"
    - from: "filter-builder-panel.component.ts"
      to: "filter-builder-panel.component.ts (recursive child)"
      via: "(removeRequest) output binding on child instance"
      pattern: "removeRequest"
---

<objective>
Fix four frontend issues found during UAT: gallery silent error state, entity source panel icon ligature leak in mat-select, missing error visibility in builder sidebar, and broken filter group delete button.

Purpose: UAT Tests 2-5 all reported issues tied to frontend rendering and event binding bugs. These fixes address the user-facing symptoms that blocked testing of downstream functionality (7 tests were skipped due to these 4 issues).

Output: Gallery shows errors, entity type labels are clean, errors are visible near the relevant panel, and nested filter groups can be deleted.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-UAT.md
@globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html
@globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.ts
@globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts
@globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts
@globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
@globcrm-web/src/app/features/reports/report.store.ts
@globcrm-web/src/app/features/reports/report.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix gallery error display and entity source panel mat-select-trigger</name>
  <files>
    globcrm-web/src/app/features/reports/report-gallery/report-gallery.component.html
    globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts
  </files>
  <action>
**1. report-gallery.component.html — Add error display block (UAT Gap 1):**

The gallery currently only shows loading skeleton and empty state. If the API call fails, `store.error()` is set but never displayed — the user sees an empty gallery with "No reports found" which is misleading.

Add an error display block BETWEEN the loading state and the empty state (after line 74, before line 77). Insert:

```html
  <!-- Error State -->
  @if (!store.loading() && store.error()) {
    <div class="report-gallery__error">
      <mat-icon>error_outline</mat-icon>
      <h3>Unable to load reports</h3>
      <p>{{ store.error() }}</p>
      <button mat-raised-button color="primary" (click)="loadReports()">
        <mat-icon>refresh</mat-icon>
        Retry
      </button>
    </div>
  }
```

Also update the empty state condition on line 77 to exclude error state — change:
`@if (!store.loading() && store.reports().length === 0)`
to:
`@if (!store.loading() && !store.error() && store.reports().length === 0)`

And update the card grid condition on line 92 similarly — change:
`@if (!store.loading() && store.reports().length > 0)`
to:
`@if (!store.loading() && !store.error() && store.reports().length > 0)`

Add styling for the error block. The gallery component uses an external SCSS file at `report-gallery.component.scss`. Add the following to that file:

```scss
.report-gallery__error {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-3, 12px);
  padding: var(--space-12, 48px) var(--space-4, 16px);
  text-align: center;

  mat-icon {
    font-size: 48px;
    width: 48px;
    height: 48px;
    color: var(--color-error, #DC2626);
  }

  h3 {
    margin: 0;
    font-size: var(--text-lg, 18px);
    font-weight: var(--font-semibold, 600);
    color: var(--color-text, #1A1A1A);
  }

  p {
    margin: 0;
    font-size: var(--text-sm, 14px);
    color: var(--color-text-secondary, #6B7280);
    max-width: 400px;
  }
}
```

Also need to make `loadReports()` public since it's used in the template. Check `report-gallery.component.ts` — `loadReports()` is already `private`. Change `private loadReports()` to just `loadReports()` (remove the `private` keyword) at line 115.

**2. entity-source-panel.component.ts — Add mat-select-trigger (UAT Gap 2):**

The Entity Type `mat-select` currently renders `mat-option` content that includes `<mat-icon>{{ entity.icon }}</mat-icon>` followed by a `<span>{{ entity.label }}</span>`. Angular Material's mat-select renders the selected option's text content as the trigger display. Since mat-icon uses CSS ligatures, the text "trending_up" from the icon element gets concatenated with "Leads" producing "trending_upLeads".

Fix by adding a `<mat-select-trigger>` inside the entity type `<mat-select>` to customize the selected display. The trigger should show ONLY the label text (no icon).

In the inline template, find the Entity Type mat-select block (lines 72-86) and add a `mat-select-trigger` element as the first child of `<mat-select>`:

```html
<mat-select
  [ngModel]="entityTypeValue()"
  (ngModelChange)="onEntityTypeChange($event)"
>
  <mat-select-trigger>
    {{ selectedEntityLabel() }}
  </mat-select-trigger>
  @for (entity of entityOptions; track entity.value) {
    <mat-option [value]="entity.value">
      <div class="entity-option">
        <mat-icon>{{ entity.icon }}</mat-icon>
        <span>{{ entity.label }}</span>
      </div>
    </mat-option>
  }
</mat-select>
```

Add a `selectedEntityLabel` computed signal to the component class:

```typescript
readonly selectedEntityLabel = computed(() => {
  const value = this.entityTypeValue();
  if (!value) return '';
  const option = this.entityOptions.find(e => e.value === value);
  return option?.label ?? value;
});
```

Import `computed` from `@angular/core` (add to existing import on line 1-8). The import list already has `signal` and `effect`, add `computed` alongside them.

Also add `MatSelectModule` import — it is already in the imports array (line 12/43) so that is fine. The `mat-select-trigger` directive comes from `MatSelectModule` which is already imported.
  </action>
  <verify>
Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` to verify compilation.

Grep `report-gallery.component.html` for `store.error()` — should appear in error display block.

Grep `entity-source-panel.component.ts` for `mat-select-trigger` — should appear exactly once.

Grep `entity-source-panel.component.ts` for `selectedEntityLabel` — should appear in both template and class.
  </verify>
  <done>
Gallery template shows error state with retry button when API fails. Entity source panel shows clean "Leads" text (not "trending_upLeads") in the mat-select trigger display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix builder error visibility, store loadFieldMetadata feedback, and filter group delete</name>
  <files>
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
    globcrm-web/src/app/features/reports/report.store.ts
    globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts
  </files>
  <action>
**1. report-builder.component.html — Add error display near sidebar panels (UAT Gap 3):**

Currently the error display (lines 146-151) is only in the preview area (right panel). When loadFieldMetadata fails, the error message is invisible because the user is looking at the sidebar. The field selector shows "Select an entity type to see available fields" instead of the actual error.

Add an error display block INSIDE the sidebar, immediately AFTER the panels div (after line 58, before the fixed bottom actions div on line 61). Insert:

```html
      <!-- Error feedback for sidebar operations -->
      @if (store.error()) {
        <div class="report-builder__sidebar-error">
          <mat-icon>warning</mat-icon>
          <span>{{ store.error() }}</span>
        </div>
      }
```

Add styling for this in `report-builder.component.scss`:

```scss
.report-builder__sidebar-error {
  display: flex;
  align-items: flex-start;
  gap: var(--space-2, 8px);
  padding: var(--space-3, 12px);
  margin: 0 var(--space-2, 8px) var(--space-2, 8px);
  border-radius: var(--radius-md, 8px);
  background: var(--color-warning-soft, #FEF3C7);
  color: var(--color-warning-text, #92400E);
  font-size: var(--text-sm, 13px);

  mat-icon {
    font-size: 18px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    margin-top: 1px;
  }
}
```

**2. report.store.ts — Improve loadFieldMetadata error handling (UAT Gap 3 supporting fix):**

The current `loadFieldMetadata` method (lines 198-209) does not clear previous errors before starting, and the error message is generic. Improve it:

```typescript
loadFieldMetadata(entityType: string): void {
  patchState(store, { fieldMetadata: null, error: null });
  service.getFieldMetadata(entityType).subscribe({
    next: (metadata) => {
      patchState(store, { fieldMetadata: metadata, error: null });
    },
    error: (err) => {
      patchState(store, {
        fieldMetadata: null,
        error: err?.error?.error ?? err?.message ?? `Failed to load fields for ${entityType}`,
      });
    },
  });
},
```

Key changes: (a) Clear fieldMetadata and error at start so stale data from prior entity type is removed; (b) Attempt to extract the API error message from `err.error.error` (the structure `{ error: "message" }` used by ReportsController); (c) Include the entity type in the fallback message for better diagnostics.

**3. filter-builder-panel.component.ts — Fix recursive group delete (UAT Gap 4):**

Two issues: (a) The recursive `<app-filter-builder-panel>` child instances (lines 208-214 in the template) do NOT bind the `(removeRequest)` output, so when a nested group clicks its delete button, the `removeRequest.emit()` fires but no parent handler catches it. (b) There is no handler method to splice a child group from the parent's groups array.

Fix the template by adding `(removeRequest)` binding on the recursive child. Find lines 208-214:

```html
@for (childGroup of currentGroup().groups; track $index; let childIdx = $index) {
  <app-filter-builder-panel
    [fieldMetadata]="fieldMetadata()"
    [filterGroup]="childGroup"
    [isNested]="true"
    (filterGroupChange)="onChildGroupChange(childIdx, $event)"
  ></app-filter-builder-panel>
}
```

Change to:

```html
@for (childGroup of currentGroup().groups; track $index; let childIdx = $index) {
  <app-filter-builder-panel
    [fieldMetadata]="fieldMetadata()"
    [filterGroup]="childGroup"
    [isNested]="true"
    (filterGroupChange)="onChildGroupChange(childIdx, $event)"
    (removeRequest)="onChildGroupRemove(childIdx)"
  ></app-filter-builder-panel>
}
```

Then add the `onChildGroupRemove` method to the component class (after `onChildGroupChange` method, around line 513):

```typescript
onChildGroupRemove(index: number): void {
  const group = this.currentGroup();
  const groups = group.groups.filter((_, i) => i !== index);
  this.emitUpdate({ ...group, groups });
}
```

This method splices the child group at `index` from the parent's groups array, then emits the updated parent group via `filterGroupChange`, propagating the change up through the recursive tree.
  </action>
  <verify>
Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build --configuration=development 2>&1 | tail -20` to verify compilation.

Grep `filter-builder-panel.component.ts` for `removeRequest` — should appear in: output declaration, template binding on recursive child, and the existing removeGroup method. Total 3+ occurrences.

Grep `filter-builder-panel.component.ts` for `onChildGroupRemove` — should appear in both template and class body.

Grep `report-builder.component.html` for `sidebar-error` — should appear once.

Grep `report.store.ts` for `fieldMetadata: null` — should appear in loadFieldMetadata's initial patchState call.
  </verify>
  <done>
Builder sidebar shows error messages near the relevant panels when API calls fail. loadFieldMetadata clears stale state and extracts API error messages. Recursive filter group delete button correctly removes child groups from the parent's groups array.
  </done>
</task>

</tasks>

<verification>
1. `ng build` compiles without errors
2. Gallery template has error, empty, and card grid states all mutually exclusive
3. Entity type mat-select uses mat-select-trigger for clean label display
4. Builder sidebar shows error feedback near panels
5. Filter builder recursive child binds (removeRequest) and parent handles onChildGroupRemove
</verification>

<success_criteria>
- Angular build succeeds with no compilation errors
- Gallery shows meaningful error state with retry instead of silent empty state
- Entity type dropdown displays "Leads" not "trending_upLeads"
- Builder sidebar displays store errors near the field selector panel
- Nested filter group delete button removes the group from parent and emits change
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-08-SUMMARY.md`
</output>
