---
phase: 20-advanced-reporting-builder
plan: 05
type: execute
wave: 5
depends_on: [20-04]
files_modified:
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.scss
  - globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/field-selector-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/grouping-panel.component.ts
  - globcrm-web/src/app/features/reports/report-builder/chart-config-panel.component.ts
autonomous: true
requirements: [RPT-01, RPT-02, RPT-03, RPT-07]

must_haves:
  truths:
    - "User can select an entity source from a dropdown and see available fields load"
    - "User can check/uncheck fields from a categorized list with search to select report columns"
    - "User can build nested AND/OR filter groups with field-specific operators"
    - "User can add grouping fields and select aggregation type for numeric fields"
    - "User can choose chart type (bar, line, pie, funnel, table)"
    - "All configuration in a left sidebar with collapsible sections and a fixed Run Report button"
  artifacts:
    - path: "globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts"
      provides: "Entity type selector dropdown that triggers field metadata loading"
      contains: "class EntitySourcePanelComponent"
    - path: "globcrm-web/src/app/features/reports/report-builder/field-selector-panel.component.ts"
      provides: "Checkbox list with search for selecting report columns, grouped by category"
      contains: "class FieldSelectorPanelComponent"
    - path: "globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts"
      provides: "Recursive AND/OR filter group builder with nestable conditions"
      contains: "class FilterBuilderPanelComponent"
    - path: "globcrm-web/src/app/features/reports/report-builder/grouping-panel.component.ts"
      provides: "Grouping field selector with aggregation type picker"
      contains: "class GroupingPanelComponent"
    - path: "globcrm-web/src/app/features/reports/report-builder/chart-config-panel.component.ts"
      provides: "Chart type selector with visual type options"
      contains: "class ChartConfigPanelComponent"
  key_links:
    - from: "globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts"
      to: "globcrm-web/src/app/features/reports/report.store.ts"
      via: "Store method to load field metadata on entity type change"
      pattern: "loadFieldMetadata"
    - from: "globcrm-web/src/app/features/reports/report-builder/field-selector-panel.component.ts"
      to: "globcrm-web/src/app/features/reports/report.store.ts"
      via: "fieldMetadata signal for available fields"
      pattern: "store\\.fieldMetadata"
---

<objective>
Build the report builder's left sidebar with 5 collapsible configuration panels: entity source selection, field/column picker, filter builder with AND/OR groups, grouping with aggregation, and chart type selector. Wire all panels into the builder layout with a fixed "Run Report" button.

Purpose: Enable users to configure every aspect of a report definition through an intuitive sidebar interface before executing it.
Output: 5 configuration panel components wired into the builder layout.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-RESEARCH.md
@.planning/phases/20-advanced-reporting-builder/20-04-SUMMARY.md

# Patterns to follow:
@globcrm-web/src/app/features/reports/report.models.ts
@globcrm-web/src/app/features/reports/report.store.ts
@globcrm-web/src/app/shared/components/filter-panel/filter-panel.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity source panel, field selector panel, grouping panel, and chart config panel</name>
  <files>
    globcrm-web/src/app/features/reports/report-builder/entity-source-panel.component.ts
    globcrm-web/src/app/features/reports/report-builder/field-selector-panel.component.ts
    globcrm-web/src/app/features/reports/report-builder/grouping-panel.component.ts
    globcrm-web/src/app/features/reports/report-builder/chart-config-panel.component.ts
  </files>
  <action>
    **EntitySourcePanelComponent** — Wrapped in mat-expansion-panel (expanded by default):
    - mat-select dropdown with all 8 CRM entity types: Contact, Deal, Company, Lead, Activity, Quote, Request, Product
    - Each option shows entity icon + name
    - On selection change: emit `entityTypeChange` output with the selected entity type string
    - The parent builder component calls `store.loadFieldMetadata(entityType)` when this changes
    - Also show report name input (mat-form-field) and optional description textarea
    - Input: `entityType = input<string>()` (for edit mode pre-population)
    - Output: `entityTypeChange = output<string>()`, `nameChange = output<string>()`, `descriptionChange = output<string>()`

    **FieldSelectorPanelComponent** — Wrapped in mat-expansion-panel (expanded by default):
    - **Per user discretion decision: checkbox list with search** (not drag-drop)
    - Input: `fieldMetadata = input<ReportFieldMetadata | null>()`, `selectedFields = input<ReportField[]>()`
    - Output: `fieldsChange = output<ReportField[]>()`
    - Template layout:
      - Search input (mat-form-field) at top for filtering field names
      - 4 expandable groups using mat-expansion-panel or simple collapsible divs:
        1. "System Fields" — checkbox list from fieldMetadata.systemFields
        2. "Custom Fields" — checkbox list from fieldMetadata.customFields
        3. "Formula Fields" — checkbox list from fieldMetadata.formulaFields (with "computed" badge)
        4. "Related Fields" — expandable sub-groups per related entity (e.g., "Company > Name", "Stage > Name")
           **Per user discretion decision:** Show expandable groups like "Related: Company", "Related: Owner" etc.
      - Each checkbox shows: field label + data type badge (string, number, date, etc.)
      - Checking a field adds it to selectedFields with next sortOrder
      - Unchecking removes it
    - Search signal filters displayed fields across all categories (case-insensitive label match)
    - Below checkbox area: "Selected columns" count badge showing how many fields are selected

    **GroupingPanelComponent** — Wrapped in mat-expansion-panel (collapsed by default):
    - Input: `selectedFields = input<ReportField[]>()`, `fieldMetadata = input<ReportFieldMetadata | null>()`, `groupings = input<ReportGrouping[]>()`
    - Output: `groupingsChange = output<ReportGrouping[]>()`, `aggregationsChange = output<ReportField[]>()`
    - Template:
      - "Group by" section: mat-select to pick a field to group by (only show groupable fields from metadata)
      - When a grouping field is selected, show a "Date truncation" dropdown (Day, Week, Month, Quarter, Year) only if the selected field is a date type
      - "Add grouping" button to allow multiple group-by fields
      - Each added grouping shown as a chip with remove button
      - "Aggregations" section (visible when at least one grouping is active):
        - For each selected numeric/currency field, show a row with field name + aggregation dropdown (Count, Sum, Average, Min, Max)
        - Non-numeric fields automatically get Count aggregation
        - **Per user discretion:** Show aggregation summary as cards above data table (handled in Plan 06 viewer)

    **ChartConfigPanelComponent** — Wrapped in mat-expansion-panel (collapsed by default):
    - Input: `chartConfig = input<ReportChartConfig | null>()`
    - Output: `chartConfigChange = output<ReportChartConfig>()`
    - Template:
      - Chart type selection as mat-button-toggle-group with visual icons:
        - Table (grid_on icon), Bar (bar_chart), Line (show_chart), Pie (pie_chart), Funnel (filter_alt)
      - Each button-toggle shows icon + label
      - Toggle: "Show Legend" (mat-slide-toggle, default on)
      - Toggle: "Show Data Labels" (mat-slide-toggle, default off)
    - **Per user decision:** Chart types are Bar, Line, Pie, and Funnel. Table is also an option (data table only, no chart).
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>Entity source panel selects entity type and triggers field loading. Field selector shows categorized checkbox list with search. Grouping panel configures group-by fields with date truncation and aggregation types. Chart config panel selects visualization type with legend/label toggles.</done>
</task>

<task type="auto">
  <name>Task 2: Filter builder panel (recursive AND/OR groups) and builder layout wiring</name>
  <files>
    globcrm-web/src/app/features/reports/report-builder/filter-builder-panel.component.ts
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.scss
  </files>
  <action>
    **FilterBuilderPanelComponent** — Wrapped in mat-expansion-panel (collapsed by default):
    - Input: `fieldMetadata = input<ReportFieldMetadata | null>()`, `filterGroup = input<ReportFilterGroup | null>()`
    - Output: `filterGroupChange = output<ReportFilterGroup>()`
    - **Per user decision:** Notion/Airtable-style nestable condition groups with AND/OR logic.
    - Template (recursive structure):
      - Top-level filter group with a logic toggle (AND/OR) as mat-button-toggle
      - List of conditions within the group, each rendered as a row:
        - Field dropdown (mat-select with all available fields from metadata)
        - Operator dropdown (operators change based on field data type):
          - String: equals, not_equals, contains, not_contains, is_empty, is_not_empty
          - Number/Currency: equals, not_equals, greater_than, less_than, greater_than_or_equal, less_than_or_equal, between, is_empty, is_not_empty
          - Date: equals, not_equals, greater_than, less_than, between, is_empty, is_not_empty
          - Boolean: equals
        - Value input (type adapts to field: text input, number input, date picker, or two inputs for "between")
        - Remove condition button (mat-icon-button, close icon)
      - "Add condition" button at the bottom of each group
      - "Add group" button to create a nested child filter group (recursive rendering)
      - Nested groups indented with a left border (visual hierarchy indicator)
      - Each nested group has its own AND/OR toggle and conditions
    - **Implementation approach:** The component renders itself recursively for child groups. Use Angular's ability to self-reference components:
      ```typescript
      // FilterBuilderPanelComponent template references itself for nested groups:
      @for (childGroup of filterGroup()?.groups ?? []; track $index) {
        <app-filter-builder-panel
          [fieldMetadata]="fieldMetadata()"
          [filterGroup]="childGroup"
          [isNested]="true"
          (filterGroupChange)="onChildGroupChange($index, $event)">
        </app-filter-builder-panel>
      }
      ```
    - Input `isNested = input(false)` — when true, renders without mat-expansion-panel wrapper (just the group content with indentation)
    - Emit filterGroupChange on any condition/group modification via an immutable update pattern (spread to create new objects)

    **ReportBuilderComponent** — Replace the placeholder shell from Plan 04 with the full builder layout:
    - `providers: [ReportStore]` (component-provided store)
    - Input: `id = input<string>()` (route param for edit mode)
    - OnInit:
      - Load categories from store
      - If id exists: load report, then set entity type and load field metadata
      - If no id (new mode): initialize empty report definition
    - Template layout (**per user decision: single-page builder with all panels visible in collapsible left sidebar**):
      ```html
      <div class="report-builder">
        <div class="report-builder__sidebar">
          <!-- 5 collapsible panels -->
          <app-entity-source-panel .../>
          <app-field-selector-panel .../>
          <app-filter-builder-panel .../>
          <app-grouping-panel .../>
          <app-chart-config-panel .../>

          <!-- Fixed bottom actions -->
          <div class="report-builder__actions">
            <button mat-flat-button color="primary" (click)="runReport()" [disabled]="store.executing()">
              <mat-icon>play_arrow</mat-icon>
              Run Report
            </button>
            <button mat-stroked-button (click)="saveReport()" [disabled]="!canSave()">
              <mat-icon>save</mat-icon>
              Save
            </button>
          </div>
        </div>
        <div class="report-builder__preview">
          <!-- Viewer components from Plan 06 will go here -->
          <!-- For now: show execution status and placeholder -->
          @if (store.executing()) {
            <mat-spinner diameter="48"></mat-spinner>
          } @else if (store.executionResult()) {
            <p>Report executed: {{ store.executionResult()?.totalCount }} rows</p>
            <!-- Plan 06 will replace this with chart + table -->
          } @else {
            <div class="report-builder__empty-preview">
              <mat-icon>bar_chart</mat-icon>
              <p>Configure your report and click "Run Report" to see results</p>
            </div>
          }
        </div>
      </div>
      ```
    - **Per user decision:** Manual "Run Report" button — no auto-preview.
    - **Sidebar width:** 320px fixed, with overflow-y auto for scrollable panels.
    - **Actions bar:** Sticky at sidebar bottom with "Run Report" (primary) and "Save" buttons.
    - runReport() method: builds ReportDefinition from panel state -> calls store.executeReport()
    - saveReport() method: builds CreateReportRequest or UpdateReportRequest -> calls store.createReport() or updateReport()
    - Local signals for building the report definition from panel outputs:
      - `entityType = signal<string>('')`
      - `reportName = signal<string>('')`
      - `reportDescription = signal<string>('')`
      - `selectedFields = signal<ReportField[]>([])`
      - `filterGroup = signal<ReportFilterGroup | null>(null)`
      - `groupings = signal<ReportGrouping[]>([])`
      - `chartConfig = signal<ReportChartConfig>({ chartType: 'table', showLegend: true, showDataLabels: false })`
    - Computed `canSave()`: true when entityType is set and at least one field is selected and name is not empty
    - On edit mode load: populate all local signals from the loaded report's definition

    **Styles (report-builder.component.scss):**
    - `.report-builder` — flexbox row, height: calc(100vh - navbar height)
    - `.report-builder__sidebar` — width: 320px, flex-shrink: 0, overflow-y: auto, border-right, padding
    - `.report-builder__preview` — flex: 1, overflow-y: auto, padding
    - `.report-builder__actions` — sticky bottom, padding, background with subtle top border
    - `.report-builder__empty-preview` — centered flex column with muted icon and text
    - mat-expansion-panel spacing: margin-bottom between panels
    - Filter group nesting: left border (2px solid primary color) with padding-left for visual hierarchy
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>Filter builder supports recursive AND/OR condition groups with field-type-adaptive operators. Builder layout wires all 5 sidebar panels with local signal state, "Run Report" button triggers execution, "Save" button persists the report definition.</done>
</task>

</tasks>

<verification>
- Angular build passes with 0 errors
- /reports/new loads the builder with empty configuration panels
- /reports/:id loads the builder with pre-populated panels from saved report
- All 5 sidebar panels render in collapsible mat-expansion-panels
- Filter builder supports nested groups (at least 2 levels deep)
- "Run Report" and "Save" buttons visible at sidebar bottom
</verification>

<success_criteria>
Users can fully configure a report definition through the sidebar: select entity type, pick fields from categorized checkbox list, build nested AND/OR filter groups with field-type-adaptive operators, configure grouping with aggregation types, and choose chart visualization type. The "Run Report" button triggers execution and "Save" persists the configuration.
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-05-SUMMARY.md`
</output>
