---
phase: 28-localization-string-extraction
plan: 07
type: execute
wave: 2
depends_on:
  - 28-01
  - 28-02
  - 28-03
  - 28-04
  - 28-05
  - 28-06
files_modified:
  - globcrm-web/scripts/check-translations.js
  - globcrm-web/package.json
autonomous: true
requirements:
  - LOCL-09
  - LOCL-10

must_haves:
  truths:
    - "Running npm run check:i18n validates that EN and TR translation files have identical key sets and fails on mismatch"
    - "Running npm run check:i18n detects hardcoded English strings in component templates not wrapped in transloco pipe"
    - "Running npm run check:i18n reports unused translation keys as warnings"
    - "No hardcoded English strings remain in any component template (CI script passes cleanly)"
  artifacts:
    - path: "globcrm-web/scripts/check-translations.js"
      provides: "CI translation validation script with 3 checks"
      min_lines: 100
    - path: "globcrm-web/package.json"
      provides: "npm check:i18n script entry"
      contains: "check:i18n"
  key_links:
    - from: "globcrm-web/scripts/check-translations.js"
      to: "globcrm-web/src/assets/i18n/"
      via: "fs.readdir recursive scan of all JSON files"
      pattern: "assets/i18n"
    - from: "globcrm-web/scripts/check-translations.js"
      to: "globcrm-web/src/app/"
      via: "recursive scan of .html and .ts files for hardcoded strings"
      pattern: "src/app"
---

<objective>
Create a CI translation validation script that enforces three checks: key parity between EN/TR files, hardcoded string detection in templates, and unused key detection. Run a final audit to catch any remaining hardcoded strings missed by plans 01-06.

Purpose: This is the CI enforcement gate (LOCL-09) that prevents regression after the extraction work. It also serves as the final quality audit to verify LOCL-10 completeness -- if the hardcoded string detector finds remaining strings, they get fixed in this plan before the script is committed.

Output: A Node.js CI script at `scripts/check-translations.js` invoked via `npm run check:i18n`, plus any final string extraction fixes found during the audit pass.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-localization-string-extraction/28-CONTEXT.md
@.planning/phases/28-localization-string-extraction/28-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI translation validation script with key parity, hardcoded string detection, and unused key detection</name>
  <files>
    globcrm-web/scripts/check-translations.js
    globcrm-web/package.json
  </files>
  <action>
Create `globcrm-web/scripts/check-translations.js` using only Node.js built-in modules (fs, path). The script performs three validation checks:

**Check 1: Key Parity (HARD FAIL)**

- Recursively scan `src/assets/i18n/` for all JSON files
- For each scope directory (and the root global files), load en.json and tr.json
- Flatten all nested keys to dot-notation paths (e.g., `common.table.noData`)
- Compare EN key set vs TR key set
- Report any keys present in EN but missing in TR (and vice versa)
- Exit with code 1 if ANY mismatches found
- Output format: `ERROR: [scope] Key "list.empty" exists in en.json but missing in tr.json`

**Check 2: Hardcoded String Detection (HARD FAIL)**

- Recursively scan `src/app/` for all `.html` files AND `.ts` files (for inline templates)
- For `.ts` files, extract only the `template: \`...\`` content (inline templates), not the entire TS file
- In template content, detect potential hardcoded English strings:
  - Text content between HTML tags that is NOT: an Angular expression (`{{ }}`), a transloco pipe, empty/whitespace, a number, a CSS class, a component selector, an HTML entity, or a single character
  - Attribute values for: `placeholder`, `aria-label`, `matTooltip`, `title`, `alt` that are NOT: property-bound (`[attr]="..."`) or using transloco pipe
  - `mat-label` content that is not using transloco pipe
  - `label` attributes on `mat-tab`, `mat-step` that are string literals (not property-bound)
- Allowlist patterns to skip false positives:
  - Angular Material structural content (mat-icon text like `"edit"`, `"delete"`, `"close"`)
  - Component selectors (`<app-...>`)
  - CSS class values
  - Single-word Angular directives/attributes
  - Known non-translatable content (URLs, email regex patterns, `@if`, `@for`, `@switch` blocks)
  - Interpolation-only content (e.g., `{{ variable }}`)
- Report each finding with file path and line number
- Exit with code 1 if findings exceed a small threshold (allow 0 for clean pass, but configurable)
- Output format: `ERROR: [file:line] Potential hardcoded string: "No results found"`

**Check 3: Unused Key Detection (WARNING ONLY)**

- Collect all translation keys from all JSON files (global + all scopes)
- For scoped keys, construct the full key path as it would appear in templates: `'scopeName.key.path'` and also the short scoped form `'key.path'`
- Scan all `.html` and `.ts` files for references to each key (in transloco pipe, translate() calls, selectTranslate() calls)
- Report keys that have no references anywhere in the codebase
- DO NOT exit with error code for unused keys -- these are informational warnings only
- Output format: `WARNING: [scope] Key "detail.obsoleteField" appears unused`

**Script structure:**

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const I18N_DIR = path.join(__dirname, '../src/assets/i18n');
const APP_DIR = path.join(__dirname, '../src/app');

let errors = 0;
let warnings = 0;

// Check 1: Key Parity
// Check 2: Hardcoded String Detection
// Check 3: Unused Key Detection

// Summary
console.log(`\nResults: ${errors} error(s), ${warnings} warning(s)`);
process.exit(errors > 0 ? 1 : 0);
```

**Add npm script to package.json:**

Read the existing package.json, add `"check:i18n": "node scripts/check-translations.js"` to the `scripts` section. Do NOT modify any other scripts or dependencies.

**Testing the script:** After creating it, run `cd globcrm-web && npm run check:i18n` and review output. If the script reports legitimate hardcoded strings missed by plans 01-06, note them for Task 2.
  </action>
  <verify>
Run `cd globcrm-web && npm run check:i18n`. The script should execute without Node.js errors. Key parity check should pass (0 mismatches). Hardcoded string check should report findings (if any remain). Unused key check should report warnings (if any).
  </verify>
  <done>CI script created at scripts/check-translations.js, npm script `check:i18n` added to package.json. Script executes the three validation checks with correct exit codes (hard fail on key parity and hardcoded strings, warning on unused keys).</done>
</task>

<task type="auto">
  <name>Task 2: Run final audit, fix any remaining hardcoded strings caught by CI script, and ensure clean pass</name>
  <files>
    globcrm-web/scripts/check-translations.js
  </files>
  <action>
1. Run `cd globcrm-web && npm run check:i18n` and capture full output.

2. **For key parity errors:** Fix any EN/TR mismatches by adding missing keys to the appropriate JSON file with correct translations.

3. **For hardcoded string detections:**
   - Review each reported string. If it's a genuine hardcoded UI string that should be translated:
     a. Add the key to the appropriate scope JSON file (or global if it's in a shared component)
     b. Add the Turkish translation
     c. Replace the hardcoded string with transloco pipe in the template
     d. Add TranslocoPipe to the component's imports if not already there
   - If it's a false positive (dynamic content, enum mapping, structural HTML), add it to the script's allowlist to prevent future false reports.

4. **For unused key warnings:** Review each. Remove genuinely unused keys to keep translation files clean. Adjust false positives in the script's detection logic.

5. **Iterate:** Run `npm run check:i18n` again after fixes. Repeat until the script exits cleanly (exit code 0) with zero errors. Warnings for unused keys are acceptable but should be minimal.

6. **Final verification:** Run `cd globcrm-web && npx ng build --configuration development` to ensure no compilation errors were introduced during the audit fixes.

7. **Tune the allowlist** in the CI script if too many false positives are reported. Common false positives to allowlist:
   - mat-icon content (`<mat-icon>edit</mat-icon>`)
   - Button icon-only content
   - Structural Angular template syntax
   - URL/path strings
   - Enum values displayed directly from API responses (these stay as-is per anti-patterns in RESEARCH.md)

The goal is a CI script that passes cleanly on the current codebase AND will catch future regressions when new hardcoded strings are added.
  </action>
  <verify>
Run `cd globcrm-web && npm run check:i18n && echo "CI PASS"`. The script should exit with code 0 (no errors). Then run `cd globcrm-web && npx ng build --configuration development` to confirm no build errors.
  </verify>
  <done>`npm run check:i18n` exits with code 0 (zero errors). Angular project compiles without errors. CI script is ready for integration into CI pipeline. Any remaining false positives are properly allowlisted.</done>
</task>

</tasks>

<verification>
- `cd globcrm-web && npm run check:i18n` exits with code 0
- `cd globcrm-web && npx ng build --configuration development` compiles without errors
- Key parity: zero mismatches between EN and TR for all scopes
- Hardcoded string detection: zero unaddressed findings (all resolved or allowlisted)
- The script correctly detects intentionally introduced regressions (manually add a hardcoded string, re-run, verify it's caught)
</verification>

<success_criteria>
- CI script exists at `globcrm-web/scripts/check-translations.js` with all three checks
- `npm run check:i18n` script added to package.json
- Script exits with code 0 on current codebase (clean pass)
- Key parity check catches EN/TR mismatches (hard fail)
- Hardcoded string detector catches unlocalized text in templates (hard fail)
- Unused key detector reports orphaned keys (warning)
- All remaining hardcoded strings from plans 01-06 are fixed
- Angular project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-localization-string-extraction/28-07-SUMMARY.md`
</output>
