---
phase: 28-localization-string-extraction
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/core/i18n/transloco-loader.ts
  - globcrm-web/src/app/features/settings/language/language-settings.component.ts
  - globcrm-web/src/app/shared/components/saved-views/view.models.ts
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
  - globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts
autonomous: true
gap_closure: true
requirements:
  - LOCL-03
  - LOCL-09
  - LOCL-10

must_haves:
  truths:
    - "Scoped translation JSON files (contacts/en.json, deals/en.json, etc.) are loaded by TranslocoHttpLoader when navigating to feature routes"
    - "Settings > Language page switches the UI language immediately after saving, not just persisting to DB"
    - "DynamicTable column headers can display translated labels when translation keys are provided via labelKey"
    - "Column picker dropdown displays translated column labels when labelKey is provided"
  artifacts:
    - path: "globcrm-web/src/app/core/i18n/transloco-loader.ts"
      provides: "Scope-aware translation file loading"
      contains: "scope"
    - path: "globcrm-web/src/app/shared/components/saved-views/view.models.ts"
      provides: "ColumnDefinition with optional labelKey field"
      contains: "labelKey"
    - path: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      provides: "getColumnLabel uses TranslocoService to translate labelKey"
      contains: "translate"
  key_links:
    - from: "globcrm-web/src/app/core/i18n/transloco-loader.ts"
      to: "globcrm-web/src/assets/i18n/{scope}/{lang}.json"
      via: "HTTP GET with scope path"
      pattern: "assets/i18n.*scope"
    - from: "globcrm-web/src/app/features/settings/language/language-settings.component.ts"
      to: "globcrm-web/src/app/core/i18n/language.service.ts"
      via: "switchLanguage() call after DB save"
      pattern: "switchLanguage"
    - from: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      to: "TranslocoService"
      via: "translate() in getColumnLabel()"
      pattern: "translocoService\\.translate"
---

<objective>
Fix three foundational localization issues discovered during UAT: (1) TranslocoHttpLoader not loading scoped translation files, (2) Settings language page not switching UI language immediately, (3) DynamicTable column headers not supporting translation keys.

Purpose: These three fixes are prerequisites for all scoped translations (contacts, deals, dashboard, settings, etc.) and column header translations to work across the application.
Output: Working scope loader, immediate language switch in settings, and translation-ready column header infrastructure.
</objective>

<execution_context>
@C:/Users/maliy/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maliy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-localization-string-extraction/28-UAT.md
@globcrm-web/src/app/core/i18n/transloco-loader.ts
@globcrm-web/src/app/core/i18n/language.service.ts
@globcrm-web/src/app/features/settings/language/language-settings.component.ts
@globcrm-web/src/app/shared/components/saved-views/view.models.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
@globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TranslocoHttpLoader scope support and Settings language immediate switch</name>
  <files>
    globcrm-web/src/app/core/i18n/transloco-loader.ts
    globcrm-web/src/app/features/settings/language/language-settings.component.ts
  </files>
  <action>
    **TranslocoHttpLoader fix:**
    Update `getTranslation(lang: string)` to accept the second parameter `data?: { scope: string }` from the `TranslocoLoader` interface. When `data?.scope` is provided, load from `./assets/i18n/${data.scope}/${lang}.json`. When no scope, load from `./assets/i18n/${lang}.json` (current behavior preserved). This is the root cause for UAT Tests 5, 6, 7, and 8 -- all scoped translation files (contacts, deals, dashboard, settings, etc.) were never loaded.

    The method signature must match the interface: `getTranslation(lang: string, data?: TranslocoLoaderData)`. Import `TranslocoLoaderData` from `@jsverse/transloco`.

    **Language settings immediate switch fix:**
    In `LanguageSettingsComponent`, inject `LanguageService` (from `../../../core/i18n/language.service`). In the `onLanguageChange()` method's success handler, after `this.selectedLanguage.set(lang)`, call `this.languageService.switchLanguage(lang as SupportedLang)`. Import `SupportedLang` from the language service. This ensures the UI updates immediately (not just DB persistence). The profile switcher already works because it calls `LanguageService.switchLanguage()` -- this settings page was missing that call.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development` -- build should succeed with 0 errors.
    After the fix, navigating to /contacts should trigger an HTTP request to `/assets/i18n/contacts/en.json` (observable in browser network tab).
  </verify>
  <done>
    TranslocoHttpLoader loads scoped translation files when scope parameter is provided. Settings language page calls LanguageService.switchLanguage() for immediate UI language change after DB save.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add labelKey to ColumnDefinition and translate in DynamicTable + ColumnPicker</name>
  <files>
    globcrm-web/src/app/shared/components/saved-views/view.models.ts
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
    globcrm-web/src/app/shared/components/dynamic-table/column-picker.component.ts
  </files>
  <action>
    **ColumnDefinition interface (view.models.ts):**
    Add an optional `labelKey?: string` field to the `ColumnDefinition` interface. When present, this is a translation key that should be used instead of the static `label` string. Custom fields will continue using `label` only (no `labelKey`), so both paths must work.

    **DynamicTable getColumnLabel() (dynamic-table.component.ts):**
    Update `getColumnLabel(fieldId: string)` to check for `labelKey` first. If the column definition has a `labelKey`, use `this.translocoService.translate(def.labelKey)` to get the translated label. If no `labelKey` exists, fall back to `def?.label ?? fieldId` (current behavior for custom fields and backward compatibility). The `translocoService` is already injected.

    **DynamicTable template (dynamic-table.component.html):**
    No change needed -- the template already uses `{{ getColumnLabel(col.fieldId) }}` which will now return translated text.

    **ColumnPicker (column-picker.component.ts):**
    Inject `TranslocoService`. Add a `getLabel(col: ColumnDefinition): string` method that returns `this.translocoService.translate(col.labelKey)` when `col.labelKey` exists, otherwise `col.label`. Update the template to use `{{ getLabel(col) }}` instead of `{{ col.label }}`. Import `TranslocoService` from `@jsverse/transloco`.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development` -- build should succeed with 0 errors.
    The ColumnDefinition interface now has an optional `labelKey` field. DynamicTable and ColumnPicker translate `labelKey` when available.
  </verify>
  <done>
    ColumnDefinition supports `labelKey` for translation. DynamicTable.getColumnLabel() and ColumnPicker both use TranslocoService to translate labelKey when provided, falling back to raw label for custom fields. Infrastructure ready for entity list components to adopt.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` -- 0 errors
2. TranslocoHttpLoader.getTranslation signature includes scope data parameter
3. ColumnDefinition interface includes optional labelKey field
4. DynamicTable.getColumnLabel() uses translate() for labelKey
5. ColumnPicker uses translate() for labelKey
6. Language settings component imports and calls LanguageService.switchLanguage()
</verification>

<success_criteria>
- Scoped translation files load when navigating to feature routes (contacts, deals, dashboard, settings, etc.)
- Settings > Language page switches UI language immediately after save
- DynamicTable and ColumnPicker infrastructure supports translated column labels via labelKey
- Build compiles with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-localization-string-extraction/28-11-SUMMARY.md`
</output>
