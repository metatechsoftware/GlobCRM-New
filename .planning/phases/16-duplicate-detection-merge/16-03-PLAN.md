---
phase: 16-duplicate-detection-merge
plan: 03
type: execute
wave: 3
depends_on: [16-02]
files_modified:
  - globcrm-web/src/app/features/duplicates/duplicate.models.ts
  - globcrm-web/src/app/features/duplicates/duplicate.service.ts
  - globcrm-web/src/app/features/duplicates/duplicates.routes.ts
  - globcrm-web/src/app/features/duplicates/duplicate-scan/duplicate-scan.component.ts
  - globcrm-web/src/app/features/duplicates/merge-comparison/merge-comparison.component.ts
  - globcrm-web/src/app/app.routes.ts
  - globcrm-web/src/app/shared/components/navbar/navbar.component.ts
autonomous: true
requirements: [DUP-02, DUP-04, DUP-05, DUP-06, DUP-07]

must_haves:
  truths:
    - "User can navigate to a duplicate scan page and see paginated results of potential duplicates sorted by confidence score"
    - "Each duplicate pair shows match percentage as a colored badge and action buttons to Compare or Dismiss"
    - "User can navigate to a side-by-side comparison page showing all fields with differences highlighted in amber"
    - "User can select field values via radio buttons per row to choose which value survives the merge"
    - "Most recently updated record is auto-selected as primary with option to flip"
    - "User sees a confirmation dialog with transfer counts before executing merge"
    - "After successful merge, user is navigated to the survivor's detail page with a success snackbar"
  artifacts:
    - path: "globcrm-web/src/app/features/duplicates/duplicate.models.ts"
      provides: "TypeScript interfaces for duplicate detection"
      contains: "DuplicateMatch"
    - path: "globcrm-web/src/app/features/duplicates/duplicate.service.ts"
      provides: "API client for duplicate endpoints"
      contains: "DuplicateService"
    - path: "globcrm-web/src/app/features/duplicates/duplicate-scan/duplicate-scan.component.ts"
      provides: "On-demand scan page"
      contains: "DuplicateScanComponent"
    - path: "globcrm-web/src/app/features/duplicates/merge-comparison/merge-comparison.component.ts"
      provides: "Side-by-side comparison and merge page"
      contains: "MergeComparisonComponent"
  key_links:
    - from: "DuplicateService"
      to: "/api/duplicates/*"
      via: "ApiService HTTP calls"
      pattern: "apiService.*duplicates"
    - from: "DuplicateScanComponent"
      to: "MergeComparisonComponent"
      via: "Router navigation with query params (ids)"
      pattern: "router.navigate.*merge"
    - from: "MergeComparisonComponent"
      to: "DuplicateService.mergeContacts/mergeCompanies"
      via: "Merge button click -> service call"
      pattern: "merge(Contacts|Companies)"
---

<objective>
Create the complete frontend for duplicate scanning and merging: models, service, routes, the on-demand scan page with paginated results, and the side-by-side merge comparison page with field selection and merge execution.

Purpose: Users need a scan page to find duplicates and a comparison page to review and merge them. This is the primary user-facing feature of Phase 16.
Output: Duplicates feature area with scan page, merge comparison page, service, models, and routes.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-duplicate-detection-merge/16-RESEARCH.md
@.planning/phases/16-duplicate-detection-merge/16-02-SUMMARY.md
@globcrm-web/src/app/features/contacts/contact.models.ts
@globcrm-web/src/app/features/contacts/contact.service.ts
@globcrm-web/src/app/features/contacts/contacts.routes.ts
@globcrm-web/src/app/shared/components/navbar/navbar.component.ts
@globcrm-web/src/app/app.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Models, service, routes, and duplicate scan page</name>
  <files>
    globcrm-web/src/app/features/duplicates/duplicate.models.ts
    globcrm-web/src/app/features/duplicates/duplicate.service.ts
    globcrm-web/src/app/features/duplicates/duplicates.routes.ts
    globcrm-web/src/app/features/duplicates/duplicate-scan/duplicate-scan.component.ts
    globcrm-web/src/app/app.routes.ts
    globcrm-web/src/app/shared/components/navbar/navbar.component.ts
  </files>
  <action>
    1. **Create duplicate.models.ts** (globcrm-web/src/app/features/duplicates/duplicate.models.ts):
       ```typescript
       export interface DuplicateMatch {
         id: string;
         fullName?: string;     // For contacts
         name?: string;         // For companies
         email?: string;
         phone?: string;
         companyName?: string;  // For contacts
         website?: string;      // For companies
         score: number;         // 0-100
         updatedAt: string;
       }

       export interface DuplicatePair {
         recordA: DuplicateMatch;
         recordB: DuplicateMatch;
         score: number;
       }

       export interface DuplicateScanResult {
         items: DuplicatePair[];
         totalCount: number;
         page: number;
         pageSize: number;
       }

       export interface MergePreview {
         dealCount: number;
         quoteCount: number;
         requestCount: number;
         noteCount: number;
         attachmentCount: number;
         activityCount: number;
         emailCount: number;
         feedItemCount: number;
         notificationCount: number;
         totalCount: number;
       }

       export interface MergeRequest {
         survivorId: string;
         loserId: string;
         fieldSelections: Record<string, any>;
       }

       export interface MergeResult {
         survivorId: string;
         transferCounts: Record<string, number>;
         mergedAt: string;
       }

       export interface DuplicateSettings {
         id: string;
         entityType: string;
         autoDetectionEnabled: boolean;
         similarityThreshold: number;
         matchingFields: string[];
         updatedAt: string;
       }

       export interface ContactComparison {
         contact: any;  // Full contact DTO
         otherContact: any;
       }

       export interface CompanyComparison {
         company: any;  // Full company DTO
         otherCompany: any;
       }
       ```

    2. **Create duplicate.service.ts** (globcrm-web/src/app/features/duplicates/duplicate.service.ts):
       - Injectable service following established pattern (inject ApiService)
       - Methods:
         * `checkContactDuplicates(request: { firstName: string; lastName: string; email?: string }): Observable<DuplicateMatch[]>`
         * `checkCompanyDuplicates(request: { name: string; website?: string }): Observable<DuplicateMatch[]>`
         * `scanContacts(page: number, pageSize: number): Observable<DuplicateScanResult>`
         * `scanCompanies(page: number, pageSize: number): Observable<DuplicateScanResult>`
         * `getContactMergePreview(survivorId: string, loserId: string): Observable<MergePreview>`
         * `getCompanyMergePreview(survivorId: string, loserId: string): Observable<MergePreview>`
         * `mergeContacts(request: MergeRequest): Observable<MergeResult>`
         * `mergeCompanies(request: MergeRequest): Observable<MergeResult>`
         * `getContactComparison(id: string, otherId: string): Observable<any>` — calls comparison endpoint
         * `getCompanyComparison(id: string, otherId: string): Observable<any>`
         * `getSettings(): Observable<DuplicateSettings[]>`
         * `updateSettings(entityType: string, request: any): Observable<DuplicateSettings>`

    3. **Create duplicates.routes.ts** (globcrm-web/src/app/features/duplicates/duplicates.routes.ts):
       ```typescript
       export const duplicatesRoutes: Routes = [
         { path: '', redirectTo: 'scan', pathMatch: 'full' },
         { path: 'scan', loadComponent: () => import('./duplicate-scan/duplicate-scan.component').then(m => m.DuplicateScanComponent) },
         { path: 'merge', loadComponent: () => import('./merge-comparison/merge-comparison.component').then(m => m.MergeComparisonComponent) },
       ];
       ```

    4. **Register route in app.routes.ts**: Add lazy-loaded duplicates feature:
       ```typescript
       { path: 'duplicates', loadChildren: () => import('./features/duplicates/duplicates.routes').then(m => m.duplicatesRoutes), canActivate: [authGuard] }
       ```

    5. **Add nav item in navbar.component.ts**: Add "Duplicates" link in the navigation (in a suitable group, e.g., Tools or Data group). Use mat-icon "compare_arrows" or "people_alt".

    6. **Create DuplicateScanComponent** (globcrm-web/src/app/features/duplicates/duplicate-scan/duplicate-scan.component.ts):
       - Standalone component with OnPush change detection
       - Template structure:
         * Header: "Duplicate Detection" title with subtitle "Find and merge duplicate records"
         * Entity type toggle: mat-button-toggle-group for "Contacts" / "Companies" (default: Contacts)
         * "Run Scan" button (mat-raised-button, primary color) triggers scan
         * Results section:
           - Loading spinner during scan
           - Empty state: "No duplicates found" with check icon
           - Results list using mat-list or custom card layout:
             * Each DuplicatePair row shows:
               - Record A: name + email (or company name + website)
               - Record B: name + email (or company name + website)
               - Score badge: colored pill (green >85%, amber 70-85%, red <70%) showing "87% match"
               - Action buttons: "Compare" (navigates to merge page), "Dismiss" (removes from list, client-side only)
           - Pagination: mat-paginator at bottom with page size options [10, 20, 50]
       - Signals: entityType (signal), scanResults (signal), loading (signal), page/pageSize signals
       - On "Run Scan": call `duplicateService.scanContacts()` or `scanCompanies()` based on toggle
       - On "Compare": navigate to `/duplicates/merge?entityType=contact&id1={recordA.id}&id2={recordB.id}`
       - Style: Use `src/styles/_entity-list.scss` pattern for consistency. Score badges use CSS custom properties for colors.
  </action>
  <verify>
    `cd globcrm-web && npm run build` succeeds.
    Route `/duplicates/scan` loads the scan component.
    NavItem "Duplicates" appears in navigation bar.
  </verify>
  <done>
    Duplicate feature area exists with models, service (all API endpoints covered), routes, and the scan page. Scan page shows paginated duplicate pairs with confidence scores as colored badges, entity type toggle, and Compare/Dismiss actions. Navigation includes Duplicates link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Merge comparison page with side-by-side layout, field selection, and merge execution</name>
  <files>
    globcrm-web/src/app/features/duplicates/merge-comparison/merge-comparison.component.ts
  </files>
  <action>
    Create MergeComparisonComponent as a full dedicated page at `/duplicates/merge?entityType=contact&id1=X&id2=Y`.

    **Layout (per locked decision: two-column side-by-side):**

    1. **Header section:**
       - Title: "Merge [Contacts/Companies]"
       - Back button to return to scan results
       - Primary record indicator: "Most recently updated" badge on the auto-selected primary

    2. **Primary selector:**
       - Two record cards at the top showing name/email/company of each record
       - Radio button or toggle to select which is the "surviving" record (default: most recently updated)
       - "Swap Primary" button to flip the selection

    3. **Field comparison table (main content):**
       - Full-width table/grid with columns: Field Name | Record A Value | Selection (radio) | Record B Value
       - For each field row:
         * Field label on the left
         * Record A value
         * Radio button group (two options: A or B) — default: primary record's value selected
         * Record B value
         * **Difference highlighting (per locked decision):** If values differ, highlight both cells in amber/yellow background. If values match, show in gray/muted.
       - Standard fields (for contacts): FirstName, LastName, Email, Phone, MobilePhone, JobTitle, Department, Address, City, State, Country, PostalCode, Description, OwnerId (show owner name)
       - Standard fields (for companies): Name, Industry, Website, Phone, Email, Address, City, State, Country, PostalCode, Size, Description, OwnerId
       - **Custom fields (per locked decision):** Load custom field definitions for the entity type. Display custom field values in the comparison table just like standard fields, with radio selection per field.

    4. **Relationship summary section:**
       - Below the field table, show a summary card with relationship counts from merge-preview endpoint
       - Format: "Relationships to be transferred from [loser name] to [survivor name]:"
       - List: "3 Deals, 5 Notes, 2 Attachments, 8 Activities, 1 Email Thread" etc.
       - Only show non-zero counts

    5. **Action footer:**
       - "Cancel" button (navigates back)
       - "Merge Records" button (mat-raised-button, warn color)
       - On "Merge Records" click: Open confirmation dialog (mat-dialog)

    6. **Confirmation dialog (per locked decision):**
       - Title: "Confirm Merge"
       - Content: Summary of what will happen:
         * "Surviving record: [name]"
         * "Record to merge: [name]"
         * "X deals, Y notes, Z attachments will be transferred"
         * "Field values: [count] fields selected from each record"
         * Warning: "This action cannot be easily undone."
       - Buttons: "Cancel" and "Confirm Merge" (warn color)
       - On confirm: Show loading overlay on the page with "Merging records..." text
       - Call `duplicateService.mergeContacts()` or `mergeCompanies()` with survivorId, loserId, and fieldSelections dictionary
       - On success: Navigate to survivor detail page (`/contacts/{survivorId}` or `/companies/{survivorId}`) with success snackbar "Records merged successfully"
       - On error: Show error snackbar "Merge failed. No changes were made." and re-enable the merge button

    **Implementation details:**
    - Read query params `entityType`, `id1`, `id2` from route using input() binding (withComponentInputBinding)
    - On init, call comparison endpoint to load both full records
    - Also call merge-preview endpoint to load relationship counts
    - Build a `fieldRows` computed signal from both records, comparing each field value
    - Track field selections in a signal: `Record<string, 'a' | 'b'>` defaulting to primary record
    - On merge, convert selections to `fieldSelections: Record<string, any>` mapping field names to chosen values
    - Responsive: On screens < 768px, stack columns vertically using CSS grid `grid-template-columns: 1fr` instead of `1fr 1fr`
    - Disable "Merge Records" button during merge operation to prevent double-submit
  </action>
  <verify>
    `cd globcrm-web && npm run build` succeeds.
    Route `/duplicates/merge?entityType=contact&id1=X&id2=Y` loads the comparison component.
    Component has field comparison table, radio selection, relationship summary, and merge button with confirmation dialog.
  </verify>
  <done>
    Full merge comparison page with two-column side-by-side layout. Each field row has radio buttons for value selection. Differences highlighted in amber, matches in gray. Primary auto-selected by most recently updated, flippable. Custom fields displayed alongside standard fields. Confirmation dialog shows transfer counts. Merge execution navigates to survivor with success snackbar. Responsive layout stacks on mobile.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npm run build` — 0 errors
2. Route `/duplicates/scan` loads scan page with entity type toggle and paginated results
3. Route `/duplicates/merge?entityType=contact&id1=X&id2=Y` loads comparison page
4. DuplicateService covers all API endpoints (check, scan, preview, merge, comparison, settings)
5. Navigation bar includes "Duplicates" link
6. Comparison page has radio buttons per field row, difference highlighting, and merge confirmation dialog
</verification>

<success_criteria>
- User can scan for duplicate contacts or companies and see results sorted by confidence with colored score badges
- User can navigate from scan results to side-by-side comparison page
- Comparison page shows all standard and custom fields with amber highlighting for differences
- User can select values via radio buttons and see relationship transfer counts
- Confirmation dialog shows explicit counts before merge execution
- After merge, user is redirected to survivor's detail page with success message
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-duplicate-detection-merge/16-03-SUMMARY.md`
</output>
