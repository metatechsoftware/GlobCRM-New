---
phase: 16-duplicate-detection-merge
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified:
  - src/GlobCRM.Api/Controllers/DuplicatesController.cs
  - src/GlobCRM.Api/Controllers/DuplicateSettingsController.cs
  - src/GlobCRM.Api/Controllers/ContactsController.cs
  - src/GlobCRM.Api/Controllers/CompaniesController.cs
autonomous: true
requirements: [DUP-01, DUP-02, DUP-03, DUP-04, DUP-05, DUP-06, DUP-07]

must_haves:
  truths:
    - "POST /api/duplicates/check/contacts returns scored duplicate matches for real-time create warnings"
    - "POST /api/duplicates/check/companies returns scored duplicate matches for real-time create warnings"
    - "GET /api/duplicates/scan/contacts returns paginated on-demand scan results sorted by confidence"
    - "GET /api/duplicates/scan/companies returns paginated on-demand scan results sorted by confidence"
    - "GET /api/duplicates/merge-preview/contacts returns relationship transfer counts for merge confirmation dialog"
    - "POST /api/duplicates/merge/contacts executes contact merge and returns result with transfer counts"
    - "POST /api/duplicates/merge/companies executes company merge and returns result with transfer counts"
    - "GET /api/duplicate-settings returns and PUT /api/duplicate-settings updates matching config per entity type"
    - "GET /api/contacts/{id} returns 301 with mergedIntoId when accessing a merged contact"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/DuplicatesController.cs"
      provides: "Duplicate check, scan, merge-preview, and merge endpoints"
      contains: "DuplicatesController"
    - path: "src/GlobCRM.Api/Controllers/DuplicateSettingsController.cs"
      provides: "Admin matching config CRUD"
      contains: "DuplicateSettingsController"
  key_links:
    - from: "DuplicatesController"
      to: "DuplicateDetectionService"
      via: "FindContactDuplicatesAsync/FindCompanyDuplicatesAsync"
      pattern: "FindContact|FindCompany"
    - from: "DuplicatesController"
      to: "ContactMergeService/CompanyMergeService"
      via: "MergeAsync"
      pattern: "MergeAsync"
    - from: "ContactsController/CompaniesController"
      to: "MergedIntoId redirect"
      via: "GetById checks MergedIntoId and returns redirect"
      pattern: "MergedIntoId.*null.*redirect"
---

<objective>
Create the complete API layer for duplicate detection and merge: DuplicatesController (check, scan, merge-preview, merge endpoints for both contacts and companies), DuplicateSettingsController (admin matching config CRUD), and merged-record redirect handling in existing Contact/Company controllers.

Purpose: The frontend (Plans 03-04) needs these endpoints to implement the scan page, comparison/merge page, admin settings, and create form warnings.
Output: Two new controllers with all duplicate/merge endpoints, plus modified Contact/Company controllers for merged-record redirect.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-duplicate-detection-merge/16-RESEARCH.md
@.planning/phases/16-duplicate-detection-merge/16-01-SUMMARY.md
@src/GlobCRM.Api/Controllers/ContactsController.cs
@src/GlobCRM.Api/Controllers/CompaniesController.cs
@src/GlobCRM.Api/Controllers/LeadsController.cs (conversion endpoint pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: DuplicatesController with check, scan, merge-preview, and merge endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/DuplicatesController.cs
  </files>
  <action>
    Create DuplicatesController at route `api/duplicates`. Follow the existing controller pattern (DTOs, request records, and validators co-located in the same file using static FromEntity/FromResult factory methods).

    **Endpoints:**

    1. **POST /api/duplicates/check/contacts** — Real-time duplicate check for contact create forms
       - Request body: `CheckContactDuplicatesRequest { FirstName, LastName, Email }`
       - Load DuplicateMatchingConfig for "Contact" entity type. If AutoDetectionEnabled is false, return empty array.
       - Call `DuplicateDetectionService.FindContactDuplicatesAsync()` with configured threshold (default 70).
       - Response: Array of `DuplicateMatchDto { Id, FullName, Email, Phone, CompanyName, Score, UpdatedAt }`
       - Permission: `Permission:Contact:View`

    2. **POST /api/duplicates/check/companies** — Real-time duplicate check for company create forms
       - Request body: `CheckCompanyDuplicatesRequest { Name, Website }`
       - Load config for "Company". Same auto-detection check.
       - Call `DuplicateDetectionService.FindCompanyDuplicatesAsync()`
       - Response: Array of `DuplicateMatchDto { Id, Name, Website, Email, Phone, Score, UpdatedAt }`
       - Permission: `Permission:Company:View`

    3. **GET /api/duplicates/scan/contacts?page=1&pageSize=20** — On-demand duplicate scan
       - Load config threshold or use default 70.
       - Call `DuplicateDetectionService.ScanContactDuplicatesAsync(threshold, page, pageSize)`
       - Response: Paginated `DuplicateScanResultDto` with items as `DuplicatePairDto { RecordA: DuplicateMatchDto, RecordB: DuplicateMatchDto, Score }`
       - Permission: `Permission:Contact:View`

    4. **GET /api/duplicates/scan/companies?page=1&pageSize=20** — On-demand company scan
       - Same pattern as contact scan.
       - Permission: `Permission:Company:View`

    5. **GET /api/duplicates/merge-preview/contacts?survivorId=X&loserId=Y** — Merge confirmation preview
       - Count all relationships that will be transferred from loser using direct db queries.
       - Counts: DealContacts, Quotes, Requests, EmailMessages, EmailThreads, Notes (polymorphic), Attachments (polymorphic), ActivityLinks (polymorphic), FeedItems (polymorphic), Notifications (polymorphic), Leads (converted_contact_id), LeadConversions.
       - Response: `MergePreviewDto { DealCount, QuoteCount, RequestCount, NoteCount, AttachmentCount, ActivityCount, EmailCount, FeedItemCount, NotificationCount, TotalCount }`
       - Permission: `Permission:Contact:Edit`

    6. **GET /api/duplicates/merge-preview/companies?survivorId=X&loserId=Y** — Company merge preview
       - Same pattern: count Contacts, Deals, Quotes, Requests, EmailMessages, EmailThreads, Notes, Attachments, ActivityLinks, FeedItems, Notifications (polymorphic), Leads, LeadConversions.
       - Permission: `Permission:Company:Edit`

    7. **POST /api/duplicates/merge/contacts** — Execute contact merge
       - Request body: `MergeContactsRequest { SurvivorId, LoserId, FieldSelections (Dictionary of string to object?) }`
       - FluentValidation: SurvivorId and LoserId required, must be different.
       - Call `ContactMergeService.MergeAsync()`
       - Response: `MergeResultDto { SurvivorId, TransferCounts, MergedAt }`
       - Permission: `Permission:Contact:Edit`

    8. **POST /api/duplicates/merge/companies** — Execute company merge
       - Request body: `MergeCompaniesRequest { SurvivorId, LoserId, FieldSelections }`
       - Call `CompanyMergeService.MergeAsync()`
       - Permission: `Permission:Company:Edit`

    9. **GET /api/duplicates/contacts/{id}/comparison** — Get two contact records for side-by-side comparison
       - Query params: `otherId=Y`
       - Return both full Contact DTOs with all standard fields and custom fields for comparison UI.
       - Use IgnoreQueryFilters to also load merged records (in case one was recently merged).
       - Permission: `Permission:Contact:View`

    10. **GET /api/duplicates/companies/{id}/comparison** — Get two company records for comparison
        - Same pattern as contacts.
        - Permission: `Permission:Company:View`

    **DTOs** (co-located in DuplicatesController.cs):
    - CheckContactDuplicatesRequest, CheckCompanyDuplicatesRequest
    - DuplicateMatchDto (with static FromResult factory)
    - DuplicatePairDto, DuplicateScanResultDto (paginated wrapper)
    - MergePreviewDto
    - MergeContactsRequest, MergeCompaniesRequest
    - MergeResultDto
    - ContactComparisonDto, CompanyComparisonDto
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors.
    All 10 endpoints are defined in the controller.
  </verify>
  <done>
    DuplicatesController has 10 endpoints covering all duplicate check, scan, merge-preview, comparison, and merge operations for both contacts and companies. DTOs use static factory methods. Permission policies protect all endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: DuplicateSettingsController and merged-record redirect in Contact/Company controllers</name>
  <files>
    src/GlobCRM.Api/Controllers/DuplicateSettingsController.cs
    src/GlobCRM.Api/Controllers/ContactsController.cs
    src/GlobCRM.Api/Controllers/CompaniesController.cs
  </files>
  <action>
    1. **Create DuplicateSettingsController** at route `api/duplicate-settings`:
       - **GET /api/duplicate-settings** — List all matching configs (Contact + Company)
         * Query DuplicateMatchingConfig for tenant. If none exist, return default configs (auto-created).
         * Response: Array of `DuplicateSettingsDto { Id, EntityType, AutoDetectionEnabled, SimilarityThreshold, MatchingFields, UpdatedAt }`
         * Permission: `Roles = "Admin"`

       - **GET /api/duplicate-settings/{entityType}** — Get config for specific entity type
         * entityType is "Contact" or "Company"
         * If no config exists, create default and return it
         * Permission: `Roles = "Admin"`

       - **PUT /api/duplicate-settings/{entityType}** — Update matching config
         * Request: `UpdateDuplicateSettingsRequest { AutoDetectionEnabled, SimilarityThreshold (range 50-100), MatchingFields }`
         * FluentValidation: SimilarityThreshold between 50 and 100, EntityType must be "Contact" or "Company"
         * Create or update DuplicateMatchingConfig for the tenant + entity type
         * Permission: `Roles = "Admin"`

       DTOs co-located in file:
       - DuplicateSettingsDto with static FromEntity factory
       - UpdateDuplicateSettingsRequest with FluentValidation validator

    2. **Modify ContactsController GetById endpoint**:
       - In the GET /api/contacts/{id} endpoint, after attempting to find the contact:
       - If not found in normal query (filtered by MergedIntoId == null), do a secondary query with IgnoreQueryFilters to check if it exists with MergedIntoId != null
       - If found with MergedIntoId: return a JSON response with status 301 (or a custom 200 with redirect info) containing `{ mergedIntoId: "{guid}" }`. Use a custom response type like `MergedRedirectDto { MergedIntoId }`.
       - This allows the frontend to detect merged records and redirect to the survivor.
       - If truly not found: return 404 as before.

    3. **Modify CompaniesController GetById endpoint**:
       - Same merged-record redirect logic as ContactsController.
       - Check for MergedIntoId on 404, return redirect info if merged.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors.
    DuplicateSettingsController has 3 endpoints for admin config management.
    ContactsController and CompaniesController GetById returns redirect info for merged records.
  </verify>
  <done>
    Admin can GET and PUT matching config per entity type via DuplicateSettingsController. Contact and Company GetById endpoints detect merged records and return MergedIntoId redirect info instead of 404. All endpoints have proper permission policies and FluentValidation.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors
2. All 13 new endpoints compile and register correctly (10 in DuplicatesController + 3 in DuplicateSettingsController)
3. ContactsController and CompaniesController GetById handle merged records
4. FluentValidation validators are defined for all request types
5. Permission policies (Permission:Contact:View/Edit, Permission:Company:View/Edit, Admin role) are applied correctly
</verification>

<success_criteria>
- DuplicatesController exposes check, scan, merge-preview, comparison, and merge endpoints for both contacts and companies
- DuplicateSettingsController allows admin to configure matching rules per entity type
- Merged records are handled with redirect info in Contact/Company GetById
- All endpoints follow established patterns: co-located DTOs, static factory methods, FluentValidation
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-duplicate-detection-merge/16-02-SUMMARY.md`
</output>
