---
phase: 21-integration-polish-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs
  - src/GlobCRM.Api/Program.cs
  - src/GlobCRM.Domain/Interfaces/IDuplicateDetectionService.cs
  - src/GlobCRM.Infrastructure/Duplicates/DuplicateDetectionService.cs
  - src/GlobCRM.Api/Controllers/DuplicatesController.cs
autonomous: true
requirements:
  - RPT-06

must_haves:
  truths:
    - "ReportCsvExportJob is registered in DI and can be resolved by Hangfire without activation errors"
    - "No duplicate AddDomainEventServices() or AddEmailTemplateServices() calls exist in Program.cs"
    - "DuplicatesController company match DTO mapping reads Website from a semantically named property, not Email"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs"
      provides: "ReportCsvExportJob DI registration"
      contains: "AddScoped<ReportCsvExportJob>"
    - path: "src/GlobCRM.Api/Program.cs"
      provides: "Clean DI pipeline without duplicate registrations"
    - path: "src/GlobCRM.Domain/Interfaces/IDuplicateDetectionService.cs"
      provides: "DuplicateMatch record with explicit SecondaryField property"
    - path: "src/GlobCRM.Infrastructure/Duplicates/DuplicateDetectionService.cs"
      provides: "DuplicateMatch construction using SecondaryField for companies"
    - path: "src/GlobCRM.Api/Controllers/DuplicatesController.cs"
      provides: "Clean DTO mapping without field overloading comments"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs"
      to: "src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs"
      via: "DI registration"
      pattern: "AddScoped<ReportCsvExportJob>"
    - from: "src/GlobCRM.Api/Program.cs"
      to: "src/GlobCRM.Infrastructure/DependencyInjection.cs"
      via: "AddInfrastructure pipeline (canonical call site)"
      pattern: "AddInfrastructure"
---

<objective>
Fix three backend integration gaps identified by the v1.1 milestone audit: register ReportCsvExportJob in DI so CSV export Hangfire jobs resolve correctly, remove duplicate AddDomainEventServices()/AddEmailTemplateServices() calls from Program.cs that are already called via AddInfrastructure(), and refactor the DuplicateMatch record to use a semantically correct property name instead of overloading Email for company Website data.

Purpose: Close INT-01, INT-03, and TD-01 audit gaps. These are surgical fixes that harden the existing system without adding new features.
Output: Three clean backend fixes committed and buildable.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integration-polish-tech-debt/21-RESEARCH.md

@src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs
@src/GlobCRM.Infrastructure/Reporting/ReportCsvExportJob.cs
@src/GlobCRM.Api/Program.cs
@src/GlobCRM.Infrastructure/DependencyInjection.cs
@src/GlobCRM.Domain/Interfaces/IDuplicateDetectionService.cs
@src/GlobCRM.Infrastructure/Duplicates/DuplicateDetectionService.cs
@src/GlobCRM.Api/Controllers/DuplicatesController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register ReportCsvExportJob in DI and remove duplicate service registrations from Program.cs</name>
  <files>
    src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs
    src/GlobCRM.Api/Program.cs
  </files>
  <action>
    **INT-01 fix:** In `ReportingServiceExtensions.cs`, add `services.AddScoped<ReportCsvExportJob>();` after the existing `AddScoped<ReportQueryEngine>()` line. This requires adding a using statement for the job's namespace if not already in scope. All 5 constructor dependencies of ReportCsvExportJob (ApplicationDbContext, ReportQueryEngine, IFileStorageService, IHubContext<CrmHub>, ILogger) are already registered elsewhere in the DI pipeline.

    **INT-03 fix:** In `Program.cs`, remove the duplicate service registration calls:
    - Remove `builder.Services.AddDomainEventServices();` (around line 91) — already called from DependencyInjection.cs line 60 via AddInfrastructure()
    - Remove `builder.Services.AddEmailTemplateServices();` (around line 94) — already called from DependencyInjection.cs line 184 via AddInfrastructure()
    - Also remove their associated comments (lines 90 and 93)

    Verify the canonical calls exist: DependencyInjection.cs calls `services.AddDomainEventServices()` at line 60 and `services.AddEmailTemplateServices()` at line 184. The `builder.Services.AddInfrastructure(...)` call at Program.cs line 58 invokes DependencyInjection.cs.
  </action>
  <verify>Run `cd src/GlobCRM.Api && dotnet build` — must compile without errors. Grep Program.cs for `AddDomainEventServices` and `AddEmailTemplateServices` — neither should appear. Grep ReportingServiceExtensions.cs for `ReportCsvExportJob` — should appear once.</verify>
  <done>ReportCsvExportJob is registered in DI via AddReportingServices(). No duplicate AddDomainEventServices() or AddEmailTemplateServices() calls exist in Program.cs.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor DuplicateMatch record to use SecondaryField instead of overloaded Email property</name>
  <files>
    src/GlobCRM.Domain/Interfaces/IDuplicateDetectionService.cs
    src/GlobCRM.Infrastructure/Duplicates/DuplicateDetectionService.cs
    src/GlobCRM.Api/Controllers/DuplicatesController.cs
  </files>
  <action>
    **TD-01 fix:** The `DuplicateMatch` record overloads its `Email` property to store company Website data, requiring misleading comments at every mapping site. Fix this by adding a `SecondaryField` property to the record.

    1. **IDuplicateDetectionService.cs:** Update the `DuplicateMatch` record definition:
       - Change from: `public record DuplicateMatch(Guid EntityId, string FullName, string? Email, int Score, DateTimeOffset UpdatedAt);`
       - Change to: `public record DuplicateMatch(Guid EntityId, string FullName, string? Email, string? SecondaryField, int Score, DateTimeOffset UpdatedAt);`
       - Add XML doc: `SecondaryField` stores entity-type-specific secondary data (Website for companies, null for contacts).

    2. **DuplicateDetectionService.cs:** Update all `new DuplicateMatch(...)` constructor calls:
       - For **contact** duplicate matches: pass `null` as the `SecondaryField` argument (contacts already use `Email` correctly).
       - For **company** duplicate matches: pass the website value as `SecondaryField` and pass `null` or the actual email (if available) as `Email`. Check how FindCompanyDuplicatesAsync and ScanCompanyDuplicatesAsync construct DuplicateMatch — the value currently in `Email` position should move to `SecondaryField`.

    3. **DuplicatesController.cs:** Update company DTO mappings:
       - At line ~130 (CheckCompanyDuplicates): Change `Website = m.Email` to `Website = m.SecondaryField` and remove the `// DuplicateMatch.Email stores website for companies` comment.
       - At line ~235 (ScanCompanyDuplicates): Same change — `Website = m.SecondaryField` and remove the explanatory comment.
       - Verify contact DTO mappings still use `m.Email` directly (they should be unaffected).
  </action>
  <verify>Run `cd src/GlobCRM.Api && dotnet build` — must compile without errors. Grep DuplicatesController.cs for `m.Email` — should only appear in contact-related mappings, not company. Grep for `m.SecondaryField` — should appear in company-related mappings. No `DuplicateMatch.Email stores website` comments should remain.</verify>
  <done>DuplicateMatch record has explicit SecondaryField property. Company mappings read Website from SecondaryField. No misleading field overloading comments remain. Contact mappings unchanged.</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` compiles without errors
2. `grep -n "ReportCsvExportJob" src/GlobCRM.Infrastructure/Reporting/ReportingServiceExtensions.cs` shows registration line
3. `grep -n "AddDomainEventServices\|AddEmailTemplateServices" src/GlobCRM.Api/Program.cs` returns no results
4. `grep -n "SecondaryField" src/GlobCRM.Domain/Interfaces/IDuplicateDetectionService.cs` shows the new property
5. `grep -n "m\.SecondaryField" src/GlobCRM.Api/Controllers/DuplicatesController.cs` shows company Website mapping
6. No comments containing "DuplicateMatch.Email stores website" remain in the codebase
</verification>

<success_criteria>
- Backend builds cleanly with all three fixes applied
- ReportCsvExportJob is explicitly registered in AddReportingServices()
- Program.cs has no duplicate DI registration calls
- DuplicateMatch uses semantically correct property names without field overloading
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration-polish-tech-debt/21-01-SUMMARY.md`
</output>
