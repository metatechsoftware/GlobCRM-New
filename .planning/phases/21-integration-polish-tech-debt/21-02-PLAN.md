---
phase: 21-integration-polish-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html
  - globcrm-web/src/app/features/email-templates/email-template.service.ts
  - src/GlobCRM.Api/Controllers/EmailTemplatesController.cs
  - src/GlobCRM.Api/Controllers/SequencesController.cs
autonomous: true
requirements:
  - WFLOW-07
  - WFLOW-09

must_haves:
  truths:
    - "Workflow builder Send Email action uses a searchable mat-select dropdown showing template name + subject, not a free-text UUID input"
    - "Workflow builder Enroll in Sequence action uses a searchable mat-select dropdown showing sequence name + step count with status badge, not a free-text UUID input"
    - "Template picker visually highlights templates matching the workflow's trigger entity type (if EntityType category matching is feasible; otherwise all templates appear equal per research gap)"
    - "Both pickers include a search input at the top of the dropdown for filtering"
    - "When opening a workflow with a deleted template/sequence reference, an amber banner warning is shown"
    - "Save is blocked with a clear error if any action references a deleted template/sequence"
    - "On template/sequence deletion, API returns usage count of workflows referencing that item"
    - "At execution time, deleted template/sequence references are already handled (skip + log) — no changes needed"
  artifacts:
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts"
      provides: "Searchable mat-select pickers for email template and sequence selection"
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts"
      provides: "Template/sequence list loading, stale reference detection on open, save validation"
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html"
      provides: "Amber stale reference warning banner in builder UI"
    - path: "src/GlobCRM.Api/Controllers/EmailTemplatesController.cs"
      provides: "GET /api/email-templates/{id}/usage endpoint"
    - path: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      provides: "GET /api/sequences/{id}/usage endpoint"
  key_links:
    - from: "globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts"
      to: "globcrm-web/src/app/features/email-templates/email-template.models.ts"
      via: "EmailTemplateListItem type import for dropdown options"
      pattern: "EmailTemplateListItem"
    - from: "globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts"
      to: "globcrm-web/src/app/features/sequences/sequence.models.ts"
      via: "SequenceListItem type import for dropdown options"
      pattern: "SequenceListItem"
    - from: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts"
      to: "globcrm-web/src/app/features/email-templates/email-template.service.ts"
      via: "inject(EmailTemplateService) for loading template list"
      pattern: "EmailTemplateService"
    - from: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts"
      to: "globcrm-web/src/app/features/sequences/sequence.service.ts"
      via: "inject(SequenceService) for loading sequence list"
      pattern: "SequenceService"
---

<objective>
Replace free-text UUID inputs for "Send Email" and "Enroll in Sequence" workflow actions with searchable mat-select dropdown pickers populated from API data, and implement stale reference handling across the workflow builder (open warning, save validation) and template/sequence deletion endpoints (usage warning).

Purpose: Close INT-02 audit gap. Users currently must paste raw UUID strings to configure email and sequence actions — this makes the workflow builder unusable for normal users. Proper dropdowns with search, name + metadata display, and stale reference safety complete the workflow builder UX.
Output: Fully functional action pickers and stale reference handling system.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-integration-polish-tech-debt/21-RESEARCH.md

@globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts
@globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts
@globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html
@globcrm-web/src/app/features/workflows/workflow.models.ts
@globcrm-web/src/app/features/email-templates/email-template.models.ts
@globcrm-web/src/app/features/email-templates/email-template.service.ts
@globcrm-web/src/app/features/sequences/sequence.models.ts
@globcrm-web/src/app/features/sequences/sequence.service.ts
@src/GlobCRM.Api/Controllers/EmailTemplatesController.cs
@src/GlobCRM.Api/Controllers/SequencesController.cs
@src/GlobCRM.Domain/Entities/Workflow.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace free-text UUID inputs with searchable mat-select dropdowns in ActionConfigComponent</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts
  </files>
  <action>
    Transform the "Send Email" and "Enroll in Sequence" sections in `action-config.component.ts` from free-text UUID inputs to searchable mat-select dropdowns. This component uses inline template, so all changes are in this single file.

    **New inputs (added to component):**
    - `templates = input<EmailTemplateListItem[]>([])` — list of available email templates, loaded by parent
    - `sequences = input<SequenceListItem[]>([])` — list of available sequences, loaded by parent
    - Import `EmailTemplateListItem` from `../../email-templates/email-template.models` (use `../..` relative path — both are under `features/`)
    - Import `SequenceListItem` from `../../sequences/sequence.models`

    **New signals for search filtering:**
    ```typescript
    readonly templateSearch = signal('');
    readonly sequenceSearch = signal('');

    readonly filteredTemplates = computed(() => {
      const search = this.templateSearch().toLowerCase();
      if (!search) return this.templates();
      return this.templates().filter(t =>
        t.name.toLowerCase().includes(search) ||
        (t.subject?.toLowerCase().includes(search) ?? false)
      );
    });

    readonly filteredSequences = computed(() => {
      const search = this.sequenceSearch().toLowerCase();
      if (!search) return this.sequences();
      return this.sequences().filter(s =>
        s.name.toLowerCase().includes(search)
      );
    });
    ```

    **Template entity type highlighting (per locked decision):**
    - Note from research: `EmailTemplateListItem` has no `entityType` field. Templates are entity-agnostic in the current model. Since the field doesn't exist, skip the visual highlighting. All templates appear equally. This is documented as a known gap — the locked decision referenced a capability that requires a model change (adding `targetEntityType` to EmailTemplate), which is out of scope for a hardening phase.

    **Sequence picker: status badge (Claude's discretion):**
    - Show all sequences (not filtered to active-only) with a status badge showing "Active", "Draft", "Paused", "Archived" as a mat-chip or colored text span. This gives users full context.

    **Replace the Send Email template section (currently lines 255-273):**
    Replace the `<mat-form-field>` containing `<input matInput>` for `emailTemplateId` with:
    ```html
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Email Template</mat-label>
      <mat-select [ngModel]="form().emailTemplateId"
                  (ngModelChange)="updateFormField('emailTemplateId', $event)"
                  (opened)="templateSearch.set('')">
        <div class="select-search">
          <mat-icon>search</mat-icon>
          <input matInput
                 placeholder="Search templates..."
                 [value]="templateSearch()"
                 (input)="templateSearch.set($any($event.target).value)"
                 (keydown)="$event.stopPropagation()" />
        </div>
        @for (t of filteredTemplates(); track t.id) {
          <mat-option [value]="t.id">
            <span class="option-name">{{ t.name }}</span>
            @if (t.subject) {
              <span class="option-preview">{{ t.subject }}</span>
            }
          </mat-option>
        }
        @empty {
          <mat-option disabled>No templates found</mat-option>
        }
      </mat-select>
    </mat-form-field>
    ```

    **Replace the Enroll in Sequence section (currently lines 316-322):**
    Replace the `<mat-form-field>` containing `<input matInput>` for `sequenceId` with:
    ```html
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Sequence</mat-label>
      <mat-select [ngModel]="form().sequenceId"
                  (ngModelChange)="updateFormField('sequenceId', $event)"
                  (opened)="sequenceSearch.set('')">
        <div class="select-search">
          <mat-icon>search</mat-icon>
          <input matInput
                 placeholder="Search sequences..."
                 [value]="sequenceSearch()"
                 (input)="sequenceSearch.set($any($event.target).value)"
                 (keydown)="$event.stopPropagation()" />
        </div>
        @for (s of filteredSequences(); track s.id) {
          <mat-option [value]="s.id">
            <span class="option-name">{{ s.name }}</span>
            <span class="option-meta">
              {{ s.stepCount }} {{ s.stepCount === 1 ? 'step' : 'steps' }}
            </span>
            <span class="status-badge" [class]="'status-' + s.status">{{ s.status }}</span>
          </mat-option>
        }
        @empty {
          <mat-option disabled>No sequences found</mat-option>
        }
      </mat-select>
    </mat-form-field>
    ```

    **Add imports:** Add `MatChipsModule` if needed for status badges, or use plain styled spans (simpler, no extra import). Prefer styled spans.

    **Add CSS styles** to the existing inline `styles` section:
    ```css
    .select-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      background: var(--color-surface);
      z-index: 1;

      input {
        border: none;
        outline: none;
        flex: 1;
        font-size: var(--text-sm);
        background: transparent;
      }

      mat-icon {
        font-size: 18px;
        width: 18px;
        height: 18px;
        color: var(--color-text-secondary);
      }
    }

    .option-name {
      display: block;
      font-weight: var(--font-medium);
    }

    .option-preview {
      display: block;
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .option-meta {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-left: 4px;
    }

    .status-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      padding: 1px 6px;
      border-radius: var(--radius-full);
      margin-left: 8px;
    }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-draft { background: #e5e7eb; color: #374151; }
    .status-paused { background: #fef3c7; color: #92400e; }
    .status-archived { background: #fee2e2; color: #991b1b; }
    ```

    **Stale reference display (Claude's discretion):** If the currently selected emailTemplateId or sequenceId is not found in the loaded lists, clear the field value to empty (not a "(Deleted)" ghost option). This makes the broken reference obvious — the field appears blank, prompting the user to select a new one. The amber banner warning in the parent (Task 2) provides additional feedback.
  </action>
  <verify>Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -20` — must compile without errors. Visually inspect that the inline template has mat-select elements instead of matInput for emailTemplateId and sequenceId fields.</verify>
  <done>Send Email section shows a searchable mat-select with template name + subject preview per option. Enroll in Sequence section shows a searchable mat-select with sequence name + step count + status badge. Both include search-at-top filtering. Free-text UUID inputs are removed.</done>
</task>

<task type="auto">
  <name>Task 2: Add template/sequence list loading, stale reference detection, save validation, and usage endpoints</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html
    globcrm-web/src/app/features/email-templates/email-template.service.ts
    src/GlobCRM.Api/Controllers/EmailTemplatesController.cs
    src/GlobCRM.Api/Controllers/SequencesController.cs
  </files>
  <action>
    **Part A: Load template and sequence lists in WorkflowBuilderComponent**

    In `workflow-builder.component.ts`:
    - Inject `EmailTemplateService` and `SequenceService` (both `providedIn: 'root'`)
    - Add signals: `readonly templates = signal<EmailTemplateListItem[]>([])` and `readonly sequences = signal<SequenceListItem[]>([])` and `readonly staleWarnings = signal<string[]>([])`
    - Import types: `EmailTemplateListItem` from `../../email-templates/email-template.models`, `SequenceListItem` from `../../sequences/sequence.models`
    - In `ngOnInit()`, call `this.loadPickerData()` after existing calls
    - Create `loadPickerData()` method:
      ```typescript
      private loadPickerData(): void {
        this.emailTemplateService.getTemplates().subscribe({
          next: (templates) => this.templates.set(templates),
          error: () => this.templates.set([]),
        });
        this.sequenceService.getSequences().subscribe({
          next: (sequences) => this.sequences.set(sequences),
          error: () => this.sequences.set([]),
        });
      }
      ```

    **Part B: Stale reference detection on builder open**

    After loading the workflow definition in `loadWorkflow()`, add stale reference detection. After `this.nodes.set(...)` and `this.connections.set(...)`, and after template/sequence lists are loaded, detect stale references:

    Since templates/sequences load asynchronously, use `forkJoin` or run stale detection via an `effect()` that fires when both the nodes signal and the templates/sequences signals are populated, but only for existing workflows (not new). Alternatively, chain stale detection in the `loadWorkflow` subscribe after `loadPickerData`. The simplest approach:

    Add a method `detectStaleReferences()` that checks the current nodes against loaded templates/sequences:
    ```typescript
    private detectStaleReferences(): void {
      const warnings: string[] = [];
      const templateIds = new Set(this.templates().map(t => t.id));
      const sequenceIds = new Set(this.sequences().map(s => s.id));

      for (const node of this.nodes()) {
        if (node.config?.['actionType'] === 'sendEmail' && node.config?.['emailTemplateId']) {
          if (!templateIds.has(node.config['emailTemplateId'])) {
            warnings.push(`Action "${node.label}" references a deleted email template`);
          }
        }
        if (node.config?.['actionType'] === 'enrollInSequence' && node.config?.['sequenceId']) {
          if (!sequenceIds.has(node.config['sequenceId'])) {
            warnings.push(`Action "${node.label}" references a deleted sequence`);
          }
        }
      }
      this.staleWarnings.set(warnings);
    }
    ```

    Call `detectStaleReferences()` from `loadWorkflow()` after both the workflow AND the picker data are loaded. One clean approach: use `forkJoin` for all three HTTP calls (getWorkflow, getTemplates, getSequences) in loadWorkflow, or use a simple effect that triggers when templates and sequences are populated while nodes are non-empty.

    **Part C: Save validation — block save if stale references exist**

    In the `onSave()` method, before proceeding with the save:
    ```typescript
    // Re-run stale detection before save
    this.detectStaleReferences();
    if (this.staleWarnings().length > 0) {
      this.snackBar.open(
        'Cannot save: ' + this.staleWarnings()[0] + (this.staleWarnings().length > 1 ? ` (+${this.staleWarnings().length - 1} more)` : ''),
        'Dismiss',
        { duration: 5000 }
      );
      return;
    }
    ```

    **Part D: Pass templates and sequences to ActionConfigComponent in the template**

    In `workflow-builder.component.html`, update both `<app-action-config>` usages (the one for `@case ('action')` and the one for `@case ('wait')`) to pass the new inputs:
    ```html
    <app-action-config
      [node]="node"
      [entityType]="entityType()"
      [entityFields]="entityFields()"
      [templates]="templates()"
      [sequences]="sequences()"
      (configChanged)="onConfigChanged(node.id, $event)" />
    ```

    **Part E: Amber stale warning banner in builder HTML**

    In `workflow-builder.component.html`, add an amber warning banner at the top of the builder content area (inside `<div class="builder-content">` before the canvas):
    ```html
    @if (staleWarnings().length > 0) {
      <div class="stale-warning-banner">
        <mat-icon>warning</mat-icon>
        <div class="stale-warning-messages">
          @for (warning of staleWarnings(); track warning) {
            <span>{{ warning }}</span>
          }
        </div>
      </div>
    }
    ```

    Add CSS for the banner either in the component's SCSS or inline. Use amber/warning colors:
    ```css
    .stale-warning-banner {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      margin: 8px 16px;
      color: #92400e;

      mat-icon {
        color: #f59e0b;
        flex-shrink: 0;
      }
    }
    .stale-warning-messages {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    ```

    **Part F: Backend usage endpoints for deletion warnings**

    In `EmailTemplatesController.cs`, add a new endpoint:
    ```csharp
    [HttpGet("{id}/usage")]
    [Authorize(Policy = "Permission:EmailTemplate:View")]
    public async Task<IActionResult> GetTemplateUsage(Guid id)
    {
        // Search workflows whose definition JSON contains this template ID
        var templateIdStr = id.ToString();
        var workflows = await _db.Workflows
            .Where(w => EF.Functions.ILike(
                EF.Property<string>(w, "Definition"),
                $"%{templateIdStr}%"))
            .Select(w => new { w.Id, w.Name })
            .ToListAsync();

        return Ok(new { usedByCount = workflows.Count, workflows });
    }
    ```

    NOTE: The exact query approach depends on how Workflow.Definition is stored. Since it's a JSONB owned type mapped via ToJson(), the simplest reliable approach is to cast definition to text and search with LIKE. Check the actual EF mapping. Alternative approach: use raw SQL `WHERE CAST(definition AS text) LIKE '%{templateIdStr}%'`. Use whichever compiles. If EF Functions doesn't work on JSONB directly, use `_db.Database.SqlQueryRaw` or `FromSqlRaw`.

    In `SequencesController.cs`, add a similar endpoint:
    ```csharp
    [HttpGet("{id}/usage")]
    [Authorize(Policy = "Permission:EmailSequence:View")]
    public async Task<IActionResult> GetSequenceUsage(Guid id)
    {
        var sequenceIdStr = id.ToString();
        var workflows = await _db.Workflows
            .Where(w => EF.Functions.ILike(
                EF.Property<string>(w, "Definition"),
                $"%{sequenceIdStr}%"))
            .Select(w => new { w.Id, w.Name })
            .ToListAsync();

        return Ok(new { usedByCount = workflows.Count, workflows });
    }
    ```

    **Part G: Add getTemplateUsage and getSequenceUsage to frontend services**

    In `email-template.service.ts`, add:
    ```typescript
    getTemplateUsage(id: string): Observable<{ usedByCount: number; workflows: { id: string; name: string }[] }> {
      return this.api.get<{ usedByCount: number; workflows: { id: string; name: string }[] }>(
        `${this.basePath}/${id}/usage`
      );
    }
    ```

    The sequence service method is not strictly needed for this plan since the deletion warning UI is on the template/sequence list pages (not the workflow builder). But add the service method for completeness:
    ```typescript
    // In sequence.service.ts:
    getSequenceUsage(id: string): Observable<{ usedByCount: number; workflows: { id: string; name: string }[] }> {
      return this.api.get<{ usedByCount: number; workflows: { id: string; name: string }[] }>(
        `${this.basePath}/${id}/usage`
      );
    }
    ```

    **Note on deletion warning UI:** The locked decision says "on template/sequence deletion, show a 'Used by N workflows' warning with workflow names before confirming deletion." The actual deletion confirmation dialog lives in the email template list and sequence list pages. If those pages already have delete confirmation dialogs, add a call to the usage endpoint before showing the confirmation. If not, this is out-of-scope for this plan (it's a separate UI concern). At minimum, the backend usage endpoint is available for any consumer to call.
  </action>
  <verify>Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -20` — must compile without errors. Run `cd src/GlobCRM.Api && dotnet build` — must compile without errors. Verify workflow-builder.component.html passes [templates] and [sequences] to app-action-config. Verify staleWarnings signal exists in workflow-builder.component.ts.</verify>
  <done>WorkflowBuilderComponent loads template and sequence lists on init, passes them to ActionConfigComponent. Stale reference detection runs on workflow open and shows amber banner. Save is blocked with error if stale references found. Backend usage endpoints available for deletion warnings. Frontend service methods added.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration development` compiles without errors
2. `cd src/GlobCRM.Api && dotnet build` compiles without errors
3. ActionConfigComponent has mat-select for emailTemplateId and sequenceId (not input matInput)
4. Both mat-selects have search inputs with `(keydown)="$event.stopPropagation()"` to prevent keyboard nav interference
5. WorkflowBuilderComponent.staleWarnings signal populated from node/template/sequence comparison
6. workflow-builder.component.html has stale-warning-banner section
7. onSave() checks staleWarnings before proceeding
8. EmailTemplatesController has GET {id}/usage endpoint
9. SequencesController has GET {id}/usage endpoint
</verification>

<success_criteria>
- Send Email and Enroll in Sequence action panels use mat-select dropdowns with name + metadata display
- Both dropdowns have search-at-top filtering with signal-based reactive computation
- Stale reference detection shows amber banner on builder open
- Save is blocked with clear error for stale references
- Backend usage endpoints support deletion warnings
- All code compiles cleanly (Angular + .NET)
</success_criteria>

<output>
After completion, create `.planning/phases/21-integration-polish-tech-debt/21-02-SUMMARY.md`
</output>
