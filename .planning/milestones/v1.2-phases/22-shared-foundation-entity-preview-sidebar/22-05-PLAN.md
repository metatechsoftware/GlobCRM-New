---
phase: 22-shared-foundation-entity-preview-sidebar
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts
  - globcrm-web/src/app/app.component.ts
autonomous: true
requirements: [PREVIEW-01, PREVIEW-05, PREVIEW-12]
gap_closure: true

must_haves:
  truths:
    - "Association chips show clear hover state (cursor pointer, elevated shadow, opacity change) indicating they are clickable"
    - "Preview sidebar starts below the 56px topbar — no content is hidden behind the fixed content-header"
    - "Feed entity link clicks open the preview sidebar (stale cache cleared)"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts"
      provides: "Effective hover styles overriding Material's internal chip DOM"
      contains: "mdc-chip-hover-state-layer-opacity"
    - path: "globcrm-web/src/app/app.component.ts"
      provides: "Sidebar container positioned below topbar"
      contains: "calc(100vh - 56px)"
  key_links:
    - from: "association-chips.component.ts"
      to: "Material mat-chip internal DOM"
      via: "CSS custom property overrides and ::ng-deep"
      pattern: "mdc-evolution-chip__action--presentational"
    - from: "app.component.ts .app-sidenav-container.has-nav-sidebar"
      to: "navbar content-header (fixed, 56px)"
      via: "margin-top instead of padding-top"
      pattern: "margin-top.*56px"
---

<objective>
Fix 3 UAT gaps from Phase 22 user acceptance testing: (1) clear stale Angular cache causing avatar 404, (2) add visible hover states to association chips overriding Material's internal DOM, (3) fix sidebar overlapping the topbar by switching from padding-top to margin-top layout.

Purpose: Close all UAT issues so Phase 22 can be marked fully shipped.
Output: Two files modified with surgical CSS fixes, cache cleared.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-UAT.md
@globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts
@globcrm-web/src/app/app.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clear stale Angular cache and fix association chip hover styles</name>
  <files>globcrm-web/src/app/shared/components/entity-preview/association-chips.component.ts</files>
  <action>
First, delete the stale Angular build cache:
```
rm -rf globcrm-web/.angular/cache
```
This resolves the avatar 404 error (Test 1). The source code is already correct — the compiled cache was serving an old template that referenced default-avatar.svg.

Then fix association-chips.component.ts hover styles. The current hover styles (lines 54-62) are ineffective because:
1. Material's mat-chip in presentational mode sets `cursor: auto` via `.mdc-evolution-chip__action--presentational`
2. Host-level `:hover` background is hidden by Material's internal chip surface elements
3. Default ViewEncapsulation.Emulated cannot target Material's internal DOM

Replace the existing `mat-chip` styles block (lines 54-62) with:

```css
mat-chip {
  cursor: pointer;
  transition: all 0.15s ease;
  --mdc-chip-elevated-container-color: var(--color-surface, #fff);
  --mdc-chip-hover-state-layer-opacity: 0.12;

  &:hover {
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    --mdc-chip-elevated-container-color: var(--color-highlight, rgba(0, 0, 0, 0.06));
  }
}

::ng-deep .mdc-evolution-chip__action--presentational {
  cursor: pointer !important;
}
```

Key changes:
- Use `--mdc-chip-elevated-container-color` CSS custom property to change chip background on hover (works through Material's internal DOM)
- Set `--mdc-chip-hover-state-layer-opacity: 0.12` so Material shows its built-in hover state layer
- Use `::ng-deep` to override `.mdc-evolution-chip__action--presentational` cursor (the only way to reach Material's internal shadow DOM for cursor)
- Keep `box-shadow` on hover for visual elevation feedback
- Remove the old `background` property from `:hover` (replaced by CSS custom property approach)
  </action>
  <verify>
Run `ls globcrm-web/.angular/cache 2>/dev/null || echo "Cache cleared"` to confirm cache deletion.
Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` to verify the project compiles without errors.
Visually inspect the styles block in association-chips.component.ts to confirm `--mdc-chip-hover-state-layer-opacity`, `--mdc-chip-elevated-container-color`, and `::ng-deep .mdc-evolution-chip__action--presentational` are present.
  </verify>
  <done>
Angular cache is deleted. Association chips component has Material CSS custom property overrides for hover background, hover state layer opacity of 0.12, cursor:pointer via ::ng-deep on presentational action, and box-shadow on hover. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix sidebar overlapping topbar by switching padding-top to margin-top</name>
  <files>globcrm-web/src/app/app.component.ts</files>
  <action>
In app.component.ts inline styles, find the `.app-sidenav-container.has-nav-sidebar` rule (currently around lines 57-61):

Current:
```css
.app-sidenav-container.has-nav-sidebar {
  margin-left: 240px;
  padding-top: 56px;
  transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
```

The problem: `padding-top: 56px` pushes the `mat-sidenav-content` down but the `mat-sidenav` panel is absolutely positioned inside the container, filling from y=0. The top 56px of the sidebar panel is hidden behind the fixed content-header (z-index 1029).

Change to:
```css
.app-sidenav-container.has-nav-sidebar {
  margin-left: 240px;
  height: calc(100vh - 56px);
  margin-top: 56px;
  transition: margin-left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
```

Also update the parent `.app-sidenav-container` rule. Current:
```css
.app-sidenav-container {
  height: 100vh;
}
```

This stays as-is for the non-navbar case (auth pages). The `has-nav-sidebar` override with `height: calc(100vh - 56px)` handles the logged-in case.

Key changes:
- Replace `padding-top: 56px` with `margin-top: 56px` — this moves the entire container (including the mat-sidenav panel) below the fixed topbar
- Add `height: calc(100vh - 56px)` — the container now fills the remaining viewport below the topbar, so the sidebar panel fills the correct area
- The mat-sidenav panel (preview drawer) will now start at y=0 of its container, which is positioned at 56px from top of viewport — exactly below the topbar

Do NOT change any other styles. The `.app-content--with-topbar` padding for mobile and the `.preview-drawer` width/border remain unchanged.
  </action>
  <verify>
Run `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5` to confirm the build succeeds.
Inspect app.component.ts to verify:
- `.app-sidenav-container.has-nav-sidebar` has `margin-top: 56px` (not `padding-top`)
- `.app-sidenav-container.has-nav-sidebar` has `height: calc(100vh - 56px)`
- No `padding-top: 56px` remains on `.has-nav-sidebar`
  </verify>
  <done>
The `.app-sidenav-container.has-nav-sidebar` uses `margin-top: 56px` and `height: calc(100vh - 56px)` instead of `padding-top: 56px`. The preview sidebar panel now starts below the topbar, not behind it. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `rm -rf globcrm-web/.angular/cache` — stale cache removed
2. `cd globcrm-web && npx ng build --configuration development` — build succeeds with no errors
3. In browser: Feed page entity link click opens sidebar without avatar 404 error
4. In browser: Hover over association chips — cursor changes to pointer, chip background shifts, subtle shadow appears
5. In browser: Preview sidebar header (close button, entity name) is fully visible below the topbar, not hidden behind it
6. In browser: Escape key and content-area click still close the sidebar (regression check)
</verification>

<success_criteria>
- Angular cache cleared, no stale compiled templates
- Association chips show visible hover state: pointer cursor, background color change via Material CSS custom properties, box-shadow elevation
- Preview sidebar starts below the 56px topbar — sidebar header fully visible and interactive
- Build compiles without errors
- No regressions to existing sidebar open/close/escape behavior
</success_criteria>

<output>
After completion, create `.planning/phases/22-shared-foundation-entity-preview-sidebar/22-05-SUMMARY.md`
</output>
