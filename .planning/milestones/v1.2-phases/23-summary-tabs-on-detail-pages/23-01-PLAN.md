---
phase: 23-summary-tabs-on-detail-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Api/Controllers/CompaniesController.cs
  - src/GlobCRM.Api/Controllers/ContactsController.cs
  - src/GlobCRM.Api/Controllers/DealsController.cs
  - src/GlobCRM.Api/Controllers/LeadsController.cs
  - src/GlobCRM.Api/Controllers/QuotesController.cs
  - src/GlobCRM.Api/Controllers/RequestsController.cs
autonomous: true
requirements:
  - SUMMARY-02
  - SUMMARY-03
  - SUMMARY-04
  - SUMMARY-05
  - SUMMARY-08
  - SUMMARY-09
  - SUMMARY-10
  - SUMMARY-11
  - SUMMARY-12

must_haves:
  truths:
    - "GET /api/companies/{id}/summary returns key properties, association counts, recent/upcoming activities, notes preview, attachment count, last contacted date, and deal pipeline summary in a single response"
    - "GET /api/contacts/{id}/summary returns the same as Company plus email engagement data (last sent/received, total emails, sequence enrollment)"
    - "GET /api/deals/{id}/summary returns key properties, association counts, recent/upcoming activities, notes preview, attachment count, and last contacted date"
    - "GET /api/leads/{id}/summary returns key properties, association counts, recent/upcoming activities, notes preview, attachment count, and last contacted date"
    - "GET /api/quotes/{id}/summary returns key properties, recent/upcoming activities, notes preview, attachment count, and last contacted date"
    - "GET /api/requests/{id}/summary returns key properties, recent/upcoming activities, notes preview, attachment count, and last contacted date"
    - "All summary endpoints use Task.WhenAll for parallel data fetching, not sequential awaits"
    - "All summary endpoints enforce RBAC scope checks matching the existing GetById pattern on each controller"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/CompaniesController.cs"
      provides: "GET {id}/summary endpoint with CompanySummaryDto including DealPipelineSummaryDto"
      contains: "GetSummary"
    - path: "src/GlobCRM.Api/Controllers/ContactsController.cs"
      provides: "GET {id}/summary endpoint with ContactSummaryDto including DealPipelineSummaryDto and EmailEngagementDto"
      contains: "GetSummary"
    - path: "src/GlobCRM.Api/Controllers/DealsController.cs"
      provides: "GET {id}/summary endpoint with DealSummaryDto"
      contains: "GetSummary"
    - path: "src/GlobCRM.Api/Controllers/LeadsController.cs"
      provides: "GET {id}/summary endpoint with LeadSummaryDto"
      contains: "GetSummary"
    - path: "src/GlobCRM.Api/Controllers/QuotesController.cs"
      provides: "GET {id}/summary endpoint with QuoteSummaryDto"
      contains: "GetSummary"
    - path: "src/GlobCRM.Api/Controllers/RequestsController.cs"
      provides: "GET {id}/summary endpoint with RequestSummaryDto"
      contains: "GetSummary"
  key_links:
    - from: "CompaniesController.GetSummary"
      to: "ApplicationDbContext"
      via: "Task.WhenAll batched queries for activities, notes, associations, attachments, pipeline"
      pattern: "Task\\.WhenAll"
    - from: "ContactsController.GetSummary"
      to: "ApplicationDbContext"
      via: "Task.WhenAll batched queries including EmailMessages for engagement stats"
      pattern: "Task\\.WhenAll"
---

<objective>
Create GET {id}/summary endpoints on all 6 entity controllers (Companies, Contacts, Deals, Leads, Quotes, Requests) that return aggregated summary data via a single batched request using Task.WhenAll.

Purpose: The summary tab on each entity detail page needs a single backend endpoint that aggregates key properties, association counts, recent/upcoming activities, notes preview, attachments count, last contacted date, and entity-specific data (deal pipeline for Company/Contact, email engagement for Contact) -- all loaded in one HTTP request.

Output: 6 new controller action methods with co-located summary DTO records, each using parallel Task.WhenAll for all independent sub-queries.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-RESEARCH.md
@.planning/phases/22-shared-foundation-entity-preview-sidebar/22-02-SUMMARY.md
@src/GlobCRM.Api/Controllers/EntityPreviewController.cs
@src/GlobCRM.Api/Controllers/CompaniesController.cs
@src/GlobCRM.Api/Controllers/ContactsController.cs
@src/GlobCRM.Api/Controllers/DealsController.cs
@src/GlobCRM.Api/Controllers/LeadsController.cs
@src/GlobCRM.Api/Controllers/QuotesController.cs
@src/GlobCRM.Api/Controllers/RequestsController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Summary endpoints for Company, Contact, and Deal controllers</name>
  <files>
    src/GlobCRM.Api/Controllers/CompaniesController.cs
    src/GlobCRM.Api/Controllers/ContactsController.cs
    src/GlobCRM.Api/Controllers/DealsController.cs
  </files>
  <action>
Add a `GET {id:guid}/summary` endpoint to each of the three controllers. Co-locate all summary DTO records at the bottom of each controller file (same pattern as existing DTOs in these files).

**Shared DTO records (define in CompaniesController.cs, reference/redefine in others):**
Since DTOs are co-located per controller file, define these shared shapes in each file that needs them:

```csharp
public record SummaryActivityDto
{
    public Guid Id { get; init; }
    public string Subject { get; init; } = string.Empty;
    public string Type { get; init; } = string.Empty;
    public string Status { get; init; } = string.Empty;
    public DateTimeOffset? DueDate { get; init; }
    public DateTimeOffset CreatedAt { get; init; }
}

public record SummaryNoteDto
{
    public Guid Id { get; init; }
    public string Title { get; init; } = string.Empty;
    public string? Preview { get; init; } // PlainTextBody truncated to 100 chars
    public string? AuthorName { get; init; }
    public DateTimeOffset CreatedAt { get; init; }
}

public record SummaryAssociationDto
{
    public string EntityType { get; init; } = string.Empty;
    public string Label { get; init; } = string.Empty;
    public string Icon { get; init; } = string.Empty;
    public int Count { get; init; }
}

public record DealPipelineSummaryDto
{
    public decimal TotalValue { get; init; }
    public int TotalDeals { get; init; }
    public decimal WinRate { get; init; } // 0.0 to 1.0
    public List<DealStageSummaryDto> DealsByStage { get; init; } = new();
}

public record DealStageSummaryDto
{
    public string StageName { get; init; } = string.Empty;
    public string Color { get; init; } = string.Empty;
    public int Count { get; init; }
    public decimal Value { get; init; }
}
```

**CompaniesController.GetSummary:**
- `[HttpGet("{id:guid}/summary")]` with `[Authorize(Policy = "Permission:Company:View")]`
- Fetch company by ID; 404 if not found; RBAC scope check (same pattern as existing GetById)
- Key properties: Name, Industry, Phone, Email, Website, OwnerName (from Owner nav property), City + Country (combined), Size
- Parallel queries via Task.WhenAll:
  - Recent activities (last 5): JOIN `ActivityLinks` where EntityType="Company" and EntityId=id, JOIN Activity, order by Activity.CreatedAt DESC, take 5, project to SummaryActivityDto (include Subject, Type.ToString(), Status.ToString(), DueDate, CreatedAt)
  - Upcoming activities (not done, due today+): same join but filter `Activity.Status != ActivityStatus.Done` AND `Activity.DueDate >= DateTimeOffset.UtcNow.Date`, order by DueDate ASC, take 5
  - Recent notes (last 3): query `Notes` where EntityType="Company" and EntityId=id, order by CreatedAt DESC, take 3, project to SummaryNoteDto (truncate PlainTextBody to 100 chars via `Substring(0, Math.Min(n.PlainTextBody.Length, 100))`)
  - Association counts: count Contacts where CompanyId=id, count Deals where CompanyId=id, count Activities via ActivityLinks, count Quotes where CompanyId=id, count Requests where CompanyId=id. Return as List<SummaryAssociationDto> with label/icon matching EntityTypeRegistry conventions (e.g., "Contacts"/"people", "Deals"/"handshake")
  - Attachment count: `_db.Attachments.CountAsync(a => a.EntityType == "Company" && a.EntityId == id)`
  - Last contacted: MAX of (most recent completed activity CreatedAt from ActivityLinks, most recent email SentAt from EmailMessages where LinkedCompanyId=id) -- use nullable DateTimeOffset, pick the later of the two
  - Deal pipeline summary: group `_db.Deals.Where(d => d.CompanyId == id)` by stage (join DealStage for name/color), compute count + sum of Value per stage, compute win rate as (deals with IsWon=true) / (deals with IsWon=true OR IsLost=true), handle division by zero (return 0)
- Return `CompanySummaryDto` with all fields assembled from awaited tasks

**ContactsController.GetSummary:**
- Same structure as Company, with these differences:
- Key properties: FirstName + LastName (as FullName), Email, Phone, JobTitle, Company name (from Company nav property), OwnerName, Department
- Association counts: count Companies (0 or 1 based on CompanyId), count Deals via DealContacts join, count Activities via ActivityLinks, count Quotes via contact linkage, count Requests via contact linkage
- Deal pipeline summary: group `_db.Deals.Where(d => d.DealContacts.Any(dc => dc.ContactId == id))` -- deals linked to this contact through DealContacts join table
- Email engagement (Contact-specific): query `_db.EmailMessages.Where(e => e.LinkedContactId == id)`:
  - TotalEmails: count
  - SentCount: count where IsInbound == false
  - ReceivedCount: count where IsInbound == true
  - LastSentAt: max SentAt where IsInbound == false
  - LastReceivedAt: max SentAt where IsInbound == true
  - IsEnrolledInSequence: `_db.SequenceEnrollments.AnyAsync(se => se.ContactId == id && se.Status == SequenceEnrollmentStatus.Active)`
  - SequenceName: if enrolled, get the sequence name from the active enrollment
- Return `ContactSummaryDto` (extends Company pattern with `EmailEngagementDto? EmailEngagement` and `DealPipelineSummaryDto? DealPipeline`)

**DealsController.GetSummary:**
- Key properties: Title, Value (decimal), Probability (int), ExpectedCloseDate, Pipeline name + Stage name (from nav properties), Company name, OwnerName
- Stage info for progress bar: query all stages in this deal's pipeline ordered by SortOrder, include current stage ID -- return as `List<DealStageInfoDto>` with Id, Name, Color, SortOrder, IsCurrent (bool)
- Association counts: count Contacts via DealContacts, count Products via DealProducts, count Activities via ActivityLinks, count Quotes where DealId=id
- No deal pipeline summary (it IS a deal)
- No email engagement
- Return `DealSummaryDto`

Add `DealStageInfoDto` record: `{ Guid Id, string Name, string Color, int SortOrder, bool IsCurrent }`
  </action>
  <verify>
    cd src/GlobCRM.Api && dotnet build 2>&1 | tail -5
    Verify: Build succeeds with 0 errors. Grep for "GetSummary" in all 3 files confirms endpoints exist.
  </verify>
  <done>
    CompaniesController has GET {id}/summary returning CompanySummaryDto with Task.WhenAll batching, 8 key properties, association counts, activities, notes, attachments count, last contacted, and deal pipeline summary.
    ContactsController has GET {id}/summary returning ContactSummaryDto with all Company fields plus email engagement data.
    DealsController has GET {id}/summary returning DealSummaryDto with stage progress info for pipeline stepper.
  </done>
</task>

<task type="auto">
  <name>Task 2: Summary endpoints for Lead, Quote, and Request controllers</name>
  <files>
    src/GlobCRM.Api/Controllers/LeadsController.cs
    src/GlobCRM.Api/Controllers/QuotesController.cs
    src/GlobCRM.Api/Controllers/RequestsController.cs
  </files>
  <action>
Add `GET {id:guid}/summary` endpoints to the remaining three controllers, following the same pattern established in Task 1.

**LeadsController.GetSummary:**
- `[HttpGet("{id:guid}/summary")]` with `[Authorize(Policy = "Permission:Lead:View")]`
- Fetch lead by ID; 404 if not found; RBAC scope check
- Key properties: FirstName + LastName (as FullName), Email, Phone, CompanyName (string field on Lead, not nav property), Source name (from LeadSource nav), Temperature (enum .ToString()), OwnerName
- Stage info for progress bar: query all LeadStages ordered by SortOrder, include current stage ID -- return as `List<LeadStageInfoDto>` with Id, Name, Color, SortOrder, IsCurrent, IsTerminal (for IsConverted/IsLost)
- Parallel queries via Task.WhenAll:
  - Recent activities (last 5): via ActivityLinks where EntityType="Lead"
  - Upcoming activities (not done, due today+): same pattern
  - Recent notes (last 3): via Notes where EntityType="Lead"
  - Association counts: count Activities via ActivityLinks, count Notes where EntityType="Lead"
  - Attachment count
  - Last contacted: MAX of recent activity or recent email to lead's email address
- No deal pipeline summary, no email engagement
- Return `LeadSummaryDto`

**QuotesController.GetSummary:**
- `[HttpGet("{id:guid}/summary")]` with `[Authorize(Policy = "Permission:Quote:View")]`
- Fetch quote by ID; 404 if not found; RBAC scope check
- Key properties: QuoteNumber, Title, Status (enum .ToString()), GrandTotal (decimal), Contact name (nav property), Company name (nav property), IssueDate, ExpiryDate
- Simpler summary per user decision: no pipeline chart, no email card
- Parallel queries via Task.WhenAll:
  - Recent activities (last 5): via ActivityLinks where EntityType="Quote"
  - Upcoming activities: same pattern
  - Recent notes (last 3)
  - Attachment count
  - Last contacted
- Association counts: count Activities, count line items (QuoteLineItems where QuoteId=id)
- Return `QuoteSummaryDto`

**RequestsController.GetSummary:**
- `[HttpGet("{id:guid}/summary")]` with `[Authorize(Policy = "Permission:Request:View")]`
- Fetch request by ID; 404 if not found; RBAC scope check
- Key properties: Subject, Status (enum .ToString()), Priority (enum .ToString()), Category, Contact name (nav property), Company name (nav property), OwnerName, AssignedToName (from AssignedTo user nav property)
- Simpler summary: no pipeline, no email card
- Parallel queries via Task.WhenAll:
  - Recent activities (last 5): via ActivityLinks where EntityType="Request"
  - Upcoming activities: same pattern
  - Recent notes (last 3)
  - Attachment count
  - Last contacted
- Association counts: count Activities
- Return `RequestSummaryDto`

Co-locate all DTO records at the bottom of each controller file. Redefine SummaryActivityDto, SummaryNoteDto, SummaryAssociationDto in each file (they are simple records; co-location per file matches the project convention of no separate DTO project).

Add `LeadStageInfoDto` record: `{ Guid Id, string Name, string Color, int SortOrder, bool IsCurrent, bool IsTerminal }`
  </action>
  <verify>
    cd src/GlobCRM.Api && dotnet build 2>&1 | tail -5
    Verify: Build succeeds. Grep for "GetSummary" in all 3 files confirms endpoints exist.
  </verify>
  <done>
    LeadsController has GET {id}/summary returning LeadSummaryDto with lead stage info for progress bar.
    QuotesController has GET {id}/summary returning QuoteSummaryDto with simpler structure (no pipeline/email).
    RequestsController has GET {id}/summary returning RequestSummaryDto with simpler structure.
    All 6 entity types now have summary endpoints using Task.WhenAll batching.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors
2. All 6 controllers contain a `GetSummary` method with `[HttpGet("{id:guid}/summary")]`
3. All GetSummary methods use `Task.WhenAll` for parallel query execution
4. Company and Contact DTOs include `DealPipelineSummaryDto`
5. Contact DTO includes `EmailEngagementDto`
6. Deal DTO includes `List<DealStageInfoDto>` for stage progress
7. Lead DTO includes `List<LeadStageInfoDto>` for stage progress
8. All DTOs include SummaryActivityDto, SummaryNoteDto, SummaryAssociationDto collections
</verification>

<success_criteria>
All 6 entity summary endpoints compile, follow RBAC patterns, use Task.WhenAll for batched queries, and return complete aggregated DTOs matching the research specifications.
</success_criteria>

<output>
After completion, create `.planning/phases/23-summary-tabs-on-detail-pages/23-01-SUMMARY.md`
</output>
