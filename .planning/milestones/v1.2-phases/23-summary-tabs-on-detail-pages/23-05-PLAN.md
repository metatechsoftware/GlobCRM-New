---
phase: 23-summary-tabs-on-detail-pages
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
  - globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
  - globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
autonomous: true
gap_closure: true
requirements:
  - SUMMARY-11

must_haves:
  truths:
    - "Summary tab 'Last Contacted' field displays the actual date from the backend, not always 'Never'"
    - "Summary tab data auto-refreshes when users perform mutations on sibling tabs of Company, Contact, Deal, and Lead detail pages"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/summary-tab/summary.models.ts"
      provides: "BaseSummaryFields interface with correct field name"
      contains: "lastContacted: string | null"
    - path: "globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html"
      provides: "Template using correct field name"
      contains: "data().lastContacted"
    - path: "globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts"
      provides: "Dirty-flag calls after contact/product link/unlink mutations"
      contains: "this.markSummaryDirty()"
    - path: "globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts"
      provides: "Dirty-flag calls after stage change, reopen, and convert mutations"
      contains: "this.markSummaryDirty()"
  key_links:
    - from: "summary.models.ts BaseSummaryFields.lastContacted"
      to: "backend JSON key 'lastContacted'"
      via: "JSON deserialization"
      pattern: "lastContacted: string \\| null"
    - from: "entity-summary-tab.component.html meta card"
      to: "BaseSummaryFields.lastContacted"
      via: "template binding data().lastContacted"
      pattern: "data\\(\\)\\.lastContacted"
    - from: "deal-detail linkContact/unlinkContact/linkProduct/unlinkProduct"
      to: "markSummaryDirty()"
      via: "subscribe next callback"
      pattern: "this\\.markSummaryDirty\\(\\)"
    - from: "lead-detail onStageClick/onReopen/onConvert"
      to: "markSummaryDirty()"
      via: "subscribe next/afterClosed callback"
      pattern: "this\\.markSummaryDirty\\(\\)"
---

<objective>
Close 2 verification gaps from Phase 23 re-verification:

1. **Last Contacted field name mismatch (SUMMARY-11 blocker):** Rename `lastContactedAt` to `lastContacted` in the frontend model and template to match the backend JSON key, so the "Last Contacted" date actually displays instead of always showing "Never".

2. **Dirty-flag not wired to mutation handlers:** Add `markSummaryDirty()` calls to all mutation handlers in Company, Contact, Deal, and Lead detail components so the Summary tab auto-refreshes when users modify data on sibling tabs.

Purpose: These are final wiring fixes — the infrastructure exists but the last connection step is missing in each case.
Output: 6 files patched; both verification gaps closed.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-summary-tabs-on-detail-pages/23-VERIFICATION.md
@globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
@globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
@globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix lastContacted field name mismatch and wire dirty-flag to all mutation handlers</name>
  <files>
    globcrm-web/src/app/shared/components/summary-tab/summary.models.ts
    globcrm-web/src/app/shared/components/summary-tab/entity-summary-tab.component.html
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/deals/deal-detail/deal-detail.component.ts
    globcrm-web/src/app/features/leads/lead-detail/lead-detail.component.ts
  </files>
  <action>
    **Gap 1 — Fix lastContacted field name (SUMMARY-11):**

    1. In `summary.models.ts`, line 92, rename `lastContactedAt: string | null` to `lastContacted: string | null` in the `BaseSummaryFields` interface. This makes the TypeScript field match the backend JSON key `lastContacted` (serialized from C# property `LastContacted`).

    2. In `entity-summary-tab.component.html`, around lines 416-417 in the meta card section, change:
       - `data().lastContactedAt` → `data().lastContacted` (the @if condition)
       - `data().lastContactedAt | date:'mediumDate'` → `data().lastContacted | date:'mediumDate'` (the display binding)

    **Gap 2 — Wire markSummaryDirty() to mutation handlers:**

    The pattern to follow: Quote detail calls `this.markSummaryDirty()` in the subscribe `next` callback after a successful status update (line 375). Apply the same pattern to all mutation handlers in the 4 detail components.

    3. **Deal detail** (`deal-detail.component.ts`): Add `this.markSummaryDirty()` in the `next` callback of these 4 methods:
       - `linkContact()` — after `this.loadTimeline()` (~line 478)
       - `unlinkContact()` — inside the confirmed block after `this.loadTimeline()` (~line 499)
       - `linkProduct()` — after `this.loadTimeline()` (~line 579)
       - `unlinkProduct()` — inside the confirmed block after `this.loadTimeline()` (~line 600)

    4. **Lead detail** (`lead-detail.component.ts`): Add `this.markSummaryDirty()` in the `next`/`afterClosed` callback of these 3 methods:
       - `onStageClick()` — after `this.loadTimeline()` (~line 352)
       - `onReopen()` — after `this.loadTimeline()` (~line 381)
       - `onConvert()` — inside the `if (result)` block after `this.loadTimeline()` (~line 407)

    5. **Company detail** (`company-detail.component.ts`): The Company detail page has no inline mutation handlers in sibling tabs (contacts/deals/activities/quotes/requests/emails/notes tabs are all read-only display lists with router navigation links — mutations happen on the target entity's own page). However, to future-proof and match the pattern, the `onDelete()` method navigates away so no dirty flag is needed there. The only mutation-like operations are the quick action handlers `onSummaryAddNote()` and `onSummaryLogActivity()` which already call `loadSummary()` directly. No additional `markSummaryDirty()` calls are needed for Company.

    6. **Contact detail** (`contact-detail.component.ts`): Same analysis as Company — no inline mutation handlers in sibling tabs. The `enrollInSequence()` method should call `this.markSummaryDirty()` after successful enrollment since it changes the contact's sequence enrollment status (which appears in the email engagement card on the summary tab). Add `this.markSummaryDirty()` after the snackBar.open() in the `next` callback of `enrollInSequence()` (~line 464).
  </action>
  <verify>
    1. Run `cd /Users/metatech/Documents/globcrm-claude-starter/globcrm-web && npx ng build --configuration=development 2>&1 | tail -5` — must compile with zero errors.
    2. Grep for `lastContactedAt` in summary.models.ts and entity-summary-tab.component.html — must return zero matches (field renamed everywhere).
    3. Grep for `markSummaryDirty()` in deal-detail.component.ts — must return at least 5 matches (1 definition + 4 calls).
    4. Grep for `markSummaryDirty()` in lead-detail.component.ts — must return at least 4 matches (1 definition + 3 calls).
    5. Grep for `markSummaryDirty()` in contact-detail.component.ts — must return at least 2 matches (1 definition + 1 call in enrollInSequence).
  </verify>
  <done>
    - BaseSummaryFields.lastContacted matches backend JSON key; template displays actual date instead of always "Never"
    - markSummaryDirty() called after every mutation handler in Deal (4 calls: linkContact, unlinkContact, linkProduct, unlinkProduct), Lead (3 calls: onStageClick, onReopen, onConvert), and Contact (1 call: enrollInSequence)
    - Angular build succeeds with zero errors
    - Both verification gaps from 23-VERIFICATION.md are closed
  </done>
</task>

</tasks>

<verification>
1. `ng build` compiles without errors
2. No remaining references to `lastContactedAt` in any summary-tab-related file
3. `markSummaryDirty()` is called from mutation handlers in all 4 detail pages where mutations exist (Deal: 4 handlers, Lead: 3 handlers, Contact: 1 handler, Company: 0 needed — no inline sibling-tab mutations)
4. The pattern matches Quote and Request which already correctly call markSummaryDirty()
</verification>

<success_criteria>
- SUMMARY-11 requirement satisfied: Last Contacted timestamp displays real data from the backend
- Success criterion 5 satisfied: Summary tab auto-refreshes via dirty-flag after mutations on all 6 detail pages
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-summary-tabs-on-detail-pages/23-05-SUMMARY.md`
</output>
