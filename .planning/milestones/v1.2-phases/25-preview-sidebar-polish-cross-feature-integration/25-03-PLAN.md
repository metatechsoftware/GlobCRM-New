---
phase: 25-preview-sidebar-polish-cross-feature-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 25-01
files_modified:
  - globcrm-web/src/app/shared/components/global-search/global-search.component.ts
  - globcrm-web/src/app/shared/components/global-search/recent-previews.service.ts
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
  - globcrm-web/src/app/app.component.ts
autonomous: true
requirements:
  - PREVIEW-08
  - PREVIEW-09

must_haves:
  truths:
    - "Clicking or pressing Enter on a global search result opens the preview sidebar (not detail page navigation)"
    - "Ctrl/Cmd+click on a search result navigates to the detail page (existing behavior preserved)"
    - "When search input is focused with no query, recently previewed entities appear in the dropdown"
    - "Preview sidebar displays full-width (100vw) on mobile screens (< 768px)"
    - "User can swipe right to close the preview sidebar on mobile (touch gesture with 80px threshold)"
    - "X button is available as fallback close mechanism on mobile"
    - "Preview sidebar closes automatically on route navigation (already implemented, verified working)"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/global-search/global-search.component.ts"
      provides: "Preview-first search result selection"
      contains: "previewStore"
    - path: "globcrm-web/src/app/shared/components/global-search/recent-previews.service.ts"
      provides: "localStorage-based recently previewed entities"
      contains: "RecentPreviewsService"
    - path: "globcrm-web/src/app/app.component.ts"
      provides: "Mobile full-width class on preview drawer"
      contains: "preview-drawer--mobile"
    - path: "globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts"
      provides: "Swipe-right-to-close gesture handler"
      contains: "touchstart"
  key_links:
    - from: "global-search.component.ts"
      to: "preview-sidebar.store.ts"
      via: "selectResult calls previewStore.open()"
      pattern: "previewStore\\.open"
    - from: "global-search.component.ts"
      to: "recent-previews.service.ts"
      via: "selectResult records recently previewed entity"
      pattern: "recentPreviewsService\\.addRecent"
    - from: "entity-preview-sidebar.component.ts"
      to: "preview-sidebar.store.ts"
      via: "swipe gesture calls store.close()"
      pattern: "store\\.close"
---

<objective>
Make global search results open the preview sidebar by default (preview-first), add recently previewed entities for quick re-access, and polish the preview sidebar for mobile with full-width display and swipe-right-to-close gesture.

Purpose: PREVIEW-09 — search-to-preview integration makes the sidebar the primary inspection tool. PREVIEW-08 — mobile responsive behavior ensures the sidebar works on all screen sizes.
Output: Preview-first search, RecentPreviewsService, mobile full-width sidebar, swipe-to-close gesture.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-RESEARCH.md
@.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-01-SUMMARY.md
@globcrm-web/src/app/shared/components/global-search/global-search.component.ts
@globcrm-web/src/app/shared/components/global-search/recent-searches.service.ts
@globcrm-web/src/app/shared/components/global-search/search.models.ts
@globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
@globcrm-web/src/app/app.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preview-first global search with recently previewed entities</name>
  <files>
    globcrm-web/src/app/shared/components/global-search/recent-previews.service.ts
    globcrm-web/src/app/shared/components/global-search/global-search.component.ts
  </files>
  <action>
    **Step 1: Create RecentPreviewsService (localStorage)**

    Create `globcrm-web/src/app/shared/components/global-search/recent-previews.service.ts` mirroring the `RecentSearchesService` pattern:

    ```typescript
    import { Injectable } from '@angular/core';

    const STORAGE_KEY = 'globcrm_recent_previews';
    const MAX_ITEMS = 8;

    export interface RecentPreviewEntry {
      entityType: string;
      entityId: string;
      entityName: string;
      previewedAt: number; // Unix timestamp ms
    }

    @Injectable({ providedIn: 'root' })
    export class RecentPreviewsService {
      getRecent(): RecentPreviewEntry[] {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      addRecent(entry: Omit<RecentPreviewEntry, 'previewedAt'>): void {
        if (!entry.entityId || !entry.entityType) return;
        const current = this.getRecent();
        // Deduplicate by entityType + entityId, update name on re-preview
        const deduplicated = current.filter(
          e => !(e.entityType === entry.entityType && e.entityId === entry.entityId)
        );
        const updated: RecentPreviewEntry[] = [
          { ...entry, previewedAt: Date.now() },
          ...deduplicated,
        ].slice(0, MAX_ITEMS);

        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
        } catch {
          // localStorage full or unavailable — silently ignore
        }
      }

      clearRecent(): void {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch {
          // silently ignore
        }
      }
    }
    ```

    **Step 2: Refactor GlobalSearchComponent for preview-first search**

    In `global-search.component.ts`:

    Add imports:
    ```typescript
    import { PreviewSidebarStore } from '../../stores/preview-sidebar.store';
    import { RecentPreviewsService } from './recent-previews.service';
    ```

    Add injections:
    ```typescript
    private readonly previewStore = inject(PreviewSidebarStore);
    private readonly recentPreviewsService = inject(RecentPreviewsService);
    ```

    Add signals:
    ```typescript
    readonly recentPreviews = signal<RecentPreviewEntry[]>([]);
    readonly showRecentPreviews = signal(false);
    ```

    Import the `RecentPreviewEntry` type.

    **Modify `selectResult` to accept $event and be preview-first:**
    ```typescript
    selectResult(hit: SearchHit, event?: MouseEvent): void {
      const term = this.searchTerm();
      if (term.trim()) {
        this.recentSearchesService.addRecent(term.trim());
      }
      this.close();

      if (event?.ctrlKey || event?.metaKey) {
        // Ctrl/Cmd+click: navigate to detail page (existing behavior)
        this.router.navigateByUrl(hit.url);
      } else {
        // Default: open preview sidebar
        this.recentPreviewsService.addRecent({
          entityType: hit.entityType,
          entityId: hit.id,
          entityName: hit.title,
        });
        this.previewStore.open({
          entityType: hit.entityType,
          entityId: hit.id,
          entityName: hit.title,
        });
      }
    }
    ```

    **Update template to pass $event:**
    Change `(click)="selectResult(hit)"` to `(click)="selectResult(hit, $event)"`.

    **Update keyboard handler to pass event:**
    In `onKeydown`, when Enter is pressed:
    ```typescript
    } else if (event.key === 'Enter') {
      const idx = this.activeIndex();
      if (idx >= 0 && idx < hits.length) {
        event.preventDefault();
        this.selectResult(hits[idx], event as unknown as MouseEvent);
      }
    }
    ```
    Note: For Enter key, there's no mouse event, so `event?.ctrlKey` still works since KeyboardEvent has ctrlKey/metaKey. Actually, the Enter handler should check for Ctrl+Enter:
    ```typescript
    } else if (event.key === 'Enter') {
      const idx = this.activeIndex();
      if (idx >= 0 && idx < hits.length) {
        event.preventDefault();
        if (event.ctrlKey || event.metaKey) {
          // Ctrl/Cmd+Enter: navigate to detail page
          this.router.navigateByUrl(hits[idx].url);
        } else {
          // Enter: open preview
          this.recentPreviewsService.addRecent({
            entityType: hits[idx].entityType,
            entityId: hits[idx].id,
            entityName: hits[idx].title,
          });
          this.previewStore.open({
            entityType: hits[idx].entityType,
            entityId: hits[idx].id,
            entityName: hits[idx].title,
          });
        }
        this.close();
      }
    }
    ```

    **Modify `onFocus` to show recently previewed when no query:**
    ```typescript
    onFocus(): void {
      this.recentSearches.set(this.recentSearchesService.getRecent());
      this.recentPreviews.set(this.recentPreviewsService.getRecent());
      if (!this.isOpen() && !this.results()) {
        // Show recently previewed if available, otherwise recent searches
        if (this.recentPreviews().length > 0) {
          this.showRecentPreviews.set(true);
          this.showRecent.set(false);
        } else {
          this.showRecentPreviews.set(false);
          this.showRecent.set(true);
        }
      }
    }
    ```

    **Update `close` to reset showRecentPreviews:**
    ```typescript
    close(): void {
      this.isOpen.set(false);
      this.showRecent.set(false);
      this.showRecentPreviews.set(false);
      this.activeIndex.set(-1);
    }
    ```

    **Add recently previewed section to template:**
    After the "Recent Searches" section, add:
    ```html
    <!-- Recently Previewed Entities -->
    @if (showRecentPreviews() && !isOpen() && recentPreviews().length > 0) {
      <div class="search-overlay">
        <div class="recent-header">
          <span>Recently Viewed</span>
          <button class="recent-clear-btn" (click)="clearRecentPreviews()">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
        @for (entry of recentPreviews(); track entry.entityId) {
          <a class="search-hit" (click)="selectRecentPreview(entry)">
            <mat-icon class="entity-icon">{{ getEntityIcon(entry.entityType) }}</mat-icon>
            <div class="hit-content">
              <span class="hit-title">{{ entry.entityName }}</span>
              <span class="hit-subtitle">{{ entry.entityType }}</span>
            </div>
          </a>
        }
      </div>
    }
    ```

    **Add helper methods:**
    ```typescript
    selectRecentPreview(entry: RecentPreviewEntry): void {
      this.close();
      this.previewStore.open({
        entityType: entry.entityType,
        entityId: entry.entityId,
        entityName: entry.entityName,
      });
    }

    clearRecentPreviews(): void {
      this.recentPreviewsService.clearRecent();
      this.recentPreviews.set([]);
      this.showRecentPreviews.set(false);
    }
    ```

    Import `RecentPreviewEntry` type for the template method signature.

    Also add a hint to the search hit template for Ctrl+Click navigation. Add a small tooltip or secondary action indicator. Per research recommendation, close the dropdown when preview opens (this is already handled by `this.close()` in selectResult).

    Build: `cd globcrm-web && npx ng build --configuration development`
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development` passes. Grep for `previewStore.open` in global-search.component.ts. Grep for `recentPreviewsService` in global-search.component.ts. Verify `recent-previews.service.ts` exists.
  </verify>
  <done>
    Global search results default to opening preview sidebar on click/Enter. Ctrl/Cmd+click and Ctrl/Cmd+Enter navigate to detail page. Empty search focus shows recently previewed entities. RecentPreviewsService persists to localStorage with deduplication. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile full-width preview sidebar with swipe-right-to-close gesture</name>
  <files>
    globcrm-web/src/app/app.component.ts
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
  </files>
  <action>
    **Step 1: Add mobile full-width class to preview drawer in AppComponent**

    In `app.component.ts`, update the mat-sidenav template:

    Change:
    ```html
    <mat-sidenav #previewDrawer
                 position="end"
                 mode="side"
                 [opened]="previewStore.isOpen()"
                 disableClose
                 class="preview-drawer">
    ```
    To:
    ```html
    <mat-sidenav #previewDrawer
                 position="end"
                 [mode]="isMobile() ? 'over' : 'side'"
                 [opened]="previewStore.isOpen()"
                 disableClose
                 class="preview-drawer"
                 [class.preview-drawer--mobile]="isMobile()">
    ```

    On mobile, use `mode="over"` instead of `mode="side"` so the drawer overlays content (full-width looks wrong in side mode because content gets pushed off-screen).

    Add mobile styles to the component styles:
    ```css
    .preview-drawer--mobile {
      width: 100vw !important;
    }
    ```

    **Step 2: Add swipe-right-to-close gesture to EntityPreviewSidebarComponent**

    In `entity-preview-sidebar.component.ts`, add touch event handling using `@HostListener`:

    Add properties:
    ```typescript
    private touchStartX = 0;
    private touchStartY = 0;
    private readonly SWIPE_THRESHOLD = 80;    // px minimum swipe distance
    private readonly SWIPE_MAX_Y_DRIFT = 50;  // px maximum vertical drift
    ```

    Add host listeners (import `HostListener` from `@angular/core`):
    ```typescript
    @HostListener('touchstart', ['$event'])
    onTouchStart(event: TouchEvent): void {
      this.touchStartX = event.touches[0].clientX;
      this.touchStartY = event.touches[0].clientY;
    }

    @HostListener('touchend', ['$event'])
    onTouchEnd(event: TouchEvent): void {
      const deltaX = event.changedTouches[0].clientX - this.touchStartX;
      const deltaY = Math.abs(event.changedTouches[0].clientY - this.touchStartY);

      // Swipe right (positive deltaX) with limited vertical drift
      if (deltaX > this.SWIPE_THRESHOLD && deltaY < this.SWIPE_MAX_Y_DRIFT) {
        this.store.close();
      }
    }
    ```

    Import `HostListener` in the import statement (it should already have it from Angular, but verify).

    **Step 3: Add mobile-specific SCSS adjustments**

    In `entity-preview-sidebar.component.scss`, add mobile overrides at the bottom:
    ```scss
    // Mobile responsive adjustments
    @media (max-width: 768px) {
      .preview-sidebar {
        // Slightly reduce padding for mobile
        .preview-header {
          padding: 10px 12px;
        }

        .preview-entity-name {
          padding: 12px 12px 4px;
          font-size: 16px;
        }

        .preview-owner {
          padding: 0 12px 12px;
          font-size: 13px;
        }

        .preview-body {
          padding: 0 12px 12px;
        }

        .preview-quick-actions {
          padding: 0 12px;
        }
      }
    }
    ```

    **Step 4: Verify auto-close on route navigation**

    The `closePreviewOnNav` effect already exists in AppComponent (lines 117-124) and handles closing the preview sidebar on route changes. No additional work needed — just verify it's still present and working.

    Build: `cd globcrm-web && npx ng build --configuration development`
  </action>
  <verify>
    `cd globcrm-web && npx ng build --configuration development` passes. Grep for `preview-drawer--mobile` in app.component.ts. Grep for `touchstart` in entity-preview-sidebar.component.ts. Grep for `SWIPE_THRESHOLD` in entity-preview-sidebar.component.ts. Grep for `closePreviewOnNav` in app.component.ts (still present).
  </verify>
  <done>
    Preview sidebar displays full-width on mobile (< 768px) using overlay mode. Swipe-right-to-close gesture (80px threshold, 50px max Y drift) works via native touch events (no library). X button close still works as fallback. Content density reduced slightly on mobile (smaller padding/font). Auto-close on route navigation confirmed working. Build passes.
  </done>
</task>

</tasks>

<verification>
1. Build: `cd globcrm-web && npx ng build --configuration development` passes
2. Preview-first search: `grep "previewStore.open" globcrm-web/src/app/shared/components/global-search/global-search.component.ts`
3. Recently previewed: `ls globcrm-web/src/app/shared/components/global-search/recent-previews.service.ts`
4. Mobile full-width: `grep "preview-drawer--mobile" globcrm-web/src/app/app.component.ts`
5. Swipe gesture: `grep "SWIPE_THRESHOLD" globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts`
6. Route auto-close: `grep "closePreviewOnNav" globcrm-web/src/app/app.component.ts`
7. Ctrl+click preserved: `grep "ctrlKey.*metaKey" globcrm-web/src/app/shared/components/global-search/global-search.component.ts`
</verification>

<success_criteria>
- Clicking a search result opens the preview sidebar (not detail navigation)
- Ctrl/Cmd+click on a search result navigates to the detail page
- Empty search focus shows recently previewed entities for quick re-access
- On mobile (< 768px), preview sidebar takes 100vw and overlays content
- Swipe right gesture (80px+ rightward, < 50px vertical drift) closes the sidebar on mobile
- X button still closes the sidebar on mobile
- Preview sidebar closes on route navigation (existing behavior preserved)
- Frontend build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-03-SUMMARY.md`
</output>
