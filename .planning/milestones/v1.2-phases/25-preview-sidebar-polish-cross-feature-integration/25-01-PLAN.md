---
phase: 25-preview-sidebar-polish-cross-feature-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.models.ts
  - globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.service.ts
  - globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.component.ts
  - globcrm-web/src/app/features/my-day/my-day.component.ts
  - globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html
  - globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
autonomous: true
requirements:
  - PREVIEW-10

must_haves:
  truths:
    - "User sees Add Note, Log Activity, and (for Contact/Lead) Send Email quick action buttons inside the preview sidebar"
    - "Clicking a quick action opens the CDK Overlay slide-in panel ON TOP of the preview sidebar without closing the sidebar"
    - "After completing a quick action (e.g. adding a note), the preview sidebar refreshes its data silently (no loading skeleton flash) and the new data is visible"
    - "Quick actions are not shown for Product entities (read-only)"
  artifacts:
    - path: "globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.models.ts"
      provides: "SlideInConfig with context field"
      contains: "context"
    - path: "globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.service.ts"
      provides: "Context-aware mutual exclusion logic"
      contains: "preview-sidebar"
    - path: "globcrm-web/src/app/shared/stores/preview-sidebar.store.ts"
      provides: "refreshCurrent method for silent re-fetch"
      contains: "refreshCurrent"
    - path: "globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts"
      provides: "Quick action bar wiring with slide-in panel"
      contains: "SlideInPanelService"
  key_links:
    - from: "entity-preview-sidebar.component.ts"
      to: "slide-in-panel.service.ts"
      via: "openQuickAction method calls SlideInPanelService.open with context: 'preview-sidebar'"
      pattern: "context.*preview-sidebar"
    - from: "entity-preview-sidebar.component.ts"
      to: "preview-sidebar.store.ts"
      via: "afterClosed subscription calls store.refreshCurrent()"
      pattern: "refreshCurrent"
---

<objective>
Wire QuickActionBarComponent into the preview sidebar so users can perform quick actions (Add Note, Log Activity, Send Email) directly from the sidebar. The slide-in panel opens on top of the sidebar without closing it, and after completion, the sidebar silently refreshes its data.

Purpose: PREVIEW-10 — quick actions inside the preview sidebar make it a power-user tool for rapid data entry without losing context.
Output: Refactored SlideInPanelService in shared location, context-aware mutual exclusion, QuickActionBarComponent in sidebar, refreshCurrent method on PreviewSidebarStore.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-RESEARCH.md
@.planning/phases/24-my-day-personal-dashboard/24-05-SUMMARY.md
@globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.models.ts
@globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.service.ts
@globcrm-web/src/app/features/my-day/slide-in-panel/slide-in-panel.component.ts
@globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html
@globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
@globcrm-web/src/app/shared/components/quick-action-bar/quick-action-bar.component.ts
@globcrm-web/src/app/features/my-day/my-day.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move SlideInPanelService to shared and add context-aware mutual exclusion</name>
  <files>
    globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.models.ts
    globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.service.ts
    globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.component.ts
    globcrm-web/src/app/features/my-day/my-day.component.ts
    globcrm-web/src/app/shared/stores/preview-sidebar.store.ts
  </files>
  <action>
    **Step 1: Relocate SlideInPanelService from features/my-day/ to shared/services/**

    Move all 3 files from `globcrm-web/src/app/features/my-day/slide-in-panel/` to `globcrm-web/src/app/shared/services/slide-in-panel/`:
    - `slide-in-panel.models.ts`
    - `slide-in-panel.service.ts`
    - `slide-in-panel.component.ts`

    Then delete the old `features/my-day/slide-in-panel/` directory.

    Update all import paths that reference the old location. The service is `providedIn: 'root'` so only import paths change. Known consumer: `my-day.component.ts` imports from `./slide-in-panel/slide-in-panel.service` and `./slide-in-panel/slide-in-panel.models` — update to `../../../shared/services/slide-in-panel/...`. Also check `slide-in-panel.service.ts` internal imports (it imports from `./slide-in-panel.models` and `./slide-in-panel.component` — these stay relative since all 3 files move together). The service also imports `PreviewSidebarStore` — update from `../../../shared/stores/preview-sidebar.store` to `../../stores/preview-sidebar.store`.

    **Step 2: Add `context` field to SlideInConfig**

    In `slide-in-panel.models.ts`, add optional fields to `SlideInConfig`:
    ```typescript
    export interface SlideInConfig {
      entityType: SlideInEntityType;
      title?: string;
      followUpSteps?: FollowUpStep[];
      context?: 'standalone' | 'preview-sidebar';  // NEW
      parentEntityType?: string;  // NEW: for associating notes/activities with previewed entity
      parentEntityId?: string;    // NEW
    }
    ```

    **Step 3: Make mutual exclusion context-aware in SlideInPanelService**

    In `slide-in-panel.service.ts`, modify the `open()` method:
    - Change the preview sidebar close logic from unconditional to conditional:
      ```typescript
      // Only close preview sidebar if NOT opening from preview context
      if (config.context !== 'preview-sidebar' && this.previewSidebarStore.isOpen()) {
        this.previewSidebarStore.close();
      }
      ```
    - Store the current context in a signal: `readonly currentContext = signal<string | undefined>(undefined);` Set it in `open()`: `this.currentContext.set(config.context);` Clear it in `close()`: `this.currentContext.set(undefined);`
    - Modify the constructor effect to only close the slide-in when preview opens IF the current context is NOT 'preview-sidebar':
      ```typescript
      effect(() => {
        const previewOpen = this.previewSidebarStore.isOpen();
        if (previewOpen && this.isOpen() && this.currentContext() !== 'preview-sidebar') {
          this.close(null);
        }
      });
      ```

    **Step 4: Add `refreshCurrent()` method to PreviewSidebarStore**

    In `preview-sidebar.store.ts`, add a new method `refreshCurrent` that re-fetches the current entity's preview data WITHOUT clearing `currentData` or setting `isLoading` to true. This prevents the skeleton flash (mirrors the "silent refresh" pattern from Phase 24):
    ```typescript
    refreshCurrent(): void {
      const entry = store.currentEntry();
      if (!entry) return;
      // Do NOT set isLoading or clear currentData — silent refresh
      previewService.getPreview(entry.entityType, entry.entityId).subscribe({
        next: (data) => {
          patchState(store, { currentData: data, error: null });
        },
        error: () => {
          // Silently ignore refresh errors — keep existing data
        },
      });
    },
    ```

    Run `cd globcrm-web && npx ng build --configuration development 2>&1 | head -50` to verify no import errors after relocation.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development` — build succeeds with zero errors. Grep for old import path `from.*my-day/slide-in-panel` to confirm no stale references remain. Verify `slide-in-panel.models.ts` contains `context` field and `preview-sidebar.store.ts` contains `refreshCurrent` method.
  </verify>
  <done>
    SlideInPanelService relocated to shared/services/slide-in-panel/, all imports updated, context-aware mutual exclusion working, PreviewSidebarStore has refreshCurrent() for silent re-fetch. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire QuickActionBarComponent into preview sidebar with slide-in panel integration</name>
  <files>
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.ts
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html
    globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.scss
  </files>
  <action>
    **Step 1: Add QuickActionBarComponent to the preview sidebar template**

    Place the quick action bar directly below the entity name/owner section and above the tab group. This is the "top of sidebar" placement per research recommendation.

    In `entity-preview-sidebar.component.html`, after the `preview-owner` div (inside the `@if (store.currentData(); as data)` block) and before the `preview-body` div, add:
    ```html
    <!-- Quick Actions -->
    @if (showQuickActions()) {
      <div class="preview-quick-actions">
        <app-quick-action-bar
          [showSendEmail]="showSendEmail()"
          (addNote)="onQuickAction('Note')"
          (logActivity)="onQuickAction('Activity')"
          (sendEmail)="onSendEmail()" />
      </div>
    }
    ```

    **Step 2: Add computed signals and methods to the component TS**

    In `entity-preview-sidebar.component.ts`:

    Import `SlideInPanelService` from `../../services/slide-in-panel/slide-in-panel.service`, `SlideInEntityType` from `../../services/slide-in-panel/slide-in-panel.models`, `QuickActionBarComponent` from `../quick-action-bar/quick-action-bar.component`, and `Router` from `@angular/router`.

    Add to imports array: `QuickActionBarComponent`.

    Inject `SlideInPanelService` and `Router`.

    Add computed signals:
    ```typescript
    /** Quick actions shown for all entity types except Product */
    readonly showQuickActions = computed(() => {
      const entry = this.store.currentEntry();
      return entry != null && entry.entityType !== 'Product';
    });

    /** Send Email shown only for Contact and Lead (entities with direct email) */
    readonly showSendEmail = computed(() => {
      const entry = this.store.currentEntry();
      return entry?.entityType === 'Contact' || entry?.entityType === 'Lead';
    });
    ```

    Add methods:
    ```typescript
    onQuickAction(type: 'Note' | 'Activity'): void {
      const entry = this.store.currentEntry();
      if (!entry) return;

      const panelRef = this.slideInPanelService.open({
        entityType: type as SlideInEntityType,
        title: `New ${type}`,
        context: 'preview-sidebar',
        parentEntityType: entry.entityType,
        parentEntityId: entry.entityId,
      });

      panelRef.afterClosed.subscribe((result) => {
        if (result) {
          // Silent refresh to show the new note/activity in the sidebar
          this.store.refreshCurrent();
        }
      });
    }

    onSendEmail(): void {
      // Navigate to email compose (per Phase 24 decision: email is too complex for slide-in)
      this.router.navigate(['/emails'], { queryParams: { compose: 'true' } });
    }
    ```

    **Step 3: Add styling for the quick action bar area**

    In `entity-preview-sidebar.component.scss`, add:
    ```scss
    .preview-quick-actions {
      padding: 0 16px;
      border-bottom: 1px solid var(--color-border-subtle);

      // Override the quick-action-bar default padding since we handle it in the container
      ::ng-deep .quick-action-bar {
        padding: 8px 0 12px;
        gap: 8px;

        .action-pill {
          font-size: 12px;
          padding: 0 12px;
          height: 32px;
          min-height: 32px;

          mat-icon {
            font-size: 16px;
            width: 16px;
            height: 16px;
          }
        }
      }
    }
    ```

    This makes the quick action pills slightly smaller than on the summary tab to fit the narrower sidebar width.

    Run `cd globcrm-web && npx ng build --configuration development` to verify build success.
  </action>
  <verify>
    Run `cd globcrm-web && npx ng build --configuration development` — build succeeds. Verify the entity-preview-sidebar.component.html contains `app-quick-action-bar`. Verify the component.ts has `onQuickAction` and `onSendEmail` methods. Verify the component.ts imports `SlideInPanelService` and passes `context: 'preview-sidebar'`.
  </verify>
  <done>
    QuickActionBarComponent is wired into the preview sidebar, appearing below entity name/owner and above tabs. Quick actions open slide-in panels with `context: 'preview-sidebar'` (preventing sidebar close). After action completion, sidebar silently refreshes. Send Email navigates to /emails?compose=true. Product entities show no quick actions. Build passes.
  </done>
</task>

</tasks>

<verification>
1. Build: `cd globcrm-web && npx ng build --configuration development` passes with zero errors
2. No stale imports: `grep -r "my-day/slide-in-panel" globcrm-web/src/ --include="*.ts"` returns zero results (only shared path used)
3. SlideInConfig contains `context` field: `grep "context" globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.models.ts`
4. PreviewSidebarStore has refreshCurrent: `grep "refreshCurrent" globcrm-web/src/app/shared/stores/preview-sidebar.store.ts`
5. Quick action bar in sidebar: `grep "app-quick-action-bar" globcrm-web/src/app/shared/components/entity-preview-sidebar/entity-preview-sidebar.component.html`
6. Context-aware exclusion: `grep "preview-sidebar" globcrm-web/src/app/shared/services/slide-in-panel/slide-in-panel.service.ts`
</verification>

<success_criteria>
- QuickActionBarComponent visible in preview sidebar for all entity types except Product
- Clicking Add Note or Log Activity opens slide-in panel without closing the preview sidebar
- After creating a note/activity from the sidebar, the sidebar refreshes its data silently (no skeleton flash)
- Send Email navigates to /emails?compose=true
- SlideInPanelService relocated to shared/services/slide-in-panel/ with all imports updated
- Angular build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-preview-sidebar-polish-cross-feature-integration/25-01-SUMMARY.md`
</output>
