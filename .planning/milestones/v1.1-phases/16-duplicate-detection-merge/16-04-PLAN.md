---
phase: 16-duplicate-detection-merge
plan: 04
type: execute
wave: 3
depends_on: [16-02]
files_modified:
  - globcrm-web/src/app/features/settings/duplicate-rules/duplicate-rules.component.ts
  - globcrm-web/src/app/features/settings/settings-hub.component.ts
  - globcrm-web/src/app/features/settings/settings.routes.ts
  - globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
  - globcrm-web/src/app/features/companies/company-form/company-form.component.ts
  - globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
  - globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
autonomous: true
requirements: [DUP-01, DUP-03]

must_haves:
  truths:
    - "System warns user of potential duplicates via inline amber banner when creating a contact (on blur of name/email fields)"
    - "System warns user of potential duplicates via inline amber banner when creating a company (on blur of name field)"
    - "Warning banner shows matching record name, email, match score, and clickable link to view the existing record"
    - "User can dismiss the duplicate warning and continue creating the record"
    - "Duplicate warnings only appear on create forms, NOT on edit forms"
    - "Admin can view and update matching rules (auto-detection toggle, similarity threshold, matching fields) per entity type"
    - "When user navigates to a merged contact/company URL, they are redirected to the surviving record"
  artifacts:
    - path: "globcrm-web/src/app/features/settings/duplicate-rules/duplicate-rules.component.ts"
      provides: "Admin matching config page"
      contains: "DuplicateRulesComponent"
    - path: "globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts"
      provides: "Contact form with duplicate warning banner"
      contains: "potentialDuplicates"
    - path: "globcrm-web/src/app/features/companies/company-form/company-form.component.ts"
      provides: "Company form with duplicate warning banner"
      contains: "potentialDuplicates"
  key_links:
    - from: "contact-form.component.ts"
      to: "DuplicateService.checkContactDuplicates"
      via: "blur event handler"
      pattern: "checkContactDuplicates"
    - from: "company-form.component.ts"
      to: "DuplicateService.checkCompanyDuplicates"
      via: "blur event handler"
      pattern: "checkCompanyDuplicates"
    - from: "DuplicateRulesComponent"
      to: "DuplicateService.getSettings/updateSettings"
      via: "API calls for config CRUD"
      pattern: "getSettings|updateSettings"
---

<objective>
Add duplicate warning banners to contact and company create forms, create the admin duplicate rules settings page, and handle merged-record redirects in detail pages.

Purpose: DUP-01 (real-time warnings) and DUP-03 (admin configurable rules) complete the user-facing experience that makes duplicate detection proactive rather than only reactive.
Output: Modified create forms with warning banners, new admin settings page, merged-record redirect handling.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-duplicate-detection-merge/16-RESEARCH.md
@.planning/phases/16-duplicate-detection-merge/16-02-SUMMARY.md
@globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
@globcrm-web/src/app/features/companies/company-form/company-form.component.ts
@globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
@globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
@globcrm-web/src/app/features/settings/settings-hub.component.ts
@globcrm-web/src/app/features/settings/settings.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin duplicate rules settings page</name>
  <files>
    globcrm-web/src/app/features/settings/duplicate-rules/duplicate-rules.component.ts
    globcrm-web/src/app/features/settings/settings-hub.component.ts
    globcrm-web/src/app/features/settings/settings.routes.ts
  </files>
  <action>
    1. **Create DuplicateRulesComponent** (globcrm-web/src/app/features/settings/duplicate-rules/duplicate-rules.component.ts):
       - Standalone component with OnPush change detection
       - Inject DuplicateService (from the duplicates feature — import the service directly)
       - On init, load settings via `duplicateService.getSettings()`

       **Template layout:**
       - Page title: "Duplicate Detection Rules"
       - Subtitle: "Configure how the system detects potential duplicate records"
       - Two sections (one for Contacts, one for Companies), each in a mat-card:

       **Per entity type card:**
       - Card title: "Contact Matching Rules" / "Company Matching Rules"
       - **Auto-detection toggle:** mat-slide-toggle for "Enable auto-detection on create"
         * Subtitle: "When enabled, the system warns users about potential duplicates when creating new records"
       - **Similarity threshold:** mat-slider with range 50-100, step 5
         * Label: "Similarity Threshold: {value}%"
         * Helper text: "Records scoring above this threshold are flagged as potential duplicates"
         * Visual: Show color indicator (green for strict >85, amber for moderate 70-85, red for permissive <70)
       - **Matching fields:** Checkbox list of available fields
         * For Contacts: Name (always on, disabled), Email
         * For Companies: Company Name (always on, disabled), Website/Domain
         * Checked fields participate in matching. Name/Company Name cannot be unchecked (always required).
       - **Save button:** mat-raised-button per card, calls `duplicateService.updateSettings(entityType, request)`
         * Show success snackbar on save: "Settings updated"

    2. **Add settings hub card** (modify settings-hub.component.ts):
       - Add a new card/link in the settings hub for "Duplicate Detection Rules"
       - Icon: "compare_arrows" or "content_copy"
       - Subtitle: "Configure matching rules and thresholds"
       - Route: `/settings/duplicate-rules`
       - Only visible to Admin role (use existing admin-only pattern from settings hub)

    3. **Add route** (modify settings.routes.ts):
       - Add route: `{ path: 'duplicate-rules', loadComponent: () => import('./duplicate-rules/duplicate-rules.component').then(m => m.DuplicateRulesComponent) }`
       - Protect with adminGuard if not already applied to settings parent route
  </action>
  <verify>
    `cd globcrm-web && npm run build` succeeds.
    Route `/settings/duplicate-rules` loads the settings component.
    Settings hub shows "Duplicate Detection Rules" card.
  </verify>
  <done>
    Admin can view and update matching rules per entity type: auto-detection toggle, similarity threshold slider (50-100%), and matching field checkboxes. Settings hub includes a card linking to the duplicate rules page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Duplicate warning banners in create forms and merged-record redirect in detail pages</name>
  <files>
    globcrm-web/src/app/features/contacts/contact-form/contact-form.component.ts
    globcrm-web/src/app/features/companies/company-form/company-form.component.ts
    globcrm-web/src/app/features/contacts/contact-detail/contact-detail.component.ts
    globcrm-web/src/app/features/companies/company-detail/company-detail.component.ts
  </files>
  <action>
    1. **Add duplicate warning to ContactFormComponent** (contact-form.component.ts):
       - Import DuplicateService from the duplicates feature
       - Add a signal: `potentialDuplicates = signal<DuplicateMatch[]>([])`
       - Add a signal: `duplicateWarningDismissed = signal<boolean>(false)`
       - **Only on CREATE mode (not edit):** Determine create vs edit mode by checking if the form has an existing entity ID (e.g., if route has an `id` param, it's edit mode). Only add blur handlers in create mode.
       - Add blur event handlers on the firstName, lastName, and email form fields:
         * On blur: If firstName or lastName has a value, call `duplicateService.checkContactDuplicates({ firstName, lastName, email })`
         * Debounce is not needed (blur fires once per field exit), but avoid calling if values haven't changed since last check
         * On response: set `potentialDuplicates` signal with results
       - **Warning banner template** (inline in component template, positioned above the form fields or below the name/email section):
         ```html
         @if (potentialDuplicates().length > 0 && !duplicateWarningDismissed()) {
           <div class="duplicate-warning">
             <mat-icon>warning</mat-icon>
             <div class="duplicate-warning__content">
               <strong>Potential duplicates found:</strong>
               @for (match of potentialDuplicates(); track match.id) {
                 <div class="duplicate-warning__match">
                   <a [routerLink]="['/contacts', match.id]" target="_blank">
                     {{ match.fullName }}
                   </a>
                   <span class="duplicate-warning__details">
                     {{ match.email ? '(' + match.email + ')' : '' }} — {{ match.score }}% match
                   </span>
                 </div>
               }
             </div>
             <button mat-icon-button (click)="dismissDuplicateWarning()">
               <mat-icon>close</mat-icon>
             </button>
           </div>
         }
         ```
       - **Warning styles** (inline or in component styles):
         * Background: amber/yellow (`var(--warning-surface)` or `#fff3e0`)
         * Border-left: 4px solid amber (`#ff9800`)
         * Padding: 12px 16px
         * Display: flex, align-items: start, gap: 12px
         * mat-icon color: amber
         * Links: use primary color, underlined
         * Dismiss button floats right
       - `dismissDuplicateWarning()` method: set `duplicateWarningDismissed` to true
       - Reset `duplicateWarningDismissed` to false when field values change (so warning can reappear with new check results)

    2. **Add duplicate warning to CompanyFormComponent** (company-form.component.ts):
       - Same pattern as ContactFormComponent but:
         * Blur handlers on `name` field (and optionally `website` field)
         * Call `duplicateService.checkCompanyDuplicates({ name, website })`
         * Warning banner shows company name, website, score
         * Link routes to `/companies/{id}`
       - Only in CREATE mode, not edit mode (per locked decision)

    3. **Add merged-record redirect to ContactDetailComponent** (contact-detail.component.ts):
       - In the component's data loading logic (where it loads the contact by ID from the route):
         * If the API returns a response indicating the contact was merged (e.g., the response contains `mergedIntoId`), navigate to `/contacts/{mergedIntoId}` with `replaceUrl: true`
         * Show an info snackbar: "This contact was merged into another record. Redirecting..."
       - Implementation approach: In the service call's error handler or response interceptor, check for the merged redirect response. If the backend returns a non-standard status (e.g., 301 or a 200 with a `mergedIntoId` field), handle it.
       - Alternative simpler approach: If the contact load returns 404, make a secondary call to check if it was merged (or handle this in the HTTP error interceptor).

    4. **Add merged-record redirect to CompanyDetailComponent** (company-detail.component.ts):
       - Same redirect pattern as ContactDetailComponent.
       - Navigate to `/companies/{mergedIntoId}` with replaceUrl.
  </action>
  <verify>
    `cd globcrm-web && npm run build` succeeds.
    Contact form component includes duplicate warning banner template and blur handlers.
    Company form component includes duplicate warning banner template and blur handlers.
    Contact and company detail components handle merged-record redirect.
  </verify>
  <done>
    Contact and company create forms show inline amber warning banners when potential duplicates are detected on blur of key fields. Each warning shows matching record name, email, score as a percentage, and a clickable link to view the existing record. Users can dismiss the warning and continue creating. Edit forms do NOT show warnings (create-only per locked decision). Merged-record URLs redirect to the surviving record with an info snackbar.
  </done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npm run build` — 0 errors
2. Contact create form shows duplicate warning banner on blur of name/email fields
3. Company create form shows duplicate warning banner on blur of name field
4. Warning banners are dismissible and non-blocking
5. Edit forms do NOT trigger duplicate warnings
6. Admin can access /settings/duplicate-rules and configure matching rules
7. Navigating to a merged contact/company URL redirects to the survivor
</verification>

<success_criteria>
- Inline amber warning banners appear in create forms with matching record details and clickable links
- Warnings are non-blocking and dismissible
- Only create forms trigger warnings, not edit forms
- Admin settings page allows toggling auto-detection, adjusting threshold, and selecting matching fields
- Settings hub includes the duplicate rules card
- Merged-record URLs redirect to the surviving record
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-duplicate-detection-merge/16-04-SUMMARY.md`
</output>
