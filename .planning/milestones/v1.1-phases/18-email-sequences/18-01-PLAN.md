---
phase: 18-email-sequences
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/EmailSequence.cs
  - src/GlobCRM.Domain/Entities/EmailSequenceStep.cs
  - src/GlobCRM.Domain/Entities/SequenceEnrollment.cs
  - src/GlobCRM.Domain/Entities/SequenceTrackingEvent.cs
  - src/GlobCRM.Domain/Enums/SequenceStatus.cs
  - src/GlobCRM.Domain/Enums/EnrollmentStatus.cs
  - src/GlobCRM.Domain/Enums/EntityType.cs
  - src/GlobCRM.Domain/Interfaces/IEmailSequenceRepository.cs
  - src/GlobCRM.Domain/Interfaces/ISequenceEnrollmentRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/EmailSequenceConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/EmailSequenceStepConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/SequenceEnrollmentConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/SequenceTrackingEventConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/EmailSequenceRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Repositories/SequenceEnrollmentRepository.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - scripts/rls-setup.sql
autonomous: true
requirements: [ESEQ-01]

must_haves:
  truths:
    - "EmailSequence, EmailSequenceStep, SequenceEnrollment, and SequenceTrackingEvent entities exist with all required properties"
    - "EF Core migration creates email_sequences, email_sequence_steps, sequence_enrollments, and sequence_tracking_events tables with correct snake_case columns"
    - "RLS policies enforce tenant isolation on all four new tables"
    - "Repositories provide CRUD operations for sequences (with eager-loaded steps) and enrollments"
    - "TenantSeeder creates sample sequence data for demo tenants"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/EmailSequence.cs"
      provides: "Sequence entity with Name, Description, Status, Steps collection, CreatedByUserId"
      contains: "class EmailSequence"
    - path: "src/GlobCRM.Domain/Entities/EmailSequenceStep.cs"
      provides: "Step entity with StepNumber, EmailTemplateId, SubjectOverride, DelayDays, PreferredSendTime"
      contains: "class EmailSequenceStep"
    - path: "src/GlobCRM.Domain/Entities/SequenceEnrollment.cs"
      provides: "Enrollment entity with ContactId, Status, CurrentStepNumber, HangfireJobId, pause/reply/bounce timestamps"
      contains: "class SequenceEnrollment"
    - path: "src/GlobCRM.Domain/Entities/SequenceTrackingEvent.cs"
      provides: "Tracking event entity with EnrollmentId, StepNumber, EventType, Url, GmailMessageId, GmailThreadId"
      contains: "class SequenceTrackingEvent"
    - path: "src/GlobCRM.Domain/Enums/SequenceStatus.cs"
      provides: "Draft, Active, Paused, Archived enum"
      contains: "enum SequenceStatus"
    - path: "src/GlobCRM.Domain/Enums/EnrollmentStatus.cs"
      provides: "Active, Paused, Completed, Replied, Bounced, Unenrolled enum"
      contains: "enum EnrollmentStatus"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "src/GlobCRM.Domain/Entities/EmailSequence.cs"
      via: "DbSet<EmailSequence> property and global query filter"
      pattern: "DbSet<EmailSequence>"
    - from: "src/GlobCRM.Domain/Entities/EmailSequenceStep.cs"
      to: "src/GlobCRM.Domain/Entities/EmailTemplate.cs"
      via: "FK EmailTemplateId referencing existing EmailTemplate entity"
      pattern: "EmailTemplateId"
    - from: "src/GlobCRM.Domain/Entities/SequenceEnrollment.cs"
      to: "src/GlobCRM.Domain/Entities/Contact.cs"
      via: "FK ContactId referencing existing Contact entity"
      pattern: "ContactId"
---

<objective>
Create the complete data layer for email sequences: domain entities, enums, repository interfaces, EF Core configurations with PostgreSQL snake_case naming, migration, RLS policies, repository implementations, and tenant seeder data.

Purpose: Establishes the foundational data model that all subsequent plans (execution engine, API, frontend) depend on.
Output: Four new database tables with proper tenant isolation, two repositories, and seed data for demo tenants.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-email-sequences/18-RESEARCH.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities, enums, and repository interfaces</name>
  <files>
    src/GlobCRM.Domain/Entities/EmailSequence.cs
    src/GlobCRM.Domain/Entities/EmailSequenceStep.cs
    src/GlobCRM.Domain/Entities/SequenceEnrollment.cs
    src/GlobCRM.Domain/Entities/SequenceTrackingEvent.cs
    src/GlobCRM.Domain/Enums/SequenceStatus.cs
    src/GlobCRM.Domain/Enums/EnrollmentStatus.cs
    src/GlobCRM.Domain/Enums/EntityType.cs
    src/GlobCRM.Domain/Interfaces/IEmailSequenceRepository.cs
    src/GlobCRM.Domain/Interfaces/ISequenceEnrollmentRepository.cs
  </files>
  <action>
    Create four domain entities following the exact patterns from the research document:

    **EmailSequence.cs** — Properties: Id (Guid), TenantId (Guid), Name (string), Description (string?), Status (SequenceStatus, default Draft), CreatedByUserId (Guid), CreatedByUser (ApplicationUser?), Steps (List&lt;EmailSequenceStep&gt;, init []), IsSeedData (bool, default false), CreatedAt (DateTimeOffset), UpdatedAt (DateTimeOffset). Follow EmailTemplate entity pattern exactly.

    **EmailSequenceStep.cs** — Properties: Id (Guid), SequenceId (Guid), Sequence (EmailSequence, null!), StepNumber (int, 1-based ordering), EmailTemplateId (Guid), EmailTemplate (EmailTemplate?), SubjectOverride (string?, overrides template subject if set — per locked decision), DelayDays (int, default 0 — days to wait after previous step per locked decision "Wait N days"), PreferredSendTime (TimeOnly?, e.g. 09:00 — per locked decision "send at 9:00 AM"), CreatedAt, UpdatedAt.

    **SequenceEnrollment.cs** — Properties: Id (Guid), TenantId (Guid), SequenceId (Guid), Sequence (EmailSequence?), ContactId (Guid), Contact (Contact?), Status (EnrollmentStatus, default Active), CurrentStepNumber (int, 0 = not started), StepsSent (int, 0), StartFromStep (int, default 1 — for re-enrollment from specific step per locked decision), LastStepSentAt (DateTimeOffset?), CompletedAt (DateTimeOffset?), RepliedAt (DateTimeOffset?), ReplyStepNumber (int?), PausedAt (DateTimeOffset?), BouncedAt (DateTimeOffset?), BounceReason (string?), CreatedByUserId (Guid), CreatedByUser (ApplicationUser?), HangfireJobId (string? — track scheduled job for pause/cancel per research recommendation), CreatedAt, UpdatedAt.

    **SequenceTrackingEvent.cs** — Properties: Id (Guid), TenantId (Guid), EnrollmentId (Guid), Enrollment (SequenceEnrollment?), StepNumber (int), EventType (string — "sent", "open", "click", "bounce"), Url (string? — clicked link URL), GmailMessageId (string?), GmailThreadId (string? — for reply detection), UserAgent (string?), IpAddress (string?), CreatedAt (DateTimeOffset).

    **SequenceStatus.cs** — Enum: Draft, Active, Paused, Archived
    **EnrollmentStatus.cs** — Enum: Active, Paused, Completed, Replied, Bounced, Unenrolled

    **EntityType.cs** — Add `EmailSequence` value to the existing enum (after EmailTemplate, following the same ordering pattern).

    **IEmailSequenceRepository.cs** — Interface: GetAllAsync(Guid tenantId), GetByIdAsync(Guid id) returning with Steps eagerly loaded, GetStepAsync(Guid sequenceId, int stepNumber), CreateAsync, UpdateAsync, DeleteAsync, GetByIdWithStepsAndTemplatesAsync(Guid id) for builder view with template details.

    **ISequenceEnrollmentRepository.cs** — Interface: GetByIdAsync(Guid id), GetBySequenceIdAsync(Guid sequenceId, paging params), GetByContactIdAsync(Guid contactId), GetActiveByContactAndSequenceAsync(Guid contactId, Guid sequenceId), CreateAsync, CreateBulkAsync(List&lt;SequenceEnrollment&gt;), UpdateAsync, GetAnalyticsAsync(Guid sequenceId) returning enrollment status counts, GetStepMetricsAsync(Guid sequenceId) returning per-step open/click/sent counts.
  </action>
  <verify>
    `cd src/GlobCRM.Domain && dotnet build` succeeds with 0 errors. All 9 files exist on disk.
  </verify>
  <done>
    All four domain entities, two enums, two repository interfaces, and EntityType extension exist with correct property types, nullable annotations, and default values matching the research document.
  </done>
</task>

<task type="auto">
  <name>Task 2: EF configurations, migration, RLS, repositories, and seed data</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/EmailSequenceConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/EmailSequenceStepConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/SequenceEnrollmentConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/SequenceTrackingEventConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/EmailSequenceRepository.cs
    src/GlobCRM.Infrastructure/Persistence/Repositories/SequenceEnrollmentRepository.cs
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
    scripts/rls-setup.sql
  </files>
  <action>
    **EF Configurations** — Follow EmailTemplateConfiguration pattern exactly with snake_case column names:

    **EmailSequenceConfiguration.cs**: Table "email_sequences". Columns: id, tenant_id (required), name (max 200, required), description (max 1000), status (string conversion, max 50), created_by_user_id (required), is_seed_data (default false), created_at, updated_at. FK to ApplicationUser (Restrict). HasMany Steps cascade delete. Indexes: idx_email_sequences_tenant_id, idx_email_sequences_created_by.

    **EmailSequenceStepConfiguration.cs**: Table "email_sequence_steps". Columns: id, sequence_id (required), step_number (required), email_template_id (required), subject_override (max 500), delay_days (required, default 0), preferred_send_time (TimeOnly mapping), created_at, updated_at. FK to EmailSequence (Cascade, already via parent HasMany). FK to EmailTemplate with OnDelete Restrict (prevents template deletion while used by active sequence — per research pitfall 6, strategy 1). Index: idx_email_sequence_steps_sequence_id, idx_email_sequence_steps_template_id. Unique composite index on (sequence_id, step_number).

    **SequenceEnrollmentConfiguration.cs**: Table "sequence_enrollments". Columns: id, tenant_id (required), sequence_id (required), contact_id (required), status (string conversion, max 50), current_step_number, steps_sent, start_from_step, last_step_sent_at, completed_at, replied_at, reply_step_number, paused_at, bounced_at, bounce_reason (max 500), created_by_user_id (required), hangfire_job_id (max 100), created_at, updated_at. FK to EmailSequence (Restrict), FK to Contact (Restrict), FK to ApplicationUser (Restrict). Indexes: idx_sequence_enrollments_tenant_id, idx_sequence_enrollments_sequence_id, idx_sequence_enrollments_contact_id, idx_sequence_enrollments_status.

    **SequenceTrackingEventConfiguration.cs**: Table "sequence_tracking_events". Columns: id, tenant_id (required), enrollment_id (required), step_number (required), event_type (max 50, required), url (max 2000), gmail_message_id (max 200), gmail_thread_id (max 200), user_agent (max 500), ip_address (max 50), created_at. FK to SequenceEnrollment (Cascade). Indexes: idx_sequence_tracking_events_enrollment_id, idx_sequence_tracking_events_event_type.

    **ApplicationDbContext.cs** — Add DbSet properties for all four entities. Add global query filters: `e.TenantId == _tenantId` for EmailSequence, SequenceEnrollment, SequenceTrackingEvent. EmailSequenceStep inherits isolation via parent FK (no direct tenant filter needed, same as DealContact pattern).

    **Migration** — Run: `cd src/GlobCRM.Api && dotnet ef migrations add AddEmailSequences --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure` then `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`.

    **RLS** — Add to scripts/rls-setup.sql: Enable RLS and create policies for email_sequences, sequence_enrollments, and sequence_tracking_events (same pattern as email_templates). email_sequence_steps does NOT need RLS (child of email_sequences, accessed via FK join).

    **Repositories** — Implement IEmailSequenceRepository and ISequenceEnrollmentRepository:
    - EmailSequenceRepository: GetAllAsync returns sequences ordered by CreatedAt desc. GetByIdAsync includes Steps (ordered by StepNumber). GetByIdWithStepsAndTemplatesAsync includes Steps.EmailTemplate. GetStepAsync queries Steps by SequenceId and StepNumber.
    - SequenceEnrollmentRepository: GetBySequenceIdAsync supports paging (skip/take). GetActiveByContactAndSequenceAsync filters Status == Active. CreateBulkAsync uses AddRangeAsync. GetAnalyticsAsync groups by Status and counts. GetStepMetricsAsync joins with SequenceTrackingEvent, groups by StepNumber and EventType, returns per-step sent/open/click/bounce counts.

    **TenantSeeder** — Add sequence seed data in the SeedSequencesAsync method (called from main seed flow):
    - Create 1 sample sequence: "New Customer Onboarding" (Status: Active, 3 steps referencing the first 3 seeded email templates with delays of 0, 2, and 5 days, preferred send times of 09:00).
    - Create 2-3 sample enrollments with varying statuses (Active, Completed, Replied) linking to seeded contacts.
    - Add cleanup logic: delete existing seed sequences (`IsSeedData == true`) before re-seeding, same pattern as other entity seeders.
    - Register repositories in DependencyInjection.cs or a new SequenceServiceExtensions.cs (prefer adding to existing DependencyInjection.cs pattern with a scoped registration section).
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors. Migration file exists. `dotnet ef database update` succeeds. Database has all four tables with correct columns. RLS policies added to rls-setup.sql.
  </verify>
  <done>
    All four tables created in PostgreSQL with snake_case columns, proper FKs, indexes, and RLS policies. Repositories registered in DI and operational. TenantSeeder creates demo sequence data. Full build passes.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors
2. All entity files exist in src/GlobCRM.Domain/Entities/
3. All configuration files exist in src/GlobCRM.Infrastructure/Persistence/Configurations/
4. Migration file exists in src/GlobCRM.Infrastructure/Persistence/Migrations/App/
5. RLS policies for 3 tables added to scripts/rls-setup.sql
6. `dotnet ef database update` applies without errors
7. `cd src/GlobCRM.Api && dotnet run -- --reseed` completes without errors (seed data created)
</verification>

<success_criteria>
- Four domain entities with all properties from research document
- Four EF configurations with snake_case PostgreSQL column naming
- Migration applied creating email_sequences, email_sequence_steps, sequence_enrollments, sequence_tracking_events tables
- RLS policies enforcing tenant isolation
- Two repository implementations with CRUD + analytics queries
- Seed data for demo sequences, steps, and enrollments
- Full solution builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-email-sequences/18-01-SUMMARY.md`
</output>
