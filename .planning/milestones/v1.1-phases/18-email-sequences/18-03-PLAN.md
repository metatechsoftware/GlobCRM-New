---
phase: 18-email-sequences
plan: 03
type: execute
wave: 3
depends_on: [18-01, 18-02]
files_modified:
  - src/GlobCRM.Api/Controllers/SequencesController.cs
  - src/GlobCRM.Api/Program.cs
  - src/GlobCRM.Infrastructure/Authorization/PermissionSeeder.cs
autonomous: true
requirements: [ESEQ-01, ESEQ-02, ESEQ-03, ESEQ-06, ESEQ-07]

must_haves:
  truths:
    - "User can create, read, update, and delete email sequences with steps via REST API"
    - "User can enroll individual contacts and bulk-enroll multiple contacts into a sequence"
    - "User can pause and resume individual enrollments via API"
    - "User can retrieve sequence-level analytics (enrolled, active, completed, replied, bounced counts)"
    - "User can retrieve per-step metrics (sent, opens, clicks per step)"
    - "Steps can be reordered via API with step number reassignment"
    - "Re-enrollment supports starting from beginning, last position, or specific step"
  artifacts:
    - path: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      provides: "Complete REST API for sequences with CRUD, enrollment management, and analytics"
      contains: "class SequencesController"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      to: "src/GlobCRM.Domain/Interfaces/IEmailSequenceRepository.cs"
      via: "Repository injection for CRUD operations"
      pattern: "IEmailSequenceRepository"
    - from: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      to: "src/GlobCRM.Infrastructure/Sequences/SequenceExecutionService.cs"
      via: "Hangfire job scheduling for enrollment"
      pattern: "IBackgroundJobClient"
    - from: "src/GlobCRM.Api/Controllers/SequencesController.cs"
      to: "src/GlobCRM.Domain/Interfaces/ISequenceEnrollmentRepository.cs"
      via: "Repository injection for enrollment operations"
      pattern: "ISequenceEnrollmentRepository"
---

<objective>
Create the SequencesController with full REST API surface: sequence CRUD with step management, contact enrollment (single + bulk), pause/resume, analytics endpoints, and RBAC permission setup.

Purpose: Provides the complete API surface that the frontend will consume for all sequence operations.
Output: SequencesController with ~15 endpoints, co-located DTOs, and RBAC permissions.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-email-sequences/18-RESEARCH.md
@.planning/phases/18-email-sequences/18-01-SUMMARY.md
@.planning/phases/14-foundation-infrastructure-email-templates/14-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SequencesController with CRUD, enrollment, and analytics endpoints</name>
  <files>
    src/GlobCRM.Api/Controllers/SequencesController.cs
  </files>
  <action>
    Create SequencesController following the EmailTemplatesController pattern exactly — co-located DTOs, request records, and validators in the same file. Route: `[Route("api/sequences")]`.

    **DTOs (co-located in same file):**

    `SequenceListItemDto`: Id, Name, Description, Status, StepCount, TotalEnrolled, ActiveEnrollments, CompletedEnrollments, ReplyRate (decimal), CreatedByUserName, CreatedAt. Static `FromEntity(EmailSequence entity, SequenceAnalyticsDto? analytics)`.

    `SequenceDetailDto`: Id, Name, Description, Status, Steps (List&lt;SequenceStepDto&gt;), CreatedByUserId, CreatedByUserName, CreatedAt, UpdatedAt. Static `FromEntity(EmailSequence entity)`.

    `SequenceStepDto`: Id, StepNumber, EmailTemplateId, EmailTemplateName, SubjectOverride, DelayDays, PreferredSendTime (string?, "HH:mm" format), CreatedAt.

    `EnrollmentListItemDto`: Id, ContactId, ContactName, ContactEmail, Status, CurrentStepNumber, StepsSent, StartFromStep, LastStepSentAt, CompletedAt, RepliedAt, ReplyStepNumber, PausedAt, BouncedAt, CreatedAt. Static `FromEntity(SequenceEnrollment entity)`.

    `SequenceAnalyticsDto`: TotalEnrolled (int), Active (int), Completed (int), Replied (int), Bounced (int), Unenrolled (int), Paused (int).

    `StepMetricsDto`: StepNumber (int), TemplateName (string), Sent (int), UniqueOpens (int), UniqueClicks (int), OpenRate (decimal), ClickRate (decimal).

    `FunnelDataDto`: StepNumber (int), StepName (string), Count (int) — for funnel chart.

    **Request records:**

    `CreateSequenceRequest`: Name, Description. Validator: Name required, max 200 chars. Description max 1000.

    `UpdateSequenceRequest`: Name, Description, Status (SequenceStatus?). Same validation.

    `AddStepRequest`: EmailTemplateId (Guid), SubjectOverride (string?), DelayDays (int), PreferredSendTime (string?, "HH:mm"). Validator: EmailTemplateId required. DelayDays >= 0. PreferredSendTime must be valid HH:mm format if provided.

    `UpdateStepRequest`: EmailTemplateId (Guid?), SubjectOverride (string?), DelayDays (int?), PreferredSendTime (string?).

    `ReorderStepsRequest`: StepIds (List&lt;Guid&gt;). Validator: at least 1 ID.

    `EnrollContactRequest`: ContactId (Guid), StartFromStep (int?, default 1). Validator: ContactId required. StartFromStep >= 1 if provided.

    `BulkEnrollRequest`: ContactIds (List&lt;Guid&gt;). Validator: At least 1 contact, max 1000.

    **Endpoints:**

    Sequence CRUD:
    - `GET /` — List sequences with analytics summary per locked decision (key columns: Name, Status, Steps, Total Enrolled, Active, Completed, Reply Rate). Returns List&lt;SequenceListItemDto&gt;.
    - `GET /{id}` — Get sequence detail with steps and template names. Returns SequenceDetailDto.
    - `POST /` — Create new sequence (Draft status). Returns SequenceDetailDto.
    - `PUT /{id}` — Update sequence name/description/status. When status changes to Active, validate all steps have valid template references. Returns SequenceDetailDto.
    - `DELETE /{id}` — Delete sequence. Fail with 409 if sequence has active enrollments.

    Step management:
    - `POST /{id}/steps` — Add step to sequence. Auto-assign StepNumber as max existing + 1. Returns SequenceStepDto.
    - `PUT /{id}/steps/{stepId}` — Update step properties. Returns SequenceStepDto.
    - `DELETE /{id}/steps/{stepId}` — Remove step, renumber remaining steps.
    - `PUT /{id}/steps/reorder` — Reorder steps by providing ordered list of step IDs. Reassign StepNumber values 1..N.

    Enrollment management:
    - `POST /{id}/enrollments` — Enroll single contact. Check if already enrolled (Active status) in this sequence — skip with 200 + message if so per locked decision. Per locked decision: warn if contact is in other sequences but don't block. If StartFromStep provided, start from that step per locked decision (re-enrollment from specific step). Schedule first step via Hangfire `_jobClient.Schedule<SequenceExecutionService>(...)`. Return EnrollmentListItemDto.
    - `POST /{id}/enrollments/bulk` — Bulk enroll contacts. For each contact: skip already-enrolled, create enrollment, schedule first step. Return { enrolled: int, skipped: int, skippedContactIds: Guid[] } per locked decision (confirmation shows skipped count).
    - `GET /{id}/enrollments` — List enrollments for sequence with paging (page, pageSize). Returns paged List&lt;EnrollmentListItemDto&gt;.
    - `PUT /{id}/enrollments/{enrollmentId}/pause` — Set status to Paused, set PausedAt = now. Delete scheduled Hangfire job if HangfireJobId exists. Return 200.
    - `PUT /{id}/enrollments/{enrollmentId}/resume` — Set status to Active, clear PausedAt. Schedule next step (CurrentStepNumber + 1) via Hangfire. Return 200.
    - `DELETE /{id}/enrollments/{enrollmentId}` — Set status to Unenrolled. Delete scheduled Hangfire job. Return 204.
    - `PUT /{id}/enrollments/bulk-pause` — Accept { enrollmentIds: Guid[] }. Pause all specified enrollments. Return count paused.
    - `PUT /{id}/enrollments/bulk-resume` — Accept { enrollmentIds: Guid[] }. Resume all specified enrollments. Return count resumed.

    Analytics:
    - `GET /{id}/analytics` — Return SequenceAnalyticsDto with enrollment status counts.
    - `GET /{id}/analytics/steps` — Return List&lt;StepMetricsDto&gt; with per-step sent/open/click counts and rates.
    - `GET /{id}/analytics/funnel` — Return List&lt;FunnelDataDto&gt; showing contact count at each step for funnel visualization.

    All endpoints use `[Authorize(Policy = "Permission:EmailSequence:View")]` for reads and `"Permission:EmailSequence:Edit"` for writes, following the existing RBAC pattern.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors. SequencesController.cs exists with all endpoint methods.
  </verify>
  <done>
    SequencesController has ~18 endpoints covering full CRUD, step management, enrollment (single + bulk + pause/resume), and analytics with co-located DTOs.
  </done>
</task>

<task type="auto">
  <name>Task 2: RBAC permissions and Program.cs wiring</name>
  <files>
    src/GlobCRM.Api/Program.cs
    src/GlobCRM.Infrastructure/Authorization/PermissionSeeder.cs
  </files>
  <action>
    **PermissionSeeder.cs** — EmailSequence entity type was added to EntityType enum in Plan 18-01. Verify that the existing auto-generation loop in PermissionSeeder that iterates EntityType values will automatically create permissions for EmailSequence (View, Create, Edit, Delete) across all 4 role templates (Admin: All scope, Manager: All, Sales Rep: Own, Viewer: View-only). If the loop uses `Enum.GetValues<EntityType>()`, it should already work. If not, add EmailSequence entries explicitly matching the existing pattern.

    **Program.cs** — Ensure AddSequenceServices() from 18-02's SequenceServiceExtensions is called (it may already be wired via DependencyInjection.cs). Verify the endpoint routing includes the new controllers. No additional middleware needed — TrackingController is a standard API controller that just lacks [Authorize].

    Also verify: The existing authorization policy setup in Program.cs dynamically creates policies from EntityType enum values. Confirm it will auto-create "Permission:EmailSequence:View", "Permission:EmailSequence:Create", "Permission:EmailSequence:Edit", "Permission:EmailSequence:Delete" policies. If it uses a hardcoded list, add EmailSequence.

    Run `cd src/GlobCRM.Api && dotnet run -- --reseed` to trigger permission seeding and verify no errors.
  </action>
  <verify>
    `cd src/GlobCRM.Api && dotnet build` succeeds. `dotnet run -- --reseed` completes without errors (RBAC permissions created for EmailSequence).
  </verify>
  <done>
    RBAC permissions (View/Create/Edit/Delete) created for EmailSequence entity type across all role templates. Program.cs correctly wires sequence services. Authorization policies dynamically created for EmailSequence.
  </done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors
2. SequencesController.cs exists with CRUD, step management, enrollment, and analytics endpoints
3. All DTOs and request records co-located in controller file
4. RBAC permissions auto-created for EmailSequence entity
5. `cd src/GlobCRM.Api && dotnet run -- --reseed` succeeds
6. Endpoint authorization uses Permission:EmailSequence:View/Edit policies
</verification>

<success_criteria>
- Full REST API surface with ~18 endpoints for sequences, steps, enrollments, and analytics
- Single enrollment with duplicate check and multi-sequence warning
- Bulk enrollment with skip-already-enrolled logic returning enrolled/skipped counts
- Pause/resume endpoints that manage Hangfire job lifecycle
- Analytics endpoints returning enrollment status counts and per-step metrics
- RBAC permissions properly seeded
- Full solution builds with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-email-sequences/18-03-SUMMARY.md`
</output>
