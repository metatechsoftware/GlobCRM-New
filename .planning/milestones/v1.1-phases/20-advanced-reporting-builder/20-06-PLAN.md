---
phase: 20-advanced-reporting-builder
plan: 06
type: execute
wave: 6
depends_on: [20-04, 20-05]
files_modified:
  - globcrm-web/src/app/features/reports/report-viewer/report-chart.component.ts
  - globcrm-web/src/app/features/reports/report-viewer/report-data-table.component.ts
  - globcrm-web/src/app/features/reports/report-viewer/report-aggregation-cards.component.ts
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
  - globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
  - globcrm-web/package.json
autonomous: true
requirements: [RPT-04, RPT-06, RPT-08]

must_haves:
  truths:
    - "User can see report results as a chart (bar, line, pie, or funnel) above a data table"
    - "Charts are polished with gradients, smooth animations, and hover tooltips"
    - "User can click a chart segment/bar/slice to drill down and see the underlying records filtered in the data table"
    - "Data table is paginated (50 rows per page) with row click navigation to entity detail"
    - "User can trigger CSV export from the builder and receive a notification when complete"
    - "Aggregation summary cards appear above the data table when grouping is active"
  artifacts:
    - path: "globcrm-web/src/app/features/reports/report-viewer/report-chart.component.ts"
      provides: "Chart.js rendering for bar, line, pie, and funnel chart types with drill-down click handling"
      contains: "class ReportChartComponent"
    - path: "globcrm-web/src/app/features/reports/report-viewer/report-data-table.component.ts"
      provides: "Paginated data table with row click navigation and drill-down filter display"
      contains: "class ReportDataTableComponent"
    - path: "globcrm-web/src/app/features/reports/report-viewer/report-aggregation-cards.component.ts"
      provides: "Summary KPI cards for aggregate values when grouping is active"
      contains: "class ReportAggregationCardsComponent"
  key_links:
    - from: "globcrm-web/src/app/features/reports/report-viewer/report-chart.component.ts"
      to: "globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts"
      via: "drillDown output event triggers filtered table update"
      pattern: "drillDown\\.emit"
    - from: "globcrm-web/src/app/features/reports/report-viewer/report-data-table.component.ts"
      to: "Entity detail routes"
      via: "Router navigation on row click"
      pattern: "router\\.navigate"
---

<objective>
Build the report viewer components: chart rendering (bar, line, pie, funnel) with polished styling, paginated data table with entity navigation, aggregation summary cards, chart drill-down interaction, and CSV export trigger. Wire all viewer components into the builder's preview area.

Purpose: Complete the report builder by adding the results visualization and interaction layer — the payoff for all the configuration work.
Output: ReportChartComponent, ReportDataTableComponent, ReportAggregationCardsComponent wired into the builder preview area.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-RESEARCH.md
@.planning/phases/20-advanced-reporting-builder/20-04-SUMMARY.md
@.planning/phases/20-advanced-reporting-builder/20-05-SUMMARY.md

# Patterns to follow:
@globcrm-web/src/app/features/dashboard/widgets/chart-widget.component.ts
@globcrm-web/src/app/features/sequences/sequence-detail/sequence-analytics.component.ts
@globcrm-web/src/app/features/reports/report.models.ts
@globcrm-web/src/app/features/reports/report.store.ts
@globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chart component (bar, line, pie, funnel) with polished styling and drill-down, plus aggregation summary cards</name>
  <files>
    globcrm-web/src/app/features/reports/report-viewer/report-chart.component.ts
    globcrm-web/src/app/features/reports/report-viewer/report-aggregation-cards.component.ts
    globcrm-web/package.json
  </files>
  <action>
    **Install chartjs-chart-funnel:**
    ```bash
    cd globcrm-web && npm install chartjs-chart-funnel
    ```

    **ReportChartComponent** — Chart rendering using existing chart.js + ng2-charts stack:
    - Standalone component with `ChangeDetectionStrategy.OnPush`
    - Input: `executionResult = input<ReportExecutionResult | null>()`, `chartType = input<ReportChartType>('bar')`, `groupingField = input<string>('')`
    - Output: `drillDown = output<ReportFilterCondition>()` — emits when user clicks a chart element

    **Chart.js Registration** — At the top of the component file:
    ```typescript
    import { Chart } from 'chart.js';
    import { FunnelController, TrapezoidElement } from 'chartjs-chart-funnel';
    Chart.register(FunnelController, TrapezoidElement);
    ```

    **Template:**
    - `@if (chartType() !== 'table')` show chart canvas via `<canvas baseChart>` (ng2-charts directive)
    - Use computed signals to transform executionResult into ChartData and ChartOptions based on chartType

    **Chart data transformation (computed signal):**
    - Extract labels from the grouping field column in rows (e.g., row['related.Stage.name'])
    - Extract data values from the aggregated fields (first numeric column)
    - Map to ChartData<'bar'|'line'|'pie'|'funnel'>

    **Color palette** — Reuse existing CHART_COLORS from ChartWidgetComponent:
    ```typescript
    const CHART_COLORS = ['#F97316', '#8B5CF6', '#14B8A6', '#3B82F6', '#22C55E', '#F59E0B', '#EF4444', '#9CA3AF'];
    ```

    **Per user decision: Rich & polished chart styling — Mixpanel/HubSpot feel:**

    Bar chart options:
    - Rounded corners on bars (borderRadius: 6)
    - Subtle gradient fills (create gradient from primary to lighter shade using canvas context in afterLayout plugin or static rgba colors)
    - Hover: increase opacity, show tooltip with group label + value + percentage
    - Animation: easeOutQuart, duration 800ms
    - Grid lines: very light gray (#f3f4f6), no border

    Line chart options:
    - Smooth tension (0.4), filled area below with 10% opacity
    - Point style: circle, 4px radius, 6px on hover
    - Hover: show vertical crosshair line
    - Animation: easeOutQuart, duration 800ms

    Pie chart options:
    - Doughnut variant (cutout: '50%') for modern look
    - Hover: expand segment (hoverOffset: 8)
    - Legend position: right
    - Tooltip: show label, value, and percentage

    Funnel chart options:
    - indexAxis: 'y' for horizontal funnel
    - Colors: gradient from primary orange to lighter shades
    - Tooltip: show stage name, count, and percentage of first stage
    - Legend: hidden (labels are on the chart)

    **All chart types shared options:**
    - `responsive: true, maintainAspectRatio: false` (container controls size)
    - Tooltips: backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, cornerRadius: 8, titleFont: { weight: 'bold' }, bodyFont: { size: 13 }
    - plugins.legend.labels: usePointStyle, padding 16, font size 12
    - Animation: smooth transitions on data update

    **Drill-down click handling:**
    - **Per user discretion decision: inline table filter (not dialog)**
    - Register chart onClick handler:
      ```typescript
      options.onClick = (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const label = chartData().labels[index];
          this.drillDown.emit({
            fieldId: this.groupingField(),
            operator: 'equals',
            value: String(label)
          });
        }
      };
      ```
    - Visual feedback: clicked segment gets highlighted border, other segments slightly faded

    **ReportAggregationCardsComponent** — Summary KPI cards above the data table:
    - **Per user discretion decision: summary cards above data table (not footer totals)**
    - Standalone component with `ChangeDetectionStrategy.OnPush`
    - Input: `aggregates = input<ReportAggregateResult[]>([])`
    - Template: horizontal flex row of cards (following sequence analytics metric cards pattern):
      ```html
      <div class="aggregation-cards">
        @for (agg of aggregates(); track agg.fieldId) {
          <div class="aggregation-card">
            <span class="aggregation-card__label">{{ agg.label }} ({{ agg.aggregation }})</span>
            <span class="aggregation-card__value">{{ formatValue(agg.value, agg.aggregation) }}</span>
          </div>
        }
      </div>
      ```
    - Styling: cards with subtle border, rounded corners, left colored accent border (cycling through CHART_COLORS), value in large bold font, label in muted small font
    - formatValue: format numbers with locale (comma separators), currency with $ prefix if applicable, round to 2 decimal places for averages
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>Chart component renders bar, line, pie (doughnut), and funnel charts with polished styling, smooth animations, detailed tooltips, and drill-down click handling. Aggregation cards display summary KPIs above the data table. chartjs-chart-funnel installed and registered.</done>
</task>

<task type="auto">
  <name>Task 2: Data table with pagination, row navigation, drill-down filter, CSV export, and builder preview wiring</name>
  <files>
    globcrm-web/src/app/features/reports/report-viewer/report-data-table.component.ts
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.ts
    globcrm-web/src/app/features/reports/report-builder/report-builder.component.html
  </files>
  <action>
    **ReportDataTableComponent** — Paginated data table for report results:
    - Standalone component with `ChangeDetectionStrategy.OnPush`
    - Input: `executionResult = input<ReportExecutionResult | null>()`, `entityType = input<string>('')`, `currentPage = input(1)`, `pageSize = input(50)`, `drillDownFilter = input<ReportFilterCondition | null>(null)`
    - Output: `pageChange = output<number>()`, `rowClick = output<Record<string, any>>()`, `clearDrillDown = output<void>()`

    **Template:**
    ```html
    <!-- Drill-down indicator -->
    @if (drillDownFilter()) {
      <div class="drill-down-bar">
        <mat-icon>filter_list</mat-icon>
        <span>Filtered by: {{ drillDownFilter()?.fieldId }} = "{{ drillDownFilter()?.value }}"</span>
        <button mat-icon-button (click)="clearDrillDown.emit()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    }

    <!-- Data table -->
    <div class="report-table-container">
      <table mat-table [dataSource]="rows()">
        @for (col of columnHeaders(); track col) {
          <ng-container [matColumnDef]="col">
            <th mat-header-cell *matHeaderCellDef>{{ col }}</th>
            <td mat-cell *matCellDef="let row">{{ formatCell(row[fieldIdForColumn(col)]) }}</td>
          </ng-container>
        }
        <tr mat-header-row *matHeaderRowDef="columnHeaders()"></tr>
        <tr mat-row *matRowDef="let row; columns: columnHeaders()"
            class="report-table__row--clickable"
            (click)="onRowClick(row)"></tr>
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator
      [length]="executionResult()?.totalCount ?? 0"
      [pageSize]="pageSize()"
      [pageIndex]="currentPage() - 1"
      [pageSizeOptions]="[25, 50, 100]"
      (page)="onPageChange($event)">
    </mat-paginator>
    ```

    **Computed signals:**
    - `rows()` — executionResult()?.rows ?? []
    - `columnHeaders()` — executionResult()?.columnHeaders ?? []
    - `fieldIdForColumn(label)` — maps column header labels to field IDs in row data

    **Row click navigation** — **Per user decision: navigate to entity detail page:**
    - On row click, check if the row has an 'id' field
    - Navigate to `/{entityType}s/{id}` (e.g., /contacts/{id}, /deals/{id})
    - Use Router.navigate with the entity type mapped to its route path
    - Entity type to route mapping: Contact -> contacts, Deal -> deals, Company -> companies, Lead -> leads, Activity -> activities, Quote -> quotes, Request -> requests, Product -> products

    **formatCell** — Format cell values:
    - Dates: pipe through DatePipe
    - Numbers: locale formatting
    - Currency: $ prefix with 2 decimal places
    - Null/undefined: show "—"
    - Booleans: "Yes"/"No"

    **Styles:**
    - `.report-table-container` — overflow-x auto for horizontal scroll on narrow screens
    - `.report-table__row--clickable` — cursor: pointer, hover background
    - `.drill-down-bar` — flex row with filter icon, text, and close button. Background: light amber (#FEF3C7), border-radius: 8px, padding, margin-bottom
    - mat-paginator: standard Material styling

    **Builder preview wiring** — Update report-builder.component.ts and .html:

    Replace the placeholder preview area from Plan 05 with the full viewer stack:
    ```html
    <div class="report-builder__preview">
      @if (store.executing()) {
        <div class="report-builder__loading">
          <mat-spinner diameter="48"></mat-spinner>
          <p>Running report...</p>
        </div>
      } @else if (store.executionResult()) {
        <!-- Chart (visible when chartType is not 'table') -->
        @if (chartConfig().chartType !== 'table') {
          <div class="report-builder__chart-area">
            <app-report-chart
              [executionResult]="store.executionResult()"
              [chartType]="chartConfig().chartType"
              [groupingField]="groupings().length > 0 ? groupings()[0].fieldId : ''"
              (drillDown)="onDrillDown($event)">
            </app-report-chart>
          </div>
        }

        <!-- Aggregation summary cards -->
        @if (store.executionResult()?.aggregates?.length) {
          <app-report-aggregation-cards
            [aggregates]="store.executionResult()!.aggregates!">
          </app-report-aggregation-cards>
        }

        <!-- Data table (always visible) -->
        <app-report-data-table
          [executionResult]="store.executionResult()"
          [entityType]="entityType()"
          [currentPage]="store.currentPage()"
          [drillDownFilter]="drillDownFilter()"
          (pageChange)="onPageChange($event)"
          (rowClick)="onRowClick($event)"
          (clearDrillDown)="onClearDrillDown()">
        </app-report-data-table>

        <!-- Export and share actions -->
        <div class="report-builder__result-actions">
          <button mat-stroked-button (click)="exportCsv()" [disabled]="store.exporting()">
            <mat-icon>download</mat-icon>
            Export CSV
          </button>
          @if (store.selectedReport()) {
            <button mat-stroked-button (click)="toggleShare()">
              <mat-icon>{{ store.selectedReport()?.isShared ? 'lock' : 'share' }}</mat-icon>
              {{ store.selectedReport()?.isShared ? 'Make Private' : 'Share' }}
            </button>
            <button mat-stroked-button (click)="cloneReport()">
              <mat-icon>content_copy</mat-icon>
              Clone
            </button>
          }
        </div>
      } @else {
        <div class="report-builder__empty-preview">
          <mat-icon>bar_chart</mat-icon>
          <h3>Report Preview</h3>
          <p>Configure your report and click "Run Report" to see results</p>
        </div>
      }
    </div>
    ```

    **Per user decision: chart on top, data table below, both visible simultaneously.**

    **Drill-down interaction** — Add to builder component:
    - `drillDownFilter = signal<ReportFilterCondition | null>(null)`
    - `onDrillDown(filter: ReportFilterCondition)`: set drillDownFilter signal, re-execute report with drillDownFilter passed to store.executeReport()
    - `onClearDrillDown()`: clear drillDownFilter, re-execute report without drill-down filter
    - `onPageChange(page: number)`: re-execute report with new page number

    **CSV export** — Add to builder component:
    - `exportCsv()`: calls store.exportCsv(reportId), which triggers the Hangfire job
    - Show a snackbar/toast: "Export started. You'll be notified when it's ready."
    - **Per user decision:** Full dataset export via Hangfire background job. Download link via SignalR notification.
    - Listen for SignalR "ReportExportComplete" event (via existing SignalRService pattern) to show download notification

    **Row click** — `onRowClick(row)`: navigate to entity detail page using Router

    **Additional builder styles:**
    - `.report-builder__chart-area` — height: 400px, padding, margin-bottom
    - `.report-builder__result-actions` — flex row with gap, padding-top, border-top
    - `.report-builder__loading` — centered flex column
  </action>
  <verify>Build succeeds: `cd globcrm-web && npx ng build --configuration development 2>&1 | tail -5`</verify>
  <done>Data table shows paginated report rows with entity navigation on row click. Drill-down from chart filters the table with a clearable filter bar. CSV export triggers background job with snackbar feedback. Builder preview area shows chart + aggregation cards + data table + action buttons.</done>
</task>

</tasks>

<verification>
- Angular build passes with 0 errors
- chartjs-chart-funnel in package.json dependencies
- Chart renders for bar, line, pie, and funnel types
- Data table paginates at 50 rows per page
- Chart click emits drill-down filter that re-runs report
- Export CSV button triggers API call
- Row click navigates to correct entity detail route
</verification>

<success_criteria>
The report viewer is fully operational: charts render with polished styling and drill-down, the data table shows paginated results with row navigation, aggregation summary cards display grouped totals, and CSV export triggers a background job. Combined with Plans 04-05, users have a complete report builder experience from configuration to visualization to export.
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-06-SUMMARY.md`
</output>
