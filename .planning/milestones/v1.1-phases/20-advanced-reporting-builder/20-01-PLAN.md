---
phase: 20-advanced-reporting-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Report.cs
  - src/GlobCRM.Domain/Entities/ReportCategory.cs
  - src/GlobCRM.Domain/Enums/ReportChartType.cs
  - src/GlobCRM.Domain/Enums/AggregationType.cs
  - src/GlobCRM.Domain/Enums/FilterLogic.cs
  - src/GlobCRM.Domain/Enums/EntityType.cs
  - src/GlobCRM.Domain/Interfaces/IReportRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ReportConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/ReportCategoryConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
  - src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
  - scripts/rls-setup.sql
autonomous: true
requirements: [RPT-01, RPT-05]

must_haves:
  truths:
    - "Report and ReportCategory domain entities exist with JSONB ReportDefinition"
    - "EF Core migration creates reports and report_categories tables with all columns and indexes"
    - "RLS policies enforce tenant isolation on reports and report_categories"
    - "IReportRepository provides CRUD, list-by-category, and shared report access"
    - "System.Linq.Dynamic.Core NuGet package is installed"
    - "EntityType.Report added for RBAC permission auto-generation"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Report.cs"
      provides: "Report entity with JSONB ReportDefinition, ReportCategory FK, OwnerId, IsShared, IsSeedData"
      contains: "class Report"
    - path: "src/GlobCRM.Domain/Entities/ReportCategory.cs"
      provides: "ReportCategory entity for organizing reports"
      contains: "class ReportCategory"
    - path: "src/GlobCRM.Domain/Interfaces/IReportRepository.cs"
      provides: "Repository interface for report CRUD and queries"
      contains: "interface IReportRepository"
    - path: "src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs"
      provides: "EF Core repository implementation"
      contains: "class ReportRepository"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs"
      to: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      via: "DbSet<Report> injection"
      pattern: "_db\\.Reports"
    - from: "src/GlobCRM.Infrastructure/DependencyInjection.cs"
      to: "src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs"
      via: "DI registration"
      pattern: "IReportRepository.*ReportRepository"
---

<objective>
Create the Report and ReportCategory domain entities with JSONB ReportDefinition, EF Core configurations, database migration, RLS policies, repository, RBAC permission, and install System.Linq.Dynamic.Core NuGet package.

Purpose: Establish the data layer foundation for the report builder -- entities, database schema, tenant isolation, and repository access pattern.
Output: Report/ReportCategory entities, EF configs, migration, RLS, repository, RBAC EntityType.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-RESEARCH.md

# Patterns to follow:
@src/GlobCRM.Domain/Entities/Workflow.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowConfiguration.cs
@src/GlobCRM.Infrastructure/Workflows/WorkflowRepository.cs
@src/GlobCRM.Domain/Interfaces/IWorkflowRepository.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities, enums, and repository interface</name>
  <files>
    src/GlobCRM.Domain/Entities/Report.cs
    src/GlobCRM.Domain/Entities/ReportCategory.cs
    src/GlobCRM.Domain/Enums/ReportChartType.cs
    src/GlobCRM.Domain/Enums/AggregationType.cs
    src/GlobCRM.Domain/Enums/FilterLogic.cs
    src/GlobCRM.Domain/Enums/EntityType.cs
    src/GlobCRM.Domain/Interfaces/IReportRepository.cs
  </files>
  <action>
    **Report.cs** — Create the Report entity following the Workflow entity JSONB pattern:
    - Properties: Id (Guid), TenantId (Guid), Name (string), Description (string?), CategoryId (Guid? FK to ReportCategory), EntityType (string — "Contact", "Deal", "Company", etc.), Definition (ReportDefinition — JSONB owned type), OwnerId (Guid? FK to ApplicationUser), IsShared (bool, default false), IsSeedData (bool, default false), ChartType (ReportChartType), LastRunAt (DateTimeOffset?), LastRunRowCount (int?), CreatedAt/UpdatedAt (DateTimeOffset).
    - Navigation properties: Category (ReportCategory?), Owner (ApplicationUser?).

    **ReportDefinition** — Owned JSONB class (same file as Report, following Workflow pattern):
    - `List<ReportField> Fields` — selected columns
    - `ReportFilterGroup? FilterGroup` — nested AND/OR filter tree
    - `List<ReportGrouping> Groupings` — group-by fields
    - `ReportChartConfig? ChartConfig` — chart type, colors, options

    **ReportField** — Owned class:
    - `string FieldId` — field identifier (e.g., "name", "related.Company.name", "custom_field_name")
    - `string Label` — display label
    - `string FieldType` — "system", "custom", "formula", "related"
    - `AggregationType? Aggregation` — null for non-grouped fields, Count/Sum/Avg/Min/Max for aggregated fields
    - `int SortOrder` — column order

    **ReportFilterGroup** — Recursive model:
    - `FilterLogic Logic` — And/Or
    - `List<ReportFilterCondition> Conditions`
    - `List<ReportFilterGroup> Groups` — nested child groups

    **ReportFilterCondition** — Owned class:
    - `string FieldId`, `string Operator` (equals, not_equals, contains, not_contains, greater_than, less_than, between, is_empty, is_not_empty), `string? Value`, `string? ValueTo` (for between)

    **ReportGrouping** — Owned class:
    - `string FieldId`, `string? DateTruncation` (day, week, month, quarter, year — for date fields)

    **ReportChartConfig** — Owned class:
    - `ReportChartType ChartType`, `string? ColorScheme`, `bool ShowLegend` (default true), `bool ShowDataLabels` (default false)

    **ReportCategory.cs** — Simple entity:
    - Id (Guid), TenantId (Guid), Name (string), Description (string?), SortOrder (int), IsSeedData (bool), CreatedAt/UpdatedAt (DateTimeOffset).

    **Enums:**
    - `ReportChartType.cs`: Table = 0, Bar = 1, Line = 2, Pie = 3, Funnel = 4
    - `AggregationType.cs`: Count = 0, Sum = 1, Average = 2, Min = 3, Max = 4
    - `FilterLogic.cs`: And = 0, Or = 1
    - `EntityType.cs`: Add `Report` value to existing enum for RBAC.

    **IReportRepository.cs** — Interface following IWorkflowRepository pattern:
    - `Task<Report?> GetByIdAsync(Guid id)`
    - `Task<(List<Report> Items, int TotalCount)> GetAllAsync(string? categoryId, string? entityType, string? search, bool includeShared, Guid userId, int page, int pageSize)`
    - `Task<Report> CreateAsync(Report report)`
    - `Task<Report> UpdateAsync(Report report)`
    - `Task DeleteAsync(Guid id)`
    - `Task<List<ReportCategory>> GetCategoriesAsync()`
    - `Task<ReportCategory> CreateCategoryAsync(ReportCategory category)`
    - `Task<ReportCategory> UpdateCategoryAsync(ReportCategory category)`
    - `Task DeleteCategoryAsync(Guid id)`
  </action>
  <verify>Build succeeds: `cd src/GlobCRM.Api && dotnet build`</verify>
  <done>Report and ReportCategory entities with all nested JSONB types defined, enums created, EntityType.Report added, IReportRepository interface ready for implementation.</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, migration, RLS, repository implementation, NuGet package, and DI registration</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/ReportConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/ReportCategoryConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
    src/GlobCRM.Infrastructure/GlobCRM.Infrastructure.csproj
    scripts/rls-setup.sql
  </files>
  <action>
    **ReportConfiguration.cs** — EF Core config following WorkflowConfiguration pattern:
    - Table "reports" with snake_case columns
    - JSONB `OwnsOne(r => r.Definition, d => d.ToJson())` with nested OwnsMany for Fields, Conditions, Groups, Groupings
    - Global query filter: `.HasQueryFilter(r => r.TenantId == _tenantId)`
    - FK to ReportCategory (optional, SetNull on delete)
    - FK to ApplicationUser Owner (optional, SetNull on delete)
    - GIN index on Definition JSONB column
    - Composite index on (TenantId, EntityType) for fast entity-type queries
    - Index on (TenantId, OwnerId, IsShared) for access filtering

    **ReportCategoryConfiguration.cs** — EF Core config:
    - Table "report_categories" with snake_case columns
    - Global query filter for TenantId
    - Unique index on (TenantId, Name)

    **ApplicationDbContext.cs** — Add:
    - `DbSet<Report> Reports { get; set; }`
    - `DbSet<ReportCategory> ReportCategories { get; set; }`
    - Apply configurations in OnModelCreating

    **Migration** — Run:
    ```
    cd src/GlobCRM.Api && dotnet ef migrations add AddReports --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure
    ```
    Then apply: `dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`

    **RLS** — Append to scripts/rls-setup.sql:
    - `ALTER TABLE reports ENABLE ROW LEVEL SECURITY;`
    - `CREATE POLICY tenant_isolation_reports ON reports USING (tenant_id = current_setting('app.current_tenant')::uuid);`
    - Same for report_categories

    **ReportRepository.cs** — In `src/GlobCRM.Infrastructure/Reporting/`:
    - Implements IReportRepository
    - Inject ApplicationDbContext
    - GetAllAsync: filter by categoryId, entityType, search (name contains), access control (owner OR shared OR seedData), paginate with Count + Skip/Take
    - Standard CRUD with Include(r => r.Category)
    - Category CRUD methods

    **NuGet** — Add System.Linq.Dynamic.Core to GlobCRM.Infrastructure.csproj:
    ```
    <PackageReference Include="System.Linq.Dynamic.Core" Version="1.*" />
    ```

    **DI** — Register in DependencyInjection.cs:
    - `services.AddScoped<IReportRepository, ReportRepository>();`
  </action>
  <verify>
    Migration created and applied: `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`
    Build succeeds: `cd src/GlobCRM.Api && dotnet build`
  </verify>
  <done>EF Core configurations map Report/ReportCategory to PostgreSQL with JSONB definition, migration creates tables with indexes, RLS policies enforce tenant isolation, repository implements all CRUD operations, System.Linq.Dynamic.Core installed.</done>
</task>

</tasks>

<verification>
- `dotnet build` passes with 0 errors
- Migration exists and applies cleanly
- Report and ReportCategory tables visible in database
- RLS policies added to rls-setup.sql
- System.Linq.Dynamic.Core in project references
</verification>

<success_criteria>
Report domain foundation is complete: entities with JSONB definition stored in PostgreSQL, tenant-isolated via RLS and query filters, accessible through repository pattern, with RBAC permission support.
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-01-SUMMARY.md`
</output>
