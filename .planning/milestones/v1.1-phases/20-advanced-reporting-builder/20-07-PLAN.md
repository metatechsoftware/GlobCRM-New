---
phase: 20-advanced-reporting-builder
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs
  - src/GlobCRM.Api/Controllers/ReportsController.cs
autonomous: true
gap_closure: true
requirements: [RPT-01, RPT-04, RPT-05]

must_haves:
  truths:
    - "Gallery API returns reports without materializing Definition JSONB"
    - "ReportListDto.ChartType returns lowercase strings matching frontend type"
    - "ReportDto.ChartType returns lowercase strings matching frontend type"
  artifacts:
    - path: "src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs"
      provides: "GetAllAsync with .Select() projection avoiding Definition materialization"
      contains: ".Select("
    - path: "src/GlobCRM.Api/Controllers/ReportsController.cs"
      provides: "ChartType .ToString().ToLowerInvariant() in both DTOs"
      contains: "ToLowerInvariant"
  key_links:
    - from: "src/GlobCRM.Api/Controllers/ReportsController.cs"
      to: "frontend ReportChartType"
      via: "ChartType lowercase serialization"
      pattern: "ToLowerInvariant"
---

<objective>
Fix backend issues causing empty gallery and mismatched chart type thumbnails.

Purpose: UAT Test 2 ("Gallery displays seed starter report cards") failed because (1) GetAllAsync loads full Report entities including the heavy Definition JSONB column — if JSONB deserialization fails for any reason, the 500 error is swallowed and gallery shows empty; and (2) ChartType.ToString() produces PascalCase ("Bar", "Funnel") but the frontend expects lowercase ("bar", "funnel"), so SVG thumbnail @switch cases never match.

Output: Backend returns lightweight report list data without Definition JSONB, and ChartType values are lowercase.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-advanced-reporting-builder/20-UAT.md
@src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs
@src/GlobCRM.Api/Controllers/ReportsController.cs
@src/GlobCRM.Domain/Entities/Report.cs
@src/GlobCRM.Domain/Enums/ReportChartType.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ReportRepository.GetAllAsync to use projection and fix ChartType casing in DTOs</name>
  <files>
    src/GlobCRM.Infrastructure/Reporting/ReportRepository.cs
    src/GlobCRM.Api/Controllers/ReportsController.cs
  </files>
  <action>
Two changes are needed:

**1. ReportRepository.cs — GetAllAsync projection (lines 33-75):**

Replace the current query that materializes full Report entities (including the heavy Definition JSONB) with a `.Select()` projection that only retrieves the columns needed for the list view. The current code:
```csharp
var items = await query
    .OrderByDescending(r => r.UpdatedAt)
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();
```

Change `GetAllAsync` to return `(List<Report> Items, int TotalCount)` but use `.Select()` to project ONLY the properties needed by `ReportListDto`:
- Id, Name, Description, EntityType, ChartType, CategoryId, Category (navigation for CategoryName), OwnerId, Owner (navigation for OwnerName), IsShared, IsSeedData, LastRunAt, LastRunRowCount, CreatedAt, UpdatedAt

**Do NOT include `Definition` in the projection.** This is the root cause — Definition is a complex JSONB owned type. If EF Core has any issue deserializing the nested owned types (ReportFilterGroup with recursive Groups, ReportChartConfig with ReportChartType enum), it throws a 500 that gets caught silently by the frontend store.

The cleanest approach: Project into an anonymous type and map back to Report objects (without Definition), OR create a separate projection that omits Definition. Since the return type is `List<Report>`, the safest fix is to use `.Select()` to create Report objects with `Definition = new ReportDefinition()` as default (an empty definition placeholder). This way the existing ReportListDto.FromEntity still works and Definition is never deserialized from the DB for list queries.

```csharp
var items = await query
    .OrderByDescending(r => r.UpdatedAt)
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .Select(r => new Report
    {
        Id = r.Id,
        TenantId = r.TenantId,
        Name = r.Name,
        Description = r.Description,
        EntityType = r.EntityType,
        ChartType = r.ChartType,
        CategoryId = r.CategoryId,
        Category = r.Category,
        OwnerId = r.OwnerId,
        Owner = r.Owner,
        IsShared = r.IsShared,
        IsSeedData = r.IsSeedData,
        LastRunAt = r.LastRunAt,
        LastRunRowCount = r.LastRunRowCount,
        CreatedAt = r.CreatedAt,
        UpdatedAt = r.UpdatedAt,
        // Definition intentionally excluded — not needed for list view
        // and avoids JSONB deserialization issues
    })
    .ToListAsync();
```

NOTE: EF Core may not allow projecting into the same entity type used in the DbSet. If that is the case, instead add `.AsNoTracking()` to the query and use a manual approach: load without Definition by selecting into an anonymous type, then map:

```csharp
var projected = await query
    .OrderByDescending(r => r.UpdatedAt)
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .AsNoTracking()
    .Select(r => new
    {
        r.Id, r.TenantId, r.Name, r.Description, r.EntityType,
        r.ChartType, r.CategoryId, CategoryName = r.Category != null ? r.Category.Name : null,
        r.OwnerId,
        OwnerFirstName = r.Owner != null ? r.Owner.FirstName : null,
        OwnerLastName = r.Owner != null ? r.Owner.LastName : null,
        r.IsShared, r.IsSeedData, r.LastRunAt, r.LastRunRowCount,
        r.CreatedAt, r.UpdatedAt
    })
    .ToListAsync();

var items = projected.Select(r => new Report
{
    Id = r.Id,
    TenantId = r.TenantId,
    Name = r.Name,
    Description = r.Description,
    EntityType = r.EntityType,
    ChartType = r.ChartType,
    CategoryId = r.CategoryId,
    Category = r.CategoryName != null ? new ReportCategory { Name = r.CategoryName } : null,
    OwnerId = r.OwnerId,
    Owner = r.OwnerFirstName != null ? new ApplicationUser { FirstName = r.OwnerFirstName, LastName = r.OwnerLastName ?? "" } : null,
    IsShared = r.IsShared,
    IsSeedData = r.IsSeedData,
    LastRunAt = r.LastRunAt,
    LastRunRowCount = r.LastRunRowCount,
    CreatedAt = r.CreatedAt,
    UpdatedAt = r.UpdatedAt,
}).ToList();
```

Add the required `using` for `ApplicationUser` entity if not already present.

**2. ReportsController.cs — Fix ChartType casing (lines 614 and 652):**

In `ReportDto.FromEntity` (line 614):
Change: `ChartType = r.ChartType.ToString(),`
To: `ChartType = r.ChartType.ToString().ToLowerInvariant(),`

In `ReportListDto.FromEntity` (line 652):
Change: `ChartType = r.ChartType.ToString(),`
To: `ChartType = r.ChartType.ToString().ToLowerInvariant(),`

This ensures the frontend receives "bar", "line", "pie", "funnel", "table" — matching the `ReportChartType` TypeScript type `'table' | 'bar' | 'line' | 'pie' | 'funnel'`. The `@switch (report().chartType)` cases in the report card SVG thumbnail will then correctly match.
  </action>
  <verify>
Run `cd /Users/metatech/Documents/globcrm-claude-starter/src/GlobCRM.Api && dotnet build` to confirm compilation succeeds.

Grep for `ToLowerInvariant` in ReportsController.cs — should appear at lines where ChartType is mapped in both DTOs.

Grep for `Definition` in ReportRepository.cs GetAllAsync method — the word "Definition" should NOT appear in the projection (only in a comment explaining its exclusion).
  </verify>
  <done>
Backend compiles successfully. GetAllAsync uses projection that excludes Definition JSONB. Both ReportDto and ReportListDto return lowercase ChartType strings.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` in src/GlobCRM.Api passes with no errors
2. ReportRepository.GetAllAsync no longer materializes Definition JSONB
3. ChartType values in API responses will be lowercase ("bar" not "Bar")
</verification>

<success_criteria>
- Backend compiles without errors
- GetAllAsync excludes Definition from query projection
- Both DTO FromEntity methods produce lowercase ChartType strings
- The gallery API endpoint returns report list data safely without JSONB deserialization risk
</success_criteria>

<output>
After completion, create `.planning/phases/20-advanced-reporting-builder/20-07-SUMMARY.md`
</output>
