---
phase: 19-workflow-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/GlobCRM.Domain/Entities/Workflow.cs
  - src/GlobCRM.Domain/Entities/WorkflowExecutionLog.cs
  - src/GlobCRM.Domain/Entities/WorkflowActionLog.cs
  - src/GlobCRM.Domain/Entities/WorkflowTemplate.cs
  - src/GlobCRM.Domain/Enums/WorkflowStatus.cs
  - src/GlobCRM.Domain/Enums/WorkflowTriggerType.cs
  - src/GlobCRM.Domain/Enums/WorkflowActionType.cs
  - src/GlobCRM.Domain/Enums/WorkflowExecutionStatus.cs
  - src/GlobCRM.Domain/Enums/EntityType.cs
  - src/GlobCRM.Domain/Interfaces/IWorkflowRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowExecutionLogConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowActionLogConfiguration.cs
  - src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowTemplateConfiguration.cs
  - src/GlobCRM.Infrastructure/Workflows/WorkflowRepository.cs
  - src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
  - src/GlobCRM.Infrastructure/DependencyInjection.cs
  - src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
  - scripts/rls-setup.sql
autonomous: true
requirements:
  - WFLOW-01
  - WFLOW-02
  - WFLOW-03
  - WFLOW-11
  - WFLOW-12
  - WFLOW-13

must_haves:
  truths:
    - "Workflow entity can store event triggers, field-change triggers, and date-based triggers in JSONB definition"
    - "WorkflowExecutionLog and WorkflowActionLog entities capture full audit trail of trigger, conditions, and action results"
    - "Workflow has IsActive flag for enable/disable without deletion"
    - "WorkflowTemplate entity supports both system and tenant-scoped custom templates"
    - "Workflow entity stores denormalized TriggerSummary for fast event matching queries"
  artifacts:
    - path: "src/GlobCRM.Domain/Entities/Workflow.cs"
      provides: "Core workflow entity with JSONB definition, TriggerSummary, IsActive, EntityType"
      contains: "WorkflowDefinition"
    - path: "src/GlobCRM.Domain/Entities/WorkflowExecutionLog.cs"
      provides: "Execution log with trigger event, condition result, overall status"
      contains: "WorkflowExecutionStatus"
    - path: "src/GlobCRM.Domain/Entities/WorkflowActionLog.cs"
      provides: "Per-action log with type, success/failure, error, duration"
      contains: "ActionStatus"
    - path: "src/GlobCRM.Domain/Entities/WorkflowTemplate.cs"
      provides: "Template entity with IsSystem flag and category"
      contains: "IsSystem"
    - path: "src/GlobCRM.Infrastructure/Workflows/WorkflowRepository.cs"
      provides: "CRUD + active workflow retrieval for trigger matching"
      contains: "GetActiveWorkflowsAsync"
  key_links:
    - from: "src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs"
      to: "Workflow entity"
      via: "DbSet and HasQueryFilter"
      pattern: "DbSet<Workflow>"
    - from: "src/GlobCRM.Infrastructure/Workflows/WorkflowRepository.cs"
      to: "ApplicationDbContext"
      via: "EF Core queries"
      pattern: "_context\\.Workflows"
---

<objective>
Create the Workflow domain foundation: entities, enums, EF Core configurations, migration, RLS policies, repository, and seed data.

Purpose: Establishes the data layer for the entire workflow automation system — the Workflow entity with its JSONB definition (storing the visual flow graph plus trigger/condition/action configurations), execution log entities for audit trail, and template entity for reusable workflow starting points.

Output: Four new domain entities (Workflow, WorkflowExecutionLog, WorkflowActionLog, WorkflowTemplate), four new enums, EF Core configurations with JSONB columns and indexes, applied PostgreSQL migration, RLS policies, repository implementation, and demo seed data.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md
@src/GlobCRM.Domain/Entities/WebhookSubscription.cs
@src/GlobCRM.Domain/Interfaces/IDomainEvent.cs
@src/GlobCRM.Domain/Interfaces/IWebhookRepository.cs
@src/GlobCRM.Infrastructure/Persistence/Configurations/WebhookSubscriptionConfiguration.cs
@src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
@src/GlobCRM.Infrastructure/Webhooks/WebhookRepository.cs
@src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
@src/GlobCRM.Domain/Enums/EntityType.cs
@scripts/rls-setup.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain entities, enums, and repository interface</name>
  <files>
    src/GlobCRM.Domain/Entities/Workflow.cs
    src/GlobCRM.Domain/Entities/WorkflowExecutionLog.cs
    src/GlobCRM.Domain/Entities/WorkflowActionLog.cs
    src/GlobCRM.Domain/Entities/WorkflowTemplate.cs
    src/GlobCRM.Domain/Enums/WorkflowStatus.cs
    src/GlobCRM.Domain/Enums/WorkflowTriggerType.cs
    src/GlobCRM.Domain/Enums/WorkflowActionType.cs
    src/GlobCRM.Domain/Enums/WorkflowExecutionStatus.cs
    src/GlobCRM.Domain/Enums/EntityType.cs
    src/GlobCRM.Domain/Interfaces/IWorkflowRepository.cs
  </files>
  <action>
Create all workflow domain entities and supporting types. Follow the existing WebhookSubscription pattern for entity structure.

**Workflow.cs:**
- `Id` (Guid, default NewGuid), `TenantId` (Guid), `Name` (string, max 200), `Description` (string?, max 1000)
- `EntityType` (string, max 50) — the target CRM entity ("Contact", "Company", "Deal", "Lead", "Activity")
- `Definition` (WorkflowDefinition) — JSONB column storing the full visual flow graph AND logical configuration as a single document. This is the single source of truth for both canvas rendering and execution engine.
- `TriggerSummary` (List&lt;string&gt;) — denormalized from Definition on save for fast trigger matching queries. Format: "RecordCreated", "RecordUpdated", "FieldChanged:Status", "DateBased:CloseDate", etc.
- `Status` (WorkflowStatus enum: Draft, Active, Paused)
- `IsActive` (bool, default false) — quick toggle for enable/disable (WFLOW-12). Active = Status is Active AND IsActive is true.
- `CreatedByUserId` (Guid)
- `ExecutionCount` (int, default 0), `LastExecutedAt` (DateTimeOffset?)
- `IsSeedData` (bool), `CreatedAt`/`UpdatedAt` (DateTimeOffset)

**WorkflowDefinition** (nested class or separate file, used as JSONB owned entity):
- `Nodes` (List&lt;WorkflowNode&gt;) — visual node positions and metadata
- `Connections` (List&lt;WorkflowConnection&gt;) — edges between nodes
- `Triggers` (List&lt;WorkflowTriggerConfig&gt;) — trigger configurations
- `Conditions` (List&lt;WorkflowConditionGroup&gt;) — AND/OR condition groups per the locked decision (AND within group, OR across groups, matching filter panel pattern)
- `Actions` (List&lt;WorkflowActionConfig&gt;) — action configurations with ContinueOnError flag per locked decision

**WorkflowNode:** `Id` (string), `Type` (string: "trigger", "condition", "action", "branch", "wait"), `Label` (string), `Position` ({ X, Y }), `Config` (Dictionary&lt;string, object?&gt;?)

**WorkflowConnection:** `Id` (string), `SourceNodeId` (string), `TargetNodeId` (string), `SourceOutput` (string?, for branch "yes"/"no")

**WorkflowTriggerConfig:** `Id` (string), `NodeId` (string), `TriggerType` (WorkflowTriggerType), `EventType` (string? — "Created"/"Updated"/"Deleted"), `FieldName` (string?), `DateOffsetDays` (int?), `PreferredTime` (TimeOnly? — per discretion: offset + optional execution time)

**WorkflowConditionGroup:** `Id` (string), `NodeId` (string), `Conditions` (List&lt;WorkflowCondition&gt;)
**WorkflowCondition:** `Field` (string), `Operator` (string — "equals", "not_equals", "gt", "gte", "lt", "lte", "contains", "changed_to", "changed_from_to", "is_null", "is_not_null"), `Value` (string?), `FromValue` (string? — for "changed_from_to", per locked decision: from is optional)

**WorkflowActionConfig:** `Id` (string), `NodeId` (string), `ActionType` (WorkflowActionType), `ContinueOnError` (bool, default false — per locked decision), `Order` (int), `Config` (Dictionary&lt;string, object?&gt;) — type-specific config:
  - UpdateField: { FieldName, Value, IsDynamic, DynamicSourceField } — per locked decision: supports both static values and dynamic mapping from trigger entity fields
  - SendNotification: { Title, Message, RecipientType ("record_owner", "deal_owner", "specific_user", "team"), RecipientId? }
  - CreateActivity: { Subject, Type, Priority, DueDateOffsetDays, AssigneeType ("record_owner", "deal_owner", "specific_user"), AssigneeId? } — per locked decision: dynamic assignment with record owner and deal owner as first-class options
  - SendEmail: { EmailTemplateId, RecipientField } — reuses Phase 14 templates
  - FireWebhook: { Url, Headers, PayloadTemplate } — per WFLOW-08
  - EnrollInSequence: { SequenceId } — per WFLOW-09
  - Branch: { ConditionGroups (same AND/OR structure) } — per discretion: support if/else branching with "yes"/"no" outputs
  - Wait: { DelayMinutes, DelayHours, DelayDays } — per discretion: support wait/delay nodes via Hangfire Schedule

**WorkflowExecutionLog.cs:**
- `Id` (Guid), `TenantId` (Guid), `WorkflowId` (Guid, FK to Workflow with Cascade delete)
- `TriggerType` (string), `TriggerEvent` (string), `EntityId` (Guid), `EntityType` (string)
- `ConditionsEvaluated` (bool), `ConditionsPassed` (bool)
- `Status` (WorkflowExecutionStatus: Succeeded, PartiallyFailed, Failed, Skipped)
- `ErrorMessage` (string?), `StartedAt`/`CompletedAt` (DateTimeOffset), `DurationMs` (int)
- Navigation: `Workflow`, `ActionLogs` (List&lt;WorkflowActionLog&gt;)
- `CreatedAt` (DateTimeOffset)

**WorkflowActionLog.cs:**
- `Id` (Guid), `TenantId` (Guid), `ExecutionLogId` (Guid, FK to ExecutionLog with Cascade delete)
- `ActionType` (WorkflowActionType as string), `ActionNodeId` (string), `Order` (int)
- `Status` (string: "Succeeded", "Failed", "Skipped")
- `ErrorMessage` (string?, max 2000), `StartedAt`/`CompletedAt` (DateTimeOffset?), `DurationMs` (int)
- Navigation: `ExecutionLog`

**WorkflowTemplate.cs:**
- `Id` (Guid), `TenantId` (Guid), `Name` (string, max 200), `Description` (string?, max 1000)
- `Category` (string, max 50 — "sales", "engagement", "operational", "custom")
- `EntityType` (string, max 50)
- `Definition` (WorkflowDefinition) — full copy of workflow definition (per locked decision: applying creates copy, no link to original)
- `IsSystem` (bool) — true for prebuilt templates, false for user-saved custom templates (shown with "Custom" badge per locked decision)
- `CreatedByUserId` (Guid?), `IsSeedData` (bool), `CreatedAt`/`UpdatedAt` (DateTimeOffset)

**Enums:**
- `WorkflowStatus`: Draft, Active, Paused
- `WorkflowTriggerType`: RecordCreated, RecordUpdated, RecordDeleted, FieldChanged, DateBased
- `WorkflowActionType`: UpdateField, SendNotification, CreateActivity, SendEmail, FireWebhook, EnrollInSequence, Branch, Wait
- `WorkflowExecutionStatus`: Succeeded, PartiallyFailed, Failed, Skipped
- Add `Workflow` to `EntityType` enum (for RBAC permissions)

**IWorkflowRepository.cs:**
- `GetByIdAsync(Guid id)` — includes nothing (definition is JSONB)
- `GetByIdWithLogsAsync(Guid id)` — includes ExecutionLogs with ActionLogs
- `GetAllAsync(string? entityType, WorkflowStatus? status, int page, int pageSize)` — paginated list
- `GetActiveWorkflowsAsync(string entityType)` — active workflows for trigger matching (IsActive && Status == Active, filtered by EntityType)
- `GetActiveWorkflowsWithDateTriggersAsync()` — for date trigger scan (cross-entity-type)
- `CreateAsync(Workflow workflow)`
- `UpdateAsync(Workflow workflow)`
- `DeleteAsync(Guid id)`
- `GetExecutionLogsAsync(Guid workflowId, int page, int pageSize)` — paginated logs
- `GetExecutionLogDetailAsync(Guid logId)` — single log with action logs
- Template methods: `GetTemplatesAsync(string? category)`, `GetTemplateByIdAsync(Guid id)`, `CreateTemplateAsync(WorkflowTemplate template)`, `DeleteTemplateAsync(Guid id)`
  </action>
  <verify>Build `cd src/GlobCRM.Api && dotnet build` succeeds with 0 errors. All entity files exist in Domain/Entities/. All enum files exist in Domain/Enums/. EntityType enum includes Workflow.</verify>
  <done>Four domain entities (Workflow, WorkflowExecutionLog, WorkflowActionLog, WorkflowTemplate), four enums, and IWorkflowRepository interface created with all properties matching research specification and locked decisions honored.</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, migration, RLS, repository, DbContext, and seed data</name>
  <files>
    src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowExecutionLogConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowActionLogConfiguration.cs
    src/GlobCRM.Infrastructure/Persistence/Configurations/WorkflowTemplateConfiguration.cs
    src/GlobCRM.Infrastructure/Workflows/WorkflowRepository.cs
    src/GlobCRM.Infrastructure/Persistence/ApplicationDbContext.cs
    src/GlobCRM.Infrastructure/DependencyInjection.cs
    src/GlobCRM.Infrastructure/MultiTenancy/TenantSeeder.cs
    scripts/rls-setup.sql
  </files>
  <action>
Create EF Core configurations, run migration, add RLS policies, implement repository, and add seed data. Follow existing WebhookSubscriptionConfiguration and WebhookRepository patterns exactly.

**WorkflowConfiguration.cs:**
- Table: "workflows", snake_case column names
- `Name` max 200, required; `Description` max 1000; `EntityType` max 50, required
- `Definition` as owned JSON: `builder.OwnsOne(w => w.Definition, d => { d.ToJson("definition"); })` — stores full WorkflowDefinition as JSONB
- `TriggerSummary` as `jsonb` column type with default `'[]'::jsonb`
- `Status` as string conversion, max 20
- Index: composite `(TenantId, IsActive, EntityType)` named `ix_workflows_tenant_active_entity` for fast trigger matching
- Index: `TenantId` named `ix_workflows_tenant`
- Global query filter: standard tenant isolation pattern matching ApplicationDbContext

**WorkflowExecutionLogConfiguration.cs:**
- Table: "workflow_execution_logs", snake_case
- FK to Workflow with Cascade delete (logs deleted with workflow)
- `Status` as string conversion, max 30
- `TriggerType` max 50, `TriggerEvent` max 100, `EntityType` max 50
- `ErrorMessage` max 2000
- Index: `(WorkflowId, StartedAt desc)` for chronological log queries
- Index: `TenantId`
- Global query filter for tenant isolation

**WorkflowActionLogConfiguration.cs:**
- Table: "workflow_action_logs", snake_case
- FK to WorkflowExecutionLog with Cascade delete
- `ActionType` max 50, `ActionNodeId` max 100, `Status` max 20
- `ErrorMessage` max 2000
- Index: `ExecutionLogId`
- NO separate tenant query filter needed — inherited via ExecutionLog FK cascade

**WorkflowTemplateConfiguration.cs:**
- Table: "workflow_templates", snake_case
- `Name` max 200, required; `Description` max 1000; `Category` max 50; `EntityType` max 50
- `Definition` as owned JSON (same as Workflow)
- Index: `(TenantId, Category)` for gallery filtering
- Unique index: `(TenantId, Name)` to prevent duplicate template names
- Global query filter for tenant isolation

**ApplicationDbContext.cs:**
- Add DbSets: `Workflows`, `WorkflowExecutionLogs`, `WorkflowActionLogs`, `WorkflowTemplates`
- Apply all 4 configurations in OnModelCreating
- Add global query filters for Workflow, WorkflowExecutionLog, WorkflowTemplate (not ActionLog — cascade)

**Migration:**
- Run: `cd src/GlobCRM.Api && dotnet ef migrations add AddWorkflows --context ApplicationDbContext --output-dir Persistence/Migrations/App --project ../GlobCRM.Infrastructure`
- Apply: `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure`

**RLS policies** in `scripts/rls-setup.sql`:
```sql
-- Workflow Automation RLS
ALTER TABLE workflows ENABLE ROW LEVEL SECURITY;
CREATE POLICY workflows_tenant_isolation ON workflows
    USING (tenant_id = current_setting('app.current_tenant')::uuid);

ALTER TABLE workflow_execution_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY workflow_execution_logs_tenant_isolation ON workflow_execution_logs
    USING (tenant_id = current_setting('app.current_tenant')::uuid);

ALTER TABLE workflow_templates ENABLE ROW LEVEL SECURITY;
CREATE POLICY workflow_templates_tenant_isolation ON workflow_templates
    USING (tenant_id = current_setting('app.current_tenant')::uuid);
```
(workflow_action_logs inherits isolation through FK cascade from execution_logs)

**WorkflowRepository.cs:**
- Implement IWorkflowRepository following WebhookRepository patterns
- `GetActiveWorkflowsAsync(entityType)`: filter `IsActive && Status == WorkflowStatus.Active && EntityType == entityType`, project to avoid loading full definition for trigger matching where possible (though definition is needed for condition evaluation — load full entity)
- `GetAllAsync`: paginated with OrderByDescending(w => w.UpdatedAt), return (items, totalCount)
- `GetExecutionLogsAsync`: Include ActionLogs, OrderByDescending StartedAt, paginated
- Template methods: filter by category, order by IsSystem desc then Name for system templates first
- Register `IWorkflowRepository` as scoped in DependencyInjection.cs

**TenantSeeder:**
- Add cleanup: delete workflows, workflow_execution_logs, workflow_action_logs, workflow_templates WHERE is_seed_data = true
- Add `SeedWorkflowsAsync` creating 2 demo workflows:
  1. "New Deal Notification" — trigger: Deal.Created, action: SendNotification to deal owner. EntityType: "Deal". Status: Active, IsActive: true.
  2. "Lead Follow-Up Task" — trigger: Lead.Updated, condition: Status changed to "Qualified", action: CreateActivity (follow-up task assigned to record owner, due in 1 day). EntityType: "Lead". Status: Active, IsActive: true.
- Both should have realistic WorkflowDefinition with positioned nodes and connections
- Add 3 system WorkflowTemplates (IsSystem: true, IsSeedData: true):
  1. "Deal Won Celebration" (category: "sales") — trigger: Deal.Updated, condition: Stage changed to "Won", actions: SendNotification + SendEmail
  2. "Welcome New Contact" (category: "engagement") — trigger: Contact.Created, actions: SendEmail (welcome) + CreateActivity (introduction call in 2 days)
  3. "High-Value Deal Alert" (category: "operational") — trigger: Deal.Created, condition: Value > 10000, action: SendNotification to team

- Also add RBAC permissions for Workflow EntityType by ensuring EntityType enum value is included (handled in Task 1). The RoleTemplateSeeder pattern auto-creates permissions for new EntityType values.
  </action>
  <verify>Run `cd src/GlobCRM.Api && dotnet build` — 0 errors. Run migration: `cd src/GlobCRM.Api && dotnet ef database update --context ApplicationDbContext --project ../GlobCRM.Infrastructure` succeeds. Reseed: `cd src/GlobCRM.Api && dotnet run -- --reseed` completes without errors.</verify>
  <done>Four EF configurations with JSONB columns and indexes applied, migration creating workflows/workflow_execution_logs/workflow_action_logs/workflow_templates tables, RLS policies in rls-setup.sql, WorkflowRepository implementing all IWorkflowRepository methods, DbContext with DbSets and query filters, and TenantSeeder creating 2 demo workflows + 3 system templates.</done>
</task>

</tasks>

<verification>
1. `cd src/GlobCRM.Api && dotnet build` — 0 errors, 0 warnings from project code
2. All domain entity files exist in src/GlobCRM.Domain/Entities/ (Workflow.cs, WorkflowExecutionLog.cs, WorkflowActionLog.cs, WorkflowTemplate.cs)
3. All enum files exist in src/GlobCRM.Domain/Enums/ (WorkflowStatus.cs, WorkflowTriggerType.cs, WorkflowActionType.cs, WorkflowExecutionStatus.cs)
4. EntityType enum includes Workflow value
5. Migration applied successfully creating 4 tables in PostgreSQL
6. RLS policies added to rls-setup.sql for 3 tables
7. `cd src/GlobCRM.Api && dotnet run -- --reseed` completes with seed workflows and templates
</verification>

<success_criteria>
- Workflow entity stores full visual flow definition as JSONB with denormalized TriggerSummary for fast matching
- WorkflowDefinition supports triggers (event, field-change, date-based), AND/OR condition groups, and all 8 action types (including Branch and Wait per discretion)
- ExecutionLog + ActionLog entities provide complete audit trail
- WorkflowTemplate supports both system templates and tenant-scoped custom templates
- Repository provides efficient active workflow retrieval for trigger matching
- Seed data creates realistic demo workflows and system template starting points
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-01-SUMMARY.md`
</output>
