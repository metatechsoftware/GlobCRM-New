---
phase: 19-workflow-automation
plan: 05
type: execute
wave: 4
depends_on: [19-04]
files_modified:
  - globcrm-web/package.json
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.scss
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/nodes/trigger-node.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/nodes/condition-node.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/nodes/action-node.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/nodes/branch-node.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/nodes/wait-node.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/trigger-config.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/condition-config.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts
  - globcrm-web/src/app/features/workflows/workflow-builder/workflow-toolbar.component.ts
autonomous: true
requirements:
  - WFLOW-01
  - WFLOW-02
  - WFLOW-03
  - WFLOW-04
  - WFLOW-05
  - WFLOW-06
  - WFLOW-07
  - WFLOW-08
  - WFLOW-09
  - WFLOW-10
  - WFLOW-13

must_haves:
  truths:
    - "User can drag and drop trigger, condition, action, branch, and wait nodes on a visual flow canvas"
    - "User can connect nodes with directional edges to define the workflow execution flow"
    - "User can configure each node via a sidebar panel (trigger events, condition operators, action settings)"
    - "User can add multiple triggers (OR logic) and multiple actions in a single workflow"
    - "User can open a template gallery sidebar and apply a template to populate the canvas"
    - "User can save/update the workflow and toggle active status from a toolbar"
  artifacts:
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts"
      provides: "Main builder page with canvas + sidebar layout"
      contains: "WorkflowBuilderComponent"
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts"
      provides: "@foblex/flow canvas wrapper with drag-and-drop nodes"
      contains: "FFlowModule"
    - path: "globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts"
      provides: "Template picker sidebar for applying templates"
      contains: "TemplateGalleryComponent"
  key_links:
    - from: "workflow-builder.component.ts"
      to: "workflow-canvas.component.ts"
      via: "Parent-child composition"
      pattern: "app-workflow-canvas"
    - from: "workflow-canvas.component.ts"
      to: "@foblex/flow"
      via: "FFlowModule imports"
      pattern: "FFlowModule"
    - from: "workflow-builder.component.ts"
      to: "workflow.store.ts"
      via: "Save/load operations"
      pattern: "inject.*WorkflowStore"
---

<objective>
Build the visual workflow builder with @foblex/flow canvas, drag-and-drop node components, configuration panels, template gallery, and toolbar.

Purpose: This is the core user-facing feature — a visual flow canvas where users construct workflows by placing trigger, condition, action, branch, and wait nodes and connecting them. The canvas definition IS the workflow definition (single source of truth per research). This is the most complex frontend component in the project.

Output: @foblex/flow npm packages installed, WorkflowBuilderComponent (main layout), WorkflowCanvasComponent (flow engine), 5 node components, 3 config panels, template gallery, and toolbar.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md
@.planning/phases/19-workflow-automation/19-04-SUMMARY.md
@globcrm-web/src/app/features/workflows/workflow.models.ts
@globcrm-web/src/app/features/workflows/workflow.service.ts
@globcrm-web/src/app/features/workflows/workflow.store.ts
@globcrm-web/src/app/features/workflows/workflows.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @foblex/flow packages and create canvas + node components</name>
  <files>
    globcrm-web/package.json
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-canvas.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/nodes/trigger-node.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/nodes/condition-node.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/nodes/action-node.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/nodes/branch-node.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/nodes/wait-node.component.ts
  </files>
  <action>
**Install @foblex/flow and peer dependencies:**
```bash
cd globcrm-web && npm install @foblex/flow @foblex/platform @foblex/mediator @foblex/2d @foblex/utils
```

**WorkflowCanvasComponent** — the core visual canvas wrapping @foblex/flow:
- Standalone component with `ChangeDetectionStrategy.OnPush`
- Imports: `FFlowModule` (provides f-flow, f-canvas, f-connection), `FDraggableModule` (fDraggable), `FNodeModule` (fNode, fNodeOutput, fNodeInput)
- Inputs:
  - `nodes` (input signal: WorkflowNode[])
  - `connections` (input signal: WorkflowConnection[])
- Outputs:
  - `nodeSelected` (output signal: string — node ID)
  - `nodeAdded` (output signal: { type, position })
  - `connectionCreated` (output signal: { sourceNodeId, targetNodeId, sourceOutput? })
  - `connectionRemoved` (output signal: string — connection ID)
  - `nodePositionChanged` (output signal: { nodeId, position })
  - `nodeDblClicked` (output signal: string — node ID, opens config panel)

- Template structure using @foblex/flow API (per research code example):
  ```html
  <f-flow fDraggable>
    <f-canvas>
      @for (node of nodes(); track node.id) {
        <!-- Use node type to select the right component -->
        @switch (node.type) {
          @case ('trigger') {
            <app-trigger-node [node]="node"
                              (selected)="onNodeSelected(node.id)"
                              (dblclick)="nodeDblClicked.emit(node.id)" />
          }
          @case ('condition') {
            <app-condition-node [node]="node"
                                (selected)="onNodeSelected(node.id)"
                                (dblclick)="nodeDblClicked.emit(node.id)" />
          }
          @case ('action') {
            <app-action-node [node]="node"
                             (selected)="onNodeSelected(node.id)"
                             (dblclick)="nodeDblClicked.emit(node.id)" />
          }
          @case ('branch') {
            <app-branch-node [node]="node"
                             (selected)="onNodeSelected(node.id)"
                             (dblclick)="nodeDblClicked.emit(node.id)" />
          }
          @case ('wait') {
            <app-wait-node [node]="node"
                           (selected)="onNodeSelected(node.id)"
                           (dblclick)="nodeDblClicked.emit(node.id)" />
          }
        }
      }

      @for (conn of connections(); track conn.id) {
        <f-connection
          [fConnectionId]="conn.id"
          [fOutputId]="conn.sourceNodeId + '_output' + (conn.sourceOutput ? '_' + conn.sourceOutput : '')"
          [fInputId]="conn.targetNodeId + '_input'">
        </f-connection>
      }
    </f-canvas>
  </f-flow>
  ```

- Canvas interaction (per discretion recommendations):
  - Zoom: mouse wheel (native fDraggable behavior) + floating zoom controls (zoom in, zoom out, fit-to-view buttons) in bottom-right corner
  - Pan: click-and-drag on canvas background (native fDraggable)
  - Selection: click on node highlights it with a ring border, emits nodeSelected
  - When empty (new workflow per locked decision): show centered text "+ Add trigger to start" with mat-icon, clickable to add first trigger node at center

- Node add handling: right-click context menu or "+" button between nodes. When user adds a node, emit `nodeAdded` with type and canvas position. The parent component creates the WorkflowNode and adds to the nodes array.

**Node Components (all 5 follow same pattern):**

Each node is a standalone component that wraps @foblex/flow node directives:

**TriggerNodeComponent:**
- Template: `<div fNode [fNodeId]="node().id" [fNodePosition]="node().position">` wrapper
- Only has output connector (bottom): `<div fNodeOutput [fOutputId]="node().id + '_output'" fOutputConnectableSide="bottom">`
- NO input connector (triggers are entry points)
- Visual: rounded rectangle with blue (#3B82F6) left border/accent, mat-icon 'bolt' + label
- Shows trigger type badge: "Record Created", "Field Changed", "Date Based"
- Node dimensions: min-width 220px, padding 12px

**ConditionNodeComponent:**
- Has input (top) and output (bottom) connectors
- Visual: amber (#F59E0B) accent, mat-icon 'filter_list' + label
- Shows condition summary (e.g., "Status = Qualified")

**ActionNodeComponent:**
- Has input (top) and output (bottom) connectors
- Visual: green (#10B981) accent, mat-icon varies by action type:
  - updateField → 'edit', sendNotification → 'notifications', createActivity → 'task_alt'
  - sendEmail → 'email', fireWebhook → 'webhook', enrollInSequence → 'schedule_send'
- Shows action type label and brief config summary

**BranchNodeComponent:**
- Has input (top) and TWO output connectors (per discretion: if/else branching):
  - `fOutputId="node.id + '_output_yes'"` labeled "Yes" (left-bottom)
  - `fOutputId="node.id + '_output_no'"` labeled "No" (right-bottom)
- Visual: purple (#8B5CF6) accent, mat-icon 'call_split' + label
- Shows condition summary for the branch

**WaitNodeComponent:**
- Has input (top) and output (bottom) connectors
- Visual: gray (#6B7280) accent, mat-icon 'hourglass_empty' + label
- Shows delay duration (e.g., "Wait 2 days", "Wait 1 hour")

**Shared node styling (in each component or a shared SCSS):**
- Rounded rectangle: `border-radius: 8px`, `background: var(--mat-surface)`, `border: 2px solid transparent`
- Selected state: `border-color: var(--color-primary)`, slight glow shadow
- Hover: subtle shadow elevation
- Connector dots: small circles (10px) at center-top and center-bottom
- Dark mode support via CSS variables
  </action>
  <verify>Run `cd globcrm-web && npx ng build --configuration=development 2>&1 | head -20` — verify build succeeds. Check `ls globcrm-web/node_modules/@foblex/flow` confirms package installed.</verify>
  <done>@foblex/flow installed with all peer deps. WorkflowCanvasComponent renders f-flow canvas with drag-and-drop nodes. Five node components (trigger, condition, action, branch, wait) with type-specific colors, icons, and connector configurations. Branch node has dual outputs for if/else. Empty canvas shows "+ Add trigger to start" prompt per locked decision.</done>
</task>

<task type="auto">
  <name>Task 2: Builder layout, config panels, template gallery, and toolbar</name>
  <files>
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.html
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-builder.component.scss
    globcrm-web/src/app/features/workflows/workflow-builder/panels/trigger-config.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/panels/condition-config.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/panels/action-config.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/panels/template-gallery.component.ts
    globcrm-web/src/app/features/workflows/workflow-builder/workflow-toolbar.component.ts
  </files>
  <action>
Create the main builder page layout, all configuration panels, template gallery, and toolbar.

**WorkflowBuilderComponent** (main page):
- Standalone component, `ChangeDetectionStrategy.OnPush`
- `providers: [WorkflowStore]`
- Route params: `id` input (from route binding). If present, load existing workflow; if absent, new workflow.
- Layout: full-height (calc(100vh - header height)) with 3 sections:
  1. **Toolbar** (top, 48px): workflow name, entity type selector, save button, activate/deactivate, template button
  2. **Canvas** (center, fills remaining space): WorkflowCanvasComponent
  3. **Sidebar** (right, 360px, slide-in/out): configuration panel for selected node OR template gallery
- State management (signals):
  - `workflowName` (signal: string)
  - `workflowDescription` (signal: string)
  - `entityType` (signal: string)
  - `nodes` (signal: WorkflowNode[])
  - `connections` (signal: WorkflowConnection[])
  - `selectedNodeId` (signal: string | null)
  - `sidebarMode` (signal: 'config' | 'templates' | 'add-node' | null)
  - `isDirty` (signal: boolean)
  - `isSaving` (signal: boolean)
- Node management methods:
  - `addNode(type, position?)`: create WorkflowNode with UUID, add to nodes array
  - `removeNode(nodeId)`: remove node and all connected edges
  - `updateNodeConfig(nodeId, config)`: update node's config dictionary
  - `addConnection(source, target, sourceOutput?)`: create WorkflowConnection
  - `removeConnection(connId)`: remove connection
- Save method:
  - Build WorkflowDefinition from current nodes/connections + extract triggers/conditions/actions from node configs
  - If new: call `store.createWorkflow({ name, description, entityType, definition })`
  - If existing: call `store.updateWorkflow(id, { name, description, entityType, definition })`
  - Navigate to workflow detail or show success toast
- Load existing workflow: populate nodes, connections, name, entityType from Workflow.definition

**WorkflowToolbarComponent:**
- Inputs: `workflowName`, `entityType`, `isActive`, `isDirty`, `isSaving`, `isNew` (all input signals)
- Outputs: `nameChanged`, `entityTypeChanged`, `save`, `toggleActive`, `openTemplates`, `back`
- Template:
  - Back button (arrow_back icon, navigates to /workflows)
  - Editable workflow name (inline mat-form-field or click-to-edit)
  - Entity type selector: mat-select with options [Contact, Company, Deal, Lead, Activity]
  - Spacer
  - "Use template" button (per locked decision: opens template gallery sidebar, NOT the default entry point)
  - Activate/Deactivate toggle button (mat-button with play_arrow/pause icon)
  - Save button (mat-raised-button, disabled when !isDirty or isSaving)

**TriggerConfigComponent:**
- Inputs: `node` (WorkflowNode), `entityType` (string), `entityFields` (EntityField[])
- Outputs: `configChanged` (WorkflowTriggerConfig)
- Template (for configuring the selected trigger node):
  - Trigger type selector: mat-select with RecordCreated, RecordUpdated, RecordDeleted, FieldChanged, DateBased
  - For RecordCreated/Updated/Deleted: no additional config needed
  - For FieldChanged:
    - Field selector: mat-select populated from entityFields
    - Per locked decision: conditions use AND/OR grouping (like filter panel). Show condition builder with:
      - Operator selector: equals, not_equals, gt, gte, lt, lte, contains, changed_to, changed_from_to, is_null, is_not_null
      - Value input (text/number depending on field type)
      - For changed_from_to: optional "From" value field + required "To" value field (per locked decision: from is optional)
  - For DateBased:
    - Date field selector (from entityFields, filtered to date/datetime types)
    - Offset: number input + "days before/after" toggle
    - Optional execution time: time picker (per discretion: offset + optional execution time)
  - Per locked decision: multiple triggers supported (OR logic). Show "Add trigger" button when this is the only trigger.

**ConditionConfigComponent:**
- Inputs: `node` (WorkflowNode), `entityFields` (EntityField[])
- Outputs: `configChanged` (WorkflowConditionGroup[])
- Template (per locked decision: AND/OR grouping like filter panel):
  - Condition group builder matching the existing FilterPanelComponent pattern
  - Each group: AND conditions listed vertically with "Add condition" button
  - Groups separated by "OR" divider with "Add group" button
  - Each condition row: field selector + operator dropdown + value input + remove button
  - All operators: equals, not_equals, gt, gte, lt, lte, contains, changed_to, changed_from_to, is_null, is_not_null

**ActionConfigComponent:**
- Inputs: `node` (WorkflowNode), `entityType` (string), `entityFields` (EntityField[])
- Outputs: `configChanged` (WorkflowActionConfig)
- Template (varies by action type):
  - Action type selector at top: mat-select with UpdateField, SendNotification, CreateActivity, SendEmail, FireWebhook, EnrollInSequence
  - "Continue on error" toggle (per locked decision: per-action toggle)
  - **UpdateField config:**
    - Field selector from entityFields
    - Value input OR dynamic mapping toggle (per locked decision: supports both static values and dynamic mapping)
    - When dynamic: show "Source field" selector (merge-field-style picker selecting from trigger entity fields)
  - **SendNotification config:**
    - Title + Message text inputs
    - Recipient type: radio group (Record Owner, Deal Owner, Specific User, Team)
    - If Specific User: user autocomplete dropdown
    - If Team: team selector dropdown
  - **CreateActivity config:**
    - Subject text input
    - Activity type: mat-select (Call, Meeting, Task, Email, Other)
    - Priority: mat-select (Low, Medium, High, Urgent)
    - Due date offset: number input "days from now"
    - Assignee type: radio group (Record Owner, Deal Owner, Specific User) — per locked decision: dynamic assignment with record owner and deal owner as first-class options
    - If Specific User: user autocomplete dropdown
  - **SendEmail config:**
    - Email template selector: mat-select populated from email templates API
    - Recipient field: mat-select from entityFields (default: "email")
  - **FireWebhook config:**
    - URL text input
    - Optional headers: key-value pair editor
    - Optional payload template textarea
  - **EnrollInSequence config:**
    - Sequence selector: mat-select populated from sequences API
    - Note: only valid when entityType is "Contact"
  - **Branch config** (shown when node type is "branch"):
    - Same condition group builder as ConditionConfigComponent
    - "Yes" path label, "No" path label
  - **Wait config** (shown when node type is "wait"):
    - Duration: number input + unit selector (minutes, hours, days)

**TemplateGalleryComponent:**
- Inputs: `entityType` (string)
- Outputs: `templateApplied` (WorkflowDefinition)
- Template (per locked decision: "Use template" button in sidebar opens template gallery):
  - Category tabs: All, Sales, Engagement, Operational, Custom
  - Template cards (list view, not grid — sidebar is narrow):
    - Template name, description, entity type badge
    - IsSystem: show "System" badge; !IsSystem: show "Custom" badge (per locked decision)
    - "Apply" button on each card
  - Applying a template (per locked decision): creates full copy, populates the canvas with the template's nodes and connections. User edits freely. Confirm dialog: "This will replace your current workflow. Continue?"
  - Load templates from WorkflowService.getTemplates()

**Add-node panel** (inline in builder, not separate component):
- When user clicks "+" between nodes or uses context menu:
  - Show a panel with node type options: Trigger, Condition, Action, Branch, Wait
  - Each option shows icon and description
  - Clicking adds the node at the selected position on canvas
  </action>
  <verify>Navigate to http://localhost:4200/workflows/new — builder page loads with empty canvas showing "+ Add trigger to start". Add nodes, connect them, configure via sidebar panels. Save creates a workflow. Template gallery opens from toolbar button.</verify>
  <done>WorkflowBuilderComponent with toolbar + canvas + sidebar layout. Full configuration panels for triggers (event/field-change/date with AND/OR conditions), actions (all 6 types with dynamic mapping), branches, and waits. Template gallery with category filtering and template application. Save/load workflow definition as single JSONB document.</done>
</task>

</tasks>

<verification>
1. `cd globcrm-web && npx ng build --configuration=development` — 0 errors
2. Navigate to /workflows/new — empty canvas with "+ Add trigger to start" prompt (locked decision)
3. Add trigger node → opens trigger config panel in sidebar
4. Add condition node → AND/OR condition group builder (locked decision)
5. Add action nodes → type-specific config panels for all 6 action types
6. Add branch node → dual "Yes"/"No" outputs with condition config
7. Add wait node → delay duration config
8. Connect nodes with directional edges via drag
9. "Use template" button opens template gallery sidebar (locked decision: optional, not default entry point)
10. Apply template replaces canvas content (locked decision: full copy)
11. Save persists workflow with full definition as JSONB
12. Load existing workflow populates canvas from saved definition
</verification>

<success_criteria>
- Visual flow canvas with drag-and-drop nodes and connections (locked decision)
- All node types work: trigger, condition, action, branch, wait
- Configuration panels for each node type with all action-specific settings
- AND/OR condition grouping (locked decision)
- Dynamic field mapping for UpdateField action (locked decision: merge-field-style picker)
- Dynamic assignment for CreateActivity (locked decision: record owner, deal owner as first-class options)
- Template gallery with system + custom templates (locked decision)
- New workflow starts with empty canvas (locked decision)
- Per-action "Continue on error" toggle (locked decision)
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-05-SUMMARY.md`
</output>
