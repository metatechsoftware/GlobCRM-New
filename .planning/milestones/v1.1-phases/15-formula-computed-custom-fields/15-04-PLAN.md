---
phase: 15-formula-computed-custom-fields
plan: 04
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
  - globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
  - globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts
  - globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.html
autonomous: true
requirements:
  - FORM-04

must_haves:
  truths:
    - "Formula field values display in dynamic table columns as read-only computed values"
    - "Formula errors display as '#ERR' with tooltip showing the error reason in dynamic tables"
    - "Formula columns are display-only (not sortable or filterable) in dynamic tables"
    - "Formula field values display as read-only in entity detail page custom field sections"
    - "Formula fields in custom-field-form are rendered as read-only display (no input control)"
  artifacts:
    - path: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      provides: "Formula error detection and #ERR display with tooltip"
      contains: "formulaError"
    - path: "globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts"
      provides: "Read-only formula field display in detail page forms"
      contains: "Formula"
  key_links:
    - from: "globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts"
      to: "globcrm-web/src/app/core/custom-fields/custom-field.models.ts"
      via: "uses isFormulaError type guard"
      pattern: "isFormulaError"
    - from: "globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts"
      to: "globcrm-web/src/app/core/custom-fields/custom-field.models.ts"
      via: "checks CustomFieldType.Formula for read-only rendering"
      pattern: "CustomFieldType.Formula"
---

<objective>
Implement formula field display across all frontend views: dynamic table columns show computed values or '#ERR' with tooltip, and custom-field-form sections on detail pages render formula values as read-only. Formula columns are display-only (not sortable/filterable).

Purpose: Completes the formula field user experience by making computed values visible everywhere entity data is displayed — list pages (dynamic tables) and detail pages (custom field forms).
Output: Updated DynamicTableComponent with formula error handling, updated CustomFieldFormComponent with read-only formula display.
</objective>

<execution_context>
@/Users/metatech/.claude/get-shit-done/workflows/execute-plan.md
@/Users/metatech/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-formula-computed-custom-fields/15-RESEARCH.md
@.planning/phases/15-formula-computed-custom-fields/15-CONTEXT.md
@.planning/phases/15-formula-computed-custom-fields/15-02-SUMMARY.md
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
@globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
@globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts
@globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.html
@globcrm-web/src/app/core/custom-fields/custom-field.models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Formula field display in DynamicTableComponent (list pages)</name>
  <files>
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.ts
    globcrm-web/src/app/shared/components/dynamic-table/dynamic-table.component.html
  </files>
  <action>
    **1. Update getCellValue method** in `dynamic-table.component.ts`:
    - Import `isFormulaError` from `custom-field.models`.
    - After the existing custom field value lookup in `getCellValue()`, check if the returned value is a formula error:
      ```typescript
      getCellValue(row: any, fieldId: string): any {
        // existing logic to get value from row.customFields or row[fieldId]
        let value = /* existing logic */;

        // Check for formula error marker
        if (isFormulaError(value)) {
          return { __formulaError: true, display: '#ERR', tooltip: value.message };
        }

        return value;
      }
      ```
    - Or alternatively, add a separate helper method:
      ```typescript
      isFormulaErrorValue(value: any): boolean {
        return isFormulaError(value);
      }

      getFormulaErrorTooltip(value: any): string {
        return isFormulaError(value) ? value.message : '';
      }
      ```

    **2. Update the template** to render formula errors:
    - In the cell rendering section of `dynamic-table.component.html`, add a conditional for formula errors:
      ```html
      <!-- In the cell value display area -->
      @if (isFormulaErrorValue(getCellValue(row, column.field))) {
        <span class="formula-error" [matTooltip]="getFormulaErrorTooltip(getCellValue(row, column.field))">
          #ERR
        </span>
      } @else {
        <!-- existing cell rendering -->
      }
      ```
    - Import `MatTooltipModule` if not already imported.
    - Style `.formula-error`: color red, font-weight bold, cursor help (to indicate tooltip availability).

    **3. Ensure formula columns are display-only:**
    - In the column definition building logic (wherever `buildColumnDefinitions` or similar is called — check the existing pattern for how custom field columns are added), ensure formula-type custom fields get `sortable: false` and `filterable: false`.
    - This is likely already the case if custom field columns are all `sortable: false`, but verify. If custom fields ARE sortable, formula fields specifically need to be excluded.
    - Check the `ColumnDefinition` interface and where custom field columns are created. Formula columns should have `sortable: false` because values aren't stored in DB (can't ORDER BY a computed value).

    **4. Formula value formatting:**
    - For formula values that are NOT errors, format based on the formula result type if available:
      - Number results: Display as-is (Angular number formatting if decimal).
      - Date results: Apply date pipe formatting.
      - Text results: Display as-is.
    - If the formula column definition doesn't carry result type info, display the raw value. The backend returns properly typed values from NCalc evaluation.
  </action>
  <verify>
    - `cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles.
    - `isFormulaError` imported and used in dynamic table component.
    - Template has conditional rendering for formula errors with tooltip.
    - `.formula-error` class styled with red color.
  </verify>
  <done>
    DynamicTableComponent detects formula errors using isFormulaError type guard, displays '#ERR' in red with matTooltip showing error reason. Normal formula values display like any other custom field. Formula columns are not sortable or filterable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Formula field display in CustomFieldFormComponent (detail pages)</name>
  <files>
    globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.ts
    globcrm-web/src/app/shared/components/custom-field-form/custom-field-form.component.html
  </files>
  <action>
    **1. Update CustomFieldFormComponent** to handle Formula type:
    - Import `CustomFieldType`, `isFormulaError` from custom-field.models.
    - In the component class, add a method to check if a field is a formula:
      ```typescript
      isFormulaField(field: CustomFieldDefinition): boolean {
        return field.fieldType === CustomFieldType.Formula;
      }
      ```
    - Add method to get the display value for a formula field:
      ```typescript
      getFormulaDisplayValue(field: CustomFieldDefinition, customFields: Record<string, any>): string {
        const value = customFields?.[field.name] ?? customFields?.[field.id];
        if (value === null || value === undefined) return '—';
        if (isFormulaError(value)) return '#ERR';
        return String(value);
      }

      getFormulaTooltip(field: CustomFieldDefinition, customFields: Record<string, any>): string {
        const value = customFields?.[field.name] ?? customFields?.[field.id];
        if (isFormulaError(value)) return value.message;
        return '';
      }

      isFormulaErrorForField(field: CustomFieldDefinition, customFields: Record<string, any>): boolean {
        const value = customFields?.[field.name] ?? customFields?.[field.id];
        return isFormulaError(value);
      }
      ```

    **2. Update the template** to render formula fields as read-only:
    - In the field rendering loop (where different field types get different inputs: text -> mat-input, dropdown -> mat-select, etc.), add a case for Formula:
      ```html
      @case ('formula') {
        <div class="formula-field-display">
          <label class="formula-label">{{ field.label }}</label>
          @if (isFormulaErrorForField(field, customFields)) {
            <span class="formula-error"
                  [matTooltip]="getFormulaTooltip(field, customFields)">
              #ERR
            </span>
          } @else {
            <span class="formula-value">
              {{ getFormulaDisplayValue(field, customFields) }}
            </span>
          }
        </div>
      }
      ```
    - Or if the template uses `@if` chains instead of `@switch`, add the formula check.
    - The key difference from other field types: NO form control, NO input element. Just a read-only display span.
    - Import `MatTooltipModule` if not already in the component's imports.

    **3. Style the formula display:**
    - `.formula-field-display`: Same layout as other field displays (label above, value below).
    - `.formula-label`: Same style as mat-form-field labels (muted color, smaller font).
    - `.formula-value`: Normal text, maybe a slight background highlight or subtle fx icon to indicate it's computed.
    - `.formula-error`: Red text, bold, cursor help. Same as dynamic table error style.
    - Consider adding a small `functions` mat-icon next to the label to indicate this is a computed field:
      ```html
      <label class="formula-label">
        <mat-icon class="formula-icon">functions</mat-icon>
        {{ field.label }}
      </label>
      ```

    **4. Ensure formula fields are excluded from form submission:**
    - When the custom-field-form builds form controls for each field, skip creating a FormControl for formula fields.
    - The formula field does NOT participate in the reactive form — it's purely display.
    - In the form value extraction for save operations, formula field values should NOT be included (they are computed, not stored).
    - Check the existing logic that maps customFields to form controls and adds them to the FormGroup. Add a guard: `if (field.fieldType === CustomFieldType.Formula) continue;` or skip in the loop.
  </action>
  <verify>
    - `cd globcrm-web && npx ng build --configuration development 2>&1 | head -20` compiles.
    - Formula fields render as read-only display in custom-field-form.
    - No FormControl created for formula fields.
    - Formula errors display as '#ERR' with tooltip.
    - Formula values excluded from form submission data.
  </verify>
  <done>
    CustomFieldFormComponent renders formula fields as read-only display values with a 'functions' icon indicator. Formula errors show '#ERR' with tooltip. No form controls created for formula fields. Formula values excluded from save operations. Consistent styling with the spreadsheet-familiar error pattern.
  </done>
</task>

</tasks>

<verification>
- `cd globcrm-web && npx ng build --configuration development` succeeds
- Dynamic table shows formula values and '#ERR' with tooltips
- Custom field form shows formula fields as read-only with computed values
- Formula fields excluded from form submission (not sent to backend on save)
- Formula columns not sortable or filterable in dynamic table
</verification>

<success_criteria>
Formula field values are visible everywhere in the frontend: dynamic table list pages show computed values or '#ERR' with tooltips, detail page custom field sections show formula values as read-only computed fields. Formula columns are display-only. The spreadsheet-familiar '#ERR' pattern is consistent across all views.
</success_criteria>

<output>
After completion, create `.planning/phases/15-formula-computed-custom-fields/15-04-SUMMARY.md`
</output>
