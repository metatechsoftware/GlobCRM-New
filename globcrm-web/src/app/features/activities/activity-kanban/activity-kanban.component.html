<div class="kanban-layout">
  <!-- Header toolbar -->
  <div class="kanban-header">
    <h1>{{ 'activities.kanban.title' | transloco }}</h1>

    <div class="header-actions">
      <!-- View mode switcher -->
      <mat-button-toggle-group value="kanban" class="view-mode-toggle">
        <mat-button-toggle value="list" routerLink="/activities">
          <mat-icon>view_list</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="kanban">
          <mat-icon>view_kanban</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="calendar" routerLink="/activities/calendar">
          <mat-icon>calendar_month</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>

      <!-- New Activity button -->
      <button mat-raised-button color="primary"
              *appHasPermission="'Activity:Create'"
              routerLink="/activities/new">
        <mat-icon>add</mat-icon> {{ 'activities.kanban.newActivity' | transloco }}
      </button>
    </div>
  </div>

  <!-- Loading bar -->
  @if (isLoading()) {
    <mat-progress-bar mode="indeterminate" class="kanban-loading"></mat-progress-bar>
  }

  <!-- Kanban board -->
  <div class="kanban-board" cdkDropListGroup>
    @for (column of columns(); track column.status) {
      <div class="kanban-column"
           [style.--stage-color]="column.color"
           [class.terminal-column]="column.status === 'Done'">
        <div class="column-header">
          <div class="column-header-left">
            <span class="column-title">{{ column.label }}</span>
            <span class="column-count">{{ column.activities.length }}</span>
          </div>
        </div>
        <div cdkDropList
             [cdkDropListData]="column.activities"
             [id]="column.status"
             (cdkDropListDropped)="onDrop($event)"
             class="column-body">
          @for (activity of column.activities; track activity.id) {
            <div cdkDrag class="activity-card"
                 (click)="openActivity(activity.id)">
              <div class="card-top-row">
                <span class="type-icon-circle">
                  <mat-icon class="type-icon">{{ getTypeIcon(activity.type) }}</mat-icon>
                </span>
                <span class="card-subject">{{ truncate(activity.subject) }}</span>
              </div>

              <div class="card-meta">
                <span [class]="'priority-badge ' + getPriorityClass(activity.priority)">
                  {{ activity.priority }}
                </span>
                <span class="type-label">{{ activity.type }}</span>
              </div>

              <div class="activity-card-footer">
                @if (activity.assignedToName) {
                  <span class="assignee-avatar" [title]="activity.assignedToName">{{ getAssigneeInitials(activity.assignedToName) }}</span>
                  <span class="assignee-name">{{ activity.assignedToName }}</span>
                }
                @if (activity.dueDate) {
                  <span [class]="'due-date-badge ' + getDueDateClass(activity.dueDate)">
                    <mat-icon class="meta-icon">event</mat-icon>
                    {{ activity.dueDate | date:'MMM d' }}
                  </span>
                }
              </div>

              <!-- Drag preview -->
              <div *cdkDragPreview class="activity-card-preview">
                <span class="preview-icon-circle">
                  <mat-icon class="type-icon">{{ getTypeIcon(activity.type) }}</mat-icon>
                </span>
                <span class="card-subject">{{ truncate(activity.subject, 40) }}</span>
                <span [class]="'priority-badge ' + getPriorityClass(activity.priority)">
                  {{ activity.priority }}
                </span>
              </div>

              <!-- Drag placeholder -->
              <div *cdkDragPlaceholder class="activity-card-placeholder"></div>
            </div>
          }
          @if (column.activities.length === 0) {
            <div class="column-empty">{{ 'activities.list.noActivities' | transloco }}</div>
          }
        </div>
      </div>
    }
  </div>
</div>
