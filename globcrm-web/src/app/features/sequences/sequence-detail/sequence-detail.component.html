<div class="detail">
  @if (store.loading() && !store.selectedSequence()) {
    <div class="detail__loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }

  @if (store.selectedSequence(); as seq) {
    <!-- Hero Header -->
    <div class="detail__header">
      <button mat-icon-button routerLink="/sequences" [attr.aria-label]="'sequences.detail.backToSequences' | transloco"
              class="detail__back-btn">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="detail__header-info">
        <h1>{{ seq.name }}</h1>
        @if (seq.description) {
          <p class="detail__description">{{ seq.description }}</p>
        }
      </div>
      <span class="detail__status"
            [class.status--draft]="seq.status === 'draft'"
            [class.status--active]="seq.status === 'active'"
            [class.status--paused]="seq.status === 'paused'"
            [class.status--archived]="seq.status === 'archived'">
        <span class="detail__status-dot"></span>
        {{ seq.status | titlecase }}
      </span>
      <div class="detail__header-actions">
        @if (seq.status === 'draft') {
          <button mat-stroked-button (click)="activateSequence()">
            <mat-icon>play_arrow</mat-icon>
            {{ 'sequences.detail.activate' | transloco }}
          </button>
        }
        @if (seq.status === 'active') {
          <button mat-stroked-button (click)="pauseSequence()">
            <mat-icon>pause</mat-icon>
            {{ 'sequences.detail.pause' | transloco }}
          </button>
        }
        @if (seq.status === 'paused') {
          <button mat-stroked-button (click)="activateSequence()">
            <mat-icon>play_arrow</mat-icon>
            {{ 'sequences.detail.resume' | transloco }}
          </button>
        }
        @if (seq.status !== 'archived') {
          <button mat-stroked-button (click)="archiveSequence()">
            <mat-icon>archive</mat-icon>
            {{ 'sequences.detail.archive' | transloco }}
          </button>
        }
        <button mat-flat-button
                color="primary"
                (click)="openEnrollmentDialog()">
          <mat-icon>person_add</mat-icon>
          {{ 'sequences.detail.addContacts' | transloco }}
        </button>
        <a mat-stroked-button [routerLink]="['/sequences', seq.id, 'edit']">
          <mat-icon>edit</mat-icon>
          {{ 'sequences.detail.edit' | transloco }}
        </a>
      </div>
    </div>

    <!-- Analytics Section -->
    <app-sequence-analytics
      [analytics]="store.analytics()"
      [stepMetrics]="store.stepMetrics()"
      [funnelData]="store.funnelData()" />

    <!-- Steps Pipeline Timeline -->
    <div class="detail__section">
      <h2 class="detail__section-title">
        <mat-icon>route</mat-icon>
        {{ 'sequences.detail.stepsTitle' | transloco }}
      </h2>
      @if (seq.steps.length === 0) {
        <p class="detail__empty-hint">{{ 'sequences.detail.noSteps' | transloco }} <a [routerLink]="['/sequences', seq.id, 'edit']">{{ 'sequences.detail.addStepsLink' | transloco }}</a></p>
      } @else {
        <div class="detail__steps">
          @for (step of seq.steps; track step.id) {
            <div class="step-overview"
                 [class.step-overview--expanded]="expandedStepId() === step.id"
                 (click)="toggleStepExpand(step.id)">
              <span class="step-overview__badge">{{ step.stepNumber }}</span>
              <div class="step-overview__header">
                <div class="step-overview__info">
                  <span class="step-overview__name">{{ step.emailTemplateName || ('sequences.builder.stepItem.noTemplate' | transloco) }}</span>
                  <span class="step-overview__delay">
                    <mat-icon>schedule</mat-icon>
                    @if (step.delayDays === 0 && step.stepNumber === 1) {
                      {{ 'sequences.detail.sendImmediately' | transloco }}
                    } @else if (step.delayDays === 0) {
                      {{ 'sequences.detail.noDelay' | transloco }}
                    } @else {
                      {{ (step.delayDays === 1 ? 'sequences.detail.waitDays' : 'sequences.detail.waitDaysPlural') | transloco:{ count: step.delayDays } }}
                    }
                    @if (step.preferredSendTime) {
                      {{ 'sequences.detail.atTime' | transloco:{ time: step.preferredSendTime } }}
                    }
                  </span>
                </div>
                <!-- Inline step metrics -->
                @if (getStepMetric(step.stepNumber); as metric) {
                  <div class="step-overview__metrics">
                    <span class="step-metric" [matTooltip]="'sequences.analytics.stepColumns.sent' | transloco">
                      <strong>{{ metric.sent }}</strong>
                      {{ 'sequences.detail.sent' | transloco }}
                    </span>
                    <span class="step-metric" [matTooltip]="'sequences.analytics.stepColumns.openRate' | transloco">
                      <strong>{{ metric.openRate }}%</strong>
                      {{ 'sequences.detail.opens' | transloco }}
                    </span>
                    <span class="step-metric" [matTooltip]="'sequences.analytics.stepColumns.clickRate' | transloco">
                      <strong>{{ metric.clickRate }}%</strong>
                      {{ 'sequences.detail.clicks' | transloco }}
                    </span>
                  </div>
                }
                <mat-icon class="step-overview__chevron">
                  {{ expandedStepId() === step.id ? 'expand_less' : 'expand_more' }}
                </mat-icon>
              </div>
              @if (expandedStepId() === step.id) {
                <div class="step-overview__detail">
                  @if (step.subjectOverride) {
                    <div class="step-overview__field">
                      <span class="step-overview__field-label">{{ 'sequences.detail.subjectOverride' | transloco }}</span>
                      {{ step.subjectOverride }}
                    </div>
                  }
                  @if (getStepMetric(step.stepNumber); as metric) {
                    <div class="step-overview__field">
                      <span class="step-overview__field-label">{{ 'sequences.detail.uniqueOpens' | transloco }}</span>
                      {{ metric.uniqueOpens }} / {{ metric.sent }}
                    </div>
                    <div class="step-overview__field">
                      <span class="step-overview__field-label">{{ 'sequences.detail.uniqueClicks' | transloco }}</span>
                      {{ metric.uniqueClicks }} / {{ metric.sent }}
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Enrollment List -->
    <div class="detail__section">
      <div class="detail__section-header">
        <h2 class="detail__section-title">
          <mat-icon>people</mat-icon>
          {{ 'sequences.detail.enrollmentsTitle' | transloco }}
        </h2>
        @if (selectedEnrollmentIds().size > 0) {
          <div class="detail__bulk-actions">
            <span class="detail__bulk-count">{{ 'sequences.detail.selected' | transloco:{ count: selectedEnrollmentIds().size } }}</span>
            <button mat-stroked-button (click)="bulkPause()">
              <mat-icon>pause</mat-icon>
              {{ 'sequences.detail.pauseSelected' | transloco }}
            </button>
            <button mat-stroked-button (click)="bulkResume()">
              <mat-icon>play_arrow</mat-icon>
              {{ 'sequences.detail.resumeSelected' | transloco }}
            </button>
          </div>
        }
      </div>

      @if (store.enrollments(); as enrollmentData) {
        @if (enrollmentData.items.length === 0) {
          <div class="detail__empty-enrollment">
            <div class="detail__empty-enrollment-icon">
              <mat-icon>people_outline</mat-icon>
            </div>
            <p>{{ 'sequences.detail.noEnrollments' | transloco }}</p>
            <button mat-flat-button color="primary" (click)="openEnrollmentDialog()">
              <mat-icon>person_add</mat-icon>
              {{ 'sequences.detail.addContacts' | transloco }}
            </button>
          </div>
        } @else {
          <div class="detail__table-wrap">
            <table mat-table [dataSource]="enrollmentData.items">
              <!-- Select Column -->
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-checkbox
                    [checked]="isAllSelected()"
                    [indeterminate]="selectedEnrollmentIds().size > 0 && !isAllSelected()"
                    (change)="toggleSelectAll($event.checked)">
                  </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let enrollment">
                  <mat-checkbox
                    [checked]="selectedEnrollmentIds().has(enrollment.id)"
                    (change)="toggleEnrollmentSelect(enrollment.id, $event.checked)">
                  </mat-checkbox>
                </td>
              </ng-container>

              <!-- Contact Column -->
              <ng-container matColumnDef="contact">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.contact' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">
                  <div class="detail__contact-cell">
                    <a class="detail__contact-link" [routerLink]="['/contacts', enrollment.contactId]">
                      {{ enrollment.contactName || ('sequences.detail.unknown' | transloco) }}
                    </a>
                    <div class="detail__contact-email">{{ enrollment.contactEmail }}</div>
                  </div>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.status' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">
                  <span class="enrollment-status"
                        [class]="'enrollment-status--' + enrollment.status">
                    <span class="enrollment-status__dot"></span>
                    {{ enrollment.status | titlecase }}
                  </span>
                </td>
              </ng-container>

              <!-- Current Step Column -->
              <ng-container matColumnDef="currentStep">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.currentStep' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">
                  {{ enrollment.currentStepNumber || '-' }}
                </td>
              </ng-container>

              <!-- Steps Sent Column -->
              <ng-container matColumnDef="stepsSent">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.sent' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">{{ enrollment.stepsSent }}</td>
              </ng-container>

              <!-- Last Sent Column -->
              <ng-container matColumnDef="lastSent">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.lastSent' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">
                  {{ enrollment.lastStepSentAt ? (enrollment.lastStepSentAt | date:'short') : '-' }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>{{ 'sequences.detail.enrollmentColumns.actions' | transloco }}</th>
                <td mat-cell *matCellDef="let enrollment">
                  <div class="detail__enrollment-actions" (click)="$event.stopPropagation()">
                    @if (enrollment.status === 'active') {
                      <mat-slide-toggle
                        [checked]="true"
                        [matTooltip]="'sequences.detail.pauseEnrollmentTooltip' | transloco"
                        (change)="onToggleEnrollment(enrollment)">
                      </mat-slide-toggle>
                    }
                    @if (enrollment.status === 'paused') {
                      <mat-slide-toggle
                        [checked]="false"
                        [matTooltip]="'sequences.detail.resumeEnrollmentTooltip' | transloco"
                        (change)="onToggleEnrollment(enrollment)">
                      </mat-slide-toggle>
                    }
                    @if (enrollment.status === 'active' || enrollment.status === 'paused') {
                      <button mat-icon-button
                              [matTooltip]="'sequences.detail.unenrollTooltip' | transloco"
                              color="warn"
                              (click)="onUnenroll(enrollment)">
                        <mat-icon>person_remove</mat-icon>
                      </button>
                    }
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="enrollmentColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: enrollmentColumns;"></tr>
            </table>
          </div>

          <mat-paginator
            [length]="enrollmentData.totalCount"
            [pageSize]="pageSize"
            [pageIndex]="currentPage() - 1"
            [pageSizeOptions]="[10, 25, 50]"
            (page)="onPageChange($event)"
            showFirstLastButtons>
          </mat-paginator>
        }
      }
    </div>
  }
</div>
