<div class="builder">
  <!-- Header -->
  <div class="builder__header">
    <button mat-icon-button (click)="goBack()" [attr.aria-label]="'common.back' | transloco">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>{{ (isEditMode() ? 'sequences.builder.editTitle' : 'sequences.builder.createTitle') | transloco }}</h1>
  </div>

  @if (store.loading() && isEditMode()) {
    <div class="builder__loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <!-- Sequence Info -->
    <div class="builder__section">
      <div class="builder__form-card">
        <mat-form-field class="builder__field" appearance="outline">
          <mat-label>{{ 'sequences.builder.sequenceName' | transloco }}</mat-label>
          <input matInput
                 [(ngModel)]="name"
                 [placeholder]="'sequences.builder.namePlaceholder' | transloco"
                 required />
        </mat-form-field>

        <mat-form-field class="builder__field" appearance="outline">
          <mat-label>{{ 'sequences.builder.description' | transloco }}</mat-label>
          <textarea matInput
                    [(ngModel)]="description"
                    rows="2"
                    [placeholder]="'sequences.builder.descriptionPlaceholder' | transloco"></textarea>
        </mat-form-field>

        @if (isEditMode() && store.selectedSequence()) {
          <div class="builder__status-row">
            <span class="builder__status-label">{{ 'sequences.builder.status' | transloco }}</span>
            <span class="builder__status-badge"
                  [class.status--draft]="store.selectedSequence()!.status === 'draft'"
                  [class.status--active]="store.selectedSequence()!.status === 'active'"
                  [class.status--paused]="store.selectedSequence()!.status === 'paused'"
                  [class.status--archived]="store.selectedSequence()!.status === 'archived'">
              <span class="builder__status-dot"></span>
              {{ store.selectedSequence()!.status | titlecase }}
            </span>
          </div>
        }
      </div>
    </div>

    <!-- Steps Section -->
    <div class="builder__section">
      <div class="builder__section-header">
        <div class="builder__section-icon">
          <mat-icon>route</mat-icon>
        </div>
        <h2>{{ 'sequences.builder.stepsTitle' | transloco }}</h2>
        <span class="builder__step-count">{{ (steps().length === 1 ? 'sequences.builder.stepCount' : 'sequences.builder.stepCountPlural') | transloco:{ count: steps().length } }}</span>
      </div>

      @if (steps().length === 0) {
        <div class="builder__empty-steps">
          <div class="builder__empty-steps-icon">
            <mat-icon>mail_outline</mat-icon>
          </div>
          <p>{{ 'sequences.builder.emptySteps' | transloco }}</p>
        </div>
      } @else {
        <div cdkDropList
             class="builder__step-list"
             (cdkDropListDropped)="onStepDrop($event)">
          @for (step of steps(); track step.id) {
            <div cdkDrag class="builder__step-drag-item">
              <app-step-item
                [step]="step"
                (stepChanged)="onStepChanged(step, $event)"
                (stepDeleted)="onStepDeleted(step)" />
            </div>
          }
        </div>
      }

      <button mat-stroked-button
              class="builder__add-step"
              (click)="addStep()">
        <mat-icon>add</mat-icon>
        {{ 'sequences.builder.addStep' | transloco }}
      </button>
    </div>

    <!-- Actions -->
    <div class="builder__actions">
      <button mat-button (click)="goBack()">{{ 'common.cancel' | transloco }}</button>
      <button mat-flat-button
              color="primary"
              [disabled]="!name || store.loading()"
              (click)="save()">
        {{ (isEditMode() ? 'sequences.builder.saveChanges' : 'sequences.builder.createSequence') | transloco }}
      </button>
    </div>
  }
</div>
