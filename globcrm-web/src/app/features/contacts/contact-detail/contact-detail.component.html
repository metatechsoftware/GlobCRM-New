@if (isLoading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else if (contact()) {
  <div class="detail-page">
    <!-- Hero Card -->
    <div class="contact-hero">
      <div class="hero-accent"></div>

      <!-- Navigation bar -->
      <div class="hero-nav">
        <a mat-icon-button routerLink="/contacts" [attr.aria-label]="'contacts.detail.backToContacts' | transloco">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <div class="hero-actions">
          <button mat-stroked-button
                  *appHasPermission="'Contact:Edit'"
                  routerLink="edit">
            <mat-icon>edit</mat-icon> {{ 'common.edit' | transloco }}
          </button>
          <button mat-stroked-button color="warn"
                  *appHasPermission="'Contact:Delete'"
                  (click)="onDelete()">
            <mat-icon>delete</mat-icon> {{ 'common.delete' | transloco }}
          </button>
          <button mat-icon-button [matMenuTriggerFor]="actionsMenu" [attr.aria-label]="'common.actions' | transloco">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #actionsMenu="matMenu">
            <button mat-menu-item (click)="enrollInSequence()">
              <mat-icon>schedule_send</mat-icon>
              <span>{{ 'contacts.detail.enrollInSequence' | transloco }}</span>
            </button>
          </mat-menu>
        </div>
      </div>

      <!-- Profile section -->
      <div class="hero-profile">
        <div class="hero-avatar">{{ getInitials() }}</div>
        <div class="hero-info">
          <h1 class="hero-name">{{ contact()!.fullName }}</h1>
          <div class="hero-badges">
            @if (contact()!.jobTitle) {
              <span class="badge badge--primary">{{ contact()!.jobTitle }}</span>
            }
            @if (contact()!.companyName) {
              <span class="badge badge--accent">{{ contact()!.companyName }}</span>
            }
            @if (contact()!.department) {
              <span class="badge badge--secondary">{{ contact()!.department }}</span>
            }
          </div>
        </div>
      </div>

      <!-- Meta info pills -->
      @if (contact()!.email || contact()!.phone || contact()!.companyName || contact()!.ownerName) {
        <hr class="hero-divider">
        <div class="hero-meta">
          @if (contact()!.email) {
            <span class="meta-item">
              <mat-icon>email</mat-icon>
              <a [href]="'mailto:' + contact()!.email">{{ contact()!.email }}</a>
            </span>
          }
          @if (contact()!.email && contact()!.phone) {
            <span class="meta-separator"></span>
          }
          @if (contact()!.phone) {
            <span class="meta-item">
              <mat-icon>phone</mat-icon>
              {{ contact()!.phone }}
            </span>
          }
          @if ((contact()!.email || contact()!.phone) && contact()!.companyName) {
            <span class="meta-separator"></span>
          }
          @if (contact()!.companyName) {
            <span class="meta-item">
              <mat-icon>business</mat-icon>
              <a [routerLink]="['/companies', contact()!.companyId]">{{ contact()!.companyName }}</a>
            </span>
          }
          @if ((contact()!.email || contact()!.phone || contact()!.companyName) && contact()!.ownerName) {
            <span class="meta-separator"></span>
          }
          @if (contact()!.ownerName) {
            <span class="meta-item">
              <mat-icon>person</mat-icon>
              {{ contact()!.ownerName }}
            </span>
          }
        </div>
      }
    </div>

    <!-- Main content: Tabs + Timeline sidebar -->
    <div class="detail-content">
      <div class="detail-main">
        <app-related-entity-tabs [tabs]="tabs" [activeTabIndex]="activeTabIndex()" (tabChanged)="onTabChanged($event)">
          <!-- Summary tab content (index 0) -->
          <ng-template>
            <app-entity-summary-tab
              entityType="Contact"
              [data]="summaryData()"
              [loading]="summaryLoading()"
              (associationClicked)="onAssociationClicked($event)"
              (addNote)="onSummaryAddNote()"
              (logActivity)="onSummaryLogActivity()"
              (sendEmail)="onSummarySendEmail()" />
          </ng-template>

          <!-- Details tab content (index 1) -->
          <ng-template>
            <!-- Contact Info section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>person</mat-icon>
                <h3>{{ 'contacts.detail.sections.contactInfo' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.firstName' | transloco }}</span>
                  <span class="field-value">{{ contact()!.firstName }}</span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.lastName' | transloco }}</span>
                  <span class="field-value">{{ contact()!.lastName }}</span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.email' | transloco }}</span>
                  @if (contact()!.email) {
                    <a class="field-value field-value--link"
                       [href]="'mailto:' + contact()!.email">
                      {{ contact()!.email }}
                    </a>
                  } @else {
                    <span class="field-value field-value--empty">{{ 'contacts.detail.empty.notSpecified' | transloco }}</span>
                  }
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.phone' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.phone">
                    {{ contact()!.phone || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.mobilePhone' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.mobilePhone">
                    {{ contact()!.mobilePhone || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.jobTitle' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.jobTitle">
                    {{ contact()!.jobTitle || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.department' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.department">
                    {{ contact()!.department || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.company' | transloco }}</span>
                  <span class="field-value">
                    @if (contact()!.companyId) {
                      <a class="field-value--link" [routerLink]="['/companies', contact()!.companyId]">{{ contact()!.companyName }}</a>
                    } @else {
                      <span class="field-value--empty">{{ 'contacts.detail.empty.notSpecified' | transloco }}</span>
                    }
                  </span>
                </div>
                <div class="detail-field full-width">
                  <span class="field-label">{{ 'contacts.detail.fields.description' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.description">
                    {{ contact()!.description || ('contacts.detail.empty.noDescription' | transloco) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Address section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>location_on</mat-icon>
                <h3>{{ 'contacts.detail.sections.address' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field full-width">
                  <span class="field-label">{{ 'contacts.detail.fields.address' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.address">
                    {{ contact()!.address || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.city' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.city">
                    {{ contact()!.city || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.state' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.state">
                    {{ contact()!.state || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.country' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.country">
                    {{ contact()!.country || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'contacts.detail.fields.postalCode' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!contact()!.postalCode">
                    {{ contact()!.postalCode || ('contacts.detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Custom fields -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>tune</mat-icon>
                <h3>{{ 'contacts.detail.sections.customFields' | transloco }}</h3>
              </div>
              <app-custom-field-form
                [entityType]="'Contact'"
                [customFieldValues]="contact()!.customFields"
                [readonly]="true" />
            </div>
          </ng-template>

          <!-- Company tab content (index 1) -->
          <ng-template>
            <div class="company-tab">
              @if (contact()!.companyId) {
                <div class="company-info-grid">
                  <div class="detail-field">
                    <span class="field-label">{{ 'contacts.detail.company.name' | transloco }}</span>
                    <span class="field-value">
                      <a class="field-value--link" [routerLink]="['/companies', contact()!.companyId]">{{ contact()!.companyName }}</a>
                    </span>
                  </div>
                </div>
              } @else {
                <div class="no-company">
                  <mat-icon>business</mat-icon>
                  <span>{{ 'contacts.detail.company.noCompany' | transloco }}</span>
                  <button mat-stroked-button
                          *appHasPermission="'Contact:Edit'"
                          routerLink="edit">
                    {{ 'contacts.detail.company.linkCompany' | transloco }}
                  </button>
                </div>
              }
            </div>
          </ng-template>

          <!-- Deals tab content (index 2) -->
          <ng-template>
            <div class="tab-placeholder">
              <mat-icon>handshake</mat-icon>
              <p>{{ 'contacts.detail.deals.noDeals' | transloco }}</p>
              <a mat-button color="primary" [routerLink]="['/deals']" [queryParams]="{ contactId: contact()?.id }">
                {{ 'contacts.detail.deals.viewDeals' | transloco }}
              </a>
            </div>
          </ng-template>

          <!-- Activities tab content (index 3) -->
          <ng-template>
            @if (activitiesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedActivities().length === 0) {
              <div class="tab-empty">
                <mat-icon>task_alt</mat-icon>
                <span>{{ 'contacts.detail.activities.noActivities' | transloco }}</span>
                <a mat-stroked-button routerLink="/activities/new">{{ 'contacts.detail.activities.createActivity' | transloco }}</a>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'contacts.detail.activities.columnSubject' | transloco }}</th>
                    <th>{{ 'contacts.detail.activities.columnType' | transloco }}</th>
                    <th>{{ 'contacts.detail.activities.columnStatus' | transloco }}</th>
                    <th>{{ 'contacts.detail.activities.columnPriority' | transloco }}</th>
                    <th>{{ 'contacts.detail.activities.columnDueDate' | transloco }}</th>
                    <th>{{ 'contacts.detail.activities.columnAssignedTo' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (activity of linkedActivities(); track activity.id) {
                    <tr>
                      <td><a [routerLink]="['/activities', activity.id]">{{ activity.subject }}</a></td>
                      <td>{{ activity.type }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getStatusColor(activity.status) + '22'"
                                    [style.color]="getStatusColor(activity.status)">
                            {{ activity.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getPriorityColor(activity.priority) + '22'"
                                    [style.color]="getPriorityColor(activity.priority)">
                            {{ activity.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td class="text-nowrap">{{ activity.dueDate ? (activity.dueDate | date:'mediumDate') : '-' }}</td>
                      <td>{{ activity.assignedToName || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Quotes tab content (index 4) -->
          <ng-template>
            @if (quotesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedQuotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>request_quote</mat-icon>
                <span>{{ 'contacts.detail.quotes.noQuotes' | transloco }}</span>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'contacts.detail.quotes.columnNumber' | transloco }}</th>
                    <th>{{ 'contacts.detail.quotes.columnTitle' | transloco }}</th>
                    <th>{{ 'contacts.detail.quotes.columnStatus' | transloco }}</th>
                    <th>{{ 'contacts.detail.quotes.columnGrandTotal' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (quote of linkedQuotes(); track quote.id) {
                    <tr>
                      <td><a [routerLink]="['/quotes', quote.id]">{{ quote.quoteNumber }}</a></td>
                      <td>{{ quote.title }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getQuoteStatusColor(quote.status) + '22'"
                                    [style.color]="getQuoteStatusColor(quote.status)">
                            {{ quote.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>{{ formatCurrency(quote.grandTotal) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div class="table-footer-link">
                <a mat-button color="primary" [routerLink]="['/quotes']" [queryParams]="{ contactId: contact()?.id }">
                  {{ 'contacts.detail.quotes.viewAll' | transloco }}
                </a>
              </div>
            }
          </ng-template>

          <!-- Requests tab content (index 5) -->
          <ng-template>
            @if (requestsLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedRequests().length === 0) {
              <div class="tab-empty">
                <mat-icon>support_agent</mat-icon>
                <span>{{ 'contacts.detail.requests.noRequests' | transloco }}</span>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'contacts.detail.requests.columnSubject' | transloco }}</th>
                    <th>{{ 'contacts.detail.requests.columnStatus' | transloco }}</th>
                    <th>{{ 'contacts.detail.requests.columnPriority' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (req of linkedRequests(); track req.id) {
                    <tr>
                      <td><a [routerLink]="['/requests', req.id]">{{ req.subject }}</a></td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getRequestStatusColor(req.status) + '22'"
                                    [style.color]="getRequestStatusColor(req.status)">
                            {{ req.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getRequestPriorityColor(req.priority) + '22'"
                                    [style.color]="getRequestPriorityColor(req.priority)">
                            {{ req.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
              <div class="table-footer-link">
                <a mat-button color="primary" [routerLink]="['/requests']" [queryParams]="{ contactId: contact()?.id }">
                  {{ 'contacts.detail.requests.viewAll' | transloco }}
                </a>
              </div>
            }
          </ng-template>

          <!-- Emails tab content (index 6) -->
          <ng-template>
            @if (emailsLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (contactEmails().length === 0) {
              <div class="tab-empty">
                <mat-icon>email</mat-icon>
                <span>{{ 'contacts.detail.emails.noEmails' | transloco }}</span>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th></th>
                    <th>{{ 'contacts.detail.emails.columnSubject' | transloco }}</th>
                    <th>{{ 'contacts.detail.emails.columnPreview' | transloco }}</th>
                    <th>{{ 'contacts.detail.emails.columnDate' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (email of contactEmails(); track email.id) {
                    <tr [style.font-weight]="email.isRead ? 'normal' : '600'">
                      <td>
                        <mat-icon class="direction-icon"
                                  [class.direction-icon--inbound]="email.isInbound"
                                  [class.direction-icon--outbound]="!email.isInbound">
                          {{ email.isInbound ? 'arrow_downward' : 'arrow_upward' }}
                        </mat-icon>
                      </td>
                      <td><a [routerLink]="['/emails', email.id]">{{ email.subject }}</a></td>
                      <td class="text-preview">{{ email.bodyPreview }}</td>
                      <td class="text-nowrap">{{ formatEmailDate(email.sentAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div class="table-footer-link">
                <a mat-button color="primary" routerLink="/emails">
                  {{ 'contacts.detail.emails.viewAll' | transloco }}
                </a>
              </div>
            }
          </ng-template>

          <!-- Notes tab content (index 7) -->
          <ng-template>
            @if (notesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (contactNotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>note</mat-icon>
                <span>{{ 'contacts.detail.notes.noNotes' | transloco }}</span>
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Contact', entityId: contact()?.id, entityName: contact()?.fullName }">
                  {{ 'contacts.detail.notes.addNote' | transloco }}
                </a>
              </div>
            } @else {
              <div class="tab-actions">
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Contact', entityId: contact()?.id, entityName: contact()?.fullName }">
                  <mat-icon>add</mat-icon> {{ 'contacts.detail.notes.addNote' | transloco }}
                </a>
              </div>
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'contacts.detail.notes.columnTitle' | transloco }}</th>
                    <th>{{ 'contacts.detail.notes.columnPreview' | transloco }}</th>
                    <th>{{ 'contacts.detail.notes.columnAuthor' | transloco }}</th>
                    <th>{{ 'contacts.detail.notes.columnDate' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (note of contactNotes(); track note.id) {
                    <tr>
                      <td><a [routerLink]="['/notes', note.id]">{{ note.title }}</a></td>
                      <td class="text-preview">{{ note.plainTextBody }}</td>
                      <td>{{ note.authorName || '-' }}</td>
                      <td class="text-nowrap">{{ formatNoteDate(note.createdAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Attachments tab content (index 8) -->
          <ng-template>
            <app-entity-attachments [entityType]="'contact'" [entityId]="contact()?.id ?? ''" />
          </ng-template>
        </app-related-entity-tabs>
      </div>

      <!-- Timeline sidebar -->
      <div class="detail-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-card__header">
            <mat-icon>timeline</mat-icon>
            <h3>{{ 'contacts.detail.timeline' | transloco }}</h3>
          </div>
          <div class="sidebar-card__body">
            <app-entity-timeline
              [entries]="timelineEntries()"
              [isLoading]="timelineLoading()" />
          </div>
        </div>
      </div>
    </div>
  </div>
} @else {
  <div class="detail-not-found">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ 'contacts.detail.notFound' | transloco }}</h2>
    <a mat-stroked-button routerLink="/contacts">{{ 'contacts.detail.backToContacts' | transloco }}</a>
  </div>
}
