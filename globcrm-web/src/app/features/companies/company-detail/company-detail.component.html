@if (isLoading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else if (company()) {
  <div class="detail-page">
    <!-- Header -->
    <div class="detail-header">
      <div class="header-left">
        <a mat-icon-button routerLink="/companies" aria-label="Back to companies">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <h1>{{ company()!.name }}</h1>
      </div>
      <div class="header-actions">
        <button mat-stroked-button
                *appHasPermission="'Company:Edit'"
                routerLink="edit">
          <mat-icon>edit</mat-icon> Edit
        </button>
        <button mat-stroked-button color="warn"
                *appHasPermission="'Company:Delete'"
                (click)="onDelete()">
          <mat-icon>delete</mat-icon> Delete
        </button>
      </div>
    </div>

    <!-- Subheader: Key fields -->
    <div class="detail-subheader">
      @if (company()!.industry) {
        <div class="subheader-item">
          <mat-icon>business</mat-icon>
          <span>{{ company()!.industry }}</span>
        </div>
      }
      @if (company()!.phone) {
        <div class="subheader-item">
          <mat-icon>phone</mat-icon>
          <span>{{ company()!.phone }}</span>
        </div>
      }
      @if (company()!.ownerName) {
        <div class="subheader-item">
          <mat-icon>person</mat-icon>
          <span>{{ company()!.ownerName }}</span>
        </div>
      }
    </div>

    <!-- Main content: Tabs + Timeline sidebar -->
    <div class="detail-content">
      <div class="detail-main">
        <app-related-entity-tabs [tabs]="tabs" (tabChanged)="onTabChanged($event)">
          <!-- Details tab content -->
          <ng-template>
            <div class="details-grid">
              <div class="detail-field">
                <span class="field-label">Company Name</span>
                <span class="field-value">{{ company()!.name }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Industry</span>
                <span class="field-value">{{ company()!.industry || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Website</span>
                <span class="field-value">{{ company()!.website || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Phone</span>
                <span class="field-value">{{ company()!.phone || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Email</span>
                <span class="field-value">{{ company()!.email || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Address</span>
                <span class="field-value">{{ company()!.address || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">City</span>
                <span class="field-value">{{ company()!.city || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">State / Region</span>
                <span class="field-value">{{ company()!.state || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Country</span>
                <span class="field-value">{{ company()!.country || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Postal Code</span>
                <span class="field-value">{{ company()!.postalCode || '-' }}</span>
              </div>
              <div class="detail-field">
                <span class="field-label">Company Size</span>
                <span class="field-value">{{ company()!.size || '-' }}</span>
              </div>
              <div class="detail-field full-width">
                <span class="field-label">Description</span>
                <span class="field-value">{{ company()!.description || '-' }}</span>
              </div>
            </div>

            <!-- Custom fields in readonly mode -->
            <h3 class="section-title">Custom Fields</h3>
            <app-custom-field-form
              [entityType]="'Company'"
              [customFieldValues]="company()!.customFields"
              [readonly]="true" />
          </ng-template>

          <!-- Contacts tab content -->
          <ng-template>
            <div class="contacts-tab">
              @if (contactsLoading()) {
                <div class="tab-loading">
                  <mat-spinner diameter="32"></mat-spinner>
                </div>
              } @else if (contacts().length === 0) {
                <div class="tab-empty">
                  <mat-icon>people_outline</mat-icon>
                  <span>No contacts linked to this company.</span>
                </div>
              } @else {
                <mat-list>
                  @for (contact of contacts(); track contact.id) {
                    <mat-list-item>
                      <mat-icon matListItemIcon>person</mat-icon>
                      <span matListItemTitle>{{ contact.fullName }}</span>
                      <span matListItemLine>
                        @if (contact.jobTitle) { {{ contact.jobTitle }} }
                        @if (contact.jobTitle && contact.email) { &middot; }
                        @if (contact.email) { {{ contact.email }} }
                      </span>
                    </mat-list-item>
                  }
                </mat-list>
              }
            </div>
          </ng-template>

          <!-- Deals tab content (index 2) -->
          <ng-template>
            <div class="tab-placeholder">
              <mat-icon>handshake</mat-icon>
              <p>View deals linked to this company</p>
              <a mat-button color="primary" [routerLink]="['/deals']" [queryParams]="{ companyId: company()?.id }">
                View Deals
              </a>
            </div>
          </ng-template>

          <!-- Activities tab content (index 3) -->
          <ng-template>
            @if (activitiesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedActivities().length === 0) {
              <div class="tab-empty">
                <mat-icon>task_alt</mat-icon>
                <span>No activities linked to this company.</span>
                <a mat-stroked-button routerLink="/activities/new">Create Activity</a>
              </div>
            } @else {
              <table class="activities-table">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Due Date</th>
                    <th>Assigned To</th>
                  </tr>
                </thead>
                <tbody>
                  @for (activity of linkedActivities(); track activity.id) {
                    <tr>
                      <td><a [routerLink]="['/activities', activity.id]">{{ activity.subject }}</a></td>
                      <td>{{ activity.type }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getStatusColor(activity.status) + '22'"
                                    [style.color]="getStatusColor(activity.status)">
                            {{ activity.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getPriorityColor(activity.priority) + '22'"
                                    [style.color]="getPriorityColor(activity.priority)">
                            {{ activity.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>{{ activity.dueDate ? (activity.dueDate | date:'mediumDate') : '-' }}</td>
                      <td>{{ activity.assignedToName || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Quotes tab content (index 4) -->
          <ng-template>
            @if (quotesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedQuotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>request_quote</mat-icon>
                <span>No quotes linked to this company.</span>
              </div>
            } @else {
              <table class="activities-table">
                <thead>
                  <tr>
                    <th>Quote #</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Grand Total</th>
                  </tr>
                </thead>
                <tbody>
                  @for (quote of linkedQuotes(); track quote.id) {
                    <tr>
                      <td><a [routerLink]="['/quotes', quote.id]">{{ quote.quoteNumber }}</a></td>
                      <td>{{ quote.title }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getQuoteStatusColor(quote.status) + '22'"
                                    [style.color]="getQuoteStatusColor(quote.status)">
                            {{ quote.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>{{ formatCurrency(quote.grandTotal) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div style="text-align: right; margin-top: 8px;">
                <a mat-button color="primary" [routerLink]="['/quotes']" [queryParams]="{ companyId: company()?.id }">
                  View All Quotes
                </a>
              </div>
            }
          </ng-template>

          <!-- Requests tab content (index 5) -->
          <ng-template>
            @if (requestsLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedRequests().length === 0) {
              <div class="tab-empty">
                <mat-icon>support_agent</mat-icon>
                <span>No requests linked to this company.</span>
              </div>
            } @else {
              <table class="activities-table">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Assigned To</th>
                  </tr>
                </thead>
                <tbody>
                  @for (req of linkedRequests(); track req.id) {
                    <tr>
                      <td><a [routerLink]="['/requests', req.id]">{{ req.subject }}</a></td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getRequestStatusColor(req.status) + '22'"
                                    [style.color]="getRequestStatusColor(req.status)">
                            {{ req.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getRequestPriorityColor(req.priority) + '22'"
                                    [style.color]="getRequestPriorityColor(req.priority)">
                            {{ req.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>{{ req.assignedToName || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div style="text-align: right; margin-top: 8px;">
                <a mat-button color="primary" [routerLink]="['/requests']" [queryParams]="{ companyId: company()?.id }">
                  View All Requests
                </a>
              </div>
            }
          </ng-template>

          <!-- Emails tab content (index 6) -->
          <ng-template>
            @if (emailsLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (companyEmails().length === 0) {
              <div class="tab-empty">
                <mat-icon>email</mat-icon>
                <span>No emails linked to this company.</span>
              </div>
            } @else {
              <table class="activities-table">
                <thead>
                  <tr>
                    <th></th>
                    <th>Subject</th>
                    <th>Preview</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  @for (email of companyEmails(); track email.id) {
                    <tr [style.font-weight]="email.isRead ? 'normal' : '600'">
                      <td>
                        <mat-icon style="font-size: 16px; width: 16px; height: 16px;"
                                  [style.color]="email.isInbound ? '#1976d2' : '#4caf50'">
                          {{ email.isInbound ? 'arrow_downward' : 'arrow_upward' }}
                        </mat-icon>
                      </td>
                      <td><a [routerLink]="['/emails', email.id]">{{ email.subject }}</a></td>
                      <td style="color: rgba(0,0,0,0.6); font-size: 13px;">{{ email.bodyPreview }}</td>
                      <td style="white-space: nowrap;">{{ formatEmailDate(email.sentAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div style="text-align: right; margin-top: 8px;">
                <a mat-button color="primary" routerLink="/emails">
                  View All Emails
                </a>
              </div>
            }
          </ng-template>

          <!-- Notes tab content (index 7) -->
          <ng-template>
            @if (notesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (companyNotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>note</mat-icon>
                <span>No notes for this company.</span>
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Company', entityId: company()?.id, entityName: company()?.name }">
                  Add Note
                </a>
              </div>
            } @else {
              <div style="margin-bottom: 12px; text-align: right;">
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Company', entityId: company()?.id, entityName: company()?.name }">
                  <mat-icon>add</mat-icon> Add Note
                </a>
              </div>
              <table class="activities-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Preview</th>
                    <th>Author</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  @for (note of companyNotes(); track note.id) {
                    <tr>
                      <td><a [routerLink]="['/notes', note.id]">{{ note.title }}</a></td>
                      <td style="color: rgba(0,0,0,0.6); font-size: 13px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ note.plainTextBody }}</td>
                      <td>{{ note.authorName || '-' }}</td>
                      <td style="white-space: nowrap;">{{ formatNoteDate(note.createdAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Attachments tab content (index 8) -->
          <ng-template>
            <app-entity-attachments [entityType]="'company'" [entityId]="company()?.id ?? ''" />
          </ng-template>
        </app-related-entity-tabs>
      </div>

      <!-- Timeline sidebar -->
      <div class="detail-sidebar">
        <h3 class="sidebar-title">Timeline</h3>
        <app-entity-timeline
          [entries]="timelineEntries()"
          [isLoading]="timelineLoading()" />
      </div>
    </div>
  </div>
} @else {
  <div class="detail-not-found">
    <mat-icon>error_outline</mat-icon>
    <h2>Company not found</h2>
    <a mat-stroked-button routerLink="/companies">Back to Companies</a>
  </div>
}
