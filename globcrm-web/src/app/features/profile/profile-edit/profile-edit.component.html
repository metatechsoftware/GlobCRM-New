@if (loading()) {
  <div class="loading-state">
    <p>{{ 'profile.edit.loading' | transloco }}</p>
  </div>
} @else {
  <div class="profile-edit-page">
    <!-- Hero Card -->
    <div class="profile-hero">
      <div class="hero-accent"></div>
      <div class="hero-content">
        <div class="hero-avatar">
          <app-avatar-upload
            [currentAvatarUrl]="profile()?.avatarUrl ?? null"
            [firstName]="profile()?.firstName ?? ''"
            [lastName]="profile()?.lastName ?? ''"
            (avatarUploaded)="onAvatarUploaded($event)"
            (avatarRemoved)="onAvatarRemoved()" />
        </div>
        <div class="hero-info">
          <h1>{{ profile()?.firstName }} {{ profile()?.lastName }}</h1>
          <div class="hero-subtitle">
            @if (profile()?.jobTitle) {
              <span>{{ profile()?.jobTitle }}</span>
            }
            @if (profile()?.jobTitle && profile()?.email) {
              <span>&middot;</span>
            }
            <span>{{ profile()?.email }}</span>
          </div>
        </div>
        <div class="hero-action">
          <button
            mat-flat-button
            color="primary"
            (click)="save()"
            [disabled]="saving()">
            <mat-icon>save</mat-icon>
            {{ saving() ? ('profile.edit.saving' | transloco) : ('profile.edit.saveChanges' | transloco) }}
          </button>
        </div>
      </div>
    </div>

    <!-- Section 1: Personal Info -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>person</mat-icon>
        <h2>{{ 'profile.edit.personalInfo' | transloco }}</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.firstName' | transloco }}</mat-label>
            <input matInput formControlName="firstName" />
            @if (profileForm.get('firstName')?.hasError('required') && profileForm.get('firstName')?.touched) {
              <mat-error>{{ 'profile.edit.firstNameRequired' | transloco }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.lastName' | transloco }}</mat-label>
            <input matInput formControlName="lastName" />
            @if (profileForm.get('lastName')?.hasError('required') && profileForm.get('lastName')?.touched) {
              <mat-error>{{ 'profile.edit.lastNameRequired' | transloco }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.email' | transloco }}</mat-label>
            <input matInput formControlName="email" />
            <mat-hint>{{ 'profile.edit.emailHint' | transloco }}</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.phone' | transloco }}</mat-label>
            <input matInput formControlName="phone" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'profile.edit.bio' | transloco }}</mat-label>
            <textarea matInput formControlName="bio" rows="3"></textarea>
          </mat-form-field>
        </form>
      </div>
    </div>

    <!-- Section 2: Work Info -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>work</mat-icon>
        <h2>{{ 'profile.edit.workInfo' | transloco }}</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.jobTitle' | transloco }}</mat-label>
            <input matInput formControlName="jobTitle" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.department' | transloco }}</mat-label>
            <input matInput formControlName="department" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'profile.edit.reportingManager' | transloco }}</mat-label>
            <input matInput formControlName="reportingManagerId" [placeholder]="'profile.edit.reportingManagerPlaceholder' | transloco" />
          </mat-form-field>
        </form>

        <!-- Skills -->
        <div class="skills-section">
          <h4>{{ 'profile.edit.skills' | transloco }}</h4>
          <mat-chip-set>
            @for (skill of skills(); track skill) {
              <mat-chip (removed)="removeSkill(skill)">
                {{ skill }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
          <div class="add-skill">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'profile.edit.addSkill' | transloco }}</mat-label>
              <input
                matInput
                [value]="newSkill()"
                (input)="newSkill.set($any($event.target).value)"
                (keyup.enter)="addSkill()" />
            </mat-form-field>
            <button mat-icon-button (click)="addSkill()">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3: Social Links -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>share</mat-icon>
        <h2>{{ 'profile.edit.socialLinks' | transloco }}</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="social-form-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.linkedIn' | transloco }}</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="linkedIn" placeholder="https://linkedin.com/in/username" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.twitter' | transloco }}</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="twitter" placeholder="https://twitter.com/username" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'profile.edit.gitHub' | transloco }}</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="gitHub" placeholder="https://github.com/username" />
          </mat-form-field>
        </form>
      </div>
    </div>

    <!-- Section 4: Work Schedule -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>schedule</mat-icon>
        <h2>{{ 'profile.edit.workSchedule' | transloco }}</h2>
      </div>
      <div class="section-body">
        <div class="work-days">
          <h4>{{ 'profile.edit.workDays' | transloco }}</h4>
          <div class="day-strip">
            @for (day of workDays; track day) {
              <span
                class="day-pill"
                [class.active]="isWorkDaySelected(day)"
                (click)="toggleWorkDay(day)">
                {{ day.slice(0, 3) }}
              </span>
            }
          </div>
        </div>

        <form [formGroup]="profileForm">
          <div class="time-fields">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'profile.edit.startTime' | transloco }}</mat-label>
              <input matInput type="time" formControlName="workStartTime" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'profile.edit.endTime' | transloco }}</mat-label>
              <input matInput type="time" formControlName="workEndTime" />
            </mat-form-field>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 5: Preferences -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>tune</mat-icon>
        <h2>{{ 'profile.edit.preferences' | transloco }}</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="preferencesForm">
          <div class="preferences-layout">
            <div class="pref-item">
              <h4>{{ 'profile.edit.theme' | transloco }}</h4>
              <mat-radio-group formControlName="theme">
                <div class="theme-options">
                  <mat-radio-button value="light">{{ 'profile.edit.themeLight' | transloco }}</mat-radio-button>
                  <mat-radio-button value="dark">{{ 'profile.edit.themeDark' | transloco }}</mat-radio-button>
                </div>
              </mat-radio-group>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'profile.edit.language' | transloco }}</mat-label>
                <mat-select formControlName="language">
                  @for (lang of languages; track lang.value) {
                    <mat-option [value]="lang.value">{{ lang.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'profile.edit.timezone' | transloco }}</mat-label>
                <mat-select formControlName="timezone">
                  @for (tz of timezones; track tz) {
                    <mat-option [value]="tz">{{ tz }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'profile.edit.dateFormat' | transloco }}</mat-label>
                <mat-select formControlName="dateFormat">
                  @for (fmt of dateFormats; track fmt.value) {
                    <mat-option [value]="fmt.value">{{ fmt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 6: Notifications -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>notifications</mat-icon>
        <h2>{{ 'profile.edit.emailNotifications' | transloco }}</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="preferencesForm">
          <div class="notification-list">
            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">{{ 'profile.edit.taskAssigned' | transloco }}</span>
                <span class="notification-desc">{{ 'profile.edit.taskAssignedDesc' | transloco }}</span>
              </div>
              <mat-slide-toggle formControlName="taskAssigned" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">{{ 'profile.edit.dealUpdated' | transloco }}</span>
                <span class="notification-desc">{{ 'profile.edit.dealUpdatedDesc' | transloco }}</span>
              </div>
              <mat-slide-toggle formControlName="dealUpdated" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">{{ 'profile.edit.mentions' | transloco }}</span>
                <span class="notification-desc">{{ 'profile.edit.mentionsDesc' | transloco }}</span>
              </div>
              <mat-slide-toggle formControlName="mention" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">{{ 'profile.edit.weeklyReport' | transloco }}</span>
                <span class="notification-desc">{{ 'profile.edit.weeklyReportDesc' | transloco }}</span>
              </div>
              <mat-slide-toggle formControlName="weeklyReport" color="primary"></mat-slide-toggle>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
}
