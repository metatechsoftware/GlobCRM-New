@if (loading()) {
  <div class="loading-state">
    <p>Loading profile...</p>
  </div>
} @else {
  <div class="profile-edit-page">
    <!-- Hero Card -->
    <div class="profile-hero">
      <div class="hero-accent"></div>
      <div class="hero-content">
        <div class="hero-avatar">
          <app-avatar-upload
            [currentAvatarUrl]="profile()?.avatarUrl ?? null"
            [firstName]="profile()?.firstName ?? ''"
            [lastName]="profile()?.lastName ?? ''"
            (avatarUploaded)="onAvatarUploaded($event)"
            (avatarRemoved)="onAvatarRemoved()" />
        </div>
        <div class="hero-info">
          <h1>{{ profile()?.firstName }} {{ profile()?.lastName }}</h1>
          <div class="hero-subtitle">
            @if (profile()?.jobTitle) {
              <span>{{ profile()?.jobTitle }}</span>
            }
            @if (profile()?.jobTitle && profile()?.email) {
              <span>&middot;</span>
            }
            <span>{{ profile()?.email }}</span>
          </div>
        </div>
        <div class="hero-action">
          <button
            mat-flat-button
            color="primary"
            (click)="save()"
            [disabled]="saving()">
            <mat-icon>save</mat-icon>
            {{ saving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Section 1: Personal Info -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>person</mat-icon>
        <h2>Personal Information</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input matInput formControlName="firstName" />
            @if (profileForm.get('firstName')?.hasError('required') && profileForm.get('firstName')?.touched) {
              <mat-error>First name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input matInput formControlName="lastName" />
            @if (profileForm.get('lastName')?.hasError('required') && profileForm.get('lastName')?.touched) {
              <mat-error>Last name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput formControlName="email" />
            <mat-hint>Email cannot be changed</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Phone</mat-label>
            <input matInput formControlName="phone" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Bio</mat-label>
            <textarea matInput formControlName="bio" rows="3"></textarea>
          </mat-form-field>
        </form>
      </div>
    </div>

    <!-- Section 2: Work Info -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>work</mat-icon>
        <h2>Work Information</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Job Title</mat-label>
            <input matInput formControlName="jobTitle" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Department</mat-label>
            <input matInput formControlName="department" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reporting Manager</mat-label>
            <input matInput formControlName="reportingManagerId" placeholder="Manager user ID" />
          </mat-form-field>
        </form>

        <!-- Skills -->
        <div class="skills-section">
          <h4>Skills</h4>
          <mat-chip-set>
            @for (skill of skills(); track skill) {
              <mat-chip (removed)="removeSkill(skill)">
                {{ skill }}
                <button matChipRemove>
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
          <div class="add-skill">
            <mat-form-field appearance="outline">
              <mat-label>Add Skill</mat-label>
              <input
                matInput
                [value]="newSkill()"
                (input)="newSkill.set($any($event.target).value)"
                (keyup.enter)="addSkill()" />
            </mat-form-field>
            <button mat-icon-button (click)="addSkill()">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3: Social Links -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>share</mat-icon>
        <h2>Social Links</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="profileForm" class="social-form-grid">
          <mat-form-field appearance="outline">
            <mat-label>LinkedIn</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="linkedIn" placeholder="https://linkedin.com/in/username" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Twitter / X</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="twitter" placeholder="https://twitter.com/username" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>GitHub</mat-label>
            <mat-icon matPrefix>link</mat-icon>
            <input matInput formControlName="gitHub" placeholder="https://github.com/username" />
          </mat-form-field>
        </form>
      </div>
    </div>

    <!-- Section 4: Work Schedule -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>schedule</mat-icon>
        <h2>Work Schedule</h2>
      </div>
      <div class="section-body">
        <div class="work-days">
          <h4>Work Days</h4>
          <div class="day-strip">
            @for (day of workDays; track day) {
              <span
                class="day-pill"
                [class.active]="isWorkDaySelected(day)"
                (click)="toggleWorkDay(day)">
                {{ day.slice(0, 3) }}
              </span>
            }
          </div>
        </div>

        <form [formGroup]="profileForm">
          <div class="time-fields">
            <mat-form-field appearance="outline">
              <mat-label>Start Time</mat-label>
              <input matInput type="time" formControlName="workStartTime" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>End Time</mat-label>
              <input matInput type="time" formControlName="workEndTime" />
            </mat-form-field>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 5: Preferences -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>tune</mat-icon>
        <h2>Preferences</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="preferencesForm">
          <div class="preferences-layout">
            <div class="pref-item">
              <h4>Theme</h4>
              <mat-radio-group formControlName="theme">
                <div class="theme-options">
                  <mat-radio-button value="light">Light</mat-radio-button>
                  <mat-radio-button value="dark">Dark</mat-radio-button>
                </div>
              </mat-radio-group>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>Language</mat-label>
                <mat-select formControlName="language">
                  @for (lang of languages; track lang.value) {
                    <mat-option [value]="lang.value">{{ lang.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>Timezone</mat-label>
                <mat-select formControlName="timezone">
                  @for (tz of timezones; track tz) {
                    <mat-option [value]="tz">{{ tz }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="pref-item">
              <mat-form-field appearance="outline">
                <mat-label>Date Format</mat-label>
                <mat-select formControlName="dateFormat">
                  @for (fmt of dateFormats; track fmt.value) {
                    <mat-option [value]="fmt.value">{{ fmt.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Section 6: Notifications -->
    <div class="section-card">
      <div class="section-header">
        <mat-icon>notifications</mat-icon>
        <h2>Email Notifications</h2>
      </div>
      <div class="section-body">
        <form [formGroup]="preferencesForm">
          <div class="notification-list">
            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">Task Assigned</span>
                <span class="notification-desc">Get notified when a task is assigned to you</span>
              </div>
              <mat-slide-toggle formControlName="taskAssigned" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">Deal Updated</span>
                <span class="notification-desc">Get notified when deals you follow are updated</span>
              </div>
              <mat-slide-toggle formControlName="dealUpdated" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">Mentions</span>
                <span class="notification-desc">Get notified when someone mentions you</span>
              </div>
              <mat-slide-toggle formControlName="mention" color="primary"></mat-slide-toggle>
            </div>

            <div class="notification-row">
              <div class="notification-info">
                <span class="notification-label">Weekly Report</span>
                <span class="notification-desc">Receive a weekly summary of your CRM activity</span>
              </div>
              <mat-slide-toggle formControlName="weeklyReport" color="primary"></mat-slide-toggle>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
}
