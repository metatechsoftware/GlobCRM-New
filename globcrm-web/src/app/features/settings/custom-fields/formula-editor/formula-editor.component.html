<div class="formula-editor">
  <!-- Formula textarea -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>{{ 'customFields.formulaEditor.formulaExpression' | transloco }}</mat-label>
    <textarea matInput
              #formulaTextarea
              [formControl]="formulaControl"
              (keyup)="onKeyUp($event)"
              rows="3"
              [placeholder]="'customFields.formulaEditor.formulaPlaceholder' | transloco"
              spellcheck="false"></textarea>
    @if (validationErrors().length > 0) {
      <mat-error>{{ validationErrors()[0] }}</mat-error>
    }
    <mat-hint>{{ 'customFields.formulaEditor.formulaHint' | transloco }}</mat-hint>
  </mat-form-field>

  <!-- Autocomplete dropdown -->
  @if (showAutocomplete()) {
    <div class="autocomplete-panel"
         [style.top.px]="autocompletePosition().top"
         [style.left.px]="autocompletePosition().left">
      @for (group of ['System', 'Custom', 'Formula']; track group) {
        @if (groupedFields()[group]?.length) {
          <div class="autocomplete-group">
            <div class="group-label">{{ group === 'System' ? ('customFields.formulaEditor.systemFields' | transloco) : (group === 'Custom' ? ('customFields.formulaEditor.customFieldsGroup' | transloco) : ('customFields.formulaEditor.formulaFields' | transloco)) }}</div>
            @for (field of groupedFields()[group]; track field.name) {
              <button class="autocomplete-item" (mousedown)="insertField(field)" type="button">
                <span class="field-name">[{{ field.name }}]</span>
                <span class="field-label">{{ field.label }}</span>
                <span class="field-type">{{ field.dataType }}</span>
              </button>
            }
          </div>
        }
      }
      @if (!groupedFields()['System']?.length && !groupedFields()['Custom']?.length && !groupedFields()['Formula']?.length) {
        <div class="autocomplete-empty">{{ 'customFields.formulaEditor.noMatchingFields' | transloco }}</div>
      }
    </div>
  }

  <!-- Validation errors list (when more than one) -->
  @if (validationErrors().length > 1) {
    <div class="validation-errors">
      @for (error of validationErrors(); track error) {
        <div class="validation-error">
          <mat-icon class="error-icon">error</mat-icon>
          <span>{{ error }}</span>
        </div>
      }
    </div>
  }

  <!-- Live Preview panel -->
  <div class="formula-preview">
    <div class="preview-label">{{ 'customFields.formulaEditor.preview' | transloco }}</div>
    @if (isValidating() || isPreviewLoading()) {
      <div class="preview-content">
        <mat-spinner diameter="16"></mat-spinner>
        <span class="preview-loading">{{ 'customFields.formulaEditor.evaluating' | transloco }}</span>
      </div>
    } @else if (previewError()) {
      <span class="preview-error">#ERR: {{ previewError() }}</span>
    } @else if (previewResult() !== null && previewResult() !== undefined) {
      <span class="preview-result">{{ previewResult() }}</span>
    } @else {
      <span class="preview-placeholder">{{ 'customFields.formulaEditor.enterFormula' | transloco }}</span>
    }
  </div>

  <!-- Collapsible Formula Help -->
  <button type="button" class="help-toggle" (click)="toggleHelp()">
    <mat-icon>{{ showHelp() ? 'expand_less' : 'help_outline' }}</mat-icon>
    {{ showHelp() ? ('customFields.formulaEditor.hideHelp' | transloco) : ('customFields.formulaEditor.formulaHelp' | transloco) }}
  </button>
  @if (showHelp()) {
    <div class="formula-help">
      <h4>{{ 'customFields.formulaEditor.availableFunctions' | transloco }}</h4>
      <table class="help-table">
        <tr><td><code>+ - * /</code></td><td>{{ 'customFields.formulaEditor.arithmeticOperators' | transloco }}</td></tr>
        <tr><td><code>IF(condition, true_value, false_value)</code></td><td>{{ 'customFields.formulaEditor.conditionalLogic' | transloco }}</td></tr>
        <tr><td><code>DATEDIFF(date1, date2)</code></td><td>{{ 'customFields.formulaEditor.daysBetweenDates' | transloco }}</td></tr>
        <tr><td><code>CONCAT(value1, value2, ...)</code></td><td>{{ 'customFields.formulaEditor.joinTextValues' | transloco }}</td></tr>
      </table>
      <h4>{{ 'customFields.formulaEditor.examples' | transloco }}</h4>
      <ul class="help-examples">
        <li><code>[value] * [probability] / 100</code> -- {{ 'customFields.formulaEditor.exWeightedDeal' | transloco }}</li>
        <li><code>IF([status] == 'won', [value], 0)</code> -- {{ 'customFields.formulaEditor.exValueIfWon' | transloco }}</li>
        <li><code>DATEDIFF([createdAt], [expectedCloseDate])</code> -- {{ 'customFields.formulaEditor.exDaysToClose' | transloco }}</li>
        <li><code>CONCAT([firstName], ' ', [lastName])</code> -- {{ 'customFields.formulaEditor.exFullName' | transloco }}</li>
      </ul>
    </div>
  }
</div>
