<div class="role-edit-container">
  <div class="page-header">
    <button mat-icon-button routerLink="/settings/roles">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>{{ pageTitle }}</h1>
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading role...</p>
    </div>
  } @else if (errorMessage() && mode() === 'edit' && !roleForm.dirty) {
    <div class="error-container">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <p>{{ errorMessage() }}</p>
      <button mat-flat-button color="primary" routerLink="/settings/roles">
        Back to Roles
      </button>
    </div>
  } @else {
    <mat-card class="role-form-card">
      <mat-card-content>
        <form [formGroup]="roleForm" class="role-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Role Name</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Enter role name"
              maxlength="100"
            />
            @if (roleForm.get('name')?.hasError('required') && roleForm.get('name')?.touched) {
              <mat-error>Role name is required.</mat-error>
            }
            @if (roleForm.get('name')?.hasError('maxlength')) {
              <mat-error>Role name must be 100 characters or less.</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Optional description"
              rows="3"
            ></textarea>
          </mat-form-field>
        </form>

        <app-permission-matrix
          [permissions]="currentPermissions()"
          (permissionsChanged)="onPermissionsChanged($event)"
        ></app-permission-matrix>

        @if (errorMessage()) {
          <div class="form-error">
            <mat-icon>error_outline</mat-icon>
            <span>{{ errorMessage() }}</span>
          </div>
        }
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button routerLink="/settings/roles">Cancel</button>
        <button
          mat-flat-button
          color="primary"
          (click)="onSave()"
          [disabled]="isSaving() || roleForm.invalid"
        >
          @if (isSaving()) {
            <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
          } @else {
            {{ mode() === 'create' ? 'Create Role' : 'Save Changes' }}
          }
        </button>
      </mat-card-actions>
    </mat-card>
  }
</div>
