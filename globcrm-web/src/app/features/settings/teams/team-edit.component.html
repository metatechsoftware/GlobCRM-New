<div class="team-edit-page">
  <!-- Header -->
  <div class="edit-header">
    <a routerLink="/settings/teams" class="back-link">
      <mat-icon>arrow_back</mat-icon>
      <span>{{ 'settings.teams.title' | transloco }}</span>
    </a>
    <h1>{{ pageTitle }}</h1>
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>{{ 'settings.teamEdit.loadingTeam' | transloco }}</p>
    </div>
  } @else if (errorMessage() && mode() === 'edit' && !teamForm.dirty) {
    <div class="error-state">
      <div class="error-icon-wrap">
        <mat-icon>error_outline</mat-icon>
      </div>
      <h3>{{ 'settings.teamEdit.couldntLoad' | transloco }}</h3>
      <p>{{ errorMessage() }}</p>
      <button mat-flat-button color="primary" routerLink="/settings/teams">
        {{ 'settings.teamEdit.backToTeams' | transloco }}
      </button>
    </div>
  } @else {
    <div class="edit-layout" [class.has-members]="mode() === 'edit'">
      <!-- Form Section -->
      <div class="form-section">
        <div class="section-card">
          <div class="section-header">
            <mat-icon class="section-icon">tune</mat-icon>
            <h2>{{ 'settings.teamEdit.detailsSection' | transloco }}</h2>
          </div>

          <form [formGroup]="teamForm" class="team-form">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.teamEdit.teamName' | transloco }}</mat-label>
              <input
                matInput
                formControlName="name"
                [placeholder]="'settings.teamEdit.teamNamePlaceholder' | transloco"
                maxlength="100"
              />
              @if (teamForm.get('name')?.hasError('required') && teamForm.get('name')?.touched) {
                <mat-error>{{ 'settings.teamEdit.teamNameRequired' | transloco }}</mat-error>
              }
              @if (teamForm.get('name')?.hasError('maxlength')) {
                <mat-error>{{ 'settings.teamEdit.teamNameMaxLength' | transloco }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.teamEdit.description' | transloco }}</mat-label>
              <textarea
                matInput
                formControlName="description"
                [placeholder]="'settings.teamEdit.descriptionPlaceholder' | transloco"
                rows="3"
              ></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'settings.teamEdit.defaultRole' | transloco }}</mat-label>
              <mat-select formControlName="defaultRoleId">
                <mat-option [value]="null">{{ 'settings.teamEdit.defaultRoleNone' | transloco }}</mat-option>
                @for (role of roles(); track role.id) {
                  <mat-option [value]="role.id">{{ role.name }}</mat-option>
                }
              </mat-select>
              <mat-hint>{{ 'settings.teamEdit.defaultRoleHint' | transloco }}</mat-hint>
            </mat-form-field>
          </form>

          @if (errorMessage()) {
            <div class="form-error">
              <mat-icon>error_outline</mat-icon>
              <span>{{ errorMessage() }}</span>
            </div>
          }

          <div class="form-actions">
            <button mat-button routerLink="/settings/teams" class="cancel-btn">{{ 'settings.teamEdit.cancel' | transloco }}</button>
            <button
              mat-flat-button
              color="primary"
              (click)="onSave()"
              [disabled]="isSaving() || teamForm.invalid"
              class="save-btn"
            >
              @if (isSaving()) {
                <mat-spinner diameter="18" class="button-spinner"></mat-spinner>
              } @else {
                <mat-icon>{{ mode() === 'create' ? 'add' : 'check' }}</mat-icon>
                {{ mode() === 'create' ? ('settings.teamEdit.createTeam' | transloco) : ('settings.teamEdit.saveChanges' | transloco) }}
              }
            </button>
          </div>
        </div>
      </div>

      <!-- Members Section (edit mode) -->
      @if (mode() === 'edit') {
        <div class="members-section">
          <div class="section-card" style="animation-delay: 80ms">
            <div class="section-header">
              <mat-icon class="section-icon">people</mat-icon>
              <h2>{{ 'settings.teamEdit.membersSection' | transloco }}</h2>
              <span class="member-count">{{ members().length }}</span>
              <button
                mat-flat-button
                color="primary"
                (click)="onAddMember()"
                class="add-member-btn"
              >
                <mat-icon>person_add</mat-icon>
                {{ 'settings.teamEdit.addMember' | transloco }}
              </button>
            </div>

            @if (members().length === 0) {
              <div class="empty-members">
                <div class="empty-members-visual">
                  <mat-icon>person_add</mat-icon>
                </div>
                <p>{{ 'settings.teamEdit.noMembersYet' | transloco }}</p>
                <span class="empty-hint">{{ 'settings.teamEdit.addMembersHint' | transloco }}</span>
              </div>
            } @else {
              <div class="members-list">
                @for (member of members(); track member.userId; let i = $index) {
                  <div class="member-card" [style.animation-delay]="(i * 40) + 'ms'">
                    <div
                      class="member-avatar"
                      [style.background-color]="member.avatarColor || '#7c4dff'"
                    >
                      {{ getInitials(member) }}
                    </div>
                    <div class="member-info">
                      <span class="member-name">
                        {{ member.firstName }} {{ member.lastName }}
                      </span>
                      <span class="member-email">{{ member.email }}</span>
                    </div>
                    <button
                      mat-icon-button
                      (click)="onRemoveMember(member)"
                      class="remove-btn"
                      [matTooltip]="'settings.teamEdit.removeFromTeam' | transloco"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
