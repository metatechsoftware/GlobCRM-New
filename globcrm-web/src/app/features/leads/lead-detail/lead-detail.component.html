@if (isLoading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else if (lead()) {
  <div class="detail-page">

    <!-- Converted Banner -->
    @if (lead()!.isConverted) {
      <div class="converted-banner">
        <mat-icon>swap_horiz</mat-icon>
        <div class="converted-banner-text">
          <strong>{{ 'detail.convertedBanner.title' | transloco }}</strong>
          <span>
            {{ 'detail.convertedBanner.onDate' | transloco }} {{ lead()!.convertedAt | date:'mediumDate' }}
            @if (lead()!.convertedByUserName) {
              {{ 'detail.convertedBanner.byUser' | transloco }} {{ lead()!.convertedByUserName }}
            }
          </span>
        </div>
        <div class="converted-links">
          @if (lead()!.convertedContactId) {
            <a mat-stroked-button [routerLink]="['/contacts', lead()!.convertedContactId]">
              <mat-icon>person</mat-icon> {{ 'detail.conversion.contact' | transloco }}
            </a>
          }
          @if (lead()!.convertedCompanyId) {
            <a mat-stroked-button [routerLink]="['/companies', lead()!.convertedCompanyId]">
              <mat-icon>business</mat-icon> {{ 'detail.conversion.company' | transloco }}
            </a>
          }
          @if (lead()!.convertedDealId) {
            <a mat-stroked-button [routerLink]="['/deals', lead()!.convertedDealId]">
              <mat-icon>handshake</mat-icon> {{ 'detail.conversion.deal' | transloco }}
            </a>
          }
        </div>
      </div>
    }

    <!-- Hero Card -->
    <div class="lead-hero">
      <div class="hero-accent"></div>

      <!-- Nav bar -->
      <div class="hero-nav">
        <a mat-icon-button routerLink="/leads" [attr.aria-label]="'detail.backToLeads' | transloco">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <div class="hero-nav-actions">
          @if (!isTerminal()) {
            <button mat-stroked-button
                    *appHasPermission="'Lead:Edit'"
                    [routerLink]="['/leads', lead()!.id, 'edit']">
              <mat-icon>edit</mat-icon> {{ 'common.edit' | transloco }}
            </button>
          }
          @if (!lead()!.isConverted) {
            <button mat-stroked-button color="warn"
                    *appHasPermission="'Lead:Delete'"
                    (click)="onDelete()">
              <mat-icon>delete</mat-icon> {{ 'common.delete' | transloco }}
            </button>
          }
          @if (!isTerminal()) {
            <button mat-raised-button color="primary"
                    *appHasPermission="'Lead:Edit'"
                    (click)="onConvert()">
              <mat-icon>swap_horiz</mat-icon> {{ 'detail.convertLead' | transloco }}
            </button>
          }
        </div>
      </div>

      <!-- Profile section -->
      <div class="hero-profile">
        <div class="hero-avatar">{{ getInitials() }}</div>
        <div class="hero-info">
          <h1 class="hero-name">{{ lead()!.fullName }}</h1>
          <div class="hero-badges">
            <!-- Temperature badge -->
            <span class="temperature-badge"
                  [style.background-color]="getTemperatureColor(lead()!.temperature)">
              {{ lead()!.temperature }}
            </span>

            <!-- Stage badge -->
            <span class="stage-badge"
                  [style.background-color]="lead()!.stageColor + '22'"
                  [style.color]="lead()!.stageColor">
              <span class="stage-dot" [style.background-color]="lead()!.stageColor"></span>
              {{ lead()!.stageName }}
            </span>

            <!-- Source badge -->
            @if (lead()!.sourceName) {
              <span class="badge badge--secondary">{{ lead()!.sourceName }}</span>
            }

            <!-- Job title badge -->
            @if (lead()!.jobTitle) {
              <span class="badge badge--info">{{ lead()!.jobTitle }}</span>
            }
          </div>
        </div>
      </div>

      <div class="hero-divider"></div>

      <!-- Meta info -->
      <div class="hero-meta">
        @if (lead()!.email) {
          <span class="meta-item">
            <mat-icon>email</mat-icon>
            <a href="mailto:{{ lead()!.email }}">{{ lead()!.email }}</a>
          </span>
          <span class="meta-separator"></span>
        }
        @if (lead()!.phone) {
          <span class="meta-item">
            <mat-icon>phone</mat-icon>
            {{ lead()!.phone }}
          </span>
          <span class="meta-separator"></span>
        }
        @if (lead()!.companyName) {
          <span class="meta-item">
            <mat-icon>business</mat-icon>
            {{ lead()!.companyName }}
          </span>
          <span class="meta-separator"></span>
        }
        @if (lead()!.ownerName) {
          <span class="meta-item">
            <mat-icon>person</mat-icon>
            {{ lead()!.ownerName }}
          </span>
        }
      </div>
    </div>

    <!-- Stage Pipeline -->
    <div class="stage-pipeline" [class.stage-pipeline--terminal]="isTerminal()">
      <div class="pipeline__header">
        <div class="pipeline__label">
          <mat-icon>route</mat-icon>
          {{ 'detail.leadPipeline' | transloco }}
        </div>
        @if (currentStage(); as cs) {
          <div class="pipeline__status">
            <span class="pipeline__status-dot" [style.background-color]="cs.color" [style.color]="cs.color"></span>
            {{ cs.name }}
          </div>
        }
      </div>

      <div class="pipeline__body">
        <div class="pipeline__stages">
          @for (stage of activeStages(); track stage.id; let i = $index; let last = $last) {
            <div class="pipeline__stage"
                 [class.is-past]="isStagePast(stage)"
                 [class.is-current]="isStageCurrent(stage)"
                 [class.is-future]="!isStagePast(stage) && !isStageCurrent(stage)"
                 [class.is-clickable]="isStageClickable(stage)"
                 [style.--stage-color]="stage.color"
                 [style.animation-delay]="(i * 80) + 'ms'"
                 (click)="onStageClick(stage)">
              <div class="stage__marker">
                @if (isStageCurrent(stage)) {
                  <div class="stage__glow" [style.border-color]="stage.color + '80'"></div>
                }
                @if (isStagePast(stage)) {
                  <mat-icon class="stage__check">check</mat-icon>
                } @else {
                  <span class="stage__number">{{ i + 1 }}</span>
                }
              </div>
              <span class="stage__label">{{ stage.name }}</span>
              @if (!last) {
                <div class="stage__connector"
                     [class.is-filled]="isStagePast(stage)"></div>
              }
            </div>
          }
        </div>

        <!-- Terminal stages -->
        @if (terminalStages().length > 0) {
          <div class="pipeline__terminal">
            <div class="pipeline__terminal-line"></div>
            @for (stage of terminalStages(); track stage.id) {
              <div class="pipeline__stage pipeline__stage--terminal"
                   [class.is-current]="isStageCurrent(stage)"
                   [class.is-converted]="stage.isConverted"
                   [class.is-lost]="stage.isLost">
                <div class="stage__marker">
                  @if (stage.isConverted) {
                    <mat-icon class="stage__terminal-icon">check_circle</mat-icon>
                  } @else {
                    <mat-icon class="stage__terminal-icon">cancel</mat-icon>
                  }
                </div>
                <span class="stage__label">{{ stage.name }}</span>
              </div>
            }
          </div>
        }
      </div>

      <!-- Reopen button for terminal stages -->
      @if (isTerminal() && !lead()!.isConverted) {
        <div class="pipeline__footer">
          <button mat-stroked-button
                  *appHasPermission="'Lead:Edit'"
                  (click)="onReopen()">
            <mat-icon>replay</mat-icon> {{ 'detail.reopenLead' | transloco }}
          </button>
        </div>
      }
    </div>

    <!-- Main content: Tabs -->
    <div class="detail-content">
      <div class="detail-main">
        <app-related-entity-tabs [tabs]="tabs()" [activeTabIndex]="activeTabIndex()" (tabChanged)="onTabChanged($event)">

          <!-- Tab 0: Summary -->
          <ng-template>
            <app-entity-summary-tab
              entityType="Lead"
              [data]="summaryData()"
              [loading]="summaryLoading()"
              (associationClicked)="onAssociationClicked($event)"
              (addNote)="onSummaryAddNote()"
              (logActivity)="onSummaryLogActivity()"
              (sendEmail)="onSummarySendEmail()" />
          </ng-template>

          <!-- Tab 1: Overview -->
          <ng-template>
            <!-- Contact Info Section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>person</mat-icon>
                <h3>{{ 'detail.sections.contactInfo' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.email' | transloco }}</span>
                  <span class="field-value">
                    @if (lead()!.email) {
                      <a href="mailto:{{ lead()!.email }}">{{ lead()!.email }}</a>
                    } @else {
                      <span class="field-value--empty">{{ 'detail.empty.notSpecified' | transloco }}</span>
                    }
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.phone' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.phone">
                    {{ lead()!.phone || ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.mobile' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.mobilePhone">
                    {{ lead()!.mobilePhone || ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.jobTitle' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.jobTitle">
                    {{ lead()!.jobTitle || ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.company' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.companyName">
                    {{ lead()!.companyName || ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Lead Details Section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>leaderboard</mat-icon>
                <h3>{{ 'detail.sections.leadDetails' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.stage' | transloco }}</span>
                  <span class="field-value stage-value">
                    <span class="stage-dot" [style.background-color]="lead()!.stageColor"></span>
                    {{ lead()!.stageName }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.source' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.sourceName">
                    {{ lead()!.sourceName || ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.owner' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.ownerName">
                    {{ lead()!.ownerName || ('detail.empty.unassigned' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.temperature' | transloco }}</span>
                  <span class="field-value">
                    <span class="temperature-badge"
                          [style.background-color]="getTemperatureColor(lead()!.temperature)">
                      {{ lead()!.temperature }}
                    </span>
                  </span>
                </div>
                <div class="detail-field full-width">
                  <span class="field-label">{{ 'detail.fields.description' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!lead()!.description">
                    {{ lead()!.description || ('detail.empty.noDescription' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.created' | transloco }}</span>
                  <span class="field-value">{{ lead()!.createdAt | date:'medium' }}</span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.lastUpdated' | transloco }}</span>
                  <span class="field-value">{{ lead()!.updatedAt | date:'medium' }}</span>
                </div>
              </div>
            </div>

            <!-- Custom Fields -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>tune</mat-icon>
                <h3>{{ 'detail.sections.customFields' | transloco }}</h3>
              </div>
              <app-custom-field-form
                [entityType]="'Lead'"
                [customFieldValues]="lead()!.customFields"
                [readonly]="true" />
            </div>
          </ng-template>

          <!-- Tab 1: Activities -->
          <ng-template>
            @if (activitiesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedActivities().length === 0) {
              <div class="tab-empty">
                <mat-icon>task_alt</mat-icon>
                <span>{{ 'detail.activities.noActivities' | transloco }}</span>
                <a mat-stroked-button routerLink="/activities/new">{{ 'detail.activities.createActivity' | transloco }}</a>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'detail.activities.columnSubject' | transloco }}</th>
                    <th>{{ 'detail.activities.columnType' | transloco }}</th>
                    <th>{{ 'detail.activities.columnStatus' | transloco }}</th>
                    <th>{{ 'detail.activities.columnPriority' | transloco }}</th>
                    <th>{{ 'detail.activities.columnDueDate' | transloco }}</th>
                    <th>{{ 'detail.activities.columnAssignedTo' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (activity of linkedActivities(); track activity.id) {
                    <tr>
                      <td><a [routerLink]="['/activities', activity.id]">{{ activity.subject }}</a></td>
                      <td>{{ activity.type }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getStatusColor(activity.status) + '22'"
                                    [style.color]="getStatusColor(activity.status)">
                            {{ activity.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getPriorityColor(activity.priority) + '22'"
                                    [style.color]="getPriorityColor(activity.priority)">
                            {{ activity.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td class="text-nowrap">{{ activity.dueDate ? (activity.dueDate | date:'mediumDate') : '-' }}</td>
                      <td>{{ activity.assignedToName || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Tab 2: Notes -->
          <ng-template>
            @if (notesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (leadNotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>note</mat-icon>
                <span>{{ 'detail.notes.noNotes' | transloco }}</span>
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Lead', entityId: lead()?.id, entityName: lead()?.fullName }">
                  {{ 'detail.notes.addNote' | transloco }}
                </a>
              </div>
            } @else {
              <div class="tab-actions">
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Lead', entityId: lead()?.id, entityName: lead()?.fullName }">
                  <mat-icon>add</mat-icon> {{ 'detail.notes.addNote' | transloco }}
                </a>
              </div>
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'detail.notes.columnTitle' | transloco }}</th>
                    <th>{{ 'detail.notes.columnPreview' | transloco }}</th>
                    <th>{{ 'detail.notes.columnAuthor' | transloco }}</th>
                    <th>{{ 'detail.notes.columnDate' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (note of leadNotes(); track note.id) {
                    <tr>
                      <td><a [routerLink]="['/notes', note.id]">{{ note.title }}</a></td>
                      <td class="text-preview">{{ note.plainTextBody }}</td>
                      <td>{{ note.authorName || '-' }}</td>
                      <td class="text-nowrap">{{ formatNoteDate(note.createdAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Tab 3: Attachments -->
          <ng-template>
            <app-entity-attachments [entityType]="'lead'" [entityId]="lead()?.id ?? ''" />
          </ng-template>

          <!-- Tab 4: Timeline -->
          <ng-template>
            <app-entity-timeline
              [entries]="timelineEntries()"
              [isLoading]="timelineLoading()" />
          </ng-template>

          <!-- Tab 5: Conversion (only when converted) -->
          @if (lead()!.isConverted) {
            <ng-template>
              <div class="conversion-details">
                <h3>{{ 'detail.conversion.title' | transloco }}</h3>
                <div class="details-grid">
                  <div class="detail-field">
                    <span class="field-label">{{ 'detail.conversion.convertedOn' | transloco }}</span>
                    <span class="field-value">{{ lead()!.convertedAt | date:'medium' }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="field-label">{{ 'detail.conversion.convertedBy' | transloco }}</span>
                    <span class="field-value" [class.field-value--empty]="!lead()!.convertedByUserName">
                      {{ lead()!.convertedByUserName || ('detail.empty.unknown' | transloco) }}
                    </span>
                  </div>
                </div>

                <h3 class="section-title">{{ 'detail.conversion.createdRecords' | transloco }}</h3>
                <div class="conversion-links">
                  @if (lead()!.conversionDetails?.contactId) {
                    <a class="conversion-link-card" [routerLink]="['/contacts', lead()!.conversionDetails!.contactId]">
                      <mat-icon>person</mat-icon>
                      <div>
                        <strong>{{ 'detail.conversion.contact' | transloco }}</strong>
                        <span>{{ lead()!.conversionDetails!.contactName || ('detail.conversion.viewContact' | transloco) }}</span>
                      </div>
                      <mat-icon class="link-arrow">arrow_forward</mat-icon>
                    </a>
                  }
                  @if (lead()!.conversionDetails?.companyId) {
                    <a class="conversion-link-card" [routerLink]="['/companies', lead()!.conversionDetails!.companyId]">
                      <mat-icon>business</mat-icon>
                      <div>
                        <strong>{{ 'detail.conversion.company' | transloco }}</strong>
                        <span>{{ lead()!.conversionDetails!.companyName || ('detail.conversion.viewCompany' | transloco) }}</span>
                      </div>
                      <mat-icon class="link-arrow">arrow_forward</mat-icon>
                    </a>
                  }
                  @if (lead()!.conversionDetails?.dealId) {
                    <a class="conversion-link-card" [routerLink]="['/deals', lead()!.conversionDetails!.dealId]">
                      <mat-icon>handshake</mat-icon>
                      <div>
                        <strong>{{ 'detail.conversion.deal' | transloco }}</strong>
                        <span>{{ lead()!.conversionDetails!.dealTitle || ('detail.conversion.viewDeal' | transloco) }}</span>
                      </div>
                      <mat-icon class="link-arrow">arrow_forward</mat-icon>
                    </a>
                  }
                </div>

                @if (lead()!.conversionDetails?.notes) {
                  <h3 class="section-title">{{ 'detail.conversion.conversionNotes' | transloco }}</h3>
                  <p class="conversion-notes">{{ lead()!.conversionDetails!.notes }}</p>
                }
              </div>
            </ng-template>
          }

        </app-related-entity-tabs>
      </div>

      <!-- Timeline sidebar -->
      <div class="sidebar-card">
        <div class="sidebar-card__header">Timeline</div>
        <div class="sidebar-card__body">
          <app-entity-timeline
            [entries]="timelineEntries()"
            [isLoading]="timelineLoading()" />
        </div>
      </div>
    </div>
  </div>
} @else {
  <div class="detail-not-found">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ 'detail.notFound' | transloco }}</h2>
    <a mat-stroked-button routerLink="/leads">{{ 'detail.backToLeads' | transloco }}</a>
  </div>
}
