<h2 mat-dialog-title>
  <mat-icon>swap_horiz</mat-icon>
  {{ 'leads.convert.dialogTitle' | transloco }} {{ data.lead.fullName }}
</h2>

<mat-dialog-content>

  <!-- Loading duplicate check -->
  @if (duplicateLoading()) {
    <div class="loading-section">
      <mat-spinner diameter="32"></mat-spinner>
      <span>{{ 'leads.convert.checkingDuplicates' | transloco }}</span>
    </div>
  }

  <!-- Section 1: Contact (always visible, required) -->
  <div class="convert-section">
    <div class="section-header">
      <mat-icon>person</mat-icon>
      <h3>{{ 'leads.convert.contactSection' | transloco }}</h3>
      <span class="required-badge">{{ 'leads.convert.required' | transloco }}</span>
    </div>

    <form [formGroup]="contactForm">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.firstName' | transloco }}</mat-label>
          <input matInput formControlName="firstName" required>
          @if (contactForm.controls['firstName'].hasError('required')) {
            <mat-error>{{ 'leads.convert.validation.firstNameRequired' | transloco }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.lastName' | transloco }}</mat-label>
          <input matInput formControlName="lastName" required>
          @if (contactForm.controls['lastName'].hasError('required')) {
            <mat-error>{{ 'leads.convert.validation.lastNameRequired' | transloco }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.email' | transloco }}</mat-label>
          <input matInput formControlName="email" type="email">
          @if (contactForm.controls['email'].hasError('email')) {
            <mat-error>{{ 'leads.convert.validation.invalidEmail' | transloco }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.phone' | transloco }}</mat-label>
          <input matInput formControlName="phone">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.mobilePhone' | transloco }}</mat-label>
          <input matInput formControlName="mobilePhone">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.fields.jobTitle' | transloco }}</mat-label>
          <input matInput formControlName="jobTitle">
        </mat-form-field>
      </div>
    </form>

    <!-- Duplicate contact warning -->
    @if (hasContactMatches && !duplicateLoading()) {
      <div class="duplicate-warning">
        <mat-icon>warning</mat-icon>
        <div>
          @for (match of duplicateResult()!.contactMatches; track match.id) {
            <p>
              {{ 'leads.convert.duplicateContact' | transloco: { name: match.fullName, email: match.email } }}
            </p>
          }
        </div>
      </div>
    }
  </div>

  <!-- Section 2: Company (optional toggle) -->
  <div class="convert-section">
    <div class="section-header">
      <mat-icon>business</mat-icon>
      <h3>{{ 'leads.convert.companySection' | transloco }}</h3>
      <mat-slide-toggle
        [checked]="createCompanyEnabled()"
        (change)="onCompanyToggle($event.checked)"
        labelPosition="before">
        {{ 'leads.convert.createOrLink' | transloco }}
      </mat-slide-toggle>
    </div>

    @if (createCompanyEnabled()) {
      <!-- Duplicate company warning -->
      @if (hasCompanyMatches && !duplicateLoading()) {
        <div class="duplicate-warning">
          <mat-icon>warning</mat-icon>
          <div>
            @for (match of duplicateResult()!.companyMatches; track match.id) {
              <p>
                {{ 'leads.convert.duplicateCompany' | transloco: { name: match.name } }}
              </p>
            }
          </div>
        </div>
      }

      <mat-radio-group
        [value]="companyMode()"
        (change)="onCompanyModeChange($event.value)"
        class="company-mode-group">
        <mat-radio-button value="link">{{ 'leads.convert.linkToExisting' | transloco }}</mat-radio-button>
        <mat-radio-button value="create">{{ 'leads.convert.createNew' | transloco }}</mat-radio-button>
      </mat-radio-group>

      @if (companyMode() === 'link') {
        <div class="company-search">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'leads.convert.searchCompanies' | transloco }}</mat-label>
            <input matInput
                   [formControl]="companySearchControl"
                   [matAutocomplete]="companyAuto"
                   [placeholder]="'leads.convert.searchPlaceholder' | transloco">
            <mat-autocomplete #companyAuto="matAutocomplete"
                              [displayWith]="displayCompanyName"
                              (optionSelected)="onCompanySelected($event)">
              @for (company of companySearchResults(); track company.id) {
                <mat-option [value]="company">
                  <div class="company-option">
                    <span class="company-option-name">{{ company.name }}</span>
                    @if (company.industry) {
                      <span class="company-option-detail">{{ company.industry }}</span>
                    }
                  </div>
                </mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        </div>
      }

      @if (companyMode() === 'create') {
        <form [formGroup]="companyForm" class="form-grid">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'leads.convert.newCompanyName' | transloco }}</mat-label>
            <input matInput formControlName="newCompanyName">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'leads.convert.newCompanyWebsite' | transloco }}</mat-label>
            <input matInput formControlName="newCompanyWebsite" placeholder="https://...">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'leads.convert.newCompanyPhone' | transloco }}</mat-label>
            <input matInput formControlName="newCompanyPhone">
          </mat-form-field>
        </form>
      }
    }
  </div>

  <!-- Section 3: Deal (optional toggle) -->
  <div class="convert-section">
    <div class="section-header">
      <mat-icon>handshake</mat-icon>
      <h3>{{ 'leads.convert.dealSection' | transloco }}</h3>
      <mat-slide-toggle
        [checked]="createDealEnabled()"
        (change)="onDealToggle($event.checked)"
        labelPosition="before">
        {{ 'leads.convert.createDeal' | transloco }}
      </mat-slide-toggle>
    </div>

    @if (createDealEnabled()) {
      <form [formGroup]="dealForm" class="form-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'leads.convert.dealTitle' | transloco }}</mat-label>
          <input matInput formControlName="dealTitle">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.dealValue' | transloco }}</mat-label>
          <input matInput formControlName="dealValue" type="number" min="0">
          <span matTextPrefix>$&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'leads.convert.dealPipeline' | transloco }}</mat-label>
          <mat-select formControlName="dealPipelineId">
            @for (pipeline of pipelines(); track pipeline.id) {
              <mat-option [value]="pipeline.id">{{ pipeline.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </form>
    }
  </div>

</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">{{ 'common.cancel' | transloco }}</button>
  <button mat-raised-button color="primary"
          (click)="onConvert()"
          [disabled]="isSaving() || contactForm.invalid"
          class="convert-action-button">
    @if (isSaving()) {
      <mat-spinner diameter="20"></mat-spinner>
    }
    <mat-icon>swap_horiz</mat-icon>
    {{ 'leads.convert.convertButton' | transloco }}
  </button>
</mat-dialog-actions>
