@if (isLoading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else if (deal()) {
  <div class="detail-page">
    <!-- Hero Card -->
    <div class="deal-hero">
      <div class="hero-accent"></div>

      <!-- Navigation bar -->
      <div class="hero-nav">
        <a mat-icon-button routerLink="/deals" [attr.aria-label]="'detail.backToDeals' | transloco">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <div class="hero-actions">
          <button mat-stroked-button
                  *appHasPermission="'Deal:Edit'"
                  routerLink="edit">
            <mat-icon>edit</mat-icon> {{ 'common.edit' | transloco }}
          </button>
          <button mat-stroked-button color="warn"
                  *appHasPermission="'Deal:Delete'"
                  (click)="onDelete()">
            <mat-icon>delete</mat-icon> {{ 'common.delete' | transloco }}
          </button>
        </div>
      </div>

      <!-- Profile section -->
      <div class="hero-profile">
        <div class="hero-avatar">
          <mat-icon>handshake</mat-icon>
        </div>
        <div class="hero-info">
          <h1 class="hero-name">{{ deal()!.title }}</h1>
          <div class="hero-badges">
            <span class="stage-badge"
                  [style.background-color]="deal()!.stageColor + '22'"
                  [style.color]="deal()!.stageColor">
              <span class="stage-dot" [style.background-color]="deal()!.stageColor"></span>
              {{ deal()!.stageName }}
            </span>
            @if (deal()!.value != null) {
              <span class="badge badge--success">{{ formatValue(deal()!.value) }}</span>
            }
            @if (deal()!.probability != null) {
              <span class="badge badge--accent">{{ formatProbability(deal()!.probability) }}</span>
            }
            @if (deal()!.linkedContacts?.length) {
              <span class="hero-stat">
                <mat-icon>people</mat-icon>
                {{ 'detail.contacts.count' | transloco: { count: deal()!.linkedContacts!.length } }}
              </span>
            }
            @if (deal()!.linkedProducts?.length) {
              <span class="hero-stat">
                <mat-icon>inventory_2</mat-icon>
                {{ 'detail.products.count' | transloco: { count: deal()!.linkedProducts!.length } }}
              </span>
            }
          </div>
        </div>
      </div>

      <!-- Meta info pills -->
      <hr class="hero-divider">
      <div class="hero-meta">
        @if (deal()!.value != null) {
          <span class="meta-item">
            <mat-icon>monetization_on</mat-icon>
            {{ formatValue(deal()!.value) }}
          </span>
          <span class="meta-separator"></span>
        }
        <span class="meta-item">
          <mat-icon>account_tree</mat-icon>
          {{ deal()!.pipelineName }}
        </span>
        @if (deal()!.expectedCloseDate) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>event</mat-icon>
            {{ deal()!.expectedCloseDate | date:'mediumDate' }}
          </span>
        }
        @if (deal()!.companyName) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>business</mat-icon>
            <a [routerLink]="['/companies', deal()!.companyId]">{{ deal()!.companyName }}</a>
          </span>
        }
        @if (deal()!.ownerName) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>person</mat-icon>
            {{ deal()!.ownerName }}
          </span>
        }
      </div>
    </div>

    <!-- Main content: Tabs + Timeline sidebar -->
    <div class="detail-content">
      <div class="detail-main">
        <app-related-entity-tabs [tabs]="tabs" [activeTabIndex]="activeTabIndex()" (tabChanged)="onTabChanged($event)">

          <!-- Tab 0: Summary -->
          <ng-template>
            <app-entity-summary-tab
              entityType="Deal"
              [data]="summaryData()"
              [loading]="summaryLoading()"
              (associationClicked)="onAssociationClicked($event)"
              (addNote)="onSummaryAddNote()"
              (logActivity)="onSummaryLogActivity()" />
          </ng-template>

          <!-- Tab 1: Details -->
          <ng-template>
            <!-- Deal Info section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>handshake</mat-icon>
                <h3>{{ 'detail.sections.dealInfo' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field full-width">
                  <span class="field-label">{{ 'detail.fields.description' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!deal()!.description">
                    {{ deal()!.description || ('detail.empty.noDescription' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.pipeline' | transloco }}</span>
                  <span class="field-value">{{ deal()!.pipelineName }}</span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.stage' | transloco }}</span>
                  <span class="field-value stage-value">
                    <span class="stage-dot" [style.background-color]="deal()!.stageColor"></span>
                    {{ deal()!.stageName }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.value' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="deal()!.value == null">
                    {{ deal()!.value != null ? formatValue(deal()!.value) : ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.probability' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="deal()!.probability == null">
                    {{ deal()!.probability != null ? formatProbability(deal()!.probability) : ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Dates & Assignment section -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>calendar_today</mat-icon>
                <h3>{{ 'detail.sections.datesAssignment' | transloco }}</h3>
              </div>
              <div class="details-grid">
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.expectedCloseDate' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!deal()!.expectedCloseDate">
                    {{ deal()!.expectedCloseDate ? (deal()!.expectedCloseDate | date:'mediumDate') : ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.actualCloseDate' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!deal()!.actualCloseDate">
                    {{ deal()!.actualCloseDate ? (deal()!.actualCloseDate | date:'mediumDate') : ('detail.empty.notSpecified' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.owner' | transloco }}</span>
                  <span class="field-value" [class.field-value--empty]="!deal()!.ownerName">
                    {{ deal()!.ownerName || ('detail.empty.unassigned' | transloco) }}
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.company' | transloco }}</span>
                  <span class="field-value">
                    @if (deal()!.companyId) {
                      <a class="field-value--link" [routerLink]="['/companies', deal()!.companyId]">{{ deal()!.companyName }}</a>
                    } @else {
                      <span class="field-value--empty">{{ 'detail.empty.notSpecified' | transloco }}</span>
                    }
                  </span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.created' | transloco }}</span>
                  <span class="field-value">{{ deal()!.createdAt | date:'medium' }}</span>
                </div>
                <div class="detail-field">
                  <span class="field-label">{{ 'detail.fields.lastUpdated' | transloco }}</span>
                  <span class="field-value">{{ deal()!.updatedAt | date:'medium' }}</span>
                </div>
              </div>
            </div>

            <!-- Custom fields -->
            <div class="detail-section">
              <div class="detail-section__header">
                <mat-icon>tune</mat-icon>
                <h3>{{ 'detail.sections.customFields' | transloco }}</h3>
              </div>
              <app-custom-field-form
                [entityType]="'Deal'"
                [customFieldValues]="deal()!.customFields"
                [readonly]="true" />
            </div>
          </ng-template>

          <!-- Tab 1: Contacts -->
          <ng-template>
            <div class="linked-entity-tab">
              <div class="tab-header">
                <span class="tab-count">{{ 'detail.contacts.count' | transloco: { count: deal()!.linkedContacts?.length || 0 } }}</span>
                <button mat-stroked-button
                        *appHasPermission="'Deal:Edit'"
                        (click)="toggleContactSearch()">
                  <mat-icon>{{ showContactSearch() ? 'close' : 'person_add' }}</mat-icon>
                  {{ showContactSearch() ? ('common.cancel' | transloco) : ('detail.contacts.linkContact' | transloco) }}
                </button>
              </div>

              <!-- Contact search -->
              @if (showContactSearch()) {
                <div class="link-search-panel">
                  <mat-form-field appearance="outline" class="search-field">
                    <mat-label>{{ 'detail.contacts.searchContacts' | transloco }}</mat-label>
                    <input matInput
                           [value]="contactSearchTerm()"
                           (input)="onContactSearchInput($any($event.target).value)"
                           [placeholder]="'detail.contacts.searchPlaceholder' | transloco">
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>
                  @if (contactSearchLoading()) {
                    <div class="search-loading">
                      <mat-spinner diameter="24"></mat-spinner>
                    </div>
                  }
                  @if (contactSearchResults().length > 0) {
                    <mat-list class="search-results">
                      @for (contact of contactSearchResults(); track contact.id) {
                        <mat-list-item class="search-result-item" (click)="linkContact(contact)">
                          <mat-icon matListItemIcon>person</mat-icon>
                          <span matListItemTitle>{{ contact.fullName }}</span>
                          <span matListItemLine>
                            @if (contact.email) { {{ contact.email }} }
                          </span>
                          <button mat-icon-button matListItemMeta aria-label="Link contact">
                            <mat-icon>add_link</mat-icon>
                          </button>
                        </mat-list-item>
                      }
                    </mat-list>
                  }
                </div>
              }

              <!-- Linked contacts list -->
              @if (!deal()!.linkedContacts?.length) {
                <div class="tab-empty">
                  <mat-icon>people_outline</mat-icon>
                  <span>{{ 'detail.contacts.noContacts' | transloco }}</span>
                </div>
              } @else {
                <mat-list>
                  @for (contact of deal()!.linkedContacts; track contact.id) {
                    <mat-list-item>
                      <mat-icon matListItemIcon>person</mat-icon>
                      <a matListItemTitle [routerLink]="['/contacts', contact.id]">
                        {{ contact.name }}
                      </a>
                      <button mat-icon-button matListItemMeta
                              *appHasPermission="'Deal:Edit'"
                              aria-label="Unlink contact"
                              (click)="unlinkContact(contact)">
                        <mat-icon>link_off</mat-icon>
                      </button>
                    </mat-list-item>
                  }
                </mat-list>
              }
            </div>
          </ng-template>

          <!-- Tab 2: Products -->
          <ng-template>
            <div class="linked-entity-tab">
              <div class="tab-header">
                <span class="tab-count">
                  {{ 'detail.products.count' | transloco: { count: deal()!.linkedProducts?.length || 0 } }}
                  @if (getProductsTotal() > 0) {
                    &middot; {{ 'detail.products.total' | transloco }}: {{ formatValue(getProductsTotal()) }}
                  }
                </span>
                <button mat-stroked-button
                        *appHasPermission="'Deal:Edit'"
                        (click)="toggleProductSearch()">
                  <mat-icon>{{ showProductSearch() ? 'close' : 'add_shopping_cart' }}</mat-icon>
                  {{ showProductSearch() ? ('common.cancel' | transloco) : ('detail.products.linkProduct' | transloco) }}
                </button>
              </div>

              <!-- Product search -->
              @if (showProductSearch()) {
                <div class="link-search-panel">
                  <mat-form-field appearance="outline" class="search-field">
                    <mat-label>{{ 'detail.products.searchProducts' | transloco }}</mat-label>
                    <input matInput
                           [value]="productSearchTerm()"
                           (input)="onProductSearchInput($any($event.target).value)"
                           [placeholder]="'detail.products.searchPlaceholder' | transloco">
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>

                  <div class="link-product-options">
                    <mat-form-field appearance="outline" class="quantity-field">
                      <mat-label>{{ 'detail.products.quantity' | transloco }}</mat-label>
                      <input matInput type="number"
                             [ngModel]="linkProductQuantity()"
                             (ngModelChange)="linkProductQuantity.set($event)"
                             min="1">
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="price-field">
                      <mat-label>{{ 'detail.products.unitPriceOverride' | transloco }}</mat-label>
                      <input matInput type="number"
                             [ngModel]="linkProductUnitPrice()"
                             (ngModelChange)="linkProductUnitPrice.set($event)"
                             [placeholder]="'detail.products.useProductDefault' | transloco">
                    </mat-form-field>
                  </div>

                  @if (productSearchLoading()) {
                    <div class="search-loading">
                      <mat-spinner diameter="24"></mat-spinner>
                    </div>
                  }
                  @if (productSearchResults().length > 0) {
                    <mat-list class="search-results">
                      @for (product of productSearchResults(); track product.id) {
                        <mat-list-item class="search-result-item" (click)="linkProduct(product)">
                          <mat-icon matListItemIcon>inventory_2</mat-icon>
                          <span matListItemTitle>{{ product.name }}</span>
                          <span matListItemLine>
                            {{ formatValue(product.unitPrice) }}
                            @if (product.sku) { &middot; SKU: {{ product.sku }} }
                          </span>
                          <button mat-icon-button matListItemMeta aria-label="Link product">
                            <mat-icon>add_link</mat-icon>
                          </button>
                        </mat-list-item>
                      }
                    </mat-list>
                  }
                </div>
              }

              <!-- Linked products list -->
              @if (!deal()!.linkedProducts?.length) {
                <div class="tab-empty">
                  <mat-icon>inventory_2</mat-icon>
                  <span>{{ 'detail.products.noProducts' | transloco }}</span>
                </div>
              } @else {
                <div class="products-table">
                  <div class="products-header">
                    <span class="product-col-name">{{ 'detail.products.columnProduct' | transloco }}</span>
                    <span class="product-col-qty">{{ 'detail.products.columnQty' | transloco }}</span>
                    <span class="product-col-price">{{ 'detail.products.columnUnitPrice' | transloco }}</span>
                    <span class="product-col-subtotal">{{ 'detail.products.columnSubtotal' | transloco }}</span>
                    <span class="product-col-actions"></span>
                  </div>
                  @for (product of deal()!.linkedProducts; track product.id) {
                    <div class="products-row">
                      <span class="product-col-name">
                        <a [routerLink]="['/products', product.id]">{{ product.name }}</a>
                      </span>
                      <span class="product-col-qty">{{ product.quantity }}</span>
                      <span class="product-col-price">{{ formatValue(product.unitPrice) }}</span>
                      <span class="product-col-subtotal">{{ formatValue((product.unitPrice ?? 0) * product.quantity) }}</span>
                      <span class="product-col-actions">
                        <button mat-icon-button
                                *appHasPermission="'Deal:Edit'"
                                aria-label="Unlink product"
                                (click)="unlinkProduct(product)">
                          <mat-icon>link_off</mat-icon>
                        </button>
                      </span>
                    </div>
                  }
                  <div class="products-footer">
                    <span class="product-col-name"><strong>{{ 'detail.products.total' | transloco }}</strong></span>
                    <span class="product-col-qty"></span>
                    <span class="product-col-price"></span>
                    <span class="product-col-subtotal"><strong>{{ formatValue(getProductsTotal()) }}</strong></span>
                    <span class="product-col-actions"></span>
                  </div>
                </div>
              }
            </div>
          </ng-template>

          <!-- Tab 3: Activities -->
          <ng-template>
            @if (activitiesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedActivities().length === 0) {
              <div class="tab-empty">
                <mat-icon>task_alt</mat-icon>
                <span>{{ 'detail.activities.noActivities' | transloco }}</span>
                <a mat-stroked-button routerLink="/activities/new">{{ 'detail.activities.createActivity' | transloco }}</a>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'detail.activities.columnSubject' | transloco }}</th>
                    <th>{{ 'detail.activities.columnType' | transloco }}</th>
                    <th>{{ 'detail.activities.columnStatus' | transloco }}</th>
                    <th>{{ 'detail.activities.columnPriority' | transloco }}</th>
                    <th>{{ 'detail.activities.columnDueDate' | transloco }}</th>
                    <th>{{ 'detail.activities.columnAssignedTo' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (activity of linkedActivities(); track activity.id) {
                    <tr>
                      <td><a [routerLink]="['/activities', activity.id]">{{ activity.subject }}</a></td>
                      <td>{{ activity.type }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getStatusColor(activity.status) + '22'"
                                    [style.color]="getStatusColor(activity.status)">
                            {{ activity.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getPriorityColor(activity.priority) + '22'"
                                    [style.color]="getPriorityColor(activity.priority)">
                            {{ activity.priority }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td class="text-nowrap">{{ activity.dueDate ? (activity.dueDate | date:'mediumDate') : '-' }}</td>
                      <td>{{ activity.assignedToName || '-' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Tab 4: Quotes -->
          <ng-template>
            @if (quotesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (linkedQuotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>request_quote</mat-icon>
                <span>{{ 'detail.quotes.noQuotes' | transloco }}</span>
              </div>
            } @else {
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'detail.quotes.columnQuoteNumber' | transloco }}</th>
                    <th>{{ 'detail.quotes.columnTitle' | transloco }}</th>
                    <th>{{ 'detail.quotes.columnStatus' | transloco }}</th>
                    <th>{{ 'detail.quotes.columnGrandTotal' | transloco }}</th>
                    <th>{{ 'detail.quotes.columnVersion' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (quote of linkedQuotes(); track quote.id) {
                    <tr>
                      <td><a [routerLink]="['/quotes', quote.id]">{{ quote.quoteNumber }}</a></td>
                      <td>{{ quote.title }}</td>
                      <td>
                        <mat-chip-set>
                          <mat-chip [style.--mdc-chip-elevated-container-color]="getQuoteStatusColor(quote.status) + '22'"
                                    [style.color]="getQuoteStatusColor(quote.status)">
                            {{ quote.status }}
                          </mat-chip>
                        </mat-chip-set>
                      </td>
                      <td>{{ formatQuoteCurrency(quote.grandTotal) }}</td>
                      <td>v{{ quote.versionNumber }}</td>
                    </tr>
                  }
                </tbody>
              </table>
              <div class="table-footer-link">
                <a mat-button color="primary" [routerLink]="['/quotes']" [queryParams]="{ dealId: deal()?.id }">
                  {{ 'detail.quotes.viewAllQuotes' | transloco }}
                </a>
              </div>
            }
          </ng-template>

          <!-- Tab 5: Timeline -->
          <ng-template>
            <app-entity-timeline
              [entries]="timelineEntries()"
              [isLoading]="timelineLoading()" />
          </ng-template>

          <!-- Tab 6: Notes -->
          <ng-template>
            @if (notesLoading()) {
              <div class="tab-loading">
                <mat-spinner diameter="32"></mat-spinner>
              </div>
            } @else if (dealNotes().length === 0) {
              <div class="tab-empty">
                <mat-icon>note</mat-icon>
                <span>{{ 'detail.notes.noNotes' | transloco }}</span>
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Deal', entityId: deal()?.id, entityName: deal()?.title }">
                  {{ 'detail.notes.addNote' | transloco }}
                </a>
              </div>
            } @else {
              <div class="tab-actions">
                <a mat-stroked-button
                   [routerLink]="['/notes/new']"
                   [queryParams]="{ entityType: 'Deal', entityId: deal()?.id, entityName: deal()?.title }">
                  <mat-icon>add</mat-icon> {{ 'detail.notes.addNote' | transloco }}
                </a>
              </div>
              <table class="entity-table">
                <thead>
                  <tr>
                    <th>{{ 'detail.notes.columnTitle' | transloco }}</th>
                    <th>{{ 'detail.notes.columnPreview' | transloco }}</th>
                    <th>{{ 'detail.notes.columnAuthor' | transloco }}</th>
                    <th>{{ 'detail.notes.columnDate' | transloco }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (note of dealNotes(); track note.id) {
                    <tr>
                      <td><a [routerLink]="['/notes', note.id]">{{ note.title }}</a></td>
                      <td class="text-preview">{{ note.plainTextBody }}</td>
                      <td>{{ note.authorName || '-' }}</td>
                      <td class="text-nowrap">{{ formatNoteDate(note.createdAt) }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            }
          </ng-template>

          <!-- Tab 7: Attachments -->
          <ng-template>
            <app-entity-attachments [entityType]="'deal'" [entityId]="deal()?.id ?? ''" />
          </ng-template>
        </app-related-entity-tabs>
      </div>

      <!-- Timeline sidebar -->
      <div class="detail-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-card__header">
            <mat-icon>timeline</mat-icon>
            <h3>{{ 'detail.timeline' | transloco }}</h3>
          </div>
          <div class="sidebar-card__body">
            <app-entity-timeline
              [entries]="timelineEntries()"
              [isLoading]="timelineLoading()" />
          </div>
        </div>
      </div>
    </div>
  </div>
} @else {
  <div class="detail-not-found">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ 'detail.notFound' | transloco }}</h2>
    <a mat-stroked-button routerLink="/deals">{{ 'detail.backToDeals' | transloco }}</a>
  </div>
}
