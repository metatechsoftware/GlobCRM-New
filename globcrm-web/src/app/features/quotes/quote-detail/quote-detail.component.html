@if (isLoading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48"></mat-spinner>
  </div>
} @else if (quote()) {
  <div class="detail-page">
    <!-- Hero Card -->
    <div class="quote-hero">
      <div class="hero-accent"></div>

      <!-- Navigation bar -->
      <div class="hero-nav">
        <a mat-icon-button routerLink="/quotes" [attr.aria-label]="'quotes.detail.aria.backToQuotes' | transloco">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <div class="hero-actions">
          <button mat-stroked-button
                  routerLink="/quotes/{{ quote()!.id }}/edit"
                  *appHasPermission="'Quote:Update'">
            <mat-icon>edit</mat-icon> {{ 'quotes.detail.actions.edit' | transloco }}
          </button>
          <button mat-stroked-button color="warn"
                  *appHasPermission="'Quote:Delete'"
                  (click)="onDelete()">
            <mat-icon>delete</mat-icon> {{ 'quotes.detail.actions.delete' | transloco }}
          </button>

          <!-- PDF Template Selector + Generate -->
          <div class="pdf-actions">
            <mat-form-field appearance="outline" class="template-selector">
              <mat-select
                [value]="selectedTemplateId()"
                (selectionChange)="onTemplateChange($event.value)"
                [placeholder]="'quotes.detail.actions.selectTemplate' | transloco"
              >
                <mat-option [value]="null">
                  {{ 'quotes.detail.actions.builtInTemplate' | transloco }}
                </mat-option>
                @for (tpl of availableTemplates(); track tpl.id) {
                  <mat-option [value]="tpl.id">
                    {{ tpl.name }}
                    @if (tpl.isDefault) {
                      ({{ 'quoteTemplates.list.default' | transloco }})
                    }
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
            <button mat-stroked-button (click)="onGeneratePdf()"
                    [disabled]="pdfGenerating()">
              @if (pdfGenerating()) {
                <mat-spinner diameter="18"></mat-spinner>
              } @else {
                <mat-icon>picture_as_pdf</mat-icon>
              }
              {{ 'quotes.detail.actions.generatePdf' | transloco }}
            </button>
          </div>

          <button mat-stroked-button (click)="onCreateNewVersion()"
                  *appHasPermission="'Quote:Create'">
            <mat-icon>content_copy</mat-icon> {{ 'quotes.detail.actions.newVersion' | transloco }}
          </button>
          <a mat-stroked-button routerLink="/quote-templates" class="manage-templates-link">
            <mat-icon>description</mat-icon> {{ 'quotes.detail.actions.manageTemplates' | transloco }}
          </a>
        </div>
      </div>

      <!-- Profile section -->
      <div class="hero-profile">
        <div class="hero-avatar">
          <mat-icon>request_quote</mat-icon>
        </div>
        <div class="hero-info">
          <div class="quote-number">
            {{ quote()!.quoteNumber }}
            <span class="badge badge--secondary">v{{ quote()!.versionNumber }}</span>
          </div>
          <h1 class="hero-name">{{ quote()!.title }}</h1>
          <div class="hero-badges">
            <span class="badge"
                  [style.background-color]="getStatusColor(quote()!.status)"
                  [style.color]="'#fff'">
              {{ getStatusLabel(quote()!.status) }}
            </span>
            <span class="badge badge--success">
              <mat-icon>payments</mat-icon>
              {{ quote()!.grandTotal | currency:'USD':'symbol':'1.2-2' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Meta info pills -->
      <hr class="hero-divider">
      <div class="hero-meta">
        <span class="meta-item">
          <mat-icon>event</mat-icon>
          {{ quote()!.issueDate | date:'mediumDate' }}
        </span>
        @if (quote()!.expiryDate) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>event_busy</mat-icon>
            {{ 'quotes.detail.fields.expires' | transloco }} {{ quote()!.expiryDate | date:'mediumDate' }}
          </span>
        }
        @if (quote()!.contactName) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>person</mat-icon>
            {{ quote()!.contactName }}
          </span>
        }
        @if (quote()!.companyName) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>business</mat-icon>
            {{ quote()!.companyName }}
          </span>
        }
        @if (quote()!.dealTitle) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>handshake</mat-icon>
            {{ quote()!.dealTitle }}
          </span>
        }
        @if (quote()!.ownerName) {
          <span class="meta-separator"></span>
          <span class="meta-item">
            <mat-icon>assignment_ind</mat-icon>
            {{ quote()!.ownerName }}
          </span>
        }
      </div>

      <!-- Status workflow transitions -->
      @if (allowedTransitions().length > 0) {
        <hr class="hero-divider">
        <div class="status-transitions">
          <span class="transition-label">{{ 'quotes.detail.actions.moveTo' | transloco }}</span>
          @for (transition of allowedTransitions(); track transition) {
            <button mat-stroked-button class="transition-btn"
                    color="primary"
                    (click)="onTransitionStatus(transition)">
              {{ getTransitionLabel(transition) }}
            </button>
          }
        </div>
      }
    </div>

    <!-- Main content: Tabs left, Info sidebar right -->
    <div class="detail-content">
      <div class="detail-main">
        <mat-tab-group animationDuration="200ms" [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabSelected($event)">
          <!-- Summary Tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon class="tab-icon">dashboard</mat-icon>
              {{ 'quotes.detail.tabs.summary' | transloco }}
            </ng-template>
            <div class="tab-body">
              <app-entity-summary-tab
                entityType="Quote"
                [data]="summaryData()"
                [loading]="summaryLoading()"
                (associationClicked)="onAssociationClicked($event)"
                (addNote)="onSummaryAddNote()"
                (logActivity)="onSummaryLogActivity()" />
            </div>
          </mat-tab>

          <!-- Line Items Tab -->
          <mat-tab [label]="'quotes.detail.tabs.lineItems' | transloco">
            <div class="tab-body">
              @if (quote()!.lineItems.length === 0) {
                <div class="tab-empty">
                  <mat-icon>receipt_long</mat-icon>
                  <span>{{ 'quotes.detail.lineItems.noLineItems' | transloco }}</span>
                </div>
              } @else {
                <table class="line-items-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>{{ 'quotes.detail.lineItems.description' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.qty' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.unitPrice' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.discountPercent' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.taxPercent' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.lineTotal' | transloco }}</th>
                      <th class="num-col">{{ 'quotes.detail.lineItems.netTotal' | transloco }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of quote()!.lineItems; track item.id; let i = $index) {
                      <tr>
                        <td>{{ i + 1 }}</td>
                        <td>{{ item.description }}</td>
                        <td class="num-col">{{ item.quantity | number:'1.0-2' }}</td>
                        <td class="num-col">{{ item.unitPrice | currency:'USD':'symbol':'1.2-2' }}</td>
                        <td class="num-col">{{ item.discountPercent | number:'1.0-2' }}%</td>
                        <td class="num-col">{{ item.taxPercent | number:'1.0-2' }}%</td>
                        <td class="num-col">{{ item.lineTotal | currency:'USD':'symbol':'1.2-2' }}</td>
                        <td class="num-col">{{ item.netTotal | currency:'USD':'symbol':'1.2-2' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>

                <div class="totals-summary">
                  <div class="totals-grid">
                    <span class="total-label">{{ 'quotes.detail.lineItems.subtotal' | transloco }}</span>
                    <span class="total-value">{{ subtotal() | currency:'USD':'symbol':'1.2-2' }}</span>
                    <span class="total-label">{{ 'quotes.detail.lineItems.discountTotal' | transloco }}</span>
                    <span class="total-value">-{{ discountTotal() | currency:'USD':'symbol':'1.2-2' }}</span>
                    <span class="total-label">{{ 'quotes.detail.lineItems.taxTotal' | transloco }}</span>
                    <span class="total-value">{{ taxTotal() | currency:'USD':'symbol':'1.2-2' }}</span>
                    <div class="grand-total">
                      <span class="total-label">{{ 'quotes.detail.fields.grandTotal' | transloco }}</span>
                    </div>
                    <div class="grand-total">
                      <span class="total-value">{{ quote()!.grandTotal | currency:'USD':'symbol':'1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          </mat-tab>

          <!-- Details Tab -->
          <mat-tab [label]="'quotes.detail.tabs.details' | transloco">
            <div class="tab-body">
              @if (!quote()!.description && !quote()!.notes) {
                <div class="tab-empty">
                  <mat-icon>description</mat-icon>
                  <span>{{ 'quotes.detail.empty.noDetails' | transloco }}</span>
                </div>
              } @else {
                @if (quote()!.description) {
                  <div class="detail-section">
                    <div class="detail-section__header">
                      <mat-icon>description</mat-icon>
                      <h3>{{ 'quotes.detail.sections.description' | transloco }}</h3>
                    </div>
                    <p class="detail-section__text">{{ quote()!.description }}</p>
                  </div>
                }
                @if (quote()!.notes) {
                  <div class="detail-section">
                    <div class="detail-section__header">
                      <mat-icon>note</mat-icon>
                      <h3>{{ 'quotes.detail.sections.termsNotes' | transloco }}</h3>
                    </div>
                    <p class="detail-section__text">{{ quote()!.notes }}</p>
                  </div>
                }
              }
            </div>
          </mat-tab>

          <!-- Versions Tab -->
          <mat-tab [label]="('quotes.detail.tabs.versions' | transloco) + ' (' + quote()!.versions.length + ')'">
            <div class="tab-body">
              @if (quote()!.versions.length === 0) {
                <div class="tab-empty">
                  <mat-icon>history</mat-icon>
                  <span>{{ 'quotes.detail.empty.noVersionHistory' | transloco }}</span>
                </div>
              } @else {
                <ul class="versions-list">
                  @for (version of quote()!.versions; track version.id) {
                    <li class="version-item">
                      <span class="version-num"
                            [class.current]="version.id === quote()!.id">
                        v{{ version.versionNumber }}
                      </span>
                      <div class="version-info">
                        <span class="badge"
                              [style.background-color]="getStatusColor(version.status)"
                              [style.color]="'#fff'"
                              style="font-size: 11px; padding: 2px 8px;">
                          {{ getStatusLabel(version.status) }}
                        </span>
                        <span class="version-date">{{ version.createdAt | date:'medium' }}</span>
                      </div>
                      @if (version.id !== quote()!.id) {
                        <a mat-stroked-button [routerLink]="['/quotes', version.id]">
                          {{ 'quotes.detail.versions.view' | transloco }}
                        </a>
                      } @else {
                        <span class="version-current-label">{{ 'quotes.detail.versions.current' | transloco }}</span>
                      }
                    </li>
                  }
                </ul>
              }
            </div>
          </mat-tab>

          <!-- Timeline Tab -->
          <mat-tab [label]="'quotes.detail.tabs.timeline' | transloco">
            <div class="tab-body">
              @if (timelineLoading()) {
                <div class="tab-loading">
                  <mat-spinner diameter="32"></mat-spinner>
                </div>
              } @else {
                <app-entity-timeline [entries]="timelineEntries()" />
              }
            </div>
          </mat-tab>

          <!-- Notes Tab -->
          <mat-tab [label]="'quotes.detail.tabs.notes' | transloco">
            <div class="tab-body">
              @if (notesLoading()) {
                <div class="tab-loading">
                  <mat-spinner diameter="32"></mat-spinner>
                </div>
              } @else if (quoteNotes().length === 0) {
                <div class="tab-empty">
                  <mat-icon>note</mat-icon>
                  <span>{{ 'quotes.detail.notes.noNotes' | transloco }}</span>
                  <a mat-stroked-button
                     [routerLink]="['/notes/new']"
                     [queryParams]="{ entityType: 'Quote', entityId: quote()?.id, entityName: quote()?.title }">
                    {{ 'quotes.detail.notes.addNote' | transloco }}
                  </a>
                </div>
              } @else {
                <div class="tab-actions">
                  <a mat-stroked-button
                     [routerLink]="['/notes/new']"
                     [queryParams]="{ entityType: 'Quote', entityId: quote()?.id, entityName: quote()?.title }">
                    <mat-icon>add</mat-icon> Add Note
                  </a>
                </div>
                <div class="notes-list">
                  @for (note of quoteNotes(); track note.id) {
                    <div class="note-item">
                      <div class="note-content">
                        <a [routerLink]="['/notes', note.id]" class="note-title">{{ note.title }}</a>
                        <div class="note-preview">{{ note.plainTextBody }}</div>
                      </div>
                      <div class="note-meta">
                        {{ note.authorName }} &middot; {{ formatNoteDate(note.createdAt) }}
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </mat-tab>

          <!-- Attachments Tab -->
          <mat-tab [label]="'quotes.detail.tabs.attachments' | transloco">
            <div class="tab-body">
              <app-entity-attachments [entityType]="'quote'" [entityId]="quote()?.id ?? ''" />
            </div>
          </mat-tab>
        </mat-tab-group>
      </div>

      <!-- Info Sidebar -->
      <div class="detail-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-card__header">
            <mat-icon>info</mat-icon>
            <h3>{{ 'quotes.detail.sections.quoteInfo' | transloco }}</h3>
          </div>
          <div class="sidebar-card__body">
            <div class="sidebar-field sidebar-field--prominent">
              <span class="sidebar-label">{{ 'quotes.detail.fields.grandTotal' | transloco }}</span>
              <span class="sidebar-value sidebar-value--grand-total">
                {{ quote()!.grandTotal | currency:'USD':'symbol':'1.2-2' }}
              </span>
            </div>

            <div class="sidebar-field">
              <span class="sidebar-label">{{ 'quotes.detail.fields.status' | transloco }}</span>
              <span class="badge"
                    [style.background-color]="getStatusColor(quote()!.status)"
                    [style.color]="'#fff'">
                {{ getStatusLabel(quote()!.status) }}
              </span>
            </div>

            @if (quote()!.contactName) {
              <div class="sidebar-field">
                <span class="sidebar-label">{{ 'quotes.detail.fields.contact' | transloco }}</span>
                <span class="sidebar-value">
                  <span class="sidebar-value">{{ quote()!.contactName }}</span>
                </span>
              </div>
            }

            @if (quote()!.companyName) {
              <div class="sidebar-field">
                <span class="sidebar-label">{{ 'quotes.detail.fields.company' | transloco }}</span>
                <span class="sidebar-value">{{ quote()!.companyName }}</span>
              </div>
            }

            @if (quote()!.dealTitle) {
              <div class="sidebar-field">
                <span class="sidebar-label">{{ 'quotes.detail.fields.deal' | transloco }}</span>
                <span class="sidebar-value">{{ quote()!.dealTitle }}</span>
              </div>
            }

            @if (quote()!.ownerName) {
              <div class="sidebar-field">
                <span class="sidebar-label">{{ 'quotes.detail.fields.owner' | transloco }}</span>
                <span class="sidebar-value">{{ quote()!.ownerName }}</span>
              </div>
            }

            <div class="sidebar-field">
              <span class="sidebar-label">{{ 'quotes.detail.fields.issueDate' | transloco }}</span>
              <span class="sidebar-value">{{ quote()!.issueDate | date:'mediumDate' }}</span>
            </div>

            <div class="sidebar-field">
              <span class="sidebar-label">{{ 'quotes.detail.fields.expiryDate' | transloco }}</span>
              <span class="sidebar-value">{{ quote()!.expiryDate ? (quote()!.expiryDate | date:'mediumDate') : ('quotes.detail.empty.notSet' | transloco) }}</span>
            </div>

            <div class="sidebar-field">
              <span class="sidebar-label">{{ 'quotes.detail.fields.version' | transloco }}</span>
              <span class="sidebar-value">v{{ quote()!.versionNumber }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
} @else {
  <div class="detail-not-found">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ 'quotes.detail.notFound' | transloco }}</h2>
    <a mat-stroked-button routerLink="/quotes">{{ 'quotes.detail.backToQuotes' | transloco }}</a>
  </div>
}
