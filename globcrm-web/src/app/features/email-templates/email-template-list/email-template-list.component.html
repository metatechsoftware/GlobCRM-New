<div class="template-list-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Email Templates</h1>
      <p class="page-tagline">Craft beautiful emails that convert</p>
    </div>
    <div class="header-right">
      <span class="template-count">{{ store.filteredTemplates().length }} templates</span>
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          placeholder="Search templates..."
          [value]="searchValue()"
          (input)="onSearchChange($any($event.target).value)"
        />
      </mat-form-field>
      <button
        mat-raised-button
        color="primary"
        *appHasPermission="'EmailTemplate:Create'"
        (click)="createTemplate()"
      >
        <mat-icon>add</mat-icon>
        Create Template
      </button>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="category-tabs">
    <div class="category-tabs__track">
      <button
        class="category-tab"
        [class.is-active]="selectedCategoryId() === null"
        (click)="onCategorySelect(null)"
      >
        All
      </button>
      @for (category of store.categories(); track category.id) {
        <button
          class="category-tab"
          [class.is-active]="selectedCategoryId() === category.id"
          (click)="onCategorySelect(category.id)"
        >
          {{ category.name }}
        </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (store.loading()) {
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading templates...</p>
    </div>
  }

  <!-- Template Grid -->
  @if (!store.loading()) {
    @if (store.filteredTemplates().length > 0) {
      <div class="template-grid">
        @for (template of store.filteredTemplates(); track template.id; let idx = $index) {
          <mat-card class="template-card" [style.--card-index]="idx">
            <div class="card-accent-top"></div>

            <!-- Thumbnail -->
            <div class="thumbnail-container" (click)="editTemplate(template)">
              <iframe
                class="thumbnail-iframe"
                [srcdoc]="(template.htmlBody || fallbackHtml) | safeHtml"
                sandbox
                scrolling="no"
                tabindex="-1"
              ></iframe>
              <div class="thumbnail-overlay"></div>

              <!-- Floating Action Bar -->
              <div class="thumbnail-actions">
                <button
                  mat-icon-button
                  *appHasPermission="'EmailTemplate:Edit'"
                  matTooltip="Edit"
                  aria-label="Edit template"
                  (click)="$event.stopPropagation(); editTemplate(template)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  *appHasPermission="'EmailTemplate:Create'"
                  matTooltip="Clone"
                  aria-label="Clone template"
                  (click)="$event.stopPropagation(); cloneTemplate(template)"
                >
                  <mat-icon>content_copy</mat-icon>
                </button>
                <button
                  mat-icon-button
                  *appHasPermission="'EmailTemplate:Delete'"
                  matTooltip="Delete"
                  aria-label="Delete template"
                  color="warn"
                  (click)="$event.stopPropagation(); deleteTemplate(template)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <!-- Info Section -->
            <mat-card-content class="template-info">
              <h3 class="template-name">{{ template.name }}</h3>
              @if (template.subject) {
                <p class="template-subject">{{ template.subject }}</p>
              }
              <div class="template-meta">
                @if (template.categoryName) {
                  <span class="category-chip">{{ template.categoryName }}</span>
                }
                <span class="share-badge" [class.shared]="template.isShared">
                  {{ template.isShared ? 'Shared' : 'Personal' }}
                </span>
                @if (template.isSeedData) {
                  <span class="starter-badge">Starter</span>
                }
                @if (template.isShared && template.ownerName) {
                  <span class="owner-label">by {{ template.ownerName }}</span>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    } @else {
      <!-- Empty State -->
      <div class="empty-state">
        <div class="empty-icon-wrap">
          <mat-icon class="empty-icon">drafts</mat-icon>
        </div>
        <h2>No email templates yet</h2>
        <p>Create your first email template to start sending personalized emails.</p>
        <button
          mat-raised-button
          color="primary"
          *appHasPermission="'EmailTemplate:Create'"
          (click)="createTemplate()"
        >
          <mat-icon>add</mat-icon>
          Create your first template
        </button>
      </div>
    }
  }
</div>
