<div class="summary-container">
  <!-- Quick Action Bar - pinned at top per user decision -->
  <app-quick-action-bar
    [showSendEmail]="showSendEmail()"
    (addNote)="addNote.emit()"
    (logActivity)="logActivity.emit()"
    (sendEmail)="sendEmail.emit()" />

  @if (loading()) {
    <div class="summary-skeleton">
      <div class="skeleton-card skeleton-wide">
        <div class="skeleton-title"></div>
        <div class="skeleton-row"></div>
        <div class="skeleton-row"></div>
        <div class="skeleton-row"></div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton-title"></div>
        <div class="skeleton-row"></div>
        <div class="skeleton-row"></div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton-title"></div>
        <div class="skeleton-row"></div>
        <div class="skeleton-row"></div>
      </div>
    </div>
  } @else if (data()) {
    <div class="summary-grid">
      <!-- ROW 1: Key Properties Card -->
      <div class="summary-card key-properties-card">
        <h3 class="card-title">
          <span class="card-title-icon"><mat-icon>info</mat-icon></span>
          {{ 'common.summary.keyProperties' | transloco }}
        </h3>
        <div class="properties-grid">
          @switch (entityType()) {
            @case ('Company') {
              @if (companyData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.name' | transloco }}</span>
                  <span class="property-value">{{ d.name }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.industry' | transloco }}</span>
                  <span class="property-value">{{ d.industry || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.phone' | transloco }}</span>
                  <span class="property-value">{{ d.phone || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.email' | transloco }}</span>
                  <span class="property-value">{{ d.email || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.website' | transloco }}</span>
                  <span class="property-value">{{ d.website || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.owner' | transloco }}</span>
                  <span class="property-value">{{ d.ownerName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.location' | transloco }}</span>
                  <span class="property-value">{{ d.location || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.size' | transloco }}</span>
                  <span class="property-value">{{ d.size || '---' }}</span>
                </div>
              }
            }
            @case ('Contact') {
              @if (contactData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.fullName' | transloco }}</span>
                  <span class="property-value">{{ d.fullName }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.email' | transloco }}</span>
                  <span class="property-value">{{ d.email || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.phone' | transloco }}</span>
                  <span class="property-value">{{ d.phone || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.jobTitle' | transloco }}</span>
                  <span class="property-value">{{ d.jobTitle || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.company' | transloco }}</span>
                  <span class="property-value">{{ d.companyName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.owner' | transloco }}</span>
                  <span class="property-value">{{ d.ownerName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.department' | transloco }}</span>
                  <span class="property-value">{{ d.department || '---' }}</span>
                </div>
              }
            }
            @case ('Deal') {
              @if (dealData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.title' | transloco }}</span>
                  <span class="property-value">{{ d.title }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.value' | transloco }}</span>
                  <span class="property-value">{{ d.value | currency:'USD':'symbol':'1.0-0' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.probability' | transloco }}</span>
                  <span class="property-value">{{ d.probability !== null ? (d.probability | percent:'1.0-0') : '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.expectedClose' | transloco }}</span>
                  <span class="property-value">{{ d.expectedCloseDate ? (d.expectedCloseDate | date:'mediumDate') : '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.pipeline' | transloco }}</span>
                  <span class="property-value">{{ d.pipelineName }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.stage' | transloco }}</span>
                  <span class="property-value">{{ d.stageName }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.company' | transloco }}</span>
                  <span class="property-value">{{ d.companyName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.owner' | transloco }}</span>
                  <span class="property-value">{{ d.ownerName || '---' }}</span>
                </div>
              }
            }
            @case ('Lead') {
              @if (leadData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.fullName' | transloco }}</span>
                  <span class="property-value">{{ d.fullName }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.email' | transloco }}</span>
                  <span class="property-value">{{ d.email || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.phone' | transloco }}</span>
                  <span class="property-value">{{ d.phone || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.company' | transloco }}</span>
                  <span class="property-value">{{ d.companyName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.source' | transloco }}</span>
                  <span class="property-value">{{ d.sourceName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.temperature' | transloco }}</span>
                  <span class="property-value temperature" [attr.data-temp]="d.temperature">{{ d.temperature }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.owner' | transloco }}</span>
                  <span class="property-value">{{ d.ownerName || '---' }}</span>
                </div>
              }
            }
            @case ('Quote') {
              @if (quoteData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.quoteNumber' | transloco }}</span>
                  <span class="property-value">{{ d.quoteNumber }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.title' | transloco }}</span>
                  <span class="property-value">{{ d.title }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.status' | transloco }}</span>
                  <span class="property-value">{{ d.status }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.grandTotal' | transloco }}</span>
                  <span class="property-value">{{ d.grandTotal | currency:'USD':'symbol':'1.2-2' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.contact' | transloco }}</span>
                  <span class="property-value">{{ d.contactName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.company' | transloco }}</span>
                  <span class="property-value">{{ d.companyName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.issueDate' | transloco }}</span>
                  <span class="property-value">{{ d.issueDate | date:'mediumDate' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.expiryDate' | transloco }}</span>
                  <span class="property-value">{{ d.expiryDate ? (d.expiryDate | date:'mediumDate') : '---' }}</span>
                </div>
              }
            }
            @case ('Request') {
              @if (requestData(); as d) {
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.subject' | transloco }}</span>
                  <span class="property-value">{{ d.subject }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.status' | transloco }}</span>
                  <span class="property-value">{{ d.status }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.priority' | transloco }}</span>
                  <span class="property-value">{{ d.priority }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.category' | transloco }}</span>
                  <span class="property-value">{{ d.category || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.contact' | transloco }}</span>
                  <span class="property-value">{{ d.contactName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.company' | transloco }}</span>
                  <span class="property-value">{{ d.companyName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.owner' | transloco }}</span>
                  <span class="property-value">{{ d.ownerName || '---' }}</span>
                </div>
                <div class="property">
                  <span class="property-label">{{ 'common.summaryTab.fields.assignedTo' | transloco }}</span>
                  <span class="property-value">{{ d.assignedToName || '---' }}</span>
                </div>
              }
            }
          }
        </div>
      </div>

      <!-- Stage/Status Card (entity-specific) -->
      @switch (entityType()) {
        @case ('Deal') {
          <div class="summary-card stage-card">
            <h3 class="card-title">
              <span class="card-title-icon"><mat-icon>linear_scale</mat-icon></span>
              {{ 'common.summary.pipelineProgress' | transloco }}
            </h3>
            @if (dealData(); as d) {
              <div class="stage-label">
                {{ d.pipelineName }}
                <span class="current-stage-badge">{{ d.stageName }}</span>
              </div>
              <app-mini-stage-bar
                [stages]="dealStages()"
                [currentStageId]="dealCurrentStage().id"
                [currentSortOrder]="dealCurrentStage().sortOrder" />
              <div class="stage-legend">
                @for (stage of d.stages; track stage.id) {
                  <span class="legend-item" [class.active]="stage.isCurrent">
                    <span class="legend-dot" [style.background-color]="stage.color"></span>
                    {{ stage.name }}
                  </span>
                }
              </div>
            }
          </div>
        }
        @case ('Lead') {
          <div class="summary-card stage-card">
            <h3 class="card-title">
              <span class="card-title-icon"><mat-icon>trending_up</mat-icon></span>
              {{ 'common.summary.leadProgress' | transloco }}
            </h3>
            @if (leadData(); as d) {
              @if (leadTerminalStage(); as terminal) {
                <div class="stage-label terminal-stage">
                  <mat-icon>{{ terminal.name === 'Converted' ? 'check_circle' : 'cancel' }}</mat-icon>
                  {{ terminal.name }}
                </div>
              } @else {
                <div class="stage-label">{{ 'common.summary.currentStage' | transloco }}</div>
              }
              <app-mini-stage-bar
                [stages]="leadStages()"
                [currentStageId]="leadCurrentStage().id"
                [currentSortOrder]="leadCurrentStage().sortOrder" />
              <div class="stage-legend">
                @for (stage of d.stages; track stage.id) {
                  <span class="legend-item" [class.active]="stage.isCurrent" [class.terminal]="stage.isTerminal">
                    <span class="legend-dot" [style.background-color]="stage.color"></span>
                    {{ stage.name }}
                  </span>
                }
              </div>
            }
          </div>
        }
        @case ('Quote') {
          <div class="summary-card status-card">
            <h3 class="card-title">
              <span class="card-title-icon"><mat-icon>receipt_long</mat-icon></span>
              {{ 'common.summaryTab.fields.status' | transloco }}
            </h3>
            @if (quoteData(); as d) {
              <div class="status-chips">
                <mat-chip-set>
                  <mat-chip [highlighted]="true">
                    <mat-icon matChipAvatar>receipt_long</mat-icon>
                    {{ d.status }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            }
          </div>
        }
        @case ('Request') {
          <div class="summary-card status-card">
            <h3 class="card-title">
              <span class="card-title-icon"><mat-icon>support_agent</mat-icon></span>
              {{ 'common.summaryTab.fields.status' | transloco }}
            </h3>
            @if (requestData(); as d) {
              <div class="status-chips">
                <mat-chip-set>
                  <mat-chip [highlighted]="true">
                    <mat-icon matChipAvatar>info</mat-icon>
                    {{ d.status }}
                  </mat-chip>
                  <mat-chip>
                    <mat-icon matChipAvatar>priority_high</mat-icon>
                    {{ d.priority }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            }
          </div>
        }
      }

      <!-- Activities Card (hero content, full-width per user decision) -->
      <div class="summary-card activities-card full-width">
        <h3 class="card-title">
          <span class="card-title-icon"><mat-icon>task_alt</mat-icon></span>
          {{ 'common.summary.activities' | transloco }}
        </h3>

        <!-- Recent Activities Section -->
        @if (data()!.recentActivities.length > 0) {
          <div class="activities-section">
            <h4 class="section-subtitle">{{ 'common.summary.recent' | transloco }}</h4>
            @for (activity of data()!.recentActivities; track activity.id) {
              <div class="activity-row">
                <div class="activity-info">
                  <span class="activity-type-dot" [ngClass]="'type-' + getActivityTypeClass(activity.type)"></span>
                  <div class="activity-text">
                    <span class="activity-subject">{{ activity.subject }}</span>
                    <span class="activity-meta">{{ activity.type }} &middot; {{ activity.status }}</span>
                  </div>
                </div>
                <span class="activity-time">{{ getRelativeTime(activity.createdAt) }}</span>
              </div>
            }
          </div>
        }

        <!-- Upcoming Activities Section (visually distinct with accent border) -->
        @if (data()!.upcomingActivities.length > 0) {
          <div class="activities-section upcoming-section">
            <h4 class="section-subtitle">{{ 'common.summary.upcoming' | transloco }}</h4>
            @for (activity of data()!.upcomingActivities; track activity.id) {
              <div class="activity-row">
                <div class="activity-info">
                  <span class="activity-type-dot" [ngClass]="'type-' + getActivityTypeClass(activity.type)"></span>
                  <div class="activity-text">
                    <span class="activity-subject">{{ activity.subject }}</span>
                    <span class="activity-meta">{{ activity.type }} &middot; Due {{ activity.dueDate | date:'mediumDate' }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
        }

        @if (data()!.recentActivities.length === 0 && data()!.upcomingActivities.length === 0) {
          <div class="empty-state"><mat-icon>event_busy</mat-icon> {{ 'common.summary.noActivities' | transloco }}</div>
        }
      </div>

      <!-- Associations Card -->
      @if (data()!.associations.length > 0) {
        <div class="summary-card associations-card">
          <h3 class="card-title">
            <span class="card-title-icon"><mat-icon>link</mat-icon></span>
            {{ 'common.summary.associations' | transloco }}
          </h3>
          <div class="associations-grid">
            @for (assoc of data()!.associations; track assoc.entityType) {
              <div class="association-item" (click)="onAssociationClick(assoc)">
                <span class="association-icon"><mat-icon>{{ assoc.icon }}</mat-icon></span>
                <span class="association-count">{{ assoc.count }}</span>
                <span class="association-label">{{ assoc.label }}</span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Notes Preview Card -->
      <div class="summary-card notes-card">
        <h3 class="card-title">
          <span class="card-title-icon"><mat-icon>note</mat-icon></span>
          {{ 'common.summary.recentNotes' | transloco }}
        </h3>
        @if (data()!.recentNotes.length > 0) {
          @for (note of data()!.recentNotes; track note.id) {
            <div class="note-item">
              <span class="note-title">{{ note.title }}</span>
              @if (note.preview) {
                <span class="note-preview">{{ note.preview }}</span>
              }
              <span class="note-meta">{{ note.authorName }} &middot; {{ getRelativeTime(note.createdAt) }}</span>
            </div>
          }
        } @else {
          <div class="empty-state"><mat-icon>note</mat-icon> {{ 'common.summary.noNotes' | transloco }}</div>
        }
      </div>

      <!-- Meta Card (Last Contacted + Attachments Count) -->
      <div class="summary-card meta-card">
        <h3 class="card-title">
          <span class="card-title-icon"><mat-icon>insights</mat-icon></span>
          {{ 'common.summary.overview' | transloco }}
        </h3>
        <div class="meta-stats-row">
          <div class="meta-stat-block">
            <span class="meta-stat-icon">
              <mat-icon>schedule</mat-icon>
            </span>
            @if (data()!.lastContacted) {
              <span class="meta-stat-value" [title]="data()!.lastContacted | date:'full'">{{ getRelativeTime(data()!.lastContacted!) }}</span>
            } @else {
              <span class="meta-stat-value empty">{{ 'common.summary.never' | transloco }}</span>
            }
            <span class="meta-stat-label">{{ 'common.summary.lastContacted' | transloco }}</span>
          </div>
          <div class="meta-stat-block">
            <span class="meta-stat-icon icon-attachment">
              <mat-icon>attach_file</mat-icon>
            </span>
            <span class="meta-stat-value">{{ data()!.attachmentCount }}</span>
            <span class="meta-stat-label">{{ 'common.attachments.title' | transloco }}</span>
          </div>
        </div>
      </div>

      <!-- Deal Pipeline Card (Company and Contact only) -->
      @if (isCompanyOrContact() && dealPipeline()) {
        <div class="summary-card pipeline-card">
          <h3 class="card-title">
            <span class="card-title-icon"><mat-icon>trending_up</mat-icon></span>
            {{ 'common.summary.dealPipeline' | transloco }}
          </h3>
          <app-deal-pipeline-chart [pipeline]="dealPipeline()!" />
        </div>
      }

      <!-- Email Engagement Card (Contact only) -->
      @if (isContact() && emailEngagement()) {
        <div class="summary-card email-card">
          <h3 class="card-title">
            <span class="card-title-icon"><mat-icon>email</mat-icon></span>
            {{ 'common.summary.emailEngagement' | transloco }}
          </h3>
          <app-email-engagement-card [engagement]="emailEngagement()!" />
        </div>
      }
    </div>
  } @else {
    <div class="summary-error">
      <mat-icon>error_outline</mat-icon>
      <span>{{ 'common.summary.unableToLoad' | transloco }}</span>
    </div>
  }
</div>
