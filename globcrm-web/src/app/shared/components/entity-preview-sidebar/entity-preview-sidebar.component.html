<div class="preview-sidebar">
  <!-- Header -->
  <div class="preview-header">
    <div class="preview-header-left">
      @if (store.stack().length > 1) {
        <app-preview-breadcrumbs
          [stack]="store.stack()"
          (navigate)="onBreadcrumbNavigate($event)" />
      } @else {
        @if (entityConfig(); as config) {
          <span class="entity-type-badge" [style.background-color]="config.color">
            <mat-icon>{{ config.icon }}</mat-icon>
            {{ config.label }}
          </span>
        }
      }
    </div>
    <div class="preview-header-right">
      <button mat-button color="primary" (click)="store.openFullRecord()">
        <mat-icon>open_in_new</mat-icon>
        {{ 'common.preview.openFullRecord' | transloco }}
      </button>
      <button mat-icon-button class="close-btn" (click)="store.close()" [matTooltip]="'common.preview.closePreview' | transloco">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Entity name -->
  @if (store.currentData(); as data) {
    <div class="preview-entity-name">{{ data.name }}</div>
    @if (data.ownerName) {
      <div class="preview-owner">
        @if (data.ownerAvatarUrl) {
          <img [src]="data.ownerAvatarUrl" class="owner-avatar" [alt]="'common.preview.ownerAlt' | transloco" />
        } @else {
          <mat-icon class="owner-avatar-icon">account_circle</mat-icon>
        }
        <span>{{ data.ownerName }}</span>
      </div>
    }

    <!-- Quick Actions -->
    @if (showQuickActions()) {
      <div class="preview-quick-actions">
        <app-quick-action-bar
          [showSendEmail]="showSendEmail()"
          (addNote)="onQuickAction('Note')"
          (logActivity)="onQuickAction('Activity')"
          (sendEmail)="onSendEmail()" />
      </div>
    }
  }

  <!-- Content -->
  <div class="preview-body">
    @if (store.isLoading()) {
      <app-preview-skeleton />
    } @else if (store.error()) {
      <div class="preview-error">
        <mat-icon>error_outline</mat-icon>
        <p>{{ store.error() }}</p>
        <button mat-stroked-button (click)="store.close()">{{ 'common.close' | transloco }}</button>
      </div>
    } @else if (store.currentData()) {
      @if (availableTabs().length > 1) {
        <mat-tab-group
          [selectedIndex]="activeTabIndex()"
          (selectedIndexChange)="activeTabIndex.set($event)"
          class="preview-tabs"
          animationDuration="150ms">
          @for (tab of availableTabs(); track tab.key) {
            <mat-tab>
              <ng-template mat-tab-label>
                <span class="tab-label">
                  <mat-icon>{{ tab.icon }}</mat-icon>
                  {{ tab.label }}
                </span>
              </ng-template>

              @if (tab.key === 'overview') {
                <div class="tab-content">
                  <ng-container *ngTemplateOutlet="overviewContent" />
                </div>
              } @else {
                <ng-template matTabContent>
                  <div class="tab-content">
                    @switch (tab.key) {
                      @case ('notes') {
                        <app-preview-notes-tab
                          [entityType]="store.currentData()!.entityType"
                          [entityId]="store.currentData()!.id" />
                      }
                      @case ('activities') {
                        <app-preview-activities-tab
                          [entityType]="store.currentData()!.entityType"
                          [entityId]="store.currentData()!.id" />
                      }
                      @case ('timeline') {
                        <app-preview-timeline-tab
                          [entityType]="store.currentData()!.entityType"
                          [entityId]="store.currentData()!.id" />
                      }
                    }
                  </div>
                </ng-template>
              }
            </mat-tab>
          }
        </mat-tab-group>
      } @else {
        <!-- Single tab (Product) â€” no tab group -->
        <ng-container *ngTemplateOutlet="overviewContent" />
      }
    }
  </div>
</div>

<!-- Overview content template -->
<ng-template #overviewContent>
  @switch (store.currentData()!.entityType) {
    @case ('Contact') { <app-contact-preview [data]="store.currentData()!" /> }
    @case ('Company') { <app-company-preview [data]="store.currentData()!" /> }
    @case ('Deal') { <app-deal-preview [data]="store.currentData()!" /> }
    @case ('Lead') { <app-lead-preview [data]="store.currentData()!" /> }
    @case ('Activity') { <app-activity-preview [data]="store.currentData()!" /> }
    @case ('Product') { <app-product-preview [data]="store.currentData()!" /> }
  }

  <!-- Associations section -->
  @if (store.currentData()!.associations.length > 0) {
    <app-association-chips
      [associations]="store.currentData()!.associations"
      (chipClick)="onAssociationClick($event)" />
  }

  <!-- Recent Activities section -->
  @if (store.currentData()!.recentActivities.length > 0) {
    <app-mini-timeline
      [activities]="store.currentData()!.recentActivities"
      [entityType]="store.currentData()!.entityType"
      [entityId]="store.currentData()!.id"
      (viewAllClick)="onViewAllActivities()" />
  }

  <!-- Pinned Custom Fields -->
  @if (store.currentData()!.pinnedCustomFields.length > 0) {
    <div class="preview-section">
      <div class="section-title">{{ 'common.preview.customFields' | transloco }}</div>
      @for (field of store.currentData()!.pinnedCustomFields; track field.label) {
        <div class="field-row">
          <span class="field-label">{{ field.label }}</span>
          <span class="field-value">{{ field.value ?? '-' }}</span>
        </div>
      }
    </div>
  }
</ng-template>
