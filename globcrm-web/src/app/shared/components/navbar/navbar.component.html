<!-- ============================================================
     Desktop: Fixed Left Sidebar + Content Header
     ============================================================ -->
@if (!isMobile()) {
  <!-- Sidebar -->
  <aside class="sidebar" [class.sidebar--collapsed]="sidebarState.isCollapsed()">
    <!-- Brand -->
    <a routerLink="/dashboard" class="sidebar__brand">
      <span class="sidebar__brand-mark">G</span>
      <span class="sidebar__brand-text">Glob<span class="sidebar__brand-accent">CRM</span></span>
    </a>

    <!-- Org Badge -->
    @if (authStore.organizationName()) {
      <div class="sidebar__org">
        <mat-icon>domain</mat-icon>
        <span class="sidebar__org-text">{{ authStore.organizationName() }}</span>
      </div>
    }

    <!-- Navigation -->
    <nav class="sidebar__nav">
      @for (group of navGroups; track group.label) {
        @if (group.label) {
          <div class="sidebar__group-label">{{ group.label }}</div>
          <div class="sidebar__group-divider"></div>
        }
        @for (item of group.items; track item.route) {
          <a [routerLink]="item.route"
             routerLinkActive="sidebar__link--active"
             class="sidebar__link"
             [matTooltip]="sidebarState.isCollapsed() ? item.label : ''"
             matTooltipPosition="right">
            <mat-icon class="sidebar__link-icon">{{ item.icon }}</mat-icon>
            <span class="sidebar__link-text">{{ item.label }}</span>
          </a>
        }
      }
    </nav>

    <!-- Footer -->
    <div class="sidebar__footer">
      <button class="sidebar__collapse-btn" (click)="toggleCollapse()"
              [attr.aria-label]="sidebarState.isCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'">
        <mat-icon>{{ sidebarState.isCollapsed() ? 'chevron_right' : 'chevron_left' }}</mat-icon>
      </button>
    </div>
  </aside>

  <!-- Content Header -->
  <header class="content-header" [class.content-header--collapsed]="sidebarState.isCollapsed()">
    <app-global-search />
    <span class="content-header__spacer"></span>
    <app-notification-center />

    <!-- User Trigger -->
    <button class="content-header__user" [matMenuTriggerFor]="userMenu"
            aria-label="User menu">
      <span class="content-header__avatar">{{ userInitials }}</span>
      <div class="content-header__user-info">
        <span class="content-header__user-name">{{ authStore.userName() }}</span>
        <span class="content-header__user-role">{{ authStore.userRole() }}</span>
      </div>
      <mat-icon class="content-header__chevron">expand_more</mat-icon>
    </button>
  </header>
}

<!-- ============================================================
     Mobile: Top Bar + Overlay Sidebar Drawer
     ============================================================ -->
@if (isMobile()) {
  <!-- Mobile Top Bar -->
  <header class="topbar">
    <button class="topbar__hamburger" (click)="toggleMobile()" aria-label="Toggle navigation menu">
      <mat-icon>{{ mobileOpen() ? 'close' : 'menu' }}</mat-icon>
    </button>
    <a routerLink="/dashboard" class="topbar__brand">
      <span class="sidebar__brand-mark sidebar__brand-mark--sm">G</span>
      <span class="sidebar__brand-text">Glob<span class="sidebar__brand-accent">CRM</span></span>
    </a>
    <span class="topbar__spacer"></span>
    <app-global-search />
    <app-notification-center />
    <button class="topbar__avatar" [matMenuTriggerFor]="userMenu" aria-label="User menu">
      {{ userInitials }}
    </button>
  </header>

  <!-- Mobile Backdrop -->
  @if (mobileOpen()) {
    <div class="sidebar__backdrop" (click)="closeMobile()"></div>
  }

  <!-- Mobile Drawer -->
  <aside class="sidebar sidebar--mobile" [class.sidebar--mobile-open]="mobileOpen()">
    @if (authStore.organizationName()) {
      <div class="sidebar__org sidebar__org--mobile">
        <mat-icon>domain</mat-icon>
        <span class="sidebar__org-text">{{ authStore.organizationName() }}</span>
      </div>
    }

    <nav class="sidebar__nav">
      @for (group of navGroups; track group.label) {
        @if (group.label) {
          <div class="sidebar__group-label">{{ group.label }}</div>
        }
        @for (item of group.items; track item.route) {
          <a [routerLink]="item.route"
             routerLinkActive="sidebar__link--active"
             class="sidebar__link"
             (click)="closeMobile()">
            <mat-icon class="sidebar__link-icon">{{ item.icon }}</mat-icon>
            <span class="sidebar__link-text">{{ item.label }}</span>
          </a>
        }
      }
    </nav>
  </aside>
}

<!-- ============================================================
     Shared User Menu (used by both desktop and mobile)
     ============================================================ -->
<mat-menu #userMenu="matMenu" xPosition="before" class="sidebar-user-menu">
  <div class="sidebar-user-menu__header">
    <span class="sidebar-user-menu__avatar">{{ userInitials }}</span>
    <div>
      <div class="sidebar-user-menu__name">{{ authStore.userName() }}</div>
      <div class="sidebar-user-menu__role">{{ authStore.userRole() }}</div>
    </div>
  </div>
  <mat-divider></mat-divider>
  <button mat-menu-item routerLink="/profile">
    <mat-icon>person_outline</mat-icon>
    <span>My Profile</span>
  </button>
  <button mat-menu-item (click)="navigateToSecurity()">
    <mat-icon>shield</mat-icon>
    <span>Security</span>
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="logout()" class="sidebar-user-menu__logout">
    <mat-icon>logout</mat-icon>
    <span>Sign Out</span>
  </button>
</mat-menu>
